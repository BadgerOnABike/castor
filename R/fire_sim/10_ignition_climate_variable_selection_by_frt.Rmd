---
title: "09_ignition_climate_variable_selection"
author: "Elizabeth Kleynhans and Cora Skaien"
date: "08/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

#=================================
#  Script Name: 10_ignition_climate_variable_selection.R
#  Script Version: 1.0
#  Script Purpose: Run logistic regression models to determine the top candidate climate variable to use in the final analysis of fire ignitions.
#  Script Author: Elizabeth Kleynhans, Ecological Modeling Specialist, Forest Analysis and Inventory Branch, B.C. Ministry of Forests, Lands, and Natural Resource Operations.
#  Script Contributor: Cora Skaien, Ecological Modeling Specialist, Forest Analysis and Inventory Branch, B.C. Ministry of Forests, Lands, and Natural Resource Operations.
#=================================

#Overview
The purpose of this script is to prepare additional climate data, sub-sample points where no fires occurred (for a better ratio of fire to no fire), and perform model selection to determine the climate variable that best predicts fire occurrence for each BEC zone.

```{r}

library(sf)

library(ggplot2)
library (ggcorrplot)
library (RPostgreSQL)
library (rpostgis)

library (lme4)
library (arm)
library(ggpubr)
library(mgcv)
library(nlme)
library(purrr)
library(tidyr)
library(caret)
library(pROC)
library(keyring)

source(here::here("R/functions/R_Postgres.R"))
```

Now we must bring in the data that we created at the end of 08_VRI_data_prep. We need only the lightning + NA and the person + NA data sets here. 


```{r}
fire_ignitions<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\Fire_data_all_veg2.gpkg")

# need to update below
#bring in lightning caused fire data
# connKyle <- dbConnect(drv = RPostgreSQL::PostgreSQL(), 
#                       host = key_get('dbhost', keyring = 'postgreSQL'),
#                       user = key_get('dbuser', keyring = 'postgreSQL'),
#                       dbname = key_get('dbname', keyring = 'postgreSQL'),
#                       password = key_get('dbpass', keyring = 'postgreSQL'),
#                       port = "5432")
# dat_lightning <- sf::st_read  (dsn = connKyle, # connKyle
#                                query = "SELECT * FROM public.Fire_data_all.shp")
# dbDisconnect (connKyle)

```


Inspect the fire ignition data.

```{r}
#fire_ignitions<-fire_all

fire_ignitions2<-fire_ignitions2[,geom:=NULL] # remove geometry column for dataset

head(fire_ignitions2)
names(fire_ignitions2) # note if you import the file the names have changed


fire_ignitions <- fire_ignitions2 %>%
  dplyr::rename(frt=Cluster)

# Histogram of lightning caused fires
fire_ignitions$ig_mnth<-as.numeric(fire_ignitions$ig_mnth)
hist(fire_ignitions$ig_mnth)
```

### Plot the climate data
```{r}
# Tave
tave_all<-fire_ignitions %>% dplyr::select(frt, Tave02:Tave11)
xtave<-pivot_longer(tave_all, cols=2:11, names_to="Month", values_to="Tave")
xtave$Tave<- as.numeric(xtave$Tave)

xtave_9_11<-xtave %>% dplyr::filter(frt %in% c("9", "11"))
xtave_5_7<-xtave %>% dplyr::filter(frt %in% c("5", "7"))

# Most basic boxplot chart
ggplot(xtave_9_11, aes(x=Month, y=Tave, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot()

ggplot(xtave_5_7, aes(x=Month, y=Tave, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot()

p <- ggplot(xtave, aes(x=Month, y=Tave, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot() +
  facet_wrap( ~ frt)
p

# Tmax
tmax_all<-fire_ignitions %>% dplyr::select(frt, Tmax02:Tmax11)
xtmax<-pivot_longer(tmax_all, cols=2:11, names_to="Month", values_to="Tave")
xtmax$Tave<- as.numeric(xtmax$Tave)

xtmax_9_11<-xtmax %>% dplyr::filter(frt %in% c("9", "11"))
xtmax_5_7<-xtmax %>% dplyr::filter(frt %in% c("5", "7"))

# Most basic boxplot chart
ggplot(xtmax_9_11, aes(x=Month, y=Tave, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot()

ggplot(xtave_5_7, aes(x=Month, y=Tave, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot()

p <- ggplot(xtave, aes(x=Month, y=Tave, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot() +
  facet_wrap( ~ frt)
p


# PPT
tPPT_all<-fire_ignitions %>% dplyr::select(frt, PPT02:PPT11)
xPPT<-pivot_longer(tPPT_all, cols=2:11, names_to="Month", values_to="PPT")
xPPT$PPT<- as.numeric(xPPT$PPT)

xPPT_9_11<-xPPT %>% dplyr::filter(frt %in% c("9", "11"))
xPPT_5_7<-xPPT %>% dplyr::filter(frt %in% c("5", "7"))

# Most basic boxplot chart
ggplot(xPPT_9_11, aes(x=Month, y=PPT, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot()
#geom_violin()

ggplot(xPPT_5_7, aes(x=Month, y=PPT, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot()

p <- ggplot(xPPT, aes(x=Month, y=PPT, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot() +
  facet_wrap( ~ frt) + 
  ylim(0,500)
p

# CMI
tCMI_all<-fire_ignitions %>% dplyr::select(frt, CMI02:CMI11)
xCMI<-pivot_longer(tCMI_all, cols=2:11, names_to="Month", values_to="CMI")
xCMI$CMI<- as.numeric(xCMI$CMI)

xCMI_9_11<-xCMI %>% dplyr::filter(frt %in% c("9", "11"))
xCMI_5_7<-xCMI %>% dplyr::filter(frt %in% c("5", "7"))

# Most basic boxplot chart
ggplot(xCMI_9_11, aes(x=Month, y=CMI, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot()
#geom_violin()

ggplot(xCMI_5_7, aes(x=Month, y=CMI, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot()

p <- ggplot(xCMI, aes(x=Month, y=CMI, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot() +
  facet_wrap( ~ frt) +
  ylim(0, 50)
p

# RH
tRH_all<-fire_ignitions %>% dplyr::select(frt, RH02:RH11)
xRH<-pivot_longer(tRH_all, cols=2:11, names_to="Month", values_to="RH")
xRH$RH<- as.numeric(xRH$RH)

p <- ggplot(xRH, aes(x=Month, y=RH, fill=frt)) + # fill=name allow to automatically dedicate a color for each group
  geom_boxplot() +
  facet_wrap( ~ frt)
p




# plot climate varibales over time to see if it looks ok.

fire_ignitions_summary<- fire_ignitions %>%
  group_by(frt) %>%
  dplyr::summarize(Tmax02=mean(Tmax02),
         Tmax03=mean(Tmax03),
         Tmax04=mean(Tmax04),
         Tmax05=mean(Tmax05),
         Tmax06=mean(Tmax06),
         Tmax07=mean(Tmax07),
         Tmax08=mean(Tmax08),
         Tmax09=mean(Tmax09),
         Tmax10=mean(Tmax10),
         Tmax11=mean(Tmax11),
         Tave02=mean(Tave02),
         Tave03=mean(Tave03),
         Tave04=mean(Tave04),
         Tave05=mean(Tave05),
         Tave06=mean(Tave06),
         Tave07=mean(Tave07),
         Tave08=mean(Tave08),
         Tave09=mean(Tave09),
         Tave10=mean(Tave10),
         Tave11=mean(Tave11),
         PPT02=mean(PPT02),
         PPT03=mean(PPT03),
         PPT04=mean(PPT04),
         PPT05=mean(PPT05),
         PPT06=mean(PPT06),
         PPT07=mean(PPT07),
         PPT08=mean(PPT08),
         PPT09=mean(PPT09),
         PPT10=mean(PPT10),
         PPT11=mean(PPT11),
         RH02=mean(RH02),
         RH03=mean(RH03),
         RH04=mean(RH04),
         RH05=mean(RH05),
         RH06=mean(RH06),
         RH07=mean(RH07),
         RH08=mean(RH08),
         RH09=mean(RH09),
         RH10=mean(RH10),
         RH11=mean(RH11),
         CMI02=mean(CMI02),
         CMI03=mean(CMI03),
         CMI04=mean(CMI04),
         CMI05=mean(CMI05),
         CMI06=mean(CMI06),
         CMI07=mean(CMI07),
         CMI08=mean(CMI08),
         CMI09=mean(CMI09),
         CMI10=mean(CMI10),
         CMI11=mean(CMI11),
         MDC_02=mean(MDC_02),
         MDC_03=mean(MDC_03),
         MDC_04=mean(MDC_04),
         MDC_05=mean(MDC_05),
         MDC_06=mean(MDC_06),
         MDC_07=mean(MDC_07),
         MDC_08=mean(MDC_08),
         MDC_09=mean(MDC_09),
         MDC_10=mean(MDC_10),
         MDC_11=mean(MDC_11))

# Tave
tave<-fire_ignitions_summary %>% dplyr::select(frt, Tave02,Tave03,Tave04,Tave05,Tave06,Tave07, Tave08, Tave09, Tave10, Tave11)

xtave<-pivot_longer(tave, cols=2:11, names_to="Month", values_to="Tave")
xtave$Tave<- as.numeric(xtave$Tave)

p<-ggplot(data=xtave, aes(x=Month, y=Tave, group= frt)) +
  geom_line(aes(colour=frt)) +
  geom_point(aes(colour=frt)) 
p


# Tmax
Tmax<-fire_ignitions_summary %>% dplyr::select(frt, Tmax02,Tmax03,Tmax04,Tmax05,Tmax06,Tmax07, Tmax08, Tmax09, Tmax10, Tmax11)

xTmax<-pivot_longer(Tmax, cols=2:11, names_to="Month", values_to="Tmax")
xTmax$Tmax<- as.numeric(xTmax$Tmax)

p<-ggplot(data=xTmax, aes(x=Month, y=Tmax, group= frt)) +
  geom_line(aes(colour=frt)) +
  geom_point(aes(colour=frt)) 
p


# PPT
PPT<-fire_ignitions_summary %>% dplyr::select(frt, PPT02,PPT03,PPT04,PPT05,PPT06,PPT07, PPT08, PPT09, PPT10, PPT11)

xPPT<-pivot_longer(PPT, cols=2:11, names_to="Month", values_to="PPT")
xPPT$PPT<- as.numeric(xPPT$PPT)

p<-ggplot(data=xPPT, aes(x=Month, y=PPT, group= frt)) +
  geom_line(aes(colour=frt)) +
  geom_point(aes(colour=frt)) 
p

# RH
RH<-fire_ignitions_summary %>% dplyr::select(frt, RH02,RH03,RH04,RH05,RH06,RH07, RH08, RH09, RH10, RH11)

xRH<-pivot_longer(RH, cols=2:11, names_to="Month", values_to="RH")
xRH$RH<- as.numeric(xRH$RH)

p<-ggplot(data=xRH, aes(x=Month, y=RH, group= frt)) +
  geom_line(aes(colour=frt)) +
  geom_point(aes(colour=frt)) 
p

xtave_3<-xRH %>% filter(frt=="3") # not sure why but filter was not working when I put c("3", "5", "7") so I had to do it separaetly for each. WEIRD
xtave_5<-xRH %>% filter(frt=="5")
xtave_7<-xRH %>% filter(frt=="7")
xtave357<-rbind(rbind(xtave_3, xtave_5), xtave_7)

ggplot(data=xtave357, aes(x=Month, y=RH, group= frt)) +
  geom_line(aes(colour=frt)) +
  geom_point(aes(colour=frt))

# MDC
MDC_<-fire_ignitions_summary %>% dplyr::select(frt, MDC_02,MDC_03,MDC_04,MDC_05,MDC_06,MDC_07, MDC_08, MDC_09, MDC_10, MDC_11)

xMDC_<-pivot_longer(MDC_, cols=2:11, names_to="Month", values_to="MDC_")
xMDC_$MDC_<- as.numeric(xMDC_$MDC_)

p<-ggplot(data=xMDC_, aes(x=Month, y=MDC_, group= frt)) +
  geom_line(aes(colour=frt)) +
  geom_point(aes(colour=frt)) 
p

# CMI
CMI<-fire_ignitions_summary %>% dplyr::select(frt, CMI02,CMI03,CMI04,CMI05,CMI06,CMI07, CMI08, CMI09, CMI10, CMI11)

xCMI<-pivot_longer(CMI, cols=2:11, names_to="Month", values_to="CMI")
xCMI$CMI<- as.numeric(xCMI$CMI)

p<-ggplot(data=xCMI, aes(x=Month, y=CMI, group= frt)) +
  geom_line(aes(colour=frt)) +
  geom_point(aes(colour=frt)) 
p


#Lightning caused fires by years
p<-ggplot(fire_ignitions%>% filter(FIRE_CA=="Lightning"), aes(x=ig_mnth))+
  geom_histogram()+
  facet_wrap(fire_yr~., ncol=4)
p

# Interleaved histograms

frt5<-ggplot(fire_ignitions%>% filter(frt==5 & FIRE_CA != "Unknown"), aes(x=ig_mnth, color=FIRE_CA, fill=FIRE_CA)) +geom_histogram(position="dodge")+
  theme(legend.position="right") +
  #scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic() +
  labs(title="FRT = 5",x="Ignition month", y = "Count")

frt7<-ggplot(fire_ignitions%>% filter(frt==7 & FIRE_CA != "Unknown"), aes(x=ig_mnth, color=FIRE_CA, fill=FIRE_CA)) +geom_histogram(position="dodge")+
  theme(legend.position="right") +
  #scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic() +
  labs(title="FRT = 7",x="Ignition month", y = "Count")

frt9<-ggplot(fire_ignitions%>% filter(frt==9 & FIRE_CA != "Unknown"), aes(x=ig_mnth, color=FIRE_CA, fill=FIRE_CA)) +geom_histogram(position="dodge")+
  theme(legend.position="right") +
  #scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic() +
  labs(title="FRT = 9",x="Ignition month", y = "Count")

frt10<-ggplot(fire_ignitions%>% filter(frt==10 & FIRE_CA != "Unknown"), aes(x=ig_mnth, color=FIRE_CA, fill=FIRE_CA)) +geom_histogram(position="dodge")+
  theme(legend.position="right") +
  #scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic() +
  labs(title="FRT = 10",x="Ignition month", y = "Count")

frt11<-ggplot(fire_ignitions%>% filter(frt==11 & FIRE_CA != "Unknown"), aes(x=ig_mnth, color=FIRE_CA, fill=FIRE_CA)) +geom_histogram(position="dodge")+
  theme(legend.position="right") +
  #scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic() +
  labs(title="FRT = 11",x="Ignition month", y = "Count")

frt12<-ggplot(fire_ignitions%>% filter(frt==12 & FIRE_CA != "Unknown"), aes(x=ig_mnth, color=FIRE_CA, fill=FIRE_CA)) +geom_histogram(position="dodge")+
  theme(legend.position="right") +
  #scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic() +
  labs(title="FRT = 12",x="Ignition month", y = "Count")

frt13<-ggplot(fire_ignitions%>% filter(frt==13 & FIRE_CA != "Unknown"), aes(x=ig_mnth, color=FIRE_CA, fill=FIRE_CA)) +geom_histogram(position="dodge")+
  theme(legend.position="right") +
  #scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic() +
  labs(title="FRT = 13",x="Ignition month", y = "Count")

frt14<-ggplot(fire_ignitions%>% filter(frt==14 & FIRE_CA != "Unknown"), aes(x=ig_mnth, color=FIRE_CA, fill=FIRE_CA)) +geom_histogram(position="dodge")+
  theme(legend.position="right") +
  #scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic() +
  labs(title="FRT = 14",x="Ignition month", y = "Count")

frt15<-ggplot(fire_ignitions%>% filter(frt==15 & FIRE_CA != "Unknown"), aes(x=ig_mnth, color=FIRE_CA, fill=FIRE_CA)) +geom_histogram(position="dodge")+
  theme(legend.position="right") +
  #scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic() +
  labs(title="FRT = 15",x="Ignition month", y = "Count")

library(ggpubr)

ggarrange(frt5, frt7, frt9, frt10,
          labels = c("A", "B", "C", "D", "E"),
          ncol = 3, nrow = 2, 
          common.legend = TRUE, legend = "bottom")


ggarrange(frt11, frt12, frt13, frt14, frt15,
          labels = c("A", "B", "C", "D", "E", "F"),
          ncol = 3, nrow = 2, 
          common.legend = TRUE, legend = "bottom")







# Lightning caused fires by FRT
p<-ggplot(fire_ignitions%>% filter(FIRE_CA=="Lightning"), aes(x=ig_mnth))+
  geom_histogram()+
  facet_wrap(frt~., ncol=4)
p

p<-ggplot(fire_ignitions%>% filter(FIRE_CA=="Person"), aes(x=ig_mnth))+
  geom_histogram()+
  facet_wrap(frt~., ncol=4)
p



#Humna caused fires by years
p<-ggplot(fire_ignitions%>% filter(FIRE_CA=="Person"), aes(x=ig_mnth))+
  geom_histogram()+
  facet_wrap(fire_yr~., ncol=4)
p

# comparison between lightning and human cuased fires
p<-ggplot(fire_ignitions %>% filter(FIRE_CA !="NA"), aes(x=ig_mnth))+
  geom_histogram()+
  facet_wrap(FIRE_CA~., ncol=4)
p

```

#### Look at correlations between variables
Now that the data is prepped from 09_veg_classification_as_FWI, we can move on to the analysis for selecting the best climatic variable(s) for each Fire Regime Type (FRT)  The loop below will be run first for lightning caused fires, and then for person-caused fires.

To select the best single fire weather covariate we first conducted exploratory graphical analyses of the correlations between fire frequency and various fire weather variables. Then we fit generalized linear models for each fire weather variable (Eq. 1) using a binomial error structure with logarithmic link. Candidate variables were monthly average temperature, monthly maximum temperature, monthly precipitations and the six mean drought codes (MDC’s). We also added various two, three or fourth-month means of these values (e.g. for May, June, July and August) to test for seasonal effects (e.g. spring vs. summer).


```{r}
# combining FRT 3 with FRT 5 because FRT3 consists of two tiny slivers on the boarder of BC.
table(fire_ignitions$frt)

#### looking at correlations between variables####

####1. Lightning ########

### NOTE: I changed the number of variables so the columns below will not be correct.
# correlation between max T and MDC. Across all the data MDC and Tmax are correlated with values ranging between 0.23 and 0.94. 

dat_lightning<-fire_ignitions %>% dplyr::filter(!FIRE_CA %in% c("Person", "Unknown"))
hist(as.numeric(dat_lightning$ig_mnth))
dat_lightning<-st_drop_geometry(dat_lightning)


dist.cut.corr <- dat_lightning [,c("Tmax02", "Tmax03", "Tmax04", "Tmax05", "Tmax06", "Tmax07", "Tmax08", "Tmax09", "Tmax10", "CMI02", "CMI03", "CMI04", "CMI05", "CMI06", "CMI07", "CMI08", "CMI09", "CMI10")]
corr <- round (cor (dist.cut.corr), 2)

ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Correlation between maximum temperature and CMI")

dist.cut.corr <- dat_lightning [,c("PPT02", "PPT03", "PPT04", "PPT05", "PPT06", "PPT07", "PPT08", "PPT09", "PPT10", "CMI02", "CMI03", "CMI04", "CMI05", "CMI06", "CMI07", "CMI08", "CMI09", "CMI10")]
corr <- round (cor (dist.cut.corr), 2)

ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Correlation between PPT and CMI")

# CMI is very correlated with precipitation and pretty correlated with Tmax (0.78) in

dist.cut.corr <- fire_ignitions2 [,c("PPT02", "PPT03", "PPT04", "PPT05", "PPT06", "PPT07", "PPT08", "PPT09", "PPT10", "CMD02", "CMD03", "CMD04", "CMD05", "CMD06", "CMD07", "CMD08", "CMD09", "CMD10")]
corr <- round (cor (dist.cut.corr), 2)

ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Correlation between PPT and CMD")

# this is less correlated with precipitation than CMIbut its still correlated 0.85 for July

dist.cut.corr <- fire_ignitions2 [,c("Tmax02", "Tmax03", "Tmax04", "Tmax05", "Tmax06", "Tmax07", "Tmax08", "Tmax09", "Tmax10", "CMD02", "CMD03", "CMD04", "CMD05", "CMD06", "CMD07", "CMD08", "CMD09", "CMD10")]
corr <- round (cor (dist.cut.corr), 2)

ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Correlation between Tmax and CMD")

# Again pretty correlated with Tmax at 0.78 in July

dist.cut.corr <- fire_ignitions2 [,c("CMI02", "CMI03", "CMI04", "CMI05", "CMI06", "CMI07", "CMI08", "CMI09", "CMI10", "CMD02", "CMD03", "CMD04", "CMD05", "CMD06", "CMD07", "CMD08", "CMD09", "CMD10")]
corr <- round (cor (dist.cut.corr), 2)

ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Correlation between CMI and CMD")

# Ok so CMI and CMD are hightly correlated with them being most correlated in July at 0.96.


# tmax and rh
dist.cut.corr <- dat_lightning [c (20:29, 50:59)]
corr <- round (cor (dist.cut.corr), 3)
ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Correlation between tmax and Rh") # somewhat correlated highest =0.71

# ppt and rh
dist.cut.corr <- dat_lightning [c (40:49, 50:59)]
corr <- round (cor (dist.cut.corr), 3)
ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Correlation between tmax and Rh") #not very correlated


```


#### Create additional climate variables
Before we begin, we will create additional climate variables.

```{r}
#Climate variable creation for lightning data

### creating amalgamations of variables to test different combinations of variables.##
fire_ignitions$tot_spring_PPT<-(fire_ignitions$PPT03+ fire_ignitions$PPT04 + fire_ignitions$PPT05)/3
fire_ignitions$tot_summer_PPT<-(fire_ignitions$PPT06+ fire_ignitions$PPT07 + fire_ignitions$PPT08)/3

fire_ignitions$spring_Tmax<-(fire_ignitions$Tmax03+ fire_ignitions$Tmax04 + fire_ignitions$Tmax05)/3
fire_ignitions$summer_Tmax<-(fire_ignitions$Tmax06+ fire_ignitions$Tmax07 + fire_ignitions$Tmax08)/3

fire_ignitions$spring_Tave<-(fire_ignitions$Tave03+ fire_ignitions$Tave04 + fire_ignitions$Tave05)/3
fire_ignitions$summer_Tave<-(fire_ignitions$Tave06+ fire_ignitions$Tave07 + fire_ignitions$Tave08)/3

fire_ignitions$tot_spring_CMD<-(fire_ignitions$CMD03+ fire_ignitions$CMD04 + fire_ignitions$CMD05)/3
fire_ignitions$tot_summer_CMD<-(fire_ignitions$CMD06+ fire_ignitions$CMD07 + fire_ignitions$CMD08)/3

fire_ignitions$tot_spring_CMI<-(fire_ignitions$CMI03+ fire_ignitions$CMI04 + fire_ignitions$CMI05)/3
fire_ignitions$tot_summer_CMI<-(fire_ignitions$CMI06+ fire_ignitions$CMI07 + fire_ignitions$CMI08)/3


fire_ignitions$mean_Tmax03_Tmax04<- (fire_ignitions$Tmax03+ fire_ignitions$Tmax04)/2
fire_ignitions$mean_Tmax04_Tmax05<- (fire_ignitions$Tmax04+ fire_ignitions$Tmax05)/2
fire_ignitions$mean_Tmax05_Tmax06<- (fire_ignitions$Tmax05+ fire_ignitions$Tmax06)/2
fire_ignitions$mean_Tmax06_Tmax07<- (fire_ignitions$Tmax06+ fire_ignitions$Tmax07)/2
fire_ignitions$mean_Tmax07_Tmax08<- (fire_ignitions$Tmax07+ fire_ignitions$Tmax08)/2
fire_ignitions$mean_Tmax08_Tmax09<- (fire_ignitions$Tmax08+ fire_ignitions$Tmax09)/2
fire_ignitions$mean_Tmax09_Tmax10<- (fire_ignitions$Tmax09+ fire_ignitions$Tmax10)/2

fire_ignitions$mean_Tmax04_Tmax05_Tmax06<- (fire_ignitions$Tmax04+ fire_ignitions$Tmax05 + fire_ignitions$Tmax06)/3
fire_ignitions$mean_Tmax05_Tmax06_Tmax07<- (fire_ignitions$Tmax05+ fire_ignitions$Tmax06 + fire_ignitions$Tmax07)/3
fire_ignitions$mean_Tmax07_Tmax08_Tmax09<- (fire_ignitions$Tmax07+ fire_ignitions$Tmax08 + fire_ignitions$Tmax09)/3
fire_ignitions$mean_Tmax08_Tmax09_Tmax10<- (fire_ignitions$Tmax08+ fire_ignitions$Tmax09 + fire_ignitions$Tmax10)/3

fire_ignitions$mean_Tmax03_Tmax04_Tmax05_Tmax06<- (fire_ignitions$Tmax03 + fire_ignitions$Tmax04+ fire_ignitions$Tmax05 + fire_ignitions$Tmax06)/4
fire_ignitions$mean_Tmax04_Tmax05_Tmax06_Tmax07<- (fire_ignitions$Tmax04 + fire_ignitions$Tmax05+ fire_ignitions$Tmax06 + fire_ignitions$Tmax07)/4
fire_ignitions$mean_Tmax05_Tmax06_Tmax07_Tmax08<- (fire_ignitions$Tmax05 + fire_ignitions$Tmax06+ fire_ignitions$Tmax07 + fire_ignitions$Tmax08)/4
fire_ignitions$mean_Tmax06_Tmax07_Tmax08_Tmax09<- (fire_ignitions$Tmax06 + fire_ignitions$Tmax07+ fire_ignitions$Tmax08 + fire_ignitions$Tmax09)/4
fire_ignitions$mean_Tmax07_Tmax08_Tmax09_Tmax10<- (fire_ignitions$Tmax07 + fire_ignitions$Tmax08+ fire_ignitions$Tmax09 + fire_ignitions$Tmax10)/4

fire_ignitions$mean_Tmax03_Tmax04_Tmax05_Tmax06_Tmax07<- (fire_ignitions$Tmax03 + fire_ignitions$Tmax04 + fire_ignitions$Tmax05+ fire_ignitions$Tmax06 + fire_ignitions$Tmax07)/5
fire_ignitions$mean_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08<- (fire_ignitions$Tmax04 + fire_ignitions$Tmax05 + fire_ignitions$Tmax06+ fire_ignitions$Tmax07 + fire_ignitions$Tmax08)/5
fire_ignitions$mean_Tmax05_Tmax06_Tmax07_Tmax08_Tmax09<- (fire_ignitions$Tmax05 + fire_ignitions$Tmax06 + fire_ignitions$Tmax07+ fire_ignitions$Tmax08 + fire_ignitions$Tmax09)/5
fire_ignitions$mean_Tmax06_Tmax07_Tmax08_Tmax09_Tmax10<- ( fire_ignitions$Tmax06 + fire_ignitions$Tmax07+ fire_ignitions$Tmax08 + fire_ignitions$Tmax09 + fire_ignitions$Tmax10)/5

fire_ignitions$mean_Tmax03_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08<- (fire_ignitions$Tmax03 + fire_ignitions$Tmax04 + fire_ignitions$Tmax05 + fire_ignitions$Tmax06 + fire_ignitions$Tmax07+ fire_ignitions$Tmax08)/6
fire_ignitions$mean_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08_Tmax9<- (fire_ignitions$Tmax04 + fire_ignitions$Tmax05 + fire_ignitions$Tmax06 + fire_ignitions$Tmax07+ fire_ignitions$Tmax08 + fire_ignitions$Tmax09)/6
fire_ignitions$mean_Tmax05_Tmax06_Tmax07_Tmax08_Tmax09_Tmax10<- (fire_ignitions$Tmax05 + fire_ignitions$Tmax06 + fire_ignitions$Tmax07+ fire_ignitions$Tmax08 + fire_ignitions$Tmax09 + fire_ignitions$Tmax10)/6

#### Tave

fire_ignitions$mean_Tave03_Tave04<- (fire_ignitions$Tave03+ fire_ignitions$Tave04)/2
fire_ignitions$mean_Tave04_Tave05<- (fire_ignitions$Tave04+ fire_ignitions$Tave05)/2
fire_ignitions$mean_Tave05_Tave06<- (fire_ignitions$Tave05+ fire_ignitions$Tave06)/2
fire_ignitions$mean_Tave06_Tave07<- (fire_ignitions$Tave06+ fire_ignitions$Tave07)/2
fire_ignitions$mean_Tave07_Tave08<- (fire_ignitions$Tave07+ fire_ignitions$Tave08)/2
fire_ignitions$mean_Tave08_Tave09<- (fire_ignitions$Tave08+ fire_ignitions$Tave09)/2
fire_ignitions$mean_Tave09_Tave10<- (fire_ignitions$Tave09+ fire_ignitions$Tave10)/2

fire_ignitions$mean_Tave04_Tave05_Tave06<- (fire_ignitions$Tave04+ fire_ignitions$Tave05 + fire_ignitions$Tave06)/3
fire_ignitions$mean_Tave05_Tave06_Tave07<- (fire_ignitions$Tave05+ fire_ignitions$Tave06 + fire_ignitions$Tave07)/3
fire_ignitions$mean_Tave07_Tave08_Tave09<- (fire_ignitions$Tave07+ fire_ignitions$Tave08 + fire_ignitions$Tave09)/3
fire_ignitions$mean_Tave08_Tave09_Tave10<- (fire_ignitions$Tave08+ fire_ignitions$Tave09 + fire_ignitions$Tave10)/3

fire_ignitions$mean_Tave03_Tave04_Tave05_Tave06<- (fire_ignitions$Tave03 + fire_ignitions$Tave04+ fire_ignitions$Tave05 + fire_ignitions$Tave06)/4
fire_ignitions$mean_Tave04_Tave05_Tave06_Tave07<- (fire_ignitions$Tave04 + fire_ignitions$Tave05+ fire_ignitions$Tave06 + fire_ignitions$Tave07)/4
fire_ignitions$mean_Tave05_Tave06_Tave07_Tave08<- (fire_ignitions$Tave05 + fire_ignitions$Tave06+ fire_ignitions$Tave07 + fire_ignitions$Tave08)/4
fire_ignitions$mean_Tave06_Tave07_Tave08_Tave09<- (fire_ignitions$Tave06 + fire_ignitions$Tave07+ fire_ignitions$Tave08 + fire_ignitions$Tave09)/4
fire_ignitions$mean_Tave07_Tave08_Tave09_Tave10<- (fire_ignitions$Tave07 + fire_ignitions$Tave08+ fire_ignitions$Tave09 + fire_ignitions$Tave10)/4

fire_ignitions$mean_Tave03_Tave04_Tave05_Tave06_Tave07<- (fire_ignitions$Tave03 + fire_ignitions$Tave04 + fire_ignitions$Tave05+ fire_ignitions$Tave06 + fire_ignitions$Tave07)/5
fire_ignitions$mean_Tave04_Tave05_Tave06_Tave07_Tave08<- (fire_ignitions$Tave04 + fire_ignitions$Tave05 + fire_ignitions$Tave06+ fire_ignitions$Tave07 + fire_ignitions$Tave08)/5
fire_ignitions$mean_Tave05_Tave06_Tave07_Tave08_Tave09<- (fire_ignitions$Tave05 + fire_ignitions$Tave06 + fire_ignitions$Tave07+ fire_ignitions$Tave08 + fire_ignitions$Tave09)/5
fire_ignitions$mean_Tave06_Tave07_Tave08_Tave09_Tave10<- ( fire_ignitions$Tave06 + fire_ignitions$Tave07+ fire_ignitions$Tave08 + fire_ignitions$Tave09 + fire_ignitions$Tave10)/5

fire_ignitions$mean_Tave03_Tave04_Tave05_Tave06_Tave07_Tave08<- (fire_ignitions$Tave03 + fire_ignitions$Tave04 + fire_ignitions$Tave05 + fire_ignitions$Tave06 + fire_ignitions$Tave07+ fire_ignitions$Tave08)/6
fire_ignitions$mean_Tave04_Tave05_Tave06_Tave07_Tave08_Tave9<- (fire_ignitions$Tave04 + fire_ignitions$Tave05 + fire_ignitions$Tave06 + fire_ignitions$Tave07+ fire_ignitions$Tave08 + fire_ignitions$Tave09)/6
fire_ignitions$mean_Tave05_Tave06_Tave07_Tave08_Tave09_Tave10<- (fire_ignitions$Tave05 + fire_ignitions$Tave06 + fire_ignitions$Tave07+ fire_ignitions$Tave08 + fire_ignitions$Tave09 + fire_ignitions$Tave10)/6

#### PPT
fire_ignitions$mean_PPT03_PPT04<- (fire_ignitions$PPT03+ fire_ignitions$PPT04)/2
fire_ignitions$mean_PPT04_PPT05<- (fire_ignitions$PPT04+ fire_ignitions$PPT05)/2
fire_ignitions$mean_PPT05_PPT06<- (fire_ignitions$PPT05+ fire_ignitions$PPT06)/2
fire_ignitions$mean_PPT06_PPT07<- (fire_ignitions$PPT06+ fire_ignitions$PPT07)/2
fire_ignitions$mean_PPT07_PPT08<- (fire_ignitions$PPT07+ fire_ignitions$PPT08)/2
fire_ignitions$mean_PPT08_PPT09<- (fire_ignitions$PPT08+ fire_ignitions$PPT09)/2
fire_ignitions$mean_PPT09_PPT10<- (fire_ignitions$PPT09+ fire_ignitions$PPT10)/2

fire_ignitions$mean_PPT04_PPT05_PPT06<- (fire_ignitions$PPT04+ fire_ignitions$PPT05 + fire_ignitions$PPT06)/3
fire_ignitions$mean_PPT05_PPT06_PPT07<- (fire_ignitions$PPT05+ fire_ignitions$PPT06 + fire_ignitions$PPT07)/3
fire_ignitions$mean_PPT07_PPT08_PPT09<- (fire_ignitions$PPT07+ fire_ignitions$PPT08 + fire_ignitions$PPT09)/3
fire_ignitions$mean_PPT08_PPT09_PPT10<- (fire_ignitions$PPT08+ fire_ignitions$PPT09 + fire_ignitions$PPT10)/3

fire_ignitions$mean_PPT03_PPT04_PPT05_PPT06<- (fire_ignitions$PPT03 + fire_ignitions$PPT04+ fire_ignitions$PPT05 + fire_ignitions$PPT06)/4
fire_ignitions$mean_PPT04_PPT05_PPT06_PPT07<- (fire_ignitions$PPT04 + fire_ignitions$PPT05+ fire_ignitions$PPT06 + fire_ignitions$PPT07)/4
fire_ignitions$mean_PPT05_PPT06_PPT07_PPT08<- (fire_ignitions$PPT05 + fire_ignitions$PPT06+ fire_ignitions$PPT07 + fire_ignitions$PPT08)/4
fire_ignitions$mean_PPT06_PPT07_PPT08_PPT09<- (fire_ignitions$PPT06 + fire_ignitions$PPT07+ fire_ignitions$PPT08 + fire_ignitions$PPT09)/4
fire_ignitions$mean_PPT07_PPT08_PPT09_PPT10<- (fire_ignitions$PPT07 + fire_ignitions$PPT08+ fire_ignitions$PPT09 + fire_ignitions$PPT10)/4

fire_ignitions$mean_PPT03_PPT04_PPT05_PPT06_PPT07<- (fire_ignitions$PPT03 + fire_ignitions$PPT04 + fire_ignitions$PPT05+ fire_ignitions$PPT06 + fire_ignitions$PPT07)/5
fire_ignitions$mean_PPT04_PPT05_PPT06_PPT07_PPT08<- (fire_ignitions$PPT04 + fire_ignitions$PPT05 + fire_ignitions$PPT06+ fire_ignitions$PPT07 + fire_ignitions$PPT08)/5
fire_ignitions$mean_PPT05_PPT06_PPT07_PPT08_PPT09<- (fire_ignitions$PPT05 + fire_ignitions$PPT06 + fire_ignitions$PPT07+ fire_ignitions$PPT08 + fire_ignitions$PPT09)/5
fire_ignitions$mean_PPT06_PPT07_PPT08_PPT09_PPT10<- ( fire_ignitions$PPT06 + fire_ignitions$PPT07+ fire_ignitions$PPT08 + fire_ignitions$PPT09 + fire_ignitions$PPT10)/5

fire_ignitions$mean_PPT03_PPT04_PPT05_PPT06_PPT07_PPT08<- (fire_ignitions$PPT03 + fire_ignitions$PPT04 + fire_ignitions$PPT05 + fire_ignitions$PPT06 + fire_ignitions$PPT07+ fire_ignitions$PPT08)/6
fire_ignitions$mean_PPT04_PPT05_PPT06_PPT07_PPT08_PPT9<- (fire_ignitions$PPT04 + fire_ignitions$PPT05 + fire_ignitions$PPT06 + fire_ignitions$PPT07+ fire_ignitions$PPT08 + fire_ignitions$PPT09)/6
fire_ignitions$mean_PPT05_PPT06_PPT07_PPT08_PPT09_PPT10<- (fire_ignitions$PPT05 + fire_ignitions$PPT06 + fire_ignitions$PPT07+ fire_ignitions$PPT08 + fire_ignitions$PPT09 + fire_ignitions$PPT10)/6


#### RH
fire_ignitions$mean_RH03_RH04<- (fire_ignitions$RH03+ fire_ignitions$RH04)/2
fire_ignitions$mean_RH04_RH05<- (fire_ignitions$RH04+ fire_ignitions$RH05)/2
fire_ignitions$mean_RH05_RH06<- (fire_ignitions$RH05+ fire_ignitions$RH06)/2
fire_ignitions$mean_RH06_RH07<- (fire_ignitions$RH06+ fire_ignitions$RH07)/2
fire_ignitions$mean_RH07_RH08<- (fire_ignitions$RH07+ fire_ignitions$RH08)/2
fire_ignitions$mean_RH08_RH09<- (fire_ignitions$RH08+ fire_ignitions$RH09)/2
fire_ignitions$mean_RH09_RH10<- (fire_ignitions$RH09+ fire_ignitions$RH10)/2

fire_ignitions$mean_RH04_RH05_RH06<- (fire_ignitions$RH04+ fire_ignitions$RH05 + fire_ignitions$RH06)/3
fire_ignitions$mean_RH05_RH06_RH07<- (fire_ignitions$RH05+ fire_ignitions$RH06 + fire_ignitions$RH07)/3
fire_ignitions$mean_RH07_RH08_RH09<- (fire_ignitions$RH07+ fire_ignitions$RH08 + fire_ignitions$RH09)/3
fire_ignitions$mean_RH08_RH09_RH10<- (fire_ignitions$RH08+ fire_ignitions$RH09 + fire_ignitions$RH10)/3

fire_ignitions$mean_RH03_RH04_RH05_RH06<- (fire_ignitions$RH03 + fire_ignitions$RH04+ fire_ignitions$RH05 + fire_ignitions$RH06)/4
fire_ignitions$mean_RH04_RH05_RH06_RH07<- (fire_ignitions$RH04 + fire_ignitions$RH05+ fire_ignitions$RH06 + fire_ignitions$RH07)/4
fire_ignitions$mean_RH05_RH06_RH07_RH08<- (fire_ignitions$RH05 + fire_ignitions$RH06+ fire_ignitions$RH07 + fire_ignitions$RH08)/4
fire_ignitions$mean_RH06_RH07_RH08_RH09<- (fire_ignitions$RH06 + fire_ignitions$RH07+ fire_ignitions$RH08 + fire_ignitions$RH09)/4
fire_ignitions$mean_RH07_RH08_RH09_RH10<- (fire_ignitions$RH07 + fire_ignitions$RH08+ fire_ignitions$RH09 + fire_ignitions$RH10)/4

fire_ignitions$mean_RH03_RH04_RH05_RH06_RH07<- (fire_ignitions$RH03 + fire_ignitions$RH04 + fire_ignitions$RH05+ fire_ignitions$RH06 + fire_ignitions$RH07)/5
fire_ignitions$mean_RH04_RH05_RH06_RH07_RH08<- (fire_ignitions$RH04 + fire_ignitions$RH05 + fire_ignitions$RH06+ fire_ignitions$RH07 + fire_ignitions$RH08)/5
fire_ignitions$mean_RH05_RH06_RH07_RH08_RH09<- (fire_ignitions$RH05 + fire_ignitions$RH06 + fire_ignitions$RH07+ fire_ignitions$RH08 + fire_ignitions$RH09)/5
fire_ignitions$mean_RH06_RH07_RH08_RH09_RH10<- ( fire_ignitions$RH06 + fire_ignitions$RH07+ fire_ignitions$RH08 + fire_ignitions$RH09 + fire_ignitions$RH10)/5

fire_ignitions$mean_RH03_RH04_RH05_RH06_RH07_RH08<- (fire_ignitions$RH03 + fire_ignitions$RH04 + fire_ignitions$RH05 + fire_ignitions$RH06 + fire_ignitions$RH07+ fire_ignitions$RH08)/6
fire_ignitions$mean_RH04_RH05_RH06_RH07_RH08_RH9<- (fire_ignitions$RH04 + fire_ignitions$RH05 + fire_ignitions$RH06 + fire_ignitions$RH07+ fire_ignitions$RH08 + fire_ignitions$RH09)/6
fire_ignitions$mean_RH05_RH06_RH07_RH08_RH09_RH10<- (fire_ignitions$RH05 + fire_ignitions$RH06 + fire_ignitions$RH07+ fire_ignitions$RH08 + fire_ignitions$RH09 + fire_ignitions$RH10)/6


### MDC
fire_ignitions$mean_MDC_03_MDC_04<- (fire_ignitions$MDC_03+ fire_ignitions$MDC_04)/2
fire_ignitions$mean_MDC_04_MDC_05<- (fire_ignitions$MDC_04+ fire_ignitions$MDC_05)/2
fire_ignitions$mean_MDC_05_MDC_06<- (fire_ignitions$MDC_05+ fire_ignitions$MDC_06)/2
fire_ignitions$mean_MDC_06_MDC_07<- (fire_ignitions$MDC_06+ fire_ignitions$MDC_07)/2
fire_ignitions$mean_MDC_07_MDC_08<- (fire_ignitions$MDC_07+ fire_ignitions$MDC_08)/2
fire_ignitions$mean_MDC_08_MDC_09<- (fire_ignitions$MDC_08+ fire_ignitions$MDC_09)/2
fire_ignitions$mean_MDC_09_MDC_10<- (fire_ignitions$MDC_09+ fire_ignitions$MDC_10)/2

fire_ignitions$mean_MDC_04_MDC_05_MDC_06<- (fire_ignitions$MDC_04+ fire_ignitions$MDC_05 + fire_ignitions$MDC_06)/3
fire_ignitions$mean_MDC_05_MDC_06_MDC_07<- (fire_ignitions$MDC_05+ fire_ignitions$MDC_06 + fire_ignitions$MDC_07)/3
fire_ignitions$mean_MDC_07_MDC_08_MDC_09<- (fire_ignitions$MDC_07+ fire_ignitions$MDC_08 + fire_ignitions$MDC_09)/3
fire_ignitions$mean_MDC_08_MDC_09_MDC_10<- (fire_ignitions$MDC_08+ fire_ignitions$MDC_09 + fire_ignitions$MDC_10)/3

fire_ignitions$mean_MDC_03_MDC_04_MDC_05_MDC_06<- (fire_ignitions$MDC_03 + fire_ignitions$MDC_04+ fire_ignitions$MDC_05 + fire_ignitions$MDC_06)/4
fire_ignitions$mean_MDC_04_MDC_05_MDC_06_MDC_07<- (fire_ignitions$MDC_04 + fire_ignitions$MDC_05+ fire_ignitions$MDC_06 + fire_ignitions$MDC_07)/4
fire_ignitions$mean_MDC_05_MDC_06_MDC_07_MDC_08<- (fire_ignitions$MDC_05 + fire_ignitions$MDC_06+ fire_ignitions$MDC_07 + fire_ignitions$MDC_08)/4
fire_ignitions$mean_MDC_06_MDC_07_MDC_08_MDC_09<- (fire_ignitions$MDC_06 + fire_ignitions$MDC_07+ fire_ignitions$MDC_08 + fire_ignitions$MDC_09)/4
fire_ignitions$mean_MDC_07_MDC_08_MDC_09_MDC_10<- (fire_ignitions$MDC_07 + fire_ignitions$MDC_08+ fire_ignitions$MDC_09 + fire_ignitions$MDC_10)/4

fire_ignitions$mean_MDC_03_MDC_04_MDC_05_MDC_06_MDC_07<- (fire_ignitions$MDC_03 + fire_ignitions$MDC_04 + fire_ignitions$MDC_05+ fire_ignitions$MDC_06 + fire_ignitions$MDC_07)/5
fire_ignitions$mean_MDC_04_MDC_05_MDC_06_MDC_07_MDC_08<- (fire_ignitions$MDC_04 + fire_ignitions$MDC_05 + fire_ignitions$MDC_06+ fire_ignitions$MDC_07 + fire_ignitions$MDC_08)/5
fire_ignitions$mean_MDC_05_MDC_06_MDC_07_MDC_08_MDC_09<- (fire_ignitions$MDC_05 + fire_ignitions$MDC_06 + fire_ignitions$MDC_07+ fire_ignitions$MDC_08 + fire_ignitions$MDC_09)/5
fire_ignitions$mean_MDC_06_MDC_07_MDC_08_MDC_09_MDC_10<- ( fire_ignitions$MDC_06 + fire_ignitions$MDC_07+ fire_ignitions$MDC_08 + fire_ignitions$MDC_09 + fire_ignitions$MDC_10)/5

fire_ignitions$mean_MDC_03_MDC_04_MDC_05_MDC_06_MDC_07_MDC_08<- (fire_ignitions$MDC_03 + fire_ignitions$MDC_04 + fire_ignitions$MDC_05 + fire_ignitions$MDC_06 + fire_ignitions$MDC_07+ fire_ignitions$MDC_08)/6
fire_ignitions$mean_MDC_04_MDC_05_MDC_06_MDC_07_MDC_08_MDC_9<- (fire_ignitions$MDC_04 + fire_ignitions$MDC_05 + fire_ignitions$MDC_06 + fire_ignitions$MDC_07+ fire_ignitions$MDC_08 + fire_ignitions$MDC_09)/6
fire_ignitions$mean_MDC_05_MDC_06_MDC_07_MDC_08_MDC_09_MDC_10<- (fire_ignitions$MDC_05 + fire_ignitions$MDC_06 + fire_ignitions$MDC_07+ fire_ignitions$MDC_08 + fire_ignitions$MDC_09 + fire_ignitions$MDC_10)/6

#### CMI
fire_ignitions$mean_CMI03_CMI04<- (fire_ignitions$CMI03+ fire_ignitions$CMI04)/2
fire_ignitions$mean_CMI04_CMI05<- (fire_ignitions$CMI04+ fire_ignitions$CMI05)/2
fire_ignitions$mean_CMI05_CMI06<- (fire_ignitions$CMI05+ fire_ignitions$CMI06)/2
fire_ignitions$mean_CMI06_CMI07<- (fire_ignitions$CMI06+ fire_ignitions$CMI07)/2
fire_ignitions$mean_CMI07_CMI08<- (fire_ignitions$CMI07+ fire_ignitions$CMI08)/2
fire_ignitions$mean_CMI08_CMI09<- (fire_ignitions$CMI08+ fire_ignitions$CMI09)/2
fire_ignitions$mean_CMI09_CMI10<- (fire_ignitions$CMI09+ fire_ignitions$CMI10)/2

fire_ignitions$mean_CMI04_CMI05_CMI06<- (fire_ignitions$CMI04+ fire_ignitions$CMI05 + fire_ignitions$CMI06)/3
fire_ignitions$mean_CMI05_CMI06_CMI07<- (fire_ignitions$CMI05+ fire_ignitions$CMI06 + fire_ignitions$CMI07)/3
fire_ignitions$mean_CMI07_CMI08_CMI09<- (fire_ignitions$CMI07+ fire_ignitions$CMI08 + fire_ignitions$CMI09)/3
fire_ignitions$mean_CMI08_CMI09_CMI10<- (fire_ignitions$CMI08+ fire_ignitions$CMI09 + fire_ignitions$CMI10)/3

fire_ignitions$mean_CMI03_CMI04_CMI05_CMI06<- (fire_ignitions$CMI03 + fire_ignitions$CMI04+ fire_ignitions$CMI05 + fire_ignitions$CMI06)/4
fire_ignitions$mean_CMI04_CMI05_CMI06_CMI07<- (fire_ignitions$CMI04 + fire_ignitions$CMI05+ fire_ignitions$CMI06 + fire_ignitions$CMI07)/4
fire_ignitions$mean_CMI05_CMI06_CMI07_CMI08<- (fire_ignitions$CMI05 + fire_ignitions$CMI06+ fire_ignitions$CMI07 + fire_ignitions$CMI08)/4
fire_ignitions$mean_CMI06_CMI07_CMI08_CMI09<- (fire_ignitions$CMI06 + fire_ignitions$CMI07+ fire_ignitions$CMI08 + fire_ignitions$CMI09)/4
fire_ignitions$mean_CMI07_CMI08_CMI09_CMI10<- (fire_ignitions$CMI07 + fire_ignitions$CMI08+ fire_ignitions$CMI09 + fire_ignitions$CMI10)/4

fire_ignitions$mean_CMI03_CMI04_CMI05_CMI06_CMI07<- (fire_ignitions$CMI03 + fire_ignitions$CMI04 + fire_ignitions$CMI05+ fire_ignitions$CMI06 + fire_ignitions$CMI07)/5
fire_ignitions$mean_CMI04_CMI05_CMI06_CMI07_CMI08<- (fire_ignitions$CMI04 + fire_ignitions$CMI05 + fire_ignitions$CMI06+ fire_ignitions$CMI07 + fire_ignitions$CMI08)/5
fire_ignitions$mean_CMI05_CMI06_CMI07_CMI08_CMI09<- (fire_ignitions$CMI05 + fire_ignitions$CMI06 + fire_ignitions$CMI07+ fire_ignitions$CMI08 + fire_ignitions$CMI09)/5
fire_ignitions$mean_CMI06_CMI07_CMI08_CMI09_CMI10<- ( fire_ignitions$CMI06 + fire_ignitions$CMI07+ fire_ignitions$CMI08 + fire_ignitions$CMI09 + fire_ignitions$CMI10)/5

fire_ignitions$mean_CMI03_CMI04_CMI05_CMI06_CMI07_CMI08<- (fire_ignitions$CMI03 + fire_ignitions$CMI04 + fire_ignitions$CMI05 + fire_ignitions$CMI06 + fire_ignitions$CMI07+ fire_ignitions$CMI08)/6
fire_ignitions$mean_CMI04_CMI05_CMI06_CMI07_CMI08_CMI9<- (fire_ignitions$CMI04 + fire_ignitions$CMI05 + fire_ignitions$CMI06 + fire_ignitions$CMI07+ fire_ignitions$CMI08 + fire_ignitions$CMI09)/6
fire_ignitions$mean_CMI05_CMI06_CMI07_CMI08_CMI09_CMI10<- (fire_ignitions$CMI05 + fire_ignitions$CMI06 + fire_ignitions$CMI07+ fire_ignitions$CMI08 + fire_ignitions$CMI09 + fire_ignitions$CMI10)/6


#### CMD
fire_ignitions$mean_CMD03_CMD04<- (fire_ignitions$CMD03+ fire_ignitions$CMD04)/2
fire_ignitions$mean_CMD04_CMD05<- (fire_ignitions$CMD04+ fire_ignitions$CMD05)/2
fire_ignitions$mean_CMD05_CMD06<- (fire_ignitions$CMD05+ fire_ignitions$CMD06)/2
fire_ignitions$mean_CMD06_CMD07<- (fire_ignitions$CMD06+ fire_ignitions$CMD07)/2
fire_ignitions$mean_CMD07_CMD08<- (fire_ignitions$CMD07+ fire_ignitions$CMD08)/2
fire_ignitions$mean_CMD08_CMD09<- (fire_ignitions$CMD08+ fire_ignitions$CMD09)/2
fire_ignitions$mean_CMD09_CMD10<- (fire_ignitions$CMD09+ fire_ignitions$CMD10)/2

fire_ignitions$mean_CMD04_CMD05_CMD06<- (fire_ignitions$CMD04+ fire_ignitions$CMD05 + fire_ignitions$CMD06)/3
fire_ignitions$mean_CMD05_CMD06_CMD07<- (fire_ignitions$CMD05+ fire_ignitions$CMD06 + fire_ignitions$CMD07)/3
fire_ignitions$mean_CMD07_CMD08_CMD09<- (fire_ignitions$CMD07+ fire_ignitions$CMD08 + fire_ignitions$CMD09)/3
fire_ignitions$mean_CMD08_CMD09_CMD10<- (fire_ignitions$CMD08+ fire_ignitions$CMD09 + fire_ignitions$CMD10)/3

fire_ignitions$mean_CMD03_CMD04_CMD05_CMD06<- (fire_ignitions$CMD03 + fire_ignitions$CMD04+ fire_ignitions$CMD05 + fire_ignitions$CMD06)/4
fire_ignitions$mean_CMD04_CMD05_CMD06_CMD07<- (fire_ignitions$CMD04 + fire_ignitions$CMD05+ fire_ignitions$CMD06 + fire_ignitions$CMD07)/4
fire_ignitions$mean_CMD05_CMD06_CMD07_CMD08<- (fire_ignitions$CMD05 + fire_ignitions$CMD06+ fire_ignitions$CMD07 + fire_ignitions$CMD08)/4
fire_ignitions$mean_CMD06_CMD07_CMD08_CMD09<- (fire_ignitions$CMD06 + fire_ignitions$CMD07+ fire_ignitions$CMD08 + fire_ignitions$CMD09)/4
fire_ignitions$mean_CMD07_CMD08_CMD09_CMD10<- (fire_ignitions$CMD07 + fire_ignitions$CMD08+ fire_ignitions$CMD09 + fire_ignitions$CMD10)/4

fire_ignitions$mean_CMD03_CMD04_CMD05_CMD06_CMD07<- (fire_ignitions$CMD03 + fire_ignitions$CMD04 + fire_ignitions$CMD05+ fire_ignitions$CMD06 + fire_ignitions$CMD07)/5
fire_ignitions$mean_CMD04_CMD05_CMD06_CMD07_CMD08<- (fire_ignitions$CMD04 + fire_ignitions$CMD05 + fire_ignitions$CMD06+ fire_ignitions$CMD07 + fire_ignitions$CMD08)/5
fire_ignitions$mean_CMD05_CMD06_CMD07_CMD08_CMD09<- (fire_ignitions$CMD05 + fire_ignitions$CMD06 + fire_ignitions$CMD07+ fire_ignitions$CMD08 + fire_ignitions$CMD09)/5
fire_ignitions$mean_CMD06_CMD07_CMD08_CMD09_CMD10<- ( fire_ignitions$CMD06 + fire_ignitions$CMD07+ fire_ignitions$CMD08 + fire_ignitions$CMD09 + fire_ignitions$CMD10)/5

fire_ignitions$mean_CMD03_CMD04_CMD05_CMD06_CMD07_CMD08<- (fire_ignitions$CMD03 + fire_ignitions$CMD04 + fire_ignitions$CMD05 + fire_ignitions$CMD06 + fire_ignitions$CMD07+ fire_ignitions$CMD08)/6
fire_ignitions$mean_CMD04_CMD05_CMD06_CMD07_CMD08_CMD9<- (fire_ignitions$CMD04 + fire_ignitions$CMD05 + fire_ignitions$CMD06 + fire_ignitions$CMD07+ fire_ignitions$CMD08 + fire_ignitions$CMD09)/6
fire_ignitions$mean_CMD05_CMD06_CMD07_CMD08_CMD09_CMD10<- (fire_ignitions$CMD05 + fire_ignitions$CMD06 + fire_ignitions$CMD07+ fire_ignitions$CMD08 + fire_ignitions$CMD09 + fire_ignitions$CMD10)/6

```



#################################
#### Subsample data before running analysis
#################################

Note: because we sampled the number of non-fire locations using all fires regardless of cause when you filter the data to remove human and unknown caused fires the non-fire locations do not get filtered and so you end up with more than 5x non-fire locations than lightning ignitions. Thus, I think we need to subsample the non-fire locations before running the models. 


Now, we must subsample the data since the sample sizes for the zeros are too large. At least two different papers used 1.5 times the number of presence points as absences. See:
   - Chang et al (2013) Predicting fire occurrence patterns with logistic regression in Heilongjiang Province, China. Landscape Ecology 28, 1989-2004 and
   - Catry et al. (2009) Modeling and mapping wildfire ignition risk in Portugal. International Journal of Wildland Fire 18, 921-931.

# Steps for subsampling:
First, get sample sizes per habitat type and year for the 1's. 
Then sample 2x or some amount more than that value in each of those vegetation, year categories. 
See https://jennybc.github.io/purrr-tutorial/ls12_different-sized-samples.html for an idea on how to do this.

This will be done separately for lightning and person caused fires. 

We must subsample the data since the sample sizes for the zeros are too large. At least two different papers used 1.5 times the number of presence points as absences. See:
   - Chang et al (2013) Predicting fire occurrence patterns with logistic regression in Heilongjiang Province, China. Landscape Ecology 28, 1989-2004 and
   - Catry et al. (2009) Modeling and mapping wildfire ignition risk in Portugal. International Journal of Wildland Fire 18, 921-931.


The step preparing the tables can take a very long time for the NAs since there are a few hundred thousand. Once you prepare these tables, you do not need to prepare them again as long as they are still saved in your R environment. Once geometry is set to null, however, the processing should be really fast.

```{r}
#fire_ignitions2<-st_set_geometry(fire_ignitions, NULL)

##Lightning caused - preparing the tables
pre<- fire_ignitions %>%
  filter(fire==1) %>%
  filter(!FIRE_CA %in% c("Person", "Unknown")) %>%
  dplyr::select(fire_yr, fire, frt, fwveg) %>%
  group_by(fire_yr, frt, fwveg) %>%
  summarize(fire_n=n())
head(pre)

##Get NA points
pre_checkpre<- fire_ignitions %>%
  filter(fire==0) %>%
  dplyr::select(fire_yr, fire, frt, fwveg) %>%
  group_by(fire_yr, frt, fwveg) %>%
  summarize(abs_n=n())
head(pre_checkpre)
```

This next chunk also takes quite a bit of time.

```{r}
check<-left_join(pre, pre_checkpre)
check %>% print(n=300) # hmm there are some NA's in the 0 column. I should probably correct that.
```


```{r}
abs_match <- fire_ignitions %>%
  filter(fire == 0) %>%
  group_by(fire_yr, frt, fwveg ) %>%   # prep for work by yr and veg type
  nest() %>%              # --> one row per yr and vegtype
  ungroup()

df<-left_join(check, abs_match) # make sure there are not veg year combinations that are not also in the fire_pres==1 file


# there are several year, zone, subzone combinations with no data in the tibble.  This code below removes the Null values. I should increase my sample of fire absences so that I don't have any combinations with zero data or sample it in a different way. TO DO!
df2 <- df %>% 
  filter(lengths(data)>0)
```

Note: each time you subsample with the code below, you will end up with different random points where fires did not occur. As a result, the results of the subsequent model selection may differ. You may wish to create different random points each a few times to ensure that the same climate variables come out as the top ones for each BEC zone, especially for those with small sample sizes for where fires occurred.

```{r}
# here I sample from the tibble the number of data points I want for the absences
# I should probably have replace = false but there are a few rows where there are more fire ignitions in that subzone than randomly sampled locations which is causing issues with this code. For now I'll leave it like this.
  sampled_df<- df2 %>% 
    mutate(samp = map2(data, ceiling(fire_n*5), sample_n, replace=TRUE)) %>%
    dplyr::select(-data) %>%
    unnest(samp) #%>%
    #dplyr::select(idno:frt)
 
# joining my subsampled absence data back to the fire ignition presence data
pre1<- fire_ignitions %>%
  filter(fire==1) %>% 
  filter(! FIRE_CA %in% c("Person", "Unknown"))
dim(sampled_df) # 
dim(pre1) #  15228 rows
sampled_df<-sampled_df %>% dplyr::select(!c(fire_n,abs_n))

dat_lightning<- rbind(pre1, as.data.frame(sampled_df))
dim(dat_lightning) # 37673 rows good this worked I think; Cora July 5 has 45656 rows. This is fewer than the >180,000 rows of the data at the end of file 01

dat_lightning<- dat_lightning %>% filter(!FIRE_CA %in% c("Person", "Unknown"))

head(dat_lightning)
str(dat_lightning)
table(dat_lightning$FIRE_CA)
```

If all looks good from above, then save data.

```{r}
#Write file
write.csv(dat_lightning, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\dat_lightning_for_analysis.csv")

#st_write(dat_lightning, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\dat_lightning_for_analysis.csv", delete_layer=TRUE)

dat_lightning<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\dat_lightning_for_analysis.csv")

```

#################################
# ANALYSIS OF CLIMATE VARIABLES
#################################

Loosely following the methods of Marchal et al. (2017) Ecography (https://onlinelibrary.wiley.com/doi/full/10.1111/ecog.01849) Supporting Information Appendix 1 I try to figure out which is the best climate variable or climate variables to include in my model. I run simple models of the form:

     logb(p/1-p) = B0 + B1x1 or logb(p/1-p) = B0 + B1x1 + B2x2

and extract the AIC as a means for comparison. I also calculate the AUC by splitting the data into a training and validation data set. Finally I repeat the analysis calculating the AIC and AUC using training and validation data sets 10 times taking the average of both the AIC and AUC values. These are the values that I spit out into a csv file so that I can examine which climate variable is best for each Fire regime type, BEC zone, or natural disturbance type. 


##### Create variables for Model Selection ########
Create groupings of variables to put into model selection loop.

```{r}
dat_lightning %>%
  ggplot( aes(x=ig_mnth)) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
  facet_wrap( ~ frt)

# Check these variables I think they are a little messed up.

variables<- c("spring_Tmax",
              "summer_Tmax",
              "Tmax03",
              "Tmax04",
              "Tmax05",
              "Tmax06",
              "Tmax07", 
              "Tmax08", 
              "Tmax09",
              #"Tmax10", 
              #"Tmax11", 
              "mean_Tmax03_Tmax04",
              "mean_Tmax04_Tmax05",
              "mean_Tmax05_Tmax06",
              "mean_Tmax06_Tmax07", 
              "mean_Tmax07_Tmax08", 
              "mean_Tmax08_Tmax09",
              #"mean_Tmax09_Tmax10",
              #"mean_Tmax10_Tmax11", 
              "mean_Tmax04_Tmax05_Tmax06",
              "mean_Tmax05_Tmax06_Tmax07", 
              "mean_Tmax07_Tmax08_Tmax09",
              #"mean_Tmax08_Tmax09_Tmax10",
              #"mean_Tmax09_Tmax10_Tmax11", 
              "mean_Tmax03_Tmax04_Tmax05_Tmax06",
              "mean_Tmax04_Tmax05_Tmax06_Tmax07",
              "mean_Tmax05_Tmax06_Tmax07_Tmax08",
              "mean_Tmax06_Tmax07_Tmax08_Tmax09",
              #"mean_Tmax07_Tmax08_Tmax09_Tmax10",
              #"mean_Tmax08_Tmax09_Tmax10_Tmax11",
              "mean_Tmax03_Tmax04_Tmax05_Tmax06_Tmax07",
              "mean_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08",
              "mean_Tmax05_Tmax06_Tmax07_Tmax08_Tmax09",
              #"mean_Tmax06_Tmax07_Tmax08_Tmax09_Tmax10",
              #"mean_Tmax07_Tmax08_Tmax09_Tmax10_Tmax11",
              "mean_Tmax03_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08",
              "mean_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08_Tmax9",
              
              "spring_Tave",
              "summer_Tave",
              "Tave03",
              "Tave04",
              "Tave05",
              "Tave06",
              "Tave07", 
              "Tave08", 
              "Tave09",
              #"Tave10", 
              #"Tave11", 
              "mean_Tave03_Tave04",
              "mean_Tave04_Tave05",
              "mean_Tave05_Tave06",
              "mean_Tave06_Tave07", 
              "mean_Tave07_Tave08", 
              "mean_Tave08_Tave09",
              #"mean_Tave09_Tave10",
              #"mean_Tave10_Tave11", 
              "mean_Tave04_Tave05_Tave06",
              "mean_Tave05_Tave06_Tave07", 
              "mean_Tave07_Tave08_Tave09",
              #"mean_Tave08_Tave09_Tave10",
              #"mean_Tave09_Tave10_Tave11", 
              "mean_Tave03_Tave04_Tave05_Tave06",
              "mean_Tave04_Tave05_Tave06_Tave07",
              "mean_Tave05_Tave06_Tave07_Tave08",
              "mean_Tave06_Tave07_Tave08_Tave09",
              #"mean_Tave07_Tave08_Tave09_Tave10",
              #"mean_Tave08_Tave09_Tave10_Tave11",
              "mean_Tave03_Tave04_Tave05_Tave06_Tave07",
              "mean_Tave04_Tave05_Tave06_Tave07_Tave08",
              "mean_Tave05_Tave06_Tave07_Tave08_Tave09",
              #"mean_Tave06_Tave07_Tave08_Tave09_Tave10",
              #"mean_Tave07_Tave08_Tave09_Tave10_Tave11",
              "mean_Tave03_Tave04_Tave05_Tave06_Tave07_Tave08",
              "mean_Tave04_Tave05_Tave06_Tave07_Tave08_Tave9",
              
              
              "tot_spring_PPT",
              "tot_summer_PPT",
              "PPT03",
              "PPT04",
              "PPT05",
              "PPT06",
              "PPT07", 
              "PPT08", 
              "PPT09",
              #"PPT10", 
              #"PPT11", 
              "mean_PPT03_PPT04",
              "mean_PPT04_PPT05",
              "mean_PPT05_PPT06",
              "mean_PPT06_PPT07", 
              "mean_PPT07_PPT08", 
              "mean_PPT08_PPT09",
              #"mean_PPT09_PPT10",
              #"mean_PPT10_PPT11", 
              "mean_PPT04_PPT05_PPT06",
              "mean_PPT05_PPT06_PPT07", 
              "mean_PPT07_PPT08_PPT09",
              #"mean_PPT08_PPT09_PPT10",
              #"mean_PPT09_PPT10_PPT11", 
              "mean_PPT03_PPT04_PPT05_PPT06",
              "mean_PPT04_PPT05_PPT06_PPT07",
              "mean_PPT05_PPT06_PPT07_PPT08",
              "mean_PPT06_PPT07_PPT08_PPT09",
              #"mean_PPT07_PPT08_PPT09_PPT10",
              #"mean_PPT08_PPT09_PPT10_PPT11",
              "mean_PPT03_PPT04_PPT05_PPT06_PPT07",
              "mean_PPT04_PPT05_PPT06_PPT07_PPT08",
              "mean_PPT05_PPT06_PPT07_PPT08_PPT09",
              #"mean_PPT06_PPT07_PPT08_PPT09_PPT10",
              #"mean_PPT07_PPT08_PPT09_PPT10_PPT11",
              "mean_PPT03_PPT04_PPT05_PPT06_PPT07_PPT08",
              "mean_PPT04_PPT05_PPT06_PPT07_PPT08_PPT9",
              
              # "RH03",
              # "RH04",
              # "RH05",
              # "RH06",
              # "RH07", 
              # "RH08", 
              # "RH09",
              # #"RH10", 
              # #"RH11", 
              # "mean_RH03_RH04",
              # "mean_RH04_RH05",
              # "mean_RH05_RH06",
              # "mean_RH06_RH07", 
              # "mean_RH07_RH08", 
              # "mean_RH08_RH09",
              # #"mean_RH09_RH10",
              # #"mean_RH10_RH11", 
              # "mean_RH04_RH05_RH06",
              # "mean_RH05_RH06_RH07", 
              # "mean_RH07_RH08_RH09",
              # #"mean_RH08_RH09_RH10",
              # #"mean_RH09_RH10_RH11", 
              # "mean_RH03_RH04_RH05_RH06",
              # "mean_RH04_RH05_RH06_RH07",
              # "mean_RH05_RH06_RH07_RH08",
              # "mean_RH06_RH07_RH08_RH09",
              # #"mean_RH07_RH08_RH09_RH10",
              # #"mean_RH08_RH09_RH10_RH11",
              # "mean_RH03_RH04_RH05_RH06_RH07",
              # "mean_RH04_RH05_RH06_RH07_RH08",
              # "mean_RH05_RH06_RH07_RH08_RH09",
              # #"mean_RH06_RH07_RH08_RH09_RH10",
              # #"mean_RH07_RH08_RH09_RH10_RH11",
              # "mean_RH03_RH04_RH05_RH06_RH07_RH08",
              # "mean_RH04_RH05_RH06_RH07_RH08_RH9",
              
              "MDC_03",
              "MDC_04",
              "MDC_05",
              "MDC_06",
              "MDC_07", 
              "MDC_08", 
              "MDC_09",
              #"MDC_10", 
              #"MDC_11", 
              "mean_MDC_03_MDC_04",
              "mean_MDC_04_MDC_05",
              "mean_MDC_05_MDC_06",
              "mean_MDC_06_MDC_07", 
              "mean_MDC_07_MDC_08", 
              "mean_MDC_08_MDC_09",
              #"mean_MDC_09_MDC_10",
              #"mean_MDC_10_MDC_11", 
              "mean_MDC_04_MDC_05_MDC_06",
              "mean_MDC_05_MDC_06_MDC_07", 
              "mean_MDC_07_MDC_08_MDC_09",
              #"mean_MDC_08_MDC_09_MDC_10",
              #"mean_MDC_09_MDC_10_MDC_11", 
              "mean_MDC_03_MDC_04_MDC_05_MDC_06",
              "mean_MDC_04_MDC_05_MDC_06_MDC_07",
              "mean_MDC_05_MDC_06_MDC_07_MDC_08",
              "mean_MDC_06_MDC_07_MDC_08_MDC_09",
              #"mean_MDC_07_MDC_08_MDC_09_MDC_10",
              #"mean_MDC_08_MDC_09_MDC_10_MDC_11",
              "mean_MDC_03_MDC_04_MDC_05_MDC_06_MDC_07",
              "mean_MDC_04_MDC_05_MDC_06_MDC_07_MDC_08",
              "mean_MDC_05_MDC_06_MDC_07_MDC_08_MDC_09",
              #"mean_MDC_06_MDC_07_MDC_08_MDC_09_MDC_10",
              #"mean_MDC_07_MDC_08_MDC_09_MDC_10_MDC_11",
              "mean_MDC_03_MDC_04_MDC_05_MDC_06_MDC_07_MDC_08",
              "mean_MDC_04_MDC_05_MDC_06_MDC_07_MDC_08_MDC_9",
              
              "tot_spring_CMI",
              "tot_summer_CMI",
              "CMI03",
              "CMI04",
              "CMI05",
              "CMI06",
              "CMI07", 
              "CMI08", 
              "CMI09",
              #"CMI_10", 
              #"CMI_11", 
              "mean_CMI03_CMI04",
              "mean_CMI04_CMI05",
              "mean_CMI05_CMI06",
              "mean_CMI06_CMI07", 
              "mean_CMI07_CMI08", 
              "mean_CMI08_CMI09",
              #"mean_CMI_09_CMI_10",
              #"mean_CMI_10_CMI_11", 
              "mean_CMI04_CMI05_CMI06",
              "mean_CMI05_CMI06_CMI07", 
              "mean_CMI07_CMI08_CMI09",
              #"mean_CMI08_CMI09_CMI10",
              #"mean_CMI09_CMI10_CMI11", 
              "mean_CMI03_CMI04_CMI05_CMI06",
              "mean_CMI04_CMI05_CMI06_CMI07",
              "mean_CMI05_CMI06_CMI07_CMI08",
              "mean_CMI06_CMI07_CMI08_CMI09",
              #"mean_CMI07_CMI08_CMI09_CMI10",
              #"mean_CMI08_CMI09_CMI10_CMI11",
              "mean_CMI03_CMI04_CMI05_CMI06_CMI07",
              "mean_CMI04_CMI05_CMI06_CMI07_CMI08",
              "mean_CMI05_CMI06_CMI07_CMI08_CMI09",
              #"mean_CMI06_CMI07_CMI08_CMI09_CMI10",
              #"mean_CMI07_CMI08_CMI09_CMI10_CMI11",
              "mean_CMI03_CMI04_CMI05_CMI06_CMI07_CMI08",
              "mean_CMI04_CMI05_CMI06_CMI07_CMI08_CMI9",
              
              "tot_spring_CMD",
              "tot_summer_CMD",
              "CMD03",
              "CMD04",
              "CMD05",
              "CMD06",
              "CMD07", 
              "CMD08", 
              "CMD09",
              #"CMD10", 
              #"CMD11", 
              "mean_CMD03_CMD04",
              "mean_CMD04_CMD05",
              "mean_CMD05_CMD06",
              "mean_CMD06_CMD07", 
              "mean_CMD07_CMD08", 
              "mean_CMD08_CMD09",
              #"mean_CMD09_CMD10",
              #"mean_CMD10_CMD11", 
              "mean_CMD04_CMD05_CMD06",
              "mean_CMD05_CMD06_CMD07", 
              "mean_CMD07_CMD08_CMD09",
              #"mean_CMD08_CMD09_CMD10",
              #"mean_CMD09_CMD10_CMD11", 
              "mean_CMD03_CMD04_CMD05_CMD06",
              "mean_CMD04_CMD05_CMD06_CMD07",
              "mean_CMD05_CMD06_CMD07_CMD08",
              "mean_CMD06_CMD07_CMD08_CMD09",
              #"mean_CMD07_CMD08_CMD09_CMD10",
              #"mean_CMD08_CMD09_CMD10_CMD11",
              "mean_CMD03_CMD04_CMD05_CMD06_CMD07",
              "mean_CMD04_CMD05_CMD06_CMD07_CMD08",
              "mean_CMD05_CMD06_CMD07_CMD08_CMD09",
              #"mean_CMD06_CMD07_CMD08_CMD09_CMD10",
              #"mean_CMD07_CMD08_CMD09_CMD10_CMD11",
              "mean_CMD03_CMD04_CMD05_CMD06_CMD07_CMD08",
              "mean_CMD04_CMD05_CMD06_CMD07_CMD08_CMD9"
              )
```


```{r}
variables1<-c("spring_Tmax","summer_Tmax", "Tmax04","Tmax05", "Tmax06", "Tmax07", "Tmax08", "Tmax09",
              "mean_Tmax04_Tmax05","mean_Tmax05_Tmax06", "mean_Tmax06_Tmax07", "mean_Tmax07_Tmax08",
               "mean_Tmax04_Tmax05_Tmax06", "mean_Tmax05_Tmax06_Tmax07", "mean_Tmax04_Tmax05_Tmax06_Tmax07", "mean_Tmax05_Tmax06_Tmax07_Tmax08",
  
                          
               "spring_Tave","summer_Tave","Tave04","Tave05", "Tave06", "Tave07", "Tave08", "Tave09",
               "mean_Tave04_Tave05","mean_Tave05_Tave06", "mean_Tave06_Tave07", "mean_Tave07_Tave08",
              "mean_Tave04_Tave05_Tave06", "mean_Tave05_Tave06_Tave07", "mean_Tave04_Tave05_Tave06_Tave07", "mean_Tave05_Tave06_Tave07_Tave08"
              )
 
variables2<-c("tot_spring_PPT","tot_summer_PPT","PPT04","PPT05", "PPT06", "PPT07", "PPT08", "PPT09",
              "mean_PPT04_PPT05","mean_PPT05_PPT06", "mean_PPT06_PPT07", "mean_PPT07_PPT08",
               "mean_PPT04_PPT05_PPT06", "mean_PPT05_PPT06_PPT07", "mean_PPT04_PPT05_PPT06_PPT07", "mean_PPT05_PPT06_PPT07_PPT08",
              
              "tot_spring_PPT","tot_summer_PPT","PPT04","PPT05", "PPT06", "PPT07", "PPT08", "PPT09",
              "mean_PPT04_PPT05","mean_PPT05_PPT06", "mean_PPT06_PPT07", "mean_PPT07_PPT08",
               "mean_PPT04_PPT05_PPT06", "mean_PPT05_PPT06_PPT07", "mean_PPT04_PPT05_PPT06_PPT07", "mean_PPT05_PPT06_PPT07_PPT08") 
# precipitation and MDC and temperature and MDC are quite correlated so I'm leaving this combination of variables out. 

```

Modify variable names for ease in analysis.

```{r}
#Lightning
dat_lightning$frt[dat_lightning$frt=="3"]<-"5"
dat_lightning$fire_pres<-as.numeric(dat_lightning$fire) 
table(dat_lightning$fire_yr, dat_lightning$fire_pres)
table(dat_lightning$FIRE_CA, dat_lightning$frt)

# remove duplicate values

dat_lightning2<-dat_lightning %>%
  distinct(idno, .keep_all = TRUE)

```

#################################
#### Running simple logistic regression model
#################################

Now that the data is prepped, we are ready to run the logistic regression model for the lightning and person caused fires separately to determine the best climate variables.

We have three main options: separate by BEC zone (14), by Natural Disturbance Type (NDT), or by fire regime type (FRT). The initial code, now saved in the "old" folder, assesses by BEC zones independently. Cora did it by NDT and here we will run by fire regime type.


```{r}
# create loop to do variable selection of climate data
unique(dat_lightning2$frt)
str(dat_lightning2$frt)
dat_lightning2$frt<-as.factor(dat_lightning2$frt)
zones<- c("5", "12", "15", "7", "9", "10", "11", "13", "14")

filenames<-list()
prop<-0.75

```


Model selection for lightning caused fires:

```{r}

for (g in 1:100){
   print(paste(g))

for (h in 1:length(zones)) {
  #print(paste((variables[i]), (zones[h]), sep=" "))
  print(paste(zones[h], g, sep=" --"))
  dat2<- dat_lightning2 %>% dplyr::filter(frt ==zones[h])
  
#Create frame of AIC table
# summary table
table.glm.climate.simple <- data.frame (matrix (ncol = 4, nrow = 0))
colnames (table.glm.climate.simple) <- c ("Zone", "Variable", "AIC", "AUC")

# Create test and training datasets
dat_0<-dat2 %>% filter(fire_pres==0)
dt_0 = sort(sample(nrow(dat_0), nrow(dat_0)*prop))
train_0<-dat_0[dt_0,]
test_0<-dat_0[-dt_0,]

dat_1<-dat2 %>% filter(fire_pres==1)
dt_1 = sort(sample(nrow(dat_1), nrow(dat_1)*prop))
train_1<-dat_1[dt_1,]
test_1<-dat_1[-dt_1,]

dat_train<-rbind(train_0,train_1)
dat_test<-rbind(test_0,test_1)

model1 <- glm (fire_pres ~ 1 ,
               data=dat_train,
               family = binomial (link = "logit"))

table.glm.climate.simple[1,1]<-zones[h]
table.glm.climate.simple[1,2]<-"intercept"
table.glm.climate.simple[1,3]<-extractAIC(model1)[2]

# lets look at fit of the Valid (validation) dataset
dat_test$model1_predict <- predict.glm(model1,newdata = dat_test,type="response")
roc_obj <- roc(dat_test$fire_pres, dat_test$model1_predict, quiet=TRUE)
auc(roc_obj)
table.glm.climate.simple[1,4]<-auc(roc_obj)

#rm(model_dat,dat1,Valid)

for (i in 1: length(variables)){
  #print(paste((variables[i]), (zones[h]), sep=" "))
  
  #model_dat<- dat2 %>% dplyr::select(fire_pres, variables[i])
  dat_test1<-dat_test %>% dplyr::select(fire_pres, variables[i])
  dat_train1<-dat_train %>% dplyr::select(fire_pres,variables[i])
  
  model1 <- glm (fire_pres ~ . ,
                 data=dat_train1,
                 family = binomial (link = "logit"))
  
  table.glm.climate.simple[i+1,1]<-zones[h]
  table.glm.climate.simple[i+1,2]<-variables[i]
  table.glm.climate.simple[i+1,3]<-extractAIC(model1)[2]
  
  # lets look at fit of the Valid (validation) dataset
  dat_test1$model1_predict <- predict.glm(model1,newdata = dat_test1,type="response")
  roc_obj <- roc(dat_test1$fire_pres, dat_test1$model1_predict, quiet=TRUE)
  auc(roc_obj)
  table.glm.climate.simple[i+1,4]<-auc(roc_obj)
  
}

# This is an addition to the table above allowing combinations of temperature and precipitation

for (i in 1: length(variables1)){
  #print(paste((variables1[i]), variables2[i], (zones[h]), sep=" "))
  dat_train2<- dat_train %>% dplyr::select(fire_pres, variables1[i], variables2[i])
  dat_test2<-dat_test %>% dplyr::select(fire_pres, variables1[i], variables2[i])
  
  model2 <- glm (fire_pres ~ . ,
                 data=dat_train2,
                 family = binomial (link = "logit"))
  
  table.glm.climate.simple[(i+length(variables))+1,1]<-zones[h]
  table.glm.climate.simple[(i+length(variables))+1,2]<-paste0(variables1[i],"+", variables2[i])
  table.glm.climate.simple[(i+length(variables))+1,3]<-extractAIC(model2)[2]
  
  dat_test2$model2_predict <- predict.glm(model2,newdata = dat_test2,type="response")
  roc_obj <- roc(dat_test2$fire_pres, dat_test2$model2_predict,quiet=TRUE)
  auc(roc_obj)
  table.glm.climate.simple[(i+length(variables))+1,4]<-auc(roc_obj)
  
}

# for (i in 1: length(variables1)){
#   #print(paste((variables1[i]), "x",variables2[i], (zones[h]), sep=" "))
# 
#   if (dim(dat_1)[1]>150) {
#   model2 <- glm (fire_pres ~ (.)^2,
#                  data=dat_train2,
#                  family = binomial (link = "logit"))
# 
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),1]<-zones[h]
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),2]<-paste0(variables1[i],"x", variables2[i])
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),3]<-extractAIC(model2)[2]
# 
#   dat_test2$model2_predict <- predict.glm(model2,newdata = dat_test2,type="response")
#   roc_obj <- roc(dat_test2$fire_pres, dat_test2$model2_predict, quiet=TRUE)
#   auc(roc_obj)
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),4]<-auc(roc_obj)
#   } 
  
#   else {
#       table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),1]<-zones[h]
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),2]<-paste0(variables1[i],"x", variables2[i])
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),3]<-"missing"
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),4]<-"missing"
#   }
# 
# }

#table.glm.climate1<-table.glm.climate.simple %>% drop_na(AIC)


#assign file names to the work
nam1<-paste("AIC",zones[h],"run",g,sep="_") #defining the name
assign(nam1,table.glm.climate.simple)
filenames<-append(filenames,nam1)
}
}
# Common warning message: glm.fit: fitted probabilities numerically 0 or 1 occurred


```

Save output:

```{r}

mkFrameList <- function(nfiles) {
  d <- lapply(seq_len(nfiles),function(i) {
    eval(parse(text=filenames[i]))
  })
  do.call(rbind,d)
}

n<-length(filenames)
aic_bec_lightning<-mkFrameList(n) 

str(aic_bec_lightning)

aic_bec_lightning_a<-aic_bec_lightning %>% 
  filter(AIC != "missing") 

aic_bec_lightning$AIC<- as.numeric(aic_bec_lightning$AIC)
aic_bec_lightning$AUC<-as.numeric(aic_bec_lightning$AUC)
table(is.na(aic_bec_lightning$AIC))

aic_bec_lightning2<- aic_bec_lightning %>% na.omit()
  
aic_bec_lightning_summary<- aic_bec_lightning2 %>%
  group_by(Zone, Variable) %>%
  summarise(meanAIC=mean(AIC),
            meanAUC=mean(AUC),
            sdAUC=sd(AUC),
            )

aic_bec_lightning_summary2<- aic_bec_lightning_summary %>%
  group_by(Zone) %>%
  mutate(deltaAIC=meanAIC-min(meanAIC))

aic_bec_lightning_summary2

```

Save file to local computer:

```{r}
write.csv(aic_bec_lightning_summary2, file="C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\climate_AIC_results_lightning_Oct23.csv")
```

##########################################
###Repeat for person-caused fires:
##########################################

# first subsample data

```{r}
##Lightning caused - preparing the tables
pre<- fire_ignitions %>%
  filter(fire==1) %>%
  filter(!FIRE_CA %in% c("Lightning", "Unknown")) %>%
  dplyr::select(fire_yr, fire, frt, fwveg) %>%
  group_by(fire_yr, frt, fwveg) %>%
  summarize(fire_n=n())
head(pre)

##Get NA points
pre_checkpre<- fire_ignitions %>%
  filter(fire==0) %>%
  dplyr::select(fire_yr, fire, frt,fwveg) %>%
  group_by(fire_yr, frt, fwveg) %>%
  summarize(abs_n=n())
head(pre_checkpre)

check<-left_join(pre, pre_checkpre)
check %>% print(n=300) # hmm there are some NA's in the 0 column. I should probably correct that.

abs_match <- fire_ignitions %>%
  filter(fire == 0) %>%
  group_by(fire_yr, frt,fwveg) %>%   # prep for work by yr and veg type
  nest() %>%              # --> one row per yr and vegtype
  ungroup()

df<-left_join(check, abs_match) # make sure there are not veg year combinations that are not also in the fire_pres==1 file

# there are several year, zone, subzone combinations with no data in the tibble.  This code below removes the Null values. I should increase my sample of fire absences so that I don't have any combinations with zero data or sample it in a different way. TO DO!
df2 <- df %>% 
  filter(lengths(data)>0)

  sampled_df<- df2 %>% 
    mutate(samp = map2(data, floor(fire_n*5), sample_n, replace=TRUE)) %>%
    dplyr::select(-data) %>%
    unnest(samp) #%>%
  #dplyr::select(idno:frt)
 
# joining my subsampled absence data back to the fire ignition presence data
pre1<-  fire_ignitions %>%
  filter(fire==1) %>%
  filter(!FIRE_CA %in% c("Lightning", "Unknown"))
dim(sampled_df) # 
dim(pre1) #  15228 rows
sampled_df<-sampled_df %>% dplyr::select(!c(fire_n,abs_n))

dat_human<- rbind(pre1, as.data.frame(sampled_df))
dim(dat_human) 
table(dat_human$FIRE_CA)
table(dat_human$frt)
```

If all looks good from above, then save data.

```{r}
#Write file
write.csv(dat_human, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\dat_human_for_analysis.csv")

#st_write(dat_lightning, dsn = "C:\\Work\\caribou\\castor\\R\\fire_sim\\tmp\\dat_lightning_for_analysis.shp", delete_layer=TRUE)
```

##### Create variables for Model Selection ########
Create groupings of variables to put into model selection loop.


```{r}
# create loop to do variable selection of climate data

dat_human2<-dat_human %>%
  distinct(idno, .keep_all = TRUE)

unique(dat_human2$frt)
str(dat_human2$frt)
dat_human2$frt<-as.factor(dat_human2$frt)
zones<- c("5", "12", "15", "7", "9", "10", "11", "13", "14")

filenames<-list()
prop<-0.75

```



```{r}

for (g in 1:100){

for (h in 1:length(zones)) {
  print(paste((zones[h]), g, sep=" __"))
  dat2<- dat_human2 %>% dplyr::filter(frt ==zones[h])
  
#Create frame of AIC table
# summary table
table.glm.climate.simple <- data.frame (matrix (ncol = 4, nrow = 0))
colnames (table.glm.climate.simple) <- c ("Zone", "Variable", "AIC", "AUC")

# Create test and training datasets
dat_0<-dat2 %>% filter(fire==0)
dt_0 = sort(sample(nrow(dat_0), nrow(dat_0)*prop))
train_0<-dat_0[dt_0,]
test_0<-dat_0[-dt_0,]

dat_1<-dat2 %>% filter(fire==1)
dt_1 = sort(sample(nrow(dat_1), nrow(dat_1)*prop))
train_1<-dat_1[dt_1,]
test_1<-dat_1[-dt_1,]

dat_train<-rbind(train_0,train_1)
dat_test<-rbind(test_0,test_1)

model1 <- glm (fire ~ 1 ,
               data=dat_train,
               family = binomial (link = "logit"))

table.glm.climate.simple[1,1]<-zones[h]
table.glm.climate.simple[1,2]<-"intercept"
table.glm.climate.simple[1,3]<-extractAIC(model1)[2]

# lets look at fit of the Valid (validation) dataset
dat_test$model1_predict <- predict.glm(model1,newdata = dat_test,type="response")
roc_obj <- roc(dat_test$fire, dat_test$model1_predict, quiet=TRUE)
auc(roc_obj)
table.glm.climate.simple[1,4]<-auc(roc_obj)

#rm(model_dat,dat1,Valid)

for (i in 1: length(variables)){
  #print(paste((variables[i]), (zones[h]), sep=" "))
  
  #model_dat<- dat2 %>% dplyr::select(fire, variables[i])
  dat_test1<-dat_test %>% dplyr::select(fire, variables[i])
  dat_train1<-dat_train %>% dplyr::select(fire,variables[i])
  
  model1 <- glm (fire ~ . ,
                 data=dat_train1,
                 family = binomial (link = "logit"))
  
  table.glm.climate.simple[i+1,1]<-zones[h]
  table.glm.climate.simple[i+1,2]<-variables[i]
  table.glm.climate.simple[i+1,3]<-extractAIC(model1)[2]
  
  # lets look at fit of the Valid (validation) dataset
  dat_test1$model1_predict <- predict.glm(model1,newdata = dat_test1,type="response")
  roc_obj <- roc(dat_test1$fire, dat_test1$model1_predict, quiet=TRUE)
  auc(roc_obj)
  table.glm.climate.simple[i+1,4]<-auc(roc_obj)
  
}

# This is an addition to the table above allowing combinations of temperature and precipitation

for (i in 1: length(variables1)){
  #print(paste((variables1[i]), variables2[i], (zones[h]), sep=" "))
  dat_train2<- dat_train %>% dplyr::select(fire, variables1[i], variables2[i])
  dat_test2<-dat_test %>% dplyr::select(fire, variables1[i], variables2[i])
  
  model2 <- glm (fire ~ . ,
                 data=dat_train2,
                 family = binomial (link = "logit"))
  
  table.glm.climate.simple[(i+length(variables))+1,1]<-zones[h]
  table.glm.climate.simple[(i+length(variables))+1,2]<-paste0(variables1[i],"+", variables2[i])
  table.glm.climate.simple[(i+length(variables))+1,3]<-extractAIC(model2)[2]
  
  dat_test2$model2_predict <- predict.glm(model2,newdata = dat_test2,type="response")
  roc_obj <- roc(dat_test2$fire, dat_test2$model2_predict, quiet=TRUE)
  auc(roc_obj)
  table.glm.climate.simple[(i+length(variables))+1,4]<-auc(roc_obj)
  
}

# for (i in 1: length(variables1)){
#   print(paste((variables1[i]), "x",variables2[i], (zones[h]), sep=" "))
# 
#   if (dim(dat_1)[1]>150) {
#   model2 <- glm (fire ~ (.)^2,
#                  data=dat_train2,
#                  family = binomial (link = "logit"))
# 
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),1]<-zones[h]
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),2]<-paste0(variables1[i],"x", variables2[i])
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),3]<-extractAIC(model2)[2]
# 
#   dat_test2$model2_predict <- predict.glm(model2,newdata = dat_test2,type="response")
#   roc_obj <- roc(dat_test2$fire, dat_test2$model2_predict)
#   auc(roc_obj)
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),4]<-auc(roc_obj)
#   } 
#   
#   else {
#       table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),1]<-zones[h]
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),2]<-paste0(variables1[i],"x", variables2[i])
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),3]<-"missing"
#   table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),4]<-"missing"
#   }
#     
# 
# }

#table.glm.climate1<-table.glm.climate.simple %>% drop_na(AIC)


#assign file names to the work
nam1<-paste("AIC",zones[h],"run",g,sep="_") #defining the name
assign(nam1,table.glm.climate.simple)
filenames<-append(filenames,nam1)
}
}
# Common warning message: glm.fit: fitted probabilities numerically 0 or 1 occurred


```

Save output:

```{r}

mkFrameList <- function(nfiles) {
  d <- lapply(seq_len(nfiles),function(i) {
    eval(parse(text=filenames[i]))
  })
  do.call(rbind,d)
}

n<-length(filenames)
aic_bec_person<-mkFrameList(n) 

str(aic_bec_person)

aic_bec_person2<-aic_bec_person %>% 
  filter(AIC != "missing") 

aic_bec_person2$AIC<- as.numeric(aic_bec_person2$AIC)
aic_bec_person2$AUC<-as.numeric(aic_bec_person2$AUC)
table(is.na(aic_bec_person2$AIC))

aic_bec_person2<- aic_bec_person2 %>% na.omit()
  
aic_bec_person_summary<- aic_bec_person2 %>%
  group_by(Zone, Variable) %>%
  summarise(meanAIC=mean(AIC),
            meanAUC=mean(AUC),
            sdAUC=sd(AUC),
            )

aic_bec_person_summary2<- aic_bec_person_summary %>%
  group_by(Zone) %>%
  mutate(deltaAIC=meanAIC-min(meanAIC))

head(aic_bec_person_summary2)

```

Save file to local computer:

```{r}
write.csv(aic_bec_person_summary2, file="C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\climate_AIC_results_person_FRT_Oct23.csv")

```


#Need to save as csv and not shape file.

```{r}

#Save to postgre
#ogr2ogr -f PostgreSQL PG:"host=DC052586 user= dbname=castor password= port=5432" D:\\Fire\\fire_data\\raw_data\\Data_Person.csv -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

#ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres dbname=postgres password=postgres port=5432" D:\\Fire\\fire_data\\raw_data\\Data_Person.csv -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

#ogr2ogr -f PostgreSQL PG:"host=DC052586 user= dbname=castor password= port=5432" D:\\Fire\\fire_data\\raw_data\\Data_Lightning.csv -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

#ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres dbname=postgres password=postgres port=5432" D:\\Fire\\fire_data\\raw_data\\Data_Lightning.csv -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI
```


Clear work space to help R run faster again.

```{r}
library(gdata)

keep(fire_veg_data_B, ignition_pres_abs4, fire_veg_data_lightning_5x, fire_veg_data_person_5x, fire_veg_data_NA_5x, fire_veg_data_lightning_NA_5x, fire_veg_data_person_NA_5x, dat_lightning, dat_lightning_, dat_person, dat_person_, aic_bec_person_summary2, aic_bec_lightning_summary2, sure = TRUE) # setting sure to TRUE removes variables not in the list

#Or even fewer
keep(dat_lightning, dat_lightning_, dat_person, dat_person_, sure = TRUE) # setting sure to TRUE removes variables not in the list
 
ls()
gc(TRUE)
```


############### Complete. Now move on to 11_Fire_ignition_data_exploration.Rmd wherein the results of these AIC tests will be utilized###########

Note: for person-caused fires, we still need to load the roads map and decide whether to use the roads castor to predict road occurence back in time to 2002, or keep as is.











We also want difference from one month to the next and then for each fire, we will assign the difference depending on the month of fire.

NOTE: we investigated this but decided not to include it for the ignition models because its difficult to know how to deal with the points with no fire i.e. what value should you assign it? You could assign it the mean for the months or randomly assign it a month and then use that or assign it a month drawn from a distribution so that months with fires are represented more often. Anyway, there are many options so we chose to leave it out for ignition but include it for escape and spread.

```{r}
#Check months for fire
table(fire_ignitions$ig_mnth)
head(fire_ignitions) 

#Ensure all months available in data for comparisons
# fire_ignitions$tave_dif_01_02<-(fire_ignitions$tave02 - fire_ignitions$tave01)
# fire_ignitions$tave_dif_02_03<-(fire_ignitions$tave03 - fire_ignitions$tave02)
# fire_ignitions$tave_dif_03_04<-(fire_ignitions$tave04 - fire_ignitions$tave03)
fire_ignitions$Tave_dif_04_05<-(fire_ignitions$Tave05 - fire_ignitions$Tave04)
fire_ignitions$Tave_dif_05_06<-(fire_ignitions$Tave06 - fire_ignitions$Tave05)
fire_ignitions$Tave_dif_06_07<-(fire_ignitions$Tave07 - fire_ignitions$Tave06)
fire_ignitions$Tave_dif_07_08<-(fire_ignitions$Tave08 - fire_ignitions$Tave07)
fire_ignitions$Tave_dif_08_09<-(fire_ignitions$Tave09 - fire_ignitions$Tave08)
fire_ignitions$Tave_dif_09_10<-(fire_ignitions$Tave10 - fire_ignitions$Tave09)

#Create a variable that is the mean of the main months for which fires occur
fire_ignitions$Tave_dif_mean<-((fire_ignitions$Tave_dif_05_06 + fire_ignitions$Tave_dif_06_07 + fire_ignitions$Tave_dif_07_08 + fire_ignitions$Tave_dif_08_09)/4)

#Compare to the mean for each individually
mean(fire_ignitions$Tave_dif_05_06) #3.79
mean(fire_ignitions$Tave_dif_06_07) #3.004
mean(fire_ignitions$Tave_dif_07_08) #-0.852
mean(fire_ignitions$Tave_dif_08_09)  #-4.6906
fire_ignitions$Tave_dif_mean2<-((fire_ignitions$Tave_dif_05_06 + fire_ignitions$Tave_dif_06_07 + fire_ignitions$Tave_dif_07_08)/3)
mean(fire_ignitions$Tave_dif_mean2)

#Create a variable for the max difference for which fires most often occur
library(matrixStats)
fire_ignitions$Tave_dif_max<- rowMaxs(as.matrix(fire_ignitions[,c(123:128)])) #select columns for fire_ignitions$Tave_dif_05_06, fire_ignitions$Tave_dif_06_07, fire_ignitions$Tave_dif_07_08, fire_ignitions$Tave_dif_08_09)

head(fire_ignitions)
hist(fire_ignitions$Tave_dif_04_05)
hist(fire_ignitions$Tave_dif_05_06)
hist(fire_ignitions$Tave_dif_06_07)
hist(fire_ignitions$Tave_dif_07_08)
hist(fire_ignitions$Tave_dif_08_09)
table(fire_ignitions$ig_mnth) 

#Assign values by month fire occurred, with the TRUE value assigning to the locations where fire did not occur
fire_ignitions$Tdif_atfire<-0
fire_ignitions$ig_mnth<-as.numeric(fire_ignitions$ig_mnth)
head(fire_ignitions)
fire_ignitions_2<-fire_ignitions %>%
    mutate(Tdif_atfire = case_when(
      ig_mnth == 5 ~Tave_dif_04_05,
      ig_mnth == 6 ~ Tave_dif_05_06,
      ig_mnth == 7 ~ Tave_dif_06_07,
      ig_mnth == 8 ~ Tave_dif_07_08,
      ig_mnth == 9 ~ Tave_dif_08_09,
      ig_mnth == 10 ~ Tave_dif_09_10,
                                  TRUE ~ Tave_dif_mean)) #Those areas without fire will receive the mean value for the season. 

#try without 08_09 since temperature change goes in opposite direction
fire_ignitions_2$Tdif_atfireB<-0
fire_ignitions_2$ig_mnth<-as.numeric(fire_ignitions_2$ig_mnth)
head(fire_ignitions_2)
fire_ignitions_2<-fire_ignitions_2 %>%
    mutate(Tdif_atfireB = case_when(ig_mnth == 5 ~ Tave_dif_04_05,
                                  ig_mnth == 6 ~ Tave_dif_05_06,
                                  ig_mnth == 7 ~ Tave_dif_06_07,
                                  ig_mnth == 8 ~ Tave_dif_07_08,
                                  ig_mnth == 9 ~ Tave_dif_08_09,
                                  ig_mnth == 10 ~ Tave_dif_09_10,
                                  TRUE ~ Tave_dif_mean2)) #Those areas without fire will receive the mean value for the season. 
head(fire_ignitions_2)
hist(fire_ignitions_2$Tdif_atfireB) #Mostly clustered at slightly about 2

#Make a second, similar variable in which the TRUE statement represents the max difference instead of the mean
fire_ignitions_2$Tdif_atfire2<-0
head(fire_ignitions_2)
fire_ignitions_2<-fire_ignitions_2 %>%
    mutate(Tdif_atfire2 = case_when(ig_mnth == 5 ~ Tave_dif_04_05,
                                  ig_mnth == 6 ~ Tave_dif_05_06,
                                  ig_mnth == 7 ~ Tave_dif_06_07,
                                  ig_mnth == 8 ~ Tave_dif_07_08,
                                  ig_mnth == 9 ~ Tave_dif_08_09,
                                  ig_mnth == 10 ~ Tave_dif_09_10,
                                  TRUE ~ Tave_dif_max)) #Those areas without fire will receive the mean value for the season. 

head(fire_ignitions_2)
hist(fire_ignitions_2$Tdif_atfire)

fire_ignitions<-fire_ignitions_2

##Will not be able to be used for ignition, but should be able to be used for escape and fire size

```
Also get temperature at time of fire.

```{r}
fire_ignitions$T_atfire<-0
fire_ignitions$ig_mnth<-as.numeric(fire_ignitions$ig_mnth)
head(fire_ignitions)
fire_ignitions_<-fire_ignitions %>%
    mutate(T_atfire = case_when(ig_mnth == 5 ~ Tave05,
                          ig_mnth == 6 ~ Tave06,
                          ig_mnth == 7 ~ Tave07,
                          ig_mnth == 8 ~ Tave08,
                          ig_mnth == 9 ~ Tave09,
                          ig_mnth == 10 ~ Tave09, 
              TRUE ~ mean_Tave05_Tave06_Tave07_Tave08_Tave09)) #Those areas without fire will receive the mean value for the season. 

head(fire_ignitions_)

```


For each fire, let's extract the MDC in the specific month that fire began. Note that some fires actually began in months other than 05-09. For these, for now, we will select the nearest time (05 for January to April, and 09 for October and November). We may wish to get the actual values.

```{r}

names(fire_ignitions)
table(fire_ignitions$ig_mnth) #Some of these fires were started in October, November, January, February and March. Very unexpected.

fire_ignitions_$mdc_atfire<-0
fire_ignitions_<-fire_ignitions_ %>%
    mutate(mdc_atfire = case_when(ig_mnth == 5 ~ MDC_05,
                                  ig_mnth == 6 ~ MDC_06,
                                  ig_mnth == 7 ~ MDC_07,
                                  ig_mnth == 8 ~ MDC_08,
                                  ig_mnth == 9 ~ MDC_09,
                                  ig_mnth == 10 ~ MDC_09,
                                  ig_mnth == 11 ~ MDC_09,
                                  ig_mnth == 4 ~ MDC_04,
                                  TRUE ~ mean_MDC05_MDC06_MDC07_MDC08_MDC09)) #Those areas without fire will receive the mean value for the season. These MDC values may be most accurately used for the escape and spread data, wherein we only assess those areas where fires began.

head(fire_ignitions_)

```
Inspect how MDC for time of fire influences probability of ignition. This can be included in the modelling for monthly predictions.

```{r}
names(fire_ignitions_)
table(fire_ignitions_$fire)
fire_ignitions_$fire_pres<-fire_ignitions_$fire

p <- ggplot(fire_ignitions_, aes(mdc_atfire, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("MDC at fire") + ylab("Pr (ignition)")
p

#MDC at time of fire is hugely important for ignitions. However, need to remember, that these 0 points are created by taking the mean for the season... so biased. Matches intuition though and could be explored.
```
Create a second mdc_atfire metric setting the default to August MDC when no fire

```{r}
fire_ignitions_$mdc_atfire_2<-0
head(fire_ignitions_)
fire_ignitions_<-fire_ignitions_ %>%
    mutate(mdc_atfire_2 = case_when(ig_mnth == 5 ~ MDC_05,
                                  ig_mnth == 6 ~ MDC_06,
                                  ig_mnth == 7 ~ MDC_07,
                                  ig_mnth == 8 ~ MDC_08,
                                  ig_mnth == 9 ~ MDC_09,
                                  ig_mnth == 10 ~ MDC_09,
                                  TRUE ~ MDC_08)) #Those areas without fire will receive MDC of August, which in many years will be the highest value. These MDC values may be most accurately used for the escape and spread data, wherein we only assess those areas where fires began.

head(fire_ignitions_)
```

Inspect how this alters the probability of ignitions graph.

```{r}

p <- ggplot(fire_ignitions_, aes(mdc_atfire_2, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("MDC at fire") + ylab("Pr (ignition)")
p

#This makes the pattern exactly opposite because all locations without fire have a large MDC... not a good solution
```

Create new factor to parse out for training and validation data

```{r}
#create new column
fire_ignitions_$fire_zone<-paste(fire_ignitions_$fire_pres, fire_ignitions_$ntrl_ds)
str(fire_ignitions_$fire_zone)
fire_ignitions_$fire_zone<-as.factor(fire_ignitions_$fire_zone)
table(fire_ignitions_$fire_zone)
head(fire_ignitions_)
```


##### Create variables for Model Selextion ########
Create groupings of variables to put into model selection loop.

```{r}

variables<- c("Tmax05","Tmax06", "Tmax07", "Tmax08", "Tmax09", 
              "mean_Tmax05_Tmax06","mean_Tmax06_Tmax07", "mean_Tmax07_Tmax08", "mean_Tmax08_Tmax09", 
              "mean_Tmax05_Tmax06_Tmax07", "mean_Tmax06_Tmax07_Tmax08","mean_Tmax07_Tmax08_Tmax09", 
              "mean_Tmax05_Tmax06_Tmax07_Tmax08", "mean_Tmax06_Tmax07_Tmax08_Tmax09", "mean_Tmax05_Tmax06_Tmax07_Tmax08_Tmax09",
              
              "Tave05","Tave06", "Tave07", "Tave08", "Tave09", 
              "mean_Tave05_Tave06","mean_Tave06_Tave07", "mean_Tave07_Tave08", "mean_Tave08_Tave09", 
              "mean_Tave05_Tave06_Tave07", "mean_Tave06_Tave07_Tave08","mean_Tave07_Tave08_Tave09", 
              "mean_Tave05_Tave06_Tave07_Tave08", "mean_Tave06_Tave07_Tave08_Tave09", "mean_Tave05_Tave06_Tave07_Tave08_Tave09",
              
              "PPT05","PPT06", "PPT07", "PPT08", "PPT09",
              "mean_PPT05_PPT06", "mean_PPT06_PPT07", "mean_PPT07_PPT08", "mean_PPT08_PPT09", 
              "mean_PPT05_PPT06_PPT07","mean_PPT06_PPT07_PPT08", "mean_PPT07_PPT08_PPT09",
              "mean_PPT05_PPT06_PPT07_PPT08", "mean_PPT06_PPT07_PPT08_PPT09",
              "mean_PPT05_PPT06_PPT07_PPT08_PPT09",
              
              "MDC_05","MDC_06", "MDC_07", "MDC_08", "MDC_09",
              "mean_MDC05_MDC06", "mean_MDC06_MDC07", "mean_MDC07_MDC08", "mean_MDC08_MDC09", 
              "mean_MDC05_MDC06_MDC07", "mean_MDC06_MDC07_MDC08", "mean_MDC07_MDC08_MDC09", 
              "mean_MDC05_MDC06_MDC07_MDC08", "mean_MDC06_MDC07_MDC08_MDC09",
              "mean_MDC05_MDC06_MDC07_MDC08_MDC09",
              
              "RH05","RH06", "RH07", "RH08", "RH09",
              "mean_RH05_RH06", "mean_RH06_RH07", "mean_RH07_RH08", "mean_RH08_RH09", 
              "mean_RH05_RH06_RH07", "mean_RH06_RH07_RH08", "mean_RH07_RH08_RH09", 
              "mean_RH05_RH06_RH07_RH08", "mean_RH06_RH07_RH08_RH09",
              "mean_RH05_RH06_RH07_RH08_RH09")

 variables1<-c("Tmax05", "Tmax06", "Tmax07", "Tmax08", "Tmax09",
               "Tave05", "Tave06", "Tave07", "Tave08", "Tave09"
#               "Tmax05","Tmax06", "Tmax07", "Tmax08", "max09",
#               "mdc_05", "mdc_06", "mdc_07", "mdc_08", "mdc_09"
)
variables2<-c("PPT05", "PPT06", "PPT07", "PPT08", "PPT09",
              "PPT05", "PPT06", "PPT07", "PPT08", "PPT09"
              # "mdc_05", "mdc_06", "mdc_07", "mdc_08", "mdc_09",
              # "ppt05", "ppt06", "ppt07", "ppt08", "ppt09"
) 
# precipitation and MDC and temperature and MDC are quite correlated so I'm leaving this combination of variables out. 

```

Modify variable names for ease in analysis.

```{r}
#Lightning
fire_ignitions_$fire_pres<-as.numeric(fire_ignitions_$fire) 
table(fire_ignitions_$fire_yr, fire_ignitions_$fire_pres)
table(fire_ignitions_$fire_yr, fire_ignitions_$FIRE_CA, fire_ignitions_$Cluster)

#Create partition for selecting randomly within zones types for validation data

```

#################################
#### Running simple logistic regression model
#################################

Now that the data is prepped, we are ready to run the logistic regression model for the lightning and person caused fires separately to determine the best climate variables.

We have three main options: separate by BEC zone (14), or separate by Natural Disturbance Type (NDT). The initial code, now saved in the "old" folder, assesses by BEC zones independently. Cora did it by NDT and here we will run by fire regime type.


```{r}
# create loop to do variable selection of climate data
unique(fire_ignitions_$Cluster)
str(fire_ignitions_$Cluster)
fire_ignitions_$Cluster<-as.factor(fire_ignitions_$Cluster)
zones<- c("3", "5", "12", "15", "7", "9", "10", "11", "13", "14")

filenames<-list()
prop<-0.75

```

Model selection for lightning caused fires:

```{r}
dat_lightning_ <- fire_ignitions_ %>% filter(FIRE_CA=="Lightning")

for (g in 1:100){

for (h in 1:length(zones)) {
  dat2<- dat_lightning_ %>% dplyr::filter(Cluster ==zones[h])
  
#Create frame of AIC table
# summary table
table.glm.climate.simple <- data.frame (matrix (ncol = 4, nrow = 0))
colnames (table.glm.climate.simple) <- c ("Zone", "Variable", "AIC", "AUC")

model_dat<- dat2 %>% dplyr::select(fire_pres)
trainIndex <- caret::createDataPartition(model_dat$fire_pres, p = prop,
                                  list = FALSE,
                                  times = 1)
dat1 <- as.data.frame(model_dat[ trainIndex,])
names(dat1)[1] <- "fire_pres"
Valid <- as.data.frame(model_dat[-trainIndex,])
names(Valid)[1] <- "fire_pres"


model1 <- glm (fire_pres ~ 1 ,
               data=dat1,
               family = binomial (link = "logit"))

table.glm.climate.simple[1,1]<-zones[h]
table.glm.climate.simple[1,2]<-"intercept"
table.glm.climate.simple[1,3]<-extractAIC(model1)[2]

# lets look at fit of the Valid (validation) dataset
Valid$model1_predict <- predict.glm(model1,newdata = Valid,type="response")
roc_obj <- roc(Valid$fire_pres, Valid$model1_predict)
auc(roc_obj)
table.glm.climate.simple[1,4]<-auc(roc_obj)

rm(model_dat,dat1,Valid)

for (i in 1: length(variables)){
  print(paste((variables[i]), (zones[h]), sep=" "))
  
  model_dat<- dat2 %>% dplyr::select(fire_pres, variables[i])
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- caret::createDataPartition(model_dat$fire_pres, p = prop,
                                    list = FALSE,
                                    times = 1)
  dat1 <- model_dat[ trainIndex,]
  Valid <- model_dat[-trainIndex,]
  
  model1 <- glm (fire_pres ~ . ,
                 data=dat1,
                 family = binomial (link = "logit"))
  
  table.glm.climate.simple[i+1,1]<-zones[h]
  table.glm.climate.simple[i+1,2]<-variables[i]
  table.glm.climate.simple[i+1,3]<-extractAIC(model1)[2]
  
  # lets look at fit of the Valid (validation) dataset
  Valid$model1_predict <- predict.glm(model1,newdata = Valid,type="response")
  roc_obj <- roc(Valid$fire_pres, Valid$model1_predict)
  auc(roc_obj)
  table.glm.climate.simple[i+1,4]<-auc(roc_obj)
  
}

# This is an addition to the table above allowing combinations of temperature and precipitation

for (i in 1: length(variables1)){
  print(paste((variables1[i]), variables2[i], (zones[h]), sep=" "))
  model_dat<- dat2 %>% dplyr::select(fire_pres, variables1[i], variables2[i])
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- caret::createDataPartition(model_dat$fire_pres, p = prop,
                                    list = FALSE,
                                    times = 1)
  dat1 <- model_dat[ trainIndex,]
  Valid <- model_dat[-trainIndex,]
  
  model2 <- glm (fire_pres ~ . ,
                 data=dat1,
                 family = binomial (link = "logit"))
  
  table.glm.climate.simple[(i+length(variables))+1,1]<-zones[h]
  table.glm.climate.simple[(i+length(variables))+1,2]<-paste0(variables1[i],"+", variables2[i])
  table.glm.climate.simple[(i+length(variables))+1,3]<-extractAIC(model2)[2]
  
  Valid$model2_predict <- predict.glm(model2,newdata = Valid,type="response")
  roc_obj <- roc(Valid$fire_pres, Valid$model2_predict)
  auc(roc_obj)
  table.glm.climate.simple[(i+length(variables))+1,4]<-auc(roc_obj)
  
}

for (i in 1: length(variables1)){
  print(paste((variables1[i]), "x",variables2[i], (zones[h]), sep=" "))

  model_dat<- dat2 %>% dplyr::select(fire_pres, variables1[i], variables2[i])
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- caret::createDataPartition(model_dat$fire_pres, p = prop,
                                    list = FALSE,
                                    times = 1)
  dat1 <- model_dat[ trainIndex,]
  Valid <- model_dat[-trainIndex,]

  model2 <- glm (fire_pres ~ (.)^2,
                 data=dat1,
                 family = binomial (link = "logit"))

  table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),1]<-zones[h]
  table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),2]<-paste0(variables1[i],"x", variables2[i])
  table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),3]<-extractAIC(model2)[2]

  Valid$model2_predict <- predict.glm(model2,newdata = Valid,type="response")
  roc_obj <- roc(Valid$fire_pres, Valid$model2_predict)
  auc(roc_obj)
  table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),4]<-auc(roc_obj)

}
table.glm.climate1<-table.glm.climate.simple %>% drop_na(AIC)


#assign file names to the work
nam1<-paste("AIC",zones[h],"run",g,sep="_") #defining the name
assign(nam1,table.glm.climate.simple)
filenames<-append(filenames,nam1)
}
}
# Common warning message: glm.fit: fitted probabilities numerically 0 or 1 occurred


```

Save output:

```{r}

mkFrameList <- function(nfiles) {
  d <- lapply(seq_len(nfiles),function(i) {
    eval(parse(text=filenames[i]))
  })
  do.call(rbind,d)
}

n<-length(filenames)
aic_bec_lightning<-mkFrameList(n) 

aic_bec_lightning_summary<- aic_bec_lightning %>%
  group_by(Zone, Variable) %>%
  summarise(meanAIC=mean(AIC),
            meanAUC=mean(AUC),
            sdAUC=sd(AUC),
            )

aic_bec_lightning_summary2<- aic_bec_lightning_summary %>%
  group_by(Zone) %>%
  mutate(deltaAIC=meanAIC-min(meanAIC))

aic_bec_lightning_summary2

```

Save file to local computer:

```{r}
write.csv(aic_bec_lightning_summary2, file="D:\\Fire\\fire_data\\raw_data\\ClimateBC_Data\\climate_AIC_results_lightning_NDT.csv")
```


Repeat for person-caused fires:

```{r}
#zones should remain the same as for lightning caused fires

filenames<-list()
prop<-0.75

##Run loop
for (g in 1:100){

for (h in 1:length(zones)) {
  dat2<- dat_person_ %>% dplyr::filter(ntrl_ds ==zones[h])
  
#Create frame of AIC table
# summary table
table.glm.climate.simple <- data.frame (matrix (ncol = 4, nrow = 0))
colnames (table.glm.climate.simple) <- c ("Zone", "Variable", "AIC", "AUC")

model_dat<- dat2 %>% dplyr::select(fire_pres)
trainIndex <- caret::createDataPartition(model_dat$fire_pres, p = prop,
                                  list = FALSE,
                                  times = 1)
dat1 <- as.data.frame(model_dat[ trainIndex,])
names(dat1)[1] <- "fire_pres"
Valid <- as.data.frame(model_dat[-trainIndex,])
names(Valid)[1] <- "fire_pres"


model1 <- glm (fire_pres ~ 1 ,
               data=dat1,
               family = binomial (link = "logit"))

table.glm.climate.simple[1,1]<-zones[h]
table.glm.climate.simple[1,2]<-"intercept"
table.glm.climate.simple[1,3]<-extractAIC(model1)[2]

# lets look at fit of the Valid (validation) dataset
Valid$model1_predict <- predict.glm(model1,newdata = Valid,type="response")
roc_obj <- roc(Valid$fire_pres, Valid$model1_predict)
auc(roc_obj)
table.glm.climate.simple[1,4]<-auc(roc_obj)

rm(model_dat,dat1,Valid)

for (i in 1: length(variables)){
  print(paste((variables[i]), (zones[h]), sep=" "))
  
  model_dat<- dat2 %>% dplyr::select(fire_pres, variables[i])
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- caret::createDataPartition(model_dat$fire_pres, p = prop,
                                    list = FALSE,
                                    times = 1)
  dat1 <- model_dat[ trainIndex,]
  Valid <- model_dat[-trainIndex,]
  
  model1 <- glm (fire_pres ~ . ,
                 data=dat1,
                 family = binomial (link = "logit"))
  
  table.glm.climate.simple[i+1,1]<-zones[h]
  table.glm.climate.simple[i+1,2]<-variables[i]
  table.glm.climate.simple[i+1,3]<-extractAIC(model1)[2]
  
  # lets look at fit of the Valid (validation) dataset
  Valid$model1_predict <- predict.glm(model1,newdata = Valid,type="response")
  roc_obj <- roc(Valid$fire_pres, Valid$model1_predict)
  auc(roc_obj)
  table.glm.climate.simple[i+1,4]<-auc(roc_obj)
  
}

# This is an addition to the table above allowing combinations of temperature and precipitation

for (i in 1: length(variables1)){
  print(paste((variables1[i]), variables2[i], (zones[h]), sep=" "))
  model_dat<- dat2 %>% dplyr::select(fire_pres, variables1[i], variables2[i])
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- caret::createDataPartition(model_dat$fire_pres, p = prop,
                                    list = FALSE,
                                    times = 1)
  dat1 <- model_dat[ trainIndex,]
  Valid <- model_dat[-trainIndex,]
  
  model2 <- glm (fire_pres ~ . ,
                 data=dat1,
                 family = binomial (link = "logit"))
  
  table.glm.climate.simple[(i+length(variables))+1,1]<-zones[h]
  table.glm.climate.simple[(i+length(variables))+1,2]<-paste0(variables1[i],"+", variables2[i])
  table.glm.climate.simple[(i+length(variables))+1,3]<-extractAIC(model2)[2]
  
  Valid$model2_predict <- predict.glm(model2,newdata = Valid,type="response")
  roc_obj <- roc(Valid$fire_pres, Valid$model2_predict)
  auc(roc_obj)
  table.glm.climate.simple[(i+length(variables))+1,4]<-auc(roc_obj)
  
}

for (i in 1: length(variables1)){
  print(paste((variables1[i]), "x",variables2[i], (zones[h]), sep=" "))

  model_dat<- dat2 %>% dplyr::select(fire_pres, variables1[i], variables2[i])
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- caret::createDataPartition(model_dat$fire_pres, p = prop,
                                    list = FALSE,
                                    times = 1)
  dat1 <- model_dat[ trainIndex,]
  Valid <- model_dat[-trainIndex,]

  model2 <- glm (fire_pres ~ (.)^2,
                 data=dat1,
                 family = binomial (link = "logit"))

  table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),1]<-zones[h]
  table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),2]<-paste0(variables1[i],"x", variables2[i])
  table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),3]<-extractAIC(model2)[2]

  Valid$model2_predict <- predict.glm(model2,newdata = Valid,type="response")
  roc_obj <- roc(Valid$fire_pres, Valid$model2_predict)
  auc(roc_obj)
  table.glm.climate.simple[(i+length(variables) +length(variables1) + 1),4]<-auc(roc_obj)

}
table.glm.climate1<-table.glm.climate.simple %>% drop_na(AIC)


#assign file names to the work
nam1<-paste("AIC",zones[h],"run",g,sep="_") #defining the name
assign(nam1,table.glm.climate.simple)
filenames<-append(filenames,nam1)
}
}


```

Save output:

```{r}

mkFrameList <- function(nfiles) {
  d <- lapply(seq_len(nfiles),function(i) {
    eval(parse(text=filenames[i]))
  })
  do.call(rbind,d)
}

n<-length(filenames)
aic_bec_person<-mkFrameList(n) 

aic_bec_person_summary<- aic_bec_person %>%
  group_by(Zone, Variable) %>%
  summarise(meanAIC=mean(AIC),
            meanAUC=mean(AUC),
            sdAUC=sd(AUC),
            )

aic_bec_person_summary2<- aic_bec_person_summary %>%
  group_by(Zone) %>%
  mutate(deltaAIC=meanAIC-min(meanAIC))

head(aic_bec_person_summary2)
```

Save file to local computer:

```{r}
write.csv(aic_bec_person_summary2, file="D:\\Fire\\fire_data\\raw_data\\ClimateBC_Data\\climate_AIC_results_person_NDT.csv")

```

Save lightning and person caused fire datasets. These are now as csv files and not as shape files, so need to find correct way to save to castor.


```{r}
write.csv(dat_lightning_,file="D:\\Fire\\fire_data\\raw_data\\Data_Lightning")
write.csv(dat_person_,file="D:\\Fire\\fire_data\\raw_data\\Data_Person")
```

#Need to save as csv and not shape file.

```{r}

#Save to postgre
#ogr2ogr -f PostgreSQL PG:"host=DC052586 user= dbname=castor password= port=5432" D:\\Fire\\fire_data\\raw_data\\Data_Person.csv -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

#ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres dbname=postgres password=postgres port=5432" D:\\Fire\\fire_data\\raw_data\\Data_Person.csv -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

#ogr2ogr -f PostgreSQL PG:"host=DC052586 user= dbname=castor password= port=5432" D:\\Fire\\fire_data\\raw_data\\Data_Lightning.csv -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

#ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres dbname=postgres password=postgres port=5432" D:\\Fire\\fire_data\\raw_data\\Data_Lightning.csv -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI
```


Clear work space to help R run faster again.

```{r}
library(gdata)

keep(fire_veg_data_B, ignition_pres_abs4, fire_veg_data_lightning_5x, fire_veg_data_person_5x, fire_veg_data_NA_5x, fire_veg_data_lightning_NA_5x, fire_veg_data_person_NA_5x, dat_lightning, dat_lightning_, dat_person, dat_person_, aic_bec_person_summary2, aic_bec_lightning_summary2, sure = TRUE) # setting sure to TRUE removes variables not in the list

#Or even fewer
keep(dat_lightning, dat_lightning_, dat_person, dat_person_, sure = TRUE) # setting sure to TRUE removes variables not in the list
 
ls()
gc(TRUE)
```


############### Complete. Now move on to 09_Fire_ignition_model_fits_by_BEC wherein the results of these AIC tests will be utilized###########

Note: for person-caused fires, we still need to load the roads map and decide whether to use the roads castor to predict road occurence back in time to 2002, or keep as is.
