---
title: "13_Fire_Spread_Polygons"
author: "Cora Skaien"
date: "16/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Overview
In this file, we will be creating a 100 m buffer around each fire burn polygon, subtract the polygon area from the buffer, and then divide both the buffers and polygons into 1 ha squares (approximately). With this, we can attempt to create logistic regressions where the 1 ha squares from the buffers are 0 for spread and the 1 ha squares from the fire polygons receive a 1. The data will not b entirely related to environmental variables, however, as it will be confouneed by fire-fighting efforts and fire weather change - but we will see if we can find any patterns using this approach. I suspect climate will not be able to come out from this, resulting in fire size being important for characterizing how climate impacts fires. Here, we can assess how topography, VRI and land-use impact the probability of spread into neighbouring cells.

We will first need to bring in the perimeter data. Then we will need to create the buffer. Then we can create the 1 ha squares and assign them 0/1. We will not get ClimateBC data since the difference between adjacent cells will be minimal, but we will need to get VRI data for each 1 ha datapoint, including stand volume, age and height, and land-use (bclcs_5).

#Load in fire perimeter polygons
```{r}

fire_boundaries<-st_read(dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\H_FIRE_PLY_polygon.shp", stringsAsFactors = T)

st_crs(fire_boundaries)
fire_boundaries2 <- st_transform (fire_boundaries, 3005)
st_crs(fire_boundaries2) #Same as before

#Inspect
head(fire_boundaries2)

```

#Create a 100 m buffer

```{r}
fire_boundaries_buf<- st_buffer(fire_boundaries2, 100) # encircles a geometry object at a specified distance and returns a geometry object that is the buffer that surrounds the source object.

plot(fire_boundaries_buf)

#Note: we will need to separate by year because the overlapping polygons do not get separate buffers.

```
#The 100 m buffer was really small, so try 500 m for comparison. Still need to separate years.

```{r}
fire_boundaries_buf_500<- st_buffer(fire_boundaries2, 500) # encircles a geometry object at a specified distance and returns a geometry object that is the buffer that surrounds the source object.
```

#Subset for 2005-2020
```{r}
fire_boundaries2002_20<-subset(fire_boundaries2, fire_boundaries2$FIRE_YEAR>2001)
table(fire_boundaries2002_20$FIRE_YEAR)

st_write(fire_boundaries2002_20, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_polygon_2002_20.shp", delete_dsn = TRUE)
#Lots of error messages with many features not successfully writen...
```


#Get the difference between the buffer and the polygon 

```{r}
#fire_buffers<-st_difference(fire_boundaries_buf, fire_boundaries2)
##This did not work. May need to do difference in QGIS
```

#Save files and assess in QGIS
```{r}
#st_write(fire_buffers, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_polygon_buffers.shp", delete_dsn = TRUE)

st_write(fire_boundaries_buf, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_polygon_plus_buffer.shp", delete_dsn = TRUE)

st_write(fire_boundaries_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_polygon_plus_buffer_500.shp", delete_dsn = TRUE)
```

##Investigate years

If we want to get differences by buffers and polygons each year, it is best to separate by years so each polygon knows which other polygon to have a difference with.

```{r}
table(fire_boundaries2$FIRE_YEAR)
fire_boundaries2002_20<-subset(fire_boundaries2, fire_boundaries2$FIRE_YEAR>2001)
table(fire_boundaries2002_20$FIRE_YEAR)

fire_boundaries2002<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2002)
fire_boundaries2003<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2003)
fire_boundaries2004<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2004)
fire_boundaries2005<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2005)
fire_boundaries2006<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2006)
fire_boundaries2007<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2007)
fire_boundaries2008<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2008)
fire_boundaries2009<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2009)
fire_boundaries2010<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2010)
fire_boundaries2011<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2011)
fire_boundaries2012<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2012)
fire_boundaries2013<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2013)
fire_boundaries2014<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2014)
fire_boundaries2015<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2015)
fire_boundaries2016<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2016)
fire_boundaries2017<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2017)
fire_boundaries2018<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2018)
fire_boundaries2019<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2019)
fire_boundaries2020<-subset(fire_boundaries2002_20, fire_boundaries2002_20$FIRE_YEAR==2020)

```

```{r}

st_write(fire_boundaries2002, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2002.shp", delete_dsn = TRUE)

st_write(fire_boundaries2003, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2003.shp", delete_dsn = TRUE)

st_write(fire_boundaries2004, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2004.shp", delete_dsn = TRUE)

st_write(fire_boundaries2005, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2005.shp", delete_dsn = TRUE)

st_write(fire_boundaries2006, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2006.shp", delete_dsn = TRUE)

st_write(fire_boundaries2007, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2007.shp", delete_dsn = TRUE)

st_write(fire_boundaries2008, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2008.shp", delete_dsn = TRUE)

st_write(fire_boundaries2009, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2009.shp", delete_dsn = TRUE)

st_write(fire_boundaries2010, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2010.shp", delete_dsn = TRUE)

st_write(fire_boundaries2011, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2011.shp", delete_dsn = TRUE)

st_write(fire_boundaries2012, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2012.shp", delete_dsn = TRUE)

st_write(fire_boundaries2013, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2013.shp", delete_dsn = TRUE)

st_write(fire_boundaries2014, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2014.shp", delete_dsn = TRUE)

st_write(fire_boundaries2015, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2015.shp", delete_dsn = TRUE)

st_write(fire_boundaries2016, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2016.shp", delete_dsn = TRUE)

st_write(fire_boundaries2017, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2017.shp", delete_dsn = TRUE)

st_write(fire_boundaries2018, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2018.shp", delete_dsn = TRUE)

st_write(fire_boundaries2019, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2019.shp", delete_dsn = TRUE)

st_write(fire_boundaries2020, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_2020.shp", delete_dsn = TRUE)

```


##try 500 m and 100 m buffers

```{r}
fire_boundaries_2002_buf_500<- st_buffer(fire_boundaries2002, 500)
fire_boundaries_2003_buf_500<- st_buffer(fire_boundaries2003, 500)
fire_boundaries_2004_buf_500<- st_buffer(fire_boundaries2004, 500)
fire_boundaries_2005_buf_500<- st_buffer(fire_boundaries2005, 500)
fire_boundaries_2006_buf_500<- st_buffer(fire_boundaries2006, 500)
fire_boundaries_2007_buf_500<- st_buffer(fire_boundaries2007, 500)
fire_boundaries_2008_buf_500<- st_buffer(fire_boundaries2008, 500)
fire_boundaries_2009_buf_500<- st_buffer(fire_boundaries2009, 500)
fire_boundaries_2010_buf_500<- st_buffer(fire_boundaries2010, 500)
fire_boundaries_2011_buf_500<- st_buffer(fire_boundaries2011, 500)
fire_boundaries_2012_buf_500<- st_buffer(fire_boundaries2012, 500)
fire_boundaries_2013_buf_500<- st_buffer(fire_boundaries2013, 500)
fire_boundaries_2014_buf_500<- st_buffer(fire_boundaries2014, 500)
fire_boundaries_2015_buf_500<- st_buffer(fire_boundaries2015, 500)
fire_boundaries_2016_buf_500<- st_buffer(fire_boundaries2016, 500)
fire_boundaries_2017_buf_500<- st_buffer(fire_boundaries2017, 500)
fire_boundaries_2018_buf_500<- st_buffer(fire_boundaries2018, 500)
fire_boundaries_2019_buf_500<- st_buffer(fire_boundaries2019, 500)
fire_boundaries_2020_buf_500<- st_buffer(fire_boundaries2020, 500)

```

```{r}

st_write(fire_boundaries_2002_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2002.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2003_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2003.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2004_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2004.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2005_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2005.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2006_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2006.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2007_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2007.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2008_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2008.shp", delete_dsn = TRUE)


st_write(fire_boundaries_2009_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2009.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2010_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2010.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2011_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2011.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2012_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2012.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2013_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2013.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2014_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2014.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2015_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2015.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2016_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2016.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2017_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2017.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2018_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2018.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2019_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2019.shp", delete_dsn = TRUE)

st_write(fire_boundaries_2020_buf_500, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_boundaries_withbuffer_2020.shp", delete_dsn = TRUE)


```

Now that we have each year's polygons and buffers, we can go to QGIS and load each polygon-buffer set in QGIS and get the difference so that the buffer is separate from the polygon. In QGIS, we will also load in the BC Boundary layer and then use the "Create Grid" function to create points that are separated by 100 m vertically and horizontally to represent 1 ha portions of the province. We will then clip and intersect these points with the buffers and fire polygons for each year and designate the 0 and 1 values for whether fire spread into that cell or not. We can then combine all of the point data into one shape file, bring back into R, and append the topography and wind speed data. We will then attach VRI data the same way we did for ignition data prep, using the command line. Once we have all of that data appended, we can assess how spread 0/1 is impacted by slope, elevation, aspect, wind speed, landuse type (bclcs_5). We will need to combine some of the bclcs_5 land types together (e.g., rock and bare ground types) since data is low and it eats up degrees of freedom. May also want to consider subsetting for only >1ha, so if do, we will need to ensure that each buffer is associated with the appropriate fire ID and fire size.









```{r}
fire_buffers_2005<-st_difference(fire_boundaries_2005_buf_500, fire_boundaries2005)
head(fire_buffers_2005)
```

```{r}

st_write(fire_buffers_2005, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_buffer_2005_500m.shp", delete_dsn = TRUE)
#Write error and for some reason saves as a multi-line instead of a multi-polygon
```


Merge all polygons into one file with separate IDS.

```{r}
fire_boundaries_combined<-rbind(fire_boundaries_2005_buf_500, fire_boundaries_2003_buf_500, fire_boundaries_2004_buf_500, fire_boundaries_2005_buf_500, fire_boundaries_2006_buf_500, fire_boundaries_2007_buf_500, fire_boundaries_2008_buf_500, fire_boundaries_2009_buf_500, fire_boundaries_2010_buf_500, fire_boundaries_2011_buf_500, fire_boundaries_2012_buf_500, fire_boundaries_2013_buf_500, fire_boundaries_2014_buf_500, fire_boundaries_2015_buf_500, fire_boundaries_2016_buf_500, fire_boundaries_2017_buf_500, fire_boundaries_2018_buf_500, fire_boundaries_2019_buf_500, fire_boundaries_2020_buf_500)
```

Save file

```{r}
st_write(fire_boundaries_combined, overwrite=TRUE, dsn = "D:\\Fire\\fire_data\\raw_data\\Historical_Fire_Perimiter_polygons\\As of August 2021\\PROT_HISTORICAL_FIRE_POLYS_SP\\Fire_polygon_plus_buffer_allyears.shp", delete_dsn = TRUE)
```


