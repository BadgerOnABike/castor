---
title: "Fire_veg"
author: "Elizabeth Kleynhans"
date: '2022-08-19'
output: html_document
---

The goal here is to change the VRI layers for each year (2002 - 2021) into rasters of the FWI_veg. Each fuel type I will make a number and then have a look up table that assosiates that number with its fuel type code e.g. 1 = N, 2 = C2 etc.These raster maps i can then sample using my ignition points instead of doing it manually through QGIS.. which is inefficient if I have to re-do it and annoying!

Note: this is not as easy as I thought. The problem is that you need to sum species_pct_1 + species_pct_2 +... etc for all conifer species to get the % of conifers in an area. Another problem is that you need to get time since some disturbance. I calculate these in R but it does not seem as easy to do in postgres. Or I need to think about how to do it.

Another option I thought of is to create a FWI_veg map for the whole province for e.g. 2020 and then make this into a raster. This is maybe the better way to do this. Then I can sample from that raster instead of re-running this code each time when I want to predict fires in different areas of the province.

Note though if we run clus and get a different vegetation layer I will need to think about how to make this into a FWI_veg raster.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(tidyverse)
```


```{r}
vri_2020<-getSpatialQuery("select shape, inventory_standard_cd, non_productive_cd, coast_interior_cd, bclcs_level_1, bclcs_level_2, bclcs_level_3, bclcs_level_4, bclcs_level_5, non_veg_cover_type_1, land_cover_class_cd_1, est_cover_pct_1, land_cover_class_cd_2, est_cover_pct_2, land_cover_class_cd_3, est_cover_pct_3, line_7b_disturbance_history, bec_zone_code, bec_subzone, earliest_nonlogging_dist_type, earliest_nonlogging_dist_date, stand_percentage_dead, harvest_date, crown_closure, vri_live_stems_per_ha, vri_dead_stems_per_ha, species_cd_1, species_pct_1, species_cd_2, species_pct_2, species_cd_3, species_pct_3, species_cd_4, species_pct_4, species_cd_5, species_pct_5, species_cd_6, species_pct_6, proj_age_1,proj_height_1 from public.veg_comp_lyr_r1_poly2020")

vri_2020<-getSpatialQuery("select shape,species_cd_1, species_pct_1, species_cd_2, species_pct_2, species_cd_3, species_pct_3, species_cd_4, species_pct_4, species_cd_5, species_pct_5, species_cd_6, species_pct_6 from public.veg_comp_lyr_r1_poly2020")


FWI<-getSpatialQuery("select shape, 
                          CASE WHEN (SPECIES_CD_1 LIKE 'AC%'  or SPECIES_CD_2 LIKE 'AC%' or  SPECIES_CD_3 LIKE 'AC%' or (SPECIES_CD_1 LIKE 'S%' and SPECIES_CD_2 IS NULL)) and (bec_zone_code = 'SBS' and bec_subzone in('wk','mk','mm','mw')) THEN 1
                               WHEN (SPECIES_CD_1 LIKE 'AC%'  or SPECIES_CD_2 LIKE 'AC%' or  SPECIES_CD_3 LIKE 'AC%' or (SPECIES_CD_1 LIKE 'S%' and SPECIES_CD_2 IS NULL)) and (bec_zone_code = 'SBS' and bec_subzone in ('dw','dh','dk')) THEN 2
                               WHEN (SPECIES_CD_1 LIKE 'A%'  or SPECIES_CD_2 LIKE 'A%') and ((bec_zone_code = 'SBPS' and bec_subzone in('xc','mc','dc','mk')) or (bec_zone_code = 'IDF' and bec_subzone in('dk','dc','mw','dw','ww')) or (bec_zone_code = 'MS' and bec_subzone in('xc','xk','dv','dm', 'dk', 'dc'))) THEN 3
                               WHEN  (SPECIES_CD_1 LIKE 'F%' and SPECIES_CD_2  IS NULL) and ((bec_zone_code = 'SBPS' and bec_subzone in('xc','mc','dc','mk')) or (bec_zone_code = 'IDF' and bec_subzone in('dk','dc','mw','dw','ww')) or (bec_zone_code = 'MS' and bec_subzone in('xc','xk','dv','dm', 'dk', 'dc'))) THEN 4
                               WHEN (SPECIES_CD_1 LIKE 'AC%'  or SPECIES_CD_2 LIKE 'AC%' or  SPECIES_CD_3 LIKE 'AC%') and ((bec_zone_code = 'BWBS' and bec_subzone in ('dk', 'mw', 'mk', 'wk')) or (bec_zone_code ='SBS' and bec_subzone = 'wk' and bec_variant ='2')) THEN 5
                               WHEN (SPECIES_CD_1 LIKE 'AT%'  or SPECIES_CD_2 LIKE 'AT%' or  SPECIES_CD_3 LIKE 'AT%')  and ((bec_zone_code = 'BWBS' and bec_subzone in ('dk', 'mw', 'mk', 'wk')) or (bec_zone_code ='SBS' and bec_subzone = 'wk' and bec_variant ='2')) THEN 6
                               ELSE 0
                               END as region from public.veg_comp_lyr_r1_poly2020 where bec_zone_code in ('SBS', 'IDF', 'MS', 'SBPS', 'BWBS')")

```


```{r}

# looking at how many na values there are
table(is.na(VRI_2005$bec_zone_code))
table(is.na(VRI_2005$bclcs_level_1))
table(is.na(VRI_2005$bclcs_level_2))
table(is.na(VRI_2005$bclcs_level_3))
table(is.na(VRI_2005$bclcs_level_4))
table(is.na(VRI_2005$bclcs_level_5))

table((VRI_2005$bclcs_level_1)) # U=unreported, N = non-vegetated, V = vegetated
table((VRI_2005$bclcs_level_2)) # T= treed, N = Non-treed, L=Land, W=water
table((VRI_2005$bclcs_level_3)) # A = alpine, U = upland, W = wetland
table((VRI_2005$bclcs_level_4)) # 
table((VRI_2005$bclcs_level_5))
table(VRI_2005$bec_subzone)

VRI_2005$stand_percentage_dead<- round(VRI_2005$stand_percentage_dead,2)
VRI_2005$crown_closure<- round(VRI_2005$crown_closure,2)
VRI_2005$species_pct_1<- round(VRI_2005$species_pct_1,0)
VRI_2005$species_pct_2<- round(VRI_2005$species_pct_2,0)
VRI_2005$species_pct_3<- round(VRI_2005$species_pct_3,0)
VRI_2005$species_pct_4<- round(VRI_2005$species_pct_4,0)
VRI_2005$species_pct_5<- round(VRI_2005$species_pct_5,0)
VRI_2005$species_pct_6<- round(VRI_2005$species_pct_6,0)
VRI_2005$proj_age_1<- round(VRI_2005$proj_age_1,2)
VRI_2005$proj_height_1<- round(VRI_2005$proj_height_1,1)
VRI_2005$bec_zone_code<- (as.character(VRI_2005$bec_zone_code))
VRI_2005$bec_subzone<- as.character(VRI_2005$bec_subzone)
VRI_2005$species_cd_1<- (as.character(VRI_2005$species_cd_1))
VRI_2005$species_cd_2<- (as.character(VRI_2005$species_cd_2))
VRI_2005$species_cd_3<- (as.character(VRI_2005$species_cd_3))
VRI_2005$species_cd_4<- (as.character(VRI_2005$species_cd_4))
VRI_2005$species_cd_5<- (as.character(VRI_2005$species_cd_5))
VRI_2005$species_cd_6<- (as.character(VRI_2005$species_cd_6))

str(VRI_2005)

```


### Now Im going to try to use the VRI vegetation data to classify vegetation as Perrakis et al. (2018) British Columbia Wildfire Fuel Typing and Fuel Type Layer Description


First I need to create some new variables i.e. time since disturbance in years and time since last harvest. 
```{r}
# note: in this code fire_yr really refers to my focal year i.e. yr that i want to create this data for.
fire_yr<-2005
VRI_2005$yearHarvest<-as.numeric(as.character(stringi::stri_sub(VRI_2005$harvest_date,1,4)))
VRI_2005<- VRI_2005 %>% dplyr::mutate(yearsSinceHarvest = fire_yr - yearHarvest)

table(VRI_2005$yearsSinceHarvest)

VRI_2005$yearsSinceHarvest<- ifelse(VRI_2005$yearsSinceHarvest<1, NA, VRI_2005$yearsSinceHarvest)
VRI_2005 %>% filter(yearsSinceHarvest<1)
table(VRI_2005$yearsSinceHarvest)


VRI_2005$earliest_nonlogging_dist_type_2<-gsub('[" "]', '', VRI_2005$earliest_nonlogging_dist_type) # removing some weird characters
table(VRI_2005$earliest_nonlogging_dist_type)
table(VRI_2005$earliest_nonlogging_dist_type_2) # better

VRI_2005$earliest_nonlogging_dist_type<-VRI_2005$earliest_nonlogging_dist_type_2

VRI_2005$earliest_nonlogging_dist_type_2<- as.factor(VRI_2005$earliest_nonlogging_dist_type_2)
levels(VRI_2005$earliest_nonlogging_dist_type_2)<-list(burn="B",burn="BE", burn = "BG", burn="BR", burn="BW", burn="NB",drought="D",  disease="DF", disease="DMP", disease="DS", disease="DSG", insect="I", insect="IBB", insect="IBD", insect="IBF", insect="IBM", insect="IBS", flooding="NF", slide="NS", windthrow="NW", planting="P" ) # amalgamate some categories
table(VRI_2005$earliest_nonlogging_dist_type_2)

VRI_2005$earliest_nonlogging_dist_date
VRI_2005$yearDisturb<-as.numeric(as.character(stringi::stri_sub(VRI_2005$earliest_nonlogging_dist_date,1,4)))

VRI_2005$yearsSinceDisturbance<- ifelse (VRI_2005$fire_yr > VRI_2005$yearDisturb, VRI_2005$fire_yr - VRI_2005$yearDisturb, NA)
table(VRI_2005$yearsSinceDisturbance)

```

To save time and effort in coding I create a list of conifer and deciduous species and the bec_subzone codes that equate to wet areas. 
```{r}
conifer<-c("C","CW","Y","YC","F","FD","FDC","FDI","B","BB","BA","BG","BL","H","HM","HW","HXM","J","JR","JS","P","PJ","PF","PL","PR","PLI","PXJ","PY","PLC","PW","PA","S","SB","SE","SS","SW","SX","SXW","SXL","SXS","T","TW","X", "XC","XH", "ZC")

deciduous<-c("L", "LA", "LT", "LW", "D", "DR", "U", "UP", "A", "AC", "ACB", "ACT", "AX", "AT", "R", "RA", "E", "EA", "EXP", "EP", "EW", "K", "KC", "V", "VB", "VV", "VP", "G", "M", "MB", "MV", "Q", "QG", "W", "WB", "WP", "WA", "WD", "WS", "WT", "XH", "ZH")

wet<-c("mc", "mcp", "mh", "mk", "mkp", "mks", "mm", "mmp", "mmw", "ms", "mv", "mvp", "mw", "mwp", "mww", "vc", "vcp", "vcw", "vh", "vk", "vks", "vm", "wc", "wcp", "wcw", "wh", "whp", "wk", "wm", "wmp", "wmu", "ws", "wv", "wvp", "ww")
```

calculating total percent cover by conifers regardless of species. Also pulling out the name of the most dominant conifer. 

```{r}

VRI_2005<- VRI_2005 %>%
  mutate(pct1 = ifelse(species_cd_1 %in% conifer, species_pct_1, NA),
         pct2 = ifelse(species_cd_2 %in% conifer, species_pct_2, NA),
         pct3 = ifelse(species_cd_3 %in% conifer, species_pct_3, NA),
         pct4 = ifelse(species_cd_4 %in% conifer, species_pct_4, NA),
         pct5 = ifelse(species_cd_5 %in% conifer, species_pct_5, NA),
         pct6 = ifelse(species_cd_6 %in% conifer, species_pct_6, NA),
         dominant_conifer = ifelse(species_cd_1 %in% conifer, species_cd_1, 
                                   ifelse(species_cd_2 %in% conifer, species_cd_2,
                                          ifelse(species_cd_3 %in% conifer, species_cd_3,
                                                 ifelse(species_cd_4 %in% conifer, species_cd_4,
                                                        ifelse(species_cd_5 %in% conifer, species_cd_5,
                                                               ifelse(species_cd_6 %in% conifer, species_cd_6, NA)))))))

table(VRI_2005$dominant_conifer)

VRI_2005<-VRI_2005 %>% mutate(conifer_pct_cover_total=rowSums(across(c(pct1:pct6)), na.rm=TRUE))

# the above calculation puts zeros in rows with NA's so Im changing them back to NA
VRI_2005$conifer_pct_cover_total<- ifelse(is.na(VRI_2005$pct1) & is.na(VRI_2005$pct2) & is.na(VRI_2005$pct3) & is.na(VRI_2005$pct4) & is.na(VRI_2005$pct5) & is.na(VRI_2005$pct6), NA, VRI_2005$conifer_pct_cover_total)

tail(VRI_2005) # looks like it worked

```


Now I can hopefully follow the rules outlined at the end of Perrakis et al (2018)
First Ill code the non-vegetated areas
```{r}
VRI_2005$FWI_veg<-NA

#Now coding the VEGETATED areas

# recently burned
fire_all1<- VRI_2005 %>%
  mutate(FWI_veg = case_when(
          bclcs_level_1=="V" & bclcs_level_2=="T" & conifer_pct_cover_total>=60 & crown_closure > 40 & earliest_nonlogging_dist_type_2=="burn" & yearsSinceDisturbance < 4 ~ "N",
          bclcs_level_1=="V" & bclcs_level_2=="T" & conifer_pct_cover_total>=60 & crown_closure > 40 & earliest_nonlogging_dist_type_2=="burn" & (yearsSinceDisturbance > 3 & yearsSinceDisturbance < 7) ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & conifer_pct_cover_total>=60 & crown_closure > 40 & earliest_nonlogging_dist_type_2=="burn" & (yearsSinceDisturbance > 6 & yearsSinceDisturbance < 11) ~ "C-5",
          bclcs_level_1=="V" & bclcs_level_2=="T" & crown_closure < 41 & earliest_nonlogging_dist_type_2=="burn" & yearsSinceDisturbance <2 ~ "N",
          
           bclcs_level_1=="V" & bclcs_level_2=="T" & conifer_pct_cover_total>=60 & crown_closure <= 40 & earliest_nonlogging_dist_type_2=="burn" & (yearsSinceDisturbance > 1 & yearsSinceDisturbance <7) ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & conifer_pct_cover_total>=60 & crown_closure <= 40 & earliest_nonlogging_dist_type_2=="burn" & (yearsSinceDisturbance >6 & yearsSinceDisturbance < 11) ~ "O-1a/b",
        
          bclcs_level_1=="V" & bclcs_level_2=="T" & conifer_pct_cover_total<60 &  earliest_nonlogging_dist_type_2=="burn" & yearsSinceDisturbance < 2 ~ "N",
          bclcs_level_1=="V" & bclcs_level_2=="T" & conifer_pct_cover_total<60 &  earliest_nonlogging_dist_type_2=="burn" & (yearsSinceDisturbance >1 & yearsSinceDisturbance <11) ~ "D-1/2",
#          TRUE ~ as.character(FWI_veg)))

#table(fire_all1$FWI_veg)

#Pure lodgepole or jack or undefined pine species. Also I just included unknown conifer species (XC) here because lodgepole and jack and undefined pines are the most common conifer species. 

#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") & yearsSinceHarvest<=7 ~ "S-1",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") & bclcs_level_5=="SP" & bec_zone_code %in% c("ICH") & bec_subzone %in% wet  ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") & bclcs_level_5=="SP" & bec_zone_code %in% c("CWH", "CDF", "MH")  ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & bclcs_level_5=="SP" & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-7",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 &  bclcs_level_5 %in% c("DE", "OP") & proj_height_1<=4 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "O-1a/b",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & bclcs_level_5 %in% c("DE", "OP") & (proj_height_1 > 3 & proj_height_1 < 13) & (vri_live_stems_per_ha+vri_dead_stems_per_ha) > 8000 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-4",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & bclcs_level_5 %in% c("DE", "OP") & (proj_height_1 > 3 & proj_height_1 <13) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-3",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & bclcs_level_5 %in% c("DE", "OP") & proj_height_1 >12 & crown_closure <40 & bec_zone_code %in% c("BG", "PP", "IDF", "MS") & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-7",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & bclcs_level_5 %in% c("DE", "OP") & proj_height_1 >12 & crown_closure <40 & bec_zone_code %in% c("CWH", "MH", "ICH") & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-5",
           bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & bclcs_level_5 %in% c("DE", "OP") & proj_height_1 >12 & crown_closure <40 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-3",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance <=5 & stand_percentage_dead >50 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "M-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance <=5 & (stand_percentage_dead > 24 & stand_percentage_dead < 51) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance <=5 & stand_percentage_dead < 25 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-3",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance > 5 & stand_percentage_dead > 50 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P", "XC") ~ "C-3",
#          TRUE ~ as.character(FWI_veg)))
          
#table(fire_all1$FWI_veg)

# Pure ponderosa pine
#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1>= 80 & species_cd_1 == "PY" & bclcs_level_5 %in% c("DE","OP") & yearsSinceHarvest<=10 ~ "S-1",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "PY" & bclcs_level_5 %in% c("DE","OP") & proj_height_1 < 4~ "O-1a/b",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "PY" & bclcs_level_5 %in% c("DE","OP") & (proj_height_1 > 3 & proj_height_1 < 13) & (vri_live_stems_per_ha+vri_dead_stems_per_ha)>8000 ~ "C-4",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "PY" & bclcs_level_5 %in% c("DE","OP") & (proj_height_1 > 3 & proj_height_1 < 13) & ((vri_live_stems_per_ha+vri_dead_stems_per_ha) > 2999 & (vri_live_stems_per_ha+vri_dead_stems_per_ha) < 8001) ~ "C-3",

##**# # could maybe remove VRI stems part!! BELOW
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 > 79 & species_cd_1 == "PY" & bclcs_level_5 %in% c("DE","OP") & (proj_height_1 > 3 & proj_height_1 < 13) & ((vri_live_stems_per_ha+vri_dead_stems_per_ha)<3000 | is.na(vri_live_stems_per_ha+vri_dead_stems_per_ha)) ~ "C-7",
          
           bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 > 79 & species_cd_1 == "PY" & bclcs_level_5 =="DE" & (proj_height_1 > 11 & proj_height_1 < 18) ~ "C-3",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "PY" & (proj_height_1 > 11 & proj_height_1 < 18) ~ "C-7",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "PY" & proj_height_1 >17 ~ "C-7",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "PY" & bclcs_level_5 =="SP" & stand_percentage_dead >=40 ~ "O-1a/b",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "PY" & bclcs_level_5 =="SP" & yearsSinceHarvest<=10 ~ "S-1",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "PY" & bclcs_level_5 =="SP" ~ "C-7",
          
# PA, PF, PW

          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("PA", "PF", "PW") & bclcs_level_5 =="DE"  ~ "C-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("PA", "PF", "PW") & (vri_live_stems_per_ha+vri_dead_stems_per_ha)>=900  ~ "C-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("PA", "PF", "PW") & ((vri_live_stems_per_ha+vri_dead_stems_per_ha) > 599 & (vri_live_stems_per_ha+vri_dead_stems_per_ha) <901)  ~ "C-7",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("PA", "PF", "PW")  ~ "C-5",
        
#          TRUE ~ as.character(FWI_veg)))

#table(fire_all1$FWI_veg)

### pure douglas fir
#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI")  & yearsSinceHarvest<=6 & bec_zone_code %in% c("CWH", "MH", "CDF") ~ "S-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI")  & yearsSinceHarvest<=6 & bec_zone_code %in% c("ICH") & bec_subzone %in% wet ~ "S-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI")  & yearsSinceHarvest<=6 ~ "S-1",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & bec_zone_code %in% c("CWH", "MH", "CDF") & proj_height_1 < 4 ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & bec_zone_code =="ICH" & bec_subzone %in% wet & proj_height_1 < 4 ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & proj_height_1 < 4 ~ "O-1a/b",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 > 79 & dominant_conifer %in% c("F","FD","FDC","FDI") & bec_zone_code %in% c("CWH", "MH", "CDF") & (proj_height_1 >= 4 & proj_height_1<=12) & crown_closure >= 55 ~ "C-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & bec_zone_code =="ICH" & bec_subzone %in% wet & (proj_height_1 > 3 & proj_height_1< 13) & crown_closure > 55 ~ "C-3",

          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & (proj_height_1 >= 4 & proj_height_1<=12) & crown_closure > 55 & stand_percentage_dead > 34 ~ "C-4",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & (proj_height_1 >= 4 & proj_height_1<=12) & crown_closure > 55 ~ "C-3",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & bec_zone_code %in% c("CWH", "MH", "CDF") & proj_height_1>12 & crown_closure > 55  ~ "C-5",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & bec_zone_code %in% c("ICH") & bec_subzone %in% wet & crown_closure > 55 & proj_height_1>12  ~ "C-5",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & proj_height_1>12 & crown_closure > 55 ~ "C-7",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & bec_zone_code %in% c("CWH", "MH", "CDF") & (crown_closure > 25 & crown_closure < 56)  ~ "C-5", 
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & bec_zone_code %in% c("ICH") & bec_subzone %in% wet & (crown_closure > 25 & crown_closure < 56)  ~ "C-5", 
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & (crown_closure > 25 & crown_closure < 56)  ~ "C-7", 
        
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & bec_zone_code %in% c("CWH", "MH", "CDF") & crown_closure<26  ~ "D-1/2", 
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & bec_zone_code =="ICH" & bec_subzone %in% wet & crown_closure<26 ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("F","FD","FDC","FDI") & crown_closure<26 ~ "O-1a/b",
#          TRUE ~ as.character(FWI_veg)))

#table(fire_all1$FWI_veg)
# Pure Spruce

#fire_all1<- fire_all1 %>%
 # mutate(FWI_veg = case_when(
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "SE"  & yearsSinceHarvest<=10  ~ "S-2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "SE" & bclcs_level_5=="SP"  ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "SE" & bclcs_level_5=="DE"  ~ "C-2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "SE"  ~ "C-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "SS"  & yearsSinceHarvest<=6  ~ "S-3",
         bclcs_level_1=="V" & bclcs_level_2=="T" &  species_pct_1> 79 & species_cd_1 == "SS" & bclcs_level_5=="SP"  ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "SS" & bclcs_level_5 %in% c("DE","OP")  ~ "C-5",
          
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("SB", "SW")  & yearsSinceHarvest<=10  ~ "S-2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1  %in% c("SB", "SW") & bclcs_level_5 %in% c("DE","OP")  ~ "C-2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("SB", "SW") & bec_zone_code %in% c("BWBS", "SWB")  ~ "C-1",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("SB", "SW")  ~ "M-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("S","SX","SXW","SXL","SXS")  & yearsSinceHarvest<=7  ~ "S-2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("S","SX","SXW","SXL","SXS")  &  bec_zone_code %in% c("BWBS", "SWB") & bclcs_level_5 %in% c("DE", "OP")  ~ "C-2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("S","SX","SXW","SXL","SXS")  &  bec_zone_code %in% c("BWBS", "SWB")  ~ "C-1",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("S","SX","SXW","SXL","SXS")  &  !bec_zone_code %in% c("BWBS", "SWB") & bclcs_level_5 =="SP"  ~ "C-7",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("S","SX","SXW","SXL","SXS")  &  bec_zone_code %in% c("CWH", "CDF")  ~ "C-5",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("S","SX","SXW","SXL","SXS")  & proj_height_1 < 4  ~ "O-1a/b",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("S","SX","SXW","SXL","SXS")  & proj_height_1 >= 4 & bclcs_level_5 == "OP"  ~ "C-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("S","SX","SXW","SXL","SXS") & proj_height_1 >= 4  ~ "C-2",
        
#          TRUE ~ as.character(FWI_veg)))
#table(fire_all1$FWI_veg)

# Pure hemlock, redcedar or yellow cedar

#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("H","HM", "HW", "C","CW", "Y", "YC")  & yearsSinceHarvest<=6  ~ "S-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("H","HM", "HW", "C","CW", "Y", "YC")  & bclcs_level_5=="DE" & proj_height_1<4  ~ "D-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("H","HM", "HW", "C","CW", "Y", "YC")  & bclcs_level_5=="DE" & (proj_height_1 > 3 & proj_height_1<16)  ~ "C-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("H","HM", "HW", "C","CW", "Y", "YC")  & bclcs_level_5=="DE" & proj_age_1<60  ~ "C-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("H","HM", "HW", "C","CW", "Y", "YC")  & bclcs_level_5=="DE" & (proj_age_1 > 59 & proj_age_1<100)  ~ "M-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("H","HM", "HW", "C","CW", "Y", "YC")  & bclcs_level_5=="DE"  ~ "C-5",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("H","HM", "HW", "C","CW", "Y", "YC")  & bclcs_level_5=="OP"  ~ "C-5",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("H","HM", "HW", "C","CW", "Y", "YC")  ~ "D-1/2",
        
#          TRUE ~ as.character(FWI_veg)))

# True fir
#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "BG"  ~ "C-7",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 == "BA"  ~ "M-1/2",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("B", "BB", "BL")  & bclcs_level_5=="SP"  ~ "C-7",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("B", "BB", "BL")  ~ "C-3",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in%  c("T","TW")  ~ "C-5",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% c("J","JR","JS")  ~ "O-1a/b",
          bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1> 79 & species_cd_1 %in% deciduous  ~ "D-1/2",
#           TRUE ~ as.character(FWI_veg)))


######################
# Mixed species stand
######################

# left out the info about bclcs_level_1 and bclcs_level_2 because there were a few locations where this info was NA and so these areas were not classified.

## % Conifer 0 - 65 

#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 <80 & conifer_pct_cover_total<=20 ~ "D-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & is.na(conifer_pct_cover_total) ~ "D-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & yearsSinceHarvest<=6 & (conifer_pct_cover_total > 20 & conifer_pct_cover_total < 81) ~ "S-1",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 20 & conifer_pct_cover_total < 41) ~ "M-1/2",

            
# note for below I made the assumption that  on pg 39 of Perrakis et al. (2018) there were refering to the dominant conifer species  when they listed specific species. That is why only the first occurrence of a conifer gets the specific species  

## conifer cover 41 - 65%
bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & dominant_conifer %in% c("T","TW") & (conifer_pct_cover_total> 40 & conifer_pct_cover_total< 66) ~ "C-5",

bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 40 & conifer_pct_cover_total<66) & dominant_conifer %in% c("J","JR","JS")  ~ "O-1a/b",

bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 40 & conifer_pct_cover_total<66) & dominant_conifer %in% c("P","PJ","PF","PL","PLI","PY","PLC","PW","PA","F","FD","FDC","FDI","SE","S","SB","SS","SW","SX","SXW","SXL","SXS","C","CW","Y","YC","H","HM","HW","HXM","B","BB","BA","BG","BL")  ~ "M-1/2", # removed PXJ & PR 

#TRUE ~ as.character(FWI_veg)))

## conifer cover 65-80% 
#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 65 & conifer_pct_cover_total < 81) & dominant_conifer %in% c("PL", "PLI", "PLC", "PJ", "P") ~ "M-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 65 & conifer_pct_cover_total<81) & dominant_conifer =="PY" ~ "C-7",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 65 & conifer_pct_cover_total<81) & dominant_conifer %in% c("PA", "PF", "PW")  ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & bec_zone_code %in% c("CWH", "CDF") & (conifer_pct_cover_total > 65 & conifer_pct_cover_total<81) & dominant_conifer %in% c("F","FD","FDC")  ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & bec_zone_code %in% c("ICH") & bec_subzone %in% wet & (conifer_pct_cover_total > 65 & conifer_pct_cover_total<81) & dominant_conifer %in% c("F","FD","FDC")  ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & bclcs_level_5=="DE" & (conifer_pct_cover_total > 65 & conifer_pct_cover_total<81) & dominant_conifer %in% c("F","FD","FDC") ~ "M-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 65 & conifer_pct_cover_total<81) & dominant_conifer %in% c("F","FD","FDC") ~ "C-7",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 65 & conifer_pct_cover_total<81) & dominant_conifer %in% c("SS")  ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 65 & conifer_pct_cover_total < 81) & dominant_conifer %in% c("SE","S","SB","SS","SW","SX","SXW","SXL","SXS")  ~ "M-1/2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 65 & conifer_pct_cover_total < 81) & dominant_conifer %in% c("C","CW","Y","YC","H","HM","HW","HXM","T","TW")  ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 65 & conifer_pct_cover_total < 81) & dominant_conifer %in% c("B","BB","BA","BG","BL","J","JR","JS")  ~ "C-7",
    
bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1<80 & (conifer_pct_cover_total > 65 & conifer_pct_cover_total<81)  ~ "M-1/2",
#TRUE ~ as.character(FWI_veg)))


## conifer cover 81-100 %            
#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & yearsSinceHarvest<=7 ~ "S-1",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & bclcs_level_5 == "SP" & bec_zone_code %in% c("CWH", "CDF", "MH") ~ "D-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & bclcs_level_5 == "SP" & bec_zone_code %in% c("ICH") & bec_subzone %in% wet ~ "D-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & bclcs_level_5 == "SP" & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") ~ "C-7",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & proj_height_1<4 ~ "O-1a/b", 
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS")  & (proj_height_1 > 3 & proj_height_1 < 13) & (vri_live_stems_per_ha+vri_dead_stems_per_ha)>8000  ~ "C-4",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS") & (proj_height_1 > 3 & proj_height_1 < 13)  ~ "C-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS") & proj_height_1 > 12 & crown_closure<40 & bec_zone_code %in% c("BG", "PP", "IDF", "MS")   ~ "C-7",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS") & proj_height_1 > 12 & crown_closure<40 & bec_zone_code %in% c("CWH", "MH", "ICH")   ~ "C-5",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS") & proj_height_1 > 12 & crown_closure<40 ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS") & proj_height_1 > 12 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance<=5 &  stand_percentage_dead > 50 ~ "M-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS") & proj_height_1 > 12 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance<=5 &  stand_percentage_dead >= 25 & stand_percentage_dead <= 50 ~ "C-2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS") & bclcs_level_5=="DE" & proj_height_1 > 12 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance<=5 &  stand_percentage_dead < 25 ~ "C-2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS")  & proj_height_1 > 12 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance<=5 &  stand_percentage_dead < 25 ~ "C-3",

# years since IBM attack > 5
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total < 101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS")  & proj_height_1 > 12 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance > 5 &  stand_percentage_dead >50 ~ "C-2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS")  & proj_height_1 > 12 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance > 5 &  stand_percentage_dead >= 25 & stand_percentage_dead <= 50  & bclcs_level_5 == "DE" ~ "C-2",

bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS")  & proj_height_1 > 12 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance > 5 &  stand_percentage_dead >= 25 & stand_percentage_dead <= 50 ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS")  & proj_height_1 > 12 & earliest_nonlogging_dist_type=="IBM" & yearsSinceDisturbance > 5 & stand_percentage_dead<25  ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & species_cd_2 %in% c("B","BB","BA","BG","BL","SE","S","SB","SS","SW","SX","SXW","SXL","SXS")  & proj_height_1 > 12   ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & crown_closure <40 & bec_zone_code %in% c("IDF", "PP", "BG", "SBPW", "MS")   ~ "C-7",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") & crown_closure <40 & bec_zone_code %in% c("CWH", "CDF", "ICH")   ~ "C-5",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PL", "PLI", "PLC", "PJ", "P") ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PY") & yearsSinceHarvest<=7 ~ "S-1",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PY") & proj_height_1 < 4   ~ "O-1a/b",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PY") & bclcs_level_5=="DE"   ~ "C-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PY")   ~ "C-7",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PA", "PF", "PW") & bclcs_level_5=="DE"   ~ "C-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PA", "PF", "PW") & (vri_live_stems_per_ha+vri_dead_stems_per_ha)>=900   ~ "C-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PA", "PF", "PW") & (vri_live_stems_per_ha+vri_dead_stems_per_ha) >= 600 & (vri_live_stems_per_ha+vri_dead_stems_per_ha) <= 900   ~ "C-7",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & (conifer_pct_cover_total > 80 & conifer_pct_cover_total<101) & species_cd_1 %in% c("PA", "PF", "PW")   ~ "C-5",
#TRUE ~ as.character(FWI_veg)))

####################
#sp. 1 Fd or any F
####################

#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total >20 & species_cd_1 %in% c("F","FD","FDC","FDI") & yearsSinceHarvest<=6 & bec_zone_code %in% c("CWH", "MH","CDF") ~ "S-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & yearsSinceHarvest<=6 & bec_zone_code %in% c("ICH") & bec_subzone %in% wet ~ "S-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & yearsSinceHarvest<=6 ~ "S-1",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & proj_height_1 < 4 & bec_zone_code %in% c("CWH", "MH", "CDF") ~ "D-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & proj_height_1 < 4 & bec_zone_code %in% c("ICH") & bec_subzone %in% wet ~ "D-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & proj_height_1 < 4 ~ "O-1a/b",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & (proj_height_1 > 3 & proj_height_1 < 13) & crown_closure>55 & bec_zone_code %in% c("CWH", "MH", "CDF") ~ "C-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & (proj_height_1 > 3 & proj_height_1 < 13) & crown_closure>55 &bec_zone_code %in% c("ICH") & bec_subzone %in% wet ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & (proj_height_1 > 3 & proj_height_1 < 13) & crown_closure>55 & stand_percentage_dead >34 ~ "C-4",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & species_cd_2=="PY" & (proj_height_1 > 3 & proj_height_1 < 13) & crown_closure>55 ~ "C-7",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI") & (proj_height_1 > 3 & proj_height_1 < 13) & crown_closure>55 ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI")  & proj_height_1 >12 & crown_closure>55 & bec_zone_code %in% c("CWH", "MH", "CDF") ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI")  & crown_closure>55 & bec_zone_code %in% c("ICH") & bec_subzone %in% wet ~ "C-5",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI")  & crown_closure>55  ~ "C-7",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI")  & ((crown_closure >= 26 & crown_closure<= 55) | is.na(crown_closure)) & bec_zone_code %in% c("CWH", "MH", "CDF")  ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI")  & ((crown_closure >= 26 & crown_closure<= 55) | is.na(crown_closure)) & bec_zone_code %in% c("ICH") & bec_subzone %in% wet  ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI")  & ((crown_closure >= 26 & crown_closure<= 55) | is.na(crown_closure))  ~ "C-7",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI")  & crown_closure < 26 & bec_zone_code %in% c("CWH", "MH", "CDF") ~ "D-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI")  & crown_closure < 26 & bec_zone_code %in% c("ICH") & bec_subzone %in% wet ~ "D-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("F","FD","FDC","FDI")  & crown_closure < 26 ~ "O-1a/b",

#TRUE ~ as.character(FWI_veg)))

#### Sp1 S(any)
 
#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & yearsSinceHarvest<=6 & bec_zone_code %in% c("CWH", "MH","CDF") ~ "S-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & yearsSinceHarvest<=6 & bec_zone_code %in% c("ICH") & bec_subzone %in% wet ~ "S-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & yearsSinceHarvest<=6 ~ "S-2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SE") & bclcs_level_5=="SP" ~ "C-7",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SE") & species_cd_2 %in% c("BL", "B", "PL", "P", "PLI") & bclcs_level_5=="DE" ~ "C-2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SE") & species_cd_2 %in% c("BL", "B", "PL", "P", "PLI") ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SE") & species_cd_2 %in% c("HW", "HM", "CW", "YC") & bclcs_level_5=="DE" ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SE") & species_cd_2 %in% c("HW", "HM", "CW", "YC") ~ "C-5",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SE") ~ "C-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SS") ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SB") & bclcs_level_5 %in% c("DE","OP") ~ "C-2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SB") & bec_zone_code=="BWBS" ~ "C-1",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("SB") ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & bclcs_level_5 %in% c("DE") & bec_zone_code=="BWBS"  ~ "C-2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & bclcs_level_5 %in% c("OP") & bec_zone_code=="BWBS"  ~ "C-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & bec_zone_code=="BWBS"  ~ "C-1",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & bec_zone_code %in% c("CWH","MH","CDF") & species_cd_2 %in% c("BL", "B", "P","PJ","PF","PL","PR","PLI","PXJ","PY","PLC","PW","PA") & bclcs_level_5=="SP"  ~ "C-7",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & bec_zone_code %in% c("CWH","MH","CDF") & species_cd_2 %in% c("BL", "B", "P","PJ","PF","PL","PR","PLI","PXJ","PY","PLC","PW","PA")  ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & bec_zone_code %in% c("CWH","MH","CDF")  ~ "C-5",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & coast_interior_cd=="I" & bclcs_level_5=="SP"  ~ "C-7",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & coast_interior_cd=="I" & bclcs_level_5=="DE"  ~ "C-2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & coast_interior_cd=="I" & stand_percentage_dead>34 ~ "C-2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") & coast_interior_cd=="I" & species_cd_2 %in% c("PL","PLI","P") ~ "C-2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("S","SB","SE","SS","SW","SX","SXW","SXL","SXS") ~ "C-3",

#TRUE ~ as.character(FWI_veg)))

### H(any), C(any), Y(any)

#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("C","CW","Y","YC","H","HM","HW","HXM") & yearsSinceHarvest<=6 ~ "S-3",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("C","CW","Y","YC","H","HM","HW","HXM") & bclcs_level_5=="DE" & proj_height_1<4 ~ "D-1/2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("C","CW","Y","YC","H","HM","HW","HXM") & bclcs_level_5=="DE" & proj_height_1 > 3 & proj_height_1 < 16 ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("C","CW","Y","YC","H","HM","HW","HXM") & bclcs_level_5=="DE" & proj_age_1<60 ~ "C-3",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("C","CW","Y","YC","H","HM","HW","HXM") & bclcs_level_5=="DE" & proj_age_1 > 59 & proj_height_1<100 ~ "M-1/2",

    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("C","CW","Y","YC","H","HM","HW","HXM") & bclcs_level_5=="SP" ~ "D-1/2",
    bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("C","CW","Y","YC","H","HM","HW","HXM") ~ "C-5",

#TRUE ~ as.character(FWI_veg)))

### BG, BA, B etc also T

#fire_all1<- fire_all1 %>%
#  mutate(FWI_veg = case_when(
bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("BG") ~ "C-7",
bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("BA") & species_cd_2 %in% c("SE", "SW", "S") ~ "C-3",
bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("BA") ~ "M-1/2",

bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("B","BB","BL") & coast_interior_cd=="C" ~ "M-1/2",

bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("B","BB","BL") & bclcs_level_5=="SP" ~ "C-7",
bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("B","BB","BL") & bclcs_level_5=="DE" & species_cd_2 %in% c("SE", "SW", "S") ~ "C-2",
bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("B","BB","BL") ~ "C-3",
bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("T","TW") ~ "C-5",
bclcs_level_1=="V" & bclcs_level_2=="T" & species_pct_1 < 80 & conifer_pct_cover_total > 20 & species_cd_1 %in% c("J","JR","JS") ~ "C-7",

TRUE ~ as.character(FWI_veg)))

table(fire_all1$FWI_veg)

### non-forested bclcs_level_2==N recently burned

fire_all1<- fire_all1 %>%
  mutate(FWI_veg = case_when(
bclcs_level_1=="V" & bclcs_level_2=="N" & earliest_nonlogging_dist_type_2 == "burn" & yearsSinceDisturbance < 2 ~ "N",
                             
bclcs_level_1=="V" & bclcs_level_2=="N" & earliest_nonlogging_dist_type_2 == "burn" & (yearsSinceDisturbance > 1 & yearsSinceDisturbance < 4) ~ "D-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & earliest_nonlogging_dist_type_2 == "burn" & (yearsSinceDisturbance> 4 & yearsSinceDisturbance<11) ~ "O-1a/b",

TRUE ~ as.character(FWI_veg)))

### logged
fire_all1<- fire_all1 %>%
  mutate(FWI_veg = case_when(bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest<=7 & species_cd_1 %in% c("P","PJ","PF","PL","PR","PLI","PXJ","PY","PLC","PW","PA") ~ "S-1",
                             
bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest<=7 & species_cd_1 %in% c("B","BB","BA","BG","BL","S","SB","SE","SS","SW","SX","SXW","SXL","SXS") ~ "S-2",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest<=7 & species_cd_1 %in% c("C","CW","Y","YC","H","HM","HW","HXM") ~ "S-3",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest<=7 & species_cd_1 %in% c("FD") & bec_zone_code %in% c("CWH", "ICH") ~ "S-3",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest<=7 ~ "S-1",

bclcs_level_1=="V" & bclcs_level_2=="N" & (yearsSinceHarvest> 7 & yearsSinceHarvest<25) & bec_zone_code %in% c("CWH", "MH") ~ "D-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & (yearsSinceHarvest> 7 & yearsSinceHarvest<25) & bec_zone_code %in% c("ICH") & bec_subzone %in% wet ~ "D-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & (yearsSinceHarvest> 7 & yearsSinceHarvest<25) ~ "O-1a/b",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("CMA", "IMA") ~ "N",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("BAFA") ~ "D-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("CWH") & bec_subzone %in% wet ~ "C-5",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("CWH") ~ "M-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("BWBS") ~ "C-2",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("SWB") ~ "M-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("SBS") ~ "C-3",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("SBPS") ~ "C-7",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("MS", "ESSF") ~ "C-3",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("IDF") & bec_subzone %in% wet ~ "C-3",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("PP", "BG") ~ "O-1a/b",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("MH") ~ "D-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("CDF", "ICH") & bec_subzone %in% wet ~ "C-5",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("IDF", "CDF") ~ "C-7",

bclcs_level_1=="V" & bclcs_level_2=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("ICH") ~ "C-3",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest <=5 ~ "S-1",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & (yearsSinceHarvest > 5 & yearsSinceHarvest<25) & bec_zone_code %in% c("CWH", "MH", "ICH") ~ "D-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & (yearsSinceHarvest > 5 & yearsSinceHarvest<25) ~ "O-1a/b",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("CMA", "IMA") ~ "N",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("BAFA") ~ "D-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("CWH") & bec_subzone %in% wet ~ "C-5",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("CWH") ~ "M-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("BWBS") ~ "C-2",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("SWB") ~ "M-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("SBS") ~ "C-3",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("SBPS") ~ "C-7",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("MS") ~ "C-7",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("IDF") & bec_subzone %in% wet ~ "M-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("IDF") ~ "C-7",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("PP", "BG") ~ "O-1a/b",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("MH") ~ "D-1/2",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("CDF", "ICH") & bec_subzone %in% wet ~ "C-5",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("ESSF", "CDF") ~ "C-7",

bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(species_cd_1) & yearsSinceHarvest >= 25 & bec_zone_code %in% c("ICH") ~ "M-1/2",

TRUE ~ as.character(FWI_veg)))

table(fire_all1$FWI_veg)

#### Unlogged
fire_all1<- fire_all1 %>%
  mutate(FWI_veg = case_when(bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & !is.na(species_cd_1) & bec_zone_code %in% c("CMA", "IMA")  ~ "N",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & !is.na(species_cd_1) & bec_zone_code %in% c("CWH", "MH", "ICH", "BAFA")  ~ "D-1/2",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & !is.na(species_cd_1)  ~ "O-1a/b",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd=="F" & non_productive_cd >10 & non_productive_cd<14 & bec_zone_code %in% c("CWH", "MH", "ICH")  ~ "D-1/2",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd=="F" & non_productive_cd >10 & non_productive_cd<14 ~ "O-1a/b",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd=="F" & non_productive_cd ==35  ~ "W",
                             
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd=="F" & non_productive_cd ==42  ~ "N",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd=="F" & (non_productive_cd == 60 |non_productive_cd == 62 | non_productive_cd == 63)  ~ "O-1a/b",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd=="F" &  bec_zone_code %in% c("CMA","IMA")  ~ "N",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd=="F" & bec_zone_code %in% c("CWH","MH", "ICH", "BAFA")  ~ "D-1/2",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd=="F" & is.na(non_productive_cd) ~ "O-1a/b",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd=="F"  ~ "N",
                             
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd %in% c("V", "I") & land_cover_class_cd_1 %in% c("LA", "RE","RL","OC")  ~ "W",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd %in% c("V", "I") & land_cover_class_cd_1 %in% c("HG")  ~ "O-1a/b",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd %in% c("V", "I") & land_cover_class_cd_1 %in% c("BY", "BM","BL")  ~ "D-1/2",
                             
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd %in% c("V", "I") & (land_cover_class_cd_1 %in% c("SL", "ST","HE","HF") |is.na(land_cover_class_cd_1)) & bec_zone_code %in% c("CMA", "IMA")  ~ "N",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd %in% c("V", "I") & (land_cover_class_cd_1 %in% c("SL", "ST","HE","HF") |is.na(land_cover_class_cd_1)) & bec_zone_code %in% c("CWH", "MH", "ICH")  ~ "D-1/2",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd %in% c("V", "I") & (land_cover_class_cd_1 %in% c("SL", "ST","HE","HF") |is.na(land_cover_class_cd_1))  ~ "O-1a/b",
                             bclcs_level_1=="V" & bclcs_level_2=="N" & is.na(harvest_date) & is.na(species_cd_1) & inventory_standard_cd %in% c("V", "I") & land_cover_class_cd_1 %in% c("SI", "GL","PN","RO", "BR", "TA", "BI", "MZ", "LB", "EL", "RS", "ES", "LS", "RM", "BE", "LL", "BU", "RZ", "MU", "CB", "MN", "GP", "TZ", "RN", "UR", "AP", "MI", "OT", "LA", "RE", "RI", "OC")  ~ "N",
                             
                             TRUE ~ as.character(FWI_veg)))

                             
fire_all1<- fire_all1 %>%
  mutate(FWI_veg = case_when(
    non_veg_cover_type_1=="OC" ~ "W",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("CMA", "IMA")  ~ "N",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("BAFA")  ~ "D-1/2",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("CWH") & bec_subzone %in% wet  ~ "C-5",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("CWH")  ~ "M-1/2",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("BWBS")  ~ "C-2",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("SWB")  ~ "M-1/2",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("SBS")  ~ "C-3",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("SBPS")  ~ "C-7",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("MS")  ~ "C-3",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("IDF") & bec_subzone %in% wet  ~ "M-1/2",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("IDF")  ~ "C-7",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("PP")  ~ "C-7",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("BG")  ~ "O-1a/b",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("MH")  ~ "C-5",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("ESSF")  ~ "C-3",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("CDF") & bec_subzone %in% wet  ~ "C-5",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("CDF")  ~ "C-7",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("ICH") & bec_subzone %in% wet  ~ "C-5",
    ((is.na(species_cd_1) & is.na(species_cd_2))|is.na(FWI_veg)) & bec_zone_code %in% c("ICH")  ~ "M-1/2",
                             TRUE ~ as.character(FWI_veg)))

# not vegetated and logged
fire_all1<- fire_all1 %>%
  mutate(FWI_veg = case_when(
    # harvest date 0-6
          bclcs_level_1=="N" & yearsSinceHarvest <= 6 & coast_interior_cd=="C" ~ "S-3",
          bclcs_level_1=="N" & yearsSinceHarvest <= 6 & coast_interior_cd =="I" ~ "S-1",
    # harvest date 7-24
          bclcs_level_1=="N" & (yearsSinceHarvest > 6 & yearsSinceHarvest<25) & bec_zone_code %in% c("CWH","MH","ICH") ~ "D-1/2",
          bclcs_level_1=="N" & (yearsSinceHarvest > 6 & yearsSinceHarvest<25) ~ "O-1a/b",
    # harvest date > 25
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("CMA","IMA") ~ "N",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="BAFA" ~ "D-1/2",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="CWH" & (bec_subzone %in% wet) ~ "C-5",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="CWH" & (!bec_subzone %in% wet) ~ "M-1/2",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="BWBS" ~ "C-2",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="SWB" ~ "M-1/2",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="SBS" ~ "C-3",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="SBPS" ~ "C-7",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="MS" ~ "C-7",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="IDF" & (bec_subzone %in% wet) ~ "C-3",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="IDF" & (!bec_subzone %in% wet) ~ "C-7",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code %in% c("PP","BG") ~ "O-1a/b",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="MH" ~ "D-1/2",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="ESSF" ~ "C-7",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="CDF" & (bec_subzone %in% wet) ~ "C-5",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="CDF" & (!bec_subzone %in% wet) ~ "C-7",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="ICH" & (bec_subzone %in% wet) ~ "C-5",
          bclcs_level_1=="N" & yearsSinceHarvest >=25 & bec_zone_code=="ICH" & (!bec_subzone %in% wet) ~ "C-3",
          
# not vegetated and not logged, Recently burned   

          bclcs_level_1=="N" & earliest_nonlogging_dist_type_2=="burn" & yearsSinceDisturbance <=3 ~"N",
          bclcs_level_1=="N" & earliest_nonlogging_dist_type_2=="burn" & (yearsSinceDisturbance > 3 & yearsSinceDisturbance < 7) ~"D-1/2",
          bclcs_level_1=="N" & earliest_nonlogging_dist_type_2=="burn" & (yearsSinceDisturbance > 6 & yearsSinceDisturbance < 11) ~"O-1a/b",

# not logged and not recently burned
          bclcs_level_1=="N" & (bclcs_level_2=="L" | is.na(bclcs_level_2)) & bclcs_level_3=="A" ~"N",          
          bclcs_level_1=="N" & (bclcs_level_2=="L" | is.na(bclcs_level_2)) &  species_pct_1 > 0 & bec_zone_code %in% c("CWH", "MH", "ICH") ~ "D-1/2",
          bclcs_level_1=="N" & (bclcs_level_2=="L" | is.na(bclcs_level_2)) & species_pct_1 > 0 ~ "O-1a/b",
          bclcs_level_1=="N" & (bclcs_level_2=="L" | is.na(bclcs_level_2)) ~ "N",

          bclcs_level_1=="N" & bclcs_level_2=="W" ~ "W",
          bclcs_level_1=="N" ~ "N", # for all other "N"'s

TRUE ~ as.character(FWI_veg)))

# note the NA values in the fire_all table were causing ifelse statements to do weird things. This seems better. Hopefully its correct.

table(fire_all1$FWI_veg)

                             
table(is.na(fire_all1$FWI_veg))

x<- fire_all1 %>% filter(is.na(FWI_veg)) %>% dplyr::select(fire, inventory_standard_cd:conifer_pct_cover_total)

y<-fire_all1 %>% filter(fire==1) %>% filter(FWI_veg %in% c("N", "W")) # Note there are a whole bunch of ignition points that have FWI_veg categoriezed as N. This is a problem because N means no fuel. I tried to deal with this by buffering the points 50m then 150m 
table(y$fire_yr)
#2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018
# 117  147  131   78  143  107  117  163   81   49   56   43   58   63   32   48   57 #2019 
#39 
#2020 2021 
 # 26   36 

table(y$FWI_veg, y$Cluster)
tail(y)

y2<-fire_all1 %>% filter(fire==1)

st_write(y, "C:\\Work\\caribou\\clus_data\\Fire\\Fire_sim_data\\tmp\\fire_veg_data_N_or_W.gpkg", delete_layer=TRUE, driver="GPKG")


st_write(fire_all1, "C:\\Work\\caribou\\clus_data\\Fire\\Fire_sim_data\\data\\Fire_data_all_veg2.gpkg", delete_layer=TRUE, driver="GPKG")

# upload to Kyle clus. Just update the relevant credentials 
key_get('dbpass', keyring = 'postgreSQL')
key_get('dbhost', keyring = 'postgreSQL')

#ogr2ogr -f PostgreSQL PG:"host= user= dbname=clus password= port=5432" C:\\Work\\caribou\\clus_data\\Fire\\Fire_sim_data\\data\\Fire_data_all_veg.gpkg -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

```
