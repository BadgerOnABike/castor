---
title: "06_Fire_spread_model_fits_by_FRT_data_prep"
author: "Elizabeth Kleynhans and Cora Skaien"
contributor: "Peter Ott"
date: "20/04/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library (kableExtra)
library (data.table)
library (DBI)
library (RPostgreSQL)
library (dplyr)
library (ggplot2)
library (here)
library(ggpubr)
library(arm)
library(tidyr)
library(AICcmodavg)
library(keyring)
library(caret)
library(pROC)
library(rje)

source(here::here("R/functions/R_Postgres.R"))
```

<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->


## Introduction

Here, we are running a glm for each separate fire regime type to develop a predictive equation so that we can extrapolate which cells are likely to burn and which are not into the future. The data that we include in these glms is vegetation, climate date, and human impact. The top climate variable for each fire regime type was determined in the script "05_spread_climate_variable_selection.R". 

Before running these glms I will plot the relationship between the climate variable and probability of spread. I should probably do partial plots because I also included lat and long in these models to try to account for autocorrelation. 




```{r eval=, message=FALSE, AIC table, echo=F}

climate_variable<-read.csv("C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/climate_AIC_results_spread_summary.csv")

kable (climate_variable,
       caption = "<b>Table 1. Top candidate climate variables for lightning caused fires as selected through an AIC analysis for each Fire Regime Type.<b>",
       digits = 2) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)
```

## Pull in the data for locations that burned and those that did not.

```{r}
fire_spread<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\spread\\Fire_data_all_veg.gpkg")
head(fire_spread)

fire_spread$tot_spring_PPT<-fire_spread$PPT04+ fire_spread$PPT05 + fire_spread$PPT06
fire_spread$spring_Tave<-(fire_spread$Tave04+ fire_spread$Tave05 + fire_spread$Tave06)/3

fire_spread$mean_Tmax05_Tmax06_Tmax07<- (fire_spread$Tmax05+ fire_spread$Tmax06 + fire_spread$Tmax07)/3

fire_spread$mean_Tmax05_Tmax06_Tmax07_Tmax08<- (fire_spread$Tmax05 + fire_spread$Tmax06+ fire_spread$Tmax07 + fire_spread$Tmax08)/4

fire_spread$mean_PPT05_PPT06_PPT07_PPT08<- (fire_spread$PPT05 + fire_spread$PPT06+ fire_spread$PPT07 + fire_spread$PPT08)/4

fire_spread$mean_PPT05_PPT06_PPT07<- (fire_spread$PPT05+ fire_spread$PPT06 + fire_spread$PPT07)/3

fire_spread$mean_Tave05_Tave06_Tave07_Tave08<- (fire_spread$Tave05 + fire_spread$Tave06+ fire_spread$Tave07 + fire_spread$Tave08)/4

```


Now we will create additional columns that have the climate1 and climate2 variables indicated as the top variables for climate. 

```{r}
#View top variable
names(fire_spread)
unique(fire_spread$frt) # FRT 3 should not be in this list
table(is.na(fire_spread$frt))

fire_spread2<-fire_spread %>% drop_na(frt)
fire_spread2$frt<-as.numeric(fire_spread2$frt)

table(fire_spread2$frt)

## Create empty vector
fire_spread2$climate1<-"NA"
head(fire_spread2)

fire_spread2<-fire_spread2 %>%
    mutate(climate1 = case_when(
                            frt == "5" ~ Tmax08 ,
                            frt == "7" ~ as.numeric(RH07),
                            frt == "9" ~ spring_Tave,
                            frt == "10" ~ mean_Tmax05_Tmax06_Tmax07_Tmax08 ,
                            frt == "11" ~ as.numeric(RH08),
                            frt == "12" ~ mean_Tmax05_Tmax06_Tmax07_Tmax08,
                            frt == "13" ~ mean_Tave05_Tave06_Tave07_Tave08,
                            frt == "14" ~ mean_Tmax05_Tmax06_Tmax07,
                            frt == "15" ~ Tave05 ,
                            TRUE ~ NA_real_))

#Repeat for climate 2
fire_spread2$climate2<-"NA"

fire_spread2<-fire_spread2 %>%
    mutate(climate2 = case_when(
                            frt == "5" ~ as.numeric(PPT08),
                            frt == "7" ~ as.numeric(PPT07),
                            frt == "9" ~ as.numeric(tot_spring_PPT),
                            frt == "10" ~ as.numeric(mean_PPT05_PPT06_PPT07_PPT08) ,
                            frt == "11" ~ as.numeric(PPT08),
                            frt == "12" ~ as.numeric(mean_PPT05_PPT06_PPT07_PPT08),
                            frt == "13" ~ as.numeric(mean_PPT05_PPT06_PPT07_PPT08),
                            frt == "14" ~ as.numeric(mean_PPT05_PPT06_PPT07),
                            frt == "15" ~ as.numeric(PPT05),
                            TRUE ~ NA_real_))

head(fire_spread2)

##Change vegtype to factor
fire_spread2$FWI_veg<-as.factor(fire_spread2$FWI_veg)

#create new column
fire_spread2$fire_veg<-paste(fire_spread2$fire, fire_spread2$FWI_veg)

```

Add some transformations to some of the variables.

```{r}
#Before transformations, must convert degrees to radians
fire_spread2$aspect_radians<-(fire_spread2$aspect_ha_bc*pi)/180

hist(fire_spread2$aspect_radians)

fire_spread2$aspect_cos<-cos(fire_spread2$aspect_radians) #try cos because I hypothesize that southern aspects would be most likely to have higher likelihood of fire. 180 degrees is -1 with cos, and north is plus 1.
```

View plots.

```{r}
p <- ggplot(fire_spread2, aes(aspect_ha_bc, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect") + ylab("Pr (ignition)")
p

p <- ggplot(fire_spread2, aes(aspect_cos, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect_cos") + ylab("Pr (ignition)")
p

# I was wondering whether there were clearly more ignitions on one side so I decided to try and look at it as a circular plot. I assume this is doing what I think it should be doing looks like cos aspect is not working the way we think it should. Plots look weird... see below.
library(circular)


x<-filter(fire_spread2, pttype==1)
b_circular<-circular(x$aspect_radians)
b_circular_asp<-circular(x$aspect_ha_bc)
b_circular_cos<-circular(x$aspect_cos)
rose.diag(b_circular, bins=36, prop=3)
rose.diag(b_circular_asp, bins=36, prop=3)
rose.diag(b_circular_cos, bins=36, prop=3) # weird it does not look like cos-aspect worked. 
b<-density(x$aspect_radians, control.circular=list(units="radians"))

##Seems to be minimal relationship with aspect overall

p <- ggplot(fire_spread2, aes(slope_ha_bc, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("slope") + ylab("Pr (ignition)")
p
#  positive association with slope

ggplot(fire_spread2, aes(x = slope_ha_bc)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(pttype ~ .)
##Seeing distribution of ignitions by slope makes me believe that slope is not a big factor for ignitions despite seemingly positive trend prior.

ggplot(fire_spread2, aes(x = aspect_ha_bc)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(pttype ~ .)


p <- ggplot(fire_spread2, aes(dem_ha_bc, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("elevation") + ylab("Pr (ignition)")
p # seems like there is probably no relationship with elevation

ggplot(fire_spread2, aes(x = dem_ha_bc)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(pttype ~ .)
```

#Inspect each of the top climate variables for each frt 

```{r}
###################################
# bring in shape file of FRT's
#FRT 5
climate_variable

frt5<-fire_spread2 %>% filter(frt==5)
model1 <- glm (pttype ~ Latitude + Longitude + Tave07 + PPT07 ,
               data=frt5,
               family = binomial (link = "logit"))
summary(model1)

library(visreg)
visreg(model1, scale="response", "Tave07")
visreg(model1, scale="response", "PPT07")
visreg(model1, "Tave07")

p_5 <- ggplot(fire_spread2 %>% filter(frt=="5"), aes(Tave07, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Tmax08 ") + ylab("Pr (ignition)")
p_5

p_5b <- ggplot(fire_spread2 %>% filter(frt=="5"), aes(PPT07, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("PPT08   ") + ylab("Pr (ignition)")
p_5b

round(cor(dat),
  digits = 2 # rounded to 2 decimals
)



model1 <- glm (pttype ~ Latitude + Longitude + Tave07 + PPT07 + dem_ha_bc + as.factor(FWI_veg) + dist_roads_m + dist_infr_m + slope_ha_bc+ win_spg ,
               data=frt5,
               family = binomial (link = "logit"))
summary(model1)




### FRT 7
climate_variable
frt7<-fire_spread2 %>% filter(frt==7)
model1 <- glm (pttype ~ Latitude + Longitude + climate1 + climate2 ,
               data=frt7,
               family = binomial (link = "logit"))
summary(model1)

visreg(model1, scale="response")
visreg(model1)

p_7 <- ggplot(fire_spread %>% filter(frt=="7"), aes(climate1, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("RH05_06_07") + ylab("Pr (ignition)")
p_7

frt_map7<-frt_map %>% filter(Cluster==7)
p7_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map7,colour="blue", fill="blue") +
  coord_sf()

p_7 + annotation_custom(ggplotGrob(p7_map), xmin = 57, xmax = 65,
                        ymin = 0.25, ymax = 0.80)

# is there a relationship with year?
climate.by.year <- data.frame (matrix (ncol = 2, nrow = 0))
colnames (climate.by.year) <- c ("Year", "beta")

year<-c("2002", "2003", "2004", "2005","2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")
for (i in 1:length(year)){
  x<-fire_spread %>% filter(frt=="7" & fire_yr==year[i])
  if(dim(x)[1]>12) {
  fit <- glm (fire ~ climate1,
                 data=x,
                 family = binomial (link = "logit"))
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-fit$coefficients[2]} else {
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-NA
}
}

climate.by.year<-drop_na(climate.by.year)
climate.by.year$Year<-as.numeric(climate.by.year$Year)
gpp<- ggplot(climate.by.year, aes(Year, beta)) +
  geom_point()
gpp+geom_smooth(method = "lm",
              formula = y ~ x)



#FRT 9
climate_variables_lightning
p_9 <- ggplot(fire_spread %>% filter(frt=="9"), aes(climate1
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab(" Tmax05") + ylab("Pr (ignition)")
p_9

frt_map9<-frt_map %>% filter(Cluster==9)
p9_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map9,colour="blue", fill="blue") +
  coord_sf()

p_9 + annotation_custom(ggplotGrob(p9_map), xmin = 75, xmax = 140,
                        ymin = 0.25, ymax = 0.80)

# is there a relationship with year?
climate.by.year <- data.frame (matrix (ncol = 2, nrow = 0))
colnames (climate.by.year) <- c ("Year", "beta")

year<-c("2002", "2003", "2004", "2005","2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")
for (i in 1:length(year)){
  x<-fire_spread %>% filter(frt=="9" & fire_yr==year[i])
  if(dim(x)[1]>12) {
  fit <- glm (fire ~ climate1,
                 data=x,
                 family = binomial (link = "logit"))
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-fit$coefficients[2]} else {
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-NA
}
}

climate.by.year<-drop_na(climate.by.year)
climate.by.year$Year<-as.numeric(climate.by.year$Year)
gpp<- ggplot(climate.by.year, aes(Year, beta)) +
  geom_point()
gpp+geom_smooth(method = "lm",
              formula = y ~ x)


#FRT 10
climate_variables_lightning
p_10_1 <- ggplot(fire_spread %>% filter(frt=="10"), aes(climate1, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tave07_Tave08_Tave09 ") + ylab("Pr (ignition)")
p_10_1

p_10_2 <- ggplot(fire_spread %>% filter(frt=="10"), aes(climate2, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_PPT07_PPT08_PPT09  ") + ylab("Pr (ignition)")
p_10_2

frt_map10<-frt_map %>% filter(Cluster==10)
p10_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map10,colour="blue", fill="blue") +
  coord_sf()

p_10_1 + annotation_custom(ggplotGrob(p10_map), xmin = 2, xmax = 8,
                        ymin = 0.25, ymax = 0.80)

# is there a relationship with year?
climate.by.year <- data.frame (matrix (ncol = 2, nrow = 0))
colnames (climate.by.year) <- c ("Year", "beta")

year<-c("2002", "2003", "2004", "2005","2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")
for (i in 1:length(year)){
  x<-fire_spread %>% filter(frt=="10" & fire_yr==year[i])
  if(dim(x)[1]>12) {
  fit <- glm (fire ~ climate1 + climate2,
                 data=x,
                 family = binomial (link = "logit"))
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-fit$coefficients[2]} else {
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-NA
}
}

climate.by.year<-drop_na(climate.by.year)
climate.by.year$Year<-as.numeric(climate.by.year$Year)
gpp<- ggplot(climate.by.year, aes(Year, beta)) +
  geom_point()
gpp+geom_smooth(method = "lm",
              formula = y ~ x)


### FRT 11
climate_variables_lightning
p_11_1 <- ggplot(fire_spread %>% filter(frt=="11"), aes(climate1, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tmax07_Tmax08_Tmax09") + ylab("Pr (ignition)")
p_11_1

p_11_2 <- ggplot(fire_spread %>% filter(frt=="11"), aes(climate2, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_PPT07_PPT08_PPT09") + ylab("Pr (ignition)")
p_11_2



frt_map11<-frt_map %>% filter(Cluster==11)
p11_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map11,colour="blue", fill="blue") +
  coord_sf()

p_11 + annotation_custom(ggplotGrob(p11_map), xmin = 7, xmax = 10,
                        ymin = 0.25, ymax = 0.80)

# is there a relationship with year?
climate.by.year <- data.frame (matrix (ncol = 2, nrow = 0))
colnames (climate.by.year) <- c ("Year", "beta")

year<-c("2002", "2003", "2004", "2005","2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")
for (i in 1:length(year)){
  x<-fire_spread %>% filter(frt=="11" & fire_yr==year[i])
  if(dim(x)[1]>12) {
  fit <- glm (fire ~ climate1,
                 data=x,
                 family = binomial (link = "logit"))
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-fit$coefficients[2]} else {
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-NA
}
}

climate.by.year<-drop_na(climate.by.year)
climate.by.year$Year<-as.numeric(climate.by.year$Year)
gpp<- ggplot(climate.by.year, aes(Year, beta)) +
  geom_point()
gpp+geom_smooth(method = "lm",
              formula = y ~ x)


####FRT 12
climate_variables_lightning
p_12 <- ggplot(fire_spread %>% filter(frt=="12"), aes(climate1, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tmax07_Tmax08") + ylab("Pr (ignition)")
p_12

frt_map12<-frt_map %>% filter(Cluster==12)
p12_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map12,colour="blue", fill="blue") +
  coord_sf()

p_12 + annotation_custom(ggplotGrob(p12_map), xmin = 15, xmax = 20,
                        ymin = 0.25, ymax = 0.80)

# is there a relationship with year? e.g. does the influence of temperature increase over time?
climate.by.year <- data.frame (matrix (ncol = 2, nrow = 0))
colnames (climate.by.year) <- c ("Year", "beta")

year<-c("2002", "2003", "2004", "2005","2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")
for (i in 1:length(year)){
  x<-fire_spread %>% filter(frt=="12" & fire_yr==year[i])
  if(dim(x)[1]>12) {
  fit <- glm (fire ~ climate1,
                 data=x,
                 family = binomial (link = "logit"))
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-fit$coefficients[2]} else {
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-NA
}
}

climate.by.year<-drop_na(climate.by.year)
climate.by.year$Year<-as.numeric(climate.by.year$Year)
gpp<- ggplot(climate.by.year, aes(Year, beta)) +
  geom_point()
gpp+geom_smooth(method = "lm",
              formula = y ~ x)

# FRT13
climate_variables_lightning
p_13 <- ggplot(fire_spread %>% filter(frt=="13"), aes(climate1, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Tave07") + ylab("Pr (ignition)")
p_13

p_13b <- ggplot(fire_spread %>% filter(frt=="13"), aes(climate2, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("PPT07 ") + ylab("Pr (ignition)")
p_13b

frt_map13<-frt_map %>% filter(Cluster==13)
p13_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map13,colour="blue", fill="blue") +
  coord_sf()

p_13 + annotation_custom(ggplotGrob(p13_map), xmin =6, xmax = 15,
                        ymin = 0.25, ymax = 0.80)

# is there a relationship with year?
climate.by.year <- data.frame (matrix (ncol = 2, nrow = 0))
colnames (climate.by.year) <- c ("Year", "beta")

year<-c("2002", "2003", "2004", "2005","2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")
for (i in 1:length(year)){
  x<-fire_spread %>% filter(frt=="13" & fire_yr==year[i])
  if(dim(x)[1]>12) {
  fit <- glm (fire ~ climate1 + climate2,
                 data=x,
                 family = binomial (link = "logit"))
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-fit$coefficients[2]} else {
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-NA
}
}

climate.by.year<-drop_na(climate.by.year)
climate.by.year$Year<-as.numeric(climate.by.year$Year)
gpp<- ggplot(climate.by.year, aes(Year, beta)) +
  geom_point()
gpp+geom_smooth(method = "lm",
              formula = y ~ x)


#### FRT14
climate_variables_lightning
p_14 <- ggplot(fire_spread %>% filter(frt=="14"), aes(climate1
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tave07_Tave08 ") + ylab("Pr (ignition)")

p_14



frt_map14<-frt_map %>% filter(Cluster==14)
p14_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map14,colour="blue", fill="blue") +
  coord_sf()

p_14 + annotation_custom(ggplotGrob(p14_map), xmin =15, xmax = 24,
                        ymin = 0.25, ymax = 0.80)

# is there a relationship with year?
climate.by.year <- data.frame (matrix (ncol = 2, nrow = 0))
colnames (climate.by.year) <- c ("Year", "beta")

year<-c("2002", "2003", "2004", "2005","2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")
for (i in 1:length(year)){
  x<-fire_spread %>% filter(frt=="14" & fire_yr==year[i])
  if(dim(x)[1]>12) {
  fit <- glm (fire ~ climate1,
                 data=x,
                 family = binomial (link = "logit"))
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-fit$coefficients[2]} else {
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-NA
}
}

climate.by.year<-drop_na(climate.by.year)
climate.by.year$Year<-as.numeric(climate.by.year$Year)
gpp<- ggplot(climate.by.year, aes(Year, beta)) +
  geom_point()
gpp+geom_smooth(method = "lm",
              formula = y ~ x)


#### FRT 15
climate_variables_lightning
p_15 <- ggplot(fire_spread %>% filter(frt=="15"), aes(climate1, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tave06_Tave07_Tave08 ") + ylab("Pr (ignition)")
p_15

p_15b <- ggplot(fire_spread %>% filter(frt=="15"), aes(climate2, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_PPT06_PPT07_PPT08   ") + ylab("Pr (ignition)")
p_15b

frt_map15<-frt_map %>% filter(Cluster==15)
p15_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map15,colour="blue") + #fill="blue") +
  coord_sf()

p_15 + annotation_custom(ggplotGrob(p15_map), xmin = 70, xmax = 90,
                        ymin = 0.17, ymax = 0.85)

# is there a relationship with year?
climate.by.year <- data.frame (matrix (ncol = 2, nrow = 0))
colnames (climate.by.year) <- c ("Year", "beta")

year<-c("2002", "2003", "2004", "2005","2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021")
for (i in 1:length(year)){
  x<-fire_spread %>% filter(frt=="15" & fire_yr==year[i])
  if(dim(x)[1]>12) {
  fit <- glm (fire ~ climate1,
                 data=x,
                 family = binomial (link = "logit"))
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-fit$coefficients[2]} else {
climate.by.year[i,1]<-year[i]
climate.by.year[i,2]<-NA
}
}

climate.by.year<-drop_na(climate.by.year)
climate.by.year$Year<-as.numeric(climate.by.year$Year)
gpp<- ggplot(climate.by.year, aes(Year, beta)) +
  geom_point()
gpp+geom_smooth(method = "lm",
              formula = y ~ x)


# generally there is no change in the impact of the climate variable over time. At least in most cases it seems likely not to be significant. 

```

#VRI variables

```{r}

x5<-fire_spread %>% filter(frt=="5")
  fit <- glm (fire ~ FWI_veg + climate1 + climate2,
                 data=x5,
                 family = binomial (link = "logit"))
  x5$predict<-predict(fit, type="response")


p <- ggplot(x5, aes(x=FWI_veg, y=predict)) +
              geom_boxplot()
p

p <- ggplot(fire_spread, aes(proj_height_1, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("proj_height_1") + ylab("Pr (ignition)")+
  facet_wrap(frt ~ ., ncol=3)
p

p <- ggplot(fire_spread, aes(l___125, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("live_stand_volume_125") + ylab("Pr (ignition)")+
  facet_wrap(frt ~ ., ncol=3)
p
```



Repeat for Person-caused fires

 
 View plots.

```{r}
p <- ggplot(dat_person, aes(aspect, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect") + ylab("Pr (ignition)")
p


##Seems to be minimal relationship with aspect overall

p <- ggplot(dat_person, aes(slope, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("slope") + ylab("Pr (ignition)")
p
#negative correlation with slope i.e. steeper slopes less ignition

ggplot(dat_person, aes(x = slope)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(fire ~ .) 
# note that there are more sampled locations with less steep slopes but thats true for both fire ignition points and not


p_elev <- ggplot(dat_person, aes(elevatn, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("elevation") + ylab("Pr (ignition)") +
  facet_wrap(frt ~ ., ncol=3)
p_elev
# lower elevations have more ignitions. This might be related to vegetation?


p_rds <- ggplot(dat_person, aes(road_dist_m, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Distance to roads") + ylab("Pr (ignition)") +
  facet_wrap(frt ~ ., ncol=3)
p_rds

ggplot(dat_person, aes(x = road_dist_m)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(fire ~ .) 

# very strong negative relationship i.e most ignitions are really close to roads.

p_inf <- ggplot(dat_person, aes(infr_dist, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Road Density") + ylab("Pr (ignition)") +
  facet_wrap(frt ~ ., ncol=3)
p_inf

ggplot(dat_person, aes(x = infr_ds)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(fire ~ .) 

# also a negative relationship with distance to infrastructure although less strong than roads. 


```


#Repeat for top climate variables

```{r}

# FRT 5
p_5 <- ggplot(dat_person %>% filter(frt==5), aes(climate1, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_PPT06_PPT07") + ylab("Pr (ignition)")
p_5

frt_map5<-frt_map %>% filter(Cluster==5)
p5_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map5,colour="blue", fill="blue") +
  coord_sf()

p_5 + annotation_custom(ggplotGrob(p5_map), xmin = 125, xmax = 180,
                        ymin = 0.17, ymax = 0.85)


# FRT 7
p_7 <- ggplot(dat_person %>% filter(frt==7), aes(climate1
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tave04_Tave05_Tave06_Tave07_Tave08_Tave09_Tave10") + ylab("Pr (ignition)")
p_7

frt_map7<-frt_map %>% filter(Cluster==7)
p7_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map7,colour="blue", fill="blue") +
  coord_sf()

p_7 + annotation_custom(ggplotGrob(p7_map), xmin = 16, xmax = 19,
                        ymin = 0.17, ymax = 0.85)


#FRT_9
p_9 <- ggplot(dat_person %>% filter(frt==9), aes(climate1
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Tmax05") + ylab("Pr (ignition)")
p_9

frt_map9<-frt_map %>% filter(Cluster==9)
p9_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map9,colour="blue", fill="blue") +
  coord_sf()

p_9 + annotation_custom(ggplotGrob(p9_map), xmin = 10, xmax = 13,
                        ymin = 0.17, ymax = 0.85)


#FRT10
p_10 <- ggplot(dat_person %>% filter(frt==10), aes(climate1
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_PPT06_PPT07_PPT08_PPT09") + ylab("Pr (ignition)")
p_10

frt_map10<-frt_map %>% filter(Cluster==10)
p10_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map10,colour="blue", fill="blue") +
  coord_sf()

p_10 + annotation_custom(ggplotGrob(p10_map), xmin = 300, xmax = 500,
                        ymin = 0.17, ymax = 0.85)


# FRT 11
p_11 <- ggplot(dat_person %>% filter(frt==11), aes(climate1
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tave08_Tave09_Tave10") + ylab("Pr (ignition)")
p_11

frt_map11<-frt_map %>% filter(Cluster==11)
p11_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map11,colour="blue", fill="blue") +
  coord_sf()

p_11 + annotation_custom(ggplotGrob(p11_map), xmin = 75, xmax = 125,
                        ymin = 0.17, ymax = 0.85)


# FRT 12
p_12 <- ggplot(dat_person %>% filter(frt==12), aes(mean_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08_Tmax09_Tmax10
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tave04_Tave05_Tave06_Tave07_Tave08_Tave09_Tave10") + ylab("Pr (ignition)")
p_12

frt_map12<-frt_map %>% filter(Cluster==12)
p12_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map12,colour="blue", fill="blue") +
  coord_sf()

p_12 + annotation_custom(ggplotGrob(p12_map), xmin = 7.5, xmax = 11,
                        ymin = 0.17, ymax = 0.85)


# FRT 13
p_13 <- ggplot(dat_person %>% filter(frt==13), aes(climate1
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tave07_Tave08_Tave09") + ylab("Pr (ignition)")
p_13

p_13_2 <- ggplot(dat_person %>% filter(frt==13), aes(climate2
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_PPT07_PPT08_PPT09") + ylab("Pr (ignition)")
p_13_2

frt_map13<-frt_map %>% filter(Cluster==13)
p13_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map13,colour="blue", fill="blue") +
  coord_sf()

p_13 + annotation_custom(ggplotGrob(p13_map), xmin = 5, xmax = 10,
                        ymin = 0.17, ymax = 0.85)


# FRT 14

p_14 <- ggplot(dat_person %>% filter(frt==14), aes(climate1
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08_Tmax09_Tmax10") + ylab("Pr (ignition)")
p_14

frt_map14<-frt_map %>% filter(Cluster==14)
p14_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map14,colour="blue", fill="blue") +
  coord_sf()

p_14 + annotation_custom(ggplotGrob(p14_map), xmin = 14, xmax = 20,
                        ymin = 0.17, ymax = 0.85)

p_15 <- ggplot(dat_person %>% filter(frt==15), aes(climate1
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_Tave07_Tave08_Tave09") + ylab("Pr (ignition)")
p_15

p_15_2 <- ggplot(dat_person %>% filter(frt==15), aes(climate2
, as.numeric(fire))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_PPT07_PPT08_PPT09") + ylab("Pr (ignition)")
p_15_2

frt_map15<-frt_map %>% filter(Cluster==15)
p15_map<-ggplot() +
  geom_sf(data=bc.bnd)+
  theme (axis.text.x=element_blank ()) +
  theme (axis.text.y=element_blank ()) +
  geom_sf(data=frt_map15,colour="blue", fill="blue") +
  coord_sf()

p_15 + annotation_custom(ggplotGrob(p15_map), xmin = 13, xmax = 17,
                        ymin = 0.17, ymax = 0.85)

library(ggpubr)

ggarrange(p_5, p_7, p_9, p_10, p_11,
          labels = c("A", "B", "C", "D", "E"),
          ncol = 3, nrow = 2, 
          common.legend = TRUE, legend = "bottom")


ggarrange(p_12, p_13, p_13_2, p_14, p_15, p_15_2,
          labels = c("A", "B", "C", "D", "E", "F"),
          ncol = 3, nrow = 2, 
          common.legend = TRUE, legend = "bottom")

# nice alternative figure but cant add a map or Im not sure how to.
library(popbio)
logi.hist.plot(dat_person$mean_Tmax07_Tmax08_Tmax09,dat_person$fire,boxp=FALSE,type="hist",col="gray")


```


###############DATA PREP COMPLETE###################
