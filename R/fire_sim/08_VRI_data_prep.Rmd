---
title: "VRI_data_prep"
author: "Elizabeth Kleynhans"
date: "07/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

#=================================
#  Script Name: 08_vri_data_prep.R
#  Script Version: 1.0
#  Script Purpose: This samples VRI data for each ignition location
#  Script Author: Elizabeth Kleynhans, Ecological Modeling Specialist, Forest Analysis and Inventory Branch, B.C. Ministry of Forests, Lands, and Natural Resource Operations.
#  Script Contributor: Cora Skaien, Ecological Modeling Specialist, Forest Analysis and Inventory Branch, B.C. Ministry of Forests, Lands, and Natural Resource Operations.
#=================================

#Overview:
In this file, we acquire the VRI (Vegetation Resources Inventory) for each year by location from 2002 to 2021. This is likely already uploaded onto a network and may not need to be redone.
The final product will be a file with veg data along with ignition data and climate data (vegetation, climate and presence/absence of fire data).

The first portion of this code cannot be run on R.Instead use QGIS to overlay the ignition points and the VRI data. 

# First get the VRI data and if you want put it in the local postgres database.
##This first section has been completed on this computer.
from https://catalogue.data.gov.bc.ca/dataset/vri-historical-vegetation-resource-inventory-2002-2019-
I (Liz) then extracted this data and uploaded it into my local postgres database by running the command below in terminal. If running it in the R terminal does not work try run it in here: 
#C:\data\localApps\QGIS10.16\OSGeo4W (the terminal window)

You may get a warning indicating that this will take a long time, or that databases are not supported. You should specify a specific item within the database.
#ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres dbname=postgres password=postgres port=5432" C:\\Work\\caribou\\castor_data\\Fire\\VEG_COMP_POLY_AND_LAYER_2020.gdb -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

Above is run or each year 2002 to 2020 separately from the data. This is already on the private server, so if you are using the private server, you do not need to run again.

# rename the table in postgres if need be
#ALTER TABLE veg_comp_lyr_r1_poly RENAME TO veg_comp_lyr_r1_poly2017

# When the table name is changed the idx name is not so you might have to change that too so that more files can be uploaded into postgres by running the following command
#ALTER INDEX veg_comp_lyr_r1_poly_shape_geom_idx RENAME TO veg_comp_lyr_r1_poly2019_geometry_geom_idx;
# and if need be change the name of the geometry column from shape to geometry
#ALTER TABLE veg_comp_lyr_r1_poly2019 RENAME COLUMN shape TO geometry;


#### VEGETATION DATA #### 
2002 to 2022 are the only years that VRI data exists, there is no earlier data.  when you try to overlay the ignition points over the VRI data and try to extract them QGIS says tehre are many geometry problems. So first I corrected taht for each VRI layer as follows:

Processing -> Toolbox -> Vector geometries -> Fix geometries 
Alternatively after opening the toolbox type fix into the search window and it should list fix geometries. 
Run the fix geometries for each VRI layer.
I saved the outputs here: 
"D:\VRI_geom_corrected".
This took really long to run so try not to redo it!

After fixing the geometries i overlayed the layers.
First I created a separate ignition point file for each year (see code below). The files can be found here:
"C:\Work\caribou\castor_data\Fire\Fire_sim_data\tmp\ignit_all_2002.shp"

Then I extracted teh VRI data as follows:
Vector -> data management tools -> join attributes by location. 

In Base layer I put the ignition points, in join layer I put the VRI data. 
Geometric predicate = intersects
Fields to add = 
'inventory_standard_cd'
'non_productive_cd'
'coast_interior_cd',
'bclcs_level_1',
'bclcs_level_2',
'bclcs_level_3',
'bclcs_level_4',
'bclcs_level_5',
'interpretation_date',
'projected_date',
'non_veg_cover_type_1'
'non_veg_cover_type_2'
'non_veg_cover_type_3'
'land_cover_class_cd_1'
'est_cover_pct_1'
'land_cover_class_cd_2'
'est_cover_pct_2'
'land_cover_class_cd_3'
'est_cover_pct_3'
'line_7b_disturbance_history',
'bec_zone_code',
'bec_subzone',
'earliest_nonlogging_dist_type',
'earliest_nonlogging_dist_date',
'stand_percentage_dead',
'harvest_date',
'quad_diam_175',
'crown_closure',
'vri_live_stems_per_ha',
'vri_dead_stems_per_ha',
'species_cd_1',
'species_pct_1',
'species_cd_2',
'species_pct_2',
'species_cd_3',
'species_pct_3',
'species_cd_4',
'species_pct_4',
'species_cd_5',
'species_pct_5',
'species_cd_6',
'species_pct_6',
'live_stand_volume_175',
'whole_stem_biomass_per_ha',
'branch_biomass_per_ha',
'foliage_biomass_per_ha',
'bark_biomass_per_ha',
'proj_age_1',
'proj_age_2',
'proj_height_1',
'proj_height_2'

Join type = Take attributes of feature with largest overlap.
Tick discard records which could not be joined
save the layer in Joined layer and the layer which could not be joined. 

For the values that could not be joined I then tried to join those values with the VRI of two years after. Or the year before. The goal was to get as much data as possible i.e. throw out as few records as possible. 

####METHODS

```{r}
library (rgdal)
library (RSQLite)
library(sf)
library(data.table)
library(tidyverse)
```

```{r}
sample_locations_DEM_roads_wind2<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\Data_clim_DEM_roads_wind_frt.gpkg")

# get the bounding box of the points
#thebbox<-st_bbox(sample_locations_DEM_roads_wind2)

#import the  fid values raster for the vri 
#ras.fid<-getRasterQuery("rast.vri2020_id", thebbox) # this takes a while
#plot(ras.fid)
```




# Save each fire year separately

```{r}

ignit_all_2002<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2002)
dim(ignit_all_2002)
sf::st_write(ignit_all_2002, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2002.gpkg", delete_layer=TRUE)

ignit_all_2003<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2003)
dim(ignit_all_2003)
sf::st_write(ignit_all_2003, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2003.gpkg", delete_layer=TRUE)

ignit_all_2004<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2004)
dim(ignit_all_2004)
sf::st_write(ignit_all_2004, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2004.gpkg", delete_layer=TRUE)

ignit_all_2005<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2005)
dim(ignit_all_2005)
sf::st_write(ignit_all_2005, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2005.gpkg", delete_layer=TRUE)

ignit_all_2006<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2006)
dim(ignit_all_2006)
sf::st_write(ignit_all_2006, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2006.gpkg", delete_layer=TRUE)

ignit_all_2007<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2007)
dim(ignit_all_2007)
sf::st_write(ignit_all_2007, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2007.gpkg", delete_layer=TRUE)

ignit_all_2008<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2008)
dim(ignit_all_2008)
sf::st_write(ignit_all_2008, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2008.gpkg", delete_layer=TRUE)

ignit_all_2009<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2009)
dim(ignit_all_2009)
sf::st_write(ignit_all_2009, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2009.gpkg", delete_layer=TRUE)

ignit_all_2010<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2010)
dim(ignit_all_2010)
sf::st_write(ignit_all_2010, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2010.gpkg", delete_layer=TRUE)

ignit_all_2011<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2011)
dim(ignit_all_2011)
sf::st_write(ignit_all_2011, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2011.gpkg", delete_layer=TRUE)

ignit_all_2012<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2012)
dim(ignit_all_2012)
sf::st_write(ignit_all_2012, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2012.gpkg", delete_layer=TRUE)

ignit_all_2013<- sample_locations_DEM_roads_wind2 %>% filter(FIRE_YE==2013)
dim(ignit_all_2013)
sf::st_write(ignit_all_2013, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2013.gpkg", delete_layer=TRUE)

ignit_all_2014<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2014)
dim(ignit_all_2014)
sf::st_write(ignit_all_2014, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2014.gpkg", delete_layer=TRUE)

ignit_all_2015<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2015)
dim(ignit_all_2015)
sf::st_write(ignit_all_2015, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2015.gpkg", delete_layer=TRUE)

ignit_all_2016<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2016)
dim(ignit_all_2016)
sf::st_write(ignit_all_2016, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2016.gpkg", delete_layer=TRUE)

ignit_all_2017<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2017)
dim(ignit_all_2017)
sf::st_write(ignit_all_2017, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2017.gpkg", delete_layer=TRUE)

ignit_all_2018<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2018)
dim(ignit_all_2018)
sf::st_write(ignit_all_2018, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2018.gpkg", delete_layer=TRUE)

ignit_all_2019<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2019)
dim(ignit_all_2019)
sf::st_write(ignit_all_2019, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2019.gpkg", delete_layer=TRUE)

ignit_all_2020<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2020)
dim(ignit_all_2020)
sf::st_write(ignit_all_2020, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2020.gpkg", delete_layer=TRUE)

ignit_all_2021<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2021)
dim(ignit_all_2021)
sf::st_write(ignit_all_2021, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2021.gpkg", delete_layer=TRUE)

ignit_all_2022<- sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2022)
dim(ignit_all_2022)
sf::st_write(ignit_all_2022, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2021.gpkg", delete_layer=TRUE)


```



### Now that the ignition points have been joined to the VRI data in QGIS. I need to reimport the data so that i can join it all together and use it.

# note I messed up the points. I was having trouble with some fire locations landing on FWI_veg type =N so I tried to fix this by buffering the points first by 50m, then by 150m then by 500m and extracting the most common vegetation type using QGIS. However, this did not seem to solve my problem so I decided to go back and just do as I did before. However, now Im confused about what buffer (if any) the fire_veg points got. I think its all mixed up with some points being buffered by 150m and others by only 50m. If I need this data from here I will need to re-extract the VRI data!

```{r}
file.list1<-list.files("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\QGIS_analysis", pattern="ignit_all", all.files=FALSE, full.names=FALSE)
y1<-gsub(".gpkg","",file.list1)
the_dir <- "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\QGIS_analysis"

for (i in 1:length(file.list1)){
  assign(paste0(y1[i]),st_read (dsn=paste0(the_dir, "\\", file.list1[i])))
}


# combined all the DC.ignition files together
mkFrameList <- function(nfiles) {
  d <- lapply(seq_len(nfiles),function(i) {
    eval(parse(text=y1[i]))
  })
  do.call(rbind,d)
}

#VRI from 2008 is missing bec_subzone and standpercent_dead. So I collected those fields from VRI 2006
extra2009<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\QGIS_analysis\\Ignit_all_2009_veg_extra_fields.gpkg")
extra2009<-extra2009 %>% select(idno, bec_subzone, stand_percentage_dead)
extra2009<-st_set_geometry(extra2009, NULL)

ignit_all_2009_veg<-left_join(ignit_all_2009_veg, extra2009)
ignit_all_2009_veg2<-left_join(ignit_all_2009_veg2, extra2009)


n<-length(y1)
fire_veg03_21<-mkFrameList(n) 
fire_veg03_21[duplicated(fire_veg03_21$idno),]$fire_yr # there should be no DUPLICATES

fire_veg03_21[duplicated(fire_veg03_21$idno),]

fire_veg03_21dt<-data.table(fire_veg03_21)

fire_veg03_21dt[idno=="160104",]

fire_veg03_21_2<-fire_veg03_21[!duplicated(fire_veg03_21$idno), ]

```

# now checking for duplicates I should have none

```{r}
dim(fire_veg03_21_2)
table(duplicated(fire_veg03_21_2$idno))

rm(ignit_all_2022, ignit_all_2021, ignit_all_2020, ignit_all_2019, ignit_all_2018, ignit_all_2017, ignit_all_2016, ignit_all_2015, ignit_all_2014, ignit_all_2012, ignit_all_2013, ignit_all_2011, ignit_all_2010, ignit_all_2009, ignit_all_2008,ignit_all_2007, ignit_all_2006, ignit_all_2005, ignit_all_2004, ignit_all_2003, ignit_all_2003_veg, ignit_all_2003_veg2, ignit_all_2004_veg, ignit_all_2005_veg, ignit_all_2005_veg2, ignit_all_2006_veg, ignit_all_2007_veg, ignit_all_2008_veg, ignit_all_2009_veg, ignit_all_2009_veg2, ignit_all_2010_veg, ignit_all_2011_veg, ignit_all_2013_veg, ignit_all_2013_veg2, ignit_all_2014_veg, ignit_all_2015_veg, ignit_all_2016_veg, ignit_all_2017_veg, ignit_all_2018_veg, ignit_all_2019_veg, ignit_all_2020_veg, ignit_all_2021_veg, ignit_all_2021_veg2, ignit_all_2022_veg)


gc()

table(fire_veg03_21_2$fire_yr)

# join the files together. Also check that there are no duplicates and if there are check which on is better to use. 

```

# checking that I did not loose lots of records when I pulled out the VRI data
```{r}
ignit2003<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\ignit_all_2003.gpkg")

dim(ignit2003)
head(ignit2003)
fire_veg_2002<-fire_veg03_21_2 %>% filter(fire_yr=='2003')
dim(fire_veg_2002)

# 2002 -> 28256 to 28256
# 2003 -> 39200 to 39185 
# 2004 -> 37840 to 37829 
# 2005 -> 15328 to 15320 
# 2006 -> 40544 to 40538  
# 2007 -> 25488 to 25478  
# 2008 -> 32080 to 32076   
# 2009 -> 48736 to 48732 
# 2010 -> 26448 to 26441 
# 2011 -> 10244 to 10220
# 2012 -> 26048 to 26041     
# 2013 -> 29536 to 29527 
# 2014 -> 23536 to 23534 
# 2015 -> 29632 to 29629 
# 2016 -> 16592 to 16590 
# 2017 -> 21424 to 21423
# 2018 -> 33520 to 33519
# 2019 -> 12816 to 12815
# 2020 -> 10608 to 10606 
# 2021 -> 26256 to 26253

# Good. I loose some points but when i plotted them in QGIS they were all points on the boarder of BC 

fire_veg_sf<-st_as_sf(fire_veg03_21_2)
head(fire_veg_sf)

```
Try saving file
```{r}
st_write(fire_veg_sf, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\Fire_data_all2.gpkg", delete_layer=TRUE, driver="GPKG")

#st_write(fire_veg_sf, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\Fire_data_everything.shp", delete_layer=TRUE, driver="ESRI Shapefile") # this one was not working

#ogr2ogr -f PostgreSQL PG:"dbname=castor port=5432 user= password= host=DG401102" C:\\Work\\caribou\\castor\\R\\fire_sim\\tmp\\Fire_data_all.shp -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI 

fire_all_2<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\Fire_data_all.gpkg")

```



############################################
# Dealing with fire locations that land on a W or N when classified for FWI_veg
############################################


```{r}
y<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\fire_veg_data_N_or_W.gpkg")
```


# Save each fire year separately

```{r}
names(y)
y<- y %>% dplyr::select(id:win_spg, FWI_veg) %>%
  rename(FWI_veg_old = FWI_veg)

ignit_all_2002<- y %>% filter(fire_yr==2002)
dim(ignit_all_2002)
sf::st_write(ignit_all_2002, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2002.gpkg", delete_layer=TRUE)

ignit_all_2003<- y %>% filter(fire_yr==2003)
dim(ignit_all_2003)
sf::st_write(ignit_all_2003, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2003.gpkg", delete_layer=TRUE)

ignit_all_2004<- y %>% filter(fire_yr==2004)
dim(ignit_all_2004)
sf::st_write(ignit_all_2004, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2004.gpkg", delete_layer=TRUE)

ignit_all_2005<- y %>% filter(fire_yr==2005)
dim(ignit_all_2005)
sf::st_write(ignit_all_2005, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2005.gpkg", delete_layer=TRUE)

ignit_all_2006<- y %>% filter(fire_yr==2006)
dim(ignit_all_2006)
sf::st_write(ignit_all_2006, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2006.gpkg", delete_layer=TRUE)

ignit_all_2007<- y %>% filter(fire_yr==2007)
dim(ignit_all_2007)
sf::st_write(ignit_all_2007, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2007.gpkg", delete_layer=TRUE)

ignit_all_2008<- y %>% filter(fire_yr==2008)
dim(ignit_all_2008)
sf::st_write(ignit_all_2008, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2008.gpkg", delete_layer=TRUE)

ignit_all_2009<- y %>% filter(fire_yr==2009)
dim(ignit_all_2009)
sf::st_write(ignit_all_2009, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2009.gpkg", delete_layer=TRUE)

ignit_all_2010<- y %>% filter(fire_yr==2010)
dim(ignit_all_2010)
sf::st_write(ignit_all_2010, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2010.gpkg", delete_layer=TRUE)

ignit_all_2011<- y %>% filter(fire_yr==2011)
dim(ignit_all_2011)
sf::st_write(ignit_all_2011, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2011.gpkg", delete_layer=TRUE)

ignit_all_2012<- y %>% filter(fire_yr==2012)
dim(ignit_all_2012)
sf::st_write(ignit_all_2012, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2012.gpkg", delete_layer=TRUE)

ignit_all_2013<- y %>% filter(fire_yr==2013)
dim(ignit_all_2013)
sf::st_write(ignit_all_2013, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2013.gpkg", delete_layer=TRUE)

ignit_all_2014<- y %>% filter(fire_yr==2014)
dim(ignit_all_2014)
sf::st_write(ignit_all_2014, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2014.gpkg", delete_layer=TRUE)

ignit_all_2015<- y %>% filter(fire_yr==2015)
dim(ignit_all_2015)
sf::st_write(ignit_all_2015, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2015.gpkg", delete_layer=TRUE)

ignit_all_2016<- y %>% filter(fire_yr==2016)
dim(ignit_all_2016)
sf::st_write(ignit_all_2016, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2016.gpkg", delete_layer=TRUE)

ignit_all_2017<- y %>% filter(fire_yr==2017)
dim(ignit_all_2017)
sf::st_write(ignit_all_2017, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2017.gpkg", delete_layer=TRUE)

ignit_all_2018<- y %>% filter(fire_yr==2018)
dim(ignit_all_2018)
sf::st_write(ignit_all_2018, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2018.gpkg", delete_layer=TRUE)

ignit_all_2019<- y %>% filter(fire_yr==2019)
dim(ignit_all_2019)
sf::st_write(ignit_all_2019, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2019.gpkg", delete_layer=TRUE)

ignit_all_2020<- y %>% filter(fire_yr==2020)
dim(ignit_all_2020)
sf::st_write(ignit_all_2020, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2020.gpkg", delete_layer=TRUE)

ignit_all_2021<- y %>% filter(fire_yr==2021)
dim(ignit_all_2021)
sf::st_write(ignit_all_2021, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\corrections\\ignit_all_2021.gpkg", delete_layer=TRUE)


```



### Now that the ignition points have been joined to the VRI data in QGIS. I need to reimport the data so that i can join it all together and use it.

# note I messed up the points. I was having trouble with some fire locations landing on FWI_veg type =N so I tried to fix this by buffering the points first by 50m, then by 150m then by 500m and extracting the most common vegetation type using QGIS. However, this did not seem to solve my problem so I decided to go back and just do as I did before. However, now Im confused about what buffer (if any) the fire_veg points got. I think its all mixed up with some points being buffered by 150m and others by only 50m. If I need this data from here I will need to re-extract the VRI data!

```{r}
file.list1<-list.files("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\QGIS_analysis\\corrections", pattern="fire_veg", all.files=FALSE, full.names=FALSE)
y1<-gsub(".gpkg","",file.list1)
the_dir <- "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\QGIS_analysis\\corrections"

for (i in 1:length(file.list1)){
  assign(paste0(y1[i]),st_read (dsn=paste0(the_dir, "\\", file.list1[i])))
}


# combined all the DC.ignition files together
mkFrameList <- function(nfiles) {
  d <- lapply(seq_len(nfiles),function(i) {
    eval(parse(text=y1[i]))
  })
  do.call(rbind,d)
}

n<-length(y1)
fire_veg02_21<-mkFrameList(n) 
fire_veg02_21[duplicated(fire_veg02_21$idno),]$fire_yr # there should be no DUPLICATES

fire_veg02_21[duplicated(fire_veg02_21$idno),]$fire_yr

y_new<-st_drop_geometry(y) %>% dplyr::select(id, idno, win_spg)

fire_veg_problems<-left_join(fire_veg02_21, y_new)



```

Now I should join these locations to the other file

```{r}
y<-fire_all1 %>% filter(fire==1) %>% filter(FWI_veg %in% c("N", "W"))

# remove everyting after yearHarvest

y3<- fire_all1 %>% filter(fire==1) %>% 
  filter(FWI_veg %in% c("N","W")) %>% 
  dplyr::select(idno)

y4<-fire_all1 %>% filter(!idno %in% y3$idno) %>%
  select(id:proj_height_2, FWI_veg) %>% 
  rename(FWI_veg_old=FWI_veg)

y4<-rbind(y4, fire_veg_problems)

st_write(y4, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\Fire_data_all3.gpkg", delete_layer=TRUE, driver="GPKG")


```



####################################################################################################
# Everythign below here is old code and should just be ignored
####################################################################################################

##This first section has been completed on this computer.
from https://catalogue.data.gov.bc.ca/dataset/vri-historical-vegetation-resource-inventory-2002-2019-
I (Liz) then extracted this data and uploaded it into my local postgres database by running the command below in terminal. If running it in the R terminal does not work try run it in here: 
#C:\data\localApps\QGIS10.16\OSGeo4W (the terminal window)

You may get a warning indicating that this will take a long time, or that databases are not supported. You should specify a specific item within the database.
#ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres dbname=postgres password=postgres port=5432" C:\\Work\\caribou\\castor_data\\Fire\\VEG_COMP_POLY_AND_LAYER_2020.gdb -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

Above is run or each year 2002 to 2020 separately from the data. This is already on the private server, so if you are using the private server, you do not need to run again.

# rename the table in postgres if need be
#ALTER TABLE veg_comp_lyr_r1_poly RENAME TO veg_comp_lyr_r1_poly2017

# When the table name is changed the idx name is not so you might have to change that too so that more files can be uploaded into postgres by running the following command
#ALTER INDEX veg_comp_lyr_r1_poly_shape_geom_idx RENAME TO veg_comp_lyr_r1_poly2019_geometry_geom_idx;
# and if need be change the name of the geometry column from shape to geometry
#ALTER TABLE veg_comp_lyr_r1_poly2019 RENAME COLUMN shape TO geometry;

#### Join ignition data to VRI data ####
Run following query in postgres for all years 2002-2019 except 2007 and 2008. 2020 also has slightly different code. This will need to be done each time new data is generated for random points in file 02. This below code is fast. Note, there are 5 locations in the below code for which to update the year.

Depending on how the file names most recently saved, some changes may need to be made (e.g., ign_mnt versus ign_month).

Data_clim_DEM_roads_wind_frt

##2002 -2006, 2009-2019
################################
CREATE TABLE fire_veg_2002 AS
(SELECT feature_id, bclcs_level_1, bclcs_level_2, bclcs_level_3, bclcs_level_4, bclcs_level_5, coast_interior_cd, bec_zone_code, bec_subzone, crown_closure, vri_live_stems_per_ha, vri_dead_stems_per_ha, harvest_date, earliest_nonlogging_dist_type, earliest_nonlogging_dist_date, species_cd_1, species_pct_1, species_cd_2, species_pct_2, species_cd_3, species_pct_3, species_cd_4, species_pct_4, species_cd_5, species_pct_5, species_cd_6, species_pct_6,   proj_age_1, proj_height_1, live_stand_volume_175, stand_percentage_dead, quad_diam_175,
  fire.idno, fire.fire_yr,
  data_clim_dem_roads_wind_frt.wkb_geometry FROM data_clim_dem_roads_wind_frt,
  (SELECT geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2002') as fire where st_contains
  (fire.wkb_geometry, veg_comp_lyr_r1_poly2002.geometry))
  
  CREATE TABLE fire_veg_2002 AS
(SELECT 
  idno, fire_yr,
  vri.feature_id, vri.bclcs_level_1,vri.bclcs_level_2, vri.bclcs_level_3, vri.bclcs_level_4, vri.bclcs_level_5, vri.coast_interior_cd, vri.bec_zone_code, vri.bec_subzone, vri.crown_closure, vri.vri_live_stems_per_ha, vri.vri_dead_stems_per_ha, vri.harvest_date, vri.earliest_nonlogging_dist_type, vri.earliest_nonlogging_dist_date, vri.species_cd_1, vri.species_pct_1, vri.species_cd_2, vri.species_pct_2, vri.species_cd_3, vri.species_pct_3, vri.species_cd_4, vri.species_pct_4, vri.species_cd_5, vri.species_pct_5, vri.species_cd_6, vri.species_pct_6,   vri.proj_age_1, vri.proj_height_1, vri.live_stand_volume_175, vri.stand_percentage_dead, vri.quad_diam_175,
  veg_comp_lyr_r1_poly2002.geometry FROM veg_comp_lyr_r1_poly2002,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2002') as fire where st_contains
  (fire.wkb_geometry, veg_comp_lyr_r1_poly2002.geometry))


################################



##2007
################################
CREATE TABLE fire_veg_2007 AS
(SELECT feature_id, bclcs_lv_1, bclcs_lv_2, bclcs_lv_3, bclcs_lv_4, bclcs_lv_5, cst_int_cd, cr_closure, live_stems, dead_stems, spec_cd_1, spec_pct_1, spec_cd_2, spec_pct_2, spec_cd_3, spec_pct_3, spec_cd_4, spec_pct_4, spec_cd_5, spec_pct_5, spec_cd_6, spec_pct_6,
 upd_htdate, proj_age_1, proj_ht_1, q_diam_175, volsp1_175, volsp2_175, volsp3_175, volsp4_175, volsp5_175, volsp6_175,  
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2007.geometry FROM veg_comp_lyr_r1_poly2007,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2007') as fire where st_contains
  (veg_comp_lyr_r1_poly2007.geometry, fire.wkb_geometry))
  
  CREATE TABLE fire_veg_2007_2 AS
(SELECT feature_id, bec_zone_code, bec_subzone, harvest_date, earliest_nonlogging_dist_type,
 earliest_nonlogging_dist_date, stand_percentage_dead, quad_diam_175,  
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2006.geometry FROM veg_comp_lyr_r1_poly2006,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2007') as fire where st_contains
  (veg_comp_lyr_r1_poly2006.geometry, fire.wkb_geometry))
##################################

##2008
##################################
CREATE TABLE fire_veg_2008 AS
(SELECT feature_id, bclcs_level_1, bclcs_level_2, bclcs_level_3, bclcs_level_4, bclcs_level_5, coast_interior_cd, bec_zone_code, crown_closure, vri_live_stems_per_ha, vri_dead_stems_per_ha, harvest_date, earliest_nonlogging_dist_type, earliest_nonlogging_dist_date, species_cd_1, species_pct_1, species_cd_2, species_pct_2, species_cd_3, species_pct_3, species_cd_4, species_pct_4, species_cd_5, species_pct_5, species_cd_6, species_pct_6,   proj_age_1, proj_height_1, vol_per_ha_spp1_175, vol_per_ha_spp2_175, vol_per_ha_spp3_175, vol_per_ha_spp4_175, vol_per_ha_spp5_175, vol_per_ha_spp6_175, quad_diam_175,
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2008.geometry FROM veg_comp_lyr_r1_poly2008,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2008') as fire where st_contains
  (veg_comp_lyr_r1_poly2008.geometry, fire.wkb_geometry))  
  
CREATE TABLE fire_veg_2008_2 AS
(SELECT bec_subzone, stand_percentage_dead,
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2009.geometry FROM veg_comp_lyr_r1_poly2009,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2008') as fire where st_contains
  (veg_comp_lyr_r1_poly2009.geometry, fire.wkb_geometry))  ################################





## See specifics of land cover types here: https://www2.gov.bc.ca/assets/gov/environment/natural-resource-stewardship/nr-laws-policy/risc/landcover-02.pdf
bclcs_level_2: The second level of the BC land cover classification scheme classifies the polygon as to the land cover type:
   # treed or non-treed for vegetated polygons; land or water for non-vegetated polygons.
bclcs_level_3: The location of the polygon relative to elevation and drainage, and is described as either alpine, wetland
   # or upland. In rare cases, the polygon may be alpine wetland.
bclcs_level_4: Classifies the vegetation types and non-vegetated cover types (as described by the presence of distinct features
    # upon the land base within the polygon).
bclcs_level_5: Classifies the vegetation density classes and Non-Vegetated categories.



# Another problem is that fire_veg_2011 has a geometry column that is type MultiPolygonZ instead of MultiPolygon so this needs to be changed with the following query in postgres
 ALTER TABLE fire_veg_2011  
 ALTER COLUMN geometry TYPE geometry(MULTIPOLYGON, 3005) 
 USING ST_Force2D(geometry);

Now, we can use R for the next step.

=====================

```{r}
#Load necessary libraries

library(dplyr)
library(tidyr)
library(keyring)
library(sf)
library(DBI)
library(purrr)
library(tidyverse)
library(ggplot2)
library (ggcorrplot)
library (RPostgreSQL)
library (rpostgis)
library (lme4)
library (arm)
library(ggpubr)
library(mgcv)
library(nlme)
library(caret)
library(pROC)

source(here::here("R/functions/R_Postgres.R"))

```

Now we will bring all of the files we made above into R. You may need to create a new connection to bring each one in instead, or at least run line by line and not as a code chunk.

If we need to set library paths, then:
```{r}
.libPaths("C:/data/localApps/R-4.1.2/library")
```


```{r}
#Import all fire_veg
conn <- dbConnect (dbDriver ("PostgreSQL"), 
                   host = "",
                   user = "postgres",
                   dbname = "postgres",
                   password = "postgres",
                   port = "5432")
fire_veg_2002 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2002")
fire_veg_2003 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2003")
fire_veg_2004 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2004")
fire_veg_2005 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2005")
fire_veg_2006 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2006")
fire_veg_2007 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2007")
fire_veg_2007_2 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2007_2")

fire_veg_2008 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2008")
fire_veg_2008_2 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2008_2")

fire_veg_2009 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2009")
fire_veg_2010 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2010")
fire_veg_2011 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2011")
fire_veg_2012 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2012")
fire_veg_2013 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2013")
fire_veg_2014 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2014")
fire_veg_2015 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2015")
fire_veg_2016 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2016")
fire_veg_2017 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2017")
fire_veg_2018 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2018")
fire_veg_2019 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2019")
fire_veg_2020 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2020")
fire_veg_2021 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2021")


dbDisconnect (conn) # connKyle

```

We need to update naming conventions from the 2007 and 2008 data given that it is different in those VRI files than for other years.

```{r}
# Change a number of things for 2007 data

fire_veg_2007_2<-st_drop_geometry(fire_veg_2007_2)
fire_veg_2007_2 <- fire_veg_2007_2 %>% dplyr::select(bec_zone_code:bec_subzone, earliest_nonlogging_dist_type:stand_percentage_dead, idno)

fire_veg_2007a<-left_join(fire_veg_2007, fire_veg_2007_2, by="idno")
dim(fire_veg_2007)
dim(fire_veg_2007a)
fire_veg_2007a[duplicated(fire_veg_2007a$idno),]
fire_veg_2007a %>% filter(idno==165838)
fire_veg_2007a %>% filter(idno==171634)
fire_veg_2007a %>% filter(idno==169733) # good looks like the duplicated records are the same.

fire_veg_2007b<-fire_veg_2007a[!duplicated(fire_veg_2007a$idno),] # remove duplicated idno records

dim(fire_veg_2007b)
fire_veg_2007<- fire_veg_2007b %>% rename(
  bclcs_level_1=bclcs_lv_1,
  bclcs_level_2=bclcs_lv_2,
  bclcs_level_3=bclcs_lv_3,
  bclcs_level_4=bclcs_lv_4,
  bclcs_level_5=bclcs_lv_5,
  proj_height_1=proj_ht_1, 
  harvest_date=upd_htdate,
  species_cd_1=spec_cd_1,
  species_cd_2=spec_cd_2,
  species_cd_3=spec_cd_3,
  species_cd_4=spec_cd_4,
  species_cd_5=spec_cd_5,
  species_cd_6=spec_cd_6,
  species_pct_1=spec_pct_1,
  species_pct_2=spec_pct_2,
  species_pct_3=spec_pct_3,
  species_pct_4=spec_pct_4,
  species_pct_5=spec_pct_5,
  species_pct_6=spec_pct_6,
  quad_diam_175=q_diam_175,
  coast_interior_cd=cst_int_cd,
  crown_closure=cr_closure,
  vri_live_stems_per_ha=live_stems,
  vri_dead_stems_per_ha=dead_stems)

fire_veg_2007<- fire_veg_2007 %>% 
  rowwise() %>%
  mutate(live_stand_volume_175 = sum(c_across(volsp1_175:volsp6_175), na.rm = TRUE))

fire_veg_2007$live_stand_volume_175<- ifelse(is.na(fire_veg_2007$volsp1_175) & is.na(fire_veg_2007$volsp2_175), NA, fire_veg_2007$live_stand_volume_175)

fire_veg_2007c<-fire_veg_2007 %>% dplyr::select(feature_id:quad_diam_175, idno:live_stand_volume_175)

dim(fire_veg_2007c)

```

Join data for 2008 and calculate live stand volume
```{r}
fire_veg_2008_2<-st_drop_geometry(fire_veg_2008_2)
fire_veg_2008_2 <- fire_veg_2008_2 %>% dplyr::select(bec_subzone:idno)

fire_veg_2008a<-left_join(fire_veg_2008, fire_veg_2008_2, by="idno")
dim(fire_veg_2008)
dim(fire_veg_2008a)

fire_veg_2008a<- fire_veg_2008a %>% 
  rowwise() %>%
  mutate(live_stand_volume_175 = sum(c_across(vol_per_ha_spp1_175:vol_per_ha_spp6_175), na.rm = TRUE))

fire_veg_2008a$live_stand_volume_175<- ifelse(is.na(fire_veg_2008a$vol_per_ha_spp1_175) & is.na(fire_veg_2008a$vol_per_ha_spp2_175), NA, fire_veg_2008a$live_stand_volume_175)

fire_veg_2008b <- fire_veg_2008a %>% dplyr::select(feature_id:proj_height_1, quad_diam_175:live_stand_volume_175)

dim(fire_veg_2008b)
dim(fire_veg_2002)



```

Now we must combine all of the files together into one.

```{r}
#Check all have same number columns
names(fire_veg_2002)
names(fire_veg_2007c)
names(fire_veg_2008b)
names(fire_veg_2020)

#fire_veg_2020<-fire_veg_2002[-c(74),]??


# join all fire_veg datasets together. This function is faster than a list of rbinds
filenames3<- c("fire_veg_2002", "fire_veg_2003", "fire_veg_2004","fire_veg_2005", "fire_veg_2006", "fire_veg_2007c","fire_veg_2008b", "fire_veg_2009", "fire_veg_2010","fire_veg_2011", "fire_veg_2012", "fire_veg_2013","fire_veg_2014", "fire_veg_2015", "fire_veg_2016","fire_veg_2017", "fire_veg_2018", "fire_veg_2019", "fire_veg_2020", "fire_veg_2021")
filenames3

mkFrameList <- function(nfiles) {
  d <- lapply(seq_len(nfiles),function(i) {
    eval(parse(text=filenames3[i])) # for new files lists change the name at filenames2
  })
  do.call(rbind,d)
}

n<-length(filenames3)
fire_veg_data_B<-mkFrameList(n)

dim(fire_veg_data_B) #508506

### hmm comparing dim(sample_locations_DEM_roads_wind2) to the above I see that 25606 points got lost somewhere. why?

sample_locations_DEM_roads_wind2<- st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\Data_clim_DEM_roads_wind_frt.shp")
dim(sample_locations_DEM_roads_wind2) # 534112 # When I sample vegetaion from the VRI I seem to loose around 4% of the points. Not sure what to do about this.

dim(sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2021))
dim(fire_veg_2021)

# 2002 -> 28256 to 27301
# 2003 -> 39200 to 38158
# 2004 -> 37840 to 36732
# 2005 -> 15328 to 15321
# 2006 -> 40544 to 40551 # thats weird this one increased. Maybe a duplicate. should double check
# 2007 -> 25488 to 25484
# 2008 -> 32080 to 23488 # this one is bad!
# 2009 -> 48736 to 48732
# 2010 -> 26448 to 26441
# 2011 -> 10244 to 10220
# 2012 -> 26048 to 20329 bad! 
# 2013 -> 29536 to 29518
# 2014 -> 23536 to 23534
# 2015 -> 29632 to 29629
# 2016 -> 16592 to 16590
# 2017 -> 21424 to 21423
# 2018 -> 33520 to 33519
# 2019 -> 12816 to 12815
# 2020 -> 10608 to 2468 REALLY BAD!!
# 2021 -> 26256 to 26253
## lots of data from 2008 getting lost when we extract vegetaion from the VRI (3206 locations in total out of 12030)
#2012 also seem to loose a lot around 2159 points.

fire_veg_data_nogeom<- st_set_geometry(fire_veg_data_B, NULL)
fire_veg_data_nogeom$idno<- as.numeric(fire_veg_data_nogeom$idno)
fire_veg_data_nogeom$idno_check<-fire_veg_data_nogeom$idno
sample_locations_DEM_roads_wind2$idno<- as.numeric(sample_locations_DEM_roads_wind2$idno)

fire_all<-merge(sample_locations_DEM_roads_wind2, fire_veg_data_nogeom, by=c("idno", "fire_yr"), all.x=TRUE)

dim(fire_all)
dim(sample_locations_DEM_roads_wind2) # its weird I seem to gain a few extra locations when I join the above two  datasets Im not sure why???

as.data.frame(fire_all %>% filter(fire_yr==2008) %>% dplyr::select(fire_yr, idno, idno_check)) # looks ok although Im not sure why I got an extra 46 locations??? Cant figure it out.

table(fire_all$fire_yr, fire_all$fire_cs)

```
Try saving file
```{r}
st_write(fire_all, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\Fire_data_all.shp", delete_layer=TRUE)

#ogr2ogr -f PostgreSQL PG:"dbname=castor port=5432 user= password= host=DG401102" C:\\Work\\caribou\\castor\\R\\fire_sim\\tmp\\Fire_data_all.shp -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI 

fire_all<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\Fire_data_all.shp")

```

Because we have many large objects open in R, we will close some that we no longer need.

```{r}
##Now we will remove all of the fire_veg_20XX files since we are finished with processing these

rm(fire_veg_2002, fire_veg_2003, fire_veg_2004,fire_veg_2005, fire_veg_2006, fire_veg_2007,fire_veg_2008, fire_veg_2009, fire_veg_2010,fire_veg_2011, fire_veg_2012, fire_veg_2013,fire_veg_2014, fire_veg_2015, fire_veg_2016,fire_veg_2017, fire_veg_2018, fire_veg_2019, fire_veg_2020,fire_veg_2020_2, fire_veg_2020_3, fire_veg_2021, fire_veg_2021_2, fire_veg_2021_3)

```

Note: do we want to remove sites that are predominately water? Might be good to have in? Instead, however, we can mask at the start to remove all sites that are water from being eligible to be on fire.

```{r}
##1. Remove all sites that are predominately water or not classified as anything
str(fire_all)

# looking at how many na values there are
table(is.na(fire_all$bclc__2))
table(is.na(fire_all$bclc__3))
table(is.na(fire_all$bclc__4))
table(is.na(fire_all$bclc__5))

ignition_pres_abs3 <-fire_all %>%
  filter(bclc__2!="W") %>%
  filter(bclc__2!=" ") # this reduces the number of points from 200344 to 176706 i.e. around 12% drop. 
# 17840 are NA and 5798 are Water. Thats a lot of NA's. Not sure what to do about that

table(ignition_pres_abs3$bclc__2, ignition_pres_abs3$fire_cs) # T=treed, N =  non-treed and L = land.

table(is.na(ignition_pres_abs3$bclc__2))
table(is.na(ignition_pres_abs3$bclc__3))
table(is.na(ignition_pres_abs3$bclc__4))
table(is.na(ignition_pres_abs3$bclc__5))

table(ignition_pres_abs3$bclc__3, ignition_pres_abs3$fire_cs)
table(ignition_pres_abs3$fire_yr, ignition_pres_abs3$fire_cs) 
table(ignition_pres_abs3$bclc__4, ignition_pres_abs3$fire_cs)
str(ignition_pres_abs3)


#Creating new variable of vegetation type and a description of how open the vegetation is
# TB =  Treed broadleaf, TC = Treed Conifer, TM = Treed mixed, SL = short shrub, ST = tall shrubs, D = disturbed, O = open. I will combine tall and short shrub. We dont estimate shrub cover in our castor model so Im not sure how this will influence our results since I dont think I can track it over time. Maybe I should include it in Open or disturbed?

ignition_pres_abs3$bclc__4<- as.factor(ignition_pres_abs3$bclc__4)
ignition_pres_abs4<- ignition_pres_abs3 %>% drop_na(bclc__4) # this drops from 176706 to 176666  locations so I think its ok to remove the NA's
unique(ignition_pres_abs4$bclc__4)

ignition_pres_abs4$vegtype<-"OP" #setting anything that is not one of the categories below to Open.
ignition_pres_abs4 <- ignition_pres_abs4 %>%
  mutate(vegtype = if_else(bclc__4=="TC","TC", # Treed coniferous
                           if_else(bclc__4=="TM", "TM", # Treed mixed
                                   if_else(bclc__4== "TB","TB", #Treed broadleaf
                                           if_else(bclc__4=="SL", "S", # shrub
                                                   if_else(bclc__4=="ST", "S", vegtype))))))
ignition_pres_abs4$vegtype[which(ignition_pres_abs4$prj_g_1 <16)]<-"D" # disturbed -  following Marchal et al 2017 I make anything that is younger than 15 years old to disturbed. This might be something I should check whether this assumption is ok.

#ignition_pres_abs4<- ignition_pres_abs4 %>% filter(fir_typ!="Nuisance Fire") 
table(ignition_pres_abs4$vegtype, ignition_pres_abs4$fire_cs)

# look at vegetation height, volume and age as we track these in castor. 
ignition_pres_abs4$prj_g_1<- as.numeric(ignition_pres_abs4$prj_g_1)
hist(ignition_pres_abs4$prj_g_1)
hist(ignition_pres_abs4$prj_h_1) # not sure we have height in castor, we do have volume though. So maybe I should include age and volume in my model. This might be a surrogate for height
hist(ignition_pres_abs4$l___125)
hist(log(ignition_pres_abs4$l___125))
```

Try saving file again.

```{r}
st_write(ignition_pres_abs4, dsn = "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\Fire_data_all_with_veg.shp", delete_layer=TRUE)
 
##To save to castor, need OsGeo4W
#Modify below with correct credentials and upload on castor as desired
#ogr2ogr -f PostgreSQL PG:"dbname=castor port=5432 user= password= host=DC052586" D:\\Fire\\fire_data\\raw_data\\Fire_climate_DEM_VRI_shape_files\\fire_veg_dem_person_NA_5x_NoW.shp -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI 

#ogr2ogr -f PostgreSQL PG:"dbname=castor port=5432 user= password= host=DC052586" D:\\Fire\\fire_data\\raw_data\\Fire_climate_DEM_VRI_shape_files\\fire_veg_dem_lightning_NA_5x_NoW.shp -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI 

```

If you still have many objects open in your Environment, then let's clean the R environment of other elements if we have continued from previous files. This will help R run and not crash. Many methods can be found here: https://stackoverflow.com/questions/6190051/how-can-i-remove-all-objects-but-one-from-the-workspace-in-r

```{r}
ls()

library(gdata)

keep(fire_veg_data_B, ignition_pres_abs4, fire_veg_data_lightning_5x, fire_veg_data_person_5x, fire_veg_data_NA_5x, fire_veg_data_lightning_NA_5x, fire_veg_data_person_NA_5x) #shows you which variables will be removed

keep(fire_veg_data_B, ignition_pres_abs4, fire_veg_data_lightning_5x, fire_veg_data_person_5x, fire_veg_data_NA_5x, fire_veg_data_lightning_NA_5x, fire_veg_data_person_NA_5x, sure = TRUE) # setting sure to TRUE removes variables not in the list
 
ls()
gc(TRUE)

```

```{r}

##You may wish to clear your environment after this portion
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
gc() #free up memory and report the memory usage.
```

############## Now move on to file 08_ignition_climate_variable_selection#############
