---
title: "VRI_data_prep"
author: "Elizabeth Kleynhans"
date: "07/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

#=================================
#  Script Name: 07_vri_data_prep.R
#  Script Version: 1.0
#  Script Purpose: This script creates a table of 1ha x 1ha pixels with vegetation data taken from the VRI for each year for each location.  These locations line up with the locations that I collected climate data from. 
#  Script Author: Elizabeth Kleynhans, Ecological Modeling Specialist, Forest Analysis and Inventory Branch, B.C. Ministry of Forests, Lands, and Natural Resource Operations.
#  Script Contributor: Cora Skaien, Ecological Modeling Specialist, Forest Analysis and Inventory Branch, B.C. Ministry of Forests, Lands, and Natural Resource Operations.
#=================================

#Overview:
In this file, we acquire the VRI (Vegetation Resources Inventory) for each year by location from 2002 to 2020. This is likely already uploaded onto a network and may not need to be redone.
The final product will be a file with veg data along with ignition data and climate data (vegetation, climate and presence/absence of fire data).

The first portion of this code cannot be run on R. Instead, you must use PgAdmin command line.


#### VEGETATION DATA #### 
2002 to 2019 are the only years that VRI data exists, there is no earlier data. I have located a 2020 data file, but it has some too but not all columns for VRI info.

##This first section has been completed on this computer.
from https://catalogue.data.gov.bc.ca/dataset/vri-historical-vegetation-resource-inventory-2002-2019-
I (Liz) then extracted this data and uploaded it into my local postgres database by running the command below in terminal. If running it in the R terminal does not work try run it in here: 
#C:\data\localApps\QGIS10.16\OSGeo4W (the terminal window)

You may get a warning indicating that this will take a long time, or that databases are not supported. You should specify a specific item within the database.
#ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres dbname=postgres password=postgres port=5432" C:\\Work\\caribou\\clus_data\\Fire\\VEG_COMP_POLY_AND_LAYER_2020.gdb -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI

Above is run or each year 2002 to 2020 separately from the data. This is already on the private server, so if you are using the private server, you do not need to run again.

# rename the table in postgres if need be
#ALTER TABLE veg_comp_lyr_r1_poly RENAME TO veg_comp_lyr_r1_poly2017

# When the table name is changed the idx name is not so you might have to change that too so that more files can be uploaded into postgres by running the following command
#ALTER INDEX veg_comp_lyr_r1_poly_shape_geom_idx RENAME TO veg_comp_lyr_r1_poly2019_geometry_geom_idx;
# and if need be change the name of the geometry column from shape to geometry
#ALTER TABLE veg_comp_lyr_r1_poly2019 RENAME COLUMN shape TO geometry;

#### Join ignition data to VRI data ####
Run following query in postgres for all years 2002-2019 except 2007 and 2008. 2020 also has slightly different code. This will need to be done each time new data is generated for random points in file 02. This below code is fast. Note, there are 5 locations in the below code for which to update the year.

Depending on how the file names most recently saved, some changes may need to be made (e.g., ign_mnt versus ign_month).

##2002 -2006, 2009-2019
################################
CREATE TABLE fire_veg_2002 AS
(SELECT feature_id, bclcs_level_2, bclcs_level_3, bclcs_level_4, bclcs_level_5,
  harvest_date, proj_age_1, proj_height_1, live_stand_volume_125, 
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2002.geometry FROM veg_comp_lyr_r1_poly2002,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2002') as fire where st_contains
  (veg_comp_lyr_r1_poly2002.geometry, fire.wkb_geometry))

################################

##2007
################################
CREATE TABLE fire_veg_2007 AS
(SELECT feature_id, bclcs_lv_2, bclcs_lv_3, bclcs_lv_4, bclcs_lv_5,
 upd_htdate, proj_age_1, proj_ht_1, 
 COALESCE(volsp1_125,0)+COALESCE(volsp2_125,0)+COALESCE(volsp3_125,0)+COALESCE(volsp4_125,0)+
 COALESCE(volsp5_125,0) AS live_stand_volume_125,  
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2007.geometry FROM veg_comp_lyr_r1_poly2007,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2007') as fire where st_contains
  (veg_comp_lyr_r1_poly2007.geometry, fire.wkb_geometry))
##################################

##2008
##################################
CREATE TABLE fire_veg_2008 AS
(SELECT feature_id, bclcs_level_2, bclcs_level_3, bclcs_level_4, bclcs_level_5,
   harvest_date, proj_age_1, proj_height_1, COALESCE(vol_per_ha_spp1_125,0)+
     COALESCE(vol_per_ha_spp2_125,0)+COALESCE(vol_per_ha_spp3_125,0)+COALESCE(vol_per_ha_spp4_125,0)
   +COALESCE(vol_per_ha_spp5_125,0)+COALESCE(vol_per_ha_spp6_125,0) AS live_stand_volume_125,
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2008.geometry FROM veg_comp_lyr_r1_poly2008,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2008') as fire where st_contains
  (veg_comp_lyr_r1_poly2008.geometry, fire.wkb_geometry))
  ################################


##2020
##################################
CREATE TABLE fire_veg_2020 AS
(SELECT feature_id, bclcs_level_2, bclcs_level_3, bclcs_level_4, bclcs_level_5,
  harvest_date, 
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2020.geometry FROM veg_comp_lyr_r1_poly2020,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2020') as fire where st_contains
  (veg_comp_lyr_r1_poly2020.geometry, fire.wkb_geometry))
  
# Trying to get projected height and volume for 2020 as its missing from this data set so instead ill sample it from the 2019 VRI and hope that is close enough  
CREATE TABLE fire_veg_2020_2 AS
(SELECT proj_age_1, proj_height_1, live_stand_volume_125, 
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2019.geometry FROM veg_comp_lyr_r1_poly2019,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2020') as fire where st_contains
  (veg_comp_lyr_r1_poly2019.geometry, fire.wkb_geometry))
  #################################

##2021 There does not seem to be 2021 VRI data yet so Im just going to sample from the 2020 VRI data
##################################
CREATE TABLE fire_veg_2021 AS
(SELECT feature_id, bclcs_level_2, bclcs_level_3, bclcs_level_4, bclcs_level_5,
  harvest_date, 
  fire.idno, fire.fire_yr,
  veg_comp_lyr_r1_poly2020.geometry FROM veg_comp_lyr_r1_poly2020,
  (SELECT wkb_geometry, idno, fire_yr
   from data_clim_dem_roads_wind_frt where fire_yr = '2021') as fire where st_contains
  (veg_comp_lyr_r1_poly2020.geometry, fire.wkb_geometry))
  #################################





## See specifics of land cover types here: https://www2.gov.bc.ca/assets/gov/environment/natural-resource-stewardship/nr-laws-policy/risc/landcover-02.pdf
bclcs_level_2: The second level of the BC land cover classification scheme classifies the polygon as to the land cover type:
   # treed or non-treed for vegetated polygons; land or water for non-vegetated polygons.
bclcs_level_3: The location of the polygon relative to elevation and drainage, and is described as either alpine, wetland
   # or upland. In rare cases, the polygon may be alpine wetland.
bclcs_level_4: Classifies the vegetation types and non-vegetated cover types (as described by the presence of distinct features
    # upon the land base within the polygon).
bclcs_level_5: Classifies the vegetation density classes and Non-Vegetated categories.

# note that the VRI for 2008 does not have live_stand_volume so I (Liz) also tried to extract it from the 2009 VRI and put it in here -  assuming that a year would not make much difference to volume. Below is the code i used to try and do this (but note this does not seem to work.... )
### July 2021, when ran, there already is a column for live_stand_volume_125, so this may not be necessary

#ALTER TABLE fire_veg_2008
#ADD COLUMN live_stand_volume_125 double precision;

# INSERT INTO fire_veg_2008
# SELECT live_stand_volume_125
# FROM veg_comp_lyr_r1_poly2009,
# (SELECT wkb_geometry from Data_ignite_AllMonths where fire_yr = '2008') as fire where st_contains
# (veg_comp_lyr_r1_poly2009.geometry, fire.wkb_geometry)


# Another problem is that fire_veg_2011 has a geometry column that is type MultiPolygonZ instead of MultiPolygon so this needs to be changed with the following query in postgres
 ALTER TABLE fire_veg_2011  
 ALTER COLUMN geometry TYPE geometry(MULTIPOLYGON, 3005) 
 USING ST_Force2D(geometry);

Now, we can use R for the next step.

=====================

```{r}
#Load necessary libraries

library(dplyr)
library(tidyr)
library(keyring)
library(sf)
library(DBI)
library(purrr)
library(tidyverse)
library(ggplot2)
library (ggcorrplot)
library (RPostgreSQL)
library (rpostgis)
library (lme4)
library (arm)
library(ggpubr)
library(mgcv)
library(nlme)
library(caret)
library(pROC)

source(here::here("R/functions/R_Postgres.R"))

```

Now we will bring all of the files we made above into R. You may need to create a new connection to bring each one in instead, or at least run line by line and not as a code chunk.

If we need to set library paths, then:
```{r}
.libPaths("C:/data/localApps/R-4.1.2/library")
```


```{r}
#Import all fire_veg
conn <- dbConnect (dbDriver ("PostgreSQL"), 
                   host = "",
                   user = "postgres",
                   dbname = "postgres",
                   password = "postgres",
                   port = "5432")
fire_veg_2002 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2002")
fire_veg_2003 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2003")
fire_veg_2004 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2004")
fire_veg_2005 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2005")
fire_veg_2006 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2006")
fire_veg_2007 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2007")
fire_veg_2008 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2008")
fire_veg_2009 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2009")
fire_veg_2010 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2010")
fire_veg_2011 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2011")
fire_veg_2012 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2012")
fire_veg_2013 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2013")
fire_veg_2014 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2014")
fire_veg_2015 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2015")
fire_veg_2016 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2016")
fire_veg_2017 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2017")
fire_veg_2018 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2018")
fire_veg_2019 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2019")
fire_veg_2020 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2020")
fire_veg_2020_2 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2020_2")
fire_veg_2021 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2021")
fire_veg_2021_2 <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM public.fire_veg_2021_2")


dbDisconnect (conn) # connKyle

```

We need to update naming conventions from the 2007 and 2008 data given that it is different in those VRI files than for other years.

```{r}
# REMEMBER TO CHANGE THE 0 values in the 2007 and 2008 fire_veg datasets for volume to NULL.

# the VRI for 2007 had harvest_date named upd_htdate and proj_height_1, proj_height_2 as proj_ht_1, proj_ht_2. So I need to be renamed these columns
#fire_veg_2007$harvest_date <- NA
names(fire_veg_2007)
names(fire_veg_2002)
fire_veg_2007<- fire_veg_2007 %>% rename(
  bclcs_level_2=bclcs_lv_2,
  bclcs_level_3=bclcs_lv_3,
  bclcs_level_4=bclcs_lv_4,
  bclcs_level_5=bclcs_lv_5,
  proj_height_1=proj_ht_1, 
  harvest_date=upd_htdate)


# change the 0 values in live_stand_volume_125 to NULL for both 2007 and 2008 data

fire_veg_2007$live_stand_volume_125[fire_veg_2007$live_stand_volume_125 == 0] <- NA
fire_veg_2008$live_stand_volume_125[fire_veg_2008$live_stand_volume_125 == 0] <- NA

fire_veg_2020_2<-st_set_geometry(fire_veg_2020_2, NULL)
fire_veg_2020_2$idno<- as.numeric(fire_veg_2020_2$idno)
fire_veg_2020$idno<- as.numeric(fire_veg_2020$idno)

fire_veg_2020_3<-left_join(fire_veg_2020, fire_veg_2020_2, by=c("idno", "fire_yr"))
dim(fire_veg_2020)
dim(fire_veg_2020_3)

fire_veg_2021_2<-st_set_geometry(fire_veg_2021_2, NULL)
fire_veg_2021_2$idno<- as.numeric(fire_veg_2021_2$idno)
fire_veg_2021$idno<- as.numeric(fire_veg_2021$idno)

fire_veg_2021_3<-left_join(fire_veg_2021, fire_veg_2021_2, by=c("idno", "fire_yr"))
dim(fire_veg_2021)
dim(fire_veg_2021_3)

```

Now we must combine all of the files together into one.

```{r}
#Check all have same number columns
names(fire_veg_2002)
names(fire_veg_2007)
names(fire_veg_2008)
names(fire_veg_2020)

#fire_veg_2020<-fire_veg_2002[-c(74),]??


# join all fire_veg datasets together. This function is faster than a list of rbinds
filenames3<- c("fire_veg_2002", "fire_veg_2003", "fire_veg_2004","fire_veg_2005", "fire_veg_2006", "fire_veg_2007","fire_veg_2008", "fire_veg_2009", "fire_veg_2010","fire_veg_2011", "fire_veg_2012", "fire_veg_2013","fire_veg_2014", "fire_veg_2015", "fire_veg_2016","fire_veg_2017", "fire_veg_2018", "fire_veg_2019", "fire_veg_2020_3", "fire_veg_2021_3")
filenames3

mkFrameList <- function(nfiles) {
  d <- lapply(seq_len(nfiles),function(i) {
    eval(parse(text=filenames3[i])) # for new files lists change the name at filenames2
  })
  do.call(rbind,d)
}

n<-length(filenames3)
fire_veg_data_B<-mkFrameList(n)

dim(fire_veg_data_B) #193773

sample_locations_DEM_roads_wind2<- st_read("C:\\Work\\caribou\\clus\\R\\fire_sim\\tmp\\Data_clim_DEM_roads_wind_frt.shp")
dim(sample_locations_DEM_roads_wind2) # 200298 # When I sample vegetaion from the VRI I seem to loose around 4% of the points. Not sure what to do about this.

dim(sample_locations_DEM_roads_wind2 %>% filter(fire_yr==2002))
dim(fire_veg_2002)

## lots of data from 2008 getting lost when we extract vegetaion from the VRI (3206 locations in total out of 12030)
#2012 also seem to loose a lot around 2159 points.

fire_veg_data_nogeom<- st_set_geometry(fire_veg_data_B, NULL)
fire_veg_data_nogeom$idno<- as.numeric(fire_veg_data_nogeom$idno)
fire_veg_data_nogeom$idno_check<-fire_veg_data_nogeom$idno
sample_locations_DEM_roads_wind2$idno<- as.numeric(sample_locations_DEM_roads_wind2$idno)

fire_all<-merge(sample_locations_DEM_roads_wind2, fire_veg_data_nogeom, by=c("idno", "fire_yr"), all.x=TRUE)

dim(fire_all)
dim(sample_locations_DEM_roads_wind2) # its weird I seem to gain a few extra locations when I join the above two  datasets Im not sure why???

as.data.frame(fire_all %>% filter(fire_yr==2008) %>% select(fire_yr, idno, idno_check)) # looks ok although Im not sure why I got an extra 46 locations??? Cant figure it out.

table(fire_all$fire_yr, fire_all$fire_cs)

```
Try saving file
```{r}
st_write(fire_all, dsn = "C:\\Work\\caribou\\clus\\R\\fire_sim\\tmp\\Fire_data_all.shp", delete_layer=TRUE)

#ogr2ogr -f PostgreSQL PG:"dbname=clus port=5432 user= password= host=DG401102" C:\\Work\\caribou\\clus\\R\\fire_sim\\tmp\\Fire_data_all.shp -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI 

fire_all<-st_read("C:\\Work\\caribou\\clus_data\\Fire\\Fire_sim_data\\tmp\\Fire_data_all.shp")

```

Because we have many large objects open in R, we will close some that we no longer need.

```{r}
##Now we will remove all of the fire_veg_20XX files since we are finished with processing these

rm(fire_veg_2002, fire_veg_2003, fire_veg_2004,fire_veg_2005, fire_veg_2006, fire_veg_2007,fire_veg_2008, fire_veg_2009, fire_veg_2010,fire_veg_2011, fire_veg_2012, fire_veg_2013,fire_veg_2014, fire_veg_2015, fire_veg_2016,fire_veg_2017, fire_veg_2018, fire_veg_2019, fire_veg_2020,fire_veg_2020_2, fire_veg_2020_3, fire_veg_2021, fire_veg_2021_2, fire_veg_2021_3)

```

Note: do we want to remove sites that are predominately water? Might be good to have in? Instead, however, we can mask at the start to remove all sites that are water from being eligible to be on fire.

```{r}
##1. Remove all sites that are predominately water or not classified as anything
str(fire_all)

# looking at how many na values there are
table(is.na(fire_all$bclc__2))
table(is.na(fire_all$bclc__3))
table(is.na(fire_all$bclc__4))
table(is.na(fire_all$bclc__5))

ignition_pres_abs3 <-fire_all %>%
  filter(bclc__2!="W") %>%
  filter(bclc__2!=" ") # this reduces the number of points from 200344 to 176706 i.e. around 12% drop. 
# 17840 are NA and 5798 are Water. Thats a lot of NA's. Not sure what to do about that

table(ignition_pres_abs3$bclc__2, ignition_pres_abs3$fire_cs) # T=treed, N =  non-treed and L = land.

table(is.na(ignition_pres_abs3$bclc__2))
table(is.na(ignition_pres_abs3$bclc__3))
table(is.na(ignition_pres_abs3$bclc__4))
table(is.na(ignition_pres_abs3$bclc__5))

table(ignition_pres_abs3$bclc__3, ignition_pres_abs3$fire_cs)
table(ignition_pres_abs3$fire_yr, ignition_pres_abs3$fire_cs) 
table(ignition_pres_abs3$bclc__4, ignition_pres_abs3$fire_cs)
str(ignition_pres_abs3)


#Creating new variable of vegetation type and a description of how open the vegetation is
# TB =  Treed broadleaf, TC = Treed Conifer, TM = Treed mixed, SL = short shrub, ST = tall shrubs, D = disturbed, O = open. I will combine tall and short shrub. We dont estimate shrub cover in our CLUS model so Im not sure how this will influence our results since I dont think I can track it over time. Maybe I should include it in Open or disturbed?

ignition_pres_abs3$bclc__4<- as.factor(ignition_pres_abs3$bclc__4)
ignition_pres_abs4<- ignition_pres_abs3 %>% drop_na(bclc__4) # this drops from 176706 to 176666  locations so I think its ok to remove the NA's
unique(ignition_pres_abs4$bclc__4)

ignition_pres_abs4$vegtype<-"OP" #setting anything that is not one of the categories below to Open.
ignition_pres_abs4 <- ignition_pres_abs4 %>%
  mutate(vegtype = if_else(bclc__4=="TC","TC", # Treed coniferous
                           if_else(bclc__4=="TM", "TM", # Treed mixed
                                   if_else(bclc__4== "TB","TB", #Treed broadleaf
                                           if_else(bclc__4=="SL", "S", # shrub
                                                   if_else(bclc__4=="ST", "S", vegtype))))))
ignition_pres_abs4$vegtype[which(ignition_pres_abs4$prj_g_1 <16)]<-"D" # disturbed -  following Marchal et al 2017 I make anything that is younger than 15 years old to disturbed. This might be something I should check whether this assumption is ok.

#ignition_pres_abs4<- ignition_pres_abs4 %>% filter(fir_typ!="Nuisance Fire") 
table(ignition_pres_abs4$vegtype, ignition_pres_abs4$fire_cs)

# look at vegetation height, volume and age as we track these in CLUS. 
ignition_pres_abs4$prj_g_1<- as.numeric(ignition_pres_abs4$prj_g_1)
hist(ignition_pres_abs4$prj_g_1)
hist(ignition_pres_abs4$prj_h_1) # not sure we have height in CLUS, we do have volume though. So maybe I should include age and volume in my model. This might be a surrogate for height
hist(ignition_pres_abs4$l___125)
hist(log(ignition_pres_abs4$l___125))
```

Try saving file again.

```{r}
st_write(ignition_pres_abs4, dsn = "C:\\Work\\caribou\\clus_data\\Fire\\Fire_sim_data\\tmp\\Fire_data_all_with_veg.shp", delete_layer=TRUE)
 
##To save to clus, need OsGeo4W
#Modify below with correct credentials and upload on clus as desired
#ogr2ogr -f PostgreSQL PG:"dbname=clus port=5432 user= password= host=DC052586" D:\\Fire\\fire_data\\raw_data\\Fire_climate_DEM_VRI_shape_files\\fire_veg_dem_person_NA_5x_NoW.shp -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI 

#ogr2ogr -f PostgreSQL PG:"dbname=clus port=5432 user= password= host=DC052586" D:\\Fire\\fire_data\\raw_data\\Fire_climate_DEM_VRI_shape_files\\fire_veg_dem_lightning_NA_5x_NoW.shp -overwrite -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI 

```

If you still have many objects open in your Environment, then let's clean the R environment of other elements if we have continued from previous files. This will help R run and not crash. Many methods can be found here: https://stackoverflow.com/questions/6190051/how-can-i-remove-all-objects-but-one-from-the-workspace-in-r

```{r}
ls()

library(gdata)

keep(fire_veg_data_B, ignition_pres_abs4, fire_veg_data_lightning_5x, fire_veg_data_person_5x, fire_veg_data_NA_5x, fire_veg_data_lightning_NA_5x, fire_veg_data_person_NA_5x) #shows you which variables will be removed

keep(fire_veg_data_B, ignition_pres_abs4, fire_veg_data_lightning_5x, fire_veg_data_person_5x, fire_veg_data_NA_5x, fire_veg_data_lightning_NA_5x, fire_veg_data_person_NA_5x, sure = TRUE) # setting sure to TRUE removes variables not in the list
 
ls()
gc(TRUE)

```

```{r}

##You may wish to clear your environment after this portion
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
gc() #free up memory and report the memory usage.
```

############## Now move on to file 08_ignition_climate_variable_selection#############
