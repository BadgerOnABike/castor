---
title: "Fire_size_test"
author: "Elizabeth Kleynhans"
date: "2023-01-11"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source(here::here("R/functions/R_Postgres.R"))
library (kableExtra)
library(tidyverse)
require (sf)
require (RPostgreSQL)
require (rpostgis)
require (fasterize)
require (raster)
require (dplyr)
library(bcdata)
library(SpaDES.tools)
library(terra)
library(quickPlot)
library(data.table)
library(ggplot2)
library(SpaDES.addins)
library(SpaDES)
library(SpaDES.core)

```

## Introduction

Here I want to test the simulation to check that its performing as expected i.e. that its somewhat mimicking real fires on the landscape.

#Ideas on how to test this:

1) If I input all actual ignition points observed for an area into the simulation does a similar proportion of fires escape. For the purpose of my escape layer I included only fires taht got bigger than 10ha. THus, here I check whether I get similar numbers of fires that are larger than 10ha's with my simulation as I do in real life.

2.) If I allow fires to spread out from those ignition points do I get a similar distribution of fire sizes as I observe in the data?

- I should do 1 and 2 for 2022 fires as an independent check of the data. 

3.) Something else to check is whether the probability of escape is similar to the probability of spread. Also are these similar for fires that dont escape as they are for fires that do escape? 
To do this if I regress the probability of escape on the probability of spread at the same locations i.e. locations where ignition occured. 

4.) I dont thinkg this will influence anything but I could also play with the number of neightbours that can ignite. Spread2 allows either 4 or 8 neighbours for spreading each simulation. Does this make any difference?

# import my ignition locations for 2022
```{r, echo=TRUE}
# get latest data off BCGW
ignit<-try(
  bcdc_query_geodata("WHSE_LAND_AND_NATURAL_RESOURCE.PROT_CURRENT_FIRE_PNTS_SP") %>%    
    filter(FIRE_TYPE == "Fire") %>%
    collect()
)

# first join the ignition points to frt so that I can see whether different frt react differently i.e. whether some are better than others.
frt <- st_read ( dsn = "D:\\Fire\\fire_data\\Fire_Regime_Types\\FRT\\FRT_Canada.shp", stringsAsFactors = T) # Read simple features from file or person_22aabase, or retrieve layer names and their geometry type(s)
st_crs(frt) #Retrieve coordinate reference system from sf or sfc object
frt<-st_transform(frt, 3005) #transform coordinate system to 3005 - that for BC, Canada

#get provincial boundary for clipping the layers to the area of interest
prov.bnd <- st_read ( dsn = "T:\\FOR\\VIC\\HTS\\ANA\\PROJECTS\\CASTOR\\Data\\admin_boundaries\\province\\gpr_000b11a_e.shp", stringsAsFactors = T) # Read simple features from file or database, or retrieve layer names and their geometry type(s)
st_crs(prov.bnd) #Retrieve coordinate reference system from sf or sfc object
prov.bnd <- prov.bnd [prov.bnd$PRENAME == "British Columbia", ] 
crs(prov.bnd)# this one needs to be transformed to 3005
bc.bnd <- st_transform (prov.bnd, 3005) #Transform coordinate system
st_crs(bc.bnd)

#Clip FRT here
frt_clipped<-st_intersection(bc.bnd, frt)
#plot(st_geometry(frt_clipped), col=sf.colors(10,categorical=TRUE))
length(unique(frt_clipped$Cluster))
frt_sf<-st_as_sf(frt_clipped)

fire.ignt.frt <- st_join(ignit, frt_clipped)
table(fire.ignt.frt$Cluster)
table(is.na(fire.ignt.frt$Cluster))

# change any ignition points in FRT =3 to frt=5
fire.ignt.frt$Cluster[fire.ignt.frt$Cluster ==3] <- 5

head(ignit)
table(ignit$FIRE_YEAR)
length(ignit$CURRENT_SIZE)

ignit_escape<- ignit %>% filter(CURRENT_SIZE >10)
length(ignit_escape$CURRENT_SIZE) # out of a total of 1647 fires only 263 of them escaped.
hist(ignit_escape$CURRENT_SIZE, breaks=50)
```

# select a study area
```{r}
# get study area

#study_area<-getSpatialQuery("SELECT tsa_name, wkb_geometry FROM study_area_compart where tsa_name in ('Quesnel TSA', 'Williams Lake TSA',  '100 Mile House TSA')")

frt_12<-frt_clipped %>% filter(Cluster == 12) %>% group_by ( Cluster) %>% summarise()
st_crs(frt_12)

ignit_subset <- ignit[frt_12, ]
ignit_subset_10<- ignit_subset %>% filter(CURRENT_SIZE >10)

length(ignit_subset$CURRENT_SIZE) # 167 locations caught fire
length(ignit_subset_10$CURRENT_SIZE) # 9 locations had fires > 10ha
```


```{r, study area with ignition points, eval = F, echo = T}
# look at where the ignition points are on the map
ggplot() +
  geom_sf(data=frt_12) + 
  geom_sf(data=ignit_subset)  +
  geom_sf(dat=ignit_subset_10, col="red")

```

##################################
# create escape and spread rasters for 2022
##################################
```{r}
x<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\BC_lighting_ignit_final_2022.gpkg")
names(x)
```

# get climate table for top variables in model
```{r}
climate_variable<-read.csv("C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/climate_AIC_results_escape_summary.csv")

kable (climate_variable,
       caption = "<b>Table 1. Top candidate climate variables for escaped fires as selected through an AIC analysis for each Fire Regime Type.<b>",
       digits = 2) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)

x$mean_Tave05_Tave06_Tave07_Tave08<- (x$Tave05 + x$Tave06 + x$Tave07 + x$Tave08)/4

x$mean_PPT05_PPT06_PPT07_PPT08 <- (x$PPT05 + x$PPT06 + x$PPT07 + x$PPT08)/4

x$mean_Tave04_Tave05_Tave06<- (x$Tave04 + x$Tave05 + x$Tave06 )/3

x$mean_PPT04_PPT05_PPT06<- (x$PPT04 + x$PPT05 + x$PPT06)/3

x$mean_PPT05_PPT06<- (x$PPT05 + x$PPT06)/2

```

#Create climate1 and climate2 columns
```{r}
#View top variable

x$frt<-as.numeric(x$frt)

table(x$frt)

## Create empty vector
x$climate1<-"NA"

head(x)

x<-x %>%
    mutate(climate1 = case_when(
                            frt == "5" ~ as.numeric(PPT05) ,
                            frt == "7" ~ as.numeric(PPT03),
                            frt == "9" ~ Tave05,
                            frt == "10" ~ mean_Tave05_Tave06_Tave07_Tave08 ,
                            frt == "11" ~ Tave09,
                            frt == "12" ~ mean_Tave04_Tave05_Tave06,
                            frt == "13" ~ Tave09,
                            frt == "14" ~ as.numeric(mean_PPT05_PPT06),
                            frt == "15" ~ Tave04 ,
                            TRUE ~ NA_real_))

#Repeat for climate 2
x$climate2<-"NA"

x<-x %>%
    mutate(climate2 = case_when(
                            frt == "10" ~ as.numeric(mean_PPT05_PPT06_PPT07_PPT08) ,
                            frt == "12" ~ as.numeric(mean_PPT04_PPT05_PPT06),
                            frt == "15" ~ as.numeric(PPT04),
                            TRUE ~ NA_real_))

head(x)

##Change vegtype to factor
x$FWI_veg<-as.factor(x$FWI_veg)
```

# create dummy variables
```{r}
# create dummy variables for FWI_veg

x$veg_C1 <- ifelse(x$FWI_veg == 'C-1', 1, 0)
x$veg_C2 <- ifelse(x$FWI_veg == 'C-2', 1, 0)
x$veg_C3 <- ifelse(x$FWI_veg == 'C-3', 1, 0)
x$veg_C4 <- ifelse(x$FWI_veg == 'C-4', 1, 0)
x$veg_C5 <- ifelse(x$FWI_veg == 'C-5', 1, 0)
x$veg_C7 <- ifelse(x$FWI_veg == 'C-7', 1, 0)
x$veg_D12 <- ifelse(x$FWI_veg == 'D-1/2', 1, 0)
x$veg_M12 <- ifelse(x$FWI_veg == 'M-1/2', 1, 0)
x$veg_M3 <- ifelse(x$FWI_veg == 'M-3', 1, 0)
x$veg_N <- ifelse(x$FWI_veg == 'N', 1, 0)
x$veg_O1ab <- ifelse(x$FWI_veg == 'O-1a/b', 1, 0)
x$veg_S1 <- ifelse(x$FWI_veg == 'S-1', 1, 0)
x$veg_S2 <- ifelse(x$FWI_veg == 'S-2', 1, 0)
x$veg_S3 <- ifelse(x$FWI_veg == 'S-3', 1, 0)
x$veg_W <- ifelse(x$FWI_veg == 'W', 1, 0)

names(x)
table(x$frt, x$FWI_veg)
x$log_dist_roads_m<-log(x$dist_roads_m + 1)
x$log_dist_infrastructure_m<-log(x$dist_infrastructure_m + 1)

```

# remove water, glaciers, lakes stuff that cant burn from points
```{r}
no_ignition1<-x %>% 
  filter(FWI_veg =="W")

spread3<-x %>% 
  filter(FWI_veg !="W")

no_ignition2<-spread3 %>% 
  filter(bclcs_level_5 %in% c("GL", "LA"))

no_ignition<-rbind(no_ignition1, no_ignition2)

spread4<-spread3 %>% 
  filter(!bclcs_level_5 %in% c("GL", "LA"))

dim(no_ignition)
dim(x)
dim(spread4) # looks good

rm(no_ignition1, no_ignition2, spread3)
gc()

```

# FRT 5
```{r}
frt5<- spread4 %>% filter(frt==5)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt5_escape.csv")

model_coef_table

table(frt5$FWI_veg)

frt5$FWI_veg[frt5$FWI_veg=="S-1"]<-"M-1/2"
frt5$FWI_veg[frt5$FWI_veg=="S-2"]<-"M-1/2"
frt5$FWI_veg[frt5$FWI_veg=="C-4"]<-"C-2"
frt5$FWI_veg[frt5$FWI_veg=="C-5"]<-"D-1/2"
frt5$FWI_veg[frt5$FWI_veg=="C-7"]<-"D-1/2"

#remove FWI_veg type = N as there apparently were none in the model. 

frt5_n<-frt5 %>% filter(FWI_veg=="N")
frt5_2<-frt5 %>% filter(FWI_veg!="N")

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt5_2$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt5_2$climate1 +
  model_coef_table[[4]]*frt5_2$veg_C2 +
  model_coef_table[[5]]*frt5_2$veg_C3 +
  model_coef_table[[6]]*frt5_2$veg_D12 +
  model_coef_table[[7]]*frt5_2$veg_M12 +
  model_coef_table[[8]]*frt5_2$veg_O1ab +
  model_coef_table[[9]]*frt5_2$elevation + 
  model_coef_table[[10]]*log(frt5_2$dist_infrastructure_m+1)
  

head(frt5_2)

# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt5_2$prob_ignition<-exp(frt5_2$logit_P)/(1+exp(frt5_2$logit_P))

frt5_n$logit_P<-0
frt5_n$prob_ignition<-0 # make the FWI_veg type =N have a probability of ignition =0

frt5_3<-rbind(frt5_2, frt5_n)

summary(frt5_3$prob_ignition)
hist(frt5_3$prob_ignition)

```

#FRT 7 
```{r}
frt7<- spread4 %>% filter(frt==7)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt7_escape.csv")

model_coef_table

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt7$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt7$climate1 +
  model_coef_table[[4]]*log(frt7$dist_infrastructure_m +1) 

head(frt7)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt7$prob_ignition<-exp(frt7$logit_P)/(1+exp(frt7$logit_P))

summary(frt7$prob_ignition)
hist(frt7$prob_ignition)

```

#FRT 9 
```{r}
frt9<- spread4 %>% filter(frt==9)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt9_escape.csv")

model_coef_table

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt9$logit_P<- model_coef_table[[2]] +
  model_coef_table[[3]]*frt9$climate1 +
  model_coef_table[[4]]*frt9$log_dist_roads_m

head(frt9)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt9$prob_ignition<-exp(frt9$logit_P)/(1+exp(frt9$logit_P))

summary(frt9$prob_ignition)
hist(frt9$prob_ignition)

```

#FRT 10 
```{r}
frt10<- spread4 %>% filter(frt==10)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt10_escape.csv")

model_coef_table


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt10$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt10$climate1 +
  model_coef_table[[4]]*frt10$climate2 +
  model_coef_table[[5]]*frt10$log_dist_roads_m +
  model_coef_table[[6]]*frt10$dist_infrastructure_m 

head(frt10)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt10$prob_ignition<-exp(frt10$logit_P)/(1+exp(frt10$logit_P))

summary(frt10$prob_ignition)
hist(frt10$prob_ignition)

```

#FRT 11 
```{r}
frt11<- spread4 %>% filter(frt==11)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt11_escape.csv")

model_coef_table

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt11$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt11$climate1 +
  model_coef_table[[4]]*frt11$log_dist_roads_m +
  model_coef_table[[5]]*frt11$log_dist_infrastructure_m

head(frt11)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt11$prob_ignition<-exp(frt11$logit_P)/(1+exp(frt11$logit_P))

summary(frt11$prob_ignition)
hist(frt11$prob_ignition)

```

#FRT 12
```{r}
frt12<- spread4 %>% filter(frt==12)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt12_escape.csv")

model_coef_table

table(frt12$FWI_veg)

frt12$FWI_veg[frt12$FWI_veg=="C-4"]<-"C-2"
frt12$FWI_veg[frt12$FWI_veg=="S-1"]<-"M-1/2"
frt12$FWI_veg[frt12$FWI_veg=="S-2"]<-"C-7"
frt12$FWI_veg[frt12$FWI_veg=="S-3"]<-"M-1/2"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt12$logit_P<- model_coef_table[[2]] +
  model_coef_table[[3]]*frt12$climate1 +
  model_coef_table[[4]]*frt12$veg_C2 +
  model_coef_table[[5]]*frt12$veg_C3 +
  model_coef_table[[6]]*frt12$veg_C5 +
  model_coef_table[[7]]*frt12$veg_C7 +
  model_coef_table[[8]]*frt12$veg_D12 +
  model_coef_table[[9]]*frt12$veg_M12 +
  model_coef_table[[10]]*frt12$veg_M3 +
  model_coef_table[[11]]*frt12$veg_N +
  model_coef_table[[12]]*frt12$veg_O1ab +
  model_coef_table[[13]]*frt12$slope +
  model_coef_table[[14]]*frt12$win_sum + 
  model_coef_table[[15]]*frt12$log_dist_roads_m +
  model_coef_table[[16]]*frt12$log_dist_infrastructure_m 

head(frt12)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt12$prob_ignition<-exp(frt12$logit_P)/(1+exp(frt12$logit_P))

summary(frt12$prob_ignition)
hist(frt12$prob_ignition)

```

#FRT 13
```{r}
frt13<- spread4 %>% filter(frt==13)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt13_escape.csv")

model_coef_table

table(frt13$FWI_veg)

frt13$FWI_veg[frt13$FWI_veg=="C-1"]<-"C-7"
frt13$FWI_veg[frt13$FWI_veg=="C-4"]<-"C-2"
frt13$FWI_veg[frt13$FWI_veg=="M-3"]<-"O-1a/b"
frt13$FWI_veg[frt13$FWI_veg=="S-2"]<-"C-7"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt13$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt13$climate1 +
  model_coef_table[[4]]*frt13$veg_C3 +
  model_coef_table[[5]]*frt13$veg_C5 +
  model_coef_table[[6]]*frt13$veg_C7 +
  model_coef_table[[7]]*frt13$veg_D12 +
  model_coef_table[[8]]*frt13$veg_M12 +
  model_coef_table[[9]]*frt13$veg_N +
  model_coef_table[[10]]*frt13$veg_O1ab +
  model_coef_table[[11]]*frt13$veg_S1 +
  model_coef_table[[12]]*frt13$veg_S3 +
  model_coef_table[[13]]*frt13$slope +
  model_coef_table[[14]]*frt13$elevation +
  model_coef_table[[15]]*frt13$win_sum +
  model_coef_table[[16]]*frt13$log_dist_roads_m +
  model_coef_table[[17]]*frt13$log_dist_infrastructure_m 
  

head(frt13)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt13$prob_ignition<-exp(frt13$logit_P)/(1+exp(frt13$logit_P))

summary(frt13$prob_ignition)
hist(frt13$prob_ignition)

```

#FRT 14
```{r}
frt14<- spread4 %>% filter(frt==14)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt14_escape.csv")

model_coef_table

table(frt14$FWI_veg)

frt14$FWI_veg[frt14$FWI_veg=="C-2"]<-"C-3"
frt14$FWI_veg[frt14$FWI_veg=="C-4"]<-"C-3"
frt14$FWI_veg[frt14$FWI_veg=="S-2"]<-"C-7"
frt14$FWI_veg[frt14$FWI_veg=="S-1"]<-"M-1/2"
frt14$FWI_veg[frt14$FWI_veg=="S-3"]<-"M-1/2"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt14$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt14$climate1 +
  model_coef_table[[4]]*frt14$veg_C5 +
  model_coef_table[[5]]*frt14$veg_C7 +
  model_coef_table[[6]]*frt14$veg_D12 +
  model_coef_table[[7]]*frt14$veg_M12 +
  model_coef_table[[8]]*frt14$veg_N +
  model_coef_table[[9]]*frt14$veg_O1ab +
  model_coef_table[[10]]*frt14$win_sum +
  model_coef_table[[11]]*frt14$log_dist_roads_m +
  model_coef_table[[12]]*frt14$log_dist_infrastructure_m
  

head(frt14)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt14$prob_ignition<-exp(frt14$logit_P)/(1+exp(frt14$logit_P))

summary(frt14$prob_ignition)
hist(frt14$prob_ignition)

```

#FRT 15
```{r}
frt15<- spread4 %>% filter(frt==15)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt15_escape.csv")

model_coef_table

table(frt15$FWI_veg)

frt15$FWI_veg[frt15$FWI_veg=="C-2"]<-"C-3"
frt15$FWI_veg[frt15$FWI_veg=="C-7"]<-"C-5"
frt15$FWI_veg[frt15$FWI_veg=="O-1a/b"]<-"C-3"
frt15$FWI_veg[frt15$FWI_veg=="S-1"]<-"S-3"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt15$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt15$climate2 +
  model_coef_table[[4]]*frt15$veg_C5 +
  model_coef_table[[5]]*frt15$veg_D12 +
  model_coef_table[[6]]*frt15$veg_M12 +
  model_coef_table[[7]]*frt15$veg_N +
  model_coef_table[[8]]*frt15$veg_S3 +
  model_coef_table[[9]]*frt15$slope +
  model_coef_table[[10]]*frt15$log_dist_infrastructure_m

head(frt15)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt15$prob_ignition<-exp(frt15$logit_P)/(1+exp(frt15$logit_P))

summary(frt15$prob_ignition)
hist(frt15$prob_ignition)

```


### now combine all FRT's and plot it
```{r}
# reduce the number of columns before I combine the files together. 
names(frt15)

frt5_2<-frt5_3 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt7_2<-frt7 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt9_2<-frt9 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt10_2<-frt10 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt11_2<-frt11 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt12_2<-frt12 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt13_2<-frt13 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt14_2<-frt14 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt15_2<-frt15 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt_all<- rbind(rbind(rbind(rbind(rbind(rbind(rbind(rbind(frt5_2, frt7_2), frt9_2), frt10_2), frt11_2), frt12_2), frt13_2), frt14_2), frt15_2)

dim(frt_all)
hist(frt_all$prob_ignition)

no_ignition$prob_ignition<-0
no_ignition$logit_P<-0

no_ignition_2<-no_ignition %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,  logit_P, prob_ignition)

frt_all2<-rbind(no_ignition_2, frt_all)

dim(frt_all2)
hist(frt_all2$prob_ignition)

# clean up a bunch of files to hopefully speed up saving
rm(frt14, frt14_2, frt5, frt5_2, frt7, frt7_2, frt9, frt9_2, frt10, frt10_2, frt11, frt11_2, frt12, frt12_2, frt13, frt13_2, frt15, frt15_2, no_ignition, no_ignition1, no_ignition2, no_ignition_2, spread3, spread4, climate_variable, directions, directions_raw, x2)

gc()
```

# save the file. 
```{r}
st_write(frt_all2, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\BC_prob_escape_final_2022.gpkg", delete_layer=TRUE, driver="GPKG")


# rasterizing the above file in QGIS:

# go to raster -> Conversion -> Rasterize (Vector to raster)

# then use the shapefile as the input layer, 
# prob ignition as the field to use for burn-in value. 
# output raster size units -> georeferenced units
# resolution = 400m
# note: make sure you use the file rast.bc_bounds as the extent. Its found in postgres kyle clus. If you dont do this the extent will be wrong and the rasterization wont work properly.
# Assign a specified nodata value - make this -9 or some negative number. You need to do this or it will make no data values 0 and then change all actual values to NA so it throws out the actual 0% chance of ignion points.

# I also told it to Pre-initialize the output image with a value of -9. I did this for the same reason as just mentioned above but Im not sure how neccessary this one is. 

# the full commonad should look something like this:

# gdal_rasterize -l BC_prob_escape_final -a prob_ignition -tr 400.0 400.0 -init -9.0 -a_nodata -9.0 -te 159587.5 173787.5 1881187.5 1748187.5 -ot Float32 -of GTiff C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/BC/BC_prob_escape_final.gpkg C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/BC/rast_escape_400m.tif

```

#######################################
#Create spread raster for 2022
#######################################
# change names of columns

```{r}
frt_all2<- frt_all2 %>% rename(prob_escape = prob_ignition,
                               logit_P_escape = logit_P,
                               climate1_escape=climate1,
                               climate2_escape = climate2)
names(frt_all2)
```

# open climate table to see which variables I need for climate1 and climate2
```{r eval=, message=FALSE, AIC table, echo=F}

climate_variable<-read.csv("C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/climate_AIC_results_spread_summary.csv")

kable (climate_variable,
       caption = "<b>Table 1. Top candidate climate variables for lightning caused fires as selected through an AIC analysis for each Fire Regime Type.<b>",
       digits = 2) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)

frt_all2$tot_spring_PPT<-frt_all2$PPT04+ frt_all2$PPT05 + frt_all2$PPT06
frt_all2$spring_Tave<-(frt_all2$Tave04+ frt_all2$Tave05 + frt_all2$Tave06)/3

frt_all2$mean_Tmax05_Tmax06_Tmax07<- (frt_all2$Tmax05+ frt_all2$Tmax06 + frt_all2$Tmax07)/3

frt_all2$mean_Tmax05_Tmax06_Tmax07_Tmax08<- (frt_all2$Tmax05 + frt_all2$Tmax06+ frt_all2$Tmax07 + frt_all2$Tmax08)/4

frt_all2$mean_PPT05_PPT06_PPT07_PPT08<- (frt_all2$PPT05 + frt_all2$PPT06+ frt_all2$PPT07 + frt_all2$PPT08)/4

frt_all2$mean_PPT05_PPT06_PPT07<- (frt_all2$PPT05+ frt_all2$PPT06 + frt_all2$PPT07)/3

frt_all2$mean_Tave05_Tave06_Tave07_Tave08<- (frt_all2$Tave05 + frt_all2$Tave06+ frt_all2$Tave07 + frt_all2$Tave08)/4


## Create empty vector
frt_all2$climate1<-"NA"
head(frt_all2)

frt_all2<-frt_all2 %>%
    mutate(climate1 = case_when(
                            frt == "5" ~ Tave07 ,
                            frt == "7" ~ as.numeric(spring_Tave),
                            frt == "9" ~ spring_Tave,
                            frt == "10" ~ mean_Tmax05_Tmax06_Tmax07_Tmax08 ,
                            frt == "11" ~ as.numeric(RH08),
                            frt == "12" ~ mean_Tmax05_Tmax06_Tmax07_Tmax08,
                            frt == "13" ~ mean_Tave05_Tave06_Tave07_Tave08,
                            frt == "14" ~ mean_Tmax05_Tmax06_Tmax07,
                            frt == "15" ~ Tave05 ,
                            TRUE ~ NA_real_))

#Repeat for climate 2
frt_all2$climate2<-"NA"

frt_all2<-frt_all2 %>%
    mutate(climate2 = case_when(
                            frt == "5" ~ as.numeric(PPT07),
                            frt == "7" ~ as.numeric(tot_spring_PPT),
                            frt == "9" ~ as.numeric(tot_spring_PPT),
                            frt == "10" ~ as.numeric(mean_PPT05_PPT06_PPT07_PPT08) ,
                            frt == "11" ~ as.numeric(PPT08),
                            frt == "12" ~ as.numeric(mean_PPT05_PPT06_PPT07_PPT08),
                            frt == "13" ~ as.numeric(mean_PPT05_PPT06_PPT07_PPT08),
                            frt == "14" ~ as.numeric(mean_PPT05_PPT06_PPT07),
                            frt == "15" ~ as.numeric(PPT05),
                            TRUE ~ NA_real_))
head(frt_all2)

##Change vegtype to factor
frt_all2$FWI_veg<-as.factor(frt_all2$FWI_veg)

#create new column
frt_all2$fire_veg<-paste(frt_all2$fire, frt_all2$FWI_veg)

```

#Change Aspect to N,S,E,W
```{r}
library(rvest)
library(tidyverse)

url <- 'http://snowfence.umn.edu/Components/winddirectionanddegreeswithouttable3.htm'
page <- read_html(url)
directions_raw <- page %>% html_node('td table') %>% html_table(header = TRUE)

directions <- directions_raw %>% 
    set_names(~tolower(sub(' Direction', '', .x))) %>% 
    slice(-1) %>% 
    separate(degree, c('degree_min', 'degree_max'), sep = '\\s+-\\s+', convert = TRUE)

directions

frt_all2 <- frt_all2 %>% 
    mutate(aspect_cardinal = cut(
        aspect, 
        breaks = c(0, directions$degree_max, 360), 
        labels = c(directions$cardinal, 'N')
    ))

frt_all2$aspect_cardinal2<-0
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="N"]<-"N"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="E"]<-"E"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="S"]<-"S"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="W"]<-"W"

frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="NNE"]<-"N"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="NNW"]<-"N"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="NE" & frt_all2$aspect<=45]<-"N"

frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="NE" & frt_all2$aspect>45]<-"E"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="ENE"]<-"E"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="ESE"]<-"E"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="SE" & frt_all2$aspect<=135]<-"E"

frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="SE" & frt_all2$aspect>135]<-"S"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="SSE"]<-"S"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="SSW"]<-"S"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="SW" & frt_all2$aspect<=225]<-"S"

frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="SW" & frt_all2$aspect>225]<-"W"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="WSW"]<-"W"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="WNW"]<-"W"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="NW" & frt_all2$aspect<=315]<-"W"
frt_all2$aspect_cardinal2[frt_all2$aspect_cardinal=="NW" & frt_all2$aspect>315]<-"N"

table(frt_all2$aspect_cardinal2)
 frt_all2[frt_all2$aspect_cardinal2=="0",]
 frt_all3<-frt_all2 %>% drop_na(aspect_cardinal)
```

```{r}
# create dummy variables for FWI_veg

frt_all3$veg_C1 <- ifelse(frt_all3$FWI_veg == 'C-1', 1, 0)
frt_all3$veg_C2 <- ifelse(frt_all3$FWI_veg == 'C-2', 1, 0)
frt_all3$veg_C3 <- ifelse(frt_all3$FWI_veg == 'C-3', 1, 0)
frt_all3$veg_C4 <- ifelse(frt_all3$FWI_veg == 'C-4', 1, 0)
frt_all3$veg_C5 <- ifelse(frt_all3$FWI_veg == 'C-5', 1, 0)
frt_all3$veg_C7 <- ifelse(frt_all3$FWI_veg == 'C-7', 1, 0)
frt_all3$veg_D12 <- ifelse(frt_all3$FWI_veg == 'D-1/2', 1, 0)
frt_all3$veg_M12 <- ifelse(frt_all3$FWI_veg == 'M-1/2', 1, 0)
frt_all3$veg_M3 <- ifelse(frt_all3$FWI_veg == 'M-3', 1, 0)
frt_all3$veg_N <- ifelse(frt_all3$FWI_veg == 'N', 1, 0)
frt_all3$veg_O1ab <- ifelse(frt_all3$FWI_veg == 'O-1a/b', 1, 0)
frt_all3$veg_S1 <- ifelse(frt_all3$FWI_veg == 'S-1', 1, 0)
frt_all3$veg_S2 <- ifelse(frt_all3$FWI_veg == 'S-2', 1, 0)
frt_all3$veg_S3 <- ifelse(frt_all3$FWI_veg == 'S-3', 1, 0)
frt_all3$veg_W <- ifelse(frt_all3$FWI_veg == 'W', 1, 0)

names(frt_all3)
table(frt_all3$frt, frt_all3$FWI_veg)
frt_all3$log_dist_roads_m<-log(frt_all3$dist_roads_m + 1)
frt_all3$log_dist_infrastructure_m<-log(frt_all3$dist_infrastructure_m + 1)

# create dummy variables for aspect
frt_all3$aspect_N <- ifelse(frt_all3$aspect_cardinal2 == 'N', 1, 0)
frt_all3$aspect_E <- ifelse(frt_all3$aspect_cardinal2 == 'E', 1, 0)
frt_all3$aspect_S <- ifelse(frt_all3$aspect_cardinal2 == 'S', 1, 0)
frt_all3$aspect_W <- ifelse(frt_all3$aspect_cardinal2 == 'W', 1, 0)

```

# remove water, glaciers, lakes stuff that cant burn from points
```{r}
no_ignition1<-frt_all3 %>% 
  filter(FWI_veg =="W")

spread3<-frt_all3 %>% 
  filter(FWI_veg !="W")

no_ignition2<-spread3 %>% 
  filter(bclcs_level_5 %in% c("GL", "LA"))

no_ignition<-rbind(no_ignition1, no_ignition2)

spread4<-spread3 %>% 
  filter(!bclcs_level_5 %in% c("GL", "LA"))

dim(no_ignition)
dim(frt_all3)
dim(spread4) # looks good


```


# FRT 5

```{r}
frt5<- spread4 %>% filter(frt==5)

model_coef_table<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt5_spread.csv")

model_coef_table

table(frt5$FWI_veg)

frt5$FWI_veg[frt5$FWI_veg=="S-1"]<-"M-1/2"
frt5$FWI_veg[frt5$FWI_veg=="C-4"]<-"C-2"



# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt5$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt5$Latitude +
  model_coef_table[[4]]*frt5$Longitude +
  model_coef_table[[5]]*frt5$climate2 +
  model_coef_table[[6]]*frt5$elevation +
  model_coef_table[[7]]*frt5$aspect_N +
  model_coef_table[[8]]*frt5$aspect_S +
  model_coef_table[[9]]*frt5$aspect_W +
  model_coef_table[[10]]*frt5$veg_C2 +
  model_coef_table[[11]]*frt5$veg_C3 +
  model_coef_table[[12]]*frt5$veg_C5 +
  model_coef_table[[13]]*frt5$veg_C7 +
  model_coef_table[[14]]*frt5$veg_D12 +
  model_coef_table[[15]]*frt5$veg_M12 +
  model_coef_table[[16]]*frt5$veg_M3 +
  model_coef_table[[17]]*frt5$veg_N +
  model_coef_table[[18]]*frt5$veg_O1ab +
  model_coef_table[[19]]*frt5$veg_S2 + 
  model_coef_table[[20]]*frt5$dist_roads_m +
  model_coef_table[[21]]*frt5$dist_infrastructure_m +
  model_coef_table[[22]]*frt5$win_spr
  

head(frt5)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt5$prob_ignition<-exp(frt5$logit_P)/(1+exp(frt5$logit_P))

summary(frt5$prob_ignition)
hist(frt5$prob_ignition)

```

#FRT 7 
```{r}
frt7<- spread4 %>% filter(frt==7)

model_coef_table<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt7_spread.csv")

model_coef_table

table(frt7$FWI_veg)
frt7$FWI_veg[frt7$FWI_veg=="C-5"]<-"C-7"
frt7$FWI_veg[frt7$FWI_veg=="M-3"]<-"O-1a/b"


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt7$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt7$Latitude +
  model_coef_table[[4]]*frt7$Longitude +
  model_coef_table[[5]]*frt7$climate1 +
  model_coef_table[[6]]*frt7$climate2 +
  model_coef_table[[7]]*frt7$elevation +
  model_coef_table[[8]]*frt7$aspect_N +
  model_coef_table[[9]]*frt7$aspect_S +
  model_coef_table[[10]]*frt7$aspect_W +
  model_coef_table[[11]]*frt7$veg_C2 +
  model_coef_table[[12]]*frt7$veg_C3 +
  model_coef_table[[13]]*frt7$veg_C4 +
  model_coef_table[[14]]*frt7$veg_C7 +
  model_coef_table[[15]]*frt7$veg_D12 +
  model_coef_table[[16]]*frt7$veg_M12 +
  model_coef_table[[17]]*frt7$veg_N +
  model_coef_table[[18]]*frt7$veg_O1ab +
  model_coef_table[[19]]*frt7$veg_S1 +
  model_coef_table[[20]]*frt7$veg_S2 + 
  model_coef_table[[21]]*frt7$log_dist_roads_m +
  model_coef_table[[22]]*frt7$dist_infrastructure_m +
  model_coef_table[[23]]*frt7$win_spr

head(frt7)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt7$prob_ignition<-exp(frt7$logit_P)/(1+exp(frt7$logit_P))

summary(frt7$prob_ignition)
hist(frt7$prob_ignition)

```

#FRT 9 
```{r}
frt9<- spread4 %>% filter(frt==9)

model_coef_table<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt9_spread.csv")

model_coef_table

table(frt9$FWI_veg)

frt9$FWI_veg[frt9$FWI_veg=="C-5"]<-"C-7"
frt9$FWI_veg[frt9$FWI_veg=="C-4"]<-"C-2"
frt9$FWI_veg[frt9$FWI_veg=="S-1"]<-"M-1/2"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt9$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt9$Latitude +
  model_coef_table[[4]]*frt9$Longitude +
  model_coef_table[[5]]*frt9$climate1 +
  model_coef_table[[6]]*frt9$climate2 +
  model_coef_table[[7]]*frt9$aspect_N +
  model_coef_table[[8]]*frt9$aspect_S +
  model_coef_table[[9]]*frt9$aspect_W +
  model_coef_table[[10]]*frt9$veg_C2 +
  model_coef_table[[11]]*frt9$veg_C3 +
  model_coef_table[[12]]*frt9$veg_C7 +
  model_coef_table[[13]]*frt9$veg_D12 +
  model_coef_table[[14]]*frt9$veg_M12 +
  model_coef_table[[15]]*frt9$veg_N +
  model_coef_table[[16]]*frt9$veg_O1ab +
  model_coef_table[[17]]*frt9$log_dist_roads_m

head(frt9)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt9$prob_ignition<-exp(frt9$logit_P)/(1+exp(frt9$logit_P))

summary(frt9$prob_ignition)
hist(frt9$prob_ignition)

```

#FRT 10 
```{r}
frt10<- spread4 %>% filter(frt==10)

model_coef_table<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt10_spread.csv")

model_coef_table

table(frt10$FWI_veg)
frt10$FWI_veg[frt10$FWI_veg=="C-4"]<-"C-2"
frt10$FWI_veg[frt10$FWI_veg=="S-2"]<-"C-7"
frt10$FWI_veg[frt10$FWI_veg=="M-3"]<-"O-1a/b"


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt10$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt10$Latitude +
  model_coef_table[[4]]*frt10$Longitude +
  model_coef_table[[5]]*frt10$climate1 +
  model_coef_table[[6]]*frt10$climate2 +
  model_coef_table[[7]]*frt10$aspect_N +
  model_coef_table[[8]]*frt10$aspect_S +
  model_coef_table[[9]]*frt10$aspect_W +
  model_coef_table[[10]]*frt10$veg_C2 +
  model_coef_table[[11]]*frt10$veg_C3 +
  model_coef_table[[12]]*frt10$veg_C5 +
  model_coef_table[[13]]*frt10$veg_C7 +
  model_coef_table[[14]]*frt10$veg_D12 +
  model_coef_table[[15]]*frt10$veg_M12 +
  model_coef_table[[16]]*frt10$veg_N +
  model_coef_table[[17]]*frt10$veg_O1ab +
  model_coef_table[[18]]*frt10$veg_S1 + 
  model_coef_table[[19]]*frt10$dist_roads_m +
  model_coef_table[[20]]*frt10$dist_infrastructure_m +
  model_coef_table[[21]]*frt10$win_spr

head(frt10)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt10$prob_ignition<-exp(frt10$logit_P)/(1+exp(frt10$logit_P))

summary(frt10$prob_ignition)
hist(frt10$prob_ignition)

```

#FRT 11 
```{r}
frt11<- spread4 %>% filter(frt==11)

model_coef_table<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt11_spread.csv")

model_coef_table

table(frt11$FWI_veg)

frt11$FWI_veg[frt11$FWI_veg=="S-2"]<-"C-7"
frt11$FWI_veg[frt11$FWI_veg=="S-1"]<-"M-1/2"
frt11$FWI_veg[frt11$FWI_veg=="S-3"]<-"M-1/2"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt11$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt11$Longitude +
  model_coef_table[[4]]*frt11$climate1 +
  model_coef_table[[5]]*frt11$climate2 +
  model_coef_table[[6]]*frt11$elevation +
  model_coef_table[[7]]*frt11$aspect_N +
  model_coef_table[[8]]*frt11$aspect_S +
  model_coef_table[[9]]*frt11$aspect_W +
  model_coef_table[[10]]*frt11$veg_C2 +
  model_coef_table[[11]]*frt11$veg_C3 +
  model_coef_table[[12]]*frt11$veg_C5 +
  model_coef_table[[13]]*frt11$veg_C7 +
  model_coef_table[[14]]*frt11$veg_D12 +
  model_coef_table[[15]]*frt11$veg_M12 +
  model_coef_table[[16]]*frt11$veg_N +
  model_coef_table[[17]]*frt11$veg_O1ab +
  model_coef_table[[18]]*frt11$dist_roads_m +
  model_coef_table[[19]]*frt11$win_spr

head(frt11)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt11$prob_ignition<-exp(frt11$logit_P)/(1+exp(frt11$logit_P))

summary(frt11$prob_ignition)
hist(frt11$prob_ignition)

```

#FRT 12
```{r}
frt12<- spread4 %>% filter(frt==12)

model_coef_table<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt12_spread.csv")

model_coef_table

table(frt12$FWI_veg)

frt12$FWI_veg[frt12$FWI_veg=="S-3"]<-"M-1/2"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt12$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt12$Latitude +
  model_coef_table[[4]]*frt12$Longitude +
  model_coef_table[[5]]*frt12$climate1 +
  model_coef_table[[6]]*frt12$climate2 +
  model_coef_table[[7]]*frt12$elevation +
  model_coef_table[[8]]*frt12$aspect_N +
  model_coef_table[[9]]*frt12$aspect_S +
  model_coef_table[[10]]*frt12$aspect_W +
  model_coef_table[[11]]*frt12$veg_C2 +
  model_coef_table[[12]]*frt12$veg_C3 +
  model_coef_table[[13]]*frt12$veg_C4 +
  model_coef_table[[14]]*frt12$veg_C5 +
  model_coef_table[[15]]*frt12$veg_C7 +
  model_coef_table[[16]]*frt12$veg_D12 +
  model_coef_table[[17]]*frt12$veg_M12 +
  model_coef_table[[18]]*frt12$veg_M3 +
  model_coef_table[[19]]*frt12$veg_N +
  model_coef_table[[20]]*frt12$veg_O1ab +
  model_coef_table[[21]]*frt12$veg_S1 +
  model_coef_table[[22]]*frt12$veg_S2 +
  model_coef_table[[23]]*frt12$log_dist_roads_m +
  model_coef_table[[24]]*frt12$log_dist_infrastructure_m +
  model_coef_table[[25]]*frt12$win_spr

head(frt12)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt12$prob_ignition<-exp(frt12$logit_P)/(1+exp(frt12$logit_P))

summary(frt12$prob_ignition)
hist(frt12$prob_ignition)

```

#FRT 13
```{r}
frt13<- spread4 %>% filter(frt==13)

model_coef_table<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt13_spread.csv")

model_coef_table

table(frt13$FWI_veg)

frt13$FWI_veg[frt13$FWI_veg=="C-1"]<-"C-7"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt13$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt13$Latitude +
  model_coef_table[[4]]*frt13$Longitude +
  model_coef_table[[5]]*frt13$climate2 +
  model_coef_table[[6]]*frt13$elevation +
  model_coef_table[[7]]*frt13$aspect_N +
  model_coef_table[[8]]*frt13$aspect_S +
  model_coef_table[[9]]*frt13$aspect_W +
  model_coef_table[[10]]*frt13$veg_C3 +
  model_coef_table[[11]]*frt13$veg_C4 +
  model_coef_table[[12]]*frt13$veg_C5 +
  model_coef_table[[13]]*frt13$veg_C7 +
  model_coef_table[[14]]*frt13$veg_D12 +
  model_coef_table[[15]]*frt13$veg_M12 +
  model_coef_table[[16]]*frt13$veg_M3 +
  model_coef_table[[17]]*frt13$veg_N +
  model_coef_table[[18]]*frt13$veg_O1ab +
  model_coef_table[[19]]*frt13$veg_S1 +
  model_coef_table[[20]]*frt13$veg_S2 +
  model_coef_table[[21]]*frt13$veg_S3 +
  model_coef_table[[22]]*frt13$log_dist_roads_m +
  model_coef_table[[23]]*frt13$log_dist_infrastructure_m +
  model_coef_table[[24]]*frt13$win_sum

head(frt13)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt13$prob_ignition<-exp(frt13$logit_P)/(1+exp(frt13$logit_P))

summary(frt13$prob_ignition)
hist(frt13$prob_ignition)

```

#FRT 14
```{r}
frt14<- spread4 %>% filter(frt==14)

model_coef_table<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt14_spread.csv")

model_coef_table

table(frt14$FWI_veg)

frt14$FWI_veg[frt14$FWI_veg=="C-4"]<-"C-2"
frt14$FWI_veg[frt14$FWI_veg=="S-2"]<-"C-7"
frt14$FWI_veg[frt14$FWI_veg=="S-3"]<-"M-1/2"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt14$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt14$Latitude +
  model_coef_table[[4]]*frt14$climate2 +
  model_coef_table[[5]]*frt14$elevation +
  model_coef_table[[6]]*frt14$aspect_N +
  model_coef_table[[7]]*frt14$aspect_S +
  model_coef_table[[8]]*frt14$aspect_W +
  model_coef_table[[9]]*frt14$veg_C3 +
  model_coef_table[[10]]*frt14$veg_C5 +
  model_coef_table[[11]]*frt14$veg_C7 +
  model_coef_table[[12]]*frt14$veg_D12 +
  model_coef_table[[13]]*frt14$veg_M12 +
  model_coef_table[[14]]*frt14$veg_M3 +
  model_coef_table[[15]]*frt14$veg_N +
  model_coef_table[[16]]*frt14$veg_O1ab +
  model_coef_table[[17]]*frt14$veg_S1 +
  model_coef_table[[18]]*frt14$log_dist_roads_m +
  model_coef_table[[19]]*frt14$log_dist_infrastructure_m +
  model_coef_table[[20]]*frt14$win_sum

head(frt14)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt14$prob_ignition<-exp(frt14$logit_P)/(1+exp(frt14$logit_P))

summary(frt14$prob_ignition)
hist(frt14$prob_ignition)

```

#FRT 15
```{r}
frt15<- spread4 %>% filter(frt==15)

model_coef_table<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt15_spread.csv")

model_coef_table

table(frt15$FWI_veg)

frt15$FWI_veg[frt15$FWI_veg=="C-2"]<-"C-3"
frt15$FWI_veg[frt15$FWI_veg=="M-3"]<-"O-1a/b"

# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt15$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt15$climate2 +
  model_coef_table[[4]]*frt15$elevation +
  model_coef_table[[5]]*frt15$aspect_N +
  model_coef_table[[6]]*frt15$aspect_S +
  model_coef_table[[7]]*frt15$aspect_W +
  model_coef_table[[8]]*frt15$veg_C5 +
  model_coef_table[[9]]*frt15$veg_C7 +
  model_coef_table[[10]]*frt15$veg_D12 +
  model_coef_table[[11]]*frt15$veg_M12 +
  model_coef_table[[12]]*frt15$veg_N +
  model_coef_table[[13]]*frt15$veg_O1ab +
  model_coef_table[[14]]*frt15$veg_S1 +
  model_coef_table[[15]]*frt15$veg_S3 +
  model_coef_table[[16]]*frt15$log_dist_infrastructure_m +
  model_coef_table[[17]]*frt15$win_sum

head(frt15)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt15$prob_ignition<-exp(frt15$logit_P)/(1+exp(frt15$logit_P))

summary(frt15$prob_ignition)
hist(frt15$prob_ignition)

```


### now combine all FRT's and plot it
```{r}
# reduce the number of columns before I combine the files together. 
frt5_2<-frt5 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt7_2<-frt7 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt9_2<-frt9 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt10_2<-frt10 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt11_2<-frt11 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt12_2<-frt12 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt13_2<-frt13 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt14_2<-frt14 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt15_2<-frt15 %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt_all<- rbind(rbind(rbind(rbind(rbind(rbind(rbind(rbind(frt5_2, frt7_2), frt9_2), frt10_2), frt11_2), frt12_2), frt13_2), frt14_2), frt15_2)

dim(frt_all)
hist(frt_all$prob_ignition)

no_ignition$prob_ignition<-0
no_ignition$logit_P<-0

no_ignition_2<-no_ignition %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5, FWI_veg: dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1_escape:prob_escape, climate1, climate2, aspect_cardinal2,  logit_P, prob_ignition)

frt_all2<-rbind(no_ignition_2, frt_all)

dim(frt_all2)
hist(frt_all2$prob_ignition)
```


```{r}
# clean up a bunch of files to hopefully speed up saving
rm(frt_14, frt14_2, frt5, frt5_2, frt7, frt7_2, frt9, frt9_2, frt10, frt10_2, frt11, frt11_2, frt12, frt12_2, frt13, frt13_2, frt15, frt15_2, no_ignition, no_ignition1, no_ignition2, no_ignition_2, spread3, spread4, climate_variable, directions, directions_raw, frt_all32)

gc()

frt_all2 <- frt_all2 %>% rename (climate1_spread = climate1,
                                 climate2_spread = climate2,
                                 logit_P_spread = logit_P,
                                 prob_spread = prob_ignition)
```

# save the file. 
```{r}
st_write(frt_all2, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\BC_prob_escape_and_spread_final_2022.gpkg", delete_layer=TRUE, driver="GPKG")


# rasterizing the above file in QGIS:

# go to raster -> Conversion -> Rasterize (Vector to raster)

# then use the shapefile as the input layer, 
# prob ignition as the field to use for burn-in value. 
# output raster size units -> georeferenced units
# resolution = 400m
# note: make sure you use the file rast.bc_bounds as the extent. Its found in postgres kyle clus. If you dont do this the extent will be wrong and the rasterization wont work properly.
# Assign a specified nodata value - make this -9 or some negative number. You need to do this or it will make no data values 0 and then change all actual values to NA so it throws out the actual 0% chance of ignion points.

# I also told it to Pre-initialize the output image with a value of -9. I did this for the same reason as just mentioned above but Im not sure how neccessary this one is. 

# the full commonad should look something like this:

# gdal_rasterize -l BC_prob_escape_final -a prob_ignition -tr 400.0 400.0 -init -9.0 -a_nodata -9.0 -te 159587.5 173787.5 1881187.5 1748187.5 -ot Float32 -of GTiff C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/BC/BC_prob_escape_final.gpkg C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/BC/rast_escape_400m.tif

```



#### IMPORT ESCAPE AND SPREAD RASTERS
```{r}
escape.ras<-raster("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\rast_escape_2022.tif")
spread.ras<-raster("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\rast_spread_2022.tif")

crs(spread.ras)
crs(escape.ras)
raster::crs(spread.ras) <- "EPSG:3005"
raster::crs(escape.ras) <- "EPSG:3005"

# replacing NA's by zero
escape.ras[is.na(escape.ras[])] <- 0 
spread.ras[is.na(spread.ras[])] <- 0 

#get provincial boundary for clipping the layers to the area of interest
prov.bnd <- st_read ( dsn = "T:\\FOR\\VIC\\HTS\\ANA\\PROJECTS\\CASTOR\\Data\\admin_boundaries\\province\\gpr_000b11a_e.shp", stringsAsFactors = T) # Read simple features from file or database, or retrieve layer names and their geometry type(s)
st_crs(prov.bnd) #Retrieve coordinate reference system from sf or sfc object
prov.bnd <- prov.bnd [prov.bnd$PRENAME == "British Columbia", ] 
crs(prov.bnd)# this one needs to be transformed to 3005
bc.bnd <- st_transform (prov.bnd, 3005) #Transform coordinate system
st_crs(bc.bnd)

bc.bnd<-sf::st_as_sf(bc.bnd) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(bc.bnd))
r3 <- mask(r2, bc.bnd)
escape.ras<-r3
plot(escape.ras)


rm(r2, r3)

```


# Predict RSF values and reclassify pixels into ordinal classes or rank bins of a specified number
```{r}
x<- as.data.frame(escape.ras)
hist(x$rast_escape_2022)

bins<-quantile(x$rast_escape_2022, probs = seq(0, 1, 1/10), na.rm=TRUE)

# 
# y<-x %>% mutate(x_bin = ntile(layer, n=10))
# table(y$x_bin)

y_alt<-x %>% mutate(x_bin = cut(rast_escape_2022, breaks=10))
#y_alt2<-x%>% mutate(x_bin = cut(layer, breaks =c(0, 0.1269326, 0.1959398, 0.2403519, 0.2758387, 0.3081048, 0.3397820, 0.3772622, 0.4259310, 0.4935676, 1.0))) # This method uses the quantiles identified above.

table(y_alt$x_bin)

y <- y_alt %>% drop_na()
plot(y$x_bin)


y2<-as.data.frame(table(y$x_bin))

# determine midpoints of each bin

w_1<-0.0941/2
w_2<-(0.0941+(0.188-0.0941)/2)
w_3<-(0.188+ (0.282-0.188)/2)
w_4<-0.282 + (0.376-0.282)/2
w_5<-0.376 + (0.47-0.376)/2
w_6<-0.47 + (0.564-0.47)/2
w_7<-0.564 + (0.658-0.564)/2
w_8<-0.658 + (0.752-0.658)/2
w_9<-0.752 + (0.847-0.752)/2
w_10<-0.847 + (0.942-0.847)/2

y2$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2$wi_Ai<- y2$midpoint * y2$Freq
y2$Ui<- y2$wi_Ai/sum(y2$wi_Ai)
y2<- y2 %>% rename(bins=Var1,
                   Area = Freq)
plot(y2$bins, y2$Area)
plot(y2$bins, y2$Ui)
```

## Getting data from an independent data set
# 6.) Count the number of used observations from an independent data set that fall in each RSF bin. 

For this I will extract the probability of ignition points from my fire map at each of the points

```{r ignitions}

ignit<-try(
  bcdc_query_geodata("WHSE_LAND_AND_NATURAL_RESOURCE.PROT_CURRENT_FIRE_PNTS_SP") %>%    
    filter(FIRE_TYPE == "Fire") %>%
    collect()
)

ignit2<-try(
  bcdc_query_geodata("WHSE_LAND_AND_NATURAL_RESOURCE.PROT_HISTORICAL_INCIDENTS_SP") %>%
    filter(FIRE_YEAR > 2019) %>%
    filter(FIRE_TYPE == "Fire") %>%
    collect()
)

names(ignit)
names(ignit2)

ignit<- ignit %>% select(id:IGNITION_DATE, FIRE_CAUSE, FIRE_TYPE, CURRENT_SIZE, geometry)
ignit2<- ignit2 %>% select(id:IGNITION_DATE, FIRE_CAUSE, FIRE_TYPE, CURRENT_SIZE, geometry)

ignit3<-rbind(ignit, ignit2)

# first join the ignition points to frt so that I can see whether different frt react differently i.e. whether some are better than others.
frt <- st_read ( dsn = "D:\\Fire\\fire_data\\Fire_Regime_Types\\FRT\\FRT_Canada.shp", stringsAsFactors = T) # Read simple features from file or person_22aabase, or retrieve layer names and their geometry type(s)
st_crs(frt) #Retrieve coordinate reference system from sf or sfc object
frt<-st_transform(frt, 3005) #transform coordinate system to 3005 - that for BC, Canada

#get provincial boundary for clipping the layers to the area of interest
prov.bnd <- st_read ( dsn = "T:\\FOR\\VIC\\HTS\\ANA\\PROJECTS\\CASTOR\\Data\\admin_boundaries\\province\\gpr_000b11a_e.shp", stringsAsFactors = T) # Read simple features from file or database, or retrieve layer names and their geometry type(s)
st_crs(prov.bnd) #Retrieve coordinate reference system from sf or sfc object
prov.bnd <- prov.bnd [prov.bnd$PRENAME == "British Columbia", ] 
crs(prov.bnd)# this one needs to be transformed to 3005
bc.bnd <- st_transform (prov.bnd, 3005) #Transform coordinate system
st_crs(bc.bnd)

#Clip FRT here
frt_clipped<-st_intersection(bc.bnd, frt)
#plot(st_geometry(frt_clipped), col=sf.colors(10,categorical=TRUE))
length(unique(frt_clipped$Cluster))
frt_sf<-st_as_sf(frt_clipped)

fire.ignt.frt <- st_join(ignit3, frt_clipped)
table(fire.ignt.frt$Cluster)
table(is.na(fire.ignt.frt$Cluster))

# change any ignition points in FRT =3 to frt=5
fire.ignt.frt$Cluster[fire.ignt.frt$Cluster ==3] <- 5

#######
## Of the fires that ignited how many escaped?
fire.escape<-fire.ignt.frt %>%
  mutate(escaped = case_when(CURRENT_SIZE > 10 ~ 1,
                           CURRENT_SIZE <= 10 ~ 0))

#####
# plotting points on raster to check they are still correct
escape_pts <- rasterToPoints(escape.ras, spatial = TRUE)
# Then to a 'conventional' dataframe
escape_pts_df  <- data.frame(escape_pts)

ggplot() +
 geom_raster(data = escape_pts_df , aes(x = x, y = y, fill = rast_escape_2022)) +
  geom_sf(data=fire.escape, aes(color = as.factor(escaped)))

```

# now extract the probability of ignition from the raster at each ignition point.
```{r}
fire.ignt.frt2 <- fire.ignt.frt %>%
  dplyr::select("id", "FIRE_NUMBER", "FIRE_YEAR", "IGNITION_DATE", "FIRE_CAUSE",
                #"LATITUDE", "LONGITUDE",
                "CURRENT_SIZE", "Cluster","geometry")

test<-cbind(fire.ignt.frt2, st_coordinates(fire.ignt.frt2))
head(test)
table(test$FIRE_YEAR)

pointCoordinates<-data.frame(test$X, test$Y)
head(pointCoordinates)
#crs(pointCoordinates) #No CRS when a dataframe

##Extract DEM values from stacked layer
rasValue2=raster::extract(escape.ras, pointCoordinates)
head(rasValue2)
str(rasValue2) #200298 values
str(fire.ignt.frt2)#200298 values

#Append new information
fire.ignt.frt3<-cbind(fire.ignt.frt2, rasValue2)
head(fire.ignt.frt3)

escaped_pts<-fire.ignt.frt3 %>% filter(CURRENT_SIZE>10
                                       , FIRE_YEAR==2022
                                       )

escaped_pts<-escaped_pts %>% mutate(points_bin = cut(rasValue2, breaks=c(-0.01, 0.0941, 0.188, 0.282, 0.376, 0.47, 0.564, 0.658, 0.752, 0.847, 0.942)))
table(escaped_pts$points_bin, escaped_pts$Cluster)
table(escaped_pts$Cluster)

y3<-as.data.frame(table(escaped_pts$points_bin))
y2$used_obs<-y3$Freq

plot(y2$bins, y2$used_obs)

y2$expected_no_obs<-sum(y2$used_obs)*y2$Ui

ggplot(data=y2) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2$prop_used<-y2$used_obs/(sum(y2$used_obs))
y2$prop_expected<-y2$expected_no_obs/(sum(y2$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2)
summary(relationship.fit)
confint(relationship.fit) # The confidence interval overlaps 0 and the slope overlaps 1. I assume there is no statistical difference from what I would expect

Xsq<-chisq.test(y2$used_obs, p=y2$prop_expected, simulate.p.value = TRUE)  
Xsq

p_bc <- ggplot(data=y2, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, linewidth = 0.5)

p_bc

# looks like intercept  is close to zero and slope is not different to 1 but its also not different to zero. 
```


# FRT 5
```{r}

# first work out proportion of habitat types across the landscape
frt5<-frt_clipped %>% filter(Cluster %in% c(3,5))
frt5<-sf::st_as_sf(frt5) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(frt5))
r3 <- mask(r2, frt5)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(rast_escape_2022, breaks=c(-0.01, 0.0941, 0.188, 0.282, 0.376, 0.47, 0.564, 0.658, 0.752, 0.847, 0.942)))
table(x2$points_bin)

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt5<-as.data.frame(table(y$points_bin))

y2_frt5$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt5$wi_Ai<- y2_frt5$midpoint * y2_frt5$Freq
y2_frt5$Ui<- y2_frt5$wi_Ai/sum(y2_frt5$wi_Ai)
y2_frt5<- y2_frt5 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in FRT5
## Start here!

frt5_escape<-escaped_pts %>% filter(Cluster==5)

y3_frt5<-as.data.frame(table(frt5_escape$points_bin))
y2_frt5$used_obs<-y3_frt5$Freq

y2_frt5$expected_no_obs<-sum(y2_frt5$used_obs)*y2_frt5$Ui

ggplot(data=y2_frt5) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt5$prop_used<-y2_frt5$used_obs/(sum(y2_frt5$used_obs))
y2_frt5$prop_expected<-y2_frt5$expected_no_obs/(sum(y2_frt5$expected_no_obs))

relationship.fit<-lm(prop_used ~ prop_expected, data=y2_frt5)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt5 <- ggplot(data=y2_frt5, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt5

Xsq<-chisq.test(y2_frt5$used_obs, p=y2_frt5$prop_expected, simulate.p.value = TRUE)  
Xsq


my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is not different to zero and slope is not different than 1. GOOD
```

# FRT 7
```{r}

########
#NOte: This data and test for this FRT is not great because I only have 3 escaped points for the whole area. Not enough data to test this with, I would say.

# first work out proportion of habitat types across the landscape
frt7<-frt_clipped %>% filter(Cluster ==7)
frt7<-sf::st_as_sf(frt7) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(frt7))
r3 <- mask(r2, frt7)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(rast_escape_2022, breaks=c(-0.01, 0.0941, 0.188, 0.282, 0.376, 0.47, 0.564, 0.658, 0.752, 0.847, 0.942)))
table(x2$points_bin)

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt7<-as.data.frame(table(y$points_bin))

y2_frt7$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt7$wi_Ai<- y2_frt7$midpoint * y2_frt7$Freq
y2_frt7$Ui<- y2_frt7$wi_Ai/sum(y2_frt7$wi_Ai)
y2_frt7<- y2_frt7 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in FRT7
## Start here!

frt7_escape<-escaped_pts %>% filter(Cluster==7)

y3_frt7<-as.data.frame(table(frt7_escape$points_bin))
y2_frt7$used_obs<-y3_frt7$Freq

y2_frt7$expected_no_obs<-sum(y2_frt7$used_obs)*y2_frt7$Ui

ggplot(data=y2_frt7) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt7$prop_used<-y2_frt7$used_obs/(sum(y2_frt7$used_obs))
y2_frt7$prop_expected<-y2_frt7$expected_no_obs/(sum(y2_frt7$expected_no_obs))

relationship.fit<-lm(prop_used ~ prop_expected, data=y2_frt7)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt7 <- ggplot(data=y2_frt7, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt7

Xsq<-chisq.test(y2_frt7$used_obs, p=y2_frt7$prop_expected, simulate.p.value = TRUE)  
Xsq


my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is not different to zero and slope is not different than 1. GOOD
```

# FRT 9
```{r}

# first work out proportion of habitat types across the landscape
frt9<-frt_clipped %>% filter(Cluster == 9)
frt9<-sf::st_as_sf(frt9) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(frt9))
r3 <- mask(r2, frt9)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(rast_escape_2022, breaks=c(-0.01, 0.0941, 0.188, 0.282, 0.376, 0.47, 0.564, 0.658, 0.752, 0.847, 0.942)))
table(x2$points_bin)

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt9<-as.data.frame(table(y$points_bin))

y2_frt9$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt9$wi_Ai<- y2_frt9$midpoint * y2_frt9$Freq
y2_frt9$Ui<- y2_frt9$wi_Ai/sum(y2_frt9$wi_Ai)
y2_frt9<- y2_frt9 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in frt9
## Start here!

frt9_escape<-escaped_pts %>% filter(Cluster==9)

y3_frt9<-as.data.frame(table(frt9_escape$points_bin))
y2_frt9$used_obs<-y3_frt9$Freq

y2_frt9$expected_no_obs<-sum(y2_frt9$used_obs)*y2_frt9$Ui

ggplot(data=y2_frt9) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt9$prop_used<-y2_frt9$used_obs/(sum(y2_frt9$used_obs))
y2_frt9$prop_expected<-y2_frt9$expected_no_obs/(sum(y2_frt9$expected_no_obs))

relationship.fit<-lm(prop_used ~ prop_expected, data=y2_frt9)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt9 <- ggplot(data=y2_frt9, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt9

Xsq<-chisq.test(y2_frt9$used_obs, p=y2_frt9$prop_expected, simulate.p.value = TRUE)  
Xsq


my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is  different to zero and slope is  different than 1. GOOD
```

# FRT 10
```{r}

# first work out proportion of habitat types across the landscape
frt10<-frt_clipped %>% filter(Cluster == 10)
frt10<-sf::st_as_sf(frt10) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(frt10))
r3 <- mask(r2, frt10)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(rast_escape_2022, breaks=c(-0.01, 0.0941, 0.188, 0.282, 0.376, 0.47, 0.564, 0.658, 0.752, 0.847, 0.942)))
table(x2$points_bin)

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt10<-as.data.frame(table(y$points_bin))

y2_frt10$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt10$wi_Ai<- y2_frt10$midpoint * y2_frt10$Freq
y2_frt10$Ui<- y2_frt10$wi_Ai/sum(y2_frt10$wi_Ai)
y2_frt10<- y2_frt10 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in frt10
## Start here!

frt10_escape<-escaped_pts %>% filter(Cluster==10)

y3_frt10<-as.data.frame(table(frt10_escape$points_bin))
y2_frt10$used_obs<-y3_frt10$Freq

y2_frt10$expected_no_obs<-sum(y2_frt10$used_obs)*y2_frt10$Ui

ggplot(data=y2_frt10) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt10$prop_used<-y2_frt10$used_obs/(sum(y2_frt10$used_obs))
y2_frt10$prop_expected<-y2_frt10$expected_no_obs/(sum(y2_frt10$expected_no_obs))

relationship.fit<-lm(prop_used ~ prop_expected, data=y2_frt10)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt10 <- ggplot(data=y2_frt10, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt10

Xsq<-chisq.test(y2_frt10$used_obs, p=y2_frt10$prop_expected, simulate.p.value = TRUE)  
Xsq


my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is not different to zero and slope is not different than 1. GOOD
```

# FRT 11
```{r}

# first work out proportion of habitat types across the landscape
frt11<-frt_clipped %>% filter(Cluster == 11)
frt11<-sf::st_as_sf(frt11) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(frt11))
r3 <- mask(r2, frt11)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(rast_escape_2022, breaks=c(-0.01, 0.0941, 0.188, 0.282, 0.376, 0.47, 0.564, 0.658, 0.752, 0.847, 0.942)))
table(x2$points_bin)

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt11<-as.data.frame(table(y$points_bin))

y2_frt11$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt11$wi_Ai<- y2_frt11$midpoint * y2_frt11$Freq
y2_frt11$Ui<- y2_frt11$wi_Ai/sum(y2_frt11$wi_Ai)
y2_frt11<- y2_frt11 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in frt11
## Start here!

frt11_escape<-escaped_pts %>% filter(Cluster==11)

y3_frt11<-as.data.frame(table(frt11_escape$points_bin))
y2_frt11$used_obs<-y3_frt11$Freq

y2_frt11$expected_no_obs<-sum(y2_frt11$used_obs)*y2_frt11$Ui

ggplot(data=y2_frt11) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt11$prop_used<-y2_frt11$used_obs/(sum(y2_frt11$used_obs))
y2_frt11$prop_expected<-y2_frt11$expected_no_obs/(sum(y2_frt11$expected_no_obs))

relationship.fit<-lm(prop_used ~ prop_expected, data=y2_frt11)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt11 <- ggplot(data=y2_frt11, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt11

Xsq<-chisq.test(y2_frt11$used_obs, p=y2_frt11$prop_expected, simulate.p.value = TRUE)  
Xsq


my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is not different to zero and slope is not different than 1. GOOD
```

# FRT 12
```{r}

# first work out proportion of habitat types across the landscape
frt12<-frt_clipped %>% filter(Cluster == 12)
frt12<-sf::st_as_sf(frt12) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(frt12))
r3 <- mask(r2, frt12)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(rast_escape_2022, breaks=c(-0.01, 0.0941, 0.188, 0.282, 0.376, 0.47, 0.564, 0.658, 0.752, 0.847, 0.942)))
table(x2$points_bin)

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt12<-as.data.frame(table(y$points_bin))

y2_frt12$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt12$wi_Ai<- y2_frt12$midpoint * y2_frt12$Freq
y2_frt12$Ui<- y2_frt12$wi_Ai/sum(y2_frt12$wi_Ai)
y2_frt12<- y2_frt12 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in frt12
## Start here!

frt12_escape<-escaped_pts %>% filter(Cluster==12)

y3_frt12<-as.data.frame(table(frt12_escape$points_bin))
y2_frt12$used_obs<-y3_frt12$Freq

y2_frt12$expected_no_obs<-sum(y2_frt12$used_obs)*y2_frt12$Ui

ggplot(data=y2_frt12) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt12$prop_used<-y2_frt12$used_obs/(sum(y2_frt12$used_obs))
y2_frt12$prop_expected<-y2_frt12$expected_no_obs/(sum(y2_frt12$expected_no_obs))

relationship.fit<-lm(prop_used ~ prop_expected, data=y2_frt12)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt12 <- ggplot(data=y2_frt12, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt12

Xsq<-chisq.test(y2_frt12$used_obs, p=y2_frt12$prop_expected, simulate.p.value = TRUE)  
Xsq


my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is not different to zero and slope is not different to 1. GOOD
```

# FRT 13
```{r}

# first work out proportion of habitat types across the landscape
frt13<-frt_clipped %>% filter(Cluster ==13)
frt13<-sf::st_as_sf(frt13) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(frt13))
r3 <- mask(r2, frt13)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(rast_escape_2022, breaks=c(-0.01, 0.0941, 0.188, 0.282, 0.376, 0.47, 0.564, 0.658, 0.752, 0.847, 0.942)))
table(x2$points_bin)

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt13<-as.data.frame(table(y$points_bin))

y2_frt13$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt13$wi_Ai<- y2_frt13$midpoint * y2_frt13$Freq
y2_frt13$Ui<- y2_frt13$wi_Ai/sum(y2_frt13$wi_Ai)
y2_frt13<- y2_frt13 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in frt13
## Start here!

frt13_escape<-escaped_pts %>% filter(Cluster==13)

y3_frt13<-as.data.frame(table(frt13_escape$points_bin))
y2_frt13$used_obs<-y3_frt13$Freq

y2_frt13$expected_no_obs<-sum(y2_frt13$used_obs)*y2_frt13$Ui

ggplot(data=y2_frt13) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt13$prop_used<-y2_frt13$used_obs/(sum(y2_frt13$used_obs))
y2_frt13$prop_expected<-y2_frt13$expected_no_obs/(sum(y2_frt13$expected_no_obs))

relationship.fit<-lm(prop_used ~ prop_expected, data=y2_frt13)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt13 <- ggplot(data=y2_frt13, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt13

Xsq<-chisq.test(y2_frt13$used_obs, p=y2_frt13$prop_expected, simulate.p.value = TRUE)  
Xsq


my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is not different to zero and slope is not different than 1. GOOD
```

# FRT 14
```{r}

# first work out proportion of habitat types across the landscape
frt14<-frt_clipped %>% filter(Cluster == 14)
frt14<-sf::st_as_sf(frt14) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(frt14))
r3 <- mask(r2, frt14)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(rast_escape_2022, breaks=10))
table(x2$points_bin)
#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt14<-as.data.frame(table(y$points_bin))

get_midpoint <- function(cut_label) {
  mean(as.numeric(unlist(strsplit(gsub("\\(|\\)|\\[|\\]", "", as.character(cut_label)), ","))))
}

y2_frt14$midpoint <- sapply(y2_frt14$Var1, get_midpoint)
y2_frt14$wi_Ai<- y2_frt14$midpoint * y2_frt14$Freq
y2_frt14$Ui<- y2_frt14$wi_Ai/sum(y2_frt14$wi_Ai)
y2_frt14<- y2_frt14 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in frt14
## Start here!

frt14_escape<-escaped_pts %>% filter(Cluster==14)

breakno<-unique(as.numeric(unlist(strsplit(gsub("\\(|\\)|\\[|\\]", "", as.character(y2_frt14$bins)), ","))))
frt14_escape<-frt14_escape %>% mutate(points_bin = cut(rasValue2, breaks=breakno))

y3_frt14<-as.data.frame(table(frt14_escape$points_bin))
y2_frt14$used_obs<-y3_frt14$Freq

y2_frt14$expected_no_obs<-sum(y2_frt14$used_obs)*y2_frt14$Ui

ggplot(data=y2_frt14) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt14$prop_used<-y2_frt14$used_obs/(sum(y2_frt14$used_obs))
y2_frt14$prop_expected<-y2_frt14$expected_no_obs/(sum(y2_frt14$expected_no_obs))

relationship.fit<-lm(prop_used ~ prop_expected, data=y2_frt14)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt14 <- ggplot(data=y2_frt14, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt14

Xsq<-chisq.test(y2_frt14$used_obs, p=y2_frt14$prop_expected, simulate.p.value = TRUE)  
Xsq


my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is not different to zero and slope is not different than 1. GOOD
```

# FRT 15
```{r}

# first work out proportion of habitat types across the landscape
frt15<-frt_clipped %>% filter(Cluster == 15)
frt15<-sf::st_as_sf(frt15) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(escape.ras, extent(frt15))
r3 <- mask(r2, frt15)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(rast_escape_2022, breaks=10))
table(x2$points_bin)
#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt15<-as.data.frame(table(y$points_bin))

get_midpoint <- function(cut_label) {
  mean(as.numeric(unlist(strsplit(gsub("\\(|\\)|\\[|\\]", "", as.character(cut_label)), ","))))
}

y2_frt15$midpoint <- sapply(y2_frt15$Var1, get_midpoint)
y2_frt15$wi_Ai<- y2_frt15$midpoint * y2_frt15$Freq
y2_frt15$Ui<- y2_frt15$wi_Ai/sum(y2_frt15$wi_Ai)
y2_frt15<- y2_frt15 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in frt15
## Start here!

frt15_escape<-escaped_pts %>% filter(Cluster==15)

breakno<-unique(as.numeric(unlist(strsplit(gsub("\\(|\\)|\\[|\\]", "", as.character(y2_frt15$bins)), ","))))
frt15_escape<-frt15_escape %>% mutate(points_bin = cut(rasValue2, breaks=breakno))

y3_frt15<-as.data.frame(table(frt15_escape$points_bin))
y2_frt15$used_obs<-y3_frt15$Freq

y2_frt15$expected_no_obs<-sum(y2_frt15$used_obs)*y2_frt15$Ui

ggplot(data=y2_frt15) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt15$prop_used<-y2_frt15$used_obs/(sum(y2_frt15$used_obs))
y2_frt15$prop_expected<-y2_frt15$expected_no_obs/(sum(y2_frt15$expected_no_obs))

relationship.fit<-lm(prop_used ~ prop_expected, data=y2_frt15)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt15 <- ggplot(data=y2_frt15, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt15

Xsq<-chisq.test(y2_frt15$used_obs, p=y2_frt15$prop_expected, simulate.p.value = TRUE)  
Xsq


my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is not different to zero and slope is not different than 1. GOOD
```

```{r}
library(ggpubr)

p_bc

ggarrange(#p_bc, 
          p_frt5,
          p_frt7,
          p_frt9,
          p_frt10,
          p_frt11,
          p_frt12,
          p_frt13,
          p_frt14,
          p_frt15 + rremove("x.text"), 
          labels = c("FRT 5", "FRT 7", "FRT 9", "FRT 10", "FRT 11", "FRT 12", "FRT 13", "FRT 14", "FRT15"),
          ncol = 3, nrow = 3)
```






```{r}
#create landscape  raster with each pixel having a different idno
a <- raster(extent(spread_crop), 
  crs = st_crs(spread_crop)$proj4string, resolution = c(400, 400), vals = 1:ncell(ignit_crop))

# make the starting locations the same as the actual ignition locations. Expect to see similar distribution of fire sizes as seen in the original data.
test<-cbind(ignit_subset, st_coordinates(ignit_subset))
head(test)

pointCoordinates<-data.frame(test$X, test$Y)
head(pointCoordinates)

start_points=raster::extract(a, pointCoordinates)

test2<-cbind(test,start_points )

start_points<- unique(start_points) # there appear to be two starting cells that get ignited twice so Im removing the duplicates

#####
# plotting points on raster to check they are still correct
ignit_pts <- rasterToPoints(escape_crop, spatial = TRUE)
# Then to a 'conventional' dataframe
ignit_pts_df  <- data.frame(ignit_pts)

ignit_subset<-ignit_subset %>%
  mutate(escaped = case_when(CURRENT_SIZE > 10 ~ 1,
                           CURRENT_SIZE <= 10 ~ 0))

ggplot() +
 geom_raster(data = ignit_pts_df , aes(x = x, y = y, fill = rast_escape_400m)) +
  geom_sf(data=ignit_subset, aes(color = as.factor(escaped)))  #+
  #geom_point(data = pointCoordinates, aes(x = test.X, y = test.Y))
#####
```

#### TRY 2

After playing with this for a while, I realize that at each iteration it test whether it can spread into all 8 adjacent cells. Thus for the escape step the fire starts at its ignition point and then spreads / or not into some of the adjacent cells. I want to test whether if i rather make escape more like ignition. Testing whether a single point can escape i.e. test its value agains some random number. if the random number is smaller than the escape probability then the fire is allowed to spread using spread2. Rather than letting spread2 act on both the escape an spread probability rasters
```{r}
#create landscape  raster with each pixel having a different idno
a <- raster(extent(ignit_crop), 
  crs = st_crs(ignit_crop)$proj4string, resolution = c(400, 400), vals = 1:ncell(ignit_crop))

#no_ignitions=length(ignit_subset$CURRENT_SIZE) # number of ignitions (FIX this so its drawn from a distribution or pulled off a map or something)
n<-100 # number of reps
out<-list()
set.seed(123)

#####
ignition.pts<-start_points
tot.area.burned<-integer(n)
tot.escapes<-integer(n)

for (i in 1:n) {
  
# initiate ignitions at randomly chosen points
#startCells <- as.integer(sample(1:ncell(ignit_crop), no_ignitions))
#startCells<-start_points

#extract probability numbers from the igniton map
#probs.ignit<-ignit_crop[startCells]
#draw random number from uniform distribution
#random.num<-runif(no_ignitions)
#combine values into a datagram
#df<-as.data.frame(cbind(startCells, probs.ignit, random.num))
#select points that have an ignition probability greater than the randomly drawn number.
#ignition.pts<- df$startCells[df$probs.ignit > df$random.num ]

# Now test if the fire can escape from the ignition point
  #extract probability numbers from the escape map
probs.escape<-escape_crop[ignition.pts]
#draw random number from uniform distribution
random.num<-runif(length(ignition.pts))
#combine values into a datagram
df<-as.data.frame(cbind(ignition.pts, probs.escape, random.num))
#select points that have an ignition probability greater than the randomly drawn number.
escape.pts<- df$ignition.pts[df$probs.escape > df$random.num ]

tot.escapes[i]<-length(escape.pts)


#dim(ignit_subset[(ignit_subset$CURRENT_SIZE>10),])

out[[i]]  <- spread2(a, start = escape.pts, spreadProb = spread_crop, asRaster = FALSE, allowOverlap = FALSE)
tot.area.burned[i]<-out[[i]][,.N]

}

out2<-data.table::rbindlist(out)
b<-table(a[out2$pixels])
b1<-b/n

b.tab<-data.table(b1)
b.tab$V1<-as.numeric(b.tab$V1)
a[]<-0
a[b.tab$V1]<-b.tab$N

plot(a)

```


```{r}
#question is it burning this many pixels because it runs out of pixels? Test this by increasing the area that is availabel to burn

# some other stats 
number_ignits<-list()

fire_size_end <- data.frame (matrix (ncol = 3, nrow = 0)) # add 'data' to the points
colnames (fire_size_end) <- c ("Var1", "Freq", "rep")

for (i in 1:n) {
  
  number_ignits[[i]]<-out[[i]][, .N, by = "initialPixels"]$N
  #number_ignits[[i]]<-length(unique(out[[i]]$initialPixels))
  
  fire_size_intermediate<-as.data.frame(table(out[[i]]$initialPixels))
  fire_size_intermediate$rep<-i
  
  fire_size_end<-rbind(fire_size_end, fire_size_intermediate)
  
}

fire_size_end$Freq<-as.numeric(fire_size_end$Freq)
x<-aggregate(fire_size_end$Freq, by=list(Category=fire_size_end$Var1), FUN=mean)

x<-x %>% rename(start_points=Category,
                size = x)

x$start_points<-as.numeric(as.character(x$start_points))
x2<-left_join(test2, x)
x2 <- x2 %>% mutate(size = ifelse(is.na(size), 1, size))

ggplot(data=x2) +    
   geom_histogram(aes(x=size), fill = "blue") 
ggplot(data=x2) +    
   geom_histogram(aes(x=CURRENT_SIZE), fill = "green") 

hist(x2$CURRENT_SIZE, breaks=50, xlim=c(0,80000))

library(reshape2)
# reshape data from wide to long format
long <- melt(x2, id= "start_points", measure.vars = c("size", "CURRENT_SIZE"))
g <- long%>%
  ggplot(aes(x=value, fill=variable)) +
  geom_histogram(alpha=0.3) #+
  #scale_x_log10()

g
```


```{r}
###########################
# how many fires escaped i.e. grew bigger than 10 ha?

rep<-1:n
number_escaped<-as.data.frame(cbind(rep, tot.escapes, tot.area.burned))
number_escaped$tot.escapes
length(ignit_subset_10$CURRENT_SIZE)


# Basic density
p <- ggplot(number_escaped, aes(x=tot.escapes)) + 
  geom_density() + 
   xlim(0, 100)
# Add mean line
p + geom_vline(aes(xintercept=length(ignit_subset_10$CURRENT_SIZE)), color="blue", linetype="dashed", size=1)

# Basic density
# p2 <- ggplot(number_escaped, aes(x=tot.area.burned)) + 
#   geom_density() + 
#    xlim(0, 400000)
# # Add mean line
# p2 + geom_vline(aes(xintercept=sum(ignit_subset_10$CURRENT_SIZE)), color="blue", linetype="dashed", size=1)
#          

```



##### Try the same for the whole of BC

```{r}
#create landscape  raster with each pixel having a different idno
a <- raster(extent(spread.ras), 
  crs = st_crs(spread.ras)$proj4string, resolution = c(400, 400), vals = 1:ncell(spread.ras))

# make the starting locations the same as the actual ignition locations. Expect to see similar distribution of fire sizes as seen in the original data.
test<-cbind(ignit_subset, st_coordinates(ignit_subset))
head(test)


pointCoordinates<-data.frame(test$X, test$Y)
head(pointCoordinates)

start_points=raster::extract(a, pointCoordinates)
test2<-cbind(test,start_points )

start_points<- unique(start_points) # there appear to be two starting cells that get ignited twice so Im removing the duplicates

#####
# plotting points on raster to check they are still correct
escape_pts <- rasterToPoints(spread.ras, spatial = TRUE)
# Then to a 'conventional' dataframe
escape_pts_df  <- data.frame(spread.ras)

ggplot() +
 geom_raster(data = escape_pts_df , aes(x = x, y = y, fill = rast_spread_400m_2)) +
  geom_point(data = pointCoordinates, aes(x = test.X, y = test.Y))
#####
```


```{r}
#create landscape  raster with each pixel having a different idno
a <- raster(extent(escape.ras), 
  crs = st_crs(escape.ras)$proj4string, resolution = c(400, 400), vals = 1:ncell(escape.ras))

#no_ignitions=length(ignit_subset$CURRENT_SIZE) # number of ignitions (FIX this so its drawn from a distribution or pulled off a map or something)
n<-100 # number of reps
out<-list()
set.seed(123)

#####
ignition.pts<-start_points
tot.area.burned<-integer(n)
tot.escapes<-integer(n)


for (i in 1:n) {
  
# initiate ignitions at randomly chosen points
#startCells <- as.integer(sample(1:ncell(ignit_crop), no_ignitions))
#startCells<-start_points

#extract probability numbers from the igniton map
#probs.ignit<-ignit_crop[startCells]
#draw random number from uniform distribution
#random.num<-runif(no_ignitions)
#combine values into a datagram
#df<-as.data.frame(cbind(startCells, probs.ignit, random.num))
#select points that have an ignition probability greater than the randomly drawn number.
#ignition.pts<- df$startCells[df$probs.ignit > df$random.num ]

# Now test if the fire can escape from the ignition point
  #extract probability numbers from the escape map
probs.escape<-escape.ras[ignition.pts]
#draw random number from uniform distribution
random.num<-runif(length(ignition.pts))
#combine values into a datagram
df<-as.data.frame(cbind(ignition.pts, probs.escape, random.num))
#select points that have an ignition probability greater than the randomly drawn number.
escape.pts<- df$ignition.pts[df$probs.escape > df$random.num ]

tot.escapes[i]<-length(escape.pts)


#dim(ignit_subset[(ignit_subset$CURRENT_SIZE>10),])

out[[i]]  <- spread2(a, start = escape.pts, spreadProb = spread.ras, asRaster = FALSE, allowOverlap = FALSE)

tot.area.burned[i]<-out[[i]][,.N]

}

out2<-data.table::rbindlist(out)
b<-table(a[out2$pixels])
b1<-b/n

b.tab<-data.table(b1)
b.tab$V1<-as.numeric(b.tab$V1)
a[]<-0
a[b.tab$V1]<-b.tab$N
#clearPlot()
plot(a)
```


```{r}
#question is it burning this many pixels because it runs out of pixels? Test this by increasing the area that is availabel to burn

# some other stats 
number_ignits<-list()

fire_size_end <- data.frame (matrix (ncol = 3, nrow = 0)) # add 'data' to the points
colnames (fire_size_end) <- c ("Var1", "Freq", "rep")

for (i in 1:n) {
  
  number_ignits[[i]]<-out[[i]][, .N, by = "initialPixels"]$N
  #number_ignits[[i]]<-length(unique(out[[i]]$initialPixels))
  
  fire_size_intermediate<-as.data.frame(table(out[[i]]$initialPixels))
  fire_size_intermediate$rep<-i
  
  fire_size_end<-rbind(fire_size_end, fire_size_intermediate)
  
}

fire_size_end$Freq<-as.numeric(fire_size_end$Freq)
x<-aggregate(fire_size_end$Freq, by=list(Category=fire_size_end$Var1), FUN=mean)

x<-x %>% rename(start_points=Category,
                size = x)
x$size<-as.numeric(x$size)

x$start_points<-as.numeric(as.character(x$start_points))
x2<-left_join(test2, x)
x2 <- x2 %>% mutate(size = ifelse(is.na(size), 0.001, size))

ggplot(data=x2) +    
   geom_histogram(aes(x=size), fill = "blue") 
ggplot(data=x2) +    
   geom_histogram(aes(x=CURRENT_SIZE), fill = "green") 

hist(x2$CURRENT_SIZE, breaks=50, xlim=c(0,80000))

library(reshape2)
# reshape data from wide to long format
long <- melt(x2, id= "start_points", measure.vars = c("size", "CURRENT_SIZE"))
g <- long%>%
  ggplot(aes(x=value, fill=variable)) +
  geom_histogram(alpha=0.3) #+
  #scale_x_log10()

g
```


```{r}
###########################
# how many fires escaped i.e. grew bigger than 10 ha?

rep<-1:n
number_escaped<-as.data.frame(cbind(rep, tot.escapes, tot.area.burned))

# Basic density
p <- ggplot(number_escaped, aes(x=tot.escapes)) + 
  geom_density() + 
   xlim(0, 100)
# Add mean line
p + geom_vline(aes(xintercept=length(ignit_subset_10$CURRENT_SIZE)), color="blue", linetype="dashed", size=1)

# Basic density
# p2 <- ggplot(number_escaped, aes(x=tot.area.burned)) + 
#   geom_density() + 
#    xlim(0, 400000)
# # Add mean line
# p2 + geom_vline(aes(xintercept=sum(ignit_subset_10$CURRENT_SIZE)), color="blue", linetype="dashed", size=1)
#          

```


```{r}
# some other stats 
number_ignits<-list()

fire_size_end <- data.frame (matrix (ncol = 3, nrow = 0)) # add 'data' to the points
colnames (fire_size_end) <- c ("Var1", "Freq", "rep")

for (i in 1:n) {
  
  number_ignits[[i]]<-out[[i]][, .N, by = "initialPixels"]$N
  #number_ignits[[i]]<-length(unique(out[[i]]$initialPixels))
  
  fire_size_intermediate<-as.data.frame(table(out[[i]]$initialPixels))
  fire_size_intermediate$rep<-i
  
  fire_size_end<-rbind(fire_size_end, fire_size_intermediate)
  
}

hist(fire_size_end$Freq, breaks=50) # gives distribution of fire sizes
```


```{r}
###########################
# how many fires escaped i.e. grew bigger than 10 ha?
number_escaped <- data.frame (matrix (ncol = 2, nrow = 0)) # add 'data' to the points
colnames (number_escaped) <- c ("rep", "tot_escaped")

for (i in 1:n) {
  no_fires_escaped<-fire_size_end %>% filter(rep==i & Freq>1) 
  number_escaped[i,1]<-i
  number_escaped[i,2]<-length(no_fires_escaped$Freq)
}


library(ggplot2)
# Basic density
p <- ggplot(number_escaped, aes(x=tot_escaped)) + 
  geom_density(fill="purple") + 
   xlim(200, 900)

ignit_10ha<-ignit %>% filter(CURRENT_SIZE>1)
# Add mean line
p + geom_vline(aes(xintercept=length(ignit_10ha$CURRENT_SIZE)), color="blue", linetype="dashed", size=1)
         
```

 Here Im going to test whether escape or spread generally has a higher probability of occuring at each of the ignition points
```{r}
test<-cbind(ignit, st_coordinates(ignit))
head(test)

pointCoordinates<-data.frame(test$X, test$Y)
head(pointCoordinates)

rasStack<-stack(escape.ras, spread.ras)

pts=raster::extract(rasStack, pointCoordinates)

ignit_pts_info<-ignit %>% dplyr::select(FIRE_CAUSE, CURRENT_SIZE )

ignit_pts_info<- cbind(ignit_pts_info, pts)
ignit_pts_info<-ignit_pts_info %>%
  mutate(escape = case_when(CURRENT_SIZE > 10 ~ 1,
                           CURRENT_SIZE <= 10 ~ 0))

ignit_pts_info$escape<-as.character(ignit_pts_info$escape)

ggplot(ignit_pts_info, aes(x=rast_spread_400m_2, y=rast_escape_400m, color=escape, shape=escape)) +
  geom_point() + 
  geom_smooth(method=lm, aes(fill=escape))


start_points<- unique(start_points) # there appear to be two starting cells that get ignited twice so Im removing the duplicates

```

## I dont think the below is correct
#### TRY 1

Running this with only escape and spread. The ignition points are the same as the data that I got for 2021.

It looks like Im getting around double the number of escaped fires as I should in comparison to what the data has. 

I should check this for other areas as well.

After playing with this for a while, I realize that at each iteration it test whether it can spread into all 8 adjacent cells. Thus for the escape step the fire starts at its ignition point and then spreads / or not into some of the adjacent cells. I want to test whether if i rather make escape more like ignition. Testing whether a single point can escape i.e. test its value agains some random number. if the random number is smaller than the escape probability then the fire is allowed to spread using spread2. Rather than letting spread2 act on both the escape an spread probability rasters



# FIRE SIM

```{r}
####################
# Spread with Escape FUNCTION
# Iterative calling -- create a function with escape and spread probability
####################

spreadWithEscape <- function(ras, start, escapeProb, spreadProb) {
  out <- spread2(ras, start = start, spreadProb = escapeProb, asRaster = FALSE, allowOverlap = FALSE, iterations=1, directions=4)
  while (any(out$state == "activeSource")) {
    # pass in previous output as start
    out <- spread2(ras, start = out, spreadProb = spreadProb,
                   asRaster = FALSE, allowOverlap = FALSE, skipChecks = FALSE) # skipChecks for speed
  }
  out
}
```


```{r}
#create landscape  raster with each pixel having a different idno
a <- raster(extent(ignit_crop), 
  crs = st_crs(ignit_crop)$proj4string, resolution = c(400, 400), vals = 1:ncell(ignit_crop))

#no_ignitions=length(ignit_subset$CURRENT_SIZE) # number of ignitions (FIX this so its drawn from a distribution or pulled off a map or something)
n<-20 # number of reps
out<-list()
set.seed(123)

#####
ignition.pts<-start_points
tot.area.burned<-integer(n)

for (i in 1:n) {
  
  # initiate ignitions at randomly chosen points
#startCells <- as.integer(sample(1:ncell(ignit_crop), no_ignitions))
#startCells<-start_points

#extract probability numbers from the igniton map
#probs.ignit<-ignit_crop[startCells]
#draw random number from uniform distribution
#random.num<-runif(no_ignitions)
#combine values into a datagram
#df<-as.data.frame(cbind(startCells, probs.ignit, random.num))
#select points that have an ignition probability greater than the randomly drawn number.
#ignition.pts<- df$startCells[df$probs.ignit > df$random.num ]


#dim(ignit_subset[(ignit_subset$CURRENT_SIZE>10),])

out[[i]]  <- spreadWithEscape(a, start = ignition.pts, escapeProb = escape_crop , spreadProb = spread_crop)
tot.area.burned[i]<-out[[i]][,.N]

}

out2<-data.table::rbindlist(out)
b<-table(a[out2$pixels])
b1<-b/n

b.tab<-data.table(b1)
b.tab$V1<-as.numeric(b.tab$V1)
a[]<-0
a[b.tab$V1]<-b.tab$N
clearPlot()
Plot(a)

# some other stats 
number_ignits<-list()

fire_size_end <- data.frame (matrix (ncol = 3, nrow = 0)) # add 'data' to the points
colnames (fire_size_end) <- c ("Var1", "Freq", "rep")

for (i in 1:n) {
  
  number_ignits[[i]]<-out[[i]][, .N, by = "initialPixels"]$N
  #number_ignits[[i]]<-length(unique(out[[i]]$initialPixels))
  
  fire_size_intermediate<-as.data.frame(table(out[[i]]$initialPixels))
  fire_size_intermediate$rep<-i
  
  fire_size_end<-rbind(fire_size_end, fire_size_intermediate)
  
}

  #hist(fire_size_end$Freq) # gives distribution of fire sizes
  
###########################
# how many fires escaped i.e. grew bigger than 10 ha?
number_escaped <- data.frame (matrix (ncol = 2, nrow = 0)) # add 'data' to the points
colnames (number_escaped) <- c ("rep", "tot_escaped")

for (i in 1:n) {
  no_fires_escaped<-fire_size_end %>% filter(rep==i & Freq>1) 
  number_escaped[i,1]<-i
  number_escaped[i,2]<-length(no_fires_escaped$Freq)
}


# Basic density
p <- ggplot(number_escaped, aes(x=tot_escaped)) + 
  geom_density() + 
   xlim(0, 300)
# Add mean line
p + geom_vline(aes(xintercept=length(ignit_subset_10$CURRENT_SIZE)), color="blue", linetype="dashed", size=1)
         

```


1.) test that the distribution of escaped fires matches the actual data:

This is wrong! I did not think about this properly. I need to count how many fires during the simulation get bigger than 10ha. 
For this Ill 
```{r}
#####

dist_ignitions <- data.frame (matrix (ncol = 2, nrow = 0)) # add 'data' to the points
colnames (dist_ignitions) <- c ("rep", "number_ignitions")

for (i in 1:10000) {

probs.ignit<-ignit_crop[startCells]
#draw random number from uniform distribution
random.num<-runif(no_ignitions)
#combine values into a datagram
df<-as.data.frame(cbind(startCells, probs.ignit, random.num))
#select points that have an ignition probability greater than the randomly drawn number.
ignition.pts<- df$startCells[df$probs.ignit > df$random.num ]

dist_ignitions[i,1]<-i
dist_ignitions[i,2]<-length(ignition.pts)

}

hist(dist_ignitions$number_ignitions)
```
