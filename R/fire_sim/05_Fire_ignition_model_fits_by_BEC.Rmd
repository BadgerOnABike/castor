---
title: "Fire ignition model fit by BEC zone"
author: "Elizabeth Kleynhans"
contributor: "Cora Skaien"
date: "20/04/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

editor_options:
  chunk_output_type: console
  
<style> 
p.caption {
  font-size: 1.2em;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require (kableExtra)
require (data.table)
require (DBI)
require (RPostgreSQL)
require (dplyr)
require (ggplot2)
require (here)
library(ggpubr)
library(arm)
library(tidyr)
library(AICcmodavg)
library(keyring)
```


<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

## Introduction

Here I am running a glm for each separate bec zone to develop a predictive equation so that I can extrapolate fire ignitions into the future. The data that I include in these glms is both vegetation and climate date. The top climate variable for each BEC zone was determined in the script "04_ignition_climate_variable_selection.R". When ran by Cora on June 23, 2021, some zones had different top models than when Liz ran code. Vegetation data is a little complicated by the fact that the VRI does not have age, height or volume data for any vegetation types that are not classified as treed. Also, it seems like forests on private land lack age, volume and height data. Because I think volume, age and height are likely good predictors of fire severity and occurrence I split up this analysis into two parts in each BEC zone. 
Firstly, in each BEC zone I split the data into treed and non-treed then I run a glm with climate and vegetation for areas that are classified as treed in the VRI and then I run another separate analysis for areas that are classified as not treed. The fixed effects I include in these analyses are slightly different, i.e. no age, volume or height data in the non-treed areas, which is why I split them up.  

# climate variable selection
In the script "04_ignition_climate_variable_selection.R" I perform an AIC and ROC analysis for each BEC zone including presence/available fire ignition points and a variety of climate variables. For this analysis I split the data into a training and a validation data set where 75% of the data was used for training and 25% was used for validation. I then fit the model and extracted the AIC and AUC values. This was repeated 100 times and at the end I calculated the average AIC and AUC values. The climate variable that results in the lowest average AIC value I decided to use in this analysis. Table 1 is a summary of which climate variables fitted best for each BEC zone. 

Note: Some climate variables resulted in delta AIC values that were very similar and had much less than 2 points difference. Also, the variable with the smallest AIC value did not always have the best AUC value. Regardless of these two issues I decided to take the climate variable with the smallest average AIC for simplicity. Results can be found in table 1 below. This file was manipulated manually and then saved on to the drive before being uploaded (i.e., it is a simplified table from that generated in the last file, 04_ignition_climate_variable_selection; code for uploading not included prior).

```{r, AIC table, echo = F, message = F, eval = T}

 climate.aic <- read.csv ("D:/Fire/fire_data/raw_data/ClimateBC_Data/AIC_table.csv")

kable (climate.aic,
       caption = "<b>Table 1. Top candidate climate variables as selected through an AIC analysis for each BEC zone.<b>",
       digits = 2) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)

```
## Pull in the data. Note, this is a cleaned version and also differs slightly from the file saved in the last script. Note: June 24, this file cannot be viewed on PostGre for some reason, but it seems to be brought in ok?
```{r}
connKyle <- dbConnect(drv = RPostgreSQL::PostgreSQL(), 
                      host = key_get('dbhost', keyring = 'postgreSQL'),
                      user = key_get('dbuser', keyring = 'postgreSQL'),
                      dbname = key_get('dbname', keyring = 'postgreSQL'),
                      password = key_get('dbpass', keyring = 'postgreSQL'),
                      port = "5432")
dat <- sf::st_read  (dsn = connKyle, # connKyle
                               query = "SELECT * FROM fire_ignitions_veg_climate_clean")
dbDisconnect (connKyle)

head(dat)

```
## Examining correlation between stand level variables
```{r}
# Examining the relationship between some stand level variables. Volume and height are fairly correlated (0.67) but age and volume are not (0.28) and neither are age and height (0.44). Because volume and height are very close to 0.7 in correlation I will leave out this combination of variables from my treed models.  
dat_t<- dat %>% dplyr::filter(bclcs_level_2=="T")


ggscatter(dat_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(dat_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(dat_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

```

## BEC ZONE BG
```{r bg figures}
bg<- dat %>% dplyr::filter(zone =="BG")
# I will run separate analyses for treed and non-treed areas because the non-treed areas don't have information for forest height, age or volume and so these variables cant be included in the model.
bg_t<- bg %>% dplyr::filter(bclcs_level_2=="T") # treed areas
bg_nt<- bg %>% dplyr::filter(bclcs_level_2!="T") # not treed

# examining  relationship between top climatic variable and ignition for bg  
p <- ggplot(bg, aes(ppt09, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt09") + ylab("Pr (ignition)")
p

p1 <- ggplot(bg_t, aes(ppt09, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt09") + ylab("Pr (ignition)")
p1

p2 <- ggplot(bg_nt, aes(ppt09, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt09") + ylab("Pr (ignition)")
p2

hist(bg_t$ppt09)
hist(bg_nt$ppt09)

```

## BG treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################


glm1<- glm(fire_pres ~ ppt09, 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"ppt09"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ ppt09 +
             proj_age_1, 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"ppt09 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ ppt09 +
             proj_height_1, 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ ppt09 +
             live_stand_volume_125, 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ ppt09 +
             bclcs_level_4, # classification of tree type in the VRI 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + bclcs_level_4"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ ppt09 +
             live_stand_volume_125 + 
             proj_age_1,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ ppt09 +
             proj_age_1 + 
             proj_height_1,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ ppt09 +
             proj_age_1 + 
             bclcs_level_4,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_age_1 + bclcs_level_4"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ ppt09 +
             proj_height_1 + 
             bclcs_level_4,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_height_1 + bclcs_level_4"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ ppt09 +
             live_stand_volume_125 + 
             bclcs_level_4,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125 + bclcs_level_4"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ ppt09 +
             live_stand_volume_125 + 
              proj_age_1 +
             bclcs_level_4,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125 + proj_age_1 + bclcs_level_4"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ ppt09 +
              proj_height_1 +
              proj_age_1 +
             bclcs_level_4,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_height_1 + proj_age_1 + bclcs_level_4"
table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.bg<- table.glm
table.glm.bg[order(table.glm.bg$deltaAIC),] 

# # 
#    Model                                                   Variable      AIC   deltaAIC
#3   glm3                                      ppt09 + proj_height_1    49.74731 0.000000
#9   glm9                      ppt09 + proj_height_1 + bclcs_level_4    51.98902 2.241716
#7   glm7                         ppt09 + proj_age_1 + proj_height_1    52.01726 2.269958
#2   glm2                                         ppt09 + proj_age_1    54.00719 4.259886
#4   glm4                              ppt09 + live_stand_volume_125    54.46260 4.715296
#12 glm12         ppt09 + proj_height_1 + proj_age_1 + bclcs_level_4    54.79458 5.047279
#1   glm1                                                      ppt09    55.85794 6.110631
#8   glm8                         ppt09 + proj_age_1 + bclcs_level_4    56.38755 6.640244
#6   glm6                  ppt09 + live_stand_volume_125 +proj_age_1    56.49051 6.743202
#10 glm10              ppt09 + live_stand_volume_125 + bclcs_level_4    57.59831 7.851009
#5   glm5                                      ppt09 + bclcs_level_4    58.75094 9.003635
#11 glm11 ppt09 + live_stand_volume_125 + proj_age_1 + bclcs_level_4    59.18188 9.434572

#TOP MODEL = glm3    ppt09 + proj_height_1 45.80242 0.0000000


####################################################
##### TOP MODEL####

bg_t2<-bg_t %>% drop_na(proj_height_1)

glm_best<- glm(fire_pres ~ ppt09 +
             proj_height_1, 
           data= bg_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


bg_t2$resids<-resid(glm_best)

binnedplot (bg_t2$proj_height_1, 
            bg_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (bg_t2$ppt09, 
            bg_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

# Diagnostic plots look ok, but my sample sizes in this BEC zone are low!

# Looking at effect of forest height at the average amount of rainfall in September
plot(bg_t2$proj_height_1,bg_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*mean(bg_t2$ppt09) + coef(glm_best)[3]*x), add=TRUE)

# looking at effect of ppt09 at the average forest height.
plot(bg_t2$ppt09,bg_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*x + coef(glm_best)[3]*mean(bg_t2$proj_height_1)), add=TRUE)


# create model table (only do this once) and add the relevant data
top_mod_table <- data.frame (matrix (ncol = 7, nrow = 0))
colnames (top_mod_table) <- c ("ZONE", "TREED", "Model_terms", "intercept", "coef_climate_1", "coef_climate_2",  "coef_stand_height")
top_mod_table[1,1]<-"BG"
top_mod_table[1,2]<-"Y"
top_mod_table[1,3]<-"fire_pres ~ ppt09 + proj_height_1"
top_mod_table[1,4]<- coef(glm_best)[1]
top_mod_table[1,5]<- coef(glm_best)[2]
#top_mod_table[1,6]<- coef(glm_best)[2]
top_mod_table[1,7]<- coef(glm_best)[3]
top_mod_table

```

## BEC ZONE BWBS Figures
```{r bg figures}
bwbs<- dat %>% dplyr::filter(zone =="BWBS")
# I will run separate analyses for treed and non-treed areas because the non-treed areas dont have information for forest height, age or volume and so these variables cant be included in the model.
bwbs_t<- bwbs %>% dplyr::filter(bclcs_level_2=="T") # treed areas
bwbs_nt<- bwbs %>% dplyr::filter(bclcs_level_2!="T") # not treed

# examining  relationship between top climatic variable (mean_tave06_tave07_tave08) and ignition for bwbs 
p <- ggplot(bwbs, aes(mean_tave06_tave07_tave08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_tave06_tave07_tave08") + ylab("Pr (ignition)")
p


p <- ggplot(bwbs_t, aes(mean_tave06_tave07_tave08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_tave06_tave07_tave08") + ylab("Pr (ignition)")
p



hist(bwbs_t$mean_tave06_tave07_tave08)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated (0.72) but age and volume are not. 
ggscatter(bwbs_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(bwbs_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(bwbs_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

```

## BWBS treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################


glm1<- glm(fire_pres ~ mean_tave06_tave07_tave08, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_tave06_tave07_tave08"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
             proj_age_1, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
             proj_height_1, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
             live_stand_volume_125, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
             bclcs_level_4, # classification of tree type in the VRI 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + bclcs_level_4"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
             live_stand_volume_125 + 
             proj_age_1,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
             proj_age_1 + 
             proj_height_1,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
             proj_age_1 + 
             bclcs_level_4,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_age_1 + bclcs_level_4"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
           proj_height_1 + 
           bclcs_level_4,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_height_1 + bclcs_level_4"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
             live_stand_volume_125 + 
             bclcs_level_4,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + live_stand_volume_125 + bclcs_level_4"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
             live_stand_volume_125 + 
              proj_age_1 +
             bclcs_level_4,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + live_stand_volume_125 + proj_age_1 + bclcs_level_4"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ mean_tave06_tave07_tave08 +
              proj_height_1 +
              proj_age_1 +
             bclcs_level_4,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + bclcs_level_4"
table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.bwbs<- table.glm
table.glm.bwbs[order(table.glm.bwbs$deltaAIC),] 

#Model                                                                       Variable      AIC  deltaAIC
#10 glm10            mean_tave06_tave07_tave08 + live_stand_volume_125 + bclcs_level_4 3084.607  0.0000000
#11 glm11 mean_tave06_tave07_tave08 + live_stand_volume_125+proj_age_1+bclcs_level_4  3085.069   0.4616382
#6   glm6             mean_tave06_tave07_tave08 + live_stand_volume_125 +proj_age_1   3151.168  66.5606752
#4   glm4                           mean_tave06_tave07_tave08 + live_stand_volume_125 3168.809  84.2018663
#12 glm12      mean_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + bclcs_level_4 4035.729 951.1215917
#8   glm8                      mean_tave06_tave07_tave08 + proj_age_1 + bclcs_level_4 4036.915 952.3082287
#9   glm9                  mean_tave06_tave07_tave08 + proj_height_1 + bclcs_level_4 4038.011  953.4039295
#5   glm5                                  mean_tave06_tave07_tave08 + bclcs_level_4 4086.511 1001.9040492
#7   glm7                     mean_tave06_tave07_tave08 + proj_age_1 + proj_height_1 4103.615 1019.0078386
#3   glm3                                 mean_tave06_tave07_tave08 + proj_height_1 4142.327 1057.7204247
#2   glm2                                     mean_tave06_tave07_tave08 + proj_age_1 4152.729 1068.1221689
#1   glm1                                                  mean_tave06_tave07_tave08 4210.062 1125.4547625

####################################################
##### TOP MODEL####

bwbs_t2<-bwbs_t %>% drop_na(live_stand_volume_125)

glm_best<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08)+
             scale(live_stand_volume_125) +
               bclcs_level_4, 
           data= bwbs_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


bwbs_t2$resids<-resid(glm_best)

binnedplot (bwbs_t2$live_stand_volume_125, 
            bwbs_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (bwbs_t2$mean_tave06_tave07_tave08, 
            bwbs_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


# Diagnostic plots look ok, not great.


```

## CMA treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

cma<- dat %>% dplyr::filter(zone =="CMA")
# I will run separate analyses for treed and non-treed areas because the non-treed areas don't have information for forest height, age or volume and so these variables cant be included in the model.
cma_t<- cma %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
cma_nt<- cma %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(cma_t$bclcs_level_4)


glm1<- glm(fire_pres ~ tave08 * ppt08, 
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"tave08 * ppt08"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ tave08 * ppt08 +
             proj_age_1, 
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"tave08 * ppt08 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ tave08 * ppt08 +
             proj_height_1, 
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ tave08 * ppt08 +
             live_stand_volume_125, 
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

#glm5<- glm(fire_pres ~ tave08 * ppt08 +
#             bclcs_level_4, # classification of tree type in the VRI; cannot do, because only TC 
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm5)
#i=5
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + bclcs_level_4"
#table.glm[i,3]<-AICc(glm5)

glm5<- glm(fire_pres ~ tave08 * ppt08 +
             live_stand_volume_125 + 
             proj_age_1,
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ tave08 * ppt08 +
             proj_age_1 + 
             proj_height_1,
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm6)

#glm8<- glm(fire_pres ~ tave08 * ppt08 +
#             proj_age_1 + 
#             bclcs_level_4, #When Cora runs this, there is only one level for bclcs_level_4 and thus an error arises
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm8)
#i=8
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + proj_age_1 + bclcs_level_4"
#table.glm[i,3]<-AICc(glm8)

#glm9<- glm(fire_pres ~ tave08 * ppt08 +
#             proj_height_1 + 
#             bclcs_level_4, #Only one level 
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm9)
#i=9
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + proj_height_1 + bclcs_level_4"
#table.glm[i,3]<-AICc(glm9)

#glm10<- glm(fire_pres ~ tave08 * ppt08 +
#             live_stand_volume_125 + 
#             bclcs_level_4,
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm10)
#i=10
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125 + bclcs_level_4"
#table.glm[i,3]<-AICc(glm10)

#glm11<- glm(fire_pres ~ tave08 * ppt08 +
#             live_stand_volume_125 + 
#              proj_age_1 +
#             bclcs_level_4,
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm11)
#i=11
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125 + proj_age_1 + bclcs_level_4"
#table.glm[i,3]<-AICc(glm11)

#glm12<- glm(fire_pres ~ tave08 * ppt08 +
#              proj_height_1 +
#              proj_age_1 +
#             bclcs_level_4,
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm12)
#i=12
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + proj_height_1 + proj_age_1 + bclcs_level_4"
#table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.cma<- table.glm
table.glm.cma[order(table.glm.cma$deltaAIC),] #


#    Model                                           Variable      AIC  deltaAIC
#4  glm4             tave08 * ppt08 + live_stand_volume_125 47.99134  0.000000
#5  glm5 tave08 * ppt08 + live_stand_volume_125 +proj_age_1 50.25766  2.266327
#2  glm2                        tave08 * ppt08 + proj_age_1 56.95475  8.963410
#3  glm3                     tave08 * ppt08 + proj_height_1 57.63835  9.647012
#1  glm1                                     tave08 * ppt08 58.87539 10.884057
#6  glm6        tave08 * ppt08 + proj_age_1 + proj_height_1 59.16631 11.174974

####################################################
##### TOP MODEL####

cma_t2<-cma_t %>% drop_na(live_stand_volume_125)

glm_best<- glm(fire_pres ~ scale(tave08)+ + scale(ppt08)+
             scale(live_stand_volume_125),
           data= cma_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


cma_t2$resids<-resid(glm_best)

binnedplot (cma_t2$live_stand_volume_125, 
            cma_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (cma_t2$mean_tave06_tave07_tave08, 
            cma_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))



# Diagnostic plots look ok, not great! Fairly small sample size for this zone.


```






## BEC ZONE ESSF
```{r essf climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for essf were 
essf<- dat %>%
  filter(zone=="ESSF")

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(essf, aes(tave08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("TAve08") + ylab("Pr (ignition)")
p

p <- ggplot(essf, aes(ppt08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08") + ylab("Pr (ignition)")
p


hist(essf$tave08)
hist(essf$ppt08, breaks=30)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(essf, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(essf, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(essf, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(essf$proj_age_1)
hist(scale(essf$proj_age_1))
hist(essf$proj_height_1)
hist(scale(essf$proj_height_1))
hist(essf$live_stand_volume_125, breaks=30)
hist(scale(essf$live_stand_volume_125), breaks=30)
```

```{r essf model fits}
################################
#### Fitting statistical models
################################
essf$proj_age_1_scale<-scale(essf$proj_age_1)
essf$live_stand_volume_125_scale<-scale(essf$live_stand_volume_125)
essf$proj_height_1_scale<-scale(essf$proj_height_1)


glm1<- glm(fire_pres ~ tave08 * ppt08, 
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"tave08 * ppt08"
table.glm[1,3]<-AIC(glm1)

glm2<- glm(fire_pres ~ tave08 * ppt08 +
             vegtype, 
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"tave08 * ppt08 + vegtype"
table.glm[i,3]<-AIC(glm2)


glm3<- glm(fire_pres ~ tave08 * ppt08 +
             proj_age_1_scale, 
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + proj_age_1_scale"
table.glm[i,3]<-AIC(glm3)

glm4<- glm(fire_pres ~ tave08 * ppt08 +
             proj_height_1_scale, 
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + proj_height_1_scale"
table.glm[i,3]<-AIC(glm4)

glm5<- glm(fire_pres ~ tave08 * ppt08 +
             live_stand_volume_125_scale, 
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125_scale"
table.glm[i,3]<-AIC(glm5)

glm6<- glm(fire_pres ~ tave08 * ppt08 +
             live_stand_volume_125_scale +
             proj_age_1_scale,
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125_scale + proj_age_1_scale"
table.glm[i,3]<-AIC(glm6)

glm7<- glm(fire_pres ~ tave08 * ppt08 +
             live_stand_volume_125_scale +
             proj_height_1_scale,
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125_scale + proj_height_1_scale"
table.glm[i,3]<-AIC(glm7)

glm8<- glm(fire_pres ~ tave08 * ppt08 +
             proj_age_1_scale +
             proj_height_1_scale,
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + proj_height_1_scale + proj_age_1_scale"
table.glm[i,3]<-AIC(glm8)

glm9<- glm(fire_pres ~ tave08 * ppt08 +
             vegtype +
             live_stand_volume_125_scale,
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + vegtype + live_stand_volume_125_scale"
table.glm[i,3]<-AIC(glm9)

glm10<- glm(fire_pres ~ tave08 * ppt08 +
             vegtype +
             proj_age_1_scale,
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + vegtype + proj_age_1_scale"
table.glm[i,3]<-AIC(glm10)

glm11<- glm(fire_pres ~ tave08 * ppt08 +
              vegtype + 
              proj_height_1_scale,
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + vegtype + proj_height_1_scale"
table.glm[i,3]<-AIC(glm11)

glm12<- glm(fire_pres ~ tave08 * ppt08 +
             vegtype +
             live_stand_volume_125_scale +
             proj_age_1_scale,
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + vegtype + live_stand_volume_125_scale + proj_age_1_scale"
table.glm[i,3]<-AIC(glm12)

glm13<- glm(fire_pres ~ tave08 * ppt08 +
             vegtype +
             live_stand_volume_125_scale +
             proj_height_1_scale,
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm13)
i=13
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + vegtype + live_stand_volume_125_scale + proj_height_1_scale"
table.glm[i,3]<-AIC(glm13)

glm14<- glm(fire_pres ~ tave08 * ppt08 +
             vegtype +
             proj_age_1_scale +
             proj_height_1_scale,
           data= essf,
           family = binomial,
           na.action=na.omit)
summary(glm14)
i=14
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + vegtype + proj_age_1_scale + proj_height_1_scale"
table.glm[i,3]<-AIC(glm14)


table.glm$delta.aic<- table.glm$AIC - min(table.glm$AIC)
table.glm[order(table.glm$delta.aic),]

# TOP MODEL IS glm13: tave08 * ppt08 + vegtype + live_stand_volume_125_scale + proj_height_1_scale


####################################################
##### TOP MODEL####

essf_red<-essf %>% drop_na(live_stand_volume_125_scale, proj_age_1_scale, vegtype)

glm_best<- glm(fire_pres ~ scale(tave08) * scale(ppt08) +
             vegtype +
             live_stand_volume_125_scale +
             proj_age_1_scale,
           data= essf_red,
           family = binomial,
           na.action=na.omit)
summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


essf_red$resids<-resid(glm_best)

binnedplot (essf_red$live_stand_volume_125_scale, 
            essf_red$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (essf_red$proj_age_1_scale, 
            essf_red$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


### Residual plots are not amazing...
```


## BEC ZONE SBS

```{r sbs climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for SBS were mean_tmax07_tmax08
sbs<- dat %>%
  filter(zone=="SBS")

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(sbs, aes(mean_tmax07_tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Mean Tmax_07 and Tmax_08") + ylab("Pr (ignition)")
p

hist(sbs$mean_tmax07_tmax08)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(dat, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(dat, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(dat, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(dat$proj_age_1, breaks=30)
hist(dat$live_stand_volume_125, breaks=30)

```

```{r sbs model fits}
################################
#### Fitting statistical models
################################

glm1<- glm(fire_pres ~ mean_tmax07_tmax08, 
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_tmax07_tmax08"
table.glm[1,3]<-AIC(glm1)
binnedplot (fitted(glm1), 
            residuals(glm1), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm1")

#veg_variables<- c("vegtype", "proj_age_1", "proj_height_1", "live_stand_volume_125", "subzone")

glm2<- glm(fire_pres ~ mean_tmax07_tmax08 +
             vegtype, 
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype"
table.glm[i,3]<-AIC(glm2)
binnedplot (fitted(glm2), 
            residuals(glm2), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm2")

glm3<- glm(fire_pres ~ mean_tmax07_tmax08 +
             proj_age_1, 
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + proj_age_1"
table.glm[i,3]<-AIC(glm3)

glm4<- glm(fire_pres ~ mean_tmax07_tmax08 +
             proj_height_1, 
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + proj_height_1"
table.glm[i,3]<-AIC(glm4)

glm5<- glm(fire_pres ~ mean_tmax07_tmax08 +
             live_stand_volume_125, 
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + live_stand_volume_125"
table.glm[i,3]<-AIC(glm5)

glm6<- glm(fire_pres ~ mean_tmax07_tmax08 +
             live_stand_volume_125 +
             proj_age_1,
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + live_stand_volume_125 + proj_age_1"
table.glm[i,3]<-AIC(glm6)

glm7<- glm(fire_pres ~ mean_tmax07_tmax08 +
             live_stand_volume_125 +
             proj_height_1,
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + live_stand_volume_125 + proj_height_1"
table.glm[i,3]<-AIC(glm7)

glm8<- glm(fire_pres ~ mean_tmax07_tmax08 +
             proj_age_1 +
             proj_height_1,
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + proj_height_1 + proj_age_1"
table.glm[i,3]<-AIC(glm8)

glm9<- glm(fire_pres ~ mean_tmax07_tmax08 +
             vegtype +
             live_stand_volume_125,
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + live_stand_volume_125"
table.glm[i,3]<-AIC(glm9)

glm10<- glm(fire_pres ~ mean_tmax07_tmax08 +
             vegtype +
             proj_age_1,
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + proj_age_1"
table.glm[i,3]<-AIC(glm10)

glm11<- glm(fire_pres ~ mean_tmax07_tmax08 +
              vegtype + 
              proj_height_1,
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + proj_height_1"
table.glm[i,3]<-AIC(glm11)

glm12<- glm(fire_pres ~ mean_tmax07_tmax08 +
             vegtype +
             live_stand_volume_125 +
             proj_age_1,
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + live_stand_volume_125 + proj_age_1"
table.glm[i,3]<-AIC(glm12)

glm13<- glm(fire_pres ~ mean_tmax07_tmax08 +
             vegtype +
             live_stand_volume_125 +
             proj_height_1,
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm13)
i=13
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + live_stand_volume_125 + proj_height_1"
table.glm[i,3]<-AIC(glm13)

glm14<- glm(fire_pres ~ mean_tmax07_tmax08 +
             vegtype +
             proj_age_1 +
             proj_height_1,
           data= sbs,
           family = binomial,
           na.action=na.omit)
summary(glm14)
i=14
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + proj_age_1 + proj_height_1"
table.glm[i,3]<-AIC(glm14)

table.glm$delta.aic<- table.glm$AIC - min(table.glm$AIC)
table.glm[order(table.glm$delta.aic),]

# TOP MODEL IS glm13: mean_tmax07_tmax08 + vegtype + live_stand_volume_125 + proj_age_1


####################################################
##### TOP MODEL####

sbs_red<-sbs %>% drop_na(live_stand_volume_125, proj_age_1, vegtype)

glm_best<- glm(fire_pres ~ mean_tmax07_tmax08 +
             vegtype +
             live_stand_volume_125 +
             proj_age_1,
           data= sbs_red,
           family = binomial,
           na.action=na.omit)
summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


sbs_red$resids<-resid(glm_best)

binnedplot (sbs_red$live_stand_volume_125, 
            sbs_red$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (sbs_red$proj_age_1, 
            sbs_red$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))
# this one has a slight up down trend. Ill try to scale proj_age_1 and see if this helps

glm_best_scale<- glm(fire_pres ~ mean_tmax07_tmax08 +
             vegtype +
             scale(live_stand_volume_125) +
             scale(proj_age_1),
           data= sbs_red,
           family = binomial,
           na.action=na.omit)
summary(glm_best_scale)
binnedplot (fitted(glm_best_scale), 
            residuals(glm_best_scale), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = ("Binned Residual Plot - glm_best_log"))

sbs_red$resids_log<-resid(glm_best_scale)
binnedplot (scale(sbs_red$proj_age_1), 
            sbs_red$resids_log, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))
# BETTER I THINK! Also the AIC confirms this as it dropped by another 10 points.

# FINAL MODEL EQUATION TO USE IN FIRE PROJECTIONS IS:
# Pr(ignition) = logit^(-1)(-4.47115 + 
#       0.132*mean_tmax07_tmax08 + 
#       -1.12*vegtypeOP)

```

## BEC ZONE SBPS

```{r sbps climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for SBS were mean_tmax07_tmax08
sbps<- dat %>%
  filter(zone=="SBPS")

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(sbps, aes(mean_tmax05_tmax06_tmax07_tmax08_tmax09, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_tmax05_tmax06_tmax07_tmax08_tmax09") + ylab("Pr (ignition)")
p

hist(sbps$mean_tmax05_tmax06_tmax07_tmax08_tmax09)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(sbps, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(sbps, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(sbps, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(sbps$proj_age_1, breaks=30)
hist(sbps$live_stand_volume_125, breaks=30)

```

```{r sbps model fits}
################################
#### Fitting statistical models
################################

glm1<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09, 
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09"
table.glm[1,3]<-AIC(glm1)

glm2<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             vegtype, 
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype"
table.glm[i,3]<-AIC(glm2)

glm3<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             proj_age_1, 
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + proj_age_1"
table.glm[i,3]<-AIC(glm3)

glm4<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             proj_height_1, 
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + proj_height_1"
table.glm[i,3]<-AIC(glm4)

glm5<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             live_stand_volume_125, 
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + live_stand_volume_125"
table.glm[i,3]<-AIC(glm5)

glm6<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             live_stand_volume_125 +
             proj_age_1,
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + live_stand_volume_125 + proj_age_1"
table.glm[i,3]<-AIC(glm6)

glm7<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             live_stand_volume_125 +
             proj_height_1,
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + live_stand_volume_125 + proj_height_1"
table.glm[i,3]<-AIC(glm7)

glm8<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             proj_age_1 +
             proj_height_1,
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + proj_height_1 + proj_age_1"
table.glm[i,3]<-AIC(glm8)

glm9<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             vegtype +
             live_stand_volume_125,
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + live_stand_volume_125"
table.glm[i,3]<-AIC(glm9)

glm10<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             vegtype +
             proj_age_1,
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + proj_age_1"
table.glm[i,3]<-AIC(glm10)

glm11<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
              vegtype + 
              proj_height_1,
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + proj_height_1"
table.glm[i,3]<-AIC(glm11)

glm12<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             vegtype +
             live_stand_volume_125 +
             proj_age_1,
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + live_stand_volume_125 + proj_age_1"
table.glm[i,3]<-AIC(glm12)

glm13<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             vegtype +
             live_stand_volume_125 +
             proj_height_1,
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm13)
i=13
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + live_stand_volume_125 + proj_height_1"
table.glm[i,3]<-AIC(glm13)

glm14<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             vegtype +
             proj_age_1 +
             proj_height_1,
           data= sbps,
           family = binomial,
           na.action=na.omit)
summary(glm14)
i=14
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + proj_age_1 + proj_height_1"
table.glm[i,3]<-AIC(glm14)

table.glm$delta.aic<- table.glm$AIC - min(table.glm$AIC)
table.glm[order(table.glm$delta.aic),]

# TOP MODEL IS glm13: mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + live_stand_volume_125 + proj_age_1


####################################################
##### TOP MODEL####

sbps_red<-sbps %>% drop_na(live_stand_volume_125, proj_age_1, vegtype)

glm_best<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             vegtype +
             live_stand_volume_125 +
             proj_age_1,
           data= sbps_red,
           family = binomial,
           na.action=na.omit)
summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


sbps_red$resids<-resid(glm_best)

binnedplot (sbps_red$live_stand_volume_125, 
            sbps_red$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (sbps_red$proj_age_1, 
            sbps_red$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))
# this one has a slight up down trend. Ill try to scale proj_age_1 and see if this helps

glm_best_scale<- glm(fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 +
             vegtype +
             scale(live_stand_volume_125) +
             scale(proj_age_1),
           data= sbps_red,
           family = binomial,
           na.action=na.omit)
summary(glm_best_scale)
binnedplot (fitted(glm_best_scale), 
            residuals(glm_best_scale), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = ("Binned Residual Plot - glm_best_log"))

sbps_red$resids_log<-resid(glm_best_scale)
binnedplot (scale(sbps_red$proj_age_1), 
            sbps_red$resids_log, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))
# BETTER I THINK! Also the AIC confirms this as it dropped by another 10 points.

# FINAL MODEL EQUATION TO USE IN FIRE PROJECTIONS IS:
# Pr(ignition) = logit^(-1)(-4.47115 + 
#       0.132*mean_tmax05_tmax06_tmax07_tmax08_tmax09 + 
#       -1.12*vegtypeOP)

```

