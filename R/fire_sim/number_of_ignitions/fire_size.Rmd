---
title: "fire_size"
author: "Kyle Lochhead"
date: '2023-12-15'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source(here::here("R/functions/R_Postgres.R"))
library(data.table)
library(sf)
library(tidyverse)
library(rgeos)
library(rpostgis)
library(keyring)
library(bcdata)
```

## Supporting information

"Different containment strategies may result in more than one population of fires (i.e., mild and severe) and, hence, clustered outcome distributions"

"Extended attack fires are those that have escaped initial attack and for which duration exceeds two days and size exceeds four hectares and, therefore, require additional resources to contain. These fires account for around 93% total area burned by lightning fires, and a large percentage of suppression costs and damage."


## Data: merge in from fire_occurence.rmd
```{r}
library(sdmTMB)
data.count<-readRDS("data.lightning.rds")
number<-data.count[, .(nfires = sum(count)), by = 'FIRE_YEAR']
data.size<-readRDS("data.lightning.size.rds")
data.size<-merge(data.size, number, by.x = "FIRE_YEAR", by.y = "FIRE_YEAR", all.x =T )
data.size<-data.size[!is.na(CURRENT_SIZE),][flam.layer >0,][, coast:=0][frt==15, coast:=1][is.na(dec.layer), dec.layer:=0][is.na(mixed.layer), mixed.layer:=0][is.na(open.layer), open.layer:=0][,conif:=c1.layer + c2.layer + c3.layer+ c4.layer+c5.layer+ c7.layer][,lconif:=log(conif+1)][,dCMI3yr:=CMI - CMI3yr]

est_mu<-rast("est_rf.tif")
random.effect.n<-data.table(est_mu = est_mu[])[, pixelid:=seq_len(.N)]
data.size<-merge(data.size, random.effect.n, by.x = "pixelid", by.y = "pixelid", all.x = T)

data.size<-data.size[, pred_mu:= exp(-15.83 + -0.0833*CMI + -0.225*dCMI3yr  -1.07*coast + 0.274*lconif + log(flam.layer) + est_mu.layer)]

data.size<-data.size[, duration := FIRE_OUT_DATE - IGNITION_DATE]
data.size[duration<0, duration:=0]
data.size<-data.size[, ignit_month:= month(IGNITION_DATE)]

model.size <- data.size[!is.na(pred_mu),][, size:= log(CURRENT_SIZE)]
test.model.size<-model.size[CURRENT_SIZE > 1,c("size", "CURRENT_SIZE", "lconif", "TEMP_MAX", "CMI", "flam.layer", "CMI3yr", "dec.layer","c1.layer","c2.layer", "c3.layer","c4.layer","c5.layer","c7.layer","open.layer","dCMI3yr","CMD", "pred_mu", "frt", "coast", "flam_win.focal_sum", "DD18_sm", "CMD", "PPT_sm", "slash.layer", "nfires", "haz.layer", "FIRE_YEAR", "IGNITION_DATE", "FIRE_CENTRE", "CMI_MIN", "wetland", "duration", "x", "y", "ndt", "CMI05", "CMI06", "CMI07", "CMI08")]
fit.model.size<-test.model.size[is.na(duration),duration:=0]
```

# Models
Do the number of fires in a year means higher stress on supression resources and relate to the extreme fire size?

## NULL Model
```{r}
library(gamlss.nl)
n0<-gamlss(formula = CURRENT_SIZE ~  1,
           family = PARETO2o(),
           data = fit.model.size ,
           control = gamlss.control(c.crit = 0.01, n.cyc = 500))
wp(n0) #not good - too tail heavy
#Try a weibull
n0<-gamlss(formula = CURRENT_SIZE ~  1,
           family = WEI3(),
           data = fit.model.size ,
           control = gamlss.control(c.crit = 0.01, n.cyc = 500))
wp(n0)

#Let X be a Pareto rv. The transformation Y = g(X) = ln(X/λ) is a 1–1 transformation from X = {x | x > λ} to Y = {y | y > 0} with inverse X = g−1 (Y ) = λeY . The newly transformed Y variable will be exponentially distributed. Gamma rv are exponentially distributed when the shape parameter alpha =1
n0<-gamlss(formula = size ~  1,
           family = WEI3(),
           data = fit.model.size ,
           control = gamlss.control(c.crit = 0.05, n.cyc = 500))
wp(n0) #Slightly better with the log transformation

#Try a finite mixture model to capture the tails better. Using log transformation as the response scale wasn't fitting well even with over 4 components
library(gamlss.mx)
nm0_ga<-gamlssMX(formula = size ~  1 ,
           K=2,
           family = list(GA(), GA()),
           data = fit.model.size)
wp(nm0_ga , ylim.all = T)
plot.new() #individual components for gamma
curve(dgamma(x, shape = exp(1.848), scale = exp(-1.12)), from = 0, to = 13, col = "red")
curve(dgamma(x, shape = exp(0.8349), scale = exp(-0.1708)), from = 0, to = 13, col = "black", add=T)

plot.new() #mixture distribution for gamma
fyGA<-dMX(y=seq(0,13,0.01), mu=list(exp(1.848),exp(0.8349)), sigma=list(exp(-1.12 ), exp(-0.1708)), pi=list(0.283, 0.717 ), family=list("GA","GA") )
plot(fyGA~seq(0,13,.01), type="l")

nm0_wei<-gamlssMX(formula = size ~  1 ,
           K=2,
           family = list(WEI3(), WEI3()),
           data = fit.model.size)
wp(nm0_wei , ylim.all = T) # two components provide best fit
AIC(nm0_ga, nm0_wei)

plot.new() #individual components weibull
curve(dWEI3(x, mu= exp(1.779), sigma = exp(1.047)), from = 0, to = 13, col = "red", ylim =c(0,.4))
curve(dWEI3(x, mu = exp(0.702), sigma = exp(0.2331)), from = 0, to = 13, col = "black", add=T)

plot.new() #mixture distribution weibull
fyWEI<-dMX(y=seq(0,13,0.01), mu=list(exp(1.779),exp(0.702)), sigma=list(exp(1.047 ), exp(0.2331)), pi=list(0.367, 0.633 ), family=list("WEI3","WEI3") )
plot(fyWEI~seq(0,13,.01), type="l")

#### Are the components (latent effects) related to something?
###### Estimate the probability of k =1 (class membership) using the posterior probabilities and Bayes theorem
fit.model.size<-fit.model.size[, pr1:= dWEI3(size, mu = exp(1.779), sigma = exp(1.047))][, pr2:=dWEI3(size, mu = exp(0.702), sigma = exp(0.2331))][, probk1:= (0.367*pr1)/(0.367*pr1 + 0.633*pr2)][probk1 < 0.5, k:=2][probk1 >=0.5, k:=1]
test<-fit.model.size[,c("k", "IGNITION_DATE", "CMI", "dCMI3yr", "haz.layer", "DD18_sm", "TEMP_MAX", "FIRE_CENTRE", "nfires", "duration")]
ggplot(data = test, aes(x = as.factor(k), y = duration)) + geom_boxplot()
###### Seems to be associated with year, the number of fires and the duration of the burns where longer burn duration are associated with component 1 and shorter burn duration are associated with component 2. This is likely linked to fire suppression and fire severity?

#Simulate the finite mixture distribution
## Gamma mixture

mus_ga <- c(exp(1.848),exp(0.8349))
sigmas_ga <- c(exp(-1.12), exp(-0.1708))
n = nrow(fit.model.size)

test<-rbindlist(lapply(1:500, function(x){
   components_ga <- sample(1:2,prob=c(0.283, 0.717),size=n,replace=TRUE)
  samples_ga<-data.table(rGA(n, mu = mus_ga[components_ga], sigma =sigmas_ga[components_ga] ))$V1
data.table(rep =x, prop = 1:n/n, ex = sort(samples_ga))
}))
sim_ci_gamma<-test[, .(lower = quantile(ex,p =0.025), med = quantile(ex,p =0.5), upper = quantile(ex,p =0.975)), by = prop]


## Weibull mixture
mus_wei <- c(exp(1.779),exp(0.702))
sigmas_wei <- c(exp(1.047), exp(0.2331))
test_wei<-rbindlist(lapply(1:500, function(x){
  components <- sample(1:2,prob=c(0.3665, 0.6335),size=n,replace=TRUE)
  data.table(rep =x, prop = 1:n/n, ex = sort(rWEI3(n, mu = mus_wei[components], sigma =sigmas_wei[components] )))
}))
sim_ci_wei<-test_wei[, .(lower = quantile(ex,p =0.025), med = quantile(ex,p =0.5), upper = quantile(ex,p =0.975)), by = prop]

### ECDF for fire size
x = sort(fit.model.size$size)
x_gamm_lower = sort(sim_ci_gamma$lower)
x_gamma = sort(sim_ci_gamma$med)
x_gamm_upper = sort(sim_ci_gamma$upper)
x_wei_lower = sort(sim_ci_wei$lower)
x_wei = sort(sim_ci_wei$med)
x_wei_upper = sort(sim_ci_wei$upper)
n = sum(!is.na(x))
plot(exp(x), (1-(1:n)/n), type = 's', ylim = c(0.00001, 1), xlim = c(0, 250000), 
     xlab = 'Fire Size (ha)', ylab = 'Pr(Fire Size > x)', 
     main = 'Empirical Cumluative Distribution',log='y')

lines(exp(x_wei_lower), (1-(1:n)/n), col="red", lty = 2)
lines(exp(x_wei), (1-(1:n)/n), col="red", lwd =2)
lines(exp(x_wei_upper), (1-(1:n)/n), col="red", lty = 2)
lines(exp(x_gamm_lower), (1-(1:n)/n), col="blue", lty = 2)
lines(exp(x_gamma), (1-(1:n)/n), col="blue" , lwd =2)
lines(exp(x_gamm_upper), (1-(1:n)/n), col="blue", lty = 2)



dta_wei <- density(samples_wei$V1, na.rm = TRUE)
dta_ga <- density(samples_ga$V1, na.rm = TRUE)
dta_obs <- density(fit.model.size$size, na.rm = TRUE)
plot(dta_obs, ylim = c(0, max(dta_wei$y,dta_ga$y,dta_obs$y)))
lines(dta_ga,col="red",lwd=2)
lines(dta_wei,col="blue",lwd=2, lty = 2)
abline(0,100)
```

## Alternative model(s)
```{r}
fit.model.size<-fit.model.size[, ind_ndt:= 0]
fit.model.size<-fit.model.size[ndt ==3 | ndt ==4, ind_ndt:= 1]
n1_wei<-gamlss(formula = size ~ PPT_sm + CMI05 + CMI06 + CMI07 + CMI08,
           mu.link = "log",
           sigma.formula = ~ 1 + as.factor(ind_ndt) + CMI05 + CMI06 + CMI07 + CMI08,
           family = WEI3(),
           data = na.omit(fit.model.size),
           control = gamlss.control(c.crit = 0.0001, n.cyc = 5800))
wp(n1_wei, ylim.all = TRUE) # A number of deviations outsite 95% CI 

library(gamlss.mx)
set.seed(6)
nm1_wei<-gamlssMX(formula = size ~  1  + PPT_sm + dec.layer + pred_mu ,
           K=2,
           sigma.formula = ~ 1  ,
           family = list(WEI3(), WEI3()),
           data = na.omit(fit.model.size))

wp(nm1_wei, ylim.all = TRUE)
AIC(nm1_wei)
#plot(model.size[]$pred, model.size[]$CURRENT_SIZE)
#fyGA<-dMX(y=seq(0,12,.01), mu=list(1.253, 0.1876), sigma=list(exp(-1.219 ), exp(-0.1571)), pi=list(0.2738614, 0.7261386 ), family=list("WEI3","WEI3") )
#plot(fyGA~seq(0,12,.01), type="l")

nm1_wei_simulate<-fit.model.size[, mu1:=4.677e-01 +   7.198e-04*PPT_sm  -8.596e-05*dec.layer   + 1.138e+00*pred_mu  ][, sigma1:=  0.07383   +   0.02030*flam_win2   ][ , mu2:=2.1255538-0.0015742*PPT_sm   -0.0000119*dec.layer  -0.7986125*pred_mu ][, sigma2:= 1.55849-0.06071*flam_win2 ][, pixel_order:=seq_len(.N)][, c("size", "mu1", "sigma1", "mu2", "sigma2", "pixel_order", "x", "y", "duration", "frt", "wetland", "flam_win.focal_sum", "CMI", "flam.layer", "nfires", "IGNITION_DATE")]

nm1_wei_simulate<-nm1_wei_simulate[, pr1:= dWEI3(size, mu = exp(mu1), sigma = exp(sigma1))][, pr2:=dWEI3(size, mu = exp(mu2), sigma = exp(sigma2))][, probk1:= (0.5978137*pr1)/(0.5978137*pr1 + 0.4021863*pr2)][probk1 < 0.5, k:=2][probk1 >=0.5, k:=1]

n=nrow( nm1_wei_simulate)
test_wei2<-rbindlist(lapply(1:1000, function(x){
  nm1_wei_simulate<-nm1_wei_simulate[ , k:= sample(1:2,prob=c(0.5978137, 0.4021863),size=1,replace=TRUE), by = seq_len(nrow(nm1_wei_simulate))]
  
  nm1_wei_simulate<-nm1_wei_simulate[k==1, mu_sim := exp(mu1)][k==1, sigma_sim := exp(sigma1)][k==2, mu_sim := exp(mu2)][k==2, sigma_sim := exp(sigma2)][, wei_sim:= rWEI3(1, mu = mu_sim, sigma =sigma_sim), by =seq_len(nrow(nm1_wei_simulate)) ]
  
  data.table(rep =x, pixel_order = nm1_wei_simulate$pixel_order,  ex = nm1_wei_simulate$wei_sim)
}))

sim_ci_wei2<-test_wei2[, .(lower = quantile(ex,p =0.025), med = quantile(ex,p =0.5), upper = quantile(ex,p =0.975)), by = pixel_order]
sim_ci_wei2<- merge(sim_ci_wei2, nm1_wei_simulate[, c("size", "pixel_order", "x", "y")], by= "pixel_order")
#using known class membership
ggplot(data = sim_ci_wei2, aes(x = med, y = size)) + geom_point() + geom_smooth()


##predicted cdfs
x <-sort(sim_ci_wei2$size)
x_wei = sort( sim_ci_wei2$med)
x_wei_lower = sort(sim_ci_wei2$lower)
x_wei_upper = sort(sim_ci_wei2$upper)

n = sum(!is.na(x))
plot(exp(x), (1-(1:n)/n), type = 's', ylim = c(0.001, 1), xlim = c(0, 200000), 
     xlab = 'Fire Size (ha)', ylab = 'Pr(Fire Size > x)', 
     main = 'Empirical Cumluative Distribution',log='y')

lines(exp(x_wei_lower), (1-(1:n)/n), col="red", lty = 2)
lines(exp(x_wei), (1-(1:n)/n), col="red", lwd =2)
lines(exp(x_wei_upper), (1-(1:n)/n), col="red", lty = 2)

####map prediction
sim_ci_wei2<- merge(sim_ci_wei2, data.size[, c("pixelid", "x", "y")], by= c("x", "y"))
sim_ci_wei2<- merge(sim_ci_wei2, data.size[, c("pixelid", "x", "y")], by= c("x", "y"))

```