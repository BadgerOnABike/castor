---
title: "simplified fuel typing"
author: "Kyle Lochhead"
date: '2024-01-09'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### A simple fuel type
Beverly et al. (2022) showed that distance to hazzardous fuel types are the best predictor of fire exposure. While the Pessaki Fuel Type Algorithm has been used in BC the main components of the classification are based on forest structural attributes: bec zone, species composition, density and height of the forest.

Simply coniferous and mixedwood fuel types are hazardous (Beverly et al. 2022), thus fuel typing may only need  bclcs_level_5 in ('TC', 'TM'), crown closure > 25% to indicate "dense or open" and height > 4 m to indicate not recently disturbed (O1-a/b).

```{r}
restest = c(100, 100)
prov.rast <- raster( # standardized provincial raster with no data in it
  nrows = 15744, ncols = 17216,
  xmn = 159587.5, xmx = 1881187.5,
  ymn = 173787.5, ymx = 1748187.5,
  crs = "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs",
  resolution = restest,
  vals = 0)

lapply(seq(2008, 2022, 1), function(x) {
  year_vri <- x
  geom_column <- 'shape'
  
  vri<- getSpatialQuery(glue::glue("SELECT 1 as hazard, {geom_column} FROM vri.veg_comp_lyr_r1_poly{year_vri} where proj_height_1 >=4 and crown_closure >= 25 and bclcs_level_4 in ('TM', 'TC');"))
  ras.haz<-fasterize::fasterize(vri, prov.rast, field = "hazard")
  rm(vri)
  gc()
  ras.haz[is.na(ras.haz[])]<-0
  ras.flame<-terra::crop(terra::aggregate(terra::rast(ras.haz), fact = 100, fun = sum ),prov.rast)
  writeRaster(ras.flame, glue::glue("hazard_{year_vri}_10k.tif "))
  x
})

```

