---
title: "15a_fire_escape_model_selection_NDT1_ALLPL_ALLTNT"
author: "Cora Skaien & Elizabeth Kleynhans"
date: "27/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Load relevant libraries
library(sf)
library(tidyverse)
library(ggplot2)
library(ggcorrplot)
library(RPostgreSQL)
library(rpostgis)
library(dplyr)
library(lme4)
library(arm)
library(ggpubr)
library(mgcv)
library(nlme)
library(purrr)
library(caret)
library(pROC)
library(keyring)
library(kableExtra)
library(data.table)
library(DBI)
library(here)
library(rje)
library(base)
library(car)
library(visreg)

source(here::here("R/functions/R_Postgres.R"))
```

<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

#=================================
#  Script Name: 12a_fire_escape_model_selection_NDT1_ALLPL_ALLTNT.R
#  Script Version: 1.0
#  Script Purpose: Model selection for escape by NDT.
#  Script Author: Cora Skaien, Ecological Modeling Specialist, Forest Analysis and Inventory Branch, B.C. Ministry of Forests, Lands, and Natural Resource Operations.
#=================================

To extract the veg categories I need spatial data. I can get the spatial data from the file below but not all climate data has been extracted. For now this is good enough for FRT13 and 14 for the Boundary TSA but i will have to go back and fix this to get the models for the rest of BC

```{r}
escape<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\Fire_escape_data_all.gpkg")

escape2<-escape %>% filter (fire_yr>2008 & fire_cs=="Lightning")

years<-c("2009","2010","2011","2013","2014","2015","2016","2017","2018","2019", "2020")

dat <- data.frame (matrix (ncol = 136, nrow = 0)) # add 'data' to the points
  colnames (dat) <- colnames(val)
  x<-data.frame(matrix(ncol=3, nrow=0))
  colnames(x)<- c("X", "Y", "veg_cat")
  dat<-cbind(dat, x)

for (i in 2: length(years)) {
  
ras<-raster(paste0( "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\spread\\","rast_ignit_", years[i], ".tiff", sep=""))

fire_spread_yr<-escape2 %>% filter(fire_yr == (as.numeric(years[i])+1))

x2<- st_centroid(fire_spread_yr)

x<-st_coordinates(x2)
test<-cbind(fire_spread_yr, x)
pointCoordinates<-data.frame(test$X, test$Y)
head(pointCoordinates)
#crs(pointCoordinates) #No CRS when a dataframe
##Extract Wind values from stacked layer
veg_cat=raster::extract(ras, pointCoordinates)
val<-cbind(test, veg_cat)

dat<-rbind(dat, val)
}

  #### now extract 2012 separately 
  ras<-raster(paste0( "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\spread\\","rast_ignit_2011", ".tiff", sep=""))

fire_spread_yr<-escape2 %>% filter(fire_yr == 2013)

x2<- st_centroid(fire_spread_yr)

x<-st_coordinates(x2)
test<-cbind(fire_spread_yr, x)
pointCoordinates<-data.frame(test$X, test$Y)

head(pointCoordinates)
#crs(pointCoordinates) #No CRS when a dataframe
##Extract Wind values from stacked layer
veg_cat=raster::extract(ras, pointCoordinates)
val<-cbind(test, veg_cat)

dat<-rbind(dat, val)
########

st_write(dat, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\Fire_escape_data_all_Feb2024.gpkg")

escape<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\Fire_escape_data_all_Feb2024_2.gpkg")

escape<-escape %>% distinct()

```


```{r}
# escape<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\escape_data_clean.csv")
# 
# escape2<-escape %>%
#   distinct(id, .keep_all = TRUE)
escape<-escape %>% rename(frt=Cluster)


escape2<-data.table(escape)

escape2<-escape2[!is.na(size_ha),]
escape2[size_ha>1.0, escape:=1]
escape2[size_ha<=1.0, escape:=0]
escape2[frt==9, frt:=11]
```

There are some spots where FRT was not categorized. So I import these points in QGIS and manually looked them up

#note there are a few ignitions in the months January and December. For now Im going to filter these out but maybe I should include them in the future. Presumabily non of these fires escape
```{r}
hist(as.numeric(escape2$ig_mnth))


ggplot(data = escape2, aes(as.numeric(as.character(ig_mnth)))) +
  geom_histogram() +
  facet_wrap(~frt, scales="free_y")



climate_variables_escape<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\climate_AIC_results_escape_summary_Oct23.csv") #This current file has all the possible models instead of the top one for each NDT as prior

escape2[frt==5, climate1:=(Tmax04+Tmax05)/2]
escape2[frt==5, climate2:=(PPT04+PPT05)/2] # I joined frt5 and 7
escape2[frt==7, climate1:=(Tmax04+Tmax05)/2]
escape2[frt==7, climate2:=(PPT04+PPT05)/2] # I joined frt5 and 7

escape2[frt==10, climate1:=(CMD04+CMD05+CMD06)/3]
escape2[frt==11, climate1:=Tave05] # I also joined frt 9 and 11
escape2[frt==11, climate2:=PPT05]
escape2[frt==12, climate1:=(Tmax04+Tmax05+Tmax06)/3]
escape2[frt==12, climate2:=(PPT04+PPT05+PPT06)/3]
escape2[frt==13, climate1:=(Tmax07+Tmax08)/2]
escape2[frt==13, climate2:=(PPT07+PPT08)/2]
escape2[frt==14, climate1:=(Tmax04+Tmax05+Tmax06)/3]
escape2[frt==14, climate2:=(PPT04+PPT05+PPT06)/3]
escape2[frt==15, climate1:=(CMD07 +CMD08)/2]

escape2[, aspect_cardinal:="O"]
escape2[aspect >315, aspect_cardinal:="N"]
escape2[aspect <=45, aspect_cardinal:="N"]
escape2[aspect >45 & aspect <=135, aspect_cardinal:="O"]
escape2[aspect >135 & aspect<=225, aspect_cardinal:="S"]
escape2[aspect >225 & aspect <=315, aspect_cardinal:="O"]

escape2$FWI_veg<-as.factor(escape2$FWI_veg)
escape2$aspect_cardinal<-as.factor((escape2$aspect_cardinal))
escape2$veg_cat<-as.factor(escape2$veg_cat)
escape2$bec_zone_code<-as.factor(escape2$bec_zone_code)

# before running any models wer are going to remove W and N because fires cannot spread on this landscape type.
escape2[frt==3, frt:=5]
#escape2<-escape2 %>% filter(!FWI_veg %in% c("W", "N"))
escape2$veg_escape<-paste(escape2$escape, escape2$veg_cat)

table(escape2$frt, escape2$veg_cat)

table(is.na(escape2$climate1))

#write.csv(escape2, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\escape_data_clean.csv")
```


################################ STAGE TWO ########################

#STAGE TWO: PUT TOGETHER MORE VARIABLES AND MANUALLY ASSESS
Now choose the top variables and create final model. The below code will need to be updated manually, depending on what the results of the above analyses are. From the top models, we will re-create two-way interactions for the variables selected from each model, plus the other variables listed as needed to be included. We will assess each set to ensure only interactions that make sense are investigated ultimately, given that sample sizes will be an issues.

Top Variables common to most:
1. climate1 + climate2 + vegtype2
2. Slope + elevation + wind_atfire
3. Road dist


#Next investigation
Because there would be far too many models to investigate including all variables and their interactions, we will start with the above and make educated guesses for what may need to be enhanced. We will seek the best model from the above informed progress.


#### FRT 5 and 7 joined because the number of ignitions in 7 are fairly low 
```{r}

escape_frt5<- escape2 %>% filter(frt %in% c(5,7) & !veg_cat %in% c(0,6))
table(escape_frt5$FWI_veg, escape_frt5$escape)
table(escape_frt5$veg_cat, escape_frt5$escape)

escape_frt5<-escape_frt5[bclcs_level_1!="W"]
escape_frt5<-escape_frt5[!bclcs_level_5 %in% c("BR", "GL", "TA", "Bl", "MZ", "LB", "RS", "LS", "RM", "BE", "LL", "GP", "TZ", "UR", "AP", "MI")]

escape_frt5[frt==5, climate1:=(Tmax04+Tmax05)/2]
escape_frt5[frt==5, climate2:=(PPT04+PPT05)/2]

table(is.na(escape_frt5$climate1))
table(is.na(escape_frt5$elevatn))
table(is.na(escape_frt5$veg_cat))
table(is.na(escape_frt5$road_dist_m))
table(is.na(escape_frt5$slope))
table(is.na(escape_frt5$escape))
table(escape_frt5$frt)


cor.test(escape_frt5$climate1, escape_frt5$elevatn)
cor.test(escape_frt5$climate2, escape_frt5$elevatn)
cor.test(escape_frt5$climate1, escape_frt5$slope)
cor.test(escape_frt5$elevatn, escape_frt5$slope)
cor.test(escape_frt5$road_dist_m, escape_frt5$infr_dist)

ggplot(escape_frt5, aes(x=as.factor(escape), y=infr_dist)) + 
  geom_boxplot()

ggplot(escape_frt5, aes(x=as.factor(escape), y=road_dist_m)) + 
  geom_boxplot()
ggplot(escape_frt5, aes(x=as.factor(escape), y=infr_dist)) + 
  geom_boxplot()


escape_frt5$log_road<-log(escape_frt5$road_dist_m+1)
escape_frt5$log_infra<-log(escape_frt5$infr_dist+1)

escape_frt5$veg_escape<-paste(escape_frt5$escape, escape_frt5$veg_cat)
table(escape_frt5$veg_escape)

escape_frt5$veg_cat<-as.factor(escape_frt5$veg_cat)
escape_frt5$bec_zone_code<-as.factor(escape_frt5$bec_zone_code)
escape_frt5$aspect_cardinal<-as.factor(escape_frt5$aspect_cardinal)
escape_frt5$frt<-as.factor(escape_frt5$frt)

# note all fires except 1 in frt5 and 7 are in the BWBS bec zone. so  I need to leave out bec

#Run model using dat1
model_ft5<-glm(escape ~ climate1 + climate2 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt5)

model_ft5a<-glm(escape ~ climate1* veg_cat + climate2 + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt5)

model_ft5b<-glm(escape ~ climate1 + climate2*veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt5)

model_ft5c<-glm(escape ~ climate1 + climate2 + veg_cat * conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt5)

model_ft5d<-glm(escape ~ climate1 + climate2 + veg_cat *proj_age_1 + conifer_pct_cover_total + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt5)

model_ft5d2<-glm(escape ~ climate1 + climate2 + veg_cat + proj_age_1 * conifer_pct_cover_total + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt5)


AIC(model_ft5, model_ft5a, model_ft5b, model_ft5c, model_ft5d, model_ft5d2)

Anova(model_ft5c, type=3)

model_ft5e<-glm(escape ~  climate2 + veg_cat * conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt5)
Anova(model_ft5e)
model_ft5f<-glm(escape ~  climate2 + veg_cat * conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn +infr_dist, family = binomial, data = escape_frt5)
Anova(model_ft5f)
model_ft5g<-glm(escape ~  climate2 + veg_cat * conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal +infr_dist, family = binomial, data = escape_frt5)
Anova(model_ft5g)
model_ft5h<-glm(escape ~  climate2 + veg_cat * conifer_pct_cover_total + proj_age_1 + aspect_cardinal +infr_dist, family = binomial, data = escape_frt5)
Anova(model_ft5h)
model_ft5i<-glm(escape ~  climate2 + veg_cat * conifer_pct_cover_total + proj_age_1 +infr_dist, family = binomial, data = escape_frt5)
Anova(model_ft5i)
model_ft5j<-glm(escape ~  climate2 + veg_cat * conifer_pct_cover_total + proj_age_1, family = binomial, data = escape_frt5)
Anova(model_ft5j)
AIC(model_ft5, model_ft5a, model_ft5b, model_ft5c, model_ft5d, model_ft5e, model_ft5f, model_ft5g, model_ft5h, model_ft5i, model_ft5j)

visreg(model_ft5i)
visreg(model_ft5i, "conifer_pct_cover_total", by="veg_cat")

#######################
### TOP MODEL
#######################
model_ft5j<-glm(escape ~  climate2 + veg_cat * conifer_pct_cover_total + proj_age_1, family = binomial, data = escape_frt5)
visreg(model_ft5j)
visreg(model_ft5j, "conifer_pct_cover_total", by="veg_cat")

```


```{r}
# model diagnostic plots
binnedplot (fitted(model_ft5i), 
            residuals(model_ft5i), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft5i)

#Create a new blank table and get AUC too
top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_veg2",
                                         "coef_veg3",
                                         "coef_veg4",
                                         "coef_veg5",
                                         "coef_conifer_pct_cover",
                                         "coef_age",
                                         "coef_dist_infr",
                                         "veg2:conifer_pct_cover",
                                         "veg3:conifer_pct_cover",
                                         "veg4:conifer_pct_cover",
                                         "veg5:conifer_pct_cover",
                                         "AUC")

escape_frt5<-as.data.frame(escape_frt5)
```

Let's run it 500 times to get good mean values.

```{r}

for (g in 1:500){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt5$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt5[ trainIndex,]
   Valid <- escape_frt5[-trainIndex,]
   
#Model   
model.FRT5<-glm(escape ~  climate2 + veg_cat * conifer_pct_cover_total + proj_age_1 + infr_dist, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT5, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT5 <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_veg2",
                                         "coef_veg3",
                                         "coef_veg4",
                                         "coef_veg5",
                                         "coef_conifer_pct_cover",
                                         "coef_age",
                                     "coef_dist_infr",
                                         "veg2:conifer_pct_cover",
                                         "veg3:conifer_pct_cover",
                                         "veg4:conifer_pct_cover",
                                         "veg5:conifer_pct_cover",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT5[1,1]<-"5"
top_mod_table_FRT5[1,2]<-"climate2 + veg_cat * conifer_pct_cover + proj_age_1 + dist_infr" 
top_mod_table_FRT5[1,3]<- coef(model.FRT5)[1] #Intercept
top_mod_table_FRT5[1,4]<- coef(model.FRT5)[2] #
top_mod_table_FRT5[1,5]<- coef(model.FRT5)[3] #
top_mod_table_FRT5[1,6]<- coef(model.FRT5)[4] #coefficient 
top_mod_table_FRT5[1,7]<- coef(model.FRT5)[5] #coefficient 
top_mod_table_FRT5[1,8]<- coef(model.FRT5)[6] #coefficient
top_mod_table_FRT5[1,9]<- coef(model.FRT5)[7] #
top_mod_table_FRT5[1,10]<- coef(model.FRT5)[8] #coefficient 
top_mod_table_FRT5[1,11]<- coef(model.FRT5)[9] #coefficient
top_mod_table_FRT5[1,12]<- coef(model.FRT5)[10] #coefficient 
top_mod_table_FRT5[1,13]<- coef(model.FRT5)[11] #coefficient
top_mod_table_FRT5[1,14]<- coef(model.FRT5)[12] 
top_mod_table_FRT5[1,15]<- coef(model.FRT5)[13] 
top_mod_table_FRT5[1,16]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

```

Check.
```{r}
head(top_mod_table_FRT5_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT5_ALL)
str(top_mod_table_FRT5_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)

FRT5_summary_table_mean$FRT<-5
FRT5_summary_table_mean$Model_terms<-"escape ~ climate2 + veg_cat * conifer_pct_cover_total + proj_age_1 + dist_infr"

```

Save table.

```{r}
write.csv(FRT5_summary_table_mean, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT5_escape.csv")


```


# note FRT 9 was joined with FRT 11 because of lack of data for both locations and because they are next to one another in the north.


#### FRT 10
```{r}
escape_frt10<- escape2 %>% filter(frt ==10 & !veg_cat %in% c(0,6))
table(escape_frt10$FWI_veg, escape_frt10$escape)
table(escape_frt10$veg_cat, escape_frt10$escape)

escape_frt10<-escape_frt10[bclcs_level_1!="W"]
escape_frt10<-escape_frt10[!bclcs_level_5 %in% c("BR", "GL", "TA", "Bl", "MZ", "LB", "RS", "LS", "RM", "BE", "LL", "GP", "TZ", "UR", "AP", "MI")]

table(is.na(escape_frt10$climate1))
table(is.na(escape_frt10$elevatn))
table(is.na(escape_frt10$FWI_veg))
table(is.na(escape_frt10$win_sum))
table(is.na(escape_frt10$road_dist_m))
table(is.na(escape_frt10$slope))
#table(is.na(escape_frt10$fire_cs))
table(is.na(escape_frt10$escape))

cor.test(escape_frt10$road_dist_m, escape_frt10$infr_dist)
cor.test(escape_frt10$climate1, escape_frt10$slope)
cor.test(escape_frt10$climate1, escape_frt10$elevatn)

table(escape_frt10$bec_zone_code, escape_frt10$escape)


escape_frt10$log_infra<-log(escape_frt10$infr_dist+1)

# Run models
model_ft10<-glm(escape ~ climate1 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt10)

model_ft10b<-glm(escape ~ climate1 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +log_infra, family = binomial, data = escape_frt10)

model_ft10c<-glm(escape ~ climate1 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt10)

model_ft10d<-glm(escape ~ climate1 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + log(road_dist_m+1) +log_infra, family = binomial, data = escape_frt10)

AIC(model_ft10, model_ft10b, model_ft10c, model_ft10d)

model_ft10e<-glm(escape ~ climate1 * veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +log_infra, family = binomial, data = escape_frt10)

model_ft10f<-glm(escape ~ climate1 + veg_cat * conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +log_infra, family = binomial, data = escape_frt10)

AIC(model_ft10b,model_ft10e,model_ft10f)
Anova(model_ft10e, type=3)

model_ft10g<-glm(escape ~ climate1 * veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m, family = binomial, data = escape_frt10)
Anova(model_ft10g, type=3)

model_ft10h<-glm(escape ~ climate1 * veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + road_dist_m, family = binomial, data = escape_frt10)
Anova(model_ft10h, type=3)

model_ft10i<-glm(escape ~ climate1 * veg_cat + conifer_pct_cover_total + proj_age_1 + slope + road_dist_m, family = binomial, data = escape_frt10)
Anova(model_ft10i, type=3)

model_ft10j<-glm(escape ~ climate1 * veg_cat + proj_age_1 + slope + road_dist_m, family = binomial, data = escape_frt10)
Anova(model_ft10j, type=3)

model_ft10k<-glm(escape ~ climate1 * veg_cat + slope + road_dist_m, family = binomial, data = escape_frt10)
Anova(model_ft10k, type=3)

model_ft10l<-glm(escape ~ climate1 * veg_cat + road_dist_m, family = binomial, data = escape_frt10)
Anova(model_ft10l, type=3)

visreg(model_ft10l)
visreg(model_ft10l, "climate1", by="veg_cat")


#######################
### TOP MODEL
#######################
#Remove least term ~ slope

model_ft10<-glm(escape ~ climate1 * veg_cat + road_dist_m, family = binomial, data = escape_frt10) # 724.7146

hist(escape_frt10$climate1)
hist(escape_frt10$road_dist_m)

ggplot(escape_frt10, aes(x=as.character(escape), y=climate1)) +
  geom_boxplot() 

table(escape_frt10$escape) #0 = 475 and 1 = 171 not bad actually.

# model diagnostic plots
binnedplot (fitted(model_ft10), 
            residuals(model_ft10), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")


```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft10)

#Create a new blank table and get AUC too
top_mod_table_FRT10_ALL <- data.frame (matrix (ncol = 10, nrow = 0))
colnames (top_mod_table_FRT10_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_veg4",
                                         "coef_veg5",
                                         "coef_road_dist",
                                         "coef_climate1:veg4",
                                         "coef_climate1:veg5",
                                         "AUC")

escape_frt10<-as.data.frame(escape_frt10)
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:500){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt10$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt10[ trainIndex,]
   Valid <- escape_frt10[-trainIndex,]
   
#Model   
model.FRT10<-glm(escape ~ climate1 * veg_cat + road_dist_m, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT10, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT10 <- data.frame (matrix (ncol = 10, nrow = 0))
colnames (top_mod_table_FRT10 ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_veg4",
                                         "coef_veg5",
                                         "coef_road_dist",
                                         "coef_climate1:veg4",
                                         "coef_climate1:veg5",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT10[1,1]<-"10"
top_mod_table_FRT10[1,2]<-"escape ~ climate1 * veg_cat + road_dist_m" 
top_mod_table_FRT10[1,3]<- coef(model.FRT10)[1] 
top_mod_table_FRT10[1,4]<- coef(model.FRT10)[2] 
top_mod_table_FRT10[1,5]<- coef(model.FRT10)[3] 
top_mod_table_FRT10[1,6]<- coef(model.FRT10)[4] 
top_mod_table_FRT10[1,7]<- coef(model.FRT10)[5] 
top_mod_table_FRT10[1,8]<- coef(model.FRT10)[6]
top_mod_table_FRT10[1,9]<- coef(model.FRT10)[7] 
top_mod_table_FRT10[1,10]<- mod.auc

top_mod_table_FRT10_ALL<-rbind(top_mod_table_FRT10_ALL, top_mod_table_FRT10)

}

```

Check.
```{r}
head(top_mod_table_FRT10_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT10_ALL)
str(top_mod_table_FRT10_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT10_ALL<- top_mod_table_FRT10_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT10_ALL$FRT<-10
summary_top_mod_table_FRT10_ALL$Model_terms<-"climate1 * veg_cat + road_dist_m" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT10_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT10_escape.csv")
```

#### FRT 11

```{r}
escape_frt11<- escape2 %>% filter(frt==11 & !veg_cat %in% c(0,6))
escape_frt11[,climate1:=(CMI04 + CMI05 + CMI06 + CMI07)/4]
escape_frt11[,climate2:=(PPT04 + PPT05+PPT06+PPT07)/4]

ggplot(escape_frt11, aes(as.numeric(ig_mnth), fill = as.factor(escape))) +
  geom_histogram()

ggplot(escape_frt11, aes(x=as.factor(escape), y=Tave05)) +
  geom_boxplot()

ggplot(escape_frt11, aes(x=as.factor(escape), y=climate2)) +
  geom_boxplot()

ggplot(escape_frt11, aes(x=as.factor(escape), y=(CMI04 + CMI05 + CMI06 + CMI07)/4)) +
  geom_boxplot()

table(is.na(escape_frt11$climate1))
table(is.na(escape_frt11$elevatn))
table(is.na(escape_frt11$FWI_veg))
table(is.na(escape_frt11$win_sum))
table(is.na(escape_frt11$road_dist_m))
table(is.na(escape_frt11$slope))

escape_frt11$log_road<-log(escape_frt11$road_dist_m+1)
escape_frt11$log_infr<- log(escape_frt11$infr_dist+1)

cor.test(escape_frt11$road_dist_m, escape_frt11$infr_dist) # correlated 0.72
cor.test(escape_frt11$climate1, escape_frt11$elevatn) # elevation and climate are correlated -0.84
cor.test(escape_frt11$climate2, escape_frt11$elevatn)
cor.test(escape_frt11$elevatn, escape_frt11$slope)
cor.test(escape_frt11$climate1, escape_frt11$climate2)

ggplot(escape_frt11, aes(x=as.factor(escape), y=road_dist_m)) +
  geom_boxplot()

ggplot(escape_frt11, aes(x=as.factor(escape), y=infr_dist)) +
  geom_boxplot()

ggplot(escape_frt11, aes(x=as.factor(escape), y=log(infr_dist+1))) +
  geom_boxplot()

hist(escape_frt11$infr_dist)
hist(log(escape_frt11$infr_dist+1))

# there is one rainfall value that is way bigger tan the others and Im worried its driving the patterns so Ill remove it
#escape_frt11<-escape_frt11[climate2<150,]


#Run model using dat1 checking if log road or log infrastructure is better
#Run model using dat1
escape_frt11[veg_cat=="3", veg_cat:="1"]
escape_frt11[veg_cat=="2", veg_cat:="1"]

model_ft11_1<-glm(escape ~ climate1 + elevatn + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + road_dist_m +infr_dist, family = binomial, data = escape_frt11)

model_ft11_2<-glm(escape ~ climate2 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt11)
AIC(model_ft11_1,model_ft11_2)
visreg(model_ft11_1)

model_ft11<-glm(escape ~  climate1 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt11)

model_ft11b<-glm(escape ~ climate1 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +log(escape_frt11$infr_dist+1), family = binomial, data = escape_frt11)

model_ft11c<-glm(escape ~ climate1 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)

model_ft11d<-glm(escape ~ climate1 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + log(road_dist_m+1) +log(infr_dist+1), family = binomial, data = escape_frt11)

AIC(model_ft11, model_ft11b, model_ft11c, model_ft11d)

model_ft11e<-glm(escape ~ climate1 * veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)

model_ft11f<-glm(escape ~ climate1 + veg_cat * conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)

AIC(model_ft11c,model_ft11e,model_ft11f)
Anova(model_ft11c, type=3)

#rm %conifer
model_ft11g<-glm(escape ~ climate1 + veg_cat + proj_age_1 + slope + aspect_cardinal + elevatn + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)
Anova(model_ft11g, type=3)

# rm age
model_ft11h<-glm(escape ~ climate1 + veg_cat + slope + aspect_cardinal + elevatn + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)
Anova(model_ft11h, type=3)

#rm aspect
model_ft11i<-glm(escape ~ climate1 + veg_cat + slope + elevatn + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)
Anova(model_ft11i, type=3)

model_ft11j<-glm(escape ~ climate1 + veg_cat + slope + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)
Anova(model_ft11j, type=3)

model_ft11k<-glm(escape ~ climate1 + slope + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)
Anova(model_ft11k, type=3)
visreg(model_ft11k)

model_ft11l<-glm(escape ~ slope + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)
Anova(model_ft11l, type=3)
visreg(model_ft11l)

model_ft11m<-glm(escape ~ log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11)
Anova(model_ft11m, type=3)

AIC(model_ft11c,model_ft11d,model_ft11e,model_ft11f,model_ft11g, model_ft11h, model_ft11i, model_ft11j, model_ft11k, model_ft11l, model_ft11m)

#best model is i

visreg(model_ft11k)
setorder(escape_frt11, cols = - "climate2")   

model_ft11<-glm(escape ~ climate1 + slope + log(road_dist_m+1) +infr_dist, family = binomial, data = escape_frt11) # 818
Anova(model_ft11, type=3)


#######################
### TOP MODEL
#######################
#Remove least term ~ slope

hist(escape_frt11$infr_dist)

table(escape_frt11$escape) 

# model diagnostic plots
binnedplot (fitted(model_ft11), 
            residuals(model_ft11), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

escape_frt11<- escape_frt11 %>% drop_na(proj_age_1)
escape_frt11$resids<-resid(model_ft11)

binnedplot (escape_frt11$proj_age_1, 
            escape_frt11$resids,  
            nclass = NULL)

binnedplot (escape_frt11$infr_dist, 
            escape_frt11$resids,  
            nclass = NULL)

# Diagnostic plots look good
```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft11)

#Create a new blank table and get AUC too
top_mod_table_FRT11_ALL <- data.frame (matrix (ncol = 8, nrow = 0))
colnames (top_mod_table_FRT11_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate1",
                                          "coef_slope",
                                          "coef_log_dist_road",
                                         "coef_dist_infra",
                                         "AUC")

escape_frt11<-as.data.frame(escape_frt11)
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:500){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt11$escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt11[ trainIndex,]
   Valid <- escape_frt11[-trainIndex,]
   
#Model   
model.FRT11<-glm(escape ~ climate1 + slope + log(road_dist_m+1) +infr_dist, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT11, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT11 <- data.frame (matrix (ncol = 8, nrow = 0))
colnames (top_mod_table_FRT11 ) <-  c ("FRT", "Model_terms", "intercept",
                                          "coef_climate1",
                                          "coef_slope",
                                          "coef_log_dist_road",
                                         "coef_dist_infra",
                                         "AUC")


##Add data for NDT1
top_mod_table_FRT11[1,1]<-"11"
top_mod_table_FRT11[1,2]<-"escape ~ climate1 + slope + log(road_dist_m+1) +infr_dist" 
top_mod_table_FRT11[1,3]<- coef(model.FRT11)[1] #Intercept
top_mod_table_FRT11[1,4]<- coef(model.FRT11)[2] #
top_mod_table_FRT11[1,5]<- coef(model.FRT11)[3] #
top_mod_table_FRT11[1,6]<- coef(model.FRT11)[4] #
top_mod_table_FRT11[1,7]<- coef(model.FRT11)[5] #
top_mod_table_FRT11[1,8]<- mod.auc

top_mod_table_FRT11_ALL<-rbind(top_mod_table_FRT11_ALL, top_mod_table_FRT11)

}

```

Check.
```{r}
head(top_mod_table_FRT11_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT11_ALL)
str(top_mod_table_FRT11_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT11_ALL<- top_mod_table_FRT11_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT11_ALL$FRT<-11
summary_top_mod_table_FRT11_ALL$Model_terms<-"escape ~ climate1 + slope + log(road_dist_m+1) +infr_dist" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT11_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT11_escape.csv")
```

#### FRT 12
```{r}
escape_frt12<- escape2 %>% filter(frt ==12 & !veg_cat %in% c(0,6))
table(escape_frt12$FWI_veg, escape_frt12$escape)
table(escape_frt12$veg_cat, escape_frt12$escape)

escape_frt12<-escape_frt12[bclcs_level_1!="W"]
escape_frt12<-escape_frt12[!bclcs_level_5 %in% c("BR", "GL", "TA", "Bl", "MZ", "LB", "RS", "LS", "RM", "BE", "LL", "GP", "TZ", "UR", "AP", "MI")]

escape_frt12$log_road<-log(escape_frt12$road_dist_m+1)
escape_frt12$log_infr<-log(escape_frt12$infr_dist+1)

table(is.na(escape_frt12$climate1))
table(is.na(escape_frt12$elevatn))
table(is.na(escape_frt12$FWI_veg))
table(is.na(escape_frt12$win_sum))
table(is.na(escape_frt12$road_dist_m))
table(is.na(escape_frt12$slope))
table(is.na(escape_frt12$escape))

cor.test(escape_frt12$road_dist_m, escape_frt12$infr_dist)
cor.test(escape_frt12$log_road, escape_frt12$log_infr)
cor.test(escape_frt12$climate1, escape_frt12$climate2)
cor.test(escape_frt12$climate1, escape_frt12$elevatn) 
cor.test(escape_frt12$elevatn, escape_frt12$climate2)

#Run model 
# Run models
model_ft12<-glm(escape ~ climate1 + climate2 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +infr_dist, family = binomial, data = escape_frt12)

model_ft12b<-glm(escape ~ climate1 + climate2 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +log_infr, family = binomial, data = escape_frt12)

model_ft12c<-glm(escape ~ climate1 + climate2 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + log_road +infr_dist, family = binomial, data = escape_frt12)

model_ft12d<-glm(escape ~ climate1 + climate2 + veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + log_road +log_infr, family = binomial, data = escape_frt12)

AIC(model_ft12, model_ft12b, model_ft12c, model_ft12d)

model_ft12e<-glm(escape ~ climate1 * veg_cat + climate2 + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +log_infr, family = binomial, data = escape_frt12)

model_ft12f<-glm(escape ~ climate1 + climate2 + veg_cat * conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +log_infr, family = binomial, data = escape_frt12)

model_ft12g<-glm(escape ~ climate1 + climate2 * veg_cat + conifer_pct_cover_total + proj_age_1 + slope + aspect_cardinal + elevatn + road_dist_m +log_infr, family = binomial, data = escape_frt12)

AIC(model_ft12b,model_ft12e,model_ft12f, model_ft12g)
Anova(model_ft12g, type=3)

model_ft12h<-glm(escape ~ climate1 + climate2 * veg_cat + conifer_pct_cover_total + slope + aspect_cardinal + elevatn + road_dist_m +log_infr, family = binomial, data = escape_frt12)
Anova(model_ft12h, type=3)

model_ft12i<-glm(escape ~ climate1 + climate2 * veg_cat + conifer_pct_cover_total + slope + elevatn + road_dist_m +log_infr, family = binomial, data = escape_frt12)
Anova(model_ft12i, type=3)

model_ft12j<-glm(escape ~ climate1 + climate2 * veg_cat + slope + elevatn + road_dist_m +log_infr, family = binomial, data = escape_frt12)
Anova(model_ft12j, type=3)

model_ft12k<-glm(escape ~ climate2 * veg_cat + slope + elevatn + road_dist_m +log_infr, family = binomial, data = escape_frt12)
Anova(model_ft12k, type=3)

escape_frt12[veg_cat=="3",veg_cat:="2"]

model_ft12l<-glm(escape ~ climate2 * veg_cat + elevatn + road_dist_m +log_infr, family = binomial, data = escape_frt12)
Anova(model_ft12l, type=3)
visreg(model_ft12l)
visreg(model_ft12l, "climate2", by="veg_cat")

AIC(model_ft12c, model_ft12d, model_ft12e, model_ft12f, model_ft12g, model_ft12h, model_ft12i, model_ft12j, model_ft12k, model_ft12l)




#######################
### TOP MODEL
#######################
#Remove least term ~ slope
hist(escape_frt12$climate2)
hist(escape_frt12$win_sum)
hist(escape_frt12$infr_dist)
hist(escape_frt12$road_dist_m)

ggplot(escape_frt12, aes(x=as.factor(escape), y=road_dist_m)) +
  geom_boxplot()
ggplot(escape_frt12, aes(x=as.factor(escape), y=log_infr)) +
  geom_boxplot()

# model diagnostic plots
binnedplot (fitted(model_ft12l), 
            residuals(model_ft12l), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")


```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft12l)

#Create a new blank table and get AUC too
top_mod_table_FRT12_ALL <- data.frame (matrix (ncol = 14, nrow = 0))
colnames (top_mod_table_FRT12_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_2",
                                         "coef_veg2",
                                         "coef_veg4",
                                         "coef_veg5",
                                         "coef_elevation",
                                         "coef_road_dist",
                                         "coef_log_infr",
                                         "coef_climate2:veg2",
                                         "coef_climate2:veg4",
                                         "coef_climate2:veg5",
                                         "AUC")

escape_frt12<-as.data.frame(escape_frt12)
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:500){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt12$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt12[ trainIndex,]
   Valid <- escape_frt12[-trainIndex,]
   
#Model   
model.FRT12<-glm(escape ~ climate2 * veg_cat + elevatn + road_dist_m +log_infr, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT12, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT12 <- data.frame (matrix (ncol = 14, nrow = 0))
colnames (top_mod_table_FRT12 ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_2",
                                         "coef_veg2",
                                         "coef_veg4",
                                         "coef_veg5",
                                         "coef_elevation",
                                         "coef_road_dist",
                                         "coef_log_infr",
                                         "coef_climate2:veg2",
                                         "coef_climate2:veg4",
                                         "coef_climate2:veg5",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT12[1,1]<-"12"
top_mod_table_FRT12[1,2]<-"escape ~ climate2 * veg_cat + elevatn + road_dist_m +log_infr" 
top_mod_table_FRT12[1,3]<- coef(model.FRT12)[1] #Intercept
top_mod_table_FRT12[1,4]<- coef(model.FRT12)[2] #
top_mod_table_FRT12[1,5]<- coef(model.FRT12)[3] #
top_mod_table_FRT12[1,6]<- coef(model.FRT12)[4] #coefficient 
top_mod_table_FRT12[1,7]<- coef(model.FRT12)[5] #coefficient 
top_mod_table_FRT12[1,8]<- coef(model.FRT12)[6] #Intercept
top_mod_table_FRT12[1,9]<- coef(model.FRT12)[7] #
top_mod_table_FRT12[1,10]<- coef(model.FRT12)[8] #
top_mod_table_FRT12[1,11]<- coef(model.FRT12)[9] #coefficient 
top_mod_table_FRT12[1,12]<- coef(model.FRT12)[10] #coefficient 
top_mod_table_FRT12[1,13]<- coef(model.FRT12)[11] #Intercept
top_mod_table_FRT12[1,14]<- mod.auc
top_mod_table_FRT12_ALL<-rbind(top_mod_table_FRT12_ALL, top_mod_table_FRT12)

}

```

Check.
```{r}
head(top_mod_table_FRT12_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT12_ALL)
str(top_mod_table_FRT12_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT12_ALL<- top_mod_table_FRT12_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT12_ALL$FRT<-12

summary_top_mod_table_FRT12_ALL$Model_terms<-"escape ~ climate2 * veg_cat + elevatn + road_dist_m +log_infr" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT12_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT12_escape.csv")
```


#### FRT 13
```{r}
escape_frt13<- escape2 %>% filter(frt==13 & !veg_cat %in% c(0,6))
table(escape_frt13$FWI_veg, escape_frt13$escape)

escape_frt13<-escape_frt13[bclcs_level_1!="W"]
escape_frt13<-escape_frt13[!bclcs_level_5 %in% c("BR", "GL", "TA", "Bl", "MZ", "LB", "RS", "LS", "RM", "BE", "LL", "GP", "TZ", "UR", "AP", "MI")]

escape_frt13[is.na(proj_age_1),c("bclcs_level_1", "bclcs_level_4","species_cd_1", "species_pct_1", "conifer_pct_cover_total", "veg_cat", "proj_age_1")]
escape_frt13[veg_cat==5 & is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]
escape_frt13[veg_cat==5 & is.na(proj_age_1), proj_age_1:=0]
escape_frt13<-(escape_frt13[!is.na(proj_age_1),])
escape_frt13[is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]



# escape_frt13$FWI_veg[escape_frt13$FWI_veg=="C-1"]<-"C-3"
# escape_frt13$veg_escape<-paste(escape_frt13$escape, escape_frt13$FWI_veg)
# escape_frt13$FWI_veg <- factor(escape_frt13$FWI_veg, levels=c("C-3", "C-2","C-5", "C-7","D-1/2", "M-1/2", "O-1a/b", "S-1"))

table(escape_frt13$veg_cat, escape_frt13$escape)
table(escape_frt13$bec_zone_code, escape_frt13$escape)

table(is.na(escape_frt13$climate1))
table(is.na(escape_frt13$elevatn))
table(is.na(escape_frt13$FWI_veg))
table(is.na(escape_frt13$road_dist_m))
table(is.na(escape_frt13$slope))
table(is.na(escape_frt13$escape))

ggplot(escape_frt13, aes(x=as.factor(escape), y=climate1)) +
  geom_boxplot()

ggplot(escape_frt13, aes(x=as.factor(escape), y=climate2)) +
  geom_boxplot()

ggplot(escape_frt13, aes(x=as.factor(escape), y=((CMI05+CMI06+CMI07)/3))) +
  geom_boxplot()



# start here

cor.test(escape_frt13$road_dist_m,escape_frt13$infr_dist)
cor.test(escape_frt13$climate1, escape_frt13$elevatn) # these are almost correlated 0.69!
cor.test(escape_frt13$climate2, escape_frt13$elevatn) 
cor.test(escape_frt13$climate1, escape_frt13$climate2)
cor.test(escape_frt13$elevatn, escape_frt13$slope)
cor.test(escape_frt13$win_sum, escape_frt13$win_spg) # very correlated
cor.test(escape_frt13$elevatn, escape_frt13$infr_dist)
cor.test(escape_frt13$log_road,escape_frt13$log_infr)

escape_frt13$log_road<-log(escape_frt13$road_dist_m+1)
escape_frt13$log_infr<- log(escape_frt13$infr_dist+1)
escape_frt13$veg_cat<-as.factor(escape_frt13$veg_cat)

escape_frt13[veg_cat=="3", veg_cat:="2"]
escape_frt13[veg_cat=="2", veg_cat:="1"]

escape_frt13[bec_zone_code=="SBPS", bec_zone_code:="SBS"]
escape_frt13[bec_zone_code=="BWBS", bec_zone_code:="IDF"]
escape_frt13[bec_zone_code=="BAFA", bec_zone_code:="CMA"]
escape_frt13[bec_zone_code=="IMA", bec_zone_code:="CMA"]
escape_frt13[bec_zone_code=="MH", bec_zone_code:="CWH"]
table(escape_frt13$bec_zone_code, escape_frt13$escape)
#Run model using dat1 
# note I tried climate 1 but the relationship is in the wrong direction and its fairly correlated with dem. So I choose to leave it out
model_ft13<-glm(escape ~  climate2 + veg_cat  + slope + elevatn + aspect_cardinal + log_road + log_infr + conifer_pct_cover_total + proj_age_1 + bec_zone_code , family = binomial, data = escape_frt13)

Anova(model_ft13, type=3)
AIC(model_ft13)

model_ft13_1<-glm(escape ~  climate2 * veg_cat  + slope + elevatn + aspect_cardinal + log_road + log_infr + conifer_pct_cover_total + proj_age_1 +bec_zone_code , family = binomial, data = escape_frt13)
Anova(model_ft13_1, type=3)
AIC(model_ft13_1)

model_ft13_2<-glm(escape ~  climate2  + elevatn + veg_cat  + slope + aspect_cardinal + log_road + log_infr + proj_age_1 +bec_zone_code, family = binomial, data = escape_frt13)
Anova(model_ft13_2, type=3)

model_ft13_3<-glm(escape ~  climate2  + elevatn + veg_cat  + slope + aspect_cardinal + log_road + log_infr +bec_zone_code, family = binomial, data = escape_frt13)
Anova(model_ft13_3, type=3)
visreg(model_ft13_3)

model_ft13_4<-glm(escape ~  climate2  + elevatn + veg_cat  + slope + aspect_cardinal + log_infr +bec_zone_code, family = binomial, data = escape_frt13)
Anova(model_ft13_4, type=3)
visreg(model_ft13_4)


model_ft13_5<-glm(escape ~  climate2  + veg_cat + slope + elevatn + aspect_cardinal + log_infr , family = binomial, data = escape_frt13)
Anova(model_ft13_5, type=3)


model_ft13_8<-glm(escape ~  climate2  + FWI_veg + slope + elevatn + aspect_cardinal + log_road * log_infr , family = binomial, data = escape_frt13)

model_ft13_9<-glm(escape ~  climate2  + bec_zone_code + slope + elevatn + aspect_cardinal + log_road + log_infr , family = binomial, data = escape_frt13)
Anova(model_ft13_9, type=3)

model_ft13_10<-glm(escape ~  climate2  + bec_zone_code + slope + elevatn + aspect_cardinal + log_infr + veg_cat, family = binomial, data = escape_frt13)
Anova(model_ft13_10, type=3)
visreg(model_ft13_10)


AIC(model_ft13,model_ft13_2, model_ft13_3,model_ft13_4, model_ft13_5,model_ft13_8, model_ft13_9,model_ft13_10)


# Top model is model_ft13_4
model_ft13_4<-glm(escape ~  climate2  + bec_zone_code + slope + elevatn + aspect_cardinal + log_infr, family = binomial, data = escape_frt13)
visreg(model_ft13_4)



#######################
### TOP MODEL
#######################
hist(escape_frt13$climate2)

# model diagnostic plots
binnedplot (fitted(model_ft13_4), 
            residuals(model_ft13_4), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")


```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft13_4)

#Create a new blank table and get AUC too
top_mod_table_FRT13_ALL <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table_FRT13_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_bec_CWH",
                                         "coef_bec_ESSF",
                                         "coef_bec_ICH",
                                         "coef_bec_IDF",
                                         "coef_bec_MS",
                                         "coef_bec_SBS",
                                         "coef_slope",
                                         "coef_elevation",
                                         "coef_aspect_O",
                                         "coef_aspect_S",
                                         "coef_log_infr",
                                         "AUC")

escape_frt13<-as.data.frame(escape_frt13)

```

Let's run it 100 times to get good mean values.

```{r}
prop<-0.75

for (g in 1:500){
  
  print(g)

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt13$escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt13[ trainIndex,]
   Valid <- escape_frt13[-trainIndex,]
   
#Model   
model.FRT13<-glm(escape ~  climate2  + bec_zone_code + slope + elevatn + aspect_cardinal + log_infr, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT13, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT13 <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table_FRT13 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_bec_CWH",
                                         "coef_bec_ESSF",
                                         "coef_bec_ICH",
                                         "coef_bec_IDF",
                                         "coef_bec_MS",
                                         "coef_bec_SBS",
                                         "coef_slope",
                                         "coef_elevation",
                                         "coef_aspect_O",
                                         "coef_aspect_S",
                                         "coef_log_infr",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT13[1,1]<-"13"
top_mod_table_FRT13[1,2]<-"escape ~  climate2  + bec_zone_code + slope + elevatn + aspect_cardinal + log_infr" 
top_mod_table_FRT13[1,3]<- coef(model.FRT13)[1] #Intercept
top_mod_table_FRT13[1,4]<- coef(model.FRT13)[2] #
top_mod_table_FRT13[1,5]<- coef(model.FRT13)[3] #
top_mod_table_FRT13[1,6]<- coef(model.FRT13)[4] #coefficient 
top_mod_table_FRT13[1,7]<- coef(model.FRT13)[5] #coefficient 
top_mod_table_FRT13[1,8]<- coef(model.FRT13)[6] #Intercept
top_mod_table_FRT13[1,9]<- coef(model.FRT13)[7] #
top_mod_table_FRT13[1,10]<- coef(model.FRT13)[8] #
top_mod_table_FRT13[1,11]<- coef(model.FRT13)[9] #
top_mod_table_FRT13[1,12]<- coef(model.FRT13)[10] #coefficient 
top_mod_table_FRT13[1,13]<- coef(model.FRT13)[11] #coefficient 
top_mod_table_FRT13[1,14]<- coef(model.FRT13)[12] #Intercept
top_mod_table_FRT13[1,15]<- coef(model.FRT13)[13] #
top_mod_table_FRT13[1,16]<- mod.auc
top_mod_table_FRT13_ALL<-rbind(top_mod_table_FRT13_ALL, top_mod_table_FRT13)

}

```

Check.
```{r}
head(top_mod_table_FRT13_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT13_ALL)
str(top_mod_table_FRT13_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT13_ALL<- top_mod_table_FRT13_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT13_ALL$FRT<-13

summary_top_mod_table_FRT13_ALL$Model_terms<-"escape ~  climate2  + bec_zone_code + slope + elevatn + aspect_cardinal + log_infr" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT13_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT13_escape.csv")
```


#### FRT 14
```{r}
escape_frt14<- escape2 %>% filter(frt==14 & !veg_cat %in% c(0,6))
escape_frt14<-escape_frt14[bclcs_level_1!="W"]
escape_frt14<-escape_frt14[!bclcs_level_5 %in% c("BR", "GL", "TA", "Bl", "MZ", "LB", "RS", "LS", "RM", "BE", "LL", "GP", "TZ", "UR", "AP", "MI")]

escape_frt14[is.na(proj_age_1),c("bclcs_level_1", "bclcs_level_4","species_cd_1", "species_pct_1", "conifer_pct_cover_total", "veg_cat", "proj_age_1")]
escape_frt14[veg_cat==5 & is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]
escape_frt14[veg_cat==5 & is.na(proj_age_1), proj_age_1:=0]
escape_frt14<-(escape_frt14[!is.na(proj_age_1),])
escape_frt14[is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]
table(escape_frt14$bec_zone_code, escape_frt14$escape)
escape_frt14[bec_zone_code=="ESSF", bec_zone_code:="ICH"]
escape_frt14$veg_cat<-as.factor(escape_frt14$veg_cat)
table(escape_frt14$veg_cat, escape_frt14$escape)
# because there are only a few 2 and 3 veg cat types ill combine them
escape_frt14[veg_cat=="3", veg_cat:="2"]

cor.test(escape_frt14$road_dist_m, escape_frt14$infr_dist)
cor.test(escape_frt14$climate1, escape_frt14$elevatn) # these are correlated!
cor.test(escape_frt14$climate2, escape_frt14$elevatn)
cor.test(escape_frt14$elevatn, escape_frt14$slope)
hist(as.numeric(escape_frt14$ig_mnth))

escape_frt14$log_road<-log(escape_frt14$road_dist_m+1)
escape_frt14$log_infr<- log(escape_frt14$infr_dist+1)
cor.test(escape_frt14$log_infr, escape_frt14$log_road)

table(is.na(escape_frt14$climate1))
table(is.na(escape_frt14$elevatn))
table(is.na(escape_frt14$FWI_veg))
table(is.na(escape_frt14$win_sum))
table(is.na(escape_frt14$road_dist_m))
table(is.na(escape_frt14$slope))
table(is.na(escape_frt14$escape))

# Try various models
model_ft14_1<-glm(escape ~   climate1 + climate2 + veg_cat  + slope + aspect_cardinal + log_road + log_infr + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt14)

model_ft14_2<-glm(escape ~  climate2 + veg_cat  + slope + elevatn + aspect_cardinal + log_road + log_infr + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt14)

model_ft14_3<-glm(escape ~  climate2 + veg_cat  + slope + elevatn + aspect_cardinal + road_dist_m + log_infr + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt14)

model_ft14_4<-glm(escape ~  climate2 + veg_cat  + slope + elevatn + aspect_cardinal + log_road + infr_dist + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt14)

model_ft14_5<-glm(escape ~  climate2 + veg_cat  + slope + elevatn + aspect_cardinal + road_dist_m + infr_dist + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt14)
AIC(model_ft14_1,model_ft14_2,model_ft14_3,model_ft14_4,model_ft14_5)

# the second model is slightly better with elev

# note the interaction between climate & veg is only significant if veg_cat=3 is present in the model and there are not very many observations of 3. So Im going to just leave the interaction out

model_ft14_3<-glm(escape ~  climate2 * veg_cat  + slope + elevatn + aspect_cardinal + log_road + log_infr + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt14)
Anova(model_ft14_3, type=3)

model_ft14_4<-glm(escape ~  climate2 + veg_cat * conifer_pct_cover_total + slope + elevatn + aspect_cardinal + log_road + log_infr + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt14)

model_ft14_5<-glm(escape ~  climate2 + veg_cat * proj_age_1 + slope + elevatn + aspect_cardinal + log_road + log_infr + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt14)
Anova(model_ft14_4, type=3)

AIC(model_ft14_2,model_ft14_3,model_ft14_4, model_ft14_5)
Anova(model_ft14_2)


# toss out age
model_ft14_5<-glm(escape ~  climate2 + veg_cat  + slope + elevatn + aspect_cardinal + log_road + log_infr + conifer_pct_cover_total + bec_zone_code, family = binomial, data = escape_frt14)
Anova(model_ft14_5, type=3)
#toss out conifer %
model_ft14_6<-glm(escape ~  climate2 + veg_cat  + slope + elevatn + aspect_cardinal + log_road + log_infr + bec_zone_code, family = binomial, data = escape_frt14)
Anova(model_ft14_6, type=3)

# toss out aspect
model_ft14_7<-glm(escape ~  climate2 + veg_cat  + slope + elevatn + log_road + log_infr + bec_zone_code, family = binomial, data = escape_frt14)
Anova(model_ft14_7, type=3)
visreg(model_ft14_7)

# toss out slope
model_ft14_8<-glm(escape ~  climate2 + veg_cat  + elevatn + log_road + log_infr + bec_zone_code, family = binomial, data = escape_frt14)

# toss out rd
model_ft14_9<-glm(escape ~  climate2 + veg_cat  + elevatn + log_infr + bec_zone_code, family = binomial, data = escape_frt14)
Anova(model_ft14_9, type=3)

model_ft14_10<-glm(escape ~  climate2 + veg_cat  + elevatn +aspect_cardinal + log_infr + bec_zone_code, family = binomial, data = escape_frt14)
Anova(model_ft14_10, type=3)
visreg(model_ft14_9)



AIC(model_ft14_1,model_ft14_2, model_ft14_3,model_ft14_4, model_ft14_5, model_ft14_6, model_ft14_7, model_ft14_8, model_ft14_9, model_ft14_10)


hist(escape_frt14$climate2)
hist(escape_frt14$road_dist_m)
hist(escape_frt14$infr_dist)

ggplot(escape_frt14, aes(x=as.character(escape), y=climate2)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape), y=slope)) + geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape), y=win_sum)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape), y=road_dist_m)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape), y=infr_dist)) + geom_boxplot()

# model diagnostic plots
binnedplot (fitted(model_ft14_9), 
            residuals(model_ft14_9), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft14_9)


#Create a new blank table and get AUC too
top_mod_table_FRT14_ALL <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table_FRT14_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_veg_cat2",
                                         "coef_veg_cat4",
                                         "coef_veg_cat5",
                                         "coef_elevation",
                                         "coef_log_infr",
                                         "coef_ICH",
                                         "coef_IDF",
                                         "coef_MS",
                                         "coef_PP",
                                         "coef_SBPS",
                                         "coef_SBS",
                                         "AUC")
escape_frt14<-as.data.frame(escape_frt14)
escape_frt14$escape_bec<-paste(escape_frt14$escape, escape_frt14$bec_zone_code)

```

Let's run it 100 times to get good mean values.

```{r}
prop<-0.75

for (g in 1:500){
  
  print(g)

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt14$escape_bec, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt14[ trainIndex,]
   Valid <- escape_frt14[-trainIndex,]
   
#Model   
model.FRT14<-glm(escape ~  climate2 + veg_cat  + elevatn + log_infr + bec_zone_code, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT14, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT14 <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table_FRT14 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_veg_cat2",
                                         "coef_veg_cat4",
                                         "coef_veg_cat5",
                                         "coef_elevation",
                                         "coef_log_infr",
                                         "coef_ICH",
                                         "coef_IDF",
                                         "coef_MS",
                                         "coef_PP",
                                         "coef_SBPS",
                                         "coef_SBS",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT14[1,1]<-"14"
top_mod_table_FRT14[1,2]<-"escape ~  climate2 + veg_cat  + elevatn + log_infr + bec_zone_code" 
top_mod_table_FRT14[1,3]<- coef(model.FRT14)[1] #Intercept
top_mod_table_FRT14[1,4]<- coef(model.FRT14)[2] #
top_mod_table_FRT14[1,5]<- coef(model.FRT14)[3] #
top_mod_table_FRT14[1,6]<- coef(model.FRT14)[4] #coefficient 
top_mod_table_FRT14[1,7]<- coef(model.FRT14)[5] #coefficient 
top_mod_table_FRT14[1,8]<- coef(model.FRT14)[6] #Intercept
top_mod_table_FRT14[1,9]<- coef(model.FRT14)[7] #
top_mod_table_FRT14[1,10]<- coef(model.FRT14)[8] #
top_mod_table_FRT14[1,11]<- coef(model.FRT14)[9] #coefficient 
top_mod_table_FRT14[1,12]<- coef(model.FRT14)[10] #coefficient 
top_mod_table_FRT14[1,13]<- coef(model.FRT14)[11] #Intercept
top_mod_table_FRT14[1,14]<- coef(model.FRT14)[12] #Intercept
top_mod_table_FRT14[1,15]<- coef(model.FRT14)[13] #Intercept
top_mod_table_FRT14[1,16]<- mod.auc
top_mod_table_FRT14_ALL<-rbind(top_mod_table_FRT14_ALL, top_mod_table_FRT14)

}

```

Check.
```{r}
head(top_mod_table_FRT14_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT14_ALL)
str(top_mod_table_FRT14_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT14_ALL<- top_mod_table_FRT14_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT14_ALL$FRT<-14
summary_top_mod_table_FRT14_ALL$Model_terms<-"escape ~  climate2 + veg_cat  + elevatn + log_infr + bec_zone_code" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT14_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT14_escape.csv")
```


#### FRT 15
```{r}
escape_frt15<- escape2 %>% filter(frt==15 & veg_cat != "0")

escape_frt15<-escape_frt15[bclcs_level_1!="W"]
escape_frt15<-escape_frt15[!bclcs_level_5 %in% c("BR", "GL", "TA", "Bl", "MZ", "LB", "RS", "LS", "RM", "BE", "LL", "GP", "TZ", "UR", "AP", "MI")]

escape_frt15[is.na(proj_age_1),c("bclcs_level_1", "bclcs_level_4","species_cd_1", "species_pct_1", "conifer_pct_cover_total", "veg_cat", "proj_age_1")]
escape_frt15[veg_cat==5 & is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]

escape_frt15[veg_cat==5 & is.na(proj_age_1), proj_age_1:=0]
escape_frt15<-(escape_frt15[!is.na(proj_age_1),])
escape_frt15[is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]
table(escape_frt15$bec_zone_code, escape_frt15$escape)
escape_frt15$veg_cat<-as.factor(escape_frt15$veg_cat)
table(escape_frt15$veg_cat, escape_frt15$escape)

table(escape_frt15$veg_cat, escape_frt15$escape)
# Remove veg type 6 since it is non-flamable
escape_frt15<-escape_frt15[veg_cat!="6",]


table(escape_frt15$veg_cat,escape_frt15$bec_zone_code, escape_frt15$escape)

escape_frt15$log_road<-log(escape_frt15$road_dist_m+1)
escape_frt15$log_infr<- log(escape_frt15$infr_dist+1)

ggplot(escape_frt15, aes(x=as.character(escape), y=(Tmax06 + Tmax07 + Tmax08)/3)) +
  geom_boxplot()

ggplot(escape_frt15, aes(x=as.character(escape), y=(PPT06 + PPT07 + PPT08)/3)) +
  geom_boxplot()

escape_frt15$climate1<-(escape_frt15$CMD07 + escape_frt15$CMD08)/2

ggplot(escape_frt15, aes(x=as.character(escape), y=climate1)) +
  geom_boxplot()


cor.test(escape_frt15$road_dist_m, escape_frt15$infr_dist)
cor.test(escape_frt15$climate1, escape_frt15$elevatn) 
cor.test(escape_frt15$elevatn, escape_frt15$slope)

table(is.na(escape_frt15$climate1))
table(is.na(escape_frt15$elevatn))
table(is.na(escape_frt15$log_infr))
table(is.na(escape_frt15$slope))
table(is.na(escape_frt15$escape))

hist(as.numeric(escape_frt15$ig_mnth))
table(as.numeric(escape_frt15$ig_mnth)) # most fires in july and aug so use win_sum

#escape_frt15<- escape_frt15 %>% filter(!is.na(elevatn))
#escape_frt15<- escape_frt15 %>% filter(!is.na(win_sum))


# Try various models
model_ft15_1<-glm(escape ~   climate1 + elevatn + veg_cat  + slope + aspect_cardinal + log_road + log_infr + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt15)

model_ft15_2<-glm(escape ~   climate1 + elevatn + veg_cat  + slope + aspect_cardinal + road_dist_m + log_infr + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt15)

model_ft15_3<-glm(escape ~   climate1 + elevatn + veg_cat  + slope + aspect_cardinal + log_road + infr_dist + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt15)

model_ft15_4<-glm(escape ~   climate1 + elevatn + veg_cat  + slope + aspect_cardinal + road_dist_m + infr_dist + conifer_pct_cover_total + proj_age_1 + bec_zone_code, family = binomial, data = escape_frt15)

AIC(model_ft15_1, model_ft15_2, model_ft15_3, model_ft15_4) 
Anova(model_ft15_2, type=3) 

model_ft15_5<-glm(escape ~   climate1 + elevatn + veg_cat  + slope + aspect_cardinal + road_dist_m + log_infr + conifer_pct_cover_total + bec_zone_code, family = binomial, data = escape_frt15)
Anova(model_ft15_5, type=3)

model_ft15_6<-glm(escape ~   climate1 + veg_cat  + slope + aspect_cardinal + road_dist_m + log_infr + conifer_pct_cover_total + bec_zone_code, family = binomial, data = escape_frt15)
Anova(model_ft15_6, type=3)

model_ft15_7<-glm(escape ~   climate1 + veg_cat  + slope + aspect_cardinal + log_infr + conifer_pct_cover_total + bec_zone_code, family = binomial, data = escape_frt15)
Anova(model_ft15_7, type=3)

model_ft15_8<-glm(escape ~   climate1 + veg_cat + aspect_cardinal + log_infr + conifer_pct_cover_total + bec_zone_code, family = binomial, data = escape_frt15)
Anova(model_ft15_8, type=3)
visreg(model_ft15_8)

model_ft15_9<-glm(escape ~   climate1 + veg_cat + aspect_cardinal + log_infr + bec_zone_code, family = binomial, data = escape_frt15)
Anova(model_ft15_9, type=3)
visreg(model_ft15_9)

# join veg_cat 2 and 3 because there are only 5 obs in each
escape_frt15[veg_cat=="3", veg_cat:="2"]

model_ft15_10<-glm(escape ~   climate1 + veg_cat + aspect_cardinal + log_infr + bec_zone_code, family = binomial, data = escape_frt15)
Anova(model_ft15_10, type=3)
visreg(model_ft15_10)

model_ft15_11<-glm(escape ~   climate1 + veg_cat + aspect_cardinal + log_infr, family = binomial, data = escape_frt15)
Anova(model_ft15_11, type=3)
visreg(model_ft15_11)

AIC(model_ft15_5, model_ft15_6, model_ft15_7, model_ft15_8, model_ft15_9,model_ft15_10, model_ft15_11) 


#######################
### TOP MODEL
#######################
model_ft15_10<-glm(escape ~   climate1 + veg_cat + aspect_cardinal + log_infr + bec_zone_code, family = binomial, data = escape_frt15)

hist(escape_frt15$slope)
hist(escape_frt15$climate1)
escape_frt15 %>%
  ggplot( aes(x=climate1, fill=as.factor(escape))) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity')

hist(escape_frt15$log_infr)

table(escape_frt15$escape) #0 = 948 and 1 = 267 not bad actually.

# model diagnostic plots
binnedplot (fitted(model_ft15_10), 
            residuals(model_ft15_10), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft15_10)


#Create a new blank table and get AUC too
top_mod_table_FRT15_ALL <- data.frame (matrix (ncol = 13, nrow = 0))
colnames (top_mod_table_FRT15_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_veg_cat2",
                                         "coef_veg_cat4",
                                         "coef_veg_cat5",
                                         "coef_aspect_O",
                                         "coef_aspect_S",
                                         "coef_log_infr",
                                         "coef_bec_CWH",
                                         "coef_bec_MH",
                                         "AUC")

escape_frt15<-as.data.frame(escape_frt15)
```

Let's run it 100 times to get good mean values.

```{r}
prop<-0.75

for (g in 1:500){
  
  print(g)
  
trainIndex <- createDataPartition(escape_frt15$escape, p = prop,
                                    list = FALSE,
                                    times = 1)
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  dat1 <- escape_frt15[ trainIndex,] # note only 6% of obs are 1's so Im going to sample to get my sample size up to 30% 1's.
   # in total I need 1589 1's
   dat1_1<-dat1 %>% filter(escape==1)
   dat1_0<-dat1 %>% filter(escape==0)
   dat1_1_samp<- sample_n(dat1_1, round(length(dat1$escape)*0.1,0), replace = TRUE)
   
   dat<-rbind(dat1_0, dat1_1_samp)
   Valid <- escape_frt15[-trainIndex,]
   
#Model   
model.FRT15<-glm(escape ~   climate1 + veg_cat + aspect_cardinal + log_infr + bec_zone_code, family = binomial, data = dat)

mod.valid <- predict.glm(model.FRT15, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT15 <- data.frame (matrix (ncol = 13, nrow = 0))
colnames (top_mod_table_FRT15 ) <-  c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_veg_cat2",
                                         "coef_veg_cat4",
                                         "coef_veg_cat5",
                                         "coef_aspect_O",
                                         "coef_aspect_S",
                                         "coef_log_infr",
                                         "coef_bec_CWH",
                                         "coef_bec_MH",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT15[1,1]<-"15"
top_mod_table_FRT15[1,2]<-"escape ~   climate1 + veg_cat + aspect_cardinal + log_infr + bec_zone_code" 

top_mod_table_FRT15[1,3]<- coef(model.FRT15)[1] #Intercept
top_mod_table_FRT15[1,4]<- coef(model.FRT15)[2] #
top_mod_table_FRT15[1,5]<- coef(model.FRT15)[3] #
top_mod_table_FRT15[1,6]<- coef(model.FRT15)[4] #coefficient 
top_mod_table_FRT15[1,7]<- coef(model.FRT15)[5] #
top_mod_table_FRT15[1,8]<- coef(model.FRT15)[6] #
top_mod_table_FRT15[1,9]<- coef(model.FRT15)[7] #coefficient 
top_mod_table_FRT15[1,10]<- coef(model.FRT15)[8] #
top_mod_table_FRT15[1,11]<- coef(model.FRT15)[9] #
top_mod_table_FRT15[1,12]<- coef(model.FRT15)[10] #coefficient 
top_mod_table_FRT15[1,13]<- mod.auc
top_mod_table_FRT15_ALL<-rbind(top_mod_table_FRT15_ALL, top_mod_table_FRT15)

}

```

Check.
```{r}
head(top_mod_table_FRT15_ALL)



```

Get mean values.

```{r}
names(top_mod_table_FRT15_ALL)
str(top_mod_table_FRT15_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT15_ALL<- top_mod_table_FRT15_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT15_ALL$FRT<-15
summary_top_mod_table_FRT15_ALL$Model_terms<-"escape ~   climate1 + veg_cat + aspect_cardinal + log_infr + bec_zone_code" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT15_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT15_escape.csv")
```
