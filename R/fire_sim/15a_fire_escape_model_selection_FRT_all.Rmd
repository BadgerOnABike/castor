---
title: "15a_fire_escape_model_selection_NDT1_ALLPL_ALLTNT"
author: "Cora Skaien & Elizabeth Kleynhans"
date: "27/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Load relevant libraries
library(sf)
library(tidyverse)
library(ggplot2)
library(ggcorrplot)
library(RPostgreSQL)
library(rpostgis)
library(dplyr)
library(lme4)
library(arm)
library(ggpubr)
library(mgcv)
library(nlme)
library(purrr)
library(tidyr)
library(caret)
library(pROC)
library(keyring)
library(ggcorrplot) 
library(kableExtra)
library(data.table)
library(DBI)
library(here)
library(AICcmodavg)
library(rje)
library(base)
library(car)
library(visreg)

source(here::here("R/functions/R_Postgres.R"))
```

<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

#=================================
#  Script Name: 12a_fire_escape_model_selection_NDT1_ALLPL_ALLTNT.R
#  Script Version: 1.0
#  Script Purpose: Model selection for escape by NDT.
#  Script Author: Cora Skaien, Ecological Modeling Specialist, Forest Analysis and Inventory Branch, B.C. Ministry of Forests, Lands, and Natural Resource Operations.
#=================================

Load in the prepped data.

```{r}
escape <- st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\escape_weather_veg.gpkg")
head(escape)
dim(escape)
escape$escape9<- NA
escape$escape9[escape$CURRENT_SIZE > 1.5] <- 1
escape$escape9[escape$CURRENT_SIZE <= 1.5] <- 0

escape<-escape %>% st_drop_geometry()



table(is.na(escape$Cluster)) # wierd there are 13 points that have no Cluster assigned to them. I looked at these points in Qgis and all but one of them are in FRT =15.
escape$Cluster[escape$idno==15511]<-13
escape$Cluster[escape$idno==31609]<-13
escape$Cluster[escape$idno==15214]<-13
escape$Cluster[escape$idno==15507]<-13
escape$Cluster[escape$idno==10828]<-13
escape$Cluster[escape$idno==119]<-14
escape$Cluster[escape$idno==20067]<-14
escape$Cluster[escape$idno==965]<-14
escape$Cluster[escape$idno==22140]<-14
escape$Cluster[escape$idno==26529]<-14
escape$Cluster[escape$idno==32226]<-14
escape$Cluster[escape$idno==27182]<-14
escape$Cluster[escape$idno==719]<-14
escape$Cluster[escape$idno==14884]<-14
escape$Cluster[escape$idno==23161]<-14
escape$Cluster[escape$idno==20054]<-14
escape$Cluster[escape$idno==21163]<-14
escape$Cluster[escape$idno==1832]<-14
escape$Cluster[escape$idno==31495]<-14

escape$Cluster[is.na(escape$Cluster)]<-15
escape$Cluster[escape$Cluster==3]<-5
escape$Cluster[escape$Cluster==9]<-11

# note Im going to combine frt9 and frt11. I re-ran the climate variable selection with both frt 9 and 11 combined results in the top climate variable being summer_Tave
#11,	summer_Tave,	mean_AIC=338.338939,	means_AUC=0.647411386,	sd_AUC=0.054643964,	delta_AIC=0

table(escape$Cluster)
table(escape$ig_mnth)
 
```

#note there are a few ignitions in the months January and December. For now Im going to filter these out but maybe I should include them in the future. Presumabily non of these fires escape
```{r}
hist(as.numeric(escape$ig_mnth))

ggplot(data = escape2, aes(as.numeric(as.character(ig_mnth)))) +
  geom_histogram() +
  facet_wrap(~Cluster, scales="free_y")


climate_escape<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\climate_AIC_results_escape_summary_March2023.csv")

escape$Cluster_numeric<-as.numeric(as.character(escape$Cluster))

escape$tot_spring_PPT<-escape$PPT04+ escape$PPT05 + escape$PPT06
escape$tot_summer_PPT<-escape$PPT07+ escape$PPT08 + escape$PPT09
escape$summer_Tmax<-(escape$Tmax07+ escape$Tmax08 + escape$Tmax09)/3
escape$summer_Tave<-(escape$Tave07+ escape$Tave08 + escape$Tave09)/3
escape$mean_MDC_05_MDC_06_MDC_07_MDC_08   <-(escape$MDC_05 + escape$MDC_06 + escape$MDC_07 + escape$MDC_08)/4


## Create empty vector
escape$climate1<-0
head(escape)

escape<-escape %>%
    mutate(climate1 = case_when(Cluster_numeric == 5 ~ as.numeric(PPT05), 
                                Cluster_numeric == 7 ~ as.numeric(PPT06), 
                                #Cluster_numeric == 9 ~ Tave05, 
                                Cluster_numeric == 10 ~ as.numeric(tot_spring_PPT),
                                Cluster_numeric == 11 ~ as.numeric(MDC_06), 
                                Cluster_numeric == 12 ~ summer_Tmax,
                                Cluster_numeric == 13 ~ summer_Tmax,
                                Cluster_numeric == 14 ~ as.numeric(mean_MDC_05_MDC_06_MDC_07_MDC_08),
                                Cluster_numeric == 15 ~ summer_Tave,
                                TRUE ~ NA_real_))

#Repeat for climate 2
escape$climate2<-0

#Perform mutate to get the applicable variable for each row
escape<-escape %>%
    mutate(climate2 = case_when(Cluster_numeric == 7 ~ as.numeric(Tave06),
                                Cluster_numeric == 12 ~ as.numeric(tot_summer_PPT),
                                Cluster_numeric == 13 ~ as.numeric(tot_summer_PPT),
                                Cluster_numeric == 15 ~ as.numeric(tot_summer_PPT),
                                TRUE ~ NA_real_))

head(escape)

# before running any models wer are going to remove W and N because fires cannot spread on this landscape type.

escape2<-escape %>% filter(FWI_veg != "W")
escape2$veg_escape<-paste(escape2$escape9, escape2$FWI_veg)
```


################################ STAGE TWO ########################

#STAGE TWO: PUT TOGETHER MORE VARIABLES AND MANUALLY ASSESS
Now choose the top variables and create final model. The below code will need to be updated manually, depending on what the results of the above analyses are. From the top models, we will re-create two-way interactions for the variables selected from each model, plus the other variables listed as needed to be included. We will assess each set to ensure only interactions that make sense are investigated ultimately, given that sample sizes will be an issues.

Top Variables common to most:
1. climate1 + climate2 + vegtype2
2. Slope + elevation + wind_atfire
3. Road dist


#Next investigation
Because there would be far too many models to investigate including all variables and their interactions, we will start with the above and make educated guesses for what may need to be enhanced. We will seek the best model from the above informed progress.


#### FRT 5
```{r}

escape_frt5<- escape2 %>% filter(Cluster==5)

table(is.na(escape_frt5$climate1))
table(is.na(escape_frt5$dem_ha_bc))
table(is.na(escape_frt5$FWI_veg))
table(is.na(escape_frt5$dist_roads_m))
table(is.na(escape_frt5$slope_ha_bc_3005))
table(is.na(escape_frt5$escape9))

cor.test(escape_frt5$climate1, escape_frt5$dem_ha_bc)
cor.test(escape_frt5$climate1, escape_frt5$slope_ha_bc_3005)
cor.test(escape_frt5$dem_ha_bc, escape_frt5$slope_ha_bc_3005)
cor.test(escape_frt5$dist_roads_m, escape_frt5$dist_infrastructure_m)

escape_frt5$log_road<-log(escape_frt5$dist_roads_m+1)
escape_frt5$log_infra<-log(escape_frt5$dist_infrastructure_m+1)

table(escape_frt5$FWI_veg, escape_frt5$escape9)

escape_frt5$FWI_veg[escape_frt5$FWI_veg=="C-7"]<-"D-1/2"

#escape_frt5<- escape_frt5 %>% filter(FWI_veg!="N")

#Run model using dat1
model_ft5<-glm(escape9 ~ climate1 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + win_spg + log_road +log_infra, family = binomial, data = escape_frt5)
# 1571

model_ft5<-glm(escape9 ~ climate1 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + win_spg + dist_roads_m +log_infra, family = binomial, data = escape_frt5)
# 1569

model_ft5<-glm(escape9 ~ climate1 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + win_spg + log_road +dist_infrastructure_m, family = binomial, data = escape_frt5)
# 1563

model_ft5<-glm(escape9 ~ climate1 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + win_spg + dist_roads_m +dist_infrastructure_m, family = binomial, data = escape_frt5)
# 1564

model_ft5<-glm(escape9 ~ climate1 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + win_spg + log_road +dist_infrastructure_m, family = binomial, data = escape_frt5)
AIC(model_ft5) #1563.224
Anova(model_ft5, type=3)

#chop win_spg
model_ft5b<-glm(escape9 ~ climate1 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + log_road +dist_infrastructure_m, family = binomial, data = escape_frt5)

AIC(model_ft5b) #1563.862
Anova(model_ft5b, type=3)

#chop slope
model_ft5c<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + log_road +dist_infrastructure_m, family = binomial, data = escape_frt5)
AIC(model_ft5c) #1562.108
Anova(model_ft5c, type=3)

#chop logroad
model_ft5d<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc +dist_infrastructure_m, family = binomial, data = escape_frt5)
AIC(model_ft5d) #1562.086
Anova(model_ft5d, type=3)

#######################
### TOP MODEL
#######################
model_ft5d<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc +dist_infrastructure_m, family = binomial, data = escape_frt5)

hist(escape_frt5$climate1)
escape_frt5<-escape_frt5 %>% drop_na(escape9)
hist(escape_frt5$dem_ha_bc)
hist(escape_frt5$dist_infrastructure_m)
hist(escape_frt5$log_road)

ggplot(escape_frt5, aes(x=as.character(escape9), y=climate1)) +
  geom_boxplot() #climate1 = PPT05
ggplot(escape_frt5, aes(x=as.character(escape9), y=dem_ha_bc)) +
  geom_boxplot() #climate1 = PPT05
ggplot(escape_frt5, aes(x=as.character(escape9), y=dist_infrastructure_m)) +
  geom_boxplot() 



table(escape_frt5$escape9) #0 = 699 and 1 = 500 not bad actually.
table(escape_frt5$FWI_veg)
```


```{r}
# model diagnostic plots
binnedplot (fitted(model_ft5d), 
            residuals(model_ft5d), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

escape_frt5<-escape_frt5 %>% drop_na(dem_ha_bc)
escape_frt5<-escape_frt5 %>% drop_na(escape9)
escape_frt5$resids<-resid(model_ft5d)

binnedplot (escape_frt5$climate1, 
            escape_frt5$resids, 
            nclass = NULL)

binnedplot (escape_frt5$dem_ha_bc, 
            escape_frt5$resids,  
            nclass = NULL)

binnedplot (escape_frt5$dist_infrastructure_m, 
            escape_frt5$resids,  
            nclass = NULL)

# Diagnostic plots look good

#Partial Residuals
library(visreg)
visreg(model_ft5d)

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft5d)

#Create a new blank table and get AUC too
top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 13, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_FWI_veg_C-2",
                                         "coef_FWI_veg_C-3",
                                         "coef_FWI_veg_D-1/2",
                                         "coef_FWI_veg_M-1/2",
                                         "coef_FWI_veg_N",
                                         "coef_FWI_veg_O-1a/b",
                                         "coef_elevation",
                                         "coef_dist_infra",
                                         "AUC")
```

Let's run it 500 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt5$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt5[ trainIndex,]
   Valid <- escape_frt5[-trainIndex,]
   
#Model   
model.FRT5<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + dist_infrastructure_m, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT5, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"escape9"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT5 <- data.frame (matrix (ncol = 13, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_FWI_veg_C-2",
                                         "coef_FWI_veg_C-3",
                                         "coef_FWI_veg_D-1/2",
                                         "coef_FWI_veg_M-1/2",
                                         "coef_FWI_veg_N",
                                         "coef_FWI_veg_O-1a/b",
                                         "coef_elevation",
                                         "coef_dist_infra",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT5[1,1]<-"5"
top_mod_table_FRT5[1,2]<-"escape16 ~ climate1 + FWI_veg + dem_ha_bc + log_road +dist_infrastructure_m" 
top_mod_table_FRT5[1,3]<- coef(model.FRT5)[1] #Intercept
top_mod_table_FRT5[1,4]<- coef(model.FRT5)[2] #
top_mod_table_FRT5[1,5]<- coef(model.FRT5)[3] #
top_mod_table_FRT5[1,6]<- coef(model.FRT5)[4] #coefficient 
top_mod_table_FRT5[1,7]<- coef(model.FRT5)[5] #coefficient 
top_mod_table_FRT5[1,8]<- coef(model.FRT5)[6] #coefficient
top_mod_table_FRT5[1,9]<- coef(model.FRT5)[7] #
top_mod_table_FRT5[1,10]<- coef(model.FRT5)[8] #coefficient 
top_mod_table_FRT5[1,11]<- coef(model.FRT5)[9] #coefficient
top_mod_table_FRT5[1,12]<- coef(model.FRT5)[10] #coefficient
top_mod_table_FRT5[1,13]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

```

Check.
```{r}
head(top_mod_table_FRT5_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT5_ALL)
str(top_mod_table_FRT5_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)

FRT5_summary_table_mean$FRT<-5
FRT5_summary_table_mean$Model_terms<-"escape16 ~ climate1 + FWI_veg + dem_ha_bc + dist_infrastructure_m"

```

Save table.

```{r}
write.csv(FRT5_summary_table_mean, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT5_escape.csv")
```


#### FRT 7
```{r}

escape_frt7<- escape2 %>% filter(Cluster==7)
table(escape_frt7$FWI_veg, escape_frt7$escape9)
#escape_frt7$FWI_veg[escape_frt7$FWI_veg=="C-1"]<-"C-3"
#escape_frt7$FWI_veg[escape_frt7$FWI_veg=="N"]<-"D-1/2"
escape_frt7$FWI_veg[escape_frt7$FWI_veg=="C-7"]<-"M-1/2"
escape_frt7$FWI_veg[escape_frt7$FWI_veg=="S-1"]<-"M-1/2"
escape_frt7$veg_escape<-paste(escape_frt7$fire, escape_frt7$FWI_veg)

table(is.na(escape_frt7$climate1))
table(is.na(escape_frt7$dem_ha_bc))
table(is.na(escape_frt7$FWI_veg))
table(is.na(escape_frt7$dist_roads_m))
table(is.na(escape_frt7$slope_ha_bc_3005))
table(is.na(escape_frt7$win_spg))
table(is.na(escape_frt7$escape9))


cor.test(escape_frt7$climate1, escape_frt7$dem_ha_bc)
cor.test(escape_frt7$climate1, escape_frt7$slope_ha_bc_3005)
cor.test(escape_frt7$climate2, escape_frt7$dem_ha_bc)
cor.test(escape_frt7$climate2, escape_frt7$slope_ha_bc_3005)
cor.test(escape_frt7$dem_ha_bc, escape_frt7$slope_ha_bc_3005)
cor.test(escape_frt7$dist_roads_m, escape_frt7$dist_infrastructure_m  )

escape_frt7$log_road<-log(escape_frt7$dist_roads_m+1)
escape_frt7$log_infr<-log(escape_frt7$dist_infrastructure_m  +1)

#Run model using dat1
model_ft7<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + log_road + log_infr + win_spg, family = binomial, data = escape_frt7)
#1431

model_ft7<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + dist_roads_m + log_infr + win_spg, family = binomial, data = escape_frt7)
# 1431

model_ft7<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + log_road + dist_infrastructure_m + win_spg, family = binomial, data = escape_frt7)
# 1432

model_ft7<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + dist_roads_m + dist_infrastructure_m + win_spg, family = binomial, data = escape_frt7) # 1432

model_ft7<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + log_road + log_infr + win_spg, family = binomial, data = escape_frt7)

AIC(model_ft7) #1431.374
Anova(model_ft7, type=3) 

#remove win_spg
model_ft7b<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + log_road + log_infr, family = binomial, data = escape_frt7)

AIC(model_ft7b) #1430.679
Anova(model_ft7b, type=3) 

#remove log_road
model_ft7c<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + dem_ha_bc + log_infr, family = binomial, data = escape_frt7)

AIC(model_ft7c) #1428.779
Anova(model_ft7c, type=3) 

# remove slope
model_ft7d<-glm(escape9 ~ climate1 + climate2 + FWI_veg + dem_ha_bc + log_infr, family = binomial, data = escape_frt7)

AIC(model_ft7d) #1427.393
Anova(model_ft7d, type=3) 

#remove elevation
model_ft7e<-glm(escape9 ~ climate1 + climate2 + FWI_veg + log_infr, family = binomial, data = escape_frt7)

AIC(model_ft7e) #1426.907
Anova(model_ft7e, type=3) 

# remove infra
model_ft7f<-glm(escape9 ~ climate1 + climate2 + FWI_veg, family = binomial, data = escape_frt7)

AIC(model_ft7f) #1427.029
Anova(model_ft7f, type=3) 

# remove infra
model_ft7f<-glm(escape9 ~ climate2 + FWI_veg, family = binomial, data = escape_frt7)

AIC(model_ft7f) #1427.029
Anova(model_ft7f, type=3) 


#######################
### TOP MODEL
#######################
model_ft7e<-glm(escape9 ~ climate2 + FWI_veg, family = binomial, data = escape_frt7)
hist(escape_frt7$climate1)
hist(escape_frt7$climate2)

ggplot(escape_frt7, aes(x=as.character(escape9), y=climate1)) +
  geom_boxplot() 
ggplot(escape_frt7, aes(x=as.character(escape9), y=climate2)) +
  geom_boxplot()

table(is.na(escape_frt7$climate1))
table(is.na(escape_frt7$escape9))
```



```{r}
model_ft7g<-glm(escape9 ~ climate2 + FWI_veg, family = binomial, data = escape_frt7)

# model diagnostic plots
binnedplot (fitted(model_ft7g), 
            residuals(model_ft7g), 
            nclass = NULL)

escape_frt7<- escape_frt7 %>% drop_na(escape9)


escape_frt7$resids<-resid(model_ft7g)


binnedplot (escape_frt7$climate1, 
            escape_frt7$resids,  
            nclass = NULL)

# Diagnostic plots look good

#Partial Residuals

visreg(model_ft7g)

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft7g)

#change order of vegetation factors as there are not many C1 observations
escape_frt7$FWI_veg <- factor(escape_frt7$FWI_veg, levels=c("C-2","C-1","C-3","D-1/2", "M-1/2", "N", "O-1a/b"))

#Create a new blank table and get AUC too
top_mod_table_FRT7_ALL <- data.frame (matrix (ncol = 11, nrow = 0))
colnames (top_mod_table_FRT7_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_FWI_veg_C-1",
                                         "coef_FWI_veg_C-3",
                                         "coef_FWI_veg_D-1/2",
                                         "coef_FWI_veg_M-1/2",
                                         "coef_FWI_veg_N",
                                         "coef_FWI_veg_O-1a/b",
                                         "AUC")
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt7$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt7[ trainIndex,]
   Valid <- escape_frt7[-trainIndex,]
   
#Model   
model.FRT7<-glm(escape9 ~ climate2 + FWI_veg, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT7, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"escape9"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT5 <- data.frame (matrix (ncol = 11, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_FWI_veg_C-1",
                                         "coef_FWI_veg_C-3",
                                         "coef_FWI_veg_D-1/2",
                                         "coef_FWI_veg_M-1/2",
                                         "coef_FWI_veg_N",
                                         "coef_FWI_veg_O-1a/b",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT5[1,1]<-"7"
top_mod_table_FRT5[1,2]<-"escape ~ climate2 + FWI_veg" 
top_mod_table_FRT5[1,3]<- coef(model.FRT7)[1] #Intercept
top_mod_table_FRT5[1,4]<- coef(model.FRT7)[2] #
top_mod_table_FRT5[1,5]<- coef(model.FRT7)[3] 
top_mod_table_FRT5[1,6]<- coef(model.FRT7)[4] #Intercept
top_mod_table_FRT5[1,7]<- coef(model.FRT7)[5] #
top_mod_table_FRT5[1,8]<- coef(model.FRT7)[6] 
top_mod_table_FRT5[1,9]<- coef(model.FRT7)[7] #Intercept
top_mod_table_FRT5[1,10]<- coef(model.FRT7)[8] 
top_mod_table_FRT5[1,11]<- mod.auc

top_mod_table_FRT7_ALL<-rbind(top_mod_table_FRT7_ALL, top_mod_table_FRT5)

}

```

Check.
```{r}
head(top_mod_table_FRT7_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT7_ALL)
str(top_mod_table_FRT7_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT7_ALL<- top_mod_table_FRT7_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT7_ALL$FRT<-7
summary_top_mod_table_FRT7_ALL$Model_terms<-"escape16 ~ climate2 + FWI_veg" 
summary_top_mod_table_FRT7_ALL$Model_Intercept<-"C-2" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT7_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT7_escape.csv")
```


<!-- #### FRT 9 -->
<!-- ```{r} -->
<!-- escape_frt9<- escape2 %>% filter(Cluster==9) -->
<!-- table(escape_frt9$FWI_veg) -->
<!-- escape_frt9$FWI_veg[escape_frt9$FWI_veg=="C-1"]<-"C-2" -->
<!-- escape_frt9$FWI_veg[escape_frt9$FWI_veg=="D-1/2"]<-"C-7" -->
<!-- escape_frt9$veg_escape<-paste(escape_frt9$fire, escape_frt9$FWI_veg) -->

<!-- table(is.na(escape_frt9$climate1)) -->
<!-- table(is.na(escape_frt9$dem_ha_bc)) -->
<!-- table(is.na(escape_frt9$FWI_veg)) -->
<!-- table(is.na(escape_frt9$dist_roads_m)) -->
<!-- table(is.na(escape_frt9$slope_ha_bc_3005)) -->

<!-- cor.test(escape_frt9$dist_roads_m, escape_frt9$dist_infrastructure_m) # these are correlated so just include 1 -->
<!-- cor.test(escape_frt9$climate1, escape_frt9$dem_ha_bc) # these are correlated! -->
<!-- cor.test(escape_frt9$dem_ha_bc, escape_frt9$slope_ha_bc_3005) -->
<!-- cor.test(escape_frt9$win_sum, escape_frt9$win_spg) # very correlated -->

<!-- escape_frt9$log_road<-log(escape_frt9$dist_roads_m+1) -->
<!-- escape_frt9$log_infr<- log(escape_frt9$dist_infrastructure_m+1) -->

<!-- #Run model using dat1 -->
<!-- model_ft9<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + win_sum + log_road, family = binomial, data = escape_frt9) -->

<!-- AIC(model_ft9)  #153.3184 -->
<!-- Anova(model_ft9, type=3) -->

<!-- model_ft9b<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + log_road, family = binomial, data = escape_frt9) -->

<!-- AIC(model_ft9b) #151.3221 -->
<!-- Anova(model_ft9b, type=3) -->


<!-- model_ft9c<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + log_road, family = binomial, data = escape_frt9) -->

<!-- AIC(model_ft9c) #149.366 -->
<!-- Anova(model_ft9c, type=3) -->

<!-- model_ft9d<-glm(escape9 ~ climate1  + slope_ha_bc_3005 + log_road, family = binomial, data = escape_frt9) -->

<!-- AIC(model_ft9d) #143.891 -->
<!-- Anova(model_ft9d, type=3) -->

<!-- model_ft9e<-glm(escape9 ~ climate1 + log_road, family = binomial, data = escape_frt9) -->

<!-- AIC(model_ft9e) #143.0078 -->
<!-- Anova(model_ft9e, type=3) -->

<!-- # model diagnostic plots -->
<!-- binnedplot (fitted(model_ft9e),  -->
<!--             residuals(model_ft9e),  -->
<!--             nclass = NULL,  -->
<!--             xlab = "Expected Values",  -->
<!--             ylab = "Average residual") -->


<!-- escape_frt9$resids<-resid(model_ft9e) -->


<!-- binnedplot (escape_frt9$climate1,  -->
<!--             escape_frt9$resids,   -->
<!--             nclass = NULL) -->

<!-- binnedplot (escape_frt9$log_road,  -->
<!--             escape_frt9$resids,   -->
<!--             nclass = NULL) -->

<!-- # Diagnostic plots look good -->

<!-- #Partial Residuals -->

<!-- visreg(model_ft9e) -->

<!-- ``` -->

<!-- We should repeat the above several times and take the mean of the coefficients. -->

<!-- ```{r} -->
<!-- summary(model_ft9e) -->

<!-- #Create a new blank table and get AUC too -->
<!-- top_mod_table_FRT9_ALL <- data.frame (matrix (ncol = 6, nrow = 0)) -->
<!-- colnames (top_mod_table_FRT9_ALL ) <- c ("FRT", "Model_terms", "intercept", -->
<!--                                          "coef_climate_1", -->
<!--                                          "coef_log_rd_dst", -->
<!--                                          "AUC") -->
<!-- ``` -->

<!-- Let's run it 100 times to get good mean values. -->

<!-- ```{r} -->

<!-- for (g in 1:100){ -->

<!--   print(g) -->

<!-- prop<-0.75 -->
<!-- # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG -->
<!--   trainIndex <- createDataPartition(escape_frt9$veg_escape, p = prop, -->
<!--                                     list = FALSE, -->
<!--                                     times = 1) -->

<!--    dat1 <- escape_frt9[ trainIndex,] -->
<!--    Valid <- escape_frt9[-trainIndex,] -->

<!-- #Model    -->
<!-- model.FRT9<-glm(escape9 ~ climate1 + log_road, family = binomial, data = dat1)  -->

<!-- mod.valid <- predict.glm(model.FRT9, newdata=Valid, type="response") -->
<!--    roc_obj <- roc(Valid[,"escape9"], mod.valid, quiet=TRUE) -->
<!--    mod.auc <- auc(roc_obj) -->

<!-- # create model table (only do this once) and add the relevant data -->
<!-- top_mod_table_FRT9 <- data.frame (matrix (ncol = 6, nrow = 0)) -->
<!-- colnames (top_mod_table_FRT9 ) <- c ("FRT", "Model_terms", "intercept", -->
<!--                                          "coef_climate_1", -->
<!--                                          "coef_log_rd_dst", -->
<!--                                          "AUC") -->

<!-- ##Add data for NDT1 -->
<!-- top_mod_table_FRT9[1,1]<-"9" -->
<!-- top_mod_table_FRT9[1,2]<-"escape ~ climate1 + log_rd_dst"  -->
<!-- top_mod_table_FRT9[1,3]<- coef(model.FRT9)[1] #Intercept -->
<!-- top_mod_table_FRT9[1,4]<- coef(model.FRT9)[2] # -->
<!-- top_mod_table_FRT9[1,5]<- coef(model.FRT9)[3] # -->
<!-- top_mod_table_FRT9[1,6]<- mod.auc -->

<!-- top_mod_table_FRT9_ALL<-rbind(top_mod_table_FRT9_ALL, top_mod_table_FRT9) -->

<!-- } -->

<!-- ``` -->

<!-- Check. -->
<!-- ```{r} -->
<!-- head(top_mod_table_FRT9_ALL) -->

<!-- ``` -->

<!-- Get mean values. -->

<!-- ```{r} -->
<!-- names(top_mod_table_FRT9_ALL) -->
<!-- str(top_mod_table_FRT9_ALL) -->
<!-- stderror <- function(x) sd(x)/sqrt(length(x)) -->

<!-- summary_top_mod_table_FRT9_ALL<- top_mod_table_FRT9_ALL %>% summarize_if(is.numeric,mean) -->

<!-- summary_top_mod_table_FRT9_ALL$FRT<-9 -->
<!-- summary_top_mod_table_FRT9_ALL$Model_terms<-"escape ~ climate1 + log_rd_dst"  -->

<!-- ``` -->

<!-- Save table. -->

<!-- ```{r} -->
<!-- write.csv(summary_top_mod_table_FRT9_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT9_escape.csv") -->
<!-- ``` -->


#### FRT 10
```{r}
# top models fro FRT 9:
#climate1 + climate2 + FWI_veg
# slope_ha_bc_3005 + dem_ha_bc + slope_ha_bc_3005:dem_ha_bc
# rd_dst_
# wind_atfire

escape_frt10<- escape2 %>% filter(Cluster==10)
table(escape_frt10$FWI_veg, escape_frt10$escape9)
escape_frt10$FWI_veg[escape_frt10$FWI_veg=="S-1"]<-"M-1/2"
escape_frt10$FWI_veg[escape_frt10$FWI_veg=="S-2"]<-"M-1/2"
escape_frt10$FWI_veg[escape_frt10$FWI_veg=="O-1a/b"]<-"M-3"
escape_frt10$veg_escape<-paste(escape_frt10$fire, escape_frt10$FWI_veg)

table(is.na(escape_frt10$climate1))
table(is.na(escape_frt10$dem_ha_bc))
table(is.na(escape_frt10$FWI_veg))
table(is.na(escape_frt10$win_sum))
table(is.na(escape_frt10$dist_roads_m))
table(is.na(escape_frt10$slope_ha_bc_3005))
#table(is.na(escape_frt10$fire_cs))
table(is.na(escape_frt10$escape9))

cor.test(escape_frt10$dist_roads_m, escape_frt10$dist_infrastructure_m)
cor.test(escape_frt10$climate1, escape_frt10$slope_ha_bc_3005)
cor.test(escape_frt10$climate1, escape_frt10$dem_ha_bc)

escape_frt10$FWI_veg <- factor(escape_frt10$FWI_veg, levels=c("C-3","C-2","C-5", "C-7","D-1/2", "M-1/2", "M-3", "N"))

#Run model using dat1
model_ft10<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + dist_roads_m + dist_infrastructure_m + win_sum, family = binomial, data = escape_frt10) # 726.5

model_ft10<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + log(dist_roads_m+1) + dist_infrastructure_m + win_sum, family = binomial, data = escape_frt10) # 730.3

model_ft10<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + dist_roads_m + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt10) # 724.7

model_ft10<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + log(dist_roads_m+1) + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt10) # 729.3


model_ft10<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + dist_roads_m + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt10) # 724.7146

AIC(model_ft10) #724.7146
Anova(model_ft10, type=3) 

#Remove least significant interaction
model_ft10b<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + dist_roads_m + log(dist_infrastructure_m+1), family = binomial, data = escape_frt10) 
visreg(model_ft10b)

AIC(model_ft10b) #722.7832
Anova(model_ft10b, type=3) 

#Remove least term ~ FWI_veg
model_ft10c<-glm(escape9 ~ climate1  + slope_ha_bc_3005 + dem_ha_bc + dist_roads_m + log(dist_infrastructure_m+1), family = binomial, data = escape_frt10) 

AIC(model_ft10c) #710.8893
Anova(model_ft10c, type=3) 

#Remove least term ~ slope
model_ft10d<-glm(escape9 ~ climate1 + dem_ha_bc + dist_roads_m + log(dist_infrastructure_m+1), family = binomial, data = escape_frt10) 

AIC(model_ft10d) #712.6573
Anova(model_ft10d, type=3) 

#######################
### TOP MODEL
#######################
#Remove least term ~ slope_ha_bc_3005

escape_frt10$log_infr<-log(escape_frt10$dist_infrastructure_m+1)
model_ft10d<-glm(escape9 ~ climate1  + dem_ha_bc + dist_roads_m + log_infr, family = binomial, data = escape_frt10)

hist(escape_frt10$climate1)
hist(escape_frt10$slope_ha_bc_3005)
hist(escape_frt10$dist_roads_m)
hist(escape_frt10$log_infr)

escape_frt10<- escape_frt10 %>% drop_na(escape9)
ggplot(escape_frt10, aes(x=as.character(escape9), y=climate1)) +
  geom_boxplot() 
ggplot(escape_frt10, aes(x=as.character(escape9), y=dem_ha_bc)) +
  geom_boxplot()
ggplot(escape_frt10, aes(x=as.character(escape9), y=dist_roads_m)) +
  geom_boxplot()
ggplot(escape_frt10, aes(x=as.character(escape9), y=log_infr)) +
  geom_boxplot()


table(escape_frt10$escape9) #0 = 475 and 1 = 171 not bad actually.

# model diagnostic plots
binnedplot (fitted(model_ft10d), 
            residuals(model_ft10d), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

escape_frt10 <- escape_frt10 %>% drop_na(escape9)

escape_frt10$resids<-resid(model_ft10d)

binnedplot (escape_frt10$climate1, 
            escape_frt10$resids,  
            nclass = NULL)

binnedplot (escape_frt10$slope_ha_bc_3005, 
            escape_frt10$resids,  
            nclass = NULL)

binnedplot (escape_frt10$log_infr, 
            escape_frt10$resids,  
            nclass = NULL)

binnedplot (escape_frt10$dist_roads_m, 
            escape_frt10$resids,  
            nclass = NULL)

# Diagnostic plots look good

#Partial Residuals

visreg(model_ft10d)


```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft10d)

#Create a new blank table and get AUC too
top_mod_table_FRT10_ALL <- data.frame (matrix (ncol = 8, nrow = 0))
colnames (top_mod_table_FRT10_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_elevation",
                                         "coef_road_dist",
                                         "coef_log_infr_dist",
                                         "AUC")
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt10$escape9, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt10[ trainIndex,]
   Valid <- escape_frt10[-trainIndex,]
   
#Model   
model.FRT10<-glm(escape9 ~ climate1  + dem_ha_bc + dist_roads_m + log_infr, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT10, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape9"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT10 <- data.frame (matrix (ncol = 8, nrow = 0))
colnames (top_mod_table_FRT10 ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_elevation",
                                         "coef_road_dist",
                                         "coef_log_infr_dist",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT10[1,1]<-"10"
top_mod_table_FRT10[1,2]<-"escape ~ climate1 + elevation  + dist_roads + log_infra_dist" 
top_mod_table_FRT10[1,3]<- coef(model.FRT10)[1] 
top_mod_table_FRT10[1,4]<- coef(model.FRT10)[2] 
top_mod_table_FRT10[1,5]<- coef(model.FRT10)[3] 
top_mod_table_FRT10[1,6]<- coef(model.FRT10)[4] 
top_mod_table_FRT10[1,7]<- coef(model.FRT10)[5] 

top_mod_table_FRT10[1,8]<- mod.auc

top_mod_table_FRT10_ALL<-rbind(top_mod_table_FRT10_ALL, top_mod_table_FRT10)

}

```

Check.
```{r}
head(top_mod_table_FRT10_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT10_ALL)
str(top_mod_table_FRT10_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT10_ALL<- top_mod_table_FRT10_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT10_ALL$FRT<-10
summary_top_mod_table_FRT10_ALL$Model_terms<-"escape16 ~ climate1 + elevation  + dist_roads + log_infra_dist" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT10_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT10_escape.csv")
```

#### FRT 11

```{r}
# top models fro FRT 11:
#climate1 + climate2 + FWI_veg
# slope_ha_bc_3005 + dem_ha_bc + slope_ha_bc_3005:dem_ha_bc
# rd_dst_
# wind_atfire

escape_frt11<- escape2 %>% filter(Cluster==11)
table(escape_frt11$FWI_veg)
escape_frt11$veg_escape<-paste(escape_frt11$fire, escape_frt11$FWI_veg)

table(escape_frt11$FWI_veg, escape_frt11$escape9)

escape_frt11$FWI_veg <- factor(escape_frt11$FWI_veg, levels=c("C-3", "C-1", "C-2","C-5", "C-7","D-1/2", "M-1/2", "N"))

table(is.na(escape_frt11$climate1))
table(is.na(escape_frt11$dem_ha_bc))
table(is.na(escape_frt11$FWI_veg))
table(is.na(escape_frt11$win_sum))
table(is.na(escape_frt11$dist_roads_m))
table(is.na(escape_frt11$slope_ha_bc_3005))

escape_frt11$log_road<-log(escape_frt11$dist_roads_m+1)
escape_frt11$log_infr<- log(escape_frt11$dist_infrastructure_m+1)

cor.test(escape_frt11$dist_roads_m, escape_frt11$dist_infrastructure_m) # correlated 0.72
cor.test(escape_frt11$log_road, escape_frt11$log_infr)
cor.test(escape_frt11$climate1, escape_frt11$dem_ha_bc) # elevation and climate are correlated -0.89
cor.test(escape_frt11$dem_ha_bc, escape_frt11$slope_ha_bc_3005)
cor.test(escape_frt11$dem_ha_bc, escape_frt11$win_sum)


#Run model using dat1 checking if log road or log infrastructure is better
model_ft11<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + dist_roads_m +dist_infrastructure_m + win_sum, family = binomial, data = escape_frt11)
AIC(model_ft11)

model_ft11<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc +dist_infrastructure_m + win_sum, family = binomial, data = escape_frt11)
AIC(model_ft11)

model_ft11<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + dist_roads_m + win_sum, family = binomial, data = escape_frt11)
AIC(model_ft11)

model_ft11<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc +log_infr + win_sum, family = binomial, data = escape_frt11)
AIC(model_ft11)

# log infra is a little better than roads

model_ft11<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc +dist_infrastructure_m + win_sum, family = binomial, data = escape_frt11)
AIC(model_ft11)
Anova(model_ft11, type=3)

model_ft11b<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc +dist_infrastructure_m, family = binomial, data = escape_frt11)
AIC(model_ft11b)
Anova(model_ft11b, type=3)

model_ft11c<-glm(escape9 ~ climate1 + FWI_veg  + slope_ha_bc_3005 +dist_infrastructure_m, family = binomial, data = escape_frt11)
AIC(model_ft11c)
Anova(model_ft11c, type=3)

model_ft11d<-glm(escape9 ~ climate1 + FWI_veg + dist_infrastructure_m, family = binomial, data = escape_frt11)
AIC(model_ft11d)
Anova(model_ft11d, type=3)

model_ft11e<-glm(escape9 ~ climate1 + dist_infrastructure_m, family = binomial, data = escape_frt11)
AIC(model_ft11e)
Anova(model_ft11e, type=3)

#######################
### TOP MODEL
#######################
#Remove least term ~ slope_ha_bc_3005

hist(escape_frt11$climate1)
hist(escape_frt11$dist_infrastructure_m)

table(escape_frt11$escape9) 

# model diagnostic plots
binnedplot (fitted(model_ft11e), 
            residuals(model_ft11e), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

escape_frt11<- escape_frt11 %>% drop_na(escape9)
escape_frt11$resids<-resid(model_ft11e)

binnedplot (escape_frt11$climate1, 
            escape_frt11$resids,  
            nclass = NULL)

binnedplot (escape_frt11$dist_infrastructure_m, 
            escape_frt11$resids,  
            nclass = NULL)

# Diagnostic plots look good

#Partial Residuals

visreg(model_ft11e)

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft11e)

#Create a new blank table and get AUC too
top_mod_table_FRT11_ALL <- data.frame (matrix (ncol = 6, nrow = 0))
colnames (top_mod_table_FRT11_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_dist_infra_m",
                                         "AUC")
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt11$escape9, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt11[ trainIndex,]
   Valid <- escape_frt11[-trainIndex,]
   
#Model   
model.FRT11<-glm(escape9 ~ climate1 + dist_infrastructure_m, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT11, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape9"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT11 <- data.frame (matrix (ncol = 6, nrow = 0))
colnames (top_mod_table_FRT11 ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_dist_infra_m",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT11[1,1]<-"11"
top_mod_table_FRT11[1,2]<-"escape ~ climate1 + dist_infra_m" 
top_mod_table_FRT11[1,3]<- coef(model.FRT11)[1] #Intercept
top_mod_table_FRT11[1,4]<- coef(model.FRT11)[2] #
top_mod_table_FRT11[1,5]<- coef(model.FRT11)[3] #
top_mod_table_FRT11[1,6]<- mod.auc

top_mod_table_FRT11_ALL<-rbind(top_mod_table_FRT11_ALL, top_mod_table_FRT11)

}

```

Check.
```{r}
head(top_mod_table_FRT11_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT11_ALL)
str(top_mod_table_FRT11_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT11_ALL<- top_mod_table_FRT11_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT11_ALL$FRT<-11
summary_top_mod_table_FRT11_ALL$Model_terms<-"escape ~ climate1 + dist_infra_m" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT11_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT11_escape.csv")
```

#### FRT 12
```{r}
escape_frt12<- escape2 %>% filter(Cluster==12)
table(escape2$Cluster)
dim(escape_frt12)
table(escape_frt12$escape9,escape_frt12$FWI_veg)
escape_frt12$FWI_veg[escape_frt12$FWI_veg=="C-4"]<-"C-2"
escape_frt12$FWI_veg[escape_frt12$FWI_veg=="C-1"]<-"C-3"
escape_frt12$FWI_veg[escape_frt12$FWI_veg=="S-3"]<-"S-1"
escape_frt12$FWI_veg[escape_frt12$FWI_veg=="M-3"]<-"O-1a/b"
#escape_frt12$FWI_veg[escape_frt12$FWI_veg=="S-2"]<-"M-1/2"
escape_frt12$veg_escape<-paste(escape_frt12$fire, escape_frt12$FWI_veg)

escape_frt12$FWI_veg <- factor(escape_frt12$FWI_veg, levels=c("C-3", "C-2","C-5", "C-7","D-1/2", "M-1/2", "N", "O-1a/b", "S-1", "S-2"))

table(is.na(escape_frt12$climate1))
table(is.na(escape_frt12$dem_ha_bc))
table(is.na(escape_frt12$FWI_veg))
table(is.na(escape_frt12$win_sum))
table(is.na(escape_frt12$dist_roads_m))
table(is.na(escape_frt12$slope_ha_bc_3005))
table(is.na(escape_frt12$FIRE_CAUSE))
table(is.na(escape_frt12$escape9))

cor.test(escape_frt12$dist_roads_m, escape_frt12$dist_infrastructure_m)
cor.test(escape_frt12$log_road, escape_frt12$log_infr)
cor.test(escape_frt12$climate1, escape_frt12$climate2)
cor.test(escape_frt12$climate1, escape_frt12$dem_ha_bc) # these are correlated!
cor.test(escape_frt12$dem_ha_bc, escape_frt12$climate2)
cor.test(escape_frt12$win_sum, escape_frt12$win_spg) # very correlated

#Run model using dat1
escape_frt12$log_road<-log(escape_frt12$dist_roads_m+1)
escape_frt12$log_infr<-log(escape_frt12$dist_infrastructure_m+1)

model_ft12<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + win_sum + log_road + log_infr, family = binomial, data = escape_frt12)
#4604

model_ft12<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + win_sum + dist_roads_m + log_infr, family = binomial, data = escape_frt12)
#4585
model_ft12<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + win_sum + log_road + dist_infrastructure_m, family = binomial, data = escape_frt12)
#4590
model_ft12<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt12)
#4583


model_ft12<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt12)
#4583
Anova(model_ft12, type=3)

model_ft12<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt12)
#4583
Anova(model_ft12, type=3)

model_ft12<-glm(escape9 ~ climate1 + climate2 + FWI_veg + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt12)
#4583
Anova(model_ft12, type=3)


#######################
### TOP MODEL
#######################
#Remove least term ~ slope_ha_bc_3005
model_ft12e<-glm(escape9 ~ climate1 + climate2 + FWI_veg + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt12)

hist(escape_frt12$climate2)
hist(escape_frt12$win_sum)
hist(escape_frt12$dist_infrastructure_m)
hist(escape_frt12$dist_roads_m)

table(escape_frt12$escape9) 
table(escape_frt12$FWI_veg)

# model diagnostic plots
binnedplot (fitted(model_ft12e), 
            residuals(model_ft12e), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

table(is.na(escape_frt12$escape9))
escape_frt12<-escape_frt12 %>% drop_na(escape9)
escape_frt12$resids<-resid(model_ft12e)


binnedplot (escape_frt12$climate2, 
            escape_frt12$resids,  
            nclass = NULL)

binnedplot (escape_frt12$dist_roads_m, 
            escape_frt12$resids,  
            nclass = NULL)

binnedplot (escape_frt12$log_infr, 
            escape_frt12$resids,  
            nclass = NULL)



# Diagnostic plots look ok ish

#Partial Residuals

visreg(model_ft12e)


```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft12e)

#Create a new blank table and get AUC too
top_mod_table_FRT12_ALL <- data.frame (matrix (ncol = 18, nrow = 0))
colnames (top_mod_table_FRT12_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_climate_2",
                                         "coef_FWI_vegC-2",
                                         "coef_FWI_vegC-5",
                                         "coef_FWI_vegC-7",
                                         "coef_FWI_vegD-1/2",
                                         "coef_FWI_vegM-1/2",
                                         "coef_FWI_vegN",
                                         "coef_FWI_vegO-1a/b",
                                         "coef_FWI_vegS-1",
                                         "coef_FWI_vegS-2",
                                         "coef_win_sum",
                                         "coef_dist_roads_m",
                                         "coef_dist_infr_m",
                                         "AUC")
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt12$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt12[ trainIndex,]
   Valid <- escape_frt12[-trainIndex,]
   
#Model   
model.FRT12<-glm(escape9 ~ climate1 + climate2 + FWI_veg + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT12, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape9"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT12 <- data.frame (matrix (ncol = 18, nrow = 0))
colnames (top_mod_table_FRT12 ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_climate_2",
                                         "coef_FWI_vegC-2",
                                         "coef_FWI_vegC-5",
                                         "coef_FWI_vegC-7",
                                         "coef_FWI_vegD-1/2",
                                         "coef_FWI_vegM-1/2",
                                         "coef_FWI_vegN",
                                         "coef_FWI_vegO-1a/b",
                                         "coef_FWI_vegS-1",
                                         "coef_FWI_vegS-2",
                                         "coef_win_sum",
                                         "coef_dist_roads_m",
                                         "coef_dist_infr_m",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT12[1,1]<-"12"
top_mod_table_FRT12[1,2]<-"escape ~ climate1 + climate2 + FWI_veg + win_sum + dist_roads_m + dist_infrastructure_m" 
top_mod_table_FRT12[1,3]<- coef(model.FRT12)[1] #Intercept
top_mod_table_FRT12[1,4]<- coef(model.FRT12)[2] #
top_mod_table_FRT12[1,5]<- coef(model.FRT12)[3] #
top_mod_table_FRT12[1,6]<- coef(model.FRT12)[4] #coefficient 
top_mod_table_FRT12[1,7]<- coef(model.FRT12)[5] #coefficient 
top_mod_table_FRT12[1,8]<- coef(model.FRT12)[6] #Intercept
top_mod_table_FRT12[1,9]<- coef(model.FRT12)[7] #
top_mod_table_FRT12[1,10]<- coef(model.FRT12)[8] #
top_mod_table_FRT12[1,11]<- coef(model.FRT12)[9] #coefficient 
top_mod_table_FRT12[1,12]<- coef(model.FRT12)[10] #coefficient 
top_mod_table_FRT12[1,13]<- coef(model.FRT12)[11] #Intercept
top_mod_table_FRT12[1,14]<- coef(model.FRT12)[12] #
top_mod_table_FRT12[1,15]<- coef(model.FRT12)[13] #
top_mod_table_FRT12[1,16]<- coef(model.FRT12)[14] #coefficient 
top_mod_table_FRT12[1,17]<- coef(model.FRT12)[15] #
top_mod_table_FRT12[1,18]<- mod.auc
top_mod_table_FRT12_ALL<-rbind(top_mod_table_FRT12_ALL, top_mod_table_FRT12)

}

```

Check.
```{r}
head(top_mod_table_FRT12_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT12_ALL)
str(top_mod_table_FRT12_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT12_ALL<- top_mod_table_FRT12_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT12_ALL$FRT<-12
summary_top_mod_table_FRT12_ALL$Model_terms<-"escape ~ climate1 + climate2 + FWI_veg + win_sum + dist_roads_m + dist_infrastructure_m" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT12_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT12_escape.csv")
```


#### FRT 13
```{r}
escape_frt13<- escape2 %>% filter(Cluster==13)
table(escape_frt13$FWI_veg, escape_frt13$escape9)
escape_frt13$FWI_veg[escape_frt13$FWI_veg=="C-1"]<-"C-3"
escape_frt13$FWI_veg[escape_frt13$FWI_veg=="C-4"]<-"C-2"
escape_frt13$veg_escape<-paste(escape_frt13$fire, escape_frt13$FWI_veg)

table(is.na(escape_frt13$climate1))
table(is.na(escape_frt13$dem_ha_bc))
table(is.na(escape_frt13$FWI_veg))
table(is.na(escape_frt13$dist_roads_m))
table(is.na(escape_frt13$slope_ha_bc_3005))
table(is.na(escape_frt13$escape9))

# start here

cor.test(escape_frt13$dist_roads_m,escape_frt13$dist_infrastructure_m)
cor.test(escape_frt13$climate1, escape_frt13$climate2)
cor.test(escape_frt13$climate1, escape_frt13$dem_ha_bc) # these are correlated!
cor.test(escape_frt13$climate2, escape_frt13$dem_ha_bc) # these are correlated!

cor.test(escape_frt13$dem_ha_bc, escape_frt13$slope_ha_bc_3005)
cor.test(escape_frt13$win_sum, escape_frt13$win_spg) # very correlated

escape_frt13$log_road<-log(escape_frt13$dist_roads_m+1)
escape_frt13$log_infr<- log(escape_frt13$dist_infrastructure_m+1)

#Run model using dat1
model_ft13<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + win_sum + log_road + log_infr, family = binomial, data = escape_frt13)
#9715

model_ft13<-glm(escape9 ~ climate2 + FWI_veg  + slope_ha_bc_3005 + dem_ha_bc + win_sum + log_road + log_infr, family = binomial, data = escape_frt13)
#9761

model_ft13<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + log_road + log_infr, family = binomial, data = escape_frt13)
#9724

# Best one leaves out dem

model_ft13<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + dist_roads_m + log_infr, family = binomial, data = escape_frt13)
#9666
model_ft13<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt13)
#9657
model_ft13<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + log_road + dist_infrastructure_m, family = binomial, data = escape_frt13)
#9680

model_ft13<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt13)
AIC(model_ft13) #9656.702
Anova(model_ft13, type=3) 

# Top model
model_ft13<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt13)
Anova(model_ft13, type=3) 


#######################
### TOP MODEL
#######################
#Remove least term ~ slope_ha_bc_3005
model_ft13e<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt13)

hist(escape_frt13$climate1)
hist(escape_frt13$climate2)
hist(escape_frt13$dist_roads_m)

escape_frt13<- escape_frt13 %>% drop_na(escape9)

ggplot(escape_frt13, aes(x=as.character(escape9), y=dist_infrastructure_m)) +
  geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape9), y=dist_roads_m)) +
  geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape9), y=climate1)) +
  geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape9), y=climate2)) +
  geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape9), y=slope_ha_bc_3005)) +geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape9), y=win_sum)) +geom_boxplot()

table(escape_frt13$escape9) #0 = 948 and 1 = 267 not bad actually.
table(escape_frt13$FWI_veg)

# model diagnostic plots
binnedplot (fitted(model_ft13e), 
            residuals(model_ft13e), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")



#Partial Residuals

visreg(model_ft13e)


```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft13e)



#Create a new blank table and get AUC too
top_mod_table_FRT13_ALL <- data.frame (matrix (ncol = 21, nrow = 0))
colnames (top_mod_table_FRT13_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_climate_2",
                                         "coef_FWI_vegC-3",
                                         "coef_FWI_vegC-5",
                                         "coef_FWI_vegC-7",
                                         "coef_FWI_vegD-1/2",
                                         "coef_FWI_vegM-1/2",
                                         "coef_FWI_vegM-3",
                                         "coef_FWI_vegN",
                                         "coef_FWI_vegO-1a/b",
                                         "coef_FWI_vegS-1",
                                         "coef_FWI_vegS-2",
                                         "coef_FWI_vegS-3",
                                         "coef_slope",
                                         "coef_win_sum",
                                         "coef_roads_m",
                                         "coef_infr_m",
                                         "AUC")
```

Let's run it 100 times to get good mean values.

```{r}
prop<-0.75

for (g in 1:100){
  
  print(g)

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt13$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt13[ trainIndex,]
   Valid <- escape_frt13[-trainIndex,]
   
#Model   
model.FRT13<-glm(escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT13, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape9"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT13 <- data.frame (matrix (ncol = 21, nrow = 0))
colnames (top_mod_table_FRT13 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_climate_2",
                                         "coef_FWI_vegC-3",
                                         "coef_FWI_vegC-5",
                                         "coef_FWI_vegC-7",
                                         "coef_FWI_vegD-1/2",
                                         "coef_FWI_vegM-1/2",
                                         "coef_FWI_vegM-3",
                                         "coef_FWI_vegN",
                                         "coef_FWI_vegO-1a/b",
                                         "coef_FWI_vegS-1",
                                         "coef_FWI_vegS-2",
                                         "coef_FWI_vegS-3",
                                         "coef_slope",
                                         "coef_win_sum",
                                         "coef_roads_m",
                                         "coef_infr_m",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT13[1,1]<-"13"
top_mod_table_FRT13[1,2]<-"escape9 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + dist_roads_m + log_infr" 
top_mod_table_FRT13[1,3]<- coef(model.FRT13)[1] #Intercept
top_mod_table_FRT13[1,4]<- coef(model.FRT13)[2] #
top_mod_table_FRT13[1,5]<- coef(model.FRT13)[3] #
top_mod_table_FRT13[1,6]<- coef(model.FRT13)[4] #coefficient 
top_mod_table_FRT13[1,7]<- coef(model.FRT13)[5] #coefficient 
top_mod_table_FRT13[1,8]<- coef(model.FRT13)[6] #Intercept
top_mod_table_FRT13[1,9]<- coef(model.FRT13)[7] #
top_mod_table_FRT13[1,10]<- coef(model.FRT13)[8] #
top_mod_table_FRT13[1,11]<- coef(model.FRT13)[9] #coefficient 
top_mod_table_FRT13[1,12]<- coef(model.FRT13)[10] #coefficient 
top_mod_table_FRT13[1,13]<- coef(model.FRT13)[11] #Intercept
top_mod_table_FRT13[1,14]<- coef(model.FRT13)[12] #
top_mod_table_FRT13[1,15]<- coef(model.FRT13)[13] #
top_mod_table_FRT13[1,16]<- coef(model.FRT13)[14] #coefficient 
top_mod_table_FRT13[1,17]<- coef(model.FRT13)[15] #coefficient 
top_mod_table_FRT13[1,18]<- coef(model.FRT13)[16] #Intercept
top_mod_table_FRT13[1,19]<- coef(model.FRT13)[17] #coefficient 
top_mod_table_FRT13[1,20]<- coef(model.FRT13)[18] #Intercept
top_mod_table_FRT13[1,21]<- mod.auc
top_mod_table_FRT13_ALL<-rbind(top_mod_table_FRT13_ALL, top_mod_table_FRT13)

}

```

Check.
```{r}
head(top_mod_table_FRT13_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT13_ALL)
str(top_mod_table_FRT13_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT13_ALL<- top_mod_table_FRT13_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT13_ALL$FRT<-13
summary_top_mod_table_FRT13_ALL$Model_terms<-"escape16 ~ climate1 + climate2 + FWI_veg  + slope_ha_bc_3005 + win_sum + dist_roads_m + infr_m" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT13_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT13_escape.csv")
```


#### FRT 14
```{r}
escape_frt14<- escape2 %>% filter(Cluster==14)
table(escape_frt14$FWI_veg, escape_frt14$escape9)

escape_frt14$FWI_veg[escape_frt14$FWI_veg=="M-3"]<-"O-1a/b"
escape_frt14$FWI_veg[escape_frt14$FWI_veg=="C-5"]<-"C-7"
escape_frt14$FWI_veg[escape_frt14$FWI_veg=="S-1"]<-"M-1/2"
escape_frt14$FWI_veg[escape_frt14$FWI_veg=="C-2"]<-"C-3"

escape_frt14$veg_escape<-paste(escape_frt14$fire, escape_frt14$FWI_veg)

cor.test(escape_frt14$dist_roads_m, escape_frt14$dist_infrastructure_m)
cor.test(escape_frt14$climate1, escape_frt14$dem_ha_bc) # these are correlated!
cor.test(escape_frt14$dem_ha_bc, escape_frt14$slope_ha_bc_3005)
hist(as.numeric(escape_frt14$ig_mnth))

escape_frt14$log_road<-log(escape_frt14$dist_roads_m+1)
escape_frt14$log_infr<- log(escape_frt14$dist_infrastructure_m+1)

table(is.na(escape_frt14$climate1))
table(is.na(escape_frt14$dem_ha_bc))
table(is.na(escape_frt14$FWI_veg))
table(is.na(escape_frt14$win_sum))
table(is.na(escape_frt14$dist_roads_m))
table(is.na(escape_frt14$slope_ha_bc_3005))
table(is.na(escape_frt14$escape9))

escape_frt14<-escape_frt14 %>% filter(!is.na(escape9))

#Run model using dat1
model_ft14<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + log_road + log_infr, family = binomial, data = escape_frt14)
#7828

model_ft14<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + dist_roads_m + log_infr, family = binomial, data = escape_frt14)
#7806

model_ft14<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + log_road + dist_infrastructure_m  , family = binomial, data = escape_frt14)
#7810

model_ft14<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m  , family = binomial, data = escape_frt14) #7798

#best model
model_ft14<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m  , family = binomial, data = escape_frt14)

AIC(model_ft14) #3737.464
Anova(model_ft14, type=3) 

#Remove least significant term
model_ft14<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + dist_roads_m, family = binomial, data = escape_frt14)
AIC(model_ft14) #3737.464 # cant actually compare these two models because slope is missing to values and so there are different datasets
Anova(model_ft14, type=3) 


#######################
### TOP MODEL
#######################
#Remove least term ~ slope_ha_bc_3005
model_ft14e<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt14)

hist(escape_frt14$climate1)
hist(escape_frt14$dem_ha_bc)
hist(escape_frt14$dist_roads_m)
hist(escape_frt14$dist_infrastructure_m)

ggplot(escape_frt14, aes(x=as.character(escape9), y=climate1)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape9), y=dem_ha_bc)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape9), y=slope_ha_bc_3005)) + geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape9), y=win_sum)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape9), y=dist_roads_m)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape9), y=dist_infrastructure_m)) + geom_boxplot()

table(escape_frt14$escape9) #0 = 9123 and 1 = 556 not bad actually.
table(escape_frt14$FWI_veg)

# model diagnostic plots
binnedplot (fitted(model_ft14e), 
            residuals(model_ft14e), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")



#Partial Residuals

visreg(model_ft14e)

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft14e)


#Create a new blank table and get AUC too
top_mod_table_FRT14_ALL <- data.frame (matrix (ncol = 15, nrow = 0))
colnames (top_mod_table_FRT14_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_FWI_vegC-7",
                                         "coef_FWI_vegD-1/2",
                                         "coef_FWI_vegM-1/2",
                                         "coef_FWI_vegN",
                                         "coef_FWI_vegO-1a/b",
                                         "coef_elev",
                                         "coef_slope",
                                         "coef_win_sum",
                                         "coef_dist_road_m",
                                         "coef_dist_infr_m",
                                         "AUC")
```

Let's run it 100 times to get good mean values.

```{r}
prop<-0.75

for (g in 1:100){
  
  print(g)

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt14$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt14[ trainIndex,]
   Valid <- escape_frt14[-trainIndex,]
   
#Model   
model.FRT14<-glm(escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT14, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape9"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT14 <- data.frame (matrix (ncol = 15, nrow = 0))
colnames (top_mod_table_FRT14 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_FWI_vegC-7",
                                         "coef_FWI_vegD-1/2",
                                         "coef_FWI_vegM-1/2",
                                         "coef_FWI_vegN",
                                         "coef_FWI_vegO-1a/b",
                                         "coef_elev",
                                         "coef_slope",
                                         "coef_win_sum",
                                         "coef_dist_road_m",
                                         "coef_dist_infr_m",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT14[1,1]<-"14"
top_mod_table_FRT14[1,2]<-"escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m" 
top_mod_table_FRT14[1,3]<- coef(model.FRT14)[1] #Intercept
top_mod_table_FRT14[1,4]<- coef(model.FRT14)[2] #
top_mod_table_FRT14[1,5]<- coef(model.FRT14)[3] #
top_mod_table_FRT14[1,6]<- coef(model.FRT14)[4] #coefficient 
top_mod_table_FRT14[1,7]<- coef(model.FRT14)[5] #coefficient 
top_mod_table_FRT14[1,8]<- coef(model.FRT14)[6] #Intercept
top_mod_table_FRT14[1,9]<- coef(model.FRT14)[7] #
top_mod_table_FRT14[1,10]<- coef(model.FRT14)[8] #
top_mod_table_FRT14[1,11]<- coef(model.FRT14)[9] #coefficient 
top_mod_table_FRT14[1,12]<- coef(model.FRT14)[10] #coefficient 
top_mod_table_FRT14[1,13]<- coef(model.FRT14)[11] #Intercept
top_mod_table_FRT14[1,14]<- coef(model.FRT14)[12] #Intercept
top_mod_table_FRT14[1,15]<- mod.auc
top_mod_table_FRT14_ALL<-rbind(top_mod_table_FRT14_ALL, top_mod_table_FRT14)

}

```

Check.
```{r}
head(top_mod_table_FRT14_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT14_ALL)
str(top_mod_table_FRT14_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT14_ALL<- top_mod_table_FRT14_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT14_ALL$FRT<-14
summary_top_mod_table_FRT14_ALL$Model_terms<-"escape9 ~ climate1 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT14_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT14_escape.csv")
```


#### FRT 15
```{r}
escape_frt15<- escape2 %>% filter(Cluster==15)
table(escape_frt15$FWI_veg, escape_frt15$escape9)
escape_frt15$FWI_veg[escape_frt15$FWI_veg=="S-1"]<-"S-3"
escape_frt15$FWI_veg[escape_frt15$FWI_veg=="C-7"]<-"C-5"
escape_frt15$FWI_veg[escape_frt15$FWI_veg=="O-1a/b"]<-"C-3"
escape_frt15$FWI_veg[escape_frt15$FWI_veg=="S-2"]<-"C-5"

escape_frt15$log_road<-log(escape_frt15$dist_roads_m+1)
escape_frt15$log_infr<- log(escape_frt15$dist_infrastructure_m+1)


escape_frt15$veg_escape<-paste(escape_frt15$escape9, escape_frt15$FWI_veg)

cor.test(escape_frt15$dist_roads_m, escape_frt15$dist_infrastructure_m)
cor.test(escape_frt15$climate1, escape_frt15$climate2)
cor.test(escape_frt15$climate1, escape_frt15$dem_ha_bc) # these are correlated!
cor.test(escape_frt15$climate2, escape_frt15$dem_ha_bc) 
cor.test(escape_frt15$dem_ha_bc, escape_frt15$slope_ha_bc_3005)

table(is.na(escape_frt15$climate1))
table(is.na(escape_frt15$dem_ha_bc))
table(is.na(escape_frt15$FWI_veg))
table(is.na(escape_frt15$win_sum))
table(is.na(escape_frt15$log_infr))
table(is.na(escape_frt15$slope_ha_bc_3005))
table(is.na(escape_frt15$fire_cs))
table(is.na(escape_frt15$escape9))

hist(as.numeric(escape_frt15$ig_mnth))
table(as.numeric(escape_frt15$ig_mnth)) # most fires in july and aug so use win_sum

#escape_frt15<- escape_frt15 %>% filter(!is.na(dem_ha_bc))
#escape_frt15<- escape_frt15 %>% filter(!is.na(win_sum))

#Run model using dat1 and test if log road or log infra works best
model_ft15<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + win_sum + log_road + log_infr, family = binomial, data = escape_frt15)

AIC(model_ft15) #2087.507
Anova(model_ft15, type=3) 

model_ft15<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + win_sum + dist_roads_m + log_infr, family = binomial, data = escape_frt15)
#2085
model_ft15<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + win_sum + log_road + dist_infrastructure_m, family = binomial, data = escape_frt15)
#2090
model_ft15<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + win_sum + dist_roads_m + dist_infrastructure_m, family = binomial, data = escape_frt15)
#2089

#Test if climate1 or dem should stay
model_ft15<-glm(escape9 ~ climate1 + climate2 + FWI_veg + dem_ha_bc + slope_ha_bc_3005 + win_sum + dist_roads_m + log_infr, family = binomial, data = escape_frt15)
#2085

model_ft15<-glm(escape9 ~climate2 + FWI_veg + dem_ha_bc + slope_ha_bc_3005  + win_sum + dist_roads_m + log_infr, family = binomial, data = escape_frt15)
#2084

model_ft15<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + win_sum + dist_roads_m + log_infr, family = binomial, data = escape_frt15)
#2085

# Ok its the same climate1 and elevation so Ill keep climate 1

# work from here to remove least signiticant term

model_ft15<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + win_sum + dist_roads_m + log_infr, family = binomial, data = escape_frt15)

AIC(model_ft15) #2085.388
Anova(model_ft15, type=3) 

model_ft15b<-glm(escape9 ~ climate1 + climate2 + FWI_veg + slope_ha_bc_3005 + dist_roads_m + log_infr, family = binomial, data = escape_frt15)

AIC(model_ft15b) #2083.709
Anova(model_ft15b, type=3) 

# choose to leave out elevation
model_ft15c<-glm(escape9 ~ climate2 + FWI_veg + slope_ha_bc_3005 + dist_roads_m + log_infr, family = binomial, data = escape_frt15)

AIC(model_ft15c) #2081.946
Anova(model_ft15c, type=3) 

#rm 
model_ft15d<-glm(escape9 ~ climate2 + FWI_veg + slope_ha_bc_3005 + log_infr, family = binomial, data = escape_frt15)

AIC(model_ft15d) #2081.953
Anova(model_ft15d, type=3) 


#######################
### TOP MODEL
#######################
#Remove least term ~ slope_ha_bc_3005
model_ft15e<-glm(escape9 ~ climate2 + FWI_veg + slope_ha_bc_3005 + log_infr, family = binomial, data = escape_frt15)

hist(escape_frt15$slope_ha_bc_3005)
hist(escape_frt15$climate2)
hist(escape_frt15$log_infr)

table(escape_frt15$escape9) #0 = 948 and 1 = 267 not bad actually.
table(escape_frt15$FWI_veg, escape_frt15$escape9)

# model diagnostic plots
binnedplot (fitted(model_ft15e), 
            residuals(model_ft15e), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")


# Diagnostic plots look good

#Partial Residuals

visreg(model_ft15e)

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft15e)


#Create a new blank table and get AUC too
top_mod_table_FRT15_ALL <- data.frame (matrix (ncol = 12, nrow = 0))
colnames (top_mod_table_FRT15_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_FWI_vegC-5",
                                         "coef_FWI_vegD-1/2",
                                         "coef_FWI_vegM-1/2",
                                         "coef_FWI_vegN",
                                         "coef_FWI_vegS-3",
                                         "coef_slope",
                                         "coef_log_infr",
                                         "AUC")
```

Let's run it 100 times to get good mean values.

```{r}
prop<-0.75

for (g in 1:100){
  
  print(g)
  
trainIndex <- createDataPartition(escape_frt15$escape9, p = prop,
                                    list = FALSE,
                                    times = 1)
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  dat1 <- escape_frt15[ trainIndex,] # note only 6% of obs are 1's so Im going to sample to get my sample size up to 30% 1's.
   # in total I need 1589 1's
   dat1_1<-dat1 %>% filter(escape9==1)
   dat1_0<-dat1 %>% filter(escape9==0)
   dat1_1_samp<- sample_n(dat1_1, round(length(dat1$escape9)*0.1,0), replace = TRUE)
   
   dat<-rbind(dat1_0, dat1_1_samp)
   Valid <- escape_frt15[-trainIndex,]
   
#Model   
model.FRT15<-glm(escape9 ~ climate2 + FWI_veg + slope_ha_bc_3005 + log_infr, family = binomial, data = dat)

mod.valid <- predict.glm(model.FRT15, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape9"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT15 <- data.frame (matrix (ncol = 12, nrow = 0))
colnames (top_mod_table_FRT15 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_FWI_vegC-5",
                                         "coef_FWI_vegD-1/2",
                                         "coef_FWI_vegM-1/2",
                                         "coef_FWI_vegN",
                                         "coef_FWI_vegS-3",
                                         "coef_slope",
                                         "coef_log_infr_ds",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT15[1,1]<-"15"
top_mod_table_FRT15[1,2]<-"escape ~ climate2 + FWI_veg + slope + log_infr" 

top_mod_table_FRT15[1,3]<- coef(model.FRT15)[1] #Intercept
top_mod_table_FRT15[1,4]<- coef(model.FRT15)[2] #
top_mod_table_FRT15[1,5]<- coef(model.FRT15)[3] #
top_mod_table_FRT15[1,6]<- coef(model.FRT15)[4] #coefficient 
top_mod_table_FRT15[1,7]<- coef(model.FRT15)[5] #
top_mod_table_FRT15[1,8]<- coef(model.FRT15)[6] #
top_mod_table_FRT15[1,9]<- coef(model.FRT15)[7]
top_mod_table_FRT15[1,10]<- coef(model.FRT15)[8] #
top_mod_table_FRT15[1,11]<- coef(model.FRT15)[9] #
top_mod_table_FRT15[1,12]<- mod.auc
top_mod_table_FRT15_ALL<-rbind(top_mod_table_FRT15_ALL, top_mod_table_FRT15)

}

```

Check.
```{r}
head(top_mod_table_FRT15_ALL)



```

Get mean values.

```{r}
names(top_mod_table_FRT15_ALL)
str(top_mod_table_FRT15_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT15_ALL<- top_mod_table_FRT15_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT15_ALL$FRT<-15
summary_top_mod_table_FRT15_ALL$Model_terms<-"escape16 ~ climate2 + FWI_veg + slope + log_infr" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT15_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT15_escape.csv")
```
