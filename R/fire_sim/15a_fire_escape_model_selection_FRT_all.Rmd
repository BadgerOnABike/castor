---
title: "15a_fire_escape_model_selection_NDT1_ALLPL_ALLTNT"
author: "Cora Skaien & Elizabeth Kleynhans"
date: "27/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Load relevant libraries
library(sf)
library(tidyverse)
library(ggplot2)
library(ggcorrplot)
library(RPostgreSQL)
library(rpostgis)
library(dplyr)
library(lme4)
library(arm)
library(ggpubr)
library(mgcv)
library(nlme)
library(purrr)
library(tidyr)
library(caret)
library(pROC)
library(keyring)
library(ggcorrplot) 
library(kableExtra)
library(data.table)
library(DBI)
library(here)
library(AICcmodavg)
library(rje)
library(base)
library(car)
library(visreg)

source(here::here("R/functions/R_Postgres.R"))
```

<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

#=================================
#  Script Name: 12a_fire_escape_model_selection_NDT1_ALLPL_ALLTNT.R
#  Script Version: 1.0
#  Script Purpose: Model selection for escape by NDT.
#  Script Author: Cora Skaien, Ecological Modeling Specialist, Forest Analysis and Inventory Branch, B.C. Ministry of Forests, Lands, and Natural Resource Operations.
#=================================

Load in the prepped data.

```{r}
escape<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\escape_data_clean.csv")

escape2<-escape %>%
  distinct(id, .keep_all = TRUE)

escape2<-data.table(escape2)

escape2<-escape2[!is.na(CURRENT),]
escape2[CURRENT>1.5, escape:=1]
escape2[CURRENT<=1.5, escape:=0]
escape2[frt==9, frt:=11]
```

There are some spots where FRT was not categorized. So I import these points in QGIS and manually looked them up
```{r}
#x<-escape2[is.na(frt),]
#write.csv(x, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\FRT_na.csv")


escape2[idno %in% c(9867, 31071, 35426, 3697, 24997, 6632,4126, 3905,21723, 17134, 29149, 32626,34666,34591, 17321), frt:=14]

escape2[idno %in% c(20588, 9744, 5748, 34377, 35183, 10459, 18956, 27789, 18167, 8193, 16061, 34001), frt:=13]

escape2[is.na(frt), frt:=15]

```

#note there are a few ignitions in the months January and December. For now Im going to filter these out but maybe I should include them in the future. Presumabily non of these fires escape
```{r}
hist(as.numeric(escape2$ig_mnth))


ggplot(data = escape2, aes(as.numeric(as.character(ig_mnth)))) +
  geom_histogram() +
  facet_wrap(~frt, scales="free_y")


climate_variables_escape<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\climate_AIC_results_escape_summary_Oct23.csv") #This current file has all the possible models instead of the top one for each NDT as prior

escape2[frt==5, climate1:=(Tmax04+Tmax05)/2]
escape2[frt==5, climate2:=(PPT04+PPT05)/2]
escape2[frt==7, climate1:=CMI04]
escape2[frt==10, climate1:=(CMD04+CMD05+CMD06)/3]
escape2[frt==11, climate1:=Tave05]
escape2[frt==11, climate2:=PPT05]
escape2[frt==12, climate1:=(Tmax04+Tmax05+Tmax06)/3]
escape2[frt==12, climate2:=(PPT04+PPT05+PPT06)/3]
escape2[frt==13, climate1:=(Tmax07+Tmax08)/2]
escape2[frt==13, climate2:=(PPT07+PPT08)/2]
escape2[frt==14, climate1:=(Tmax04+Tmax05+Tmax06)/3]
escape2[frt==14, climate2:=(PPT04+PPT05+PPT06)/3]
escape2[frt==15, climate1:=(CMD07 +CMD08)/2]

escape2[, aspect_cardinal:="O"]
escape2[a___300 >315, aspect_cardinal:="N"]
escape2[a___300 <=45, aspect_cardinal:="N"]
escape2[a___300 >45 & a___300 <=135, aspect_cardinal:="O"]
escape2[a___300 >135 & a___300<=225, aspect_cardinal:="S"]
escape2[a___300 >225 & a___300 <=315, aspect_cardinal:="O"]

escape2$fwveg<-as.factor(escape2$fwveg)
escape2$aspect_cardinal<-as.factor((escape2$aspect_cardinal))

# before running any models wer are going to remove W and N because fires cannot spread on this landscape type.
escape2[frt==3, frt:=5]
escape2<-escape2 %>% filter(!fwveg %in% c("W", "N"))
escape2$veg_escape<-paste(escape2$escape, escape2$fwveg)

table(escape2$frt, escape2$fwveg)

escape2[fwveg=="M-3", fwveg:="M-1/2"]
escape2[fwveg=="S-2", fwveg:="S-1"]
escape2[fwveg=="S-3", fwveg:="S-1"]

setorder(escape2, cols = - "climate1") 

table(is.na(escape2$climate1))
escape2<-escape2[!is.na(climate1), ]

#write.csv(escape2, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\escape_data_clean.csv")
```


################################ STAGE TWO ########################

#STAGE TWO: PUT TOGETHER MORE VARIABLES AND MANUALLY ASSESS
Now choose the top variables and create final model. The below code will need to be updated manually, depending on what the results of the above analyses are. From the top models, we will re-create two-way interactions for the variables selected from each model, plus the other variables listed as needed to be included. We will assess each set to ensure only interactions that make sense are investigated ultimately, given that sample sizes will be an issues.

Top Variables common to most:
1. climate1 + climate2 + vegtype2
2. Slope + elevation + wind_atfire
3. Road dist


#Next investigation
Because there would be far too many models to investigate including all variables and their interactions, we will start with the above and make educated guesses for what may need to be enhanced. We will seek the best model from the above informed progress.


#### FRT 5
```{r}

escape_frt5<- escape2 %>% filter(frt==5)

table(is.na(escape_frt5$climate1))
table(is.na(escape_frt5$dm_h_bc))
table(is.na(escape_frt5$fwveg))
table(is.na(escape_frt5$road_dist_m))
table(is.na(escape_frt5$s___300))
table(is.na(escape_frt5$escape))


cor.test(escape_frt5$climate1, escape_frt5$dm_h_bc)
cor.test(escape_frt5$climate2, escape_frt5$dm_h_bc)
cor.test(escape_frt5$climate1, escape_frt5$s___300)
cor.test(escape_frt5$dm_h_bc, escape_frt5$s___300)
cor.test(escape_frt5$road_dist_m, escape_frt5$dist_infrastructure_m)
# roads and infrastructure are correlated (0.85)
ggplot(escape_frt5, aes(x=as.factor(escape), y=dist_infrastructure_m)) + 
  geom_boxplot()
escape_frt5<-escape_frt5[!dist_infrastructure_m>50000,]
ggplot(escape_frt5, aes(x=as.factor(escape), y=road_dist_m)) + 
  geom_boxplot()
ggplot(escape_frt5, aes(x=as.factor(escape), y=dist_infrastructure_m)) + 
  geom_boxplot()


escape_frt5$log_road<-log(escape_frt5$road_dist_m+1)
escape_frt5$log_infra<-log(escape_frt5$dist_infrastructure_m+1)

table(escape_frt5$fwveg, escape_frt5$escape)

escape_frt5$fwveg[escape_frt5$fwveg=="C-7"]<-"M-1/2"
escape_frt5$fwveg[escape_frt5$fwveg=="S-1"]<-"M-1/2"
escape_frt5<-escape_frt5[!is.na(fwveg),]

escape_frt5$veg_escape<-paste(escape_frt5$escape, escape_frt5$fwveg)
table(escape_frt5$veg_escape)


#Run model using dat1
model_ft5<-glm(escape ~ climate1 + climate2 + fwveg + s___300 + aspect_cardinal + dm_h_bc + win_spg + road_dist_m +dist_infrastructure_m, family = binomial, data = escape_frt5)
# 1546

model_ft5a<-glm(escape ~ climate1 + climate2  + fwveg + s___300 + aspect_cardinal + dm_h_bc + win_spg +dist_infrastructure_m, family = binomial, data = escape_frt5) # 1545

model_ft5b<-glm(escape ~ climate1 + climate2  + fwveg + s___300 + aspect_cardinal + dm_h_bc + win_spg + road_dist_m, family = binomial, data = escape_frt5)# 1547

#Ok distance to infrastructure is better and its better not to log it

model_ft5c<-glm(escape ~ climate1 + climate2 + fwveg + s___300 + aspect_cardinal + dm_h_bc + win_spg +log_infra, family = binomial, data = escape_frt5)
# 1551

model_ft5<-glm(escape ~ climate1 + climate2 + fwveg + s___300 + dm_h_bc + aspect_cardinal + win_spg +dist_infrastructure_m, family = binomial, data = escape_frt5)
AIC(model_ft5) #1571
Anova(model_ft5, type=3)

#chop asepct
model_ft5b<-glm(escape ~ climate1 + climate2 + fwveg + s___300 + dm_h_bc + win_spg +dist_infrastructure_m, family = binomial, data = escape_frt5)

AIC(model_ft5b) #1563.862
Anova(model_ft5b, type=3)

#chop win_sp
model_ft5c<-glm(escape ~ climate1 + climate2 + fwveg + s___300 + dm_h_bc + dist_infrastructure_m, family = binomial, data = escape_frt5)
AIC(model_ft5c) #1566.132
Anova(model_ft5c, type=3)
visreg(model_ft5c)

#chop climate1
model_ft5c<-glm(escape ~ climate2 + fwveg + s___300 + dm_h_bc + dist_infrastructure_m, family = binomial, data = escape_frt5)
AIC(model_ft5c) #1566.132
Anova(model_ft5c, type=3)
visreg(model_ft5c)

# chop slope
model_ft5c<-glm(escape ~ climate2 + fwveg + dm_h_bc + dist_infrastructure_m, family = binomial, data = escape_frt5)
AIC(model_ft5c) #1541.128
Anova(model_ft5c, type=3)
visreg(model_ft5c)

# try chopping fwveg no apparently fwveg is actually helping 
model_ft5c<-glm(escape ~ climate2 + dm_h_bc + dist_infrastructure_m, family = binomial, data = escape_frt5)
AIC(model_ft5c) #1584.124
Anova(model_ft5c, type=3)
visreg(model_ft5c)


#######################
### TOP MODEL
#######################
model_ft5b<-glm(escape ~ climate2 + fwveg + dm_h_bc + dist_infrastructure_m, family = binomial, data = escape_frt5)

hist(escape_frt5$climate2)
escape_frt5<-escape_frt5 %>% drop_na(escape)
hist(escape_frt5$dm_h_bc)
hist(escape_frt5$dist_infrastructure_m)

ggplot(escape_frt5, aes(x=as.character(escape), y=climate2)) +
  geom_boxplot() #climate1 = PPT05
ggplot(escape_frt5, aes(x=as.character(escape), y=dm_h_bc)) +
  geom_boxplot() #climate1 = PPT05
ggplot(escape_frt5, aes(x=as.character(escape), y=dist_infrastructure_m)) +
  geom_boxplot() 

```


```{r}
# model diagnostic plots
binnedplot (fitted(model_ft5b), 
            residuals(model_ft5b), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft5b)

#Create a new blank table and get AUC too
top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 12, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_fwveg_C-2",
                                         "coef_fwveg_C-3",
                                         "coef_fwveg_D-1/2",
                                         "coef_fwveg_M-1/2",
                                         "coef_fwveg_O-1a/b",
                                         "coef_elevation",
                                         "coef_dist_infra",
                                         "AUC")

escape_frt5<-as.data.frame(escape_frt5)
```

Let's run it 500 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt5$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt5[ trainIndex,]
   Valid <- escape_frt5[-trainIndex,]
   
#Model   
model.FRT5<-glm(escape ~ climate2 + fwveg + dm_h_bc + dist_infrastructure_m, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT5, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT5 <- data.frame (matrix (ncol = 12, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_fwveg_C-2",
                                         "coef_fwveg_C-3",
                                         "coef_fwveg_D-1/2",
                                         "coef_fwveg_M-1/2",
                                         "coef_fwveg_O-1a/b",
                                         "coef_elevation",
                                         "coef_dist_infra",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT5[1,1]<-"5"
top_mod_table_FRT5[1,2]<-"escape16 ~ climate2 + fwveg + dm_h_bc + dist_infrastructure_m" 
top_mod_table_FRT5[1,3]<- coef(model.FRT5)[1] #Intercept
top_mod_table_FRT5[1,4]<- coef(model.FRT5)[2] #
top_mod_table_FRT5[1,5]<- coef(model.FRT5)[3] #
top_mod_table_FRT5[1,6]<- coef(model.FRT5)[4] #coefficient 
top_mod_table_FRT5[1,7]<- coef(model.FRT5)[5] #coefficient 
top_mod_table_FRT5[1,8]<- coef(model.FRT5)[6] #coefficient
top_mod_table_FRT5[1,9]<- coef(model.FRT5)[7] #
top_mod_table_FRT5[1,10]<- coef(model.FRT5)[8] #coefficient 
top_mod_table_FRT5[1,11]<- coef(model.FRT5)[9] #coefficient
top_mod_table_FRT5[1,12]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

```

Check.
```{r}
head(top_mod_table_FRT5_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT5_ALL)
str(top_mod_table_FRT5_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)

FRT5_summary_table_mean$FRT<-5
FRT5_summary_table_mean$Model_terms<-"escape ~ climate2 + fwveg + dm_h_bc + dist_infrastructure_m"

```

Save table.

```{r}
write.csv(FRT5_summary_table_mean, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT5_escape.csv")
```


#### FRT 7
```{r}

escape_frt7<- escape2 %>% filter(frt==7)
table(escape_frt7$fwveg, escape_frt7$escape)
escape_frt7$fwveg[escape_frt7$fwveg=="C-7"]<-"M-1/2"
escape_frt7$fwveg[escape_frt7$fwveg=="S-1"]<-"M-1/2"
escape_frt7$veg_escape<-paste(escape_frt7$escape, escape_frt7$fwveg)

table(is.na(escape_frt7$climate1))
table(is.na(escape_frt7$dm_h_bc))
table(is.na(escape_frt7$fwveg))
table(is.na(escape_frt7$road_dist_m))
table(is.na(escape_frt7$s___300))
table(is.na(escape_frt7$win_spg))
table(is.na(escape_frt7$escape))


cor.test(escape_frt7$climate1, escape_frt7$dm_h_bc)
cor.test(escape_frt7$climate1, escape_frt7$s___300)
cor.test(escape_frt7$dm_h_bc, escape_frt7$s___300)
cor.test(escape_frt7$road_dist_m, escape_frt7$dist_infrastructure_m  ) # highly correlated

escape_frt7$log_road<-log(escape_frt7$road_dist_m+1)
escape_frt7$log_infr<-log(escape_frt7$dist_infrastructure_m  +1)

ggplot(escape_frt7, aes(x=as.factor(escape), y=road_dist_m))+
  geom_boxplot()
ggplot(escape_frt7, aes(x=as.factor(escape), y=dist_infrastructure_m)) + 
  geom_boxplot()
ggplot(escape_frt7, aes(x=as.factor(escape), y=log_road))+
  geom_boxplot()
ggplot(escape_frt7, aes(x=as.factor(escape), y=log_infr)) + 
  geom_boxplot()
hist(escape_frt7$road_dist_m)
hist(escape_frt7$log_road)
hist(escape_frt7$log_infr)



#Run model using dat1
model_ft7<-glm(escape ~ climate1 + fwveg + s___300 + dm_h_bc + aspect_cardinal + log_road + log_infr + win_spg, family = binomial, data = escape_frt7)
#1223

model_ft7b<-glm(escape ~ climate1 + fwveg + s___300 + dm_h_bc + aspect_cardinal + log_road + win_spg, family = binomial, data = escape_frt7)
AIC(model_ft7b)#1223

model_ft7c<-glm(escape ~ climate1 + fwveg + s___300 + dm_h_bc + aspect_cardinal + log_infr + win_spg, family = binomial, data = escape_frt7) #1222
AIC(model_ft7c)
Anova(model_ft7c, type=3) 

#toss out slope
model_ft7<-glm(escape ~ climate1 + fwveg + dm_h_bc + aspect_cardinal + log_infr + win_spg, family = binomial, data = escape_frt7)
Anova(model_ft7, type=3) 

#toss out win spg
model_ft7<-glm(escape ~ climate1 + fwveg + dm_h_bc + aspect_cardinal + log_infr, family = binomial, data = escape_frt7)
Anova(model_ft7, type=3) 

#toss out log_infr
model_ft7<-glm(escape ~ climate1 + fwveg + dm_h_bc + aspect_cardinal, family = binomial, data = escape_frt7)
Anova(model_ft7, type=3) 

#toss out elevation
model_ft7<-glm(escape ~ climate1 + fwveg + aspect_cardinal, family = binomial, data = escape_frt7)
#1227
Anova(model_ft7, type=3) 

#toss out aspect
model_ft7<-glm(escape ~ climate1 + fwveg, family = binomial, data = escape_frt7) #1228
Anova(model_ft7, type=3) 


#######################
### TOP MODEL
#######################
model_ft7e<-glm(escape ~ climate1 + fwveg, family = binomial, data = escape_frt7)
hist(escape_frt7$climate1)

ggplot(escape_frt7, aes(x=as.character(escape), y=climate1)) +
  geom_boxplot() 

table(is.na(escape_frt7$climate1))
```



```{r}
model_ft7g<-glm(escape ~ climate1 + fwveg, family = binomial, data = escape_frt7)

# model diagnostic plots
binnedplot (fitted(model_ft7g), 
            residuals(model_ft7g), 
            nclass = NULL)

#Partial Residuals

visreg(model_ft7g)

```

We should repeat the above several times and take the mean of the coefficients.

```{r}

#change order of vegetation factors as there are not many C1 observations
escape_frt7$fwveg <- factor(escape_frt7$fwveg, levels=c("D-1/2", "C-1", "C-2","C-3","M-1/2", "N", "O-1a/b"))

model_ft7g<-glm(escape ~ climate1 + fwveg, family = binomial, data = escape_frt7)
summary(model_ft7g)



#Create a new blank table and get AUC too
top_mod_table_FRT7_ALL <- data.frame (matrix (ncol = 10, nrow = 0))
colnames (top_mod_table_FRT7_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_fwveg_C-1",
                                         "coef_fwveg_C-2",
                                         "coef_fwveg_C-3",
                                         "coef_fwveg_M-1/2",
                                         "coef_fwveg_O-1a/b",
                                         "AUC")

escape_frt7<-as.data.frame(escape_frt7)
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt7$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt7[ trainIndex,]
   Valid <- escape_frt7[-trainIndex,]
   
#Model   
model.FRT7<-glm(escape ~ climate1 + fwveg, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT7, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT5 <- data.frame (matrix (ncol = 10, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_fwveg_C-1",
                                         "coef_fwveg_C-2",
                                         "coef_fwveg_C-3",
                                         "coef_fwveg_M-1/2",
                                         "coef_fwveg_O-1a/b",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT5[1,1]<-"7"
top_mod_table_FRT5[1,2]<-"escape ~ climate1 + fwveg" 
top_mod_table_FRT5[1,3]<- coef(model.FRT7)[1] #Intercept
top_mod_table_FRT5[1,4]<- coef(model.FRT7)[2] #
top_mod_table_FRT5[1,5]<- coef(model.FRT7)[3] 
top_mod_table_FRT5[1,6]<- coef(model.FRT7)[4] #Intercept
top_mod_table_FRT5[1,7]<- coef(model.FRT7)[5] #
top_mod_table_FRT5[1,8]<- coef(model.FRT7)[6] 
top_mod_table_FRT5[1,9]<- coef(model.FRT7)[7] #Intercept
top_mod_table_FRT5[1,10]<- mod.auc

top_mod_table_FRT7_ALL<-rbind(top_mod_table_FRT7_ALL, top_mod_table_FRT5)

}

```

Check.
```{r}
head(top_mod_table_FRT7_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT7_ALL)
str(top_mod_table_FRT7_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT7_ALL<- top_mod_table_FRT7_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT7_ALL$FRT<-7
summary_top_mod_table_FRT7_ALL$Model_terms<-"escape ~ climate1 + fwveg" 
summary_top_mod_table_FRT7_ALL$Model_Intercept<-"D-1/2" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT7_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT7_escape.csv")
```

# note FRT 9 was joined with FRT 11 because of lack of data for both locations and because they are next to one another in the north.


#### FRT 10
```{r}
escape_frt10<- escape2 %>% filter(frt==10)
table(escape_frt10$fwveg, escape_frt10$escape)
escape_frt10$fwveg[escape_frt10$fwveg=="S-1"]<-"M-1/2"
escape_frt10$veg_escape<-paste(escape_frt10$escape, escape_frt10$fwveg)

table(is.na(escape_frt10$climate1))
table(is.na(escape_frt10$dm_h_bc))
table(is.na(escape_frt10$fwveg))
table(is.na(escape_frt10$win_sum))
table(is.na(escape_frt10$road_dist_m))
table(is.na(escape_frt10$s___300))
#table(is.na(escape_frt10$fire_cs))
table(is.na(escape_frt10$escape))

cor.test(escape_frt10$road_dist_m, escape_frt10$dist_infrastructure_m)
cor.test(escape_frt10$climate1, escape_frt10$s___300)
cor.test(escape_frt10$climate1, escape_frt10$dm_h_bc)


escape_frt10$log_infra<-log(escape_frt10$dist_infrastructure_m+1)

escape_frt10$fwveg <- factor(escape_frt10$fwveg, levels=c("C-3","C-2","C-5", "C-7","D-1/2", "M-1/2", "M-3", "N"))

#Run model using dat1
model_ft10<-glm(escape ~ climate1 + fwveg  + s___300 + dm_h_bc +aspect_cardinal + road_dist_m + dist_infrastructure_m + win_sum, family = binomial, data = escape_frt10) # 602.9

model_ft10<-glm(escape ~ climate1 + fwveg  + s___300 + dm_h_bc  +aspect_cardinal + log(road_dist_m+1) + dist_infrastructure_m + win_sum, family = binomial, data = escape_frt10) # 602.9

model_ft10<-glm(escape ~ climate1 + fwveg  + s___300 + dm_h_bc + aspect_cardinal + road_dist_m + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt10) # 605

model_ft10<-glm(escape ~ climate1 + fwveg  + s___300 + dm_h_bc +aspect_cardinal + log(road_dist_m+1) + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt10) # 603


model_ft10<-glm(escape ~ climate1 + fwveg  + s___300 + dm_h_bc  +aspect_cardinal + road_dist_m + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt10) # 601
Anova(model_ft10, type=3) 

#Remove least significant interaction
model_ft10<-glm(escape ~ climate1 + fwveg  + s___300 + dm_h_bc +aspect_cardinal + road_dist_m + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt10) # 724.7146
Anova(model_ft10, type=3) 

model_ft10<-glm(escape ~ climate1 + fwveg  + s___300 + dm_h_bc + road_dist_m + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt10) # 724.7146
Anova(model_ft10, type=3) 

model_ft10<-glm(escape ~ climate1 + fwveg  + s___300 + road_dist_m + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt10) # 724.7146
Anova(model_ft10, type=3) 

model_ft10<-glm(escape ~ climate1 + fwveg  + s___300 + road_dist_m + log(dist_infrastructure_m+1), family = binomial, data = escape_frt10) # 724.7146
Anova(model_ft10, type=3) 

model_ft10<-glm(escape ~ climate1  + s___300 + road_dist_m + log(dist_infrastructure_m+1), family = binomial, data = escape_frt10) # 724.7146
Anova(model_ft10, type=3) 

model_ft10<-glm(escape ~ climate1  + s___300 + log_infra, family = binomial, data = escape_frt10) # 724.7146
Anova(model_ft10, type=3) 

visreg(model_ft10)


#######################
### TOP MODEL
#######################
#Remove least term ~ s___300

model_ft10<-glm(escape ~ climate1  + s___300 + log_infra, family = binomial, data = escape_frt10) # 724.7146

hist(escape_frt10$climate1)
hist(escape_frt10$s___300)
hist(escape_frt10$log_infra)

ggplot(escape_frt10, aes(x=as.character(escape), y=climate1)) +
  geom_boxplot() 
ggplot(escape_frt10, aes(x=as.character(escape), y=s___300)) +
  geom_boxplot()
ggplot(escape_frt10, aes(x=as.character(escape), y=log_infra)) +
  geom_boxplot()


table(escape_frt10$escape) #0 = 475 and 1 = 171 not bad actually.

# model diagnostic plots
binnedplot (fitted(model_ft10), 
            residuals(model_ft10), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")


```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft10)

#Create a new blank table and get AUC too
top_mod_table_FRT10_ALL <- data.frame (matrix (ncol = 7, nrow = 0))
colnames (top_mod_table_FRT10_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_slope",
                                         "coef_log_infr",
                                         "AUC")

escape_frt10<-as.data.frame(escape_frt10)
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt10$escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt10[ trainIndex,]
   Valid <- escape_frt10[-trainIndex,]
   
#Model   
model.FRT10<-glm(escape ~ climate1  + s___300 + log_infra, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT10, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT10 <- data.frame (matrix (ncol = 7, nrow = 0))
colnames (top_mod_table_FRT10 ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                         "coef_slope",
                                         "coef_log_infr",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT10[1,1]<-"10"
top_mod_table_FRT10[1,2]<-"escape ~ climate1 + slope  + log_infra" 
top_mod_table_FRT10[1,3]<- coef(model.FRT10)[1] 
top_mod_table_FRT10[1,4]<- coef(model.FRT10)[2] 
top_mod_table_FRT10[1,5]<- coef(model.FRT10)[3] 
top_mod_table_FRT10[1,6]<- coef(model.FRT10)[4] 
top_mod_table_FRT10[1,7]<- mod.auc

top_mod_table_FRT10_ALL<-rbind(top_mod_table_FRT10_ALL, top_mod_table_FRT10)

}

```

Check.
```{r}
head(top_mod_table_FRT10_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT10_ALL)
str(top_mod_table_FRT10_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT10_ALL<- top_mod_table_FRT10_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT10_ALL$FRT<-10
summary_top_mod_table_FRT10_ALL$Model_terms<-"escape ~ climate1 + slope + log_infra" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT10_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT10_escape.csv")
```

#### FRT 11

```{r}
escape_frt11<- escape2 %>% filter(frt==11)
ggplot(escape_frt11, aes(ig_mnth, fill = as.factor(escape))) +
  geom_histogram()

ggplot(escape_frt11, aes(x=as.factor(escape), y=Tave05)) +
  geom_boxplot()

ggplot(escape_frt11, aes(x=as.factor(escape), y=PPT05)) +
  geom_boxplot()

table(escape_frt11$escape,escape_frt11$fwveg)
escape_frt11[fwveg=="S-1", fwveg:="M-1/2"]
escape_frt11<-escape_frt11[!fwveg %in% c("W", "N"),]
escape_frt11$veg_escape<-paste(escape_frt11$escape, escape_frt11$fwveg)

table(escape_frt11$fwveg, escape_frt11$escape)

escape_frt11$fwveg <- factor(escape_frt11$fwveg, levels=c("C-3", "C-1", "C-2","C-5", "C-7","D-1/2", "M-1/2", "O-1a/b"))

table(is.na(escape_frt11$climate1))
table(is.na(escape_frt11$dm_h_bc))
table(is.na(escape_frt11$fwveg))
table(is.na(escape_frt11$win_sum))
table(is.na(escape_frt11$road_dist_m))
table(is.na(escape_frt11$s___300))

escape_frt11$log_road<-log(escape_frt11$road_dist_m+1)
escape_frt11$log_infr<- log(escape_frt11$dist_infrastructure_m+1)

cor.test(escape_frt11$road_dist_m, escape_frt11$dist_infrastructure_m) # correlated 0.72
cor.test(escape_frt11$climate1, escape_frt11$dm_h_bc) # elevation and climate are correlated -0.89
cor.test(escape_frt11$climate2, escape_frt11$dm_h_bc)
cor.test(escape_frt11$dm_h_bc, escape_frt11$s___300)
cor.test(escape_frt11$dm_h_bc, escape_frt11$win_sum)

ggplot(escape_frt11, aes(x=as.factor(escape), y=road_dist_m)) +
  geom_boxplot()

ggplot(escape_frt11, aes(x=as.factor(escape), y=dist_infrastructure_m)) +
  geom_boxplot()

ggplot(escape_frt11, aes(x=as.factor(escape), y=log(dist_infrastructure_m+1))) +
  geom_boxplot()

hist(escape_frt11$dist_infrastructure_m)
hist(log(escape_frt11$dist_infrastructure_m+1))

# there is one rainfall value that is way bigger tan the others and Im worried its driving the patterns so Ill remove it
escape_frt11<-escape_frt11[climate2<150,]


#Run model using dat1 checking if log road or log infrastructure is better
model_ft11<-glm(escape ~ climate1 +climate2 + fwveg  + s___300 + aspect_cardinal + road_dist_m +dist_infrastructure_m + win_sum, family = binomial, data = escape_frt11)
AIC(model_ft11) # 431

model_ft11<-glm(escape ~ climate1+climate2 + fwveg  + s___300 + aspect_cardinal + road_dist_m + win_sum, family = binomial, data = escape_frt11) # 442

model_ft11<-glm(escape ~ climate1+climate2 + fwveg  + s___300 + aspect_cardinal + dist_infrastructure_m + win_sum, family = binomial, data = escape_frt11) # 429

model_ft11<-glm(escape ~ climate1+climate2 + fwveg  + s___300 + aspect_cardinal + log(dist_infrastructure_m+1) + win_sum, family = binomial, data = escape_frt11) # 427
Anova(model_ft11, type=3)

# drop win_sum
model_ft11<-glm(escape ~ climate1 + climate2 + fwveg  + s___300 + aspect_cardinal + log(dist_infrastructure_m+1), family = binomial, data = escape_frt11) # 426
Anova(model_ft11, type=3)

# remove aspect
model_ft11a<-glm(escape ~ climate1 + climate2 + fwveg +  s___300 + log(dist_infrastructure_m+1), family = binomial, data = escape_frt11)  # 427
Anova(model_ft11a, type=3)

# drop fwveg
model_ft11b<-glm(escape ~ climate1 + climate2 +  s___300 + log(dist_infrastructure_m+1), family = binomial, data = escape_frt11)  # 421
anova(model_ft11a, model_ft11b, test="Chisq")
Anova(model_ft11b, type=3)
visreg(model_ft11b)
setorder(escape_frt11, cols = - "climate2")   

model_ft11<-glm(escape ~ climate1 + climate2  + s___300 + log(dist_infrastructure_m+1), family = binomial, data = escape_frt11) # 818
Anova(model_ft11, type=3)


#######################
### TOP MODEL
#######################
#Remove least term ~ s___300

hist(escape_frt11$climate1)
hist(escape_frt11$climate2)
hist(escape_frt11$dist_infrastructure_m)

table(escape_frt11$escape) 

# model diagnostic plots
binnedplot (fitted(model_ft11), 
            residuals(model_ft11), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

escape_frt11<- escape_frt11 %>% drop_na(escape)
escape_frt11$resids<-resid(model_ft11)

binnedplot (escape_frt11$climate1, 
            escape_frt11$resids,  
            nclass = NULL)

binnedplot (escape_frt11$dist_infrastructure_m, 
            escape_frt11$resids,  
            nclass = NULL)

# Diagnostic plots look good
```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft11)

#Create a new blank table and get AUC too
top_mod_table_FRT11_ALL <- data.frame (matrix (ncol = 8, nrow = 0))
colnames (top_mod_table_FRT11_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                          "coef_climate_2",
                                          "coef_slope",
                                         "coef_log_dist_infra",
                                         "AUC")

escape_frt11<-as.data.frame(escape_frt11)
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt11$escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt11[ trainIndex,]
   Valid <- escape_frt11[-trainIndex,]
   
#Model   
model.FRT11<-glm(escape ~ climate1 + climate2  + s___300 + log_infr, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT11, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT11 <- data.frame (matrix (ncol = 8, nrow = 0))
colnames (top_mod_table_FRT11 ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_1",
                                          "coef_climate_2",
                                          "coef_slope",
                                         "coef_log_dist_infra",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT11[1,1]<-"11"
top_mod_table_FRT11[1,2]<-"escape ~ climate1 + climate2 + slope + log_dist_infra" 
top_mod_table_FRT11[1,3]<- coef(model.FRT11)[1] #Intercept
top_mod_table_FRT11[1,4]<- coef(model.FRT11)[2] #
top_mod_table_FRT11[1,5]<- coef(model.FRT11)[3] #
top_mod_table_FRT11[1,6]<- coef(model.FRT11)[4] #
top_mod_table_FRT11[1,7]<- coef(model.FRT11)[5] #
top_mod_table_FRT11[1,8]<- mod.auc

top_mod_table_FRT11_ALL<-rbind(top_mod_table_FRT11_ALL, top_mod_table_FRT11)

}

```

Check.
```{r}
head(top_mod_table_FRT11_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT11_ALL)
str(top_mod_table_FRT11_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT11_ALL<- top_mod_table_FRT11_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT11_ALL$FRT<-11
summary_top_mod_table_FRT11_ALL$Model_terms<-"escape ~ climate1 + climate2 + slope + dist_infra_m" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT11_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT11_escape.csv")
```

#### FRT 12
```{r}
escape_frt12<- escape2 %>% filter(frt==12)
table(escape2$frt)
dim(escape_frt12)
table(escape_frt12$escape,escape_frt12$fwveg)
escape_frt12$fwveg[escape_frt12$fwveg=="C-1"]<-"C-3"
escape_frt12$veg_escape<-paste(escape_frt12$escape, escape_frt12$fwveg)

escape_frt12$fwveg <- factor(escape_frt12$fwveg, levels=c("C-3", "C-2","C-5", "C-7","D-1/2", "M-1/2", "O-1a/b"))
escape_frt12$log_road<-log(escape_frt12$road_dist_m+1)
escape_frt12$log_infr<-log(escape_frt12$dist_infrastructure_m+1)

table(is.na(escape_frt12$climate1))
table(is.na(escape_frt12$dm_h_bc))
table(is.na(escape_frt12$fwveg))
table(is.na(escape_frt12$win_sum))
table(is.na(escape_frt12$road_dist_m))
table(is.na(escape_frt12$s___300))
table(is.na(escape_frt12$escape))

cor.test(escape_frt12$road_dist_m, escape_frt12$dist_infrastructure_m)
cor.test(escape_frt12$log_road, escape_frt12$log_infr)
cor.test(escape_frt12$climate1, escape_frt12$climate2)
cor.test(escape_frt12$climate1, escape_frt12$dm_h_bc) # these are correlated!
cor.test(escape_frt12$dm_h_bc, escape_frt12$climate2)
cor.test(escape_frt12$win_sum, escape_frt12$win_spg) # very correlated

#Run model using dat1

model_ft12<-glm(escape ~ climate1 + climate2 + fwveg  + s___300 + dm_h_bc + aspect_cardinal + win_sum + log_road + log_infr, family = binomial, data = escape_frt12)
#3900

model_ft12<-glm(escape ~ climate1 + climate2 + fwveg  + s___300 + dm_h_bc + aspect_cardinal + win_sum + road_dist_m + log_infr, family = binomial, data = escape_frt12)
#3884
model_ft12<-glm(escape ~ climate1 + climate2 + fwveg  + s___300 + dm_h_bc + aspect_cardinal + win_sum + log_road + dist_infrastructure_m, family = binomial, data = escape_frt12)
#3895
model_ft12<-glm(escape ~ climate1 + climate2 + fwveg  + s___300 + dm_h_bc + aspect_cardinal + win_sum + road_dist_m + dist_infrastructure_m, family = binomial, data = escape_frt12)
#3890


model_ft12<-glm(escape ~ climate1 + climate2 + fwveg  + s___300 + dm_h_bc + aspect_cardinal + win_sum + road_dist_m + log_infr, family = binomial, data = escape_frt12)
#4583
Anova(model_ft12, type=3)

#drop elevatiom
model_ft12<-glm(escape ~ climate1 + climate2 + fwveg  + s___300 + aspect_cardinal + win_sum + road_dist_m + log_infr, family = binomial, data = escape_frt12)
#3898
Anova(model_ft12, type=3)

# drop climate1
model_ft12<-glm(escape ~ climate2 + fwveg  + s___300 + aspect_cardinal + win_sum + road_dist_m + log_infr, family = binomial, data = escape_frt12)
#3898
Anova(model_ft12, type=3)

#drop slope
model_ft12a<-glm(escape ~ climate2 + fwveg + aspect_cardinal + win_sum + road_dist_m + log_infr, family = binomial, data = escape_frt12)
#3898
Anova(model_ft12, type=3)

# drop aspect
model_ft12b<-glm(escape ~ climate2 + fwveg + win_sum + road_dist_m + log_infr, family = binomial, data = escape_frt12)
#3898
Anova(model_ft12b, type=3)
anova(model_ft12a, model_ft12b, test="Chisq")
visreg(model_ft12b)

# Im going to remove wind because it does not change the fit very much and is only adding 0.03% information 


#######################
### TOP MODEL
#######################
#Remove least term ~ s___300

ggplot(escape_frt12, aes(x=as.factor(escape), y=climate1))+
  geom_boxplot()

ggplot(escape_frt12, aes(x=as.factor(escape), y=climate2))+
  geom_boxplot()


hist(escape_frt12$climate2)
hist(escape_frt12$win_sum)
hist(escape_frt12$dist_infrastructure_m)
hist(escape_frt12$road_dist_m)

ggplot(escape_frt12, aes(x=as.factor(escape), y=win_sum)) +
  geom_boxplot()
ggplot(escape_frt12, aes(x=as.factor(escape), y=road_dist_m)) +
  geom_boxplot()
ggplot(escape_frt12, aes(x=as.factor(escape), y=log_infr)) +
  geom_boxplot()

table(escape_frt12$escape) 
table(escape_frt12$fwveg)

# model diagnostic plots
binnedplot (fitted(model_ft12b), 
            residuals(model_ft12b), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")


```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft12b)

#Create a new blank table and get AUC too
top_mod_table_FRT12_ALL <- data.frame (matrix (ncol = 14, nrow = 0))
colnames (top_mod_table_FRT12_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_2",
                                         "coef_fwvegC-2",
                                         "coef_fwvegC-5",
                                         "coef_fwvegC-7",
                                         "coef_fwvegD-1/2",
                                         "coef_fwvegM-1/2",
                                         "coef_fwvegO-1a/b",
                                         "coef_win_sum",
                                         "coef_road_dist_m",
                                         "coef_log_dist_infr",
                                         "AUC")

escape_frt12<-as.data.frame(escape_frt12)
```

Let's run it 100 times to get good mean values.

```{r}

for (g in 1:100){
  
  print(g)

prop<-0.75
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt12$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt12[ trainIndex,]
   Valid <- escape_frt12[-trainIndex,]
   
#Model   
model.FRT12<-glm(escape ~ climate2 + fwveg + win_sum + road_dist_m + log_infr, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT12, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT12 <- data.frame (matrix (ncol = 14, nrow = 0))
colnames (top_mod_table_FRT12 ) <- c ("FRT", "Model_terms", "intercept",
                                          "coef_climate_2",
                                         "coef_fwvegC-2",
                                         "coef_fwvegC-5",
                                         "coef_fwvegC-7",
                                         "coef_fwvegD-1/2",
                                         "coef_fwvegM-1/2",
                                         "coef_fwvegO-1a/b",
                                         "coef_win_sum",
                                         "coef_road_dist_m",
                                         "coef_log_dist_infr",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT12[1,1]<-"12"
top_mod_table_FRT12[1,2]<-"escape ~ climate1 + climate2 + fwveg + win_sum + road_dist_m + dist_infrastructure_m" 
top_mod_table_FRT12[1,3]<- coef(model.FRT12)[1] #Intercept
top_mod_table_FRT12[1,4]<- coef(model.FRT12)[2] #
top_mod_table_FRT12[1,5]<- coef(model.FRT12)[3] #
top_mod_table_FRT12[1,6]<- coef(model.FRT12)[4] #coefficient 
top_mod_table_FRT12[1,7]<- coef(model.FRT12)[5] #coefficient 
top_mod_table_FRT12[1,8]<- coef(model.FRT12)[6] #Intercept
top_mod_table_FRT12[1,9]<- coef(model.FRT12)[7] #
top_mod_table_FRT12[1,10]<- coef(model.FRT12)[8] #
top_mod_table_FRT12[1,11]<- coef(model.FRT12)[9] #coefficient 
top_mod_table_FRT12[1,12]<- coef(model.FRT12)[10] #coefficient 
top_mod_table_FRT12[1,13]<- coef(model.FRT12)[11] #Intercept
top_mod_table_FRT12[1,14]<- mod.auc
top_mod_table_FRT12_ALL<-rbind(top_mod_table_FRT12_ALL, top_mod_table_FRT12)

}

```

Check.
```{r}
head(top_mod_table_FRT12_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT12_ALL)
str(top_mod_table_FRT12_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT12_ALL<- top_mod_table_FRT12_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT12_ALL$FRT<-12
summary_top_mod_table_FRT12_ALL$intercept_veg<-"C-3"

summary_top_mod_table_FRT12_ALL$Model_terms<-"escape ~ climate2 + fwveg + win_sum + road_dist_m + log_dist_infrastructure" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT12_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT12_escape.csv")
```


#### FRT 13
```{r}
escape_frt13<- escape2 %>% filter(frt==13)
table(escape_frt13$fwveg, escape_frt13$escape)
escape_frt13$fwveg[escape_frt13$fwveg=="C-1"]<-"C-3"
escape_frt13$veg_escape<-paste(escape_frt13$escape, escape_frt13$fwveg)
escape_frt13$fwveg <- factor(escape_frt13$fwveg, levels=c("C-3", "C-2","C-5", "C-7","D-1/2", "M-1/2", "O-1a/b", "S-1"))


table(escape_frt13$fwveg, escape_frt13$escape)

table(is.na(escape_frt13$climate1))
table(is.na(escape_frt13$dm_h_bc))
table(is.na(escape_frt13$fwveg))
table(is.na(escape_frt13$road_dist_m))
table(is.na(escape_frt13$s___300))
table(is.na(escape_frt13$escape))

ggplot(escape_frt13, aes(x=as.factor(escape), y=climate1)) +
  geom_boxplot()

ggplot(escape_frt13, aes(x=as.factor(escape), y=climate2)) +
  geom_boxplot()
ggplot(escape_frt13, aes(x=as.factor(escape), y=(CMI08+CMI09)/2)) +
  geom_boxplot()



# start here

cor.test(escape_frt13$road_dist_m,escape_frt13$dist_infrastructure_m)
cor.test(escape_frt13$climate1, escape_frt13$dm_h_bc) # these are almost correlated 0.69!
cor.test(escape_frt13$climate2, escape_frt13$dm_h_bc) 
cor.test(escape_frt13$climate1, escape_frt13$climate2)
cor.test(escape_frt13$dm_h_bc, escape_frt13$s___300)
cor.test(escape_frt13$win_sum, escape_frt13$win_spg) # very correlated
cor.test(escape_frt13$dm_h_bc, escape_frt13$dist_infrastructure_m)

escape_frt13$log_road<-log(escape_frt13$road_dist_m+1)
escape_frt13$log_infr<- log(escape_frt13$dist_infrastructure_m+1)

#Run model using dat1
model_ft13<-glm(escape ~ climate2 + fwveg  + s___300 + dm_h_bc + aspect_cardinal + win_sum + log_road + log_infr, family = binomial, data = escape_frt13)
Anova(model_ft13, type=3)
#9437


model_ft13<-glm(escape ~ climate1 + climate2 + fwveg  + s___300 +aspect_cardinal + win_sum + log_road + log_infr, family = binomial, data = escape_frt13)
Anova(model_ft13, type=3)
visreg(model_ft13)
#9761

# Best one leaves out dem

model_ft13<-glm(escape ~ climate2 + fwveg  + dm_h_bc + s___300 + aspect_cardinal + road_dist_m + log_infr, family = binomial, data = escape_frt13)
#9365

model_ft13<-glm(escape ~ climate2 + fwveg  + dm_h_bc + s___300 + aspect_cardinal + win_sum + road_dist_m + dist_infrastructure_m, family = binomial, data = escape_frt13)
#9374

# Top model
model_ft13<-glm(escape ~ climate2 + fwveg  + dm_h_bc + s___300 + aspect_cardinal + win_sum + road_dist_m + log_infr, family = binomial, data = escape_frt13)

AIC(model_ft13) #9656.702
Anova(model_ft13, type=3)
summary(model_ft13)
visreg(model_ft13)

#######################
### TOP MODEL
#######################
hist(escape_frt13$climate1)
hist(escape_frt13$climate2)
hist(escape_frt13$road_dist_m)

ggplot(escape_frt13, aes(x=as.character(escape), y=dist_infrastructure_m)) +
  geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape), y=road_dist_m)) +
  geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape), y=climate1)) +
  geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape), y=climate2)) +
  geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape), y=s___300)) +geom_boxplot()
ggplot(escape_frt13, aes(x=as.character(escape), y=win_sum)) +geom_boxplot()

table(escape_frt13$fwveg)

# model diagnostic plots
binnedplot (fitted(model_ft13), 
            residuals(model_ft13), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")



#Partial Residuals

visreg(model_ft13)

escape_frt13<-data.table(escape_frt13)

escape_frt13<-escape_frt13[!is.na(fwveg),]
escape_frt13<-escape_frt13[aspect_cardinal!="O",]


```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft13)



#Create a new blank table and get AUC too
top_mod_table_FRT13_ALL <- data.frame (matrix (ncol = 19, nrow = 0))
colnames (top_mod_table_FRT13_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_fwvegC-2",
                                         "coef_fwvegC-5",
                                         "coef_fwvegC-7",
                                         "coef_fwvegD-1/2",
                                         "coef_fwvegM-1/2",
                                         "coef_fwvegO-1a/b",
                                         "coef_fwvegS-1",
                                         "coef_elevation",
                                         "coef_slope",
                                         "coef_aspect_S",
                                         "coef_aspect_O",
                                         "coef_win_sum",
                                         "coef_roads_m",
                                         "coef_log_infr",
                                         "AUC")

escape_frt13<-as.data.frame(escape_frt13)

```

Let's run it 100 times to get good mean values.

```{r}
prop<-0.75

for (g in 1:100){
  
  print(g)

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt13$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt13[ trainIndex,]
   Valid <- escape_frt13[-trainIndex,]
   
#Model   
model.FRT13<-glm(escape ~ climate2 + fwveg  + dm_h_bc + s___300 + aspect_cardinal + win_sum + road_dist_m + log_infr, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT13, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT13 <- data.frame (matrix (ncol = 19, nrow = 0))
colnames (top_mod_table_FRT13 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_2",
                                         "coef_fwvegC-2",
                                         "coef_fwvegC-5",
                                         "coef_fwvegC-7",
                                         "coef_fwvegD-1/2",
                                         "coef_fwvegM-1/2",
                                         "coef_fwvegO-1a/b",
                                         "coef_fwvegS-1",
                                         "coef_elevation",
                                         "coef_slope",
                                         "coef_aspect_S",
                                         "coef_aspect_O",
                                         "coef_win_sum",
                                         "coef_roads_m",
                                         "coef_log_infr",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT13[1,1]<-"13"
top_mod_table_FRT13[1,2]<-"escape ~ climate2 + fwveg  + dm_h_bc + s___300 + aspect_cardinal + win_sum + road_dist_m + log_infr" 
top_mod_table_FRT13[1,3]<- coef(model.FRT13)[1] #Intercept
top_mod_table_FRT13[1,4]<- coef(model.FRT13)[2] #
top_mod_table_FRT13[1,5]<- coef(model.FRT13)[3] #
top_mod_table_FRT13[1,6]<- coef(model.FRT13)[4] #coefficient 
top_mod_table_FRT13[1,7]<- coef(model.FRT13)[5] #coefficient 
top_mod_table_FRT13[1,8]<- coef(model.FRT13)[6] #Intercept
top_mod_table_FRT13[1,9]<- coef(model.FRT13)[7] #
top_mod_table_FRT13[1,10]<- coef(model.FRT13)[8] #
top_mod_table_FRT13[1,11]<- coef(model.FRT13)[9] #coefficient 
top_mod_table_FRT13[1,12]<- coef(model.FRT13)[10] #coefficient 
top_mod_table_FRT13[1,13]<- coef(model.FRT13)[11] #Intercept
top_mod_table_FRT13[1,14]<- coef(model.FRT13)[12] #
top_mod_table_FRT13[1,15]<- coef(model.FRT13)[13] #
top_mod_table_FRT13[1,16]<- coef(model.FRT13)[14] #coefficient 
top_mod_table_FRT13[1,17]<- coef(model.FRT13)[15]
top_mod_table_FRT13[1,18]<- coef(model.FRT13)[16]
top_mod_table_FRT13[1,19]<- mod.auc
top_mod_table_FRT13_ALL<-rbind(top_mod_table_FRT13_ALL, top_mod_table_FRT13)

}

```

Check.
```{r}
head(top_mod_table_FRT13_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT13_ALL)
str(top_mod_table_FRT13_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT13_ALL<- top_mod_table_FRT13_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT13_ALL$FRT<-13
summary_top_mod_table_FRT13_ALL$intercept_veg<-"C-3"

summary_top_mod_table_FRT13_ALL$Model_terms<-"escape ~ climate2 + fwveg  + dm_h_bc + s___300 + aspect_cardinal + win_sum + road_dist_m + log_infr" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT13_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT13_escape.csv")
```


#### FRT 14
```{r}
escape_frt14<- escape2 %>% filter(frt==14)
table(escape_frt14$fwveg, escape_frt14$escape)

escape_frt14$fwveg[escape_frt14$fwveg=="C-5"]<-"C-7"
escape_frt14$fwveg[escape_frt14$fwveg=="S-1"]<-"M-1/2"
escape_frt14$fwveg <- factor(escape_frt14$fwveg, levels=c("C-7", "C-2", "C-3", "D-1/2", "M-1/2", "O-1a/b"))


escape_frt14$veg_escape<-paste(escape_frt14$escape, escape_frt14$fwveg)

cor.test(escape_frt14$road_dist_m, escape_frt14$dist_infrastructure_m)
cor.test(escape_frt14$climate1, escape_frt14$dm_h_bc) # these are correlated!
cor.test(escape_frt14$climate2, escape_frt14$dm_h_bc)
cor.test(escape_frt14$dm_h_bc, escape_frt14$s___300)
hist(as.numeric(escape_frt14$ig_mnth))

escape_frt14$log_road<-log(escape_frt14$road_dist_m+1)
escape_frt14$log_infr<- log(escape_frt14$dist_infrastructure_m+1)

escape_frt14<-escape_frt14[aspect_cardinal != "flat",]

table(is.na(escape_frt14$climate1))
table(is.na(escape_frt14$dm_h_bc))
table(is.na(escape_frt14$fwveg))
table(is.na(escape_frt14$win_sum))
table(is.na(escape_frt14$road_dist_m))
table(is.na(escape_frt14$s___300))
table(is.na(escape_frt14$escape))

escape_frt14<-escape_frt14 %>% filter(!is.na(escape))

#Run model using dat1
model_ft14<-glm(escape ~ climate1 + climate2 + fwveg + dm_h_bc + s___300 + aspect_cardinal + win_sum + log_road + log_infr, family = binomial, data = escape_frt14)
#6817

model_ft14<-glm(escape ~ climate1 + climate2 + fwveg + dm_h_bc + s___300 + aspect_cardinal + win_sum + road_dist_m + log_infr, family = binomial, data = escape_frt14)
#6792

model_ft14<-glm(escape ~ climate1 + climate2 + fwveg + dm_h_bc + s___300 + aspect_cardinal + win_sum + log_road + dist_infrastructure_m  , family = binomial, data = escape_frt14)
#6796

model_ft14<-glm(escape ~ climate1 + climate2 + fwveg + dm_h_bc + s___300 + aspect_cardinal + win_sum + road_dist_m + dist_infrastructure_m  , family = binomial, data = escape_frt14) #6790

model_ft14<-glm(escape ~ climate1 + climate2 + fwveg + s___300 + aspect_cardinal + win_sum + road_dist_m + dist_infrastructure_m  , family = binomial, data = escape_frt14) #6825

model_ft14<-glm(escape ~ climate2 + fwveg + dm_h_bc + s___300 + aspect_cardinal + win_sum + road_dist_m + dist_infrastructure_m  , family = binomial, data = escape_frt14) #6791


#best model
model_ft14<-glm(escape ~ climate2 + fwveg + dm_h_bc + s___300 + aspect_cardinal + win_sum + road_dist_m + dist_infrastructure_m, family = binomial, data = escape_frt14)

AIC(model_ft14) #6788
Anova(model_ft14, type=3) 
visreg(model_ft14)

model_ft14<-glm(escape ~ climate1 + climate2 + fwveg + s___300 + aspect_cardinal + win_sum + road_dist_m + dist_infrastructure_m, family = binomial, data = escape_frt14) #6821

# take out wind summer. Although its significant Im going to leave it out because I dont want to over fit the model

model_ft14<-glm(escape ~ climate1 + climate2 + fwveg + s___300 + aspect_cardinal + road_dist_m + dist_infrastructure_m, family = binomial, data = escape_frt14) #6821

hist(escape_frt14$climate1)
hist(escape_frt14$climate2)
hist(escape_frt14$road_dist_m)
hist(escape_frt14$dist_infrastructure_m)

ggplot(escape_frt14, aes(x=as.character(escape), y=climate1)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape), y=climate2)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape), y=s___300)) + geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape), y=win_sum)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape), y=road_dist_m)) +
  geom_boxplot()
ggplot(escape_frt14, aes(x=as.character(escape), y=dist_infrastructure_m)) + geom_boxplot()

table(escape_frt14$escape) #0 = 9123 and 1 = 556 not bad actually.
table(escape_frt14$fwveg)

# model diagnostic plots
binnedplot (fitted(model_ft14), 
            residuals(model_ft14), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft14)


#Create a new blank table and get AUC too
top_mod_table_FRT14_ALL <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table_FRT14_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_climate_2",
                                         "coef_fwvegC-2",
                                         "coef_fwvegC-3",
                                         "coef_fwvegD-1/2",
                                         "coef_fwvegM-1/2",
                                         "coef_fwvegO-1a/b",
                                         "coef_slope",
                                         "coef_aspect_S",
                                         "coef_aspect_O",
                                         "coef_dist_road_m",
                                         "coef_dist_infr_m",
                                         "AUC")
escape_frt14<-as.data.frame(escape_frt14)

```

Let's run it 100 times to get good mean values.

```{r}
prop<-0.75

for (g in 1:100){
  
  print(g)

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(escape_frt14$veg_escape, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- escape_frt14[ trainIndex,]
   Valid <- escape_frt14[-trainIndex,]
   
#Model   
model.FRT14<-glm(escape ~ climate1 + climate2 + fwveg + s___300 + aspect_cardinal + road_dist_m + dist_infrastructure_m, family = binomial, data = dat1)

mod.valid <- predict.glm(model.FRT14, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT14 <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table_FRT14 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_climate_2",
                                         "coef_fwvegC-2",
                                         "coef_fwvegC-3",
                                         "coef_fwvegD-1/2",
                                         "coef_fwvegM-1/2",
                                         "coef_fwvegO-1a/b",
                                         "coef_slope",
                                         "coef_aspect_S",
                                         "coef_aspect_O",
                                         "coef_dist_road_m",
                                         "coef_dist_infr_m",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT14[1,1]<-"14"
top_mod_table_FRT14[1,2]<-"climate1 + climate2 + fwveg + s___300 + aspect_cardinal + road_dist_m + dist_infrastructure_m" 
top_mod_table_FRT14[1,3]<- coef(model.FRT14)[1] #Intercept
top_mod_table_FRT14[1,4]<- coef(model.FRT14)[2] #
top_mod_table_FRT14[1,5]<- coef(model.FRT14)[3] #
top_mod_table_FRT14[1,6]<- coef(model.FRT14)[4] #coefficient 
top_mod_table_FRT14[1,7]<- coef(model.FRT14)[5] #coefficient 
top_mod_table_FRT14[1,8]<- coef(model.FRT14)[6] #Intercept
top_mod_table_FRT14[1,9]<- coef(model.FRT14)[7] #
top_mod_table_FRT14[1,10]<- coef(model.FRT14)[8] #
top_mod_table_FRT14[1,11]<- coef(model.FRT14)[9] #coefficient 
top_mod_table_FRT14[1,12]<- coef(model.FRT14)[10] #coefficient 
top_mod_table_FRT14[1,13]<- coef(model.FRT14)[11] #Intercept
top_mod_table_FRT14[1,14]<- coef(model.FRT14)[12] #Intercept
top_mod_table_FRT14[1,15]<- coef(model.FRT14)[13] #Intercept
top_mod_table_FRT14[1,16]<- mod.auc
top_mod_table_FRT14_ALL<-rbind(top_mod_table_FRT14_ALL, top_mod_table_FRT14)

}

```

Check.
```{r}
head(top_mod_table_FRT14_ALL)

```

Get mean values.

```{r}
names(top_mod_table_FRT14_ALL)
str(top_mod_table_FRT14_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT14_ALL<- top_mod_table_FRT14_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT14_ALL$FRT<-14
summary_top_mod_table_FRT14_ALL$intercept_veg<-"C-7"
summary_top_mod_table_FRT14_ALL$Model_terms<-"escape ~ climate1 + climate2 + fwveg + s___300 + aspect_cardinal + road_dist_m + dist_infrastructure_m" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT14_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT14_escape.csv")
```


#### FRT 15
```{r}
escape_frt15<- escape2 %>% filter(frt==15)
table(escape_frt15$fwveg, escape_frt15$escape)
#escape_frt15$fwveg[escape_frt15$fwveg=="C-7"]<-"C-5"
#escape_frt15$fwveg[escape_frt15$fwveg=="O-1a/b"]<-"C-3"
escape_frt15$fwveg[escape_frt15$fwveg=="S-1"]<-"M-1/2"
escape_frt15$fwveg <- factor(escape_frt15$fwveg, levels=c("C-5", "C-3", "C-7", "D-1/2", "M-1/2", "O-1a/b"))

escape_frt15$log_road<-log(escape_frt15$road_dist_m+1)
escape_frt15$log_infr<- log(escape_frt15$dist_infrastructure_m+1)

ggplot(escape_frt15, aes(x=as.character(escape), y=(Tmax06 + Tmax07 + Tmax08)/3)) +
  geom_boxplot()

ggplot(escape_frt15, aes(x=as.character(escape), y=(PPT06 + PPT07 + PPT08)/3)) +
  geom_boxplot()

escape_frt15$climate1<-(escape_frt15$CMD07 + escape_frt15$CMD08)/3

ggplot(escape_frt15, aes(x=as.character(escape), y=climate1)) +
  geom_boxplot()

escape_frt15$veg_escape<-paste(escape_frt15$escape, escape_frt15$fwveg)

cor.test(escape_frt15$road_dist_m, escape_frt15$dist_infrastructure_m)
cor.test(escape_frt15$climate1, escape_frt15$dm_h_bc) 
cor.test(escape_frt15$climate2, escape_frt15$dm_h_bc)
cor.test(escape_frt15$dm_h_bc, escape_frt15$s___300)

table(is.na(escape_frt15$climate1))
table(is.na(escape_frt15$dm_h_bc))
table(is.na(escape_frt15$fwveg))
table(is.na(escape_frt15$win_sum))
table(is.na(escape_frt15$log_infr))
table(is.na(escape_frt15$s___300))
table(is.na(escape_frt15$escape))

hist(as.numeric(escape_frt15$ig_mnth))
table(as.numeric(escape_frt15$ig_mnth)) # most fires in july and aug so use win_sum

#escape_frt15<- escape_frt15 %>% filter(!is.na(dm_h_bc))
#escape_frt15<- escape_frt15 %>% filter(!is.na(win_sum))


#Run model using dat1 and test if log road or log infra works best
model_ft15<-glm(escape ~ climate1 + fwveg + dm_h_bc + s___300 + aspect_cardinal + log_road + log_infr, family = binomial, data = escape_frt15)

AIC(model_ft15) #2052
Anova(model_ft15, type=3) 

model_ft15<-glm(escape ~ climate1 + fwveg + dm_h_bc + s___300 + aspect_cardinal + road_dist_m + log_infr, family = binomial, data = escape_frt15)
#2050
model_ft15<-glm(escape ~ climate1 + fwveg + dm_h_bc + s___300 + aspect_cardinal + log_road + dist_infrastructure_m, family = binomial, data = escape_frt15)
#2057
model_ft15<-glm(escape ~ climate1 + fwveg + dm_h_bc + s___300 + aspect_cardinal + road_dist_m + dist_infrastructure_m, family = binomial, data = escape_frt15)
#2056

# kick out least significant variables
model_ft15<-glm(escape ~ climate1 + fwveg + dm_h_bc + s___300 + aspect_cardinal + road_dist_m + log_infr, family = binomial, data = escape_frt15)
Anova(model_ft15, type=3) 
#2085

model_ft15<-glm(escape ~ climate1 + dm_h_bc + s___300 + aspect_cardinal + road_dist_m + log_infr, family = binomial, data = escape_frt15)
Anova(model_ft15, type=3) 

model_ft15<-glm(escape ~ climate1 + s___300 + aspect_cardinal + road_dist_m + log_infr, family = binomial, data = escape_frt15)
Anova(model_ft15, type=3) 

model_ft15<-glm(escape ~ climate1 + s___300 + aspect_cardinal + log_infr, family = binomial, data = escape_frt15)
Anova(model_ft15, type=3) 
visreg(model_ft15, scale = "response")
summary(model_ft15)



#######################
### TOP MODEL
#######################
#Remove least term ~ s___300
model_ft15<-glm(escape ~ climate1 + s___300 + aspect_cardinal + log_infr, family = binomial, data = escape_frt15)

hist(escape_frt15$s___300)
hist(escape_frt15$climate1)
escape_frt15 %>%
  ggplot( aes(x=climate1, fill=as.factor(escape))) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity')

hist(escape_frt15$log_infr)

table(escape_frt15$escape) #0 = 948 and 1 = 267 not bad actually.
table(escape_frt15$fwveg, escape_frt15$escape)

# model diagnostic plots
binnedplot (fitted(model_ft15), 
            residuals(model_ft15), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual")


# Diagnostic plots look good

#Partial Residuals

visreg(model_ft15, scale = "response")

```

We should repeat the above several times and take the mean of the coefficients.

```{r}
summary(model_ft15)


#Create a new blank table and get AUC too
top_mod_table_FRT15_ALL <- data.frame (matrix (ncol = 9, nrow = 0))
colnames (top_mod_table_FRT15_ALL ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_slope",
                                         "coef_aspect_S",
                                         "coef_aspect_O",
                                         "coef_log_infr",
                                         "AUC")

escape_frt15<-escape_frt15[!is.na(s___300),]
escape_frt15<-as.data.frame(escape_frt15)
```

Let's run it 100 times to get good mean values.

```{r}
prop<-0.75

for (g in 1:100){
  
  print(g)
  
trainIndex <- createDataPartition(escape_frt15$escape, p = prop,
                                    list = FALSE,
                                    times = 1)
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  dat1 <- escape_frt15[ trainIndex,] # note only 6% of obs are 1's so Im going to sample to get my sample size up to 30% 1's.
   # in total I need 1589 1's
   dat1_1<-dat1 %>% filter(escape==1)
   dat1_0<-dat1 %>% filter(escape==0)
   dat1_1_samp<- sample_n(dat1_1, round(length(dat1$escape)*0.1,0), replace = TRUE)
   
   dat<-rbind(dat1_0, dat1_1_samp)
   Valid <- escape_frt15[-trainIndex,]
   
#Model   
model.FRT15<-glm(escape ~ climate1 + s___300 + aspect_cardinal + log_infr, family = binomial, data = dat)

mod.valid <- predict.glm(model.FRT15, newdata=Valid, type="response")
   
roc_obj <- roc(Valid[,"escape"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_FRT15 <- data.frame (matrix (ncol = 9, nrow = 0))
colnames (top_mod_table_FRT15 ) <- c ("FRT", "Model_terms", "intercept",
                                         "coef_climate_1",
                                         "coef_slope",
                                         "coef_aspect_S",
                                         "coef_aspect_O",
                                         "coef_log_infr",
                                         "AUC")

##Add data for NDT1
top_mod_table_FRT15[1,1]<-"15"
top_mod_table_FRT15[1,2]<-"escape ~ climate1 + s___300 + aspect_cardinal + log_infr" 

top_mod_table_FRT15[1,3]<- coef(model.FRT15)[1] #Intercept
top_mod_table_FRT15[1,4]<- coef(model.FRT15)[2] #
top_mod_table_FRT15[1,5]<- coef(model.FRT15)[3] #
top_mod_table_FRT15[1,6]<- coef(model.FRT15)[4] #coefficient 
top_mod_table_FRT15[1,7]<- coef(model.FRT15)[5] #
top_mod_table_FRT15[1,8]<- coef(model.FRT15)[6] #
top_mod_table_FRT15[1,9]<- mod.auc
top_mod_table_FRT15_ALL<-rbind(top_mod_table_FRT15_ALL, top_mod_table_FRT15)

}

```

Check.
```{r}
head(top_mod_table_FRT15_ALL)



```

Get mean values.

```{r}
names(top_mod_table_FRT15_ALL)
str(top_mod_table_FRT15_ALL)
stderror <- function(x) sd(x)/sqrt(length(x))

summary_top_mod_table_FRT15_ALL<- top_mod_table_FRT15_ALL %>% summarize_if(is.numeric,mean)

summary_top_mod_table_FRT15_ALL$FRT<-15
summary_top_mod_table_FRT15_ALL$intercept_veg<-"C-5"
summary_top_mod_table_FRT15_ALL$Model_terms<-"escape ~ climate1 + s___300 + aspect_cardinal + log_infr" 

```

Save table.

```{r}
write.csv(summary_top_mod_table_FRT15_ALL, file="D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT15_escape.csv")
```
