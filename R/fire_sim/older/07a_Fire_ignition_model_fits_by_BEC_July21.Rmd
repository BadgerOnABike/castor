---
title: "07a_Fire ignition model fit by BEC zone"
author: "Elizabeth Kleynhans and Cora Skaien"
contributor: "Peter Ott"
date: "20/04/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

editor_options:
  chunk_output_type: console
  
<style> 
p.caption {
  font-size: 1.2em;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (kableExtra)
library (data.table)
library (DBI)
library (RPostgreSQL)
library (dplyr)
library (ggplot2)
library (here)
library(ggpubr)
library(arm)
library(tidyr)
library(AICcmodavg)
library(keyring)
library(caret)
library(pROC)
library(rje)

source(here::here("R/functions/R_Postgres.R"))
```


<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

## Introduction

Here, we are running a glm for each separate bec zone to develop a predictive equation so that we can extrapolate fire ignitions into the future. The data that we include in these glms is both vegetation and climate date. The top climate variable for each BEC zone was determined in the script "06_ignition_climate_variable_selection.R". 

Liz note: Vegetation data is a little complicated by the fact that the VRI does not have age, height or volume data for any vegetation types that are not classified as treed (although sometimes it does). Also, it seems like forests on private land lack age, volume and height data. Because I think volume, age and height are likely good predictors of fire severity and occurrence, I split up this analysis into two parts in each BEC zone. 

Firstly, in each BEC zone, we split the data into treed and non-treed then run a glm with climate and vegetation for areas that are classified as treed in the VRI and another separate analysis for areas that are classified as not treed. The fixed effects we include in these analyses are slightly different, i.e. no age, volume or height data in the non-treed areas, which is why we split the analyses up.  

# climate variable selection
In the script "06_ignition_climate_variable_selection.R", we performed an AIC and ROC analysis for each BEC zone including presence/available fire ignition points and a variety of climate variables. For this analysis, we split the data into a training and a validation data set where 75% of the data was used for training and 25% was used for validation. We then fit the model and extracted the AIC and AUC values. This was repeated 100 times and at the end we calculated the average AIC and AUC values. We then also used a different subset of non-fire locations from the initial pruned numbers and repeated the previous step 3-5 times to get consistent results per BEC zone. The climate variable that consistently resulted in the lowest average AIC value is used in this analysis. We will load tables for person and lightning caused is a summary of which climate variables fitted best for each BEC zone. 

Note: Some climate variables resulted in delta AIC values that were very similar and had much less than 2 points difference. Also, the variable with the smallest AIC value did not always have the best AUC value. Regardless of these two issues, we decided to take the climate variable with the smallest average AIC for simplicity. Results will be loaded in for each AIC table. These files were manipulated manually and then saved on to the drive before being uploaded (i.e., it is a simplified table from that generated in the last file, 06_ignition_climate_variable_selection; code for uploading not included prior).

Note: when the rows with NAs are removed, the disturbed ("D") vegtype is removed from the data set and we are losing information on disturbed sites.

```{r, AIC table, echo = F, message = F, eval = T}

climate_variables_lightning<-read.csv("D:/Fire/fire_data/raw_data/ClimateBC_Data/Final_Selected_Climate_Variables_Lightning.csv")
climate_variables_person<-read.csv("D://Fire//fire_data//raw_data//ClimateBC_Data//Final_Selected_Climate_Variables_Person.csv")

head(climate_variables_lightning) 
head(climate_variables_person) 

kable (climate_variables_lightning,
       caption = "<b>Table 1. Top candidate climate variables for lightning caused fires as selected through an AIC analysis for each BEC zone.<b>",
       digits = 2) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)

kable (climate_variables_person,
       caption = "<b>Table 2. Top candidate climate variables for person caused fires as selected through an AIC analysis for each BEC zone.<b>",
       digits = 2) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)

```

## Pull in the data for both lightning and person caused fires. Note, below seems to not be working and currently I am bringing it in from my local computer.

```{r}
connKyle <- dbConnect(drv = RPostgreSQL::PostgreSQL(), 
                      host = key_get('dbhost', keyring = 'postgreSQL'),
                      user = key_get('dbuser', keyring = 'postgreSQL'),
                      dbname = key_get('dbname', keyring = 'postgreSQL'),
                      password = key_get('dbpass', keyring = 'postgreSQL'),
                      port = "5432")
dat_lightning_ <- sf::st_read  (dsn = connKyle, # connKyle
                               query = "SELECT * FROM Data_Lightning")
dbDisconnect (connKyle)

head(dat_lightning_)

```


```{r}
connKyle <- dbConnect(drv = RPostgreSQL::PostgreSQL(), 
                      host = key_get('dbhost', keyring = 'postgreSQL'),
                      user = key_get('dbuser', keyring = 'postgreSQL'),
                      dbname = key_get('dbname', keyring = 'postgreSQL'),
                      password = key_get('dbpass', keyring = 'postgreSQL'),
                      port = "5432")
dat_person_ <- sf::st_read  (dsn = connKyle, # connKyle
                               query = "SELECT * FROM Data_Person")
dbDisconnect (connKyle)

head(dat_person_)

```


When doing the below analyses, it was noticed that disturbed areas often get eliminated when NAs are removed from the final data used for the model. Here, we investigate what variables are missing.

```{r}
dat_Disturbed<-subset(dat_lightning_, dat_lightning_$vegtype=="D")
head(dat_Disturbed)
dat_Disturbed$live_stand_volume_125
table(dat_Disturbed$live_stand_volume_125)
## We see that live_stand_volume does not exist for most disturbed sites (and when it does, it is 0, and one that is 3.103)

hist(dat_Disturbed$proj_age_1) #All under 15 years, as expected given the classification of disturbed if below 15 years

hist(dat_Disturbed$proj_height_1) #When not NA, Mostly all 0-5 m, a small number ~7 m.

##Change all NA for this vegtype to 0
dat_lightning_ <- within(dat_lightning_, live_stand_volume_125[is.na(live_stand_volume_125) & vegtype == 'D'] <- 0)
dat_person_ <- within(dat_person_, live_stand_volume_125[is.na(live_stand_volume_125) & vegtype == 'D'] <- 0)
##Because there will be no effect of stand volume on disturbed veg type, an interaction between these two variables should be included when both are in the model.

```


Now we will create additional columns that have the climate1 and climate2 variables indicated as the top variables for climate. 

```{r}
#View top variable
climate_variables_lightning
names(dat_lightning_)
unique(dat_lightning_$zone)
dat_lightning_$zone<-as.factor(dat_lightning_$zone)
dat_lightning_$zone_numeric<-as.numeric(dat_lightning_$zone)
table(dat_lightning_$zone_numeric)

dat_lightning_$zone_codes<-paste(dat_lightning_$zone, dat_lightning_$zone_numeric)
unique(dat_lightning_$zone_codes)

## Create empty vector
dat_lightning_$climate1<-0
head(dat_lightning_)

dat_lightning_<-dat_lightning_ %>%
    mutate(climate1 = case_when(zone_numeric == 6 ~ tmax08, # CWH
                                zone_numeric == 3 ~ mean_tave05_tave06_tave07_tave08, #BWBS
                                zone_numeric == 7 ~ mean_tave07_tave08, #ESSF
                                zone_numeric == 8 ~ tmax08, # ICH
                                zone_numeric == 12 ~ mean_tave07_tave08, # MS
                                zone_numeric == 13 ~ tave06, #PP
                                zone_numeric == 5 ~ mean_mdc07_mdc08, #CMA
                                zone_numeric == 16 ~ tmax05, #SWB
                                zone_numeric == 15 ~ mean_tmax07_tmax08, # SBS
                                zone_numeric == 14 ~ mean_tmax05_tmax06_tmax07_tmax08, #SBPS
                                zone_numeric == 11 ~ mean_ppt07_ppt08_ppt09, #MH
                                zone_numeric == 10 ~ tave06, #IMA
                                zone_numeric == 2 ~ mean_mdc07_mdc08_mdc09, #BG
                                TRUE ~ NA_real_))

#Repeat for climate 2
dat_lightning_$climate2<-0

#Perform mutate to get the applicable variable for each row
dat_lightning_<-dat_lightning_ %>%
    mutate(climate2 = case_when(zone_numeric == 6 ~ ppt08, # CWH
                                #zone_numeric == 3 ~ , #BWBS
                                #zone_numeric == 7 ~ , #ESSF
                                zone_numeric == 8 ~ ppt08, # ICH
                                #zone_numeric == 12 ~ , # MS
                                zone_numeric == 13 ~ ppt06, #PP
                                #zone_numeric == 5 ~ , #CMA
                                #zone_numeric == 16 ~ , #SWB
                                #zone_numeric == 15 ~ , # SBS
                                #zone_numeric == 14 ~ , #SBPS
                                #zone_numeric == 11 ~ , #MH
                                zone_numeric == 10 ~ ppt06, #IMA
                                zone_numeric == 2 ~ mean_ppt05_ppt06_ppt07_ppt08, #BG
                                TRUE ~ NA_real_))

head(dat_lightning_)

##Change vegtype to factor
dat_lightning_$vegtype<-as.factor(dat_lightning_$vegtype)

#create new column
dat_lightning_$fire_veg<-paste(dat_lightning_$fire_pres, dat_lightning_$vegtype)

```

Repeat for person-caused fires.


```{r}
#View top variable
climate_variables_person
names(dat_person_)
unique(dat_person_$zone)
dat_person_$zone<-as.factor(dat_person_$zone)
dat_person_$zone_numeric<-as.numeric(dat_person_$zone)
table(dat_person_$zone_numeric)

dat_person_$zone_codes<-paste(dat_person_$zone, dat_person_$zone_numeric)
unique(dat_person_$zone_codes)
#Compare codes to lightning
unique(dat_lightning_$zone_codes) #they are the same

## Create empty vector
dat_person_$climate1<-0
head(dat_person_)

dat_person_<-dat_person_ %>%
    mutate(climate1 = case_when(zone_numeric == 6 ~ tave08, # CWH
                                zone_numeric == 3 ~ tmax08, #BWBS
                                zone_numeric == 7 ~ tave08, #ESSF
                                zone_numeric == 8 ~ mean_tave05_tave06_tave07_tave08_tave09, # ICH
                                zone_numeric == 12 ~ mean_tave05_tave06_tave07_tave08_tave09, # MS
                                zone_numeric == 13 ~ tmax08, #PP
                                zone_numeric == 5 ~ tave09, #CMA
                                #zone_numeric == 16 ~ , #SWB insufficient data at this time
                                zone_numeric == 15 ~ mean_tave05_tave06_tave07_tave08_tave09, # SBS
                                zone_numeric == 14 ~ mean_mdc05_mdc06, #SBPS
                                zone_numeric == 11 ~ tave08, #MH
                                #zone_numeric == 10 ~ , #IMA insufficient data at this time
                                zone_numeric == 2 ~ tmax08, #BG
                                zone_numeric == 4 ~ tave05, #CDF
                                zone_numeric == 9 ~ mean_tave05_tave06_tave07_tave08_tave09, #IDF
                                TRUE ~ NA_real_))

#Repeat for climate 2
dat_person_$climate2<-0

#Perform mutate to get the applicable variable for each row
dat_person_<-dat_person_ %>%
    mutate(climate2 = case_when(zone_numeric == 6 ~ ppt08, # CWH
                                zone_numeric == 3 ~ ppt08, #BWBS
                                zone_numeric == 7 ~ ppt08, #ESSF
                               # zone_numeric == 8 ~ , # ICH
                                #zone_numeric == 12 ~ , # MS
                                zone_numeric == 13 ~ ppt08, #PP
                                zone_numeric == 5 ~ ppt09, #CMA
                                #zone_numeric == 16 ~ , #SWB -- insufficient data at this time
                                #zone_numeric == 15 ~ , # SBS
                                #zone_numeric == 14 ~ , #SBPS
                                zone_numeric == 11 ~ ppt08, #MH
                                #zone_numeric == 10 ~ , #IMA -- insufficient data at this time
                                zone_numeric == 2 ~ ppt08, #BG
                                zone_numeric == 4 ~ ppt05, #CDF
                                #zone_numeric == 9 ~ , #IDF
                                TRUE ~ NA_real_))

head(dat_person_)

##Change vegtype to factor
dat_person_$vegtype<-as.factor(dat_person_$vegtype)

##Create new variable for fire presence by vegtype
dat_person_$fire_veg<-paste(dat_person_$fire_pres, dat_person_$vegtype)
str(dat_person_$fire_veg)
str(dat_person_$fire_pres)

```

Add some transformations to some of the variables.

```{r}
#Before transformations, must convert degrees to radians
dat_lightning_$aspect_radians<-(dat_lightning_$aspect*pi)/180
hist(dat_lightning_$aspect_radians)

dat_lightning_$aspect_cos<-cos(dat_lightning_$aspect_radians) #try cos because I hypothesize that southern aspects would be most likely to have higher likelihood of fire. 180 degrees is -1 with cos, and north is plus 1.

p <- ggplot(dat_lightning_, aes(aspect, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect") + ylab("Pr (ignition)")
p

p <- ggplot(dat_lightning_, aes(aspect_cos, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect_cos") + ylab("Pr (ignition)")
p
##Seems to be minimal relationship with aspect overall

p <- ggplot(dat_lightning_, aes(slope, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("slope") + ylab("Pr (ignition)")
p
#positive association

ggplot(dat_lightning_, aes(x = slope)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(fire_pres ~ .)
##Seeing distribution of ignitions by slope makes me believe that slope is not a big factor for ignitions despite seemingly positive trend prior.


#
p <- ggplot(dat_lightning_, aes(aspect_cos*slope, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect_cos*slope") + ylab("Pr (ignition)")
p


p <- ggplot(dat_lightning_, aes(elevation, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("elevation") + ylab("Pr (ignition)")
p



##########Repeat for person-caused fires
dat_person_$aspect_radians<-(dat_person_$aspect*pi)/180
hist(dat_person_$aspect_radians)

dat_person_$aspect_cos<-cos(dat_person_$aspect_radians) 

p <- ggplot(dat_person_, aes(aspect, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect") + ylab("Pr (ignition)")
p

p <- ggplot(dat_person_, aes(aspect_cos, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect_cos") + ylab("Pr (ignition)")
p

##Seems to be minimal relationship with aspect overall

p <- ggplot(dat_person_, aes(slope, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("slope") + ylab("Pr (ignition)")
p
#strong negative correlation

ggplot(dat_person_, aes(x = slope)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(fire_pres ~ .)


p <- ggplot(dat_person_, aes(elevation, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("elevation") + ylab("Pr (ignition)")
p


##cos makes more sense for aspect, so make this the default in analyses
dat_person_$aspect_degrees<-dat_person_$aspect
dat_person_$aspect<-dat_person_$aspect_cos

dat_lightning_$aspect_degrees<-dat_lightning_$aspect
dat_lightning_$aspect<-dat_lightning_$aspect_cos

```


## Examining correlation between stand level variables
```{r}
# Examining the relationship between some stand level variables. Volume and height are fairly correlated (0.67) but age and volume are not (0.28) and neither are age and height (0.44). Because volume and height are very close to 0.7 in correlation I will leave out this combination of variables from my treed models. 
table(dat_lightning_$bclcs_level_2) ##What is L? It is Land, exclude and do not use.
dat_lightning_$fire_pres<-as.numeric(dat_lightning_$fire)

dat_lightning_t<- dat_lightning_ %>% dplyr::filter(bclcs_level_2=="T")
dat_lightning_nt<- dat_lightning_ %>% dplyr::filter(bclcs_level_2=="N")
dat_lightning_l<- dat_lightning_ %>% dplyr::filter(bclcs_level_2=="L")

table(dat_lightning_$vegtype)
table(dat_lightning_t$vegtype) #either disturbed, open, treed broadleaf, treed conifer, or treed mixed broadleaf and conifer
table(dat_lightning_nt$vegtype) #either disturbed, open or shrub

ggscatter(dat_lightning_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(dat_lightning_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(dat_lightning_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")


##Note that some no tree areas also have tree attributes. This is likely because the majority of the polygon has no trees, but part of the polygon might have trees which are given attributes.
hist(dat_lightning_nt$proj_height_1)
hist(dat_lightning_nt$proj_age_1)
hist(dat_lightning_nt$live_stand_volume_125) #Pretty much all NAs. Can likely assume 0.
dat_lightning_nt$proj_height_1 #Also many NAs. 
dat_lightning_nt$proj_age_1 # Also many NAs. 

hist(dat_lightning_l$proj_height_1)
hist(dat_lightning_l$proj_age_1)
hist(dat_lightning_l$live_stand_volume_125)
## This is ok. Still exclude from models, because majority of polygon will not be treed

head(dat_lightning_t)

```


#Repeat for person caused fires


## Examining correlation between stand level variables
```{r}
# Examining the relationship between some stand level variables. Volume and height are fairly correlated (0.67) but age and volume are not (0.28) and neither are age and height (0.44). Because volume and height are very close to 0.7 in correlation I will leave out this combination of variables from my treed models. 
table(dat_person_$bclcs_level_2) ##What is L? It is Land, exclude and do not use.
dat_person_$fire_pres<-as.numeric(dat_person_$fire)

dat_person_t<- dat_person_ %>% dplyr::filter(bclcs_level_2=="T")
dat_person_nt<- dat_person_ %>% dplyr::filter(bclcs_level_2=="N")
dat_person_l<- dat_person_ %>% dplyr::filter(bclcs_level_2=="L")

table(dat_person_$vegtype)
table(dat_person_t$vegtype) #either disturbed, open, treed broadleaf, treed conifer, or treed mixed broadleaf and conifer
table(dat_person_nt$vegtype) #either disturbed, open or shrub

ggscatter(dat_person_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(dat_person_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(dat_person_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")


##Note that some no tree areas also have tree attributes. This is likely because the majority of the polygon has no trees, but part of the polygon might have trees which are given attributes.
hist(dat_person_nt$proj_height_1)
hist(dat_person_nt$proj_age_1)
hist(dat_person_nt$live_stand_volume_125) #Pretty much all NAs. Can likely assume 0.
dat_person_nt$proj_height_1 #Also many NAs. 
dat_person_nt$proj_age_1 # Also many NAs. 

hist(dat_person_l$proj_height_1)
hist(dat_person_l$proj_age_1)
hist(dat_person_l$live_stand_volume_125)
## This is ok. Still exclude from models, because majority of polygon will not be treed

```


Save the prepped data

```{r}

write.csv(dat_lightning_t, file="D:\\Fire\\fire_data\\raw_data\\ClimateBC_Data\\data_lightning_trees.csv")

write.csv(dat_lightning_nt, file="D:\\Fire\\fire_data\\raw_data\\ClimateBC_Data\\data_lightning_notrees.csv")

write.csv(dat_person_t, file="D:\\Fire\\fire_data\\raw_data\\ClimateBC_Data\\data_person_trees.csv")

write.csv(dat_person_nt, file="D:\\Fire\\fire_data\\raw_data\\ClimateBC_Data\\data_person_notrees.csv")

```



#################### ANALYSES #########################

Now, we will make a loop that does something very similar to our last loop, but with the selected climate variable plus other variables of interest. For lightning caused fires, the variables of interest include:

1. Climate variable(s)
2. Projected Height (proj_height_1)
3. projected age (proj_age_1)  
4. live_stand_volume_125
5. vegtype
6. slope
7. aspect (cos)
8. elevation

Interactions of interest: two-way interactions between climate (1) and vegtype (5); two-way interactions between topography measures (6-8).

This will be done separately for trees and non-treed areas. 

First, let's do this for treed areas (with the lightning-caused fires dataset).

##We will do each loop separately for each BEC zone given the large number of possible models for just one zone (>2 million).

```{r}

##Create variable lists to be used in the model loop.
variables_all<-c(climate1 = "climate1", proj_height_1 = "proj_height_1", proj_age_1 = "proj_age_1", live_stand_volume_125 = "live_stand_volume_125", slope = "slope", aspect = "aspect", elevation ="elevation", vegtype = "vegtype") 

variables_all<-c(climate1 = "climate1", proj_height_1 = "proj_height_1", proj_age_1 = "proj_age_1", live_stand_volume_125 = "live_stand_volume_125", slope = "slope", aspect = "aspect", vegtype = "vegtype") 


vars.clim<-c("climate1")
vars.clim.vegtype<-c("climate1", "vegtype")
vars.oth<-c("proj_height_1", "proj_age_1", "live_stand_volume_125") 
#vars.topo<-c("slope", "aspect") #"elevation")
vars.topo<-c("slope", "aspect", "elevation")


#Also for later with 2 climate variables
vars.clim.vegtype2<-c("climate1", "climate2","vegtype")

##Create interaction for climate and vegtype
inputs.me <- c(vars.clim.vegtype)

#get the names of all possible two-way interactions for climate and the first set of variables
twoway.ints <- NULL
for (i in 1:(length(inputs.me)-1)) {
  for (j in (i+1):length(inputs.me)) {
     twoway.ints <- cbind(twoway.ints, paste(inputs.me[i], inputs.me[j], sep=":"))
  }
}
twoway.ints
length(twoway.ints)

#
#Create function to determine Powerset for any vector of variable names
## or use rje package
#powerSet <- function(x) {
#   z.list <- NULL
#   for(i in 1:length(x)) {
#      z.list <- append(z.list, combn(x, m=i, simplify=F))
#   }    
#   return(z.list)
#}


#Get variables on own
#complete list of models using non-climate vars
mods.me.tmp <- powerSet(vars.clim.vegtype) 
#add climate vars to all of the above
mods.me.climate <- list()
for (i in 1: length(mods.me.tmp)) {
   mods.me.climate[[i]] <- c(mods.me.tmp[[i]])
}

mods.me.climate


#########Now for topography data, get all possible two-way interactions

#get the names of all possible two-way interactions
twoway.ints2 <- NULL
for (i in 1:(length(vars.topo)-1)) {
  for (j in (i+1):length(vars.topo)) {
     twoway.ints2 <- cbind(twoway.ints2, paste(vars.topo[i], vars.topo[j], sep=":"))
  }
}
twoway.ints2
length(twoway.ints2)

#complete list of models using non-climate vars (topo)
mods.me.tmp <- powerSet(vars.topo) 
#add climate vars to all of the above
mods.me2 <- list()
for (i in 1: length(mods.me.tmp)) {
   mods.me2[[i]] <- c(mods.me.tmp[[i]])
}

mods.me2

#complete list of two-way interactions
mods.twoway2 <- powerSet(twoway.ints2)
length(mods.twoway2) #7
mods.twoway2

#Finding models in mods.me that accommodate/allow interaction terms in each mods.twoway to be added
#should really use lapply instead of loop but being lazy
mods.inter2 <- list()
counter <- 0
for (i in 1: length(mods.twoway2)) {
   s1 <- unique(unlist( strsplit(mods.twoway2[[i]], split=':', fixed=TRUE) ) )
   for (j in 1: length(mods.me2)) {
      if (all(s1 %in% mods.me2[[j]])==TRUE) {
        counter <- counter + 1
        both <-  c(mods.me2[[j]], mods.twoway2[[i]])
        mods.inter2[[counter]] <- both
      }
   }
}

length(mods.inter2)

##For other VRI data, get without interactions

#complete list of models using VRI - no interactions
mods.me.tmp <- powerSet(vars.oth) 
#add climate vars to all of the above
mods.me.oth <- list()
for (i in 1: length(mods.me.tmp)) {
   mods.me.oth[[i]] <- c(mods.me.tmp[[i]])
}

mods.me.oth

#the list of all possible model RHSs. 
#all.poss.mods <- c(1, vars.clim, twoway.ints, mods.me.oth, mods.me2, mods.inter2)
#all.poss.mods

all.poss.mods.clim.vegtype<-c(1, mods.me.climate, twoway.ints)
all.poss.mods.clim.vegtype #Why character(0)? Check and fix In mods.me.climate model.
all.poss.mods.clim.vegtype<-all.poss.mods.clim.vegtype[-2]
all.poss.mods.VRI<-c(1, mods.me.oth)
all.poss.mods.VRI
all.poss.mods.topo<-c(1, mods.me2, mods.inter2)
all.poss.mods.topo


#####Prepare variables for BEC zones with 2 climate variables
##Create interaction for climate and vegtype
inputs.me2 <- c(vars.clim.vegtype2)

#get the names of all possible two-way interactions for climate and the first set of variables
twoway.ints.c2 <- NULL
for (i in 1:(length(inputs.me2)-1)) {
  for (j in (i+1):length(inputs.me2)) {
     twoway.ints.c2 <- cbind(twoway.ints.c2, paste(inputs.me2[i], inputs.me2[j], sep=":"))
  }
}
twoway.ints.c2

#Get variables on own
#complete list of models using non-climate vars
mods.me.tmp <- powerSet(vars.clim.vegtype2) 
#add climate vars to all of the above
mods.me.climate.c2 <- list()
for (i in 1: length(mods.me.tmp)) {
   mods.me.climate.c2[[i]] <- c(mods.me.tmp[[i]])
}

mods.me.climate.c2


#complete list of two-way interactions
mods.twoway.c2 <- powerSet(twoway.ints.c2)
length(mods.twoway.c2) #7
mods.twoway.c2

#Finding models in mods.me that accommodate/allow interaction terms in each mods.twoway to be added
#should really use lapply instead of loop but being lazy
mods.inter.c2 <- list()
counter <- 0
for (i in 1: length(mods.twoway.c2)) {
   s1 <- unique(unlist( strsplit(mods.twoway.c2[[i]], split=':', fixed=TRUE) ) )
   for (j in 1: length(mods.me.climate.c2)) {
      if (all(s1 %in% mods.me.climate.c2[[j]])==TRUE) {
        counter <- counter + 1
        both <-  c(mods.me.climate.c2[[j]], mods.twoway.c2[[i]])
        mods.inter.c2[[counter]] <- both
      }
   }
}

mods.inter.c2


all.poss.mods.clim.vegtype.c2<-c(1, mods.me.climate.c2, mods.inter.c2)
all.poss.mods.clim.vegtype.c2

```


Let's work with one BEC zone at a time. Let's first do all of the BEC zones with one climate variable, and then later, the BEC zones with 2 (this will require a few extra models with interactions).

zones1<-c("ESSF", "MH", "MS", "SBPS", "BWBS", "SBS", "SWB", "CMA") #these are the models with one climate variable
#Note: CMA must be assessed without vegtype because no vegtype variation

cma_t<-subset(dat_lightning_t, dat_lightning_t$zone=="CMA")
table(cma_t$vegtype)

#  D  OP   S  TB  TC  TM 
 # 0   0   0   1 135   0 

zones2<-c("ICH", "CWH",   "PP",  "IMA",  "BG") #These are the models with two climate variables from previous climate selection models.

Other zones had insufficient information to determine top climate variables. These other zones will need to be assessed at a later time. Investigate with below.


```{r}
unique(dat_lightning_t$zone)
# Zones without climate variables as of July 2021:  BAFA, CDF,IDF
```

Because of the large number of models, we will test the climate and vegtype first, then the VRI variables, then the topography variables. Then we will test the top models together, with determining best AIC model from there. Or perhaps we will just combine the top models for each together, and eliminate models if the intercept was the best predictor.


Select first zones: SBS

```{r}
zones1<-c("SBS") #Do one zone at a time

########### 1. Climate and vegtype ############
for (g in 1:100){

for (h in 1:length(zones1)) {
  dat2<- dat_lightning_t %>% dplyr::filter(zone ==zones1[h])

for (i in 1: length(all.poss.mods.clim.vegtype)){
  print(paste((all.poss.mods.clim.vegtype[i]), (zones1[h]), sep=" "))
  
 # model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, variables_all[i])
  model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, !!variables_all)
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(model_dat$fire_veg, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- model_dat[ trainIndex,]
   Valid <- model_dat[-trainIndex,]

big.mod <- function(mods.in, df.train, df.test, dep.var="fire_pres") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(all.poss.mods.clim.vegtype, big.mod, df.train=dat1, df.test=Valid)

}
}
}


```

Now extract elements from the output for climate and vegetation type.

```{r}
#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.climate <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.climate$BEC<-c("SBS")
tab.sum.climate$delta.aic<- tab.sum.climate$aic - (min(tab.sum.climate$aic))
tab.sum.climate 

```


#Now repeat for VRI data


```{r}

########### 2. VRI ############
for (g in 1:100){

for (h in 1:length(zones1)) {
  dat2<- dat_lightning_t %>% dplyr::filter(zone ==zones1[h])

for (i in 1: length(all.poss.mods.VRI)){
  print(paste((all.poss.mods.VRI[i]), (zones1[h]), sep=" "))
  
 # model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, variables_all[i])
  model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, !!variables_all)
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(model_dat$fire_veg, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- model_dat[ trainIndex,]
   Valid <- model_dat[-trainIndex,]

big.mod <- function(mods.in, df.train, df.test, dep.var="fire_pres") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(all.poss.mods.VRI, big.mod, df.train=dat1, df.test=Valid)

}
}
}


```

Now extract elements from the output for climate and vegetation type.

```{r}
#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.VRI <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.VRI$BEC<-c("SBS")
tab.sum.VRI$delta.aic<- tab.sum.VRI$aic - (min(tab.sum.VRI$aic))
tab.sum.VRI 

```


#Now repeat for topography

```{r}

########### 3. Topography ############
for (g in 1:100){

for (h in 1:length(zones1)) {
  dat2<- dat_lightning_t %>% dplyr::filter(zone ==zones1[h])

for (i in 1: length(all.poss.mods.topo)){
  print(paste((all.poss.mods.topo[i]), (zones1[h]), sep=" "))
  
 # model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, variables_all[i])
  model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, !!variables_all)
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(model_dat$fire_veg, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- model_dat[ trainIndex,]
   Valid <- model_dat[-trainIndex,]

big.mod <- function(mods.in, df.train, df.test, dep.var="fire_pres") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(all.poss.mods.topo, big.mod, df.train=dat1, df.test=Valid)

}
}
}


```

Now extract elements from the output for climate and vegetation type.

```{r}
#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.topo <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.topo$BEC<-c("SBS")
tab.sum.topo$delta.aic<- tab.sum.topo$aic - (min(tab.sum.topo$aic))
tab.sum.topo

```

#Now combine the datatables and save to computer

```{r}
SBS_l_models<-rbind(tab.sum.climate, tab.sum.VRI, tab.sum.topo)
SBS_l_models

write.csv(SBS_l_models, file="D:\\Fire\\fire_data\\raw_data\\SBS_lightning_models.csv")
```

Now choose the top variables and create final model. The below code will need to be updated manually, depending on what the results of the above analyses are.

######## UPDATE BELOW #########

```{r}
##### TOP MODEL####
sbs_t<-dat_lightning_t %>%
  filter(zone=="SBS")

sbs_t2<-sbs_t %>% drop_na(live_stand_volume_125, vegtype, climate1)

glm_best<- glm(fire_pres ~ scale(climate1) +
             scale(live_stand_volume_125) +
               vegtype, 
           data= sbs_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


sbs_t2$resids<-resid(glm_best)

binnedplot (sbs_t2$live_stand_volume_125, 
            sbs_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (sbs_t2$climate1, 
            sbs_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

# Diagnostic plots look good

# Looking at effect of forest height at the average amount of rainfall in September
plot(sbs_t2$live_stand_volume_125,sbs_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*mean(sbs_t2$climate1) + coef(glm_best)[3]*x), add=TRUE)

# looking at effect of climate1 at the average forest height.
plot(sbs_t2$climate1,sbs_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*x + coef(glm_best)[3]*mean(sbs_t2$live_stand_volume_125)), add=TRUE)


# create model table (only do this once) and add the relevant data
top_mod_table <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table) <- c ("ZONE", "TREED", "Model_terms", "intercept", "coef_climate_1", "coef_climate_2", "coef_climate_interaction", "coef_stand_height", "coef_live_stand_volume_125", "coef_proj_age", "coef_vegtypeD", "coef_vegtypeOP", "coef_vegtypeS", "coef_vegtypeTB", "coef_vegtypeTC", "coef_vegtypeTM")

##Add data for BG
top_mod_table[1,1]<-"SBS"
top_mod_table[1,2]<-"Y"
top_mod_table[1,3]<-"fire_pres ~ ppt09 + proj_height_1" ######### UPDATE
top_mod_table[1,4]<- coef(glm_best)[1] #Intercept
top_mod_table[1,5]<- coef(glm_best)[2] #Climate variable 1
#top_mod_table[1,6]<- coef(glm_best)[2] #Climate variable 2
#top_mod_table[1,7]<- coef(glm_best)[3] #Interaction climate variables
#top_mod_table[1,8]<- coef(glm_best)[3] #coef_stand_height
#top_mod_table[1,9]<- coef(glm_best)[3] #live_stand_volume_125
#top_mod_table[1,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[1,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[1,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[1,13]<- coef(glm_best)[4] #coefficient vegtypeS
#top_mod_table[1,14]<- coef(glm_best)[4] #coefficient vegtypeTB
#top_mod_table[1,15]<- coef(glm_best)[4] #coefficient vegtypeTC
#top_mod_table[1,16]<- coef(glm_best)[5] #coefficient vegtypeTM
top_mod_table ##Determine if better way to represent categories for vegtype, and if each climate variable should have its own column

########################## SBS Model Selection Complete ###################

```
 


############### Now choose the next BEC zone and repeat ########
Note: currently doing  those with one climate variable)
Models complete above: SBS
Models to still do henceforth:"ESSF", "MH", "MS", "SBPS", "BWBS", "SWB", "CMA"


Select next zone: ESSF

```{r}
zones1<-c("ESSF") #Do one zones at a time

########### 1. Climate and vegtype ############
for (g in 1:100){

for (h in 1:length(zones1)) {
  dat2<- dat_lightning_t %>% dplyr::filter(zone ==zones1[h])

for (i in 1: length(all.poss.mods.clim.vegtype)){
  print(paste((all.poss.mods.clim.vegtype[i]), (zones1[h]), sep=" "))
  
 # model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, variables_all[i])
  model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, !!variables_all)
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(model_dat$fire_veg, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- model_dat[ trainIndex,]
   Valid <- model_dat[-trainIndex,]

big.mod <- function(mods.in, df.train, df.test, dep.var="fire_pres") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(all.poss.mods.clim.vegtype, big.mod, df.train=dat1, df.test=Valid)

}
}
}


```

Now extract elements from the output for climate and vegetation type.

```{r}
#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.climate <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.climate$BEC<-c("ESSF")
tab.sum.climate$delta.aic<- tab.sum.climate$aic - (min(tab.sum.climate$aic))
tab.sum.climate 

```


#Now repeat for VRI data


```{r}

########### 2. VRI ############
for (g in 1:100){

for (h in 1:length(zones1)) {
  dat2<- dat_lightning_t %>% dplyr::filter(zone ==zones1[h])

for (i in 1: length(all.poss.mods.VRI)){
  print(paste((all.poss.mods.VRI[i]), (zones1[h]), sep=" "))
  
 # model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, variables_all[i])
  model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, !!variables_all)
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(model_dat$fire_veg, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- model_dat[ trainIndex,]
   Valid <- model_dat[-trainIndex,]

big.mod <- function(mods.in, df.train, df.test, dep.var="fire_pres") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(all.poss.mods.VRI, big.mod, df.train=dat1, df.test=Valid)

}
}
}


```

Now extract elements from the output for climate and vegetation type.

```{r}
#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.VRI <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.VRI$BEC<-c("ESSF")
tab.sum.VRI$delta.aic<- tab.sum.VRI$aic - (min(tab.sum.VRI$aic))
tab.sum.VRI 

```


#Now repeat for topography

```{r}

########### 3. Topography ############
for (g in 1:100){

for (h in 1:length(zones1)) {
  dat2<- dat_lightning_t %>% dplyr::filter(zone ==zones1[h])

for (i in 1: length(all.poss.mods.topo)){
  print(paste((all.poss.mods.topo[i]), (zones1[h]), sep=" "))
  
 # model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, variables_all[i])
  model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, !!variables_all)
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(model_dat$fire_veg, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- model_dat[ trainIndex,]
   Valid <- model_dat[-trainIndex,]

big.mod <- function(mods.in, df.train, df.test, dep.var="fire_pres") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(all.poss.mods.topo, big.mod, df.train=dat1, df.test=Valid)

}
}
}


```

Now extract elements from the output for climate and vegetation type.

```{r}
#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.topo <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.topo$BEC<-c("ESSF")
tab.sum.topo$delta.aic<- tab.sum.topo$aic - (min(tab.sum.topo$aic))
tab.sum.topo

```

#Now combine the datatables and save to computer

```{r}
ESSF_l_models<-rbind(tab.sum.climate, tab.sum.VRI, tab.sum.topo)
ESSF_l_models

write.csv(ESSF_l_models, file="D:\\Fire\\fire_data\\raw_data\\ESSF_lightning_models.csv")
```

Now choose the top variables and create final model. The below code will need to be updated manually, depending on what the results of the above analyses are.

######## UPDATE BELOW #########

```{r}
##### TOP MODEL####
ESSF_t<-dat_lightning_t %>%
  filter(zone=="ESSF")

ESSF_t2<-ESSF_t %>% drop_na(live_stand_volume_125, vegtype, climate1)

glm_best<- glm(fire_pres ~ scale(climate1) +
             scale(live_stand_volume_125) +
               vegtype, 
           data= ESSF_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


ESSF_t2$resids<-resid(glm_best)

binnedplot (ESSF_t2$live_stand_volume_125, 
            ESSF_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (ESSF_t2$climate1, 
            ESSF_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

# Diagnostic plots look good

# Looking at effect of forest height at the average amount of rainfall in September
plot(ESSF_t2$live_stand_volume_125,ESSF_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*mean(ESSF_t2$climate1) + coef(glm_best)[3]*x), add=TRUE)

# looking at effect of climate1 at the average forest height.
plot(ESSF_t2$climate1,ESSF_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*x + coef(glm_best)[3]*mean(ESSF_t2$live_stand_volume_125)), add=TRUE)


# create model table (only do this once) and add the relevant data
top_mod_table <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table) <- c ("ZONE", "TREED", "Model_terms", "intercept", "coef_climate_1", "coef_climate_2", "coef_climate_interaction", "coef_stand_height", "coef_live_stand_volume_125", "coef_proj_age", "coef_vegtypeD", "coef_vegtypeOP", "coef_vegtypeS", "coef_vegtypeTB", "coef_vegtypeTC", "coef_vegtypeTM")

##Add data for BG
top_mod_table[1,1]<-"ESSF"
top_mod_table[1,2]<-"Y"
top_mod_table[1,3]<-"fire_pres ~ ppt09 + proj_height_1" ######### UPDATE
top_mod_table[1,4]<- coef(glm_best)[1] #Intercept
top_mod_table[1,5]<- coef(glm_best)[2] #Climate variable 1
#top_mod_table[1,6]<- coef(glm_best)[2] #Climate variable 2
#top_mod_table[1,7]<- coef(glm_best)[3] #Interaction climate variables
#top_mod_table[1,8]<- coef(glm_best)[3] #coef_stand_height
#top_mod_table[1,9]<- coef(glm_best)[3] #live_stand_volume_125
#top_mod_table[1,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[1,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[1,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[1,13]<- coef(glm_best)[4] #coefficient vegtypeS
#top_mod_table[1,14]<- coef(glm_best)[4] #coefficient vegtypeTB
#top_mod_table[1,15]<- coef(glm_best)[4] #coefficient vegtypeTC
#top_mod_table[1,16]<- coef(glm_best)[5] #coefficient vegtypeTM
top_mod_table ##Determine if better way to represent categories for vegtype, and if each climate variable should have its own column

########################## ESSF Model Selection Complete ###################

```
 


############### Now choose the next BEC zone and repeat ########
Note: currently doing  those with one climate variable
Models complete above: SBS, ESSF
Models to still do henceforth:"MH", "MS", "SBPS", "BWBS", "SWB", "CMA"


Select next zone: SBPS

```{r}
zones1<-c("SBPS") #Do one zones at a time

########### 1. Climate and vegtype ############
for (g in 1:100){

for (h in 1:length(zones1)) {
  dat2<- dat_lightning_t %>% dplyr::filter(zone ==zones1[h])

for (i in 1: length(all.poss.mods.clim.vegtype)){
  print(paste((all.poss.mods.clim.vegtype[i]), (zones1[h]), sep=" "))
  
 # model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, variables_all[i])
  model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, !!variables_all)
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(model_dat$fire_veg, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- model_dat[ trainIndex,]
   Valid <- model_dat[-trainIndex,]

big.mod <- function(mods.in, df.train, df.test, dep.var="fire_pres") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(all.poss.mods.clim.vegtype, big.mod, df.train=dat1, df.test=Valid)

}
}
}


```

Now extract elements from the output for climate and vegetation type.

```{r}
#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.climate <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.climate$BEC<-c("SBPS")
tab.sum.climate$delta.aic<- tab.sum.climate$aic - (min(tab.sum.climate$aic))
tab.sum.climate 

```


#Now repeat for VRI data


```{r}

########### 2. VRI ############
for (g in 1:100){

for (h in 1:length(zones1)) {
  dat2<- dat_lightning_t %>% dplyr::filter(zone ==zones1[h])

for (i in 1: length(all.poss.mods.VRI)){
  print(paste((all.poss.mods.VRI[i]), (zones1[h]), sep=" "))
  
 # model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, variables_all[i])
  model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, !!variables_all)
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(model_dat$fire_veg, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- model_dat[ trainIndex,]
   Valid <- model_dat[-trainIndex,]

big.mod <- function(mods.in, df.train, df.test, dep.var="fire_pres") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(all.poss.mods.VRI, big.mod, df.train=dat1, df.test=Valid)

}
}
}


```

Now extract elements from the output for climate and vegetation type.

```{r}
#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.VRI <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.VRI$BEC<-c("SBPS")
tab.sum.VRI$delta.aic<- tab.sum.VRI$aic - (min(tab.sum.VRI$aic))
tab.sum.VRI 

```


#Now repeat for topography

```{r}

########### 3. Topography ############
for (g in 1:100){

for (h in 1:length(zones1)) {
  dat2<- dat_lightning_t %>% dplyr::filter(zone ==zones1[h])

for (i in 1: length(all.poss.mods.topo)){
  print(paste((all.poss.mods.topo[i]), (zones1[h]), sep=" "))
  
 # model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, variables_all[i])
  model_dat<- dat2 %>% dplyr::select(fire_pres, fire_veg, !!variables_all)
  # Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(model_dat$fire_veg, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- model_dat[ trainIndex,]
   Valid <- model_dat[-trainIndex,]

big.mod <- function(mods.in, df.train, df.test, dep.var="fire_pres") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(all.poss.mods.topo, big.mod, df.train=dat1, df.test=Valid)

}
}
}


```

Now extract elements from the output for climate and vegetation type.

```{r}
#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.topo <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.topo$BEC<-c("SBPS")
tab.sum.topo$delta.aic<- tab.sum.topo$aic - (min(tab.sum.topo$aic))
tab.sum.topo

```

#Now combine the datatables and save to computer

```{r}
SBPS_l_models<-rbind(tab.sum.climate, tab.sum.VRI, tab.sum.topo)
SBPS_l_models

write.csv(SBPS_l_models, file="D:\\Fire\\fire_data\\raw_data\\SBPS_lightning_models.csv")
```

Now choose the top variables and create final model. The below code will need to be updated manually, depending on what the results of the above analyses are.

######## UPDATE BELOW #########

```{r}
##### TOP MODEL####
SBPS_t<-dat_lightning_t %>%
  filter(zone=="SBPS")

SBPS_t2<-SBPS_t %>% drop_na(live_stand_volume_125, vegtype, climate1)

glm_best<- glm(fire_pres ~ scale(climate1) +
             scale(live_stand_volume_125) +
               vegtype, 
           data= SBPS_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


SBPS_t2$resids<-resid(glm_best)

binnedplot (SBPS_t2$live_stand_volume_125, 
            SBPS_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (SBPS_t2$climate1, 
            SBPS_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

# Diagnostic plots look good

# Looking at effect of forest height at the average amount of rainfall in September
plot(SBPS_t2$live_stand_volume_125,SBPS_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*mean(SBPS_t2$climate1) + coef(glm_best)[3]*x), add=TRUE)

# looking at effect of climate1 at the average forest height.
plot(SBPS_t2$climate1,SBPS_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*x + coef(glm_best)[3]*mean(SBPS_t2$live_stand_volume_125)), add=TRUE)


# create model table (only do this once) and add the relevant data
top_mod_table <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table) <- c ("ZONE", "TREED", "Model_terms", "intercept", "coef_climate_1", "coef_climate_2", "coef_climate_interaction", "coef_stand_height", "coef_live_stand_volume_125", "coef_proj_age", "coef_vegtypeD", "coef_vegtypeOP", "coef_vegtypeS", "coef_vegtypeTB", "coef_vegtypeTC", "coef_vegtypeTM")

##Add data for BG
top_mod_table[1,1]<-"SBPS"
top_mod_table[1,2]<-"Y"
top_mod_table[1,3]<-"fire_pres ~ ppt09 + proj_height_1" ######### UPDATE
top_mod_table[1,4]<- coef(glm_best)[1] #Intercept
top_mod_table[1,5]<- coef(glm_best)[2] #Climate variable 1
#top_mod_table[1,6]<- coef(glm_best)[2] #Climate variable 2
#top_mod_table[1,7]<- coef(glm_best)[3] #Interaction climate variables
#top_mod_table[1,8]<- coef(glm_best)[3] #coef_stand_height
#top_mod_table[1,9]<- coef(glm_best)[3] #live_stand_volume_125
#top_mod_table[1,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[1,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[1,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[1,13]<- coef(glm_best)[4] #coefficient vegtypeS
#top_mod_table[1,14]<- coef(glm_best)[4] #coefficient vegtypeTB
#top_mod_table[1,15]<- coef(glm_best)[4] #coefficient vegtypeTC
#top_mod_table[1,16]<- coef(glm_best)[5] #coefficient vegtypeTM
top_mod_table ##Determine if better way to represent categories for vegtype, and if each climate variable should have its own column

########################## SBPS Model Selection Complete ###################

```
 



```{r}

```




Now repeat for the entire model selection process for each BEC zone for person-caused fires. For person caused fires, the variables of interest include:

1. Climate variable(s)
2. vegtype
3. slope
4. aspect
5. road density (roads_km)





















## BEC ZONE BG

####Come back to this BEC Zone. Inconsistent results with each iteration of new random points with no fire
```{r bg figures}
bg<- dat_lightning_ %>% dplyr::filter(zone =="BG")
# I will run separate analyses for treed and non-treed areas because the non-treed areas don't have information for forest height, age or volume and so these variables cant be included in the model.
bg_t<- bg %>% dplyr::filter(bclcs_level_2=="T") # treed areas
bg_nt<- bg %>% dplyr::filter(bclcs_level_2!="T") # not treed

# examining  relationship between top climatic variable and ignition for bg  
p <- ggplot(bg, aes(mdc_atfire, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mdc_atfire") + ylab("Pr (ignition)")
p
##We see that the 0s are too clustered because they take the mean for where fires did not occur. Let's use MDC for when fires occurred for the escape and spread analyses, but not the ignition analyses

p <- ggplot(bg, aes(mean_tmax07_tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt09") + ylab("Pr (ignition)")
p

p1 <- ggplot(bg_t, aes(mean_tmax07_tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt09") + ylab("Pr (ignition)")
p1

p2 <- ggplot(bg_nt, aes(mean_tmax07_tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt09") + ylab("Pr (ignition)")
p2

hist(bg_t$ppt09)
hist(scale(bg_t$ppt09))
hist(bg_nt$ppt09)
hist(scale(bg_nt$ppt09))

hist(bg_t$live_stand_volume_125)
hist(scale(bg_t$live_stand_volume_125))
hist(log(bg_t$live_stand_volume_125+1))
hist(bg_nt$live_stand_volume_125)
hist(scale(bg_nt$live_stand_volume_125))
hist(log(bg_nt$live_stand_volume_125+1))

hist(bg_t$proj_height_1)
hist(scale(bg_t$proj_height_1))
hist(scale(bg_nt$proj_height_1))
hist(bg_nt$proj_height_1)

hist(bg_t$proj_age_1)
hist(scale(bg_t$proj_age_1))
hist(bg_nt$proj_age_1)
hist(scale(bg_nt$proj_age_1))

##Scale variables of interest for applicability downstream (https://besjournals.onlinelibrary.wiley.com/doi/epdf/10.1111/j.2041-210X.2010.00012.x)

##If we choose to scale variables, we could also try to back transform the coefficient -- because B1*X = B1*(mean-value)/SD to make downstream use easier

```

## BG treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

##For this zone, vegtype and bclcs_type_4 are identical

glm1<- glm(fire_pres ~ scale(ppt09), 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"ppt09"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(ppt09) +
             scale(proj_age_1), 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"ppt09 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(ppt09) +
             scale(proj_height_1), 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(ppt09) +
             scale(live_stand_volume_125), 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ scale(ppt09) +
             vegtype, # classification of tree type in the VRI 
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(ppt09) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ scale(ppt09) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ scale(ppt09) +
             scale(proj_age_1) + 
             vegtype,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ scale(ppt09) +
             scale(proj_height_1) + 
             vegtype,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ scale(ppt09) +
             scale(live_stand_volume_125) + 
             vegtype,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ scale(ppt09) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ scale(ppt09) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)


glm13<- glm(fire_pres ~ scale(ppt09) +
             scale(live_stand_volume_125)* 
             vegtype,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm13)
i=13
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125*vegtype"
table.glm[i,3]<-AICc(glm13)


glm14<- glm(fire_pres ~ scale(ppt09) +
             scale(live_stand_volume_125)*vegtype + 
              scale(proj_age_1),
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm14)
i=14
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + live_stand_volume_125*vegtype + proj_age_1"
table.glm[i,3]<-AICc(glm14)

glm15<- glm(fire_pres ~ scale(ppt09) +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm15)
i=15
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm15)

glm16<- glm(fire_pres ~ scale(ppt09) +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype,
           data= bg_t,
           family = binomial,
           na.action=na.omit)
summary(glm16)
i=16
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"ppt09 + proj_height_1 + proj_age_1 + live_stand_volume_125*vegtype"
table.glm[i,3]<-AICc(glm16)

##Create summary table
table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.bg<- table.glm
table.glm.bg[order(table.glm.bg$deltaAIC),] 


#TOP MODEL = glm3    ppt09 + proj_height_1 


####################################################

```

Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

bg_t2<-bg_t %>% drop_na(proj_height_1)

glm_best<- glm(fire_pres ~ scale(ppt09) +
             scale(proj_height_1), 
           data= bg_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


bg_t2$resids<-resid(glm_best)

binnedplot (bg_t2$proj_height_1, 
            bg_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (bg_t2$ppt09, 
            bg_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

# Diagnostic plots look ok, but my sample sizes in this BEC zone are low!

# Looking at effect of forest height at the average amount of rainfall in September
plot(bg_t2$proj_height_1,bg_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*mean(bg_t2$ppt09) + coef(glm_best)[3]*x), add=TRUE)

# looking at effect of ppt09 at the average forest height.
plot(bg_t2$ppt09,bg_t2$fire_pres)
curve(invlogit(coef(glm_best)[1] +coef(glm_best)[2]*x + coef(glm_best)[3]*mean(bg_t2$proj_height_1)), add=TRUE)


# create model table (only do this once) and add the relevant data
top_mod_table <- data.frame (matrix (ncol = 16, nrow = 0))
colnames (top_mod_table) <- c ("ZONE", "TREED", "Model_terms", "intercept", "coef_climate_1", "coef_climate_2", "coef_climate_interaction", "coef_stand_height", "coef_live_stand_volume_125", "coef_proj_age", "coef_vegtypeD", "coef_vegtypeOP", "coef_vegtypeS", "coef_vegtypeTB", "coef_vegtypeTC", "coef_vegtypeTM")

##Add data for BG
top_mod_table[1,1]<-"BG"
top_mod_table[1,2]<-"Y"
top_mod_table[1,3]<-"fire_pres ~ ppt09 + proj_height_1"
top_mod_table[1,4]<- coef(glm_best)[1] #Intercept
top_mod_table[1,5]<- coef(glm_best)[2] #Climate variable 1
#top_mod_table[1,6]<- coef(glm_best)[2] #Climate variable 2
#top_mod_table[1,7]<- coef(glm_best)[3] #Interaction climate variables
top_mod_table[1,8]<- coef(glm_best)[3] #coef_stand_height
#top_mod_table[1,9]<- coef(glm_best)[3] #live_stand_volume_125
#top_mod_table[1,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[1,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[1,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[1,13]<- coef(glm_best)[4] #coefficient vegtypeS
#top_mod_table[1,14]<- coef(glm_best)[4] #coefficient vegtypeTB
#top_mod_table[1,15]<- coef(glm_best)[4] #coefficient vegtypeTC
#top_mod_table[1,16]<- coef(glm_best)[5] #coefficient vegtypeTM
top_mod_table ##Determine if better way to represent categories for vegtype, and if each climate variable should have its own column

```


## BEC ZONE BWBS Figures
```{r bwbs figures}
bwbs<- dat_lightning_ %>% dplyr::filter(zone =="BWBS")
# I will run separate analyses for treed and non-treed areas because the non-treed areas don't have information for forest height, age or volume and so these variables can't be included in the model.
bwbs_t<- bwbs %>% dplyr::filter(bclcs_level_2=="T") # treed areas
bwbs_nt<- bwbs %>% dplyr::filter(bclcs_level_2!="T") # not treed

# examining relationship between top climatic variable (mean_tave05_tave06_tave07_tave08) and ignition for bwbs 
p <- ggplot(bwbs, aes(mean_tave05_tave06_tave07_tave08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_tave05_tave06_tave07_tave08") + ylab("Pr (ignition)")
p


p <- ggplot(bwbs_t, aes(mean_tave05_tave06_tave07_tave08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_tave05_tave06_tave07_tave08") + ylab("Pr (ignition)")
p


hist(bwbs_t$mean_tave05_tave06_tave07_tave08)


##Check slope and aspect
p <- ggplot(bwbs, aes(slope, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("slope") + ylab("Pr (ignition)")
p


p <- ggplot(bwbs, aes(aspect, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect") + ylab("Pr (ignition)")
p

# Examining the relationship between some stand level variables. Volume and height are fairly correlated (0.72) but age and volume are not. 
ggscatter(bwbs_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(bwbs_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(bwbs_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

table(bwbs_t$vegtype) # includes disturbed, so use this instead of bclcs_level4


```

## BWBS treed statistical model 
```{r bwbs treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

glm1<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08), 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_tave05_tave06_tave07_tave08"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1), 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_height_1), 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125), 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             vegtype, # classification of tree type in the VRI 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             vegtype,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
           scale(proj_height_1) + 
           vegtype,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             vegtype,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)



glm13<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125)* 
             vegtype,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm13)
i=13
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125*vegtype"
table.glm[i,3]<-AICc(glm13)


glm14<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125)*vegtype + 
              scale(proj_age_1),
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm14)
i=14
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125*vegtype + proj_age_1"
table.glm[i,3]<-AICc(glm14)

glm15<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm15)
i=15
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm15)

glm16<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm16)
i=16
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + live_stand_volume_125*vegtype"
table.glm[i,3]<-AICc(glm16)


glm17<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08)
          + slope, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm17)
i=17
table.glm[i,1]<-"glm17"
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + slope"
table.glm[i,3]<-AICc(glm17)

glm18<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) +slope, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm18)
i=18
table.glm[i,1]<-"glm18"
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + slope"
table.glm[i,3]<-AICc(glm18)


glm19<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_height_1) + slope, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm19)
i=19
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + slope"
table.glm[i,3]<-AICc(glm19)

glm20<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + slope, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm20)
i=20
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + slope "
table.glm[i,3]<-AICc(glm20)

glm21<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             vegtype # classification of tree type in the VRI 
+ slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm21)
i=21
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + vegtype + slope "
table.glm[i,3]<-AICc(glm21)

glm22<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1) + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm22)
i=22
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 +proj_age_1 + slope"
table.glm[i,3]<-AICc(glm22)

glm23<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             scale(proj_height_1) + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm23)
i=23
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + proj_height_1 + slope"
table.glm[i,3]<-AICc(glm23)

glm24<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             vegtype + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm24)
i=24
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + vegtype + slope"
table.glm[i,3]<-AICc(glm24)

glm25<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
           scale(proj_height_1) + 
           vegtype + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm25)
i=25
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + vegtype + slope"
table.glm[i,3]<-AICc(glm25)

glm26<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             vegtype + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm26)
i=26
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + vegtype + slope"
table.glm[i,3]<-AICc(glm26)

glm27<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm27)
i=27
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + proj_age_1 + vegtype + slope "
table.glm[i,3]<-AICc(glm27)

glm28<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm28)
i=28
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + vegtype + slope "
table.glm[i,3]<-AICc(glm28)



glm29<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125)* 
             vegtype + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm29)
i=29
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125*vegtype+ slope"
table.glm[i,3]<-AICc(glm29)


glm30<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125)*vegtype + 
              scale(proj_age_1) + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm30)
i=30
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125*vegtype + proj_age_1+ slope"
table.glm[i,3]<-AICc(glm30)

glm31<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype + slope,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm31)
i=31
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype + slope "
table.glm[i,3]<-AICc(glm31)

glm31<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08)
          + aspect, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm31)
i=31
table.glm[i,1]<-"glm31"
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + aspect"
table.glm[i,3]<-AICc(glm31)

glm32<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) +aspect, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm32)
i=32
table.glm[i,1]<-"glm32"
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + aspect"
table.glm[i,3]<-AICc(glm32)


glm33<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_height_1) + aspect, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm33)
i=33
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + aspect"
table.glm[i,3]<-AICc(glm33)

glm34<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + aspect, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm34)
i=34
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + aspect "
table.glm[i,3]<-AICc(glm34)

glm35<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             vegtype # classification of tree type in the VRI 
+ aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm35)
i=35
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + vegtype + aspect "
table.glm[i,3]<-AICc(glm35)

glm36<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1) + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm36)
i=36
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 +proj_age_1 + aspect"
table.glm[i,3]<-AICc(glm36)

glm37<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             scale(proj_height_1) + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm37)
i=37
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + proj_height_1 + aspect"
table.glm[i,3]<-AICc(glm37)

glm38<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             vegtype + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm38)
i=38
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + vegtype + aspect"
table.glm[i,3]<-AICc(glm38)

glm39<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
           scale(proj_height_1) + 
           vegtype + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm39)
i=39
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + vegtype + aspect"
table.glm[i,3]<-AICc(glm39)

glm40<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             vegtype + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm40)
i=40
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + vegtype + aspect"
table.glm[i,3]<-AICc(glm40)

glm41<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm41)
i=41
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + proj_age_1 + vegtype + aspect "
table.glm[i,3]<-AICc(glm41)

glm42<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm42)
i=42
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + vegtype + aspect "
table.glm[i,3]<-AICc(glm42)



glm43<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125)* 
             vegtype + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm43)
i=43
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125*vegtype+ aspect"
table.glm[i,3]<-AICc(glm43)


glm44<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125)*vegtype + 
              scale(proj_age_1) + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm44)
i=44
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125*vegtype + proj_age_1+ aspect"
table.glm[i,3]<-AICc(glm44)

glm45<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm45)
i=45
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype + aspect "
table.glm[i,3]<-AICc(glm45)

glm46<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08)
          + slope + aspect, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm46)
i=46
table.glm[i,1]<-"glm46"
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + slope + aspect"
table.glm[i,3]<-AICc(glm46)

glm47<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) +slope + aspect, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm47)
i=47
table.glm[i,1]<-"glm47"
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + slope + aspect"
table.glm[i,3]<-AICc(glm47)


glm48<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_height_1) + slope + aspect, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm48)
i=48
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + slope + aspect"
table.glm[i,3]<-AICc(glm48)

glm49<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + slope + aspect, 
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm49)
i=49
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + slope + aspect "
table.glm[i,3]<-AICc(glm49)

glm50<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             vegtype # classification of tree type in the VRI 
+ slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm50)
i=50
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + vegtype + slope + aspect "
table.glm[i,3]<-AICc(glm50)

glm51<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1) + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm51)
i=51
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 +proj_age_1 + slope + aspect"
table.glm[i,3]<-AICc(glm51)

glm52<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             scale(proj_height_1) + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm52)
i=52
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + proj_height_1 + slope + aspect"
table.glm[i,3]<-AICc(glm52)

glm53<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             vegtype + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm53)
i=53
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_age_1 + vegtype + slope + aspect"
table.glm[i,3]<-AICc(glm53)

glm54<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
           scale(proj_height_1) + 
           vegtype + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm54)
i=54
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + vegtype + slope + aspect"
table.glm[i,3]<-AICc(glm54)

glm55<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             vegtype + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm55)
i=55
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + vegtype + slope + aspect"
table.glm[i,3]<-AICc(glm55)

glm56<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm56)
i=56
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + proj_age_1 + vegtype + slope + aspect "
table.glm[i,3]<-AICc(glm56)

glm57<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm57)
i=57
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + vegtype + slope + aspect "
table.glm[i,3]<-AICc(glm57)



glm58<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125)* 
             vegtype + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm58)
i=58
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125*vegtype+ slope + aspect"
table.glm[i,3]<-AICc(glm58)


glm59<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
             scale(live_stand_volume_125)*vegtype + 
              scale(proj_age_1) + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm59)
i=59
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + live_stand_volume_125*vegtype + proj_age_1+ slope + aspect"
table.glm[i,3]<-AICc(glm59)

glm60<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype + slope + aspect,
           data= bwbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm60)
i=60
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype + slope + aspect "
table.glm[i,3]<-AICc(glm60)



#Create summary AIC table
table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.bwbs<- table.glm
table.glm.bwbs[order(table.glm.bwbs$deltaAIC),] 


#Best model: tie between model 15 and 16! 
# mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + vegtype
# Close second: mean_tave05_tave06_tave07_tave08 + live_stand_volume_125 + proj_age_1 + vegtype

####################################################


```

Now inspect the top model from the AIC table and alter below to match.

```{r}

##### TOP MODEL####

bwbs_t2<-bwbs_t %>% drop_na(live_stand_volume_125)

glm_best<- glm(fire_pres ~ scale(mean_tave05_tave06_tave07_tave08) +
              scale(live_stand_volume_125) +
             vegtype,
           data= bwbs_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


bwbs_t2$resids<-resid(glm_best)

binnedplot (bwbs_t2$live_stand_volume_125, 
            bwbs_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (bwbs_t2$mean_tave05_tave06_tave07_tave08, 
            bwbs_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


# Diagnostic plots look okay.

##Add to top model table
top_mod_table[2,1]<-"BWBS"
top_mod_table[2,2]<-"Y"
top_mod_table[2,3]<-"fire_pres ~ mean_tave05_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype"
top_mod_table[2,4]<- coef(glm_best)[1] #Intercept
top_mod_table[2,5]<- coef(glm_best)[2] #Climate variable 1
#top_mod_table[2,6]<- coef(glm_best)[3] #Climate variable 2 (if applicable)
#top_mod_table[2,7]<- coef(glm_best)[3] #Climate variable interaction
top_mod_table[2,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[2,9]<- coef(glm_best)[5] #live_stand_volume_125
top_mod_table[2,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[2,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[2,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[2,13]<- coef(glm_best)[4] #coefficient vegtypeS
top_mod_table[2,14]<- coef(glm_best)[6] #coefficient vegtypeTB
top_mod_table[2,15]<- coef(glm_best)[7] #coefficient vegtypeTC
top_mod_table[2,16]<- coef(glm_best)[8] #coefficient vegtypeTM
top_mod_table
```




#############Below needs Models 13-16 added. But still want to add DEM variables anyway.




## CMA treed statistical model 

```{r BG treed model fits}

cma<- dat_lightning_ %>% dplyr::filter(zone =="CMA")
# I will run separate analyses for treed and non-treed areas because the non-treed areas don't have information for forest height, age or volume and so these variables cant be included in the model.
cma_t<- cma %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
cma_nt<- cma %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(cma_t$vegtype)

##Check correlations
ggscatter(cma, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(cma, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(cma, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

ggscatter(cma_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(cma_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(cma_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(cma_t$proj_age_1, breaks=30)
hist(scale(cma_t$proj_age_1), breaks=30)
hist(cma_t$live_stand_volume_125, breaks=30)
hist(scale(cma_t$live_stand_volume_125), breaks=30)

table(cma_t$vegtype)
```

Run chunk below. Note, if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to be models 5 and 6.

```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

##Analyses
glm1<- glm(fire_pres ~ scale(tave08) * scale(ppt08), 
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"tave08 * ppt08"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(tave08) * scale(ppt08) +
             scale(proj_age_1), 
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"tave08 * ppt08 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(tave08) * scale(ppt08) +
             scale(proj_height_1), 
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(tave08) * scale(ppt08) +
             scale(live_stand_volume_125), 
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

#glm5<- glm(fire_pres ~ tave08 * ppt08 +
#             vegtype, # classification of tree type in the VRI; cannot do, because only TC 
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm5)
#i=5
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + vegtype"
#table.glm[i,3]<-AICc(glm5)

glm5<- glm(fire_pres ~ scale(tave08) * scale(ppt08) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(tave08) * scale(ppt08) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= cma_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave08 * ppt08 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm6)

#glm8<- glm(fire_pres ~ tave08 * ppt08 +
#             proj_age_1 + 
#             vegtype, #When Cora runs this, there is only one level for vegtype and thus an error arises
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm8)
#i=8
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + proj_age_1 + vegtype"
#table.glm[i,3]<-AICc(glm8)

#glm9<- glm(fire_pres ~ tave08 * ppt08 +
#             proj_height_1 + 
#             vegtype, #Only one level 
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm9)
#i=9
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + proj_height_1 + vegtype"
#table.glm[i,3]<-AICc(glm9)

#glm10<- glm(fire_pres ~ tave08 * ppt08 +
#             live_stand_volume_125 + 
#             vegtype,
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm10)
#i=10
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125 + vegtype"
#table.glm[i,3]<-AICc(glm10)

#glm11<- glm(fire_pres ~ tave08 * ppt08 +
#             live_stand_volume_125 + 
#              proj_age_1 +
#             vegtype,
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm11)
#i=11
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + live_stand_volume_125 + proj_age_1 + vegtype"
#table.glm[i,3]<-AICc(glm11)

#glm12<- glm(fire_pres ~ tave08 * ppt08 +
#              proj_height_1 +
#              proj_age_1 +
#             vegtype,
#           data= cma_t,
#           family = binomial,
#           na.action=na.omit)
#summary(glm12)
#i=12
#table.glm[i,1]<-paste0("glm",i)
#table.glm[i,2]<-"tave08 * ppt08 + proj_height_1 + proj_age_1 + vegtype"
#table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.cma<- table.glm
table.glm.cma[order(table.glm.cma$deltaAIC),] #


#    Model                                           Variable      AIC  deltaAIC
#4  glm4             tave08 * ppt08 + live_stand_volume_125 47.99134  0.000000
#5  glm5 tave08 * ppt08 + live_stand_volume_125 +proj_age_1 50.25766  2.266327
#2  glm2                        tave08 * ppt08 + proj_age_1 56.95475  8.963410
#3  glm3                     tave08 * ppt08 + proj_height_1 57.63835  9.647012
#1  glm1                                     tave08 * ppt08 58.87539 10.884057
#6  glm6        tave08 * ppt08 + proj_age_1 + proj_height_1 59.16631 11.174974

####################################################

```


Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

cma_t2<-cma_t %>% drop_na(live_stand_volume_125)

glm_best<- glm(fire_pres ~ scale(tave08) * scale(ppt08)+
             scale(live_stand_volume_125),
           data= cma_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


cma_t2$resids<-resid(glm_best)

binnedplot (cma_t2$live_stand_volume_125, 
            cma_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (cma_t2$mean_tave06_tave07_tave08, 
            cma_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))



# Diagnostic plots look ok, not great! Fairly small sample size for this zone.


##Add to top model table
top_mod_table[3,1]<-"CMA"
top_mod_table[3,2]<-"Y"
top_mod_table[3,3]<-"fire_pres ~ tave08 * ppt08 + live_stand_volume_125 + vegtype"
top_mod_table[3,4]<- coef(glm_best)[1] #Intercept
top_mod_table[3,5]<- coef(glm_best)[2] #Climate variable 1
top_mod_table[3,6]<- coef(glm_best)[3] #Climate variable 2 (if applicable)
top_mod_table[3,7]<- coef(glm_best)[5] #Climate variable interaction
#top_mod_table[3,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[3,9]<- coef(glm_best)[4] #live_stand_volume_125
#top_mod_table[3,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[3,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[3,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[3,13]<- coef(glm_best)[4] #coefficient vegtypeS
#top_mod_table[3,14]<- coef(glm_best)[4] #coefficient vegtypeTB
#top_mod_table[3,15]<- coef(glm_best)[4] #coefficient vegtypeTC
#top_mod_table[3,16]<- coef(glm_best)[5] #coefficient vegtypeTM
top_mod_table

```




## BEC ZONE ESSF
```{r essf climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for essf were 
essf<- dat_lightning_ %>%
  filter(zone=="ESSF")

#Separate by trees and no trees
essf_t<- essf %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
essf_nt<- essf %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(essf_t$vegtype)
table(essf_nt$vegtype)

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(essf_t, aes(tave08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("TAve08") + ylab("Pr (ignition)")
p

p <- ggplot(essf_t, aes(ppt08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08") + ylab("Pr (ignition)")
p


hist(essf_t$tave08)
hist(essf_t$ppt08, breaks=30)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(essf_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(essf_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(essf_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(essf_t$proj_age_1)
hist(scale(essf_t$proj_age_1))
hist(essf_t$proj_height_1)
hist(scale(essf_t$proj_height_1))
hist(essf_t$live_stand_volume_125, breaks=30)
hist(scale(essf_t$live_stand_volume_125), breaks=30)
```

```{r essf_1 model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then some of these models cannot be run and will need to be excluded.

essf_t$proj_age_1_scale<-scale(essf_t$proj_age_1)
essf_t$live_stand_volume_125_scale<-scale(essf_t$live_stand_volume_125)
essf_t$proj_height_1_scale<-scale(essf_t$proj_height_1)


glm1<- glm(fire_pres ~ tave07 * ppt07, 
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"tave07 * ppt07"
table.glm[1,3]<-AIC(glm1)

glm2<- glm(fire_pres ~ tave07 * ppt07 +
             vegtype, 
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"tave07 * ppt07 + vegtype"
table.glm[i,3]<-AIC(glm2)


glm3<- glm(fire_pres ~ tave07 * ppt07 +
             proj_age_1_scale, 
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + proj_age_1_scale"
table.glm[i,3]<-AIC(glm3)

glm4<- glm(fire_pres ~ tave07 * ppt07 +
             proj_height_1_scale, 
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + proj_height_1_scale"
table.glm[i,3]<-AIC(glm4)

glm5<- glm(fire_pres ~ tave07 * ppt07 +
             live_stand_volume_125_scale, 
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + live_stand_volume_125_scale"
table.glm[i,3]<-AIC(glm5)

glm6<- glm(fire_pres ~ tave07 * ppt07 +
             live_stand_volume_125_scale +
             proj_age_1_scale,
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + live_stand_volume_125_scale + proj_age_1_scale"
table.glm[i,3]<-AIC(glm6)

glm7<- glm(fire_pres ~ tave07 * ppt07 +
             live_stand_volume_125_scale +
             proj_height_1_scale,
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + live_stand_volume_125_scale + proj_height_1_scale"
table.glm[i,3]<-AIC(glm7)

glm8<- glm(fire_pres ~ tave07 * ppt07 +
             proj_age_1_scale +
             proj_height_1_scale,
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + proj_height_1_scale + proj_age_1_scale"
table.glm[i,3]<-AIC(glm8)

glm9<- glm(fire_pres ~ tave07 * ppt07 +
             vegtype +
             live_stand_volume_125_scale,
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + vegtype + live_stand_volume_125_scale"
table.glm[i,3]<-AIC(glm9)

glm10<- glm(fire_pres ~ tave07 * ppt07 +
             vegtype +
             proj_age_1_scale,
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + vegtype + proj_age_1_scale"
table.glm[i,3]<-AIC(glm10)

glm11<- glm(fire_pres ~ tave07 * ppt07 +
              vegtype + 
              proj_height_1_scale,
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + vegtype + proj_height_1_scale"
table.glm[i,3]<-AIC(glm11)

glm12<- glm(fire_pres ~ tave07 * ppt07 +
             vegtype +
             live_stand_volume_125_scale +
             proj_age_1_scale,
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + vegtype + live_stand_volume_125_scale + proj_age_1_scale"
table.glm[i,3]<-AIC(glm12)

glm13<- glm(fire_pres ~ tave07 * ppt07 +
             vegtype +
             live_stand_volume_125_scale +
             proj_height_1_scale,
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm13)
i=13
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + vegtype + live_stand_volume_125_scale + proj_height_1_scale"
table.glm[i,3]<-AIC(glm13)

glm14<- glm(fire_pres ~ tave07 * ppt07 +
             vegtype +
             proj_age_1_scale +
             proj_height_1_scale,
           data= essf_t,
           family = binomial,
           na.action=na.omit)
summary(glm14)
i=14
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tave07 * ppt07 + vegtype + proj_age_1_scale + proj_height_1_scale"
table.glm[i,3]<-AIC(glm14)


table.glm$delta.aic<- table.glm$AIC - min(table.glm$AIC)
table.glm[order(table.glm$delta.aic),]

# TOP MODEL IS glm13: tave07 * ppt07 + vegtype + live_stand_volume_125_scale + proj_height_1_scale
```

Now inspect the top model from the AIC table and alter below to match.

```{r essf_t model fits}
####################################################
##### TOP MODEL####

essf_t_red<-essf_t %>% drop_na(live_stand_volume_125_scale, proj_age_1_scale, vegtype)

glm_best<- glm(fire_pres ~ scale(tave07) * scale(ppt07) +
             live_stand_volume_125_scale +
             proj_age_1_scale +
            vegtype,
           data= essf_t_red,
           family = binomial,
           na.action=na.omit)
summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


essf_t_red$resids<-resid(glm_best)

binnedplot (essf_t_red$live_stand_volume_125_scale, 
            essf_t_red$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (essf_t_red$proj_age_1_scale, 
            essf_t_red$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


### Residual plots are not amazing...

##Add to top model table
top_mod_table[4,1]<-"ESSF"
top_mod_table[4,2]<-"Y"
top_mod_table[4,3]<-"fire_pres ~ tave07*ppt07 + live_stand_volume_125_scale + proj_age_1_scale + vegtype"
top_mod_table[4,4]<- coef(glm_best)[1] #Intercept
top_mod_table[4,5]<- coef(glm_best)[2] #Climate variable 1
top_mod_table[4,6]<- coef(glm_best)[3] #Climate variable 2 (if applicable)
top_mod_table[4,7]<- coef(glm_best)[11] #Climate variable interaction
#top_mod_table[4,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[4,9]<- coef(glm_best)[4] #live_stand_volume_125
top_mod_table[4,10]<- coef(glm_best)[5] #proj_age_1
#top_mod_table[4,11]<- coef(glm_best)[4] #coefficient vegtypeD
top_mod_table[4,12]<- coef(glm_best)[6] #coefficient vegtypeOP
top_mod_table[4,13]<- coef(glm_best)[7] #coefficient vegtypeS
top_mod_table[4,14]<- coef(glm_best)[8] #coefficient vegtypeTB
top_mod_table[4,15]<- coef(glm_best)[9] #coefficient vegtypeTC
top_mod_table[4,16]<- coef(glm_best)[10] #coefficient vegtypeTM
top_mod_table

```


## BEC ZONE SBS

```{r sbs climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for SBS were mean_tmax07_tmax08
sbs<- dat_lightning_ %>%
  filter(zone=="SBS")

#Separate by trees and no trees
sbs_t<- sbs %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
sbs_nt<- sbs %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(sbs_t$vegtype)
table(sbs_nt$vegtype)

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(sbs_t, aes(mean_tmax07_tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Mean Tmax_07 and Tmax_08") + ylab("Pr (ignition)")
p

hist(sbs_t$mean_tmax07_tmax08)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(sbs_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(sbs_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(sbs_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(sbs_t$proj_age_1, breaks=30)
hist(sbs_t$live_stand_volume_125, breaks=30)

```

```{r sbs model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then some of these models cannot be run and will need to be excluded.

glm1<- glm(fire_pres ~ scale(mean_tmax07_tmax08), 
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_tmax07_tmax08"
table.glm[1,3]<-AIC(glm1)
binnedplot (fitted(glm1), 
            residuals(glm1), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm1")

#veg_variables<- c("vegtype", "proj_age_1", "proj_height_1", "live_stand_volume_125", "subzone")

glm2<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             vegtype, 
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype"
table.glm[i,3]<-AIC(glm2)
binnedplot (fitted(glm2), 
            residuals(glm2), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm2")

glm3<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             scale(proj_age_1), 
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + proj_age_1"
table.glm[i,3]<-AIC(glm3)

glm4<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             scale(proj_height_1), 
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + proj_height_1"
table.glm[i,3]<-AIC(glm4)

glm5<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             scale(live_stand_volume_125), 
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + live_stand_volume_125"
table.glm[i,3]<-AIC(glm5)

glm6<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             scale(live_stand_volume_125) +
             scale(proj_age_1),
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + live_stand_volume_125 + proj_age_1"
table.glm[i,3]<-AIC(glm6)

glm7<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             scale(live_stand_volume_125) +
             scale(proj_height_1),
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + live_stand_volume_125 + proj_height_1"
table.glm[i,3]<-AIC(glm7)

glm8<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             scale(proj_age_1) +
             scale(proj_height_1),
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + proj_height_1 + proj_age_1"
table.glm[i,3]<-AIC(glm8)

glm9<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             vegtype +
             scale(live_stand_volume_125),
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + live_stand_volume_125"
table.glm[i,3]<-AIC(glm9)

glm10<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             vegtype +
             scale(proj_age_1),
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + proj_age_1"
table.glm[i,3]<-AIC(glm10)

glm11<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
              vegtype + 
              scale(proj_height_1),
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + proj_height_1"
table.glm[i,3]<-AIC(glm11)

glm12<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             vegtype +
             scale(live_stand_volume_125) +
             scale(proj_age_1),
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + live_stand_volume_125 + proj_age_1"
table.glm[i,3]<-AIC(glm12)

glm13<- glm(fire_pres ~ mean_tmax07_tmax08 +
             vegtype +
             live_stand_volume_125 +
             proj_height_1,
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm13)
i=13
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + live_stand_volume_125 + proj_height_1"
table.glm[i,3]<-AIC(glm13)

glm14<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             vegtype +
             scale(proj_age_1) +
             scale(proj_height_1),
           data= sbs_t,
           family = binomial,
           na.action=na.omit)
summary(glm14)
i=14
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax07_tmax08 + vegtype + proj_age_1 + proj_height_1"
table.glm[i,3]<-AIC(glm14)

table.glm$delta.aic<- table.glm$AIC - min(table.glm$AIC)
table.glm[order(table.glm$delta.aic),]

# TOP MODEL IS glm13: mean_tmax07_tmax08 + vegtype + live_stand_volume_125 + proj_height_1
```

Now inspect the top model from the AIC table and alter below to match.

```{r sbs model fits}
####################################################
##### TOP MODEL####

sbs_t2<-sbs_t %>% drop_na(live_stand_volume_125, proj_height_1, vegtype)

glm_best<- glm(fire_pres ~ scale(mean_tmax07_tmax08) +
             scale(live_stand_volume_125) +
             scale(proj_height_1) +
             vegtype,
           data= sbs_t2,
           family = binomial,
           na.action=na.omit)
summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


sbs_t2$resids<-resid(glm_best)

binnedplot (sbs_t2$live_stand_volume_125, 
            sbs_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (sbs_t2$proj_age_1, 
            sbs_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))
# this one has a slight up down trend. Ill try to scale proj_age_1 and see if this helps




##Add to top model table
top_mod_table[5,1]<-"SBS"
top_mod_table[5,2]<-"Y"
top_mod_table[5,3]<-"fire_pres ~ mean_tmax07_tmax08 + live_stand_volume_125 + proj_height_1 + vegtype"
top_mod_table[5,4]<- coef(glm_best)[1] #Intercept
top_mod_table[5,5]<- coef(glm_best)[2] #Climate variable 1
#top_mod_table[5,6]<- coef(glm_best)[3] #Climate variable 2 (if applicable)
#top_mod_table[5,7]<- coef(glm_best)[11] #Climate variable interaction
top_mod_table[5,8]<- coef(glm_best)[4] #coef_stand_height
top_mod_table[5,9]<- coef(glm_best)[3] #live_stand_volume_125
#top_mod_table[5,10]<- coef(glm_best)[5] #proj_age_1
#top_mod_table[5,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[5,12]<- coef(glm_best)[5] #coefficient vegtypeOP
#top_mod_table[5,13]<- coef(glm_best)[6] #coefficient vegtypeS
top_mod_table[5,14]<- coef(glm_best)[5] #coefficient vegtypeTB
top_mod_table[5,15]<- coef(glm_best)[6] #coefficient vegtypeTC
top_mod_table[5,16]<- coef(glm_best)[7] #coefficient vegtypeTM
top_mod_table

```

## BEC ZONE SBPS

```{r sbps climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for SBS were mean_tmax07_tmax08
sbps<- dat_lightning_ %>%
  filter(zone=="SBPS")

#Separate by trees and no trees
sbps_t<- sbps %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
sbps_nt<- sbps %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(sbps_t$vegtype)
table(sbps_nt$vegtype)

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(sbps_t, aes(mean_tmax05_tmax06_tmax07_tmax08_tmax09, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_tmax05_tmax06_tmax07_tmax08_tmax09") + ylab("Pr (ignition)")
p

hist(sbps_t$mean_tmax05_tmax06_tmax07_tmax08_tmax09)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(sbps_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(sbps_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(sbps_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(sbps_t$proj_age_1, breaks=30)
hist(sbps_t$live_stand_volume_125, breaks=30)

```

```{r sbps_t model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then some models need to be commented out and model numbers updated.

glm1<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09), 
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09"
table.glm[1,3]<-AIC(glm1)

glm2<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             vegtype, 
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype"
table.glm[i,3]<-AIC(glm2)

glm3<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             proj_age_1, 
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + proj_age_1"
table.glm[i,3]<-AIC(glm3)

glm4<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             scale(proj_height_1), 
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + proj_height_1"
table.glm[i,3]<-AIC(glm4)

glm5<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             scale(live_stand_volume_125), 
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + live_stand_volume_125"
table.glm[i,3]<-AIC(glm5)

glm6<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             scale(live_stand_volume_125) +
             scale(proj_age_1),
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + live_stand_volume_125 + proj_age_1"
table.glm[i,3]<-AIC(glm6)

glm7<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             scale(live_stand_volume_125) +
             scale(proj_height_1),
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + live_stand_volume_125 + proj_height_1"
table.glm[i,3]<-AIC(glm7)

glm8<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             scale(proj_age_1) +
             scale(proj_height_1),
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + proj_height_1 + proj_age_1"
table.glm[i,3]<-AIC(glm8)

glm9<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             vegtype +
             scale(live_stand_volume_125),
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + live_stand_volume_125"
table.glm[i,3]<-AIC(glm9)

glm10<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             vegtype +
             scale(proj_age_1),
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + proj_age_1"
table.glm[i,3]<-AIC(glm10)

glm11<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
              vegtype + 
              scale(proj_height_1),
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + proj_height_1"
table.glm[i,3]<-AIC(glm11)

glm12<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             vegtype +
             scale(live_stand_volume_125) +
             scale(proj_age_1),
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + live_stand_volume_125 + proj_age_1"
table.glm[i,3]<-AIC(glm12)

glm13<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             vegtype +
             scale(live_stand_volume_125) +
             scale(proj_height_1),
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm13)
i=13
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + live_stand_volume_125 + proj_height_1"
table.glm[i,3]<-AIC(glm13)

glm14<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             vegtype +
             scale(proj_age_1) +
             scale(proj_height_1),
           data= sbps_t,
           family = binomial,
           na.action=na.omit)
summary(glm14)
i=14
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06_tmax07_tmax08_tmax09 + vegtype + proj_age_1 + proj_height_1"
table.glm[i,3]<-AIC(glm14)

table.glm$delta.aic<- table.glm$AIC - min(table.glm$AIC)
table.glm[order(table.glm$delta.aic),]

# TOP MODEL IS glm7: mean_tmax05_tmax06_tmax07_tmax08_tmax09 + live_stand_volume_125 + proj_height_1

```


```{r sbps_t model fits}
####################################################
##### TOP MODEL####

sbps_t_red<-sbps_t %>% drop_na(live_stand_volume_125, proj_height_1)

glm_best<- glm(fire_pres ~ scale(mean_tmax05_tmax06_tmax07_tmax08_tmax09) +
             scale(live_stand_volume_125) +
             scale(proj_height_1),
           data= sbps_t_red,
           family = binomial,
           na.action=na.omit)
summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


sbps_t_red$resids<-resid(glm_best)

binnedplot (sbps_t_red$live_stand_volume_125, 
            sbps_t_red$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (sbps_t_red$proj_age_1, 
            sbps_t_red$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))
# this one has a slight up down trend. Ill try to scale proj_age_1 and see if this helps


##Add to top model table
top_mod_table[6,1]<-"SBPS"
top_mod_table[6,2]<-"Y"
top_mod_table[6,3]<-"fire_pres ~ mean_tmax05_tmax06_tmax07_tmax08_tmax09 + live_stand_volume_125 + proj_height_1"
top_mod_table[6,4]<- coef(glm_best)[1] #Intercept
top_mod_table[6,5]<- coef(glm_best)[2] #Climate variable 1
#top_mod_table[6,6]<- coef(glm_best)[3] #Climate variable 2 (if applicable)
#top_mod_table[6,7]<- coef(glm_best)[11] #Climate variable interaction
top_mod_table[6,8]<- coef(glm_best)[4] #coef_stand_height
top_mod_table[6,9]<- coef(glm_best)[3] #live_stand_volume_125
#top_mod_table[6,10]<- coef(glm_best)[5] #proj_age_1
#top_mod_table[6,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[6,12]<- coef(glm_best)[5] #coefficient vegtypeOP
#top_mod_table[6,13]<- coef(glm_best)[6] #coefficient vegtypeS
#top_mod_table[6,14]<- coef(glm_best)[5] #coefficient vegtypeTB
#top_mod_table[6,15]<- coef(glm_best)[6] #coefficient vegtypeTC
#top_mod_table[6,16]<- coef(glm_best)[7] #coefficient vegtypeTM
top_mod_table

```


## BEC ZONE ICH Figures
```{r bg figures}
ICH<- dat_lightning_ %>% dplyr::filter(zone =="ICH")
# I will run separate analyses for treed and non-treed areas because the non-treed areas dont have information for forest height, age or volume and so these variables cant be included in the model.
ICH_t<- ICH %>% dplyr::filter(bclcs_level_2=="T") # treed areas
ICH_nt<- ICH %>% dplyr::filter(bclcs_level_2!="T") # not treed

# examining  relationship between top climatic variable (tmax08 x ppt08) and ignition for ICH 
p <- ggplot(ICH, aes(tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("tmax08") + ylab("Pr (ignition)")
p


p <- ggplot(ICH_t, aes(tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("tmax08") + ylab("Pr (ignition)")
p



hist(ICH_t$tmax08)


p <- ggplot(ICH, aes(ppt08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08") + ylab("Pr (ignition)")
p


p <- ggplot(ICH_t, aes(ppt08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08") + ylab("Pr (ignition)")
p



hist(ICH_t$ppt08)


p <- ggplot(ICH_t, aes(ppt08*tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08*tmax08") + ylab("Pr (ignition)")
p

# Examining the relationship between some stand level variables. Volume and height are fairly correlated (0.72) but age and volume are not. 
ggscatter(ICH_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(ICH_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(ICH_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

table(ICH_t$vegtype) # includes disturbed, so use this instead of bclcs_level4 (but note that most disturbed sites get eleiminated when NAs removed in final model)
table(ICH_t$vegtype)

```

## ICH treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

glm1<- glm(fire_pres ~ scale(tmax08)*scale(ppt08), 
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"tmax08 * ppt08"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
             scale(proj_age_1), 
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
             scale(proj_height_1), 
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
             scale(live_stand_volume_125), 
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
             vegtype, # classification of tree type in the VRI 
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
             scale(proj_age_1) + 
             vegtype,
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
           scale(proj_height_1) + 
           vegtype,
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
             scale(live_stand_volume_125) + 
             vegtype,
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ scale(tmax08)*scale(ppt08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= ICH_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.ICH<- table.glm
table.glm.ICH[order(table.glm.ICH$deltaAIC),] 

#Model                                                      Variable       AIC  deltaAIC
#11 glm11 tmax08 * ppt08 + live_stand_volume_125 + proj_age_1 + vegtype  9905.907    0.0000
#6   glm6            tmax08 * ppt08 + live_stand_volume_125 +proj_age_1 10014.752  108.8450
#10 glm10              tmax08 * ppt08 + live_stand_volume_125 + vegtype 10071.034  165.1262
#4   glm4                        tmax08 * ppt08 + live_stand_volume_125 10232.234  326.3266
#8   glm8                         tmax08 * ppt08 + proj_age_1 + vegtype 10546.895  640.9872
#12 glm12         tmax08 * ppt08 + proj_height_1 + proj_age_1 + vegtype 10547.330  641.4222
#9   glm9                      tmax08 * ppt08 + proj_height_1 + vegtype 10683.185  777.2771
#7   glm7                   tmax08 * ppt08 + proj_age_1 + proj_height_1 10693.948  788.0405
#2   glm2                                   tmax08 * ppt08 + proj_age_1 10705.446  799.5384
#3   glm3                                tmax08 * ppt08 + proj_height_1 10901.324  995.4168
#5   glm5                                      tmax08 * ppt08 + vegtype 11237.079 1331.1718
#1   glm1                                                tmax08 * ppt08 11468.882 1562.9745


##Best model tmax08 * ppt08 + live_stand_volume_125 + proj_age_1 + vegtype 

```

Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

ICH_t2<-ICH_t %>% drop_na(live_stand_volume_125, proj_age_1, vegtype)
table(ICH_t2$vegtype) # 5 disturbed remain from the initial 203

glm_best<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)+
             scale(live_stand_volume_125) +
               scale(proj_age_1) +
               vegtype, 
           data= ICH_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


ICH_t2$resids<-resid(glm_best)

binnedplot (ICH_t2$live_stand_volume_125, 
            ICH_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (ICH_t2$ppt08, 
            ICH_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (ICH_t2$tmax08, 
            ICH_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


# Diagnostic plots look good

##Add to top model table
top_mod_table[7,1]<-"ICH"
top_mod_table[7,2]<-"Y"
top_mod_table[7,3]<-"fire_pres ~ tmax08 * ppt08 + live_stand_volume_125 + proj_age_1 + vegtype"
top_mod_table[7,4]<- coef(glm_best)[1] #Intercept
top_mod_table[7,5]<- coef(glm_best)[2] #Climate variable 1
top_mod_table[7,6]<- coef(glm_best)[3] #Climate variable 2 (if applicable)
top_mod_table[7,7]<- coef(glm_best)[10] #Climate variable interaction
#top_mod_table[7,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[7,9]<- coef(glm_best)[4] #live_stand_volume_125
top_mod_table[7,10]<- coef(glm_best)[5] #proj_age_1
#top_mod_table[7,11]<- coef(glm_best)[4] #coefficient vegtypeD
top_mod_table[7,12]<- coef(glm_best)[6] #coefficient vegtypeOP
#top_mod_table[7,13]<- coef(glm_best)[4] #coefficient vegtypeS
top_mod_table[7,14]<- coef(glm_best)[7] #coefficient vegtypeTB
top_mod_table[7,15]<- coef(glm_best)[8] #coefficient vegtypeTC
top_mod_table[7,16]<- coef(glm_best)[9] #coefficient vegtypeTM
top_mod_table
```


## BEC ZONE CWH Figures
```{r bg figures}
CWH<- dat_lightning_ %>% dplyr::filter(zone =="CWH")
# I will run separate analyses for treed and non-treed areas because the non-treed areas dont have information for forest height, age or volume and so these variables cant be included in the model.
CWH_t<- CWH %>% dplyr::filter(bclcs_level_2=="T") # treed areas
CWH_nt<- CWH %>% dplyr::filter(bclcs_level_2!="T") # not treed

# examining  relationship between top climatic variable (tmax08 x ppt08) and ignition for CWH 
p <- ggplot(CWH, aes(tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("tmax08") + ylab("Pr (ignition)")
p


p <- ggplot(CWH_t, aes(tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("tmax08") + ylab("Pr (ignition)")
p



hist(CWH_t$tmax08)


p <- ggplot(CWH, aes(ppt08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08") + ylab("Pr (ignition)")
p


p <- ggplot(CWH_t, aes(ppt08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08") + ylab("Pr (ignition)")
p



hist(CWH_t$ppt08)


p <- ggplot(CWH_t, aes(ppt08*tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08*tmax08") + ylab("Pr (ignition)")
p

##Above are not linear. Try 1/x and 1/x^2 transformation for ppt08

p <- ggplot(CWH_t, aes((1/ppt08), as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("1/ppt08") + ylab("Pr (ignition)")
p

p <- ggplot(CWH_t, aes((1/ppt08^2), as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("1/ppt08^2") + ylab("Pr (ignition)")
p

hist(1/((CWH_t$ppt08^2)+1))
min(CWH_t$ppt08)
max(CWH_t$ppt08)
#Distribution is not great

hist(CWH$ppt08*CWH$tmax08)


##Check slope and aspect

##Check slope and aspect
p <- ggplot(CWH, aes(slope, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("slope") + ylab("Pr (ignition)")
p


p <- ggplot(CWH, aes(aspect, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect") + ylab("Pr (ignition)")
p

p <- ggplot(CWH, aes(sin(aspect), as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("aspect") + ylab("Pr (ignition)")
p

# Examining the relationship between some stand level variables. Volume and height are fairly correlated (0.72) but age and volume are not. 
ggscatter(CWH_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(CWH_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(CWH_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

table(CWH_t$vegtype) # Check to see if we lose disturbed sites in final model

```

## CWH treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

glm1<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ), 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"scale(tmax08) * scale(ppt08) "
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(proj_age_1), 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(proj_height_1), 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(live_stand_volume_125), 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             vegtype, # classification of tree type in the VRI 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(proj_age_1) + 
             vegtype,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
           scale(proj_height_1) + 
           vegtype,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(live_stand_volume_125) + 
             vegtype,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)



glm13<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(live_stand_volume_125)* 
             vegtype,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm13)
i=13
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + live_stand_volume_125*vegtype"
table.glm[i,3]<-AICc(glm13)


glm14<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
             scale(live_stand_volume_125)*vegtype + 
              scale(proj_age_1),
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm14)
i=14
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + live_stand_volume_125*vegtype + proj_age_1"
table.glm[i,3]<-AICc(glm14)

glm15<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm15)
i=15
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm15)

glm16<- glm(fire_pres ~ scale(scale(tmax08) * scale(ppt08) ) +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm16)
i=16
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"scale(tmax08) * scale(ppt08)  + proj_height_1 + proj_age_1 + live_stand_volume_125*vegtype"
table.glm[i,3]<-AICc(glm16)




glm17<- glm(fire_pres ~ scale(tmax08) * scale(ppt08) 
          + slope, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm17)
i=17
table.glm[i,1]<-"glm17"
table.glm[i,2]<-"tmax08 * ppt08 + slope"
table.glm[i,3]<-AICc(glm17)

glm18<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_age_1) +slope, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm18)
i=18
table.glm[i,1]<-"glm18"
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + slope"
table.glm[i,3]<-AICc(glm18)


glm19<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_height_1) + slope, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm19)
i=19
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + slope"
table.glm[i,3]<-AICc(glm19)

glm20<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + slope, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm20)
i=20
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + slope "
table.glm[i,3]<-AICc(glm20)

glm21<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             vegtype # classification of tree type in the VRI 
+ slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm21)
i=21
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + vegtype + slope "
table.glm[i,3]<-AICc(glm21)

glm22<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + 
             scale(proj_age_1) + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm22)
i=22
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 +proj_age_1 + slope"
table.glm[i,3]<-AICc(glm22)

glm23<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_age_1) + 
             scale(proj_height_1) + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm23)
i=23
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + proj_height_1 + slope"
table.glm[i,3]<-AICc(glm23)

glm24<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_age_1) + 
             vegtype + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm24)
i=24
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + vegtype + slope"
table.glm[i,3]<-AICc(glm24)

glm25<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
           scale(proj_height_1) + 
           vegtype + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm25)
i=25
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + vegtype + slope"
table.glm[i,3]<-AICc(glm25)

glm26<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + 
             vegtype + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm26)
i=26
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + vegtype + slope"
table.glm[i,3]<-AICc(glm26)

glm27<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm27)
i=27
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + proj_age_1 + vegtype + slope "
table.glm[i,3]<-AICc(glm27)

glm28<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm28)
i=28
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + proj_age_1 + vegtype + slope "
table.glm[i,3]<-AICc(glm28)



glm29<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125)* 
             vegtype + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm29)
i=29
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125*vegtype+ slope"
table.glm[i,3]<-AICc(glm29)


glm30<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125)*vegtype + 
              scale(proj_age_1) + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm30)
i=30
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125*vegtype + proj_age_1+ slope"
table.glm[i,3]<-AICc(glm30)

glm31<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype + slope,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm31)
i=31
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype + slope "
table.glm[i,3]<-AICc(glm31)

glm31<- glm(fire_pres ~ scale(tmax08) * scale(ppt08) 
          + aspect, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm31)
i=31
table.glm[i,1]<-"glm31"
table.glm[i,2]<-"tmax08 * ppt08 + aspect"
table.glm[i,3]<-AICc(glm31)

glm32<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_age_1) +aspect, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm32)
i=32
table.glm[i,1]<-"glm32"
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + aspect"
table.glm[i,3]<-AICc(glm32)


glm33<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_height_1) + aspect, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm33)
i=33
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + aspect"
table.glm[i,3]<-AICc(glm33)

glm34<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + aspect, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm34)
i=34
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + aspect "
table.glm[i,3]<-AICc(glm34)

glm35<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             vegtype # classification of tree type in the VRI 
+ aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm35)
i=35
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + vegtype + aspect "
table.glm[i,3]<-AICc(glm35)

glm36<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + 
             scale(proj_age_1) + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm36)
i=36
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 +proj_age_1 + aspect"
table.glm[i,3]<-AICc(glm36)

glm37<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_age_1) + 
             scale(proj_height_1) + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm37)
i=37
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + proj_height_1 + aspect"
table.glm[i,3]<-AICc(glm37)

glm38<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_age_1) + 
             vegtype + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm38)
i=38
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + vegtype + aspect"
table.glm[i,3]<-AICc(glm38)

glm39<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
           scale(proj_height_1) + 
           vegtype + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm39)
i=39
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + vegtype + aspect"
table.glm[i,3]<-AICc(glm39)

glm40<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + 
             vegtype + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm40)
i=40
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + vegtype + aspect"
table.glm[i,3]<-AICc(glm40)

glm41<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm41)
i=41
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + proj_age_1 + vegtype + aspect "
table.glm[i,3]<-AICc(glm41)

glm42<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm42)
i=42
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + proj_age_1 + vegtype + aspect "
table.glm[i,3]<-AICc(glm42)



glm43<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125)* 
             vegtype + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm43)
i=43
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125*vegtype+ aspect"
table.glm[i,3]<-AICc(glm43)


glm44<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125)*vegtype + 
              scale(proj_age_1) + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm44)
i=44
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125*vegtype + proj_age_1+ aspect"
table.glm[i,3]<-AICc(glm44)

glm45<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm45)
i=45
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype + aspect "
table.glm[i,3]<-AICc(glm45)

glm46<- glm(fire_pres ~ scale(tmax08) * scale(ppt08) 
          + slope + aspect, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm46)
i=46
table.glm[i,1]<-"glm46"
table.glm[i,2]<-"tmax08 * ppt08 + slope + aspect"
table.glm[i,3]<-AICc(glm46)

glm47<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_age_1) +slope + aspect, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm47)
i=47
table.glm[i,1]<-"glm47"
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + slope + aspect"
table.glm[i,3]<-AICc(glm47)


glm48<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_height_1) + slope + aspect, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm48)
i=48
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + slope + aspect"
table.glm[i,3]<-AICc(glm48)

glm49<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + slope + aspect, 
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm49)
i=49
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + slope + aspect "
table.glm[i,3]<-AICc(glm49)

glm50<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             vegtype # classification of tree type in the VRI 
+ slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm50)
i=50
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + vegtype + slope + aspect "
table.glm[i,3]<-AICc(glm50)

glm51<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + 
             scale(proj_age_1) + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm51)
i=51
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 +proj_age_1 + slope + aspect"
table.glm[i,3]<-AICc(glm51)

glm52<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_age_1) + 
             scale(proj_height_1) + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm52)
i=52
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + proj_height_1 + slope + aspect"
table.glm[i,3]<-AICc(glm52)

glm53<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(proj_age_1) + 
             vegtype + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm53)
i=53
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_age_1 + vegtype + slope + aspect"
table.glm[i,3]<-AICc(glm53)

glm54<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
           scale(proj_height_1) + 
           vegtype + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm54)
i=54
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + vegtype + slope + aspect"
table.glm[i,3]<-AICc(glm54)

glm55<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + 
             vegtype + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm55)
i=55
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + vegtype + slope + aspect"
table.glm[i,3]<-AICc(glm55)

glm56<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm56)
i=56
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125 + proj_age_1 + vegtype + slope + aspect "
table.glm[i,3]<-AICc(glm56)

glm57<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm57)
i=57
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + proj_age_1 + vegtype + slope + aspect "
table.glm[i,3]<-AICc(glm57)



glm58<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125)* 
             vegtype + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm58)
i=58
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125*vegtype+ slope + aspect"
table.glm[i,3]<-AICc(glm58)


glm59<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
             scale(live_stand_volume_125)*vegtype + 
              scale(proj_age_1) + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm59)
i=59
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + live_stand_volume_125*vegtype + proj_age_1+ slope + aspect"
table.glm[i,3]<-AICc(glm59)

glm60<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)  +
              scale(proj_height_1) +
              scale(proj_age_1) +
              scale(live_stand_volume_125) +
             vegtype + slope + aspect,
           data= CWH_t,
           family = binomial,
           na.action=na.omit)
summary(glm60)
i=60
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax08 * ppt08 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype + slope + aspect "
table.glm[i,3]<-AICc(glm60)




table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.CWH<- table.glm
table.glm.CWH[order(table.glm.CWH$deltaAIC),] 



##Best model tmax08 * ppt08 + live_stand_volume_125*vegtype + proj_age_1 + slope
## next best model: tmax08 * ppt08 + proj_height_1 + proj_age_1 + live_stand_volume_125 + vegtype + slope + aspect

```

Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

CWH_t2<-CWH_t %>% drop_na(live_stand_volume_125, proj_age_1, vegtype)
table(CWH_t2$vegtype) # 5 disturbed remain from the initial 203

glm_best<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)+
             scale(live_stand_volume_125)*vegtype +
               scale(proj_age_1) +
               scale(slope), 
           data= CWH_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

##Use second model without interaction since delatAIC < 2
CWH_t2<-CWH_t %>% drop_na(live_stand_volume_125, proj_age_1, vegtype,proj_height_1, slope, aspect)

glm_best<- glm(fire_pres ~ scale(tmax08) * scale(ppt08)+
             scale(live_stand_volume_125) + 
               vegtype +
               scale(proj_age_1) +
               scale(proj_height_1) +
               scale(slope) +
               scale(aspect), 
           data= CWH_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


CWH_t2$resids<-resid(glm_best)

binnedplot (CWH_t2$live_stand_volume_125, 
            CWH_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (CWH_t2$ppt08, 
            CWH_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (CWH_t2$tmax08, 
            CWH_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


# Diagnostic plots look ok

##Add to top model table
top_mod_table[8,1]<-"CWH"
top_mod_table[8,2]<-"Y"
top_mod_table[8,3]<-"fire_pres ~ tmax08 * ppt08 + live_stand_volume_125 + proj_age_1 + vegtype"
top_mod_table[8,4]<- coef(glm_best)[1] #Intercept
top_mod_table[8,5]<- coef(glm_best)[2] #Climate variable 1
top_mod_table[8,6]<- coef(glm_best)[3] #Climate variable 2 (if applicable)
top_mod_table[8,7]<- coef(glm_best)[9] #Climate variable interaction
#top_mod_table[8,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[8,9]<- coef(glm_best)[4] #live_stand_volume_125
top_mod_table[8,10]<- coef(glm_best)[5] #proj_age_1
#top_mod_table[8,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[8,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[8,13]<- coef(glm_best)[4] #coefficient vegtypeS
top_mod_table[8,14]<- coef(glm_best)[6] #coefficient vegtypeTB
top_mod_table[8,15]<- coef(glm_best)[7] #coefficient vegtypeTC
top_mod_table[8,16]<- coef(glm_best)[8] #coefficient vegtypeTM
top_mod_table

```



## BEC ZONE IDF Figures
```{r bg figures}
IDF<- dat_lightning_ %>% dplyr::filter(zone =="IDF")
# I will run separate analyses for treed and non-treed areas because the non-treed areas dont have information for forest height, age or volume and so these variables cant be included in the model.
IDF_t<- IDF %>% dplyr::filter(bclcs_level_2=="T") # treed areas
IDF_nt<- IDF %>% dplyr::filter(bclcs_level_2!="T") # not treed

# examining  relationship between top climatic variable (tmax08 x ppt08) and ignition for IDF 
p <- ggplot(IDF, aes(tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("tmax08") + ylab("Pr (ignition)")
p


p <- ggplot(IDF_t, aes(tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("tmax08") + ylab("Pr (ignition)")
p



hist(IDF_t$tmax08)


p <- ggplot(IDF, aes(ppt08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08") + ylab("Pr (ignition)")
p


p <- ggplot(IDF_t, aes(ppt08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08") + ylab("Pr (ignition)")
p



hist(IDF_t$ppt08)


p <- ggplot(IDF_t, aes(ppt08*tmax08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("ppt08*tmax08") + ylab("Pr (ignition)")
p

# Examining the relationship between some stand level variables. Volume and height are fairly correlated (0.72) but age and volume are not. 
ggscatter(IDF_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(IDF_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(IDF_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

table(IDF_t$vegtype) # includes disturbed, so use this instead of bclcs_level4 (but note that most disturbed sites get eliminated when NAs removed in final model)
table(IDF_t$vegtype)

```


## IDF treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

glm1<- glm(fire_pres ~ scale(tmax07)*scale(ppt07), 
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"tmax07 * ppt07"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
             scale(proj_age_1), 
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"tmax07 * ppt07 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
             scale(proj_height_1), 
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
             scale(live_stand_volume_125), 
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
             vegtype, # classification of tree type in the VRI 
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
             scale(proj_age_1) + 
             vegtype,
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
           scale(proj_height_1) + 
           vegtype,
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
             scale(live_stand_volume_125) + 
             vegtype,
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ scale(tmax07)*scale(ppt07) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= IDF_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"tmax07 * ppt07 + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.IDF<- table.glm
table.glm.IDF[order(table.glm.IDF$deltaAIC),] 

#Model                                                      Variable      AIC   deltaAIC
#11 glm11 tmax07 * ppt07 + live_stand_volume_125 + proj_age_1 + vegtype 7229.607   0.000000
#10 glm10              tmax07 * ppt07 + live_stand_volume_125 + vegtype 7239.183   9.576046
#6   glm6            tmax07 * ppt07 + live_stand_volume_125 +proj_age_1 7251.285  21.678483
#4   glm4                        tmax07 * ppt07 + live_stand_volume_125 7268.595  38.988212
#12 glm12         tmax07 * ppt07 + proj_height_1 + proj_age_1 + vegtype 7641.474 411.866710
#8   glm8                         tmax07 * ppt07 + proj_age_1 + vegtype 7642.318 412.710785
#9   glm9                      tmax07 * ppt07 + proj_height_1 + vegtype 7643.739 414.131779
#2   glm2                                   tmax07 * ppt07 + proj_age_1 7666.938 437.331375
#7   glm7                   tmax07 * ppt07 + proj_age_1 + proj_height_1 7667.244 437.637481
#3   glm3                                tmax07 * ppt07 + proj_height_1 7675.991 446.383862
#5   glm5                                      tmax07 * ppt07 + vegtype 8108.856 879.249464
#1   glm1                                                tmax07 * ppt07 8142.728 913.121436


##Best model tmax07 * ppt07 + live_stand_volume_125 + proj_age_1 + vegtype

```

Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

IDF_t2<-IDF_t %>% drop_na(live_stand_volume_125, proj_age_1, vegtype)
table(IDF_t2$vegtype) # Most disturbed sites lost

glm_best<- glm(fire_pres ~ scale(tmax07) * scale(ppt07)+
             scale(live_stand_volume_125) +
               scale(proj_age_1) +
               vegtype, 
           data= IDF_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


IDF_t2$resids<-resid(glm_best)

binnedplot (IDF_t2$live_stand_volume_125, 
            IDF_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (IDF_t2$ppt07, 
            IDF_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (IDF_t2$tmax07, 
            IDF_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


# Diagnostic plots look ok

##Add to top model table
top_mod_table[9,1]<-"IDF"
top_mod_table[9,2]<-"Y"
top_mod_table[9,3]<-"fire_pres ~ tmax07 * ppt07 + live_stand_volume_125 + proj_age_1 + vegtype"
top_mod_table[9,4]<- coef(glm_best)[1] #Intercept
top_mod_table[9,5]<- coef(glm_best)[2] #Climate variable 1
top_mod_table[9,6]<- coef(glm_best)[3] #Climate variable 2 (if applicable)
top_mod_table[9,7]<- coef(glm_best)[9] #Climate variable interaction
#top_mod_table[9,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[9,9]<- coef(glm_best)[4] #live_stand_volume_125
top_mod_table[9,10]<- coef(glm_best)[5] #proj_age_1
#top_mod_table[9,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[9,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[9,13]<- coef(glm_best)[4] #coefficient vegtypeS
top_mod_table[9,14]<- coef(glm_best)[6] #coefficient vegtypeTB
top_mod_table[9,15]<- coef(glm_best)[7] #coefficient vegtypeTC
top_mod_table[9,16]<- coef(glm_best)[8] #coefficient vegtypeTM
top_mod_table
```




## BEC ZONE IMA

```{r IMA climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for SBS were mean_tmax07_tmax08
IMA<- dat_lightning_ %>%
  filter(zone=="IMA")

#Separate by trees and no trees
IMA_t<- IMA %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
IMA_nt<- IMA %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(IMA_t$vegtype)
table(IMA_nt$vegtype)

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(IMA_t, aes(mean_tave05_tave06, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_tave05_tave06") + ylab("Pr (ignition)")
p

hist(IMA_t$mean_tave05_tave06)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(IMA_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(IMA_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(IMA_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(IMA_t$proj_age_1, breaks=30)
hist(IMA_t$live_stand_volume_125, breaks=30)

```


## IMA treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

glm1<- glm(fire_pres ~ mean_tave05_tave06, 
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_tave05_tave06"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ mean_tave05_tave06 +
             scale(proj_age_1), 
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_tave05_tave06 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ mean_tave05_tave06 +
             scale(proj_height_1), 
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ mean_tave05_tave06 +
             scale(live_stand_volume_125), 
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ mean_tave05_tave06 +
             vegtype, # classification of tree type in the VRI 
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ mean_tave05_tave06 +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ mean_tave05_tave06 +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ mean_tave05_tave06 +
             scale(proj_age_1) + 
             vegtype,
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ mean_tave05_tave06 +
           scale(proj_height_1) + 
           vegtype,
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ mean_tave05_tave06 +
             scale(live_stand_volume_125) + 
             vegtype,
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ mean_tave05_tave06 +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ mean_tave05_tave06 +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= IMA_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave05_tave06 + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.IMA<- table.glm
table.glm.IMA[order(table.glm.IMA$deltaAIC),] 

#Model                                                          Variable         AIC     deltaAIC
#4   glm4                        mean_tave05_tave06 + live_stand_volume_125    74.02171 0.000000e+00
#6   glm6            mean_tave05_tave06 + live_stand_volume_125 +proj_age_1    74.91448 8.927644e-01
#1   glm1                                                mean_tave05_tave06    78.65020 #4.628489e+00
#2   glm2                                   mean_tave05_tave06 + proj_age_1    78.69108 #4.669373e+00
#3   glm3                                mean_tave05_tave06 + proj_height_1    78.93650 #4.914793e+00
#7   glm7                   mean_tave05_tave06 + proj_age_1 + proj_height_1    80.70013 6.678418e+00
#11 glm11 mean_tave05_tave06 + live_stand_volume_125 + proj_age_1 + vegtype  9905.90747 9.831886e+03
#10 glm10              mean_tave05_tave06 + live_stand_volume_125 + vegtype 10071.03368 9.997012e+03
#8   glm8                         mean_tave05_tave06 + proj_age_1 + vegtype 10546.89467 1.047287e+04
#12 glm12         mean_tave05_tave06 + proj_height_1 + proj_age_1 + vegtype 10547.32970 1.047331e+04
#9   glm9                      mean_tave05_tave06 + proj_height_1 + vegtype 10683.18461 1.060916e+04
#5   glm5                                      mean_tave05_tave06 + vegtype 11237.07931 1.116306e+04

```

Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

IMA_t2<-IMA_t %>% drop_na(live_stand_volume_125)
table(IMA_t2$vegtype) # Most disturbed sites lost

glm_best<- glm(fire_pres ~ scale(mean_tave05_tave06)+
             scale(live_stand_volume_125), 
           data= IMA_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


IMA_t2$resids<-resid(glm_best)

binnedplot (IMA_t2$live_stand_volume_125, 
            IMA_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (IMA_t2$mean_tave05_tave06, 
            IMA_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))



# Diagnostic plots look ok

##Add to top model table
top_mod_table[10,1]<-"IMA"
top_mod_table[10,2]<-"Y"
top_mod_table[10,3]<-"fire_pres ~ mean_tave05_tave06 + live_stand_volume_125"
top_mod_table[10,4]<- coef(glm_best)[1] #Intercept
top_mod_table[10,5]<- coef(glm_best)[2] #Climate variable 1
#top_mod_table[10,6]<- coef(glm_best)[3] #Climate variable 2 (if applicable)
#top_mod_table[10,7]<- coef(glm_best)[9] #Climate variable interaction
#top_mod_table[10,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[10,9]<- coef(glm_best)[3] #live_stand_volume_125
#top_mod_table[10,10]<- coef(glm_best)[5] #proj_age_1
#top_mod_table[10,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[10,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[10,13]<- coef(glm_best)[4] #coefficient vegtypeS
#top_mod_table[10,14]<- coef(glm_best)[6] #coefficient vegtypeTB
#top_mod_table[10,15]<- coef(glm_best)[7] #coefficient vegtypeTC
#top_mod_table[10,16]<- coef(glm_best)[8] #coefficient vegtypeTM
top_mod_table
```








## BEC ZONE MH

```{r MH climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for SBS were mean_ppt08_ppt09
MH<- dat_lightning_ %>%
  filter(zone=="MH")

#Separate by trees and no trees
MH_t<- MH %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
MH_nt<- MH %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(MH_t$vegtype)
table(MH_nt$vegtype)

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(MH_t, aes(mean_ppt08_ppt09, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_ppt08_ppt09") + ylab("Pr (ignition)")
p

hist(MH_t$mean_ppt08_ppt09)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(MH_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(MH_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(MH_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(MH_t$proj_age_1, breaks=30)
hist(MH_t$live_stand_volume_125, breaks=30)

```


## MH treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

glm1<- glm(fire_pres ~ scale(mean_ppt08_ppt09), 
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_ppt08_ppt09"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(proj_age_1), 
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(proj_height_1), 
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(live_stand_volume_125), 
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             vegtype, # classification of tree type in the VRI 
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(proj_age_1) + 
             vegtype,
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
           scale(proj_height_1) + 
           vegtype,
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(live_stand_volume_125) + 
             vegtype,
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= MH_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.MH<- table.glm
table.glm.MH[order(table.glm.MH$deltaAIC),] 

#Model                                                        Variable      AIC   deltaAIC
#6   glm6            mean_ppt08_ppt09 + live_stand_volume_125 +proj_age_1 369.9763   0.000000
#4   glm4                        mean_ppt08_ppt09 + live_stand_volume_125 372.6720   2.695711
#11 glm11 mean_ppt08_ppt09 + live_stand_volume_125 + proj_age_1 + vegtype 372.6859   2.709637
#10 glm10              mean_ppt08_ppt09 + live_stand_volume_125 + vegtype 375.0995   5.123233
#12 glm12         mean_ppt08_ppt09 + proj_height_1 + proj_age_1 + vegtype 519.3666 149.390325
#2   glm2                                   mean_ppt08_ppt09 + proj_age_1 519.6185 149.642232
#8   glm8                         mean_ppt08_ppt09 + proj_age_1 + vegtype 519.6352 149.658917
#7   glm7                   mean_ppt08_ppt09 + proj_age_1 + proj_height_1 520.0387 150.062410
#9   glm9                      mean_ppt08_ppt09 + proj_height_1 + vegtype 522.5865 152.610244
#3   glm3                                mean_ppt08_ppt09 + proj_height_1 525.1243 155.148022
#5   glm5                                      mean_ppt08_ppt09 + vegtype 552.3049 182.328601
#1   glm1                                                mean_ppt08_ppt09 554.1078 184.131559

```

Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

MH_t2<-MH_t %>% drop_na(live_stand_volume_125, proj_age_1)

glm_best<- glm(fire_pres ~ scale(mean_ppt08_ppt09)+
             scale(live_stand_volume_125) +
               scale(proj_age_1), 
           data= MH_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


MH_t2$resids<-resid(glm_best)

binnedplot (MH_t2$live_stand_volume_125, 
            MH_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (MH_t2$mean_ppt08_ppt09, 
            MH_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


# Diagnostic plots look ok

##Add to top model table
top_mod_table[11,1]<-"MH"
top_mod_table[11,2]<-"Y"
top_mod_table[11,3]<-"fire_pres ~ mean_ppt08_ppt09 + live_stand_volume_125 +proj_age_1"
top_mod_table[11,4]<- coef(glm_best)[1] #Intercept
top_mod_table[11,5]<- coef(glm_best)[2] #ClMHte variable 1
#top_mod_table[11,6]<- coef(glm_best)[3] #ClMHte variable 2 (if applicable)
#top_mod_table[11,7]<- coef(glm_best)[9] #ClMHte variable interaction
#top_mod_table[11,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[11,9]<- coef(glm_best)[3] #live_stand_volume_125
top_mod_table[11,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[11,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[11,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[11,13]<- coef(glm_best)[4] #coefficient vegtypeS
#top_mod_table[11,14]<- coef(glm_best)[6] #coefficient vegtypeTB
#top_mod_table[11,15]<- coef(glm_best)[7] #coefficient vegtypeTC
#top_mod_table[11,16]<- coef(glm_best)[8] #coefficient vegtypeTM
top_mod_table
```





## BEC ZONE MS

```{r MS climate figure}
# look at the data graphically in this BEC zone

# top clMStic variables for SBS were mean_tmax07_tmax08
MS<- dat_lightning_ %>%
  filter(zone=="MS")

#Separate by trees and no trees
MS_t<- MS %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
MS_nt<- MS %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(MS_t$vegtype)
table(MS_nt$vegtype)

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(MS_t, aes(mean_tave06_tave07_tave08, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_tave06_tave07_tave08") + ylab("Pr (ignition)")
p

hist(MS_t$mean_tave06_tave07_tave08)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(MS_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(MS_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(MS_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(MS_t$proj_age_1, breaks=30)
hist(MS_t$live_stand_volume_125, breaks=30)

```


## MS treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

glm1<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08), 
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_tave06_tave07_tave08"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
             scale(proj_age_1), 
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
             scale(proj_height_1), 
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
             scale(live_stand_volume_125), 
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
             vegtype, # classification of tree type in the VRI 
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
             scale(proj_age_1) + 
             vegtype,
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
           scale(proj_height_1) + 
           vegtype,
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
             vegtype,
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= MS_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.MS<- table.glm
table.glm.MS[order(table.glm.MS$deltaAIC),] 

#Model                                                                 Variable      AIC    deltaAIC
#11 glm11 mean_tave06_tave07_tave08 + live_stand_volume_125 + proj_age_1 + vegtype 2153.255   0.0000000
#6   glm6            mean_tave06_tave07_tave08 + live_stand_volume_125 +proj_age_1 2154.118   0.8630376
#10 glm10              mean_tave06_tave07_tave08 + live_stand_volume_125 + vegtype 2163.379  10.1238511
#4   glm4                        mean_tave06_tave07_tave08 + live_stand_volume_125 2164.554  11.2989558
#12 glm12         mean_tave06_tave07_tave08 + proj_height_1 + proj_age_1 + vegtype 2312.630 159.3744499
#9   glm9                      mean_tave06_tave07_tave08 + proj_height_1 + vegtype 2312.743 159.4881535
#7   glm7                   mean_tave06_tave07_tave08 + proj_age_1 + proj_height_1 2319.125 165.8694262
#3   glm3                                mean_tave06_tave07_tave08 + proj_height_1 2319.322 166.0672661
#8   glm8                         mean_tave06_tave07_tave08 + proj_age_1 + vegtype 2326.132 172.8767789
#2   glm2                                   mean_tave06_tave07_tave08 + proj_age_1 2329.669 176.4139646
#5   glm5                                      mean_tave06_tave07_tave08 + vegtype 2495.537 342.2821384
#1   glm1                                                mean_tave06_tave07_tave08 2503.033 349.7775403

```

Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

MS_t2<-MS_t %>% drop_na(live_stand_volume_125, proj_age_1)

glm_best<- glm(fire_pres ~ scale(mean_tave06_tave07_tave08)+
             scale(live_stand_volume_125) +
               scale(proj_age_1) +
               vegtype, 
           data= MS_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


MS_t2$resids<-resid(glm_best)

binnedplot (MS_t2$live_stand_volume_125, 
            MS_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (MS_t2$mean_tave06_tave07_tave08, 
            MS_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))



# Diagnostic plots look ok

##Add to top model table
top_mod_table[12,1]<-"MS"
top_mod_table[12,2]<-"Y"
top_mod_table[12,3]<-"fire_pres ~ mean_tave06_tave07_tave08 + live_stand_volume_125 + proj_age_1 + vegtype"
top_mod_table[12,4]<- coef(glm_best)[1] #Intercept
top_mod_table[12,5]<- coef(glm_best)[2] #climate variable 1
#top_mod_table[12,6]<- coef(glm_best)[3] #climate variable 2 (if applicable)
#top_mod_table[12,7]<- coef(glm_best)[9] #climate variable interaction
#top_mod_table[12,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[12,9]<- coef(glm_best)[3] #live_stand_volume_125
top_mod_table[12,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[12,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[12,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[12,13]<- coef(glm_best)[4] #coefficient vegtypeS
top_mod_table[12,14]<- coef(glm_best)[5] #coefficient vegtypeTB
top_mod_table[12,15]<- coef(glm_best)[6] #coefficient vegtypeTC
top_mod_table[12,16]<- coef(glm_best)[7] #coefficient vegtypeTM
top_mod_table

```







## BEC ZONE PP

```{r PP climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for SBS were mean_tmax07_tmax08
PP<- dat_lightning_ %>%
  filter(zone=="PP")

#Separate by trees and no trees
PP_t<- PP %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
PP_nt<- PP %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(PP_t$vegtype)
table(PP_nt$vegtype)

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(PP_t, aes(mean_tmax05_tmax06, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_tmax05_tmax06") + ylab("Pr (ignition)")
p

hist(PP_t$mean_tmax05_tmax06)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(PP_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(PP_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(PP_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(PP_t$proj_age_1, breaks=30)
hist(PP_t$live_stand_volume_125, breaks=30)

```


## PP treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

glm1<- glm(fire_pres ~ scale(mean_tmax05_tmax06), 
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_tmax05_tmax06"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
             scale(proj_age_1), 
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_tmax05_tmax06 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
             scale(proj_height_1), 
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
             scale(live_stand_volume_125), 
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
             vegtype, # classification of tree type in the VRI 
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
             scale(proj_age_1) + 
             vegtype,
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
           scale(proj_height_1) + 
           vegtype,
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
             scale(live_stand_volume_125) + 
             vegtype,
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ scale(mean_tmax05_tmax06) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= PP_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_tmax05_tmax06 + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.PP<- table.glm
table.glm.PP[order(table.glm.PP$deltaAIC),] 

#Model                                                          Variable      AIC   deltaAIC
#10 glm10              mean_tmax05_tmax06 + live_stand_volume_125 + vegtype 654.2600  0.0000000
#4   glm4                        mean_tmax05_tmax06 + live_stand_volume_125 654.3807  0.1206701
#11 glm11 mean_tmax05_tmax06 + live_stand_volume_125 + proj_age_1 + vegtype 655.7796  1.5196213
#6   glm6            mean_tmax05_tmax06 + live_stand_volume_125 +proj_age_1 655.9487  1.6887108
#2   glm2                                   mean_tmax05_tmax06 + proj_age_1 667.2082 12.9481824
#3   glm3                                mean_tmax05_tmax06 + proj_height_1 667.5180 13.2579662
#7   glm7                   mean_tmax05_tmax06 + proj_age_1 + proj_height_1 669.0634 14.8034331
#8   glm8                         mean_tmax05_tmax06 + proj_age_1 + vegtype 670.8152 16.5552232
#9   glm9                      mean_tmax05_tmax06 + proj_height_1 + vegtype 671.3666 17.1066272
#12 glm12         mean_tmax05_tmax06 + proj_height_1 + proj_age_1 + vegtype 672.7682 18.5082398
#1   glm1                                                mean_tmax05_tmax06 715.9461 61.6861181
#5   glm5                                      mean_tmax05_tmax06 + vegtype 720.3849 66.1249404

```

Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

PP_t2<-PP_t %>% drop_na(live_stand_volume_125)

glm_best<- glm(fire_pres ~ scale(mean_tmax05_tmax06)+
             scale(live_stand_volume_125) +
               vegtype, 
           data= PP_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


PP_t2$resids<-resid(glm_best)

binnedplot (PP_t2$live_stand_volume_125, 
            PP_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (PP_t2$mean_tmax05_tmax06, 
            PP_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


# Diagnostic plots look ok

##Add to top model table
top_mod_table[13,1]<-"PP"
top_mod_table[13,2]<-"Y"
top_mod_table[13,3]<-"fire_pres ~ mean_tmax05_tmax06 + live_stand_volume_125 + vegtype"
top_mod_table[13,4]<- coef(glm_best)[1] #Intercept
top_mod_table[13,5]<- coef(glm_best)[2] #climate variable 1
#top_mod_table[13,6]<- coef(glm_best)[3] #climate variable 2 (if applicable)
#top_mod_table[13,7]<- coef(glm_best)[9] #climate variable interaction
#top_mod_table[13,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[13,9]<- coef(glm_best)[3] #live_stand_volume_125
#top_mod_table[13,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[13,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[13,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[13,13]<- coef(glm_best)[4] #coefficient vegtypeS
#top_mod_table[13,14]<- coef(glm_best)[5] #coefficient vegtypeTB
top_mod_table[13,15]<- coef(glm_best)[4] #coefficient vegtypeTC
top_mod_table[13,16]<- coef(glm_best)[5] #coefficient vegtypeTM
top_mod_table

```






BEC zones still need to do: SWB


## BEC ZONE SWB

```{r SWB climate figure}
# look at the data graphically in this BEC zone

# top climatic variables for SBS were mean_ppt08_ppt09
SWB<- dat_lightning_ %>%
  filter(zone=="SWB")

#Separate by trees and no trees
SWB_t<- SWB %>% dplyr::filter(bclcs_level_2=="T") # treed areas; note, only TC (no TM or TB)
SWB_nt<- SWB %>% dplyr::filter(bclcs_level_2!="T") # not treed
table(SWB_t$vegtype)
table(SWB_nt$vegtype)

# Plotting Probability of ignition versus temp and precipitation.
p <- ggplot(SWB_t, aes(mean_ppt08_ppt09, as.numeric(fire_pres))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("mean_ppt08_ppt09") + ylab("Pr (ignition)")
p

hist(SWB_t$mean_ppt08_ppt09)

# Examining the relationship between some stand level variables. Volume and height are fairly correlated but age and volume are not. However, none of the variables are more correlated than 0.7. So Ill try all combinations
ggscatter(SWB_t, x = "live_stand_volume_125", y = "proj_age_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand age")

ggscatter(SWB_t, x = "live_stand_volume_125", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "live stand volume", ylab = "Stand height")

ggscatter(SWB_t, x = "proj_age_1", y = "proj_height_1", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "proj_age_1", ylab = "Stand height")

hist(SWB_t$proj_age_1, breaks=30)
hist(SWB_t$live_stand_volume_125, breaks=30)

```


## SWB treed statistical model 
```{r BG treed model fits}
################################
#### Fitting statistical models
################################

##Note: if only one level of vegtype exists, then these models cannot be run. In this case, models 5 and 8 through 12 must be commented out, and models 6 and 7 must be altered to models 5 and 6.

glm1<- glm(fire_pres ~ scale(mean_ppt08_ppt09), 
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm1)

table.glm <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (table.glm) <- c ("Model", "Variable", "AIC")
table.glm[1,1]<-"glm1"
table.glm[1,2]<-"mean_ppt08_ppt09"
table.glm[1,3]<-AICc(glm1)

glm2<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(proj_age_1), 
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm2)
i=2
table.glm[i,1]<-"glm2"
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_age_1"
table.glm[i,3]<-AICc(glm2)


glm3<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(proj_height_1), 
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm3)
i=3
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_height_1"
table.glm[i,3]<-AICc(glm3)

glm4<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(live_stand_volume_125), 
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm4)
i=4
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + live_stand_volume_125"
table.glm[i,3]<-AICc(glm4)

glm5<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             vegtype, # classification of tree type in the VRI 
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm5)
i=5
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + vegtype"
table.glm[i,3]<-AICc(glm5)

glm6<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(live_stand_volume_125) + 
             scale(proj_age_1),
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm6)
i=6
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + live_stand_volume_125 +proj_age_1"
table.glm[i,3]<-AICc(glm6)

glm7<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(proj_age_1) + 
             scale(proj_height_1),
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm7)
i=7
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_age_1 + proj_height_1"
table.glm[i,3]<-AICc(glm7)

glm8<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(proj_age_1) + 
             vegtype,
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm8)
i=8
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm8)

glm9<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
           scale(proj_height_1) + 
           vegtype,
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm9)
i=9
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_height_1 + vegtype"
table.glm[i,3]<-AICc(glm9)

glm10<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(live_stand_volume_125) + 
             vegtype,
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm10)
i=10
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + live_stand_volume_125 + vegtype"
table.glm[i,3]<-AICc(glm10)

glm11<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
             scale(live_stand_volume_125) + 
              scale(proj_age_1) +
             vegtype,
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm11)
i=11
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + live_stand_volume_125 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm11)

glm12<- glm(fire_pres ~ scale(mean_ppt08_ppt09) +
              scale(proj_height_1) +
              scale(proj_age_1) +
             vegtype,
           data= SWB_t,
           family = binomial,
           na.action=na.omit)
summary(glm12)
i=12
table.glm[i,1]<-paste0("glm",i)
table.glm[i,2]<-"mean_ppt08_ppt09 + proj_height_1 + proj_age_1 + vegtype"
table.glm[i,3]<-AICc(glm12)


table.glm$deltaAIC<- table.glm$AIC-min(table.glm$AIC)

table.glm.SWB<- table.glm
table.glm.SWB[order(table.glm.SWB$deltaAIC),] 

#Model                                                        Variable      AIC   deltaAIC
#6   glm6            mean_ppt08_ppt09 + live_stand_volume_125 +proj_age_1 161.9424  0.0000000
#4   glm4                        mean_ppt08_ppt09 + live_stand_volume_125 162.2117  0.2693224
#10 glm10              mean_ppt08_ppt09 + live_stand_volume_125 + vegtype 162.6238  0.6814437
#11 glm11 mean_ppt08_ppt09 + live_stand_volume_125 + proj_age_1 + vegtype 163.5823  1.6398883
#9   glm9                      mean_ppt08_ppt09 + proj_height_1 + vegtype 194.1706 32.2282507
#7   glm7                   mean_ppt08_ppt09 + proj_age_1 + proj_height_1 194.8174 32.8750438
#3   glm3                                mean_ppt08_ppt09 + proj_height_1 194.8991 32.9567578
#12 glm12         mean_ppt08_ppt09 + proj_height_1 + proj_age_1 + vegtype 195.4663 33.5238680
#2   glm2                                   mean_ppt08_ppt09 + proj_age_1 195.5106 33.5681977
#5   glm5                                      mean_ppt08_ppt09 + vegtype 195.7991 33.8567427
#8   glm8                         mean_ppt08_ppt09 + proj_age_1 + vegtype 196.2433 34.3008879
#1   glm1                                                mean_ppt08_ppt09 197.0064 35.0640439

```

Now inspect the top model from the AIC table and alter below to match.

```{r}
##### TOP MODEL####

SWB_t2<-SWB_t %>% drop_na(live_stand_volume_125, proj_age_1)

glm_best<- glm(fire_pres ~ scale(mean_ppt08_ppt09)+
             scale(live_stand_volume_125) +
               scale(proj_age_1), 
           data= SWB_t2,
           family = binomial,
           na.action=na.omit)

summary(glm_best)

# model diagnostic plots
binnedplot (fitted(glm_best), 
            residuals(glm_best), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = "Binned Residual Plot - glm")


SWB_t2$resids<-resid(glm_best)

binnedplot (SWB_t2$live_stand_volume_125, 
            SWB_t2$resids, 
            nclass = NULL, 
            xlab = "live stand volume", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

binnedplot (SWB_t2$mean_ppt08_ppt09, 
            SWB_t2$resids, 
            nclass = NULL, 
            xlab = "", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))


# Diagnostic plots look ok

##Add to top model table
top_mod_table[14,1]<-"SWB"
top_mod_table[14,2]<-"Y"
top_mod_table[14,3]<-"fire_pres ~ mean_ppt08_ppt09 + live_stand_volume_125 +proj_age_1"
top_mod_table[14,4]<- coef(glm_best)[1] #Intercept
top_mod_table[14,5]<- coef(glm_best)[2] #climate variable 1
#top_mod_table[14,6]<- coef(glm_best)[3] #climate variable 2 (if aSWBlicable)
#top_mod_table[14,7]<- coef(glm_best)[9] #climate variable interaction
#top_mod_table[14,8]<- coef(glm_best)[3] #coef_stand_height
top_mod_table[14,9]<- coef(glm_best)[3] #live_stand_volume_125
top_mod_table[14,10]<- coef(glm_best)[4] #proj_age_1
#top_mod_table[14,11]<- coef(glm_best)[4] #coefficient vegtypeD
#top_mod_table[14,12]<- coef(glm_best)[4] #coefficient vegtypeOP
#top_mod_table[14,13]<- coef(glm_best)[4] #coefficient vegtypeS
#top_mod_table[14,14]<- coef(glm_best)[5] #coefficient vegtypeTB
#top_mod_table[14,15]<- coef(glm_best)[4] #coefficient vegtypeTC
#top_mod_table[14,16]<- coef(glm_best)[5] #coefficient vegtypeTM
top_mod_table

```

Write as a table to save data for top models for all BEC zones, for those with trees. Will need to repeat for areas without trees.

```{r}
write.csv(top_mod_table, file="D:\\Fire\\fire_data\\raw_data\\Top_Models_Treed.csv")

```



```{r}


```{r}