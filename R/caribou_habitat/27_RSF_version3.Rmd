---
title: "Caribou RSF 3.0"
author: "Tyler Muhly"
date: "28/01/2020"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (dplyr)
library (ggcorrplot)
library (ggplot2)
library (lme4)
library (raster)
library (rgdal)
library (arm)
library (car)
library (optimx)
library (dfoptim)
```

## Introduction
Here I create a caribou disturbance model using an RSF framework to develop the model. Purpose is to create a model that links forestry disturbance to cariobu habitat quality. disturabnce avoidance fucntion (DAF)

didn;t try to model other direvers of habtait selection or use; modle is naive to those. Juits truign to ciofucs on distruanbcem efefct. Philosphy here is to focus on distruabcen effect only, not build a habtait model. So this si a 'targeted RSF', nto desinged to accurately idnetify cariobu habtait, just accruately identify the fefcts of forestry on caribou.

RSF's created for each DU. r
Use fucntional repsonse. comapred osme models usign AIC and looked at fxn response fit to dtemrine 'best' model


## Methods
Data from GPS collars across BC, 2008 - 2018;  no capture info, but assume mostly females. (add these detials)

Calcualted annual home rnages usign kernbel density to defien 'available sample' (add these detials)

average size of hiomre nrages, bu DU = 

RSF with GLMM appraoch, with random effects, random effect for season,herd and animal


### Prepare data
Load data 

create fxn response covariate by takign average value for each covariet in each aniamls seasonal HR
data orginally broekn down by season (early witner, late wirnter, summer); took average across season as 'available' sapce for aniamls: DU6 = 10,518 ha, DU7 = 12,538 ha, DU8 = 5,836 ha and DU9 = 4,895 ha.


```{r, Load data and transform, echo = F, message = F}
# load data
rsf.data.du6 <- read.csv ("C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\rsf_data_du6.csv")
rsf.data.du7 <- read.csv ("C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\rsf_data_du7.csv")
rsf.data.du8 <- read.csv ("C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\rsf_data_du8.csv")
rsf.data.du9 <- read.csv ("C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\rsf_data_du9.csv")

# Create new covars to deal with corelations, for fxn repsonse 
rsf.data.du6$dist_cut_min_all <- pmin (rsf.data.du6$distance_to_cut_1to4,
                                       rsf.data.du6$distance_to_cut_5to9yo,
                                       rsf.data.du6$distance_to_cut_10yoorOver)

rsf.data.du7 <- dplyr::mutate (rsf.data.du7, 
                               distance_to_cut_over4 = pmin (distance_to_cut_5to9yo, 
                                                             distance_to_cut_10to29yo,
                                                             distance_to_cut_30orOveryo))
rsf.data.du7$dist_cut_min_all <- pmin (rsf.data.du7$distance_to_cut_1to4,
                                       rsf.data.du7$distance_to_cut_over4)

rsf.data.du8 <- rsf.data.du8 %>% # removed outlier locations really far from  (>200km) from cutblocks
                  dplyr::filter (distance_to_cut_30orOveryo < 27500)
rsf.data.du8$dist_cut_min_all <- pmin (rsf.data.du8$distance_to_cut_1to4,
                                       rsf.data.du8$distance_to_cut_5to9yo,
                                       rsf.data.du8$distance_to_cut_10to29yo,
                                       rsf.data.du8$distance_to_cut_30orOveryo)
rsf.data.du9$dist_cut_min_all <- pmin (rsf.data.du9$distance_to_cut_1to4,
                                       rsf.data.du9$distance_to_cut_5to9yo,
                                       rsf.data.du9$distance_to_cut_10to29yo,
                                       rsf.data.du9$distance_to_cut_30orOveryo)

# convert m to km 
rsf.data.du6$distance_to_resource_road <- rsf.data.du6$distance_to_resource_road/1000
rsf.data.du6$distance_to_cut_1to4yo <- rsf.data.du6$distance_to_cut_1to4yo/1000
rsf.data.du6$distance_to_cut_5to9yo <- rsf.data.du6$distance_to_cut_5to9yo/1000
rsf.data.du6$distance_to_cut_10yoorOver <- rsf.data.du6$distance_to_cut_10yoorOver/1000
rsf.data.du6$dist_cut_min_all <- rsf.data.du6$dist_cut_min_all/1000

rsf.data.du7$distance_to_resource_road <- rsf.data.du7$distance_to_resource_road/1000
rsf.data.du7$distance_to_cut_1to4yo <- rsf.data.du7$distance_to_cut_1to4yo/1000
rsf.data.du7$distance_to_cut_over4 <- rsf.data.du7$distance_to_cut_over4/1000
rsf.data.du7$dist_cut_min_all <- rsf.data.du7$dist_cut_min_all/1000

rsf.data.du8$distance_to_resource_road <- rsf.data.du8$distance_to_resource_road/1000
rsf.data.du8$distance_to_cut_1to4yo <- rsf.data.du8$distance_to_cut_1to4yo/1000
rsf.data.du8$distance_to_cut_5to9yo <- rsf.data.du8$distance_to_cut_5to9yo/1000
rsf.data.du8$distance_to_cut_10to29yo <- rsf.data.du8$distance_to_cut_10to29yo/1000
rsf.data.du8$distance_to_cut_30orOveryo <- rsf.data.du8$distance_to_cut_30orOveryo/1000
rsf.data.du8$dist_cut_min_all <- rsf.data.du8$dist_cut_min_all/1000

rsf.data.du9$distance_to_resource_road <- rsf.data.du9$distance_to_resource_road/1000
rsf.data.du9$distance_to_cut_1to4yo <- rsf.data.du9$distance_to_cut_1to4yo/1000
rsf.data.du9$distance_to_cut_5to9yo <- rsf.data.du9$distance_to_cut_5to9yo/1000
rsf.data.du9$dist_cut_min_all <- rsf.data.du9$dist_cut_min_all/1000

# calculate fxn response covars
avail.rsf.data.du6 <- subset (rsf.data.du6, pttype == 0)
dist_res_road_E <- tapply (avail.rsf.data.du6$distance_to_resource_road, 
                                   avail.rsf.data.du6$animal_id, mean)
distance_to_cut_1to4yo_E <- tapply (avail.rsf.data.du6$distance_to_cut_1to4yo, 
                           avail.rsf.data.du6$animal_id, mean)
distance_to_cut_5to9yo_E <- tapply (avail.rsf.data.du6$distance_to_cut_5to9yo, 
                                   avail.rsf.data.du6$animal_id, mean)
distance_to_cut_10yoorOver_E <- tapply (avail.rsf.data.du6$distance_to_cut_10yoorOver, 
                                 avail.rsf.data.du6$animal_id, mean)
dist_cut_min_E <- tapply (avail.rsf.data.du6$dist_cut_min,  
                                  avail.rsf.data.du6$animal_id, mean)
inds <- as.character (rsf.data.du6$animal_id)
rsf.data.du6 <- cbind (rsf.data.du6, "dist_res_road_E" = dist_res_road_E[inds], 
                       "distance_to_cut_1to4yo_E" = distance_to_cut_1to4yo_E[inds],
                       "distance_to_cut_5to9yo_E" = distance_to_cut_5to9yo_E[inds],
                       "distance_to_cut_10yoorOver_E" = distance_to_cut_10yoorOver_E[inds],
                       "dist_cut_min_E" = dist_cut_min_E[inds])

avail.rsf.data.du7 <- subset (rsf.data.du7, pttype == 0)
dist_res_road_E <- tapply (avail.rsf.data.du7$distance_to_resource_road, 
                           avail.rsf.data.du7$animal_id, mean)
distance_to_cut_1to4yo_E <- tapply (avail.rsf.data.du7$distance_to_cut_1to4yo, 
                           avail.rsf.data.du7$animal_id, mean)
distance_to_cut_over4_E <- tapply (avail.rsf.data.du7$distance_to_cut_over4, 
                            avail.rsf.data.du7$animal_id, mean)
dist_cut_min_E <- tapply (avail.rsf.data.du7$dist_cut_min, 
                                  avail.rsf.data.du7$animal_id, mean)
inds <- as.character (rsf.data.du7$animal_id)
rsf.data.du7 <- cbind (rsf.data.du7, 
                       "dist_rd_E" = dist_res_road_E[inds], 
                       "distance_to_cut_1to4yo_E" = distance_to_cut_1to4yo_E[inds],
                       "distance_to_cut_over4_E" = distance_to_cut_over4_E[inds],
                       "dist_cut_min_E" = dist_cut_min_E[inds])


avail.rsf.data.du8 <- subset (rsf.data.du8, pttype == 0)
dist_res_road_E <- tapply (avail.rsf.data.du8$distance_to_resource_road, 
                                   avail.rsf.data.du8$animal_id, mean)
distance_to_cut_1to4yo_E <- tapply (avail.rsf.data.du8$distance_to_cut_1to4yo, 
                                   avail.rsf.data.du8$animal_id, mean)
distance_to_cut_5to9yo_E <- tapply (avail.rsf.data.du8$distance_to_cut_5to9yo, 
                                   avail.rsf.data.du8$animal_id, mean)
distance_to_cut_10to29_E <- tapply (avail.rsf.data.du8$distance_to_cut_10to29yo, 
                                     avail.rsf.data.du8$animal_id, mean)
dist_cut_30_E <- tapply (avail.rsf.data.du8$distance_to_cut_30orOveryo, 
                                 avail.rsf.data.du8$animal_id, mean)
dist_cut_min_E <- tapply (avail.rsf.data.du8$dist_cut_min, 
                          avail.rsf.data.du8$animal_id, mean)
inds <- as.character (rsf.data.du8$animal_id)
rsf.data.du8 <- cbind (rsf.data.du8, "dist_rd_E" = dist_res_road_E[inds], 
                       "distance_to_cut_1to4yo_E" = distance_to_cut_1to4yo_E[inds],
                       "distance_to_cut_5to9yo_E" = distance_to_cut_5to9yo_E[inds],
                       "distance_to_cut_10yoorOverto29_E" = distance_to_cut_10to29_E[inds],
                       "dist_cut_30_E" = dist_cut_30_E[inds],
                       "dist_cut_min_E" = dist_cut_min_E[inds])


avail.rsf.data.du9 <- subset (rsf.data.du9, pttype == 0)
dist_res_road_E <- tapply (avail.rsf.data.du9$distance_to_resource_road, 
                           avail.rsf.data.du9$animal_id, mean)
distance_to_cut_1to4yo_E <- tapply (avail.rsf.data.du9$distance_to_cut_1to4yo, 
                           avail.rsf.data.du9$animal_id, mean)
distance_to_cut_5to9yo_E <- tapply (avail.rsf.data.du9$distance_to_cut_5to9yo, 
                           avail.rsf.data.du9$animal_id, mean)
rsf.data.du9$dist_cut_min_all <- pmin (rsf.data.du9$distance_to_cut_1to4,
                                       rsf.data.du9$distance_to_cut_5to9yo)
inds <- as.character (rsf.data.du9$animal_id)
rsf.data.du9 <- cbind (rsf.data.du9, "dist_rd_E" = dist_res_road_E[inds], 
                       "distance_to_cut_1to4yo_E" = distance_to_cut_1to4yo_E[inds],
                       "distance_to_cut_5to9yo_E" = distance_to_cut_5to9yo_E[inds],
                       "dist_cut_min_E" = dist_cut_min_E[inds])

rsf.data.du6$pttype <- as.factor (rsf.data.du6$pttype)
rsf.data.du7$pttype <- as.factor (rsf.data.du7$pttype)
rsf.data.du8$pttype <- as.factor (rsf.data.du8$pttype)
rsf.data.du9$pttype <- as.factor (rsf.data.du9$pttype)

rm (avail.rsf.data.du6, avail.rsf.data.du7, avail.rsf.data.du8, avail.rsf.data.du9, inds, dist_cut_30_E, dist_cut_min_E, distance_to_cut_10to29_E, distance_to_cut_10yoorOver_E, distance_to_cut_1to4yo_E, dist_res_road_E, distance_to_cut_5to9yo_E, distance_to_cut_over4_E)
gc ()
```

### Analysis by DU
decided DU's shoudl be modeled spewrately because of sificant ecological differences, parrticualrly between borel an moutnain, but wanted to account for pteontail differetn moutanin beahvoiours (different use of low/high elev?)

### DU7
northern mtn, included animals from Itcha-Ilgachuz, Rainbows, Charlotte Alplands, Tweedsmuir, Spatsizi, Pink Mountain, Muskwa, Frog, Chase, Finlay, Graham, Tsenaglode, Telkwa (Table 1).

Ranged from 1 to 35 aniamls and 856 to 41,837 locations by herd. 

```{r, DU7, data sumamry, echo = F, message = F}
# numebr of animals, by herd
count.animals.herd <- rsf.data.du7  %>%
  group_by(HERD_NAME) %>%
  summarise(count = n_distinct(animal_id))

count.locs.herd <- rsf.data.du7  %>%
  group_by(HERD_NAME) %>%
  filter (pttype == 1) %>%
  summarise(count = n())

table <- full_join(count.animals.herd, count.locs.herd, by = "HERD_NAME")

table <- table %>% 
  rename (Herd = HERD_NAME,
          Animals = count.x,
          Locations = count.y)

kable (table,
       caption = "<b>Table 1. Number of Animals and Telemetry Locations Sampled by Caribou Herd in DU7.<b>") %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 

```

#### Herd Effect of Disturbance
show that response to roads and cutbocks varies by herd

possible fucntional repsonse; difernt response dependnign on hoem rnage context, by herd

```{r, DU7 Herd effect plots, echo = F, message = F}

ggplot (rsf.data.du7, 
        aes (x = pttype, y = distance_to_resource_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (title = "Distance to Resource Road at Available (0) and Used (1) Locations",
        x = "Available (0) and Used (1) Locations",
        y = "Distance to Resource Road") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 6))

ggplot (rsf.data.du7, 
        aes (x = pttype, y = dist_cut_min_all)) +
  geom_boxplot (outlier.colour = "red") +
  labs (title = "Distance to Cutblock at Available (0) and Used (1) Locations",
        x = "Available (0) and Used (1) Locations",
        y = "Distance to Cutblock") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 6))

```

#### Season efefct
some differences, include as RE

```{r, DU7 season effect, echo = F, message = F}
ggplot (rsf.data.du7, 
        aes (x = pttype, y = distance_to_resource_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (title = "Distance to Resource Road at Available (0) and Used (1) Locations",
        x = "Available (0) and Used (1) Locations",
        y = "Distance to Resource Road") +
  facet_grid (. ~ season, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8))

ggplot (rsf.data.du7, 
        aes (x = pttype, y = dist_cut_min_all)) +
  geom_boxplot (outlier.colour = "red") +
  labs (title = "Distance to Cutblock at Available (0) and Used (1) Locations",
        x = "Available (0) and Used (1) Locations",
        y = "Distance to Cutblock") +
  facet_grid (. ~ season, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8))

```

#### Fit Models
Fit models with fixed effects including cut + roads with  fucntioanl repsonse adn with RE slope,

fucntional response calcualte at indivual level, i.e., available 'resrouce' calcualted within hoem rnage (coudl also try at herd level model); assumption is thta indivudal in herd will acocutn for herd varaibility (i.e., inidvudlas are rpeseeantiative untis of the herd); still incl RE for slope at herd scale to alow for vaariabiltiy there

looked at fxn reponse predcitons and evaluated visually if clear fxn response; no clear fxn response with cutblcks when incl road fxn responses in models, so only incl road fxn response; 

some high resiudlas at ~16 km form roads. looked at indivudals and no clear pattern (ddfiferen inds, herds, saeasons), so didn;t remove; perhasps males?

```{r, du7 model, echo = F, message = F}
# top model equation
model.lme4.du7.cut.rd.fxn <- glmer (pttype ~ dist_cut_min_all + 
                                        distance_to_resource_road +
                                        dist_rd_E +
                                        distance_to_resource_road*dist_rd_E +
                                        (dist_cut_min_all + distance_to_resource_road || animal_id) +                                         (dist_cut_min_all + distance_to_resource_road || HERD_NAME) +                                         (dist_cut_min_all + distance_to_resource_road || season),
                                  data = rsf.data.du7, 
                                  family = binomial (link = "logit"),
                                  verbose = T) 



model.lme4.du7.cut.rd.fxn.all <- allFit (model.lme4.du7.cut.rd.fxn) # did not converge, ran with many optimizers and got very similar coeffecients, so model considered ok (see hlep ('convergence'))
ss <- summary (model.lme4.du7.cut.rd.fxn.all)
ss$which.OK
ss$fixef



# check residuals
rsf.data.du7$resids <- residuals (model.lme4.du7.cut.rd.fxn, type = "response")
rsf.data.du7$fit <- fitted (model.lme4.du7.cut.rd.fxn)
ggplot (rsf.data.du7, aes (x = fit, y = resids)) +
  geom_point ()
binnedplot (fitted (model.lme4.du7.cut.rd.fxn), 
             residuals(model.lme4.du7.cut.rd.fxn, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "Binned residual plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")
binnedplot (rsf.data.du7$distance_to_resource_road, 
             residuals(model.lme4.du7.cut.rd.fxn, type = "response"), 
             nclass = NULL, 
             xlab = "Distance to Road", 
             ylab = "Average residual", 
             main = "Binned residual plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")
binnedplot (rsf.data.du7$dist_cut_min_all, 
             residuals(model.lme4.du7.cut.rd.fxn, type = "response"), 
             nclass = NULL, 
             xlab = "Distance to Cutblock", 
             ylab = "Average residual", 
             main = "Binned residual plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

# check fxn response
scatter3D (rsf.data.du7$distance_to_resource_road, 
           rsf.data.du7$dist_rd_E,
           (predict (model.lme4.du7.cut.rd.fxn,
                     newdata = rsf.data.du7, 
                     re.form = NA, type = "response")), 
           xlab = "Dist Road",
           ylab = "HR Dist Road", 
           zlab = "Use/Select",
           theta = 15, phi = 20)

# save the top model
save (model.lme4.du7.cut.rd.fxn, 
      file = "C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\Rmodels\\model_du7_top_v3.rda")

# Create table of model coefficients from top model
model.coeffs <- as.data.frame (coef (summary (model.lme4.du7.cut.rd.fxn)))
write.table (model.coeffs, "C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\model_coefficients\\table_du7_model_fixed_coeffs_v3.csv", sep = ",")

# random effects by herd adn season
re_coeffs.herd <- as.data.frame (coef(model.lme4.du7.cut.rd.fxn)$HERD_NAME)
write.table (re_coeffs.herd, "C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\model_coefficients\\table_du7_model_herd_re_coeffs_v3.csv", sep = ",")
re_coeffs.season <- as.data.frame (coef(model.lme4.du7.cut.rd.fxn)$season)
write.table (re_coeffs.season, "C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\model_coefficients\\table_du7_model_season_re_coeffs_v3.csv", sep = ",")

```


### DU8
Central mtn, included animals from Burnt Pine, Kennedy Siding, Moberly, Narraway, Qunittet adn Scott (Table 2).

Ranged from 8 to 57 animals and 5,414 to 65,431 locations by herd. 

```{r, DU8, data summary, echo = F, message = F}
# numebr of animals, by herd
count.animals.herd <- rsf.data.du8  %>%
  group_by(HERD_NAME) %>%
  summarise(count = n_distinct(animal_id))

count.locs.herd <- rsf.data.du8  %>%
  group_by(HERD_NAME) %>%
  filter (pttype == 1) %>%
  summarise(count = n())

table <- full_join(count.animals.herd, count.locs.herd, by = "HERD_NAME")

table <- table %>% 
  rename (Herd = HERD_NAME,
          Animals = count.x,
          Locations = count.y)

kable (table,
       caption = "<b>Table 2. Number of Animals and Telemetry Locations Sampled by Caribou Herd in DU8.<b>") %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 

```

#### Herd Effect of Disturbance
show that response to roads and cutbocks varies by herd

pssobiel fucntional repsonse; difernt response dependnign on hoem rnage context, by herd, e.g., more avodiance of roads in NArrawya and Quintette, no clear efefct in Kennedy Siging or Burnt Pine (note that Burtn Pine now extirpated); avoidance of cutblock in Quintette, but maybe selction in Narraway adn Burtn Pine

```{r, DU8 Herd effect plots, echo = F, message = F}

ggplot (rsf.data.du8, 
        aes (x = pttype, y = distance_to_resource_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (title = "Distance to Resource Road at Available (0) and Used (1) Locations",
        x = "Available (0) and Used (1) Locations",
        y = "Distance to Resource Road") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 6))

ggplot (rsf.data.du8, 
        aes (x = pttype, y = dist_cut_min_all)) +
  geom_boxplot (outlier.colour = "red") +
  labs (title = "Distance to Cutblock at Available (0) and Used (1) Locations",
        x = "Available (0) and Used (1) Locations",
        y = "Distance to Cutblock") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 6))

```

#### Season efefct
maybe some differences in early witner cutblocks adn roads, adn summer roads; include as RE

```{r, DU8 season effect, echo = F, message = F}
ggplot (rsf.data.du8, 
        aes (x = pttype, y = distance_to_resource_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (title = "Distance to Resource Road at Available (0) and Used (1) Locations",
        x = "Available (0) and Used (1) Locations",
        y = "Distance to Resource Road") +
  facet_grid (. ~ season, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8))

ggplot (rsf.data.du8, 
        aes (x = pttype, y = dist_cut_min_all)) +
  geom_boxplot (outlier.colour = "red") +
  labs (title = "Distance to Cutblock at Available (0) and Used (1) Locations",
        x = "Available (0) and Used (1) Locations",
        y = "Distance to Cutblock") +
  facet_grid (. ~ season, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8))

```






#### Fit Models
Fit models with fixed effects including cut + roads with  fucntioanl repsonse adn with RE slope,

fucntional response calcualte at indivual level, i.e., available 'resrouce' calcualted within hoem rnage (coudl also try at herd level model); assumption is thta indivudal in herd will acocutn for herd varaibility (i.e., inidvudlas are rpeseeantiative untis of the herd); still incl RE for slope at herd scale to alow for vaariabiltiy there

looked at fxn reponse predcitons and evaluated visually if clear fxn response; no clear fxn response with cutblcks when incl road fxn responses in models, so only incl road fxn response; 

some high resiudlas at ~16 km form roads. looked at indivudals and no clear pattern (ddfiferen inds, herds, saeasons), so didn;t remove; perhasps males?

```{r, du8 model, echo = F, message = F}

model.lme4.du8.cut.rd <- glmer (pttype ~ distance_to_resource_road + dist_cut_min_all +
                                         (dist_cut_min_all + distance_to_resource_road || season) +
                                         (dist_cut_min_all + distance_to_resource_road|| animal_id) +                                          (dist_cut_min_all + distance_to_resource_road|| HERD_NAME),
                                  data = rsf.data.du8, 
                                  family = binomial (link = "logit"),
                                  verbose = T) 

summary (model.lme4.du8.cut.rd)

# top model equation
model.lme4.du8.cut.rd.fxn2 <- glmer (pttype ~ dist_cut_min_all + 
                                        distance_to_resource_road +
                                        dist_rd_E +
                                        distance_to_resource_road*dist_rd_E +
                                        (dist_cut_min_all || animal_id) + 
                                        (dist_cut_min_all || HERD_NAME) +
                                        (distance_to_resource_road || animal_id) + 
                                        (distance_to_resource_road || HERD_NAME),
                                  data = rsf.data.du8, 
                                  family = binomial (link = "logit"),
                                  verbose = T) 

# check residuals
rsf.data.du8$resids <- residuals (model.lme4.du8.cut.rd, type = "response")
rsf.data.du8$fit <- fitted (model.lme4.du8.cut.rd)
ggplot (rsf.data.du8, aes (x = fit, y = resids)) +
  geom_point ()
binnedplot (fitted (model.lme4.du8.cut.rd), 
             residuals(model.lme4.du8.cut.rd, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "Binned residual plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")
binnedplot (rsf.data.du8$distance_to_resource_road, 
             residuals(model.lme4.du8.cut.rd, type = "response"), 
             nclass = NULL, 
             xlab = "Distance to Road", 
             ylab = "Average residual", 
             main = "Binned residual plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")
binnedplot (rsf.data.du8$dist_cut_min_all, 
             residuals(model.lme4.du8.cut.rd, type = "response"), 
             nclass = NULL, 
             xlab = "Distance to Road", 
             ylab = "Average residual", 
             main = "Binned residual plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

# check fxn response
scatter3D (rsf.data.du8$distance_to_resource_road, 
           rsf.data.du8$dist_rd_E,
           (predict (model.lme4.du8.cut.rd,
                     newdata = rsf.data.du8, 
                     re.form = NA, type = "response")), 
           xlab = "Dist Road",
           ylab = "HR Dist Road", 
           zlab = "Use/Select",
           theta = 15, phi = 20)

# save the top model
save (model.lme4.du8.cut.rd.fxn2, 
      file = "C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\Rmodels\\model_du8_top_v3.rda")

# Create table of model coefficients from top model
model.coeffs <- as.data.frame (coef (summary (model.lme4.du8.cut.rd.fxn2)))
write.table (model.coeffs, "C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\model_coefficients\\table_du8_model_fixed_coeffs_v3.csv", sep = ",")

# random effects by herd
re_coeffs.herd <- as.data.frame (coef(model.lme4.du8.cut.rd.fxn2)$HERD_NAME)
write.table (re_coeffs.herd, "C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\model_coefficients\\table_du8_model_herd_re_coeffs_v3.csv", sep = ",")

```




