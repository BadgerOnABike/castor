---
title: "Huckleberry_Data_analysis"
author: "Cora Skaien"
date: "14/01/2022"
output: html_document
---
<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(data.table)
library(sf)
library(tidyverse)
library(rgeos)
library(cleangeo)
library(dplyr)
library(tidyr)
library(ggplot2)
library(rgdal)
library(keyring)
library(DBI)
library(rgeos)
library(car)
library(rje)
library(caret)
library(pROC)
library(visreg)

source(here::here("R/functions/R_Postgres.R"))
```

##Data sets for what purpose
1. Percent cover huckleberry: cutblock_plots_openings_Huck_ALL_df
2. Other elements huckleberry: cutblock_plots_openings_Huck_ALL_df_Huck (although if use above, NA remove will likely get same result- *should* at least)

3. Percent cover buffaloberry (plant and berries separate), Presence buffaloberry (plant and berries separate): cutblock_plots_openings_Buff_ALL_df

#Overview
This file continues from huckleberry_data_processing_Dec2021, and shows some intitial exploration of the huckleberry data. As of January 14, 2022, the analyses only encompass the huckleberry data from Mowat and Lamb due to missing data in the BEC data for % sand, DEM (which can be easily acquired), pH, and other environmental variables that have been shown to be crucial for huckleberry P/A, cover and huckleberry fruit P/A and cover. These variables will need to be appended to that data before it can be included into the analyses for percent cover; note, this data may wish to not be included for P/A models as we only selected presence data, and thus have no complimenting absence data, and the number of presences will likely overwhelm the models.

#Additional processing needed for BEC data:
1. Determine timing of harvested and burning to determine origin age of stand and time since fire and harvest
2. DEM --> Although BEC data has aspect and slope indicated for some point within area from RESULTS tab
3. % Sand (TSAND)
4. pH
5. ClimateBC data (Tave_wt, PAS)
6. Land Cover Type (MODIS_LC)
7. Canopy Cover - but investigate what StrataCove, StrataCo_1...3 are.


All of the NAs by oerigin (burn/harvest) for huckleberry cover are from the BEC dara, and we can see that the percent cover is much smaller on average. Clarify what size of plots were assessed by Clayton, and if these data can even be comparable.

#Begin Exploration of variables
```{r}
head(cutblock_plots_openings_Huck_ALL_df_Huck)
table(cutblock_plots_openings_Huck_ALL_df_Huck$Fruit.Present) #206 absences, 319 presences
table(cutblock_plots_openings_Huck_ALL_df_Huck$Species.Present) #135 absences, 455 presences

table(cutblock_plots_openings_Huck_ALL_df$Fruit.Present) #206 absences, 319 presences
table(cutblock_plots_openings_Huck_ALL_df$Species.Present) #135 absences, 2141 presences --> decide if this is a problem or not

table(cutblock_plots_openings_Huck_ALL_df$Species.y) 

```

## Looking at DN1_DIS_CD (DENUDATION_1_DISTURBANCE_CODE) between openings and openings + activity files
```{r}
#See if worth losing the data points - i.e., do we have consistent good data within this.
head(cutblock_plots_openings_Huck_ALL_df)
table(cutblock_plots_openings_Huck_ALL_df_Huck$G_BGC_ZONE) #BEC Zone: ESSF, ICH, MS, SBS
table(cutblock_plots_openings_Huck_ALL_df$G_BGC_ZONE) #BEC Zone: ESSF, ICH, MS, SBS; plus CWH, IDF, MH, SBPS
hist(cutblock_plots_openings_Huck_ALL_df$OPEN_GRSAR) #total area the opening encompasses
table(cutblock_plots_openings_Huck_ALL_df$DN1_DIS_CD) # 23 B (burned wildfire); 2193 logged (L); 16 P (pest); 37 S (Salvage); 3 W (windthrow); 636 total
table(cutblock_plots_openings_Huck_ALL_df$DN2_DIS_CD) #Additional elements; 133 total

#Create an ifelse statement to get a new category in case there are any DSN1s with NAs taht have a DSN2 input
cutblock_plots_openings_Huck_ALL_df$DN1_2_DIS_CD<- ifelse (is.na(cutblock_plots_openings_Huck_ALL_df$DN1_DIS_CD), cutblock_plots_openings_Huck_ALL_df$DN2_DIS_CD, cutblock_plots_openings_Huck_ALL_df$DN1_DIS_CD)
table(cutblock_plots_openings_Huck_ALL_df$DN1_2_DIS_CD)# 636; same as initial, so no improvement
```

#Inspect DN1_SILSYS (DENUDATION_1_SILV_SYSTEM_CODE)
```{r}
table(cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS) #626 CCRES (Clearcut with reserves); 953 Clearcut; spattering of others; 
table(cutblock_plots_openings_Huck_ALL_df$DN2_SILSYS)
#Do same as above to see if can get additional data inputs
cutblock_plots_openings_Huck_ALL_df$DN1_2_SILSYS<- ifelse (is.na(cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS), cutblock_plots_openings_Huck_ALL_df$DN2_SILSYS, cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS)
table(cutblock_plots_openings_Huck_ALL_df$DN1_2_SILSYS)#No improvement, and names now turned to numbers?
```

#Investigate other categories
```{r}
table(cutblock_plots_openings_Huck_ALL_df$DN1_SILVAR) # Not many records; not useful
table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH) # 594 BU (burn), 657 ME (mechanical), others;
table(cutblock_plots_openings_Huck_ALL_df$PREP2_TECH)
#Same as above
cutblock_plots_openings_Huck_ALL_df$PREP1_TECH<-as.factor(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH)
cutblock_plots_openings_Huck_ALL_df$PREP2_TECH<-as.factor(cutblock_plots_openings_Huck_ALL_df$PREP2_TECH)
cutblock_plots_openings_Huck_ALL_df$PREP1_2_TECH<- ifelse (is.na(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH), cutblock_plots_openings_Huck_ALL_df$PREP2_TECH, cutblock_plots_openings_Huck_ALL_df$PREP1_TECH)
table(cutblock_plots_openings_Huck_ALL_df$PREP1_2_TECH)# 516; get two additional one, but names messed up (become numbers)
```


```{r}
cutblock_plots_openings_Huck_ALL_df$PREP1_2<-paste(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH,cutblock_plots_openings_Huck_ALL_df$PREP2_TECH)
table(cutblock_plots_openings_Huck_ALL_df$PREP1_2) #336 records of NA, lots of combinations otherwise. Maybe make a column that is yes/no for each technique that is considered important? We see that the 2 in above that we gain are the "NA GS" here. We also see that some were burned first and then had mechanical treatment (50), and some had mechanical treatment and then were burned (57)

cutblock_plots_openings_Huck_ALL_df$PREP1_2<-as.factor(cutblock_plots_openings_Huck_ALL_df$PREP1_2)
cutblock_plots_openings_Huck_ALL_df$PREP1_TECH<-as.factor(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH)

table(cutblock_plots_openings_Huck_ALL_df$PREP1_2)

##All 3 of the ifelse statements below get the same result
cutblock_plots_openings_Huck_ALL_df$PREP_TECH <- ifelse (cutblock_plots_openings_Huck_ALL_df$PREP1_2 == "BU ME", cutblock_plots_openings_Huck_ALL_df$PREP1_2, ifelse (cutblock_plots_openings_Huck_ALL_df$PREP1_2 == "ME BU", cutblock_plots_openings_Huck_ALL_df$PREP1_2, cutblock_plots_openings_Huck_ALL_df$PREP1_TECH))

cutblock_plots_openings_Huck_ALL_df$PREP_TECH <- ifelse ((cutblock_plots_openings_Huck_ALL_df$PREP1_2 == "BU ME" | cutblock_plots_openings_Huck_ALL_df$PREP1_2 == "ME BU"), cutblock_plots_openings_Huck_ALL_df$PREP1_2, cutblock_plots_openings_Huck_ALL_df$PREP1_TECH)
cutblock_plots_openings_Huck_ALL_df$PREP_TECH <- ifelse ((cutblock_plots_openings_Huck_ALL_df$PREP1_2 == "ME BU" | cutblock_plots_openings_Huck_ALL_df$PREP1_2 == "BU ME"), cutblock_plots_openings_Huck_ALL_df$PREP1_2, cutblock_plots_openings_Huck_ALL_df$PREP1_TECH) #get same result if change order of names
table(cutblock_plots_openings_Huck_ALL_df$PREP_TECH)
table(cutblock_plots_openings_Huck_ALL_df$PREP2_TECH)
table(cutblock_plots_openings_Huck_ALL_df$PREP1_2)
table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH)
table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df$PREP_TECH) #1 = BU; 2=CA; 3=CG; 4=GS; 5=MA; 6=ME; 7=BI; 24=?? NA? 
table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df$PREP1_2)

cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2<-paste(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df$PREP_TECH)
table(cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2) #This helps fix the weird error above; n = 641 

```

Create additional columns that indicate whether burning happened and whether mechanical application happened.

```{r}
cutblock_plots_openings_Huck_ALL_df$PREP_BU <- ifelse ((cutblock_plots_openings_Huck_ALL_df$PREP1_TECH == "BU" | cutblock_plots_openings_Huck_ALL_df$PREP2_TECH == "BU"), 1, 0)
table(cutblock_plots_openings_Huck_ALL_df$PREP_BU) #There should be a LOT more data here - lots of NAs
table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH)
table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df$PREP_BU)
cutblock_plots_openings_Huck_ALL_df$PREP_BU # A lot of NAs: turn to 0s
cutblock_plots_openings_Huck_ALL_df$PREP_BU[is.na(cutblock_plots_openings_Huck_ALL_df$PREP_BU)]<-0
table(cutblock_plots_openings_Huck_ALL_df$PREP_BU) #This looks better, but keep in mind that some that had no info may have had treatments not listed


```

Repeat for mechanical.

```{r}
cutblock_plots_openings_Huck_ALL_df$PREP_ME <- ifelse ((cutblock_plots_openings_Huck_ALL_df$PREP1_TECH == "ME" | cutblock_plots_openings_Huck_ALL_df$PREP2_TECH == "ME"), 1, 0)
table(cutblock_plots_openings_Huck_ALL_df$PREP_ME) #There should be a LOT more data here
table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH)
table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df$PREP_ME)
cutblock_plots_openings_Huck_ALL_df$PREP_ME # A lot of NAs: turn to 0s
cutblock_plots_openings_Huck_ALL_df$PREP_ME[is.na(cutblock_plots_openings_Huck_ALL_df$PREP_ME)]<-0
table(cutblock_plots_openings_Huck_ALL_df$PREP_ME) #This looks better, MEt keep in mind that some that had no info may have had treatments not listed
```


```{r}
table(cutblock_plots_openings_Huck_ALL_df$BRSH1_TECH) #Brushing technique; 428 MA (manual); 69 CG (Chemical Ground); 51 CA (Chemical Air); and others
table(cutblock_plots_openings_Huck_ALL_df$PLNT1_TECH) #Mostly PL (planting). DO NAs mean no planting? Or unknown?
cutblock_plots_openings_Huck_ALL_df$PLNT1_TECH
table(cutblock_plots_openings_Huck_ALL_df$PLNT2_TECH)
cutblock_plots_openings_Huck_ALL_df$PLNT1_2_TECH<-paste(cutblock_plots_openings_Huck_ALL_df$PLNT1_TECH, cutblock_plots_openings_Huck_ALL_df$PLNT2_TECH)
table(cutblock_plots_openings_Huck_ALL_df$PLNT1_2_TECH)
cutblock_plots_openings_Huck_ALL_df$PLNT1_2_TECH<-as.factor(cutblock_plots_openings_Huck_ALL_df$PLNT1_2_TECH)

cutblock_plots_openings_Huck_ALL_df$PLANTED<- ifelse (cutblock_plots_openings_Huck_ALL_df$PLNT1_2_TECH=="NA NA", 0, 1)
table(cutblock_plots_openings_Huck_ALL_df$PLANTED) #391 not planted, and 1896 with some kind of planting. Very uneven sample size.

```


```{r}
hist(cutblock_plots_openings_Huck_ALL_df$FEAT_AREA)
hist(cutblock_plots_openings_Huck_ALL_df$PLNT1_AREA) #Also has a Plant2, so could add together for total planting area?
hist(cutblock_plots_openings_Huck_ALL_df$PLNT2_AREA)
cutblock_plots_openings_Huck_ALL_df$TOTAL_plant_area<-cutblock_plots_openings_Huck_ALL_df$PLNT1_AREA+cutblock_plots_openings_Huck_ALL_df$PLNT2_AREA
cutblock_plots_openings_Huck_ALL_df$TOTAL_plant_area
cutblock_plots_openings_Huck_ALL_df$TOTAL_plant_area[is.na(cutblock_plots_openings_Huck_ALL_df$TOTAL_plant_area)]<-0
cutblock_plots_openings_Huck_ALL_df$TOTAL_plant_area # We will assume an absence is indicative of no planting
hist(cutblock_plots_openings_Huck_ALL_df$TOTAL_plant_area)

cutblock_plots_openings_Huck_ALL_df$PLANTING<-ifelse (cutblock_plots_openings_Huck_ALL_df$TOTAL_plant_area==0, 0, 1)
table(cutblock_plots_openings_Huck_ALL_df$PLANTING) # We see that this is far different than the data for whether planted or not, suggesting that not all planted sites have planting density. These are NOT true 0s and this data can only be used for locations where we know planting occurred.
#Compare to:
table(cutblock_plots_openings_Huck_ALL_df$PLANTED)

```


```{r}
table(cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS) #May wish to group the smaller groups into an "other" category
cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS_GP<-cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS
cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS_GP <- recode_factor(cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS_GP, CCRES = "CCRES", CLEAR = "CLEAR", IMCUT  = "Other", PATCT = "Other", RETEN= "Other", SEEDT = "Other", SELEC = "Other", SHELT = "Other")
table(cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS_GP)

table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH) #May wish to combine smaller groups into "other"
cutblock_plots_openings_Huck_ALL_df$PREP1_TECH_GP<-cutblock_plots_openings_Huck_ALL_df$PREP1_TECH
cutblock_plots_openings_Huck_ALL_df$PREP1_TECH_GP <- recode_factor(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH_GP, BU="BU", CA="Other",CG="Other",GS="Other",MA="Other",ME="ME", "BI"="Other")
table(cutblock_plots_openings_Huck_ALL_df$PREP1_TECH_GP)
```

NEED TO UPDATE BELOW CODE CHUNK!
```{r}
#Can also use new category instead
##NEEDS UPDATING BELOW
table(cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2) #May wish to combine smaller groups into "other"
cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2_GP<-cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2
cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2_GP <- recode_factor(cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2_GP, "BU 1"="BU", "CA 2"="Other","CG 3"="Other","GS 4"="Other","MA 5"="Other","ME 6"="ME", "BU 5"="BU ME", "ME 16"="ME BU", "NA NA"="NA", "ME 24" ="", "BU 6"="", "BI 7" =="")
table(cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2_GP)

table(cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2_GP, cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS_GP) #Not all "other" paired between categories. Good.
```

#Error in below now... check and fix
```{r}
##May need to combine BU ME and ME BU later.

table(cutblock_plots_openings_Huck_ALL_df$PREP_BU) #1533 no, 754 yes
table(cutblock_plots_openings_Huck_ALL_df$PREP_ME) #1501 no, 786 yes

#Compare above with data
table(cutblock_plots_openings_Huck_ALL_df$Species.Present) #135 absent, 455 present; ignores BEC plots because only presences there
table(cutblock_plots_openings_Huck_ALL_df$Species.Present, cutblock_plots_openings_Huck_ALL_df$PREP_TECH_2_GP) #Definitely a smaller sample size; must be a lot of NAs --> only 383 datapoints accounted for here if eliminate NAs; BU = burn; ME = mechanical
table(cutblock_plots_openings_Huck_ALL_df$Species.Present, cutblock_plots_openings_Huck_ALL_df$DN1_SILSYS_GP) #Only 475 datapoints accounted for here. CCRES = Clearcut with reserves; CLEAR = clearcut

```

Because some of these clearcuts subsequently had fire come through, we must create a new variable that accounts for if fire occurred after but before sampling.

```{r}
# make a new variable that is "origin"
cutblock_plots_openings_Huck_ALL_df$origin <- ifelse ((cutblock_plots_openings_Huck_ALL_df$CutBlock_Occurrence == 1 & cutblock_plots_openings_Huck_ALL_df$TimeSinceCut < cutblock_plots_openings_Huck_ALL_df$TimeSinceFire), 1, ifelse ((cutblock_plots_openings_Huck_ALL_df$Fire_Occ == 1 & cutblock_plots_openings_Huck_ALL_df$TimeSinceCut > cutblock_plots_openings_Huck_ALL_df$TimeSinceFire), 2, 0))
cutblock_plots_openings_Huck_ALL_df$origin <- as.factor (cutblock_plots_openings_Huck_ALL_df$origin)

table(cutblock_plots_openings_Huck_ALL_df$origin) # 1 = most recently logged; 2 = fire after logging. 0 is when harvesting and burning occurred in the same year.

# make a new variable that is age of stands of known origin
cutblock_plots_openings_Huck_ALL_df$origin.age <- ifelse ((cutblock_plots_openings_Huck_ALL_df$origin == 1), cutblock_plots_openings_Huck_ALL_df$TimeSinceCut, ifelse ((cutblock_plots_openings_Huck_ALL_df$origin == 2), cutblock_plots_openings_Huck_ALL_df$TimeSinceFire, ifelse ((cutblock_plots_openings_Huck_ALL_df$origin == 0), cutblock_plots_openings_Huck_ALL_df$TimeSinceFire, NA)))


table(cutblock_plots_openings_Huck_ALL_df$origin)

```

Visualize differences by categories.

```{r}
cutblock_plots_openings_Huck_ALL_df$Species.Present2 <- as.factor (cutblock_plots_openings_Huck_ALL_df$Species.Present)

cutblock_plots_openings_Huck_ALL_df$Species.Present
cutblock_plots_openings_Huck_ALL_df2 <-  subset(cutblock_plots_openings_Huck_ALL_df, cutblock_plots_openings_Huck_ALL_df$Species.Present2!="NA")
table(cutblock_plots_openings_Huck_ALL_df2$Species.Present2) #135 absences and 2141 present

ggplot (cutblock_plots_openings_Huck_ALL_df2, aes (x = Species.Present2, fill = origin)) + 
  geom_bar (position = "fill") +
  scale_fill_discrete (name = "Stand Origin", labels = c("Burned and Harvested", "Harvested", "Burned")) #Most data points are in harvested stands. Those that were burned since harvesting may have more presences? But very unequal sample sizes.
```

##We see in above figure that if we include the BEC data, we need to determine information on when those plots were burned and harvested, as they are all presences and all NAs currently.

Assess for fruit Presence/Absence.

```{r}
cutblock_plots_openings_Huck_ALL_df$Fruit.Present2 <- as.factor (cutblock_plots_openings_Huck_ALL_df$Fruit.Present)
cutblock_plots_openings_Huck_ALL_df$Fruit.Present2
cutblock_plots_openings_Huck_ALL_df3 <-  subset(cutblock_plots_openings_Huck_ALL_df, cutblock_plots_openings_Huck_ALL_df$Fruit.Present2!="NA")
cutblock_plots_openings_Huck_ALL_df3$Fruit.Present2

ggplot (cutblock_plots_openings_Huck_ALL_df3, aes (x = Fruit.Present, fill = origin)) + 
geom_bar (position = "fill") +
  scale_fill_discrete (name = "Stand Origin", labels = c("Burned and Harvested", "Harvested", "Burned")) #Unequal sample sizes, but areas burned and harvested might have more fruit.
```

Assess the percent cover of huckleberry by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2, aes (x = origin, y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "Harvest Fire Same Year (0), Harvest Origin (1) and Fire Origin (2) Stands",
        y = "Huckleberry Cover")

#Cover appears to be highest in stands that burned, then that were harvested, and then that had both in the same year.
```

#All of the NAs in the above are from the BEC dara, and we can see that the percent cover is much smaller on average. Clarify what size of plots were assessed by Clayton, and if these data can even be comparable.

Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2, aes (x = origin, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "Unknown Origin (0), Harvest Origin (1) and Fire Origin (2) Stands",
        y = "Huckleberry Fruit Abundance")

#Reverse pattern as last: highest in burned and harvested in same year, then harvest, then burned.
```
Assess for differences in stand age by category.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2, aes (x = origin, y = origin.age)) +
  geom_boxplot () +
  labs (x = "Harvest Origin (1) and Fire Origin (2) Stands",
        y = "Stand Age")

#Those burned and harvested in same year WAY older. Perhaps remove these. Other two categories (harvested, burned) more similar ins tand age but means differ.
```
Let's remove the category 0 given dramatic difference in years.

```{r}
table(cutblock_plots_openings_Huck_ALL_df2$origin)
cutblock_plots_openings_Huck_ALL_df2b<-subset(cutblock_plots_openings_Huck_ALL_df2, cutblock_plots_openings_Huck_ALL_df2$origin!="0")
table(cutblock_plots_openings_Huck_ALL_df2b$origin) #556 harvested most recently, 23 burned since harvested. Small sample size for those burned since harvested. But seems important. See if can find patterns with it or not.
table(cutblock_plots_openings_Huck_ALL_df2b$PREP_TECH_2_GP)

```

Compare area in hectares between plots with and without.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Species.Present2, y = AREAHA)) +
  geom_boxplot () +
  labs (x = "No Huckleberry (0) and Huckleberry Detected (1) Stands",
        y = "Area (HA)")
#Difficult to see any differences.
```

Compare age of stand for if huckleberry detected.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2, aes (x = Species.Present2, y = origin.age)) +
  geom_boxplot () +
  labs (x = "No Huckleberry (0) and Huckleberry Detected (1) Stands",
        y = "Stand Age")

#Huckleberry maybe slightly more detected in slightly older stands

ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Species.Present2, y = origin.age)) +
  geom_boxplot () +
  labs (x = "No Huckleberry (0) and Huckleberry Detected (1) Stands",
        y = "Stand Age")
#Pattern stronger for huckleberry to be detected in older stands. May be a hump shaped distribution that is not being captured.

```
Assess age between burned and harvested plots with and without.

```{r}
supp.labs <- c("Harvest", "Fire")
names(supp.labs) <- c(1, 2)
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Species.Present2, y = origin.age)) +
  geom_boxplot () +
  labs (x = "No Huckleberry (0) and Huckleberry Detected (1) Stands",
        y = "Stand Age") +
  facet_grid (cols = vars(origin),
              labeller = labeller (origin = supp.labs))

#More likely to occur in stands with fire since harvested at a younger age, and more likely to occur in older stands if harvested.
```

#Repeat using PREP_BU

```{r}
cutblock_plots_openings_Huck_ALL_df2b$PREP_BU_<-as.factor(cutblock_plots_openings_Huck_ALL_df2b$PREP_BU)

ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Species.Present2, fill = PREP_BU_)) + 
  geom_bar (position = "fill") +
  scale_fill_discrete (name = "Burned or Not", labels = c("Not Burned", "Burned")) 
#More common in burned
```

Assess for fruit Presence/Absence.

```{r}
cutblock_plots_openings_Huck_ALL_df$Fruit.Present2 <- as.factor (cutblock_plots_openings_Huck_ALL_df$Fruit.Present)
cutblock_plots_openings_Huck_ALL_df$PREP_BU_ <- as.factor (cutblock_plots_openings_Huck_ALL_df$PREP_BU)
cutblock_plots_openings_Huck_ALL_df3 <-  subset(cutblock_plots_openings_Huck_ALL_df, cutblock_plots_openings_Huck_ALL_df$Fruit.Present2!="NA")
cutblock_plots_openings_Huck_ALL_df3$Fruit.Present2

ggplot (cutblock_plots_openings_Huck_ALL_df3, aes (x = Fruit.Present, fill = PREP_BU_)) + 
geom_bar (position = "fill") +
  scale_fill_discrete (name = "Stand Origin", labels = c("Not Burned", "Burned")) 
#No differences
```

Assess the percent cover of huckleberry.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_BU_, y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "Not Burned (0), Burned(1)",
        y = "Huckleberry Cover")

#Maybe slightly higher in burned.
```
Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_BU_, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "Not Burned (0), Burned(1)",
        y = "Huckleberry Fruit Abundance")

#Not a huge difference
```
Assess for differences in stand age by category.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_BU_, y = origin.age)) +
  geom_boxplot () +
  labs (x = "Not Burned (0), Burned(1)",
        y = "Stand Age")

#Stand age is greater in burned areas.
```

#Repeat for Mechanical treatment
#using PREP_ME


```{r}
cutblock_plots_openings_Huck_ALL_df2b$PREP_ME_<-as.factor(cutblock_plots_openings_Huck_ALL_df2b$PREP_ME)

ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Species.Present2, fill = PREP_ME_)) + 
  geom_bar (position = "fill") +
  scale_fill_discrete (name = "Mechanical Treatment or Not", labels = c("No Mechanical TR", "Mechanical TR")) 
#More common in those with mechanical treatment; are the labels backwards since differ from next figure?
```

Assess for fruit Presence/Absence.

```{r}
cutblock_plots_openings_Huck_ALL_df$Fruit.Present2 <- as.factor (cutblock_plots_openings_Huck_ALL_df$Fruit.Present)
cutblock_plots_openings_Huck_ALL_df$PREP_ME_ <- as.factor (cutblock_plots_openings_Huck_ALL_df$PREP_ME)
cutblock_plots_openings_Huck_ALL_df3 <-  subset(cutblock_plots_openings_Huck_ALL_df, cutblock_plots_openings_Huck_ALL_df$Fruit.Present2!="NA")
cutblock_plots_openings_Huck_ALL_df3$Fruit.Present2

ggplot (cutblock_plots_openings_Huck_ALL_df3, aes (x = Fruit.Present, fill = PREP_ME_)) + 
geom_bar (position = "fill") +
  scale_fill_discrete (name = "Treatment", labels = c("No Mechanical TR", "Mechanical TR")) #Less common with mechanical treatment
```

Assess the percent cover of huckleberry by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_ME_, y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "No Mechanical TR (0), Mechanical TR (1)",
        y = "Huckleberry Cover")

#Similar; maybe slightly higher in ME
```
Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_ME_, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "No Mechanical TR (0), Mechanical TR (1)",
        y = "Huckleberry Fruit Abundance")

#Lower with ME
```
Assess for differences in stand age by category.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_ME_, y = origin.age)) +
  geom_boxplot () +
  labs (x = "No Mechanical TR (0), Mechanical TR (1)",
        y = "Stand Age")

#Stand age is similar for both with and without.
```

```{r}
cutblock_plots_openings_Huck_ALL_df2b$PREP_BU_ME<-paste(cutblock_plots_openings_Huck_ALL_df2b$PREP_BU_, cutblock_plots_openings_Huck_ALL_df2b$PREP_ME_)
str(cutblock_plots_openings_Huck_ALL_df2b$PREP_BU_ME)
cutblock_plots_openings_Huck_ALL_df2b$PREP_BU_ME<-as.factor(cutblock_plots_openings_Huck_ALL_df2b$PREP_BU_ME)

ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = TimeSinceCut, y = Species.Cover, colour = factor(PREP_BU_ME))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Cover Across stand Ages",
        x = "Stand Age (years)",
        y = "Species Cover (%)")  +
  scale_colour_discrete (name = "Stand Origin", labels = c("No Burn No Mechanical", "Mechanical", "Burn", "Burn and Mechanical"))

#Burn peaks at 15 years, with a second peak at 35 years; burn and mechanical peaks at 10 years and lowest at 30 years; mechanical peaked at 5 years; no burn and no mechanical peaked at 35 years before data too sparse
```


Repeat the above plots for site prep and other harvest treatments (PREP1_TECH_GP, PREP_TECH_2_GP,  DN1_SILSYS_GP).

Visualize differences by categories DN1_SILSYS_GP

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Species.Present2, fill = DN1_SILSYS_GP)) + 
  geom_bar (position = "fill") +
  scale_fill_discrete (name = "Clearcut Technique") 
#More likely to occur in sites with clearcuts as opposed to clearcuts with reserves.
```
Assess for fruit Presence/Absence.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df3, aes (x = Fruit.Present, fill = DN1_SILSYS_GP)) + 
geom_bar (position = "fill") +
  scale_fill_discrete (name = "Clearcut Technique")
#Fruit presence most common in clearcuts.
```
Assess the percent cover of huckleberry by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = DN1_SILSYS_GP, y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "Clearcut Technique",
        y = "Huckleberry Cover")

#Cover appears to be similar for all categories.
```
Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = DN1_SILSYS_GP, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "Clearcut Technique",
        y = "Huckleberry Fruit Abundance")

#Appears highest in other site clearcut types, then clearcut > clearcut with reserves
```
Assess for differences in stand age by category.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = DN1_SILSYS_GP, y = origin.age)) +
  geom_boxplot () +
  labs (x = "Clearcut Technique",
        y = "Stand Age")

#Clearcut with reserves are younger than clearcuts and other.
```


Repeat the above plots for site prep and other harvest treatments (PREP1_TECH_GP, PREP_TECH_2_GP,  DN1_SILSYS_GP).

Visualize differences by categories PREP_TECH_2_GP

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Species.Present2, fill = PREP_TECH_2_GP)) + 
  geom_bar (position = "fill") +
  scale_fill_discrete (name = "Site Prep Technique") 
#Largest difference with category NA... may need to make proper NA as it is reading it as a category. Could call it unknown or remove these points.
```
Assess for fruit Presence/Absence.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df3, aes (x = Fruit.Present, fill = PREP_TECH_2_GP)) + 
geom_bar (position = "fill") +
  scale_fill_discrete (name = "Site Prep Technique")
#No major differences
```
Assess the percent cover of huckleberry by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_TECH_2_GP, y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "Site Prep Technique",
        y = "Huckleberry Cover")

#Cover appears to be similar for all categories.
```
Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_TECH_2_GP, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "Site Prep Technique",
        y = "Huckleberry Fruit Abundance")

#Lots of variation. May be too many groups to divide data into. If burned first or only burned, might be higher.
```
Assess for differences in stand age by category.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_TECH_2_GP, y = origin.age)) +
  geom_boxplot () +
  labs (x = "Site Prep Technique",
        y = "Stand Age")

#Similar but Other, ME and unknown lower than other 3 categories.
```


Repeat the above plots for site prep and other harvest treatments (PREP1_TECH_GP, DN1_SILSYS_GP).

Visualize differences by categories PREP1_TECH_GP

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Species.Present2, fill = PREP1_TECH_GP)) + 
  geom_bar (position = "fill") +
  scale_fill_discrete (name = "Site Prep Technique") 
#If burning used in site prep, more likely to occur. Definitely a lot of NAs though too.
```
Assess for fruit Presence/Absence.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df3, aes (x = Fruit.Present, fill = PREP1_TECH_GP)) + 
geom_bar (position = "fill") +
  scale_fill_discrete (name = "Site Prep technique")
#Fruit presence pretty similar between all
```

Assess the percent cover of huckleberry by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP1_TECH_GP, y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "Prep Technique",
        y = "Huckleberry Cover")

#Cover appears to be similar for all categories.
```

Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP1_TECH_GP, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "Prep Technique",
        y = "Huckleberry Fruit Abundance")

#Appears highest in areas with burning as part of site prep.
```

Assess for differences in stand age by category.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP1_TECH_GP, y = origin.age)) +
  geom_boxplot () +
  labs (x = "Site Prep Technique",
        y = "Stand Age")

#Areas with burning for prep slightly older.
```


Create a even more trimmed dataset without NAs in above metrics of interest.

```{r}
cutblock_plots_openings_Huck_ALL_df4<-subset(cutblock_plots_openings_Huck_ALL_df2b, cutblock_plots_openings_Huck_ALL_df2b$PREP1_TECH_GP!="NA")
cutblock_plots_openings_Huck_ALL_df4<-subset(cutblock_plots_openings_Huck_ALL_df4, cutblock_plots_openings_Huck_ALL_df4$DN1_SILSYS_GP!="NA")

table(cutblock_plots_openings_Huck_ALL_df4$Species.Present) #dataset down to 53 absences and 231 presences. Getting pretty slim.
table(cutblock_plots_openings_Huck_ALL_df4$PREP1_TECH_GP)
table(cutblock_plots_openings_Huck_ALL_df4$DN1_SILSYS_GP)
table(cutblock_plots_openings_Huck_ALL_df4$origin) #Leaves us with only 10 sites that were burned since harvesting. Likely need to either exclude these, or ignore this variable. Either way, likely insufficient data to use this as a variable.
table(cutblock_plots_openings_Huck_ALL_df4$origin, cutblock_plots_openings_Huck_ALL_df4$PREP1_TECH_GP)
table(cutblock_plots_openings_Huck_ALL_df4$origin, cutblock_plots_openings_Huck_ALL_df4$DN1_SILSYS_GP)

#Exploratory models with what we have currently, we would be able to use PREP1_TECH_GP, DN1_SILSYS_GP, and TimeSinceCut on (1) Huckleberry Presence/Absence; (2) Species cover; (3) fruit P/A; (4) fruit abundance

```


```{r}
cutblock_plots_openings_Huck_ALL_df2b$TOTAL_plant_area #But 0s are not true values necessarily
cutblock_plots_openings_Huck_ALL_df2b$AREAHA
```

#Check pattern by origin.age

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = origin.age, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Time since Fire or Harvest (years)",
        y = "Species Cover")
```

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = TimeSinceCut, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Time Since Harvest (years)",
        y = "Species Cover")
#Seemingly positive but very little data >90 years.
```

At this point, we have a few variations on the data:
1. cutblock_plots_openings_Huck_ALL_df2b
2. cutblock_plots_openings_Huck_ALL_df2b

Save

```{r}
#two names ASPECT and aspect, must change 1
names(cutblock_plots_openings_Huck_ALL_df2b)
cutblock_plots_openings_Huck_ALL_df2b$ASPECT_1<-cutblock_plots_openings_Huck_ALL_df2b$ASPECT
cutblock_plots_openings_Huck_ALL_df2b<-cutblock_plots_openings_Huck_ALL_df2b[-62]

st_write(cutblock_plots_openings_Huck_ALL_df2b, dsn="D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Huck_ALL_df2b.csv")
```


#####################  Begin Exploratory Analayses ###########################

Exploratory models with what we have currently, we would be able to use PREP1_TECH_GP OR PREP_TECH_2_GP, DN1_SILSYS_GP, and TimeSinceCut (or rather origin.age if include origin) on (1) Huckleberry Presence/Absence (Species.Present); (2) Species cover (Species.Cover); (3) fruit P/A (Fruit.Present); (4) fruit abundance (Fruit.Cover). Might need to include an interaction between TimeSinceCut and other variables. Might want to play around with origin as there seem to be differences there, but very few plots burned more recently than  harvested. May want to assess AREAHA, but preliminary graphs do not suggest we would expect a difference by harvest area and we have the problem of it not necessarily capturing the total open area since multiple cutblocks may be adjacent to each other, representing a larger open area.

Explore if there are datasets that might be able to fill in the gaps for the lost data already. Or if a variable comes out as not significant, then take a step back and use the larger dataset that did not eliminate the NAs for that one. 

Still need to add in (1) planting density and number of trees planted. And get (2) canopy cover for each year that data was collected for remaining data. Then can add canopy cover as 4th variable to above. Also should include (3) cutblock size, (4) species harvested (or similar).

Perhaps explore above first. Then other variables to include in exploratory model in step 2: (1) percent sand (TSAND), (2) average winter T (Tave_wt), (3) precip as snow (PAS_wt, or add all PAS_wt+PAS_at+PAS_sm+PAS_sp), (4) average pH (PH2), (5) slope (slope_30m_SRTM) and (6) heatload (not currently in dataset for some reason). No interactions, not enough df for that. Also (6) Land cover type (MODIS_LC)

##Initial Exploration with only a few variables

```{r}
model1 <- glm (Species.Present2 ~ PREP1_TECH_GP + DN1_SILSYS_GP + origin*origin.age,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

library(car)
Anova(model1, type=3) #only origin.age significant

model1b <- glm (Species.Present2 ~ PREP_TECH_2_GP + DN1_SILSYS_GP + origin*origin.age,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
Anova(model1b, type=3) #Nothing

#Remove interaction
model2 <- glm (Species.Present2 ~ PREP1_TECH_GP + DN1_SILSYS_GP + origin + origin.age,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model2, type=3) #origin.age significant
summary(model2)

model2b <- glm (Species.Present2 ~ PREP_TECH_2_GP + DN1_SILSYS_GP + origin + origin.age,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model2b, type=3)
summary(model2b)

#Ignore origin given very few that burned since harvested
model3 <- glm (Species.Present2 ~ PREP1_TECH_GP + DN1_SILSYS_GP + TimeSinceCut,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model3, type=3)
summary(model3)

model3b <- glm (Species.Present2 ~ PREP_TECH_2_GP + DN1_SILSYS_GP + TimeSinceCut,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model3b, type=3)
summary(model3b)

model4 <- glm (Species.Present2 ~ PREP_BU_ + PREP_ME_ + DN1_SILSYS_GP + TimeSinceCut,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model4, type=3) #PREP_BU_ almost sig
summary(model4)

```

Create data without NA category:

```{r}
cutblock_plots_openings_Huck_ALL_df2b_<-subset(cutblock_plots_openings_Huck_ALL_df2b, cutblock_plots_openings_Huck_ALL_df2b$PREP_TECH_2_GP!="NA")
table(cutblock_plots_openings_Huck_ALL_df2b_$PREP_TECH_2_GP)

```

Run a few simpler models due to small sample size:

```{r}
model.1 <- glm (Species.Present2 ~ PREP_TECH_2_GP,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.1, type=3) #Yes
summary(model.1)

#Repeat above with unknown removed
model.1b <- glm (Species.Present2 ~ PREP_TECH_2_GP,
               data=cutblock_plots_openings_Huck_ALL_df2b_,
               family = binomial (link = "logit"))

Anova(model.1b, type=3) #Definitely no
summary(model.1b)

#
model.2 <- glm (Species.Present2 ~ PREP1_TECH_GP,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.2, type=3) #No
summary(model.2)

model.3 <- glm (Species.Present2 ~ DN1_SILSYS_GP,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.3, type=3) #yes
summary(model.3) #clearcut higher probability to have huckleberry than clearcut with reserves and other

model.4 <- glm (Species.Present2 ~ TimeSinceCut,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.4, type=3) #yes
summary(model.4) #Positive relationship

model.5 <- glm (Species.Present2 ~ origin*origin.age,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.5, type=3) #Only origin age
summary(model.5) #Origin age positive

model.6 <- glm (Species.Present2 ~ origin,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.6, type=3) #No
summary(model.6)

model.7 <- glm (Species.Present2 ~ PLANTED,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.7, type=3) #No
summary(model.7)

model.8 <- glm (Species.Present2 ~ PREP_BU_ + PREP_ME_,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.8, type=3) #PREP_BU significant
summary(model.8) # if burned, more likely to occur
```

Investigate climate variables:
(1) percent sand (TSAND), (2) average winter T (Tave_wt), (3) precip as snow (PAS_wt, or add all PAS_wt+PAS_at+PAS_sm+PAS_sp), (4) average pH (PH2), (5) slope (slope_30m_SRTM) and (6) heatload (not currently in dataset for some reason). Also (6) Land cover type (MODIS_LC). No interactions, not enough df for that.  Canopy Cover from 2010: LandsatCC_2010_Fixed, but hoping to get more accurate canopy cover using clus

```{r}
model.8 <- glm (Species.Present2 ~ TSAND,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.8, type=3) #Almost
summary(model.8)

model.9 <- glm (Species.Present2 ~ Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.9, type=3) #Very much so yes
summary(model.9) #Positive interaction. More likely to occur where winters warmer.

#Create total PAS (precipitation as snow)
cutblock_plots_openings_Huck_ALL_df2b$PAS_total<-cutblock_plots_openings_Huck_ALL_df2b$PAS_at+cutblock_plots_openings_Huck_ALL_df2b$PAS_sm+cutblock_plots_openings_Huck_ALL_df2b$PAS_sp+cutblock_plots_openings_Huck_ALL_df2b$PAS_wt

model.10 <- glm (Species.Present2 ~ PAS_total,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.10, type=3) #Very much so yes
summary(model.10) #positive interaction. More huckleberry where more precipitation falls as snow.

model.11 <- glm (Species.Present2 ~ PH2,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.11, type=3) #No
summary(model.11)

model.12 <- glm (Species.Present2 ~ slope_30m_SRTM,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.12, type=3) #Very much yes
summary(model.12) #Positive interaction; more likely to occur steeper slopes; although may wish to assess for non-linear relationships


model.14 <- glm (Species.Present2 ~ LandsatCC_2010_Fixed,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.14, type=3) #Very much yes
summary(model.14) #Negative interaction; less likely to occur as canopy cover increases; although may wish to assess for non-linear relationships


#
cutblock_plots_openings_Huck_ALL_df2b$MODIS_LC<-as.factor(cutblock_plots_openings_Huck_ALL_df2b$MODIS_LC)

model.13 <- glm (Species.Present2 ~ MODIS_LC,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.13, type=3) #Very much yes
summary(model.13) #Compare to table


```

#Below key for Model 13 Levels:
0	Water
1	Evergreen Needle leaf Forest
2	Evergreen Broadleaf Forest
3	Deciduous Needle leaf Forest** More common
4	Deciduous Broadleaf Forest
5	Mixed Forests *Less common
6	Closed Shrublands
7	Open Shrublands **More common
8	Woody Savannas
9	Savannas
10	Grasslands
11	Permanent Wetland **More common
12	Croplands
13	Urban and Built-Up
14	Cropland/Natural Vegetation Mosaic *less common
15	Snow and Ice
16	Barren or Sparsely Vegetated


Look at raw data relationhship shapes to each climate variable

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = TSAND, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "% Sand",
        y = "Species Cover")
```


```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Tave_wt, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Average Winter Temp",
        y = "Species Cover")
#Relationship may be more hump shaped centred around -7 degrees as opposed to linear
```


```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PAS_total, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Precipitation as snow (mm)",
        y = "Species Cover")
```


```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PH2, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Soil PH",
        y = "Species Cover")
#Interesting pattern... not quite linear. Drops off above ph ~ 5
```


```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = slope_30m_SRTM, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Slope",
        y = "Species Cover")
#Definitely more hump shaped
```

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = SLOPE, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Slope",
        y = "Species Cover")
```

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = aspect_30m_SRTM, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Aspect",
        y = "Species Cover")
```

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = ASPECT, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Aspect",
        y = "Species Cover")
```


```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = LandsatCC_2010_Fixed, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Canopy Cover (%)",
        y = "Species Cover")
#Mostly a negative relationship
```


#Because max slope ~40 degrees, can create an SAI (slope-aspect index) value: example = sin(aspect +225) x (slope/45).

```{r}
names(cutblock_plots_openings_Huck_ALL_df2b)
hist(cutblock_plots_openings_Huck_ALL_df2b$SLOPE)
cutblock_plots_openings_Huck_ALL_df2b$SLOPE<-as.numeric(cutblock_plots_openings_Huck_ALL_df2b$SLOPE)
max(cutblock_plots_openings_Huck_ALL_df2b$SLOPE) #Cannot get max because of NAs
hist(cutblock_plots_openings_Huck_ALL_df2b$ASPECT_1)

cor(cutblock_plots_openings_Huck_ALL_df2b$SLOPE, cutblock_plots_openings_Huck_ALL_df2b$slope_30m_SRTM) #cannot get because of NAs
plot(cutblock_plots_openings_Huck_ALL_df2b$SLOPE ~ cutblock_plots_openings_Huck_ALL_df2b$slope_30m_SRTM) #Quite different. Perhaps use point values and use DEM to get slope and aspect? Or use the cutblock data because it likely takes the average for the cutblock which is probably more representative.
plot(cutblock_plots_openings_Huck_ALL_df2b$ASPECT_1 ~ cutblock_plots_openings_Huck_ALL_df2b$aspect_30m_SRTM)

#Test for max values
cutblock_plots_openings_Huck_ALL_df2b_SLOPE<-subset(cutblock_plots_openings_Huck_ALL_df2b, cutblock_plots_openings_Huck_ALL_df2b$SLOPE!="NA")
max(cutblock_plots_openings_Huck_ALL_df2b_SLOPE$SLOPE) #58.9
max(cutblock_plots_openings_Huck_ALL_df2b_SLOPE$slope_30m_SRTM) #45

cutblock_plots_openings_Huck_ALL_df2b$SAI_cb<-(sin(cutblock_plots_openings_Huck_ALL_df2b$ASPECT_1 + 225) *(cutblock_plots_openings_Huck_ALL_df2b$SLOPE/58.9)) #SAI (Slope to aspect Index) of cutblock data slope and aspect
cutblock_plots_openings_Huck_ALL_df2b$SAI_rec<-(sin(cutblock_plots_openings_Huck_ALL_df2b$aspect_30m_SRTM + 225) *(cutblock_plots_openings_Huck_ALL_df2b$slope_30m_SRTM/45)) #SAI of slope and aspect from Clayton's data

hist(cutblock_plots_openings_Huck_ALL_df2b$SAI_cb)
hist(cutblock_plots_openings_Huck_ALL_df2b$SAI_rec)
plot(cutblock_plots_openings_Huck_ALL_df2b$SAI_cb ~ cutblock_plots_openings_Huck_ALL_df2b$SAI_rec) # The result is COMPLETELY different, depending on which values are used. No correlation what so ever.

```

Compare probabilities between values.

```{r}
ggplot(cutblock_plots_openings_Huck_ALL_df2b, aes(SAI_cb, as.numeric(Species.Present))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("SAI by cutblock data") + ylab("Pr (Species Present)")
#No relationship
```

```{r}
ggplot(cutblock_plots_openings_Huck_ALL_df2b, aes(SAI_rec, as.numeric(Species.Present))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("SAI by recorded data") + ylab("Pr (Species Present)")
#Maybe slight negative relationship
```

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = SAI_rec, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "SAI by recorded data",
        y = "Species Cover")
```

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = SAI_cb, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "SAI by cutblock data",
        y = "Species Cover")
```


#Check for colineraity between continuous variables.


#Try a model with: canopy cover (%), scarification (0/1), CTI (soil wetness metric the Compound Topographic Index), SAI, and elevation (Nielsen et al. 2004b). Also include burned (0/1).

```{r}
hist(cutblock_plots_openings_Huck_ALL_df2b$ELEVATION)
```

Try model: canopy cover (%), scarification (0/1), CTI (soil wetness metric the Compound Topographic Index), SAI, and elevation (Nielsen et al. 2004b). Also include burned (0/1).

```{r}
cutblock_plots_openings_Huck_ALL_df2b$PLANTED<-as.factor(cutblock_plots_openings_Huck_ALL_df2b$PLANTED)
```


```{r}
### Assess best model for Species Present/Absence

#Species Present or Absent Huckleberry
model.new.1 <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_*PREP_ME_ +  PAS_total + PH2 + MODIS_LC + PLANTED +AREAHA + ELEVATION,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #445

#Remove least significant
model.new.1 <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2 + MODIS_LC + PLANTED +AREAHA + ELEVATION,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #443

#Remove least significant
model.new.1 <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #441.5

#Remove least significant
model.new.1 <- glm (Species.Present2 ~ LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #448 - WORSE

#Revert
model.new.1 <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #441.5

#Explore partial residuals with current model
library(visreg)

visreg(model.new.1, "SAI_cb")
visreg(model.new.1, "LandsatCC_2010_Fixed")

visreg(model.new.1, "PREP_BU_")
visreg(model.new.1, "PREP_ME_")

visreg(model.new.1, "PAS_total")
visreg(model.new.1, "PH2")

visreg(model.new.1, "PLANTED")
visreg(model.new.1, "AREAHA")
visreg(model.new.1, "ELEVATION")
```


```{r}
#Include some otehrs back in
names(cutblock_plots_openings_Huck_ALL_df2b)
cutblock_plots_openings_Huck_ALL_df2b$VFSAND

model.new.1 <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + TimeSinceCut +TimeSinceFire + TCLAY + VFSAND,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

#Change to origin age
model.new.1 <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #439.6

#Add some of the other variables
model.new.1 <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #347.7

#Even though not all significant, visualize residuals
library(visreg)

#SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP
visreg(model.new.1, "SAI_cb")
visreg(model.new.1, "LandsatCC_2010_Fixed")

visreg(model.new.1, "PREP_BU_", by="PREP_ME_")
visreg(model.new.1, "PREP_ME_", by="PREP_BU_")

visreg(model.new.1, "PAS_total")
visreg(model.new.1, "PH2")

visreg(model.new.1, "PLANTED")
visreg(model.new.1, "AREAHA")
visreg(model.new.1, "ELEVATION")

visreg(model.new.1, "origin.age")
visreg(model.new.1, "TCLAY")
visreg(model.new.1, "VFSAND")
visreg(model.new.1, "DN1_SILSYS_GP")
```


```{r}
#Add BEC zones
table(cutblock_plots_openings_Huck_ALL_df2b$G_BGC_ZONE)

model.new.1 <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #327.4

visreg(model.new.1, "SAI_cb")
visreg(model.new.1, "LandsatCC_2010_Fixed")

visreg(model.new.1, "PREP_BU_", by="PREP_ME_")
visreg(model.new.1, "PREP_ME_", by="PREP_BU_")

visreg(model.new.1, "PAS_total")
visreg(model.new.1, "PH2")

visreg(model.new.1, "PLANTED")
visreg(model.new.1, "AREAHA")
visreg(model.new.1, "ELEVATION")

visreg(model.new.1, "origin.age")
visreg(model.new.1, "TCLAY")
visreg(model.new.1, "VFSAND")
visreg(model.new.1, "DN1_SILSYS_GP")

visreg(model.new.1, "G_BGC_ZONE")

```

## Add Start_Season
```{r}
model.new.1 <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #328.3

visreg(model.new.1, "SAI_cb")
visreg(model.new.1, "LandsatCC_2010_Fixed")

visreg(model.new.1, "PREP_BU_", by="PREP_ME_")
visreg(model.new.1, "PREP_ME_", by="PREP_BU_")

visreg(model.new.1, "PAS_total")
visreg(model.new.1, "PH2")

visreg(model.new.1, "PLANTED")
visreg(model.new.1, "AREAHA")
visreg(model.new.1, "ELEVATION")

visreg(model.new.1, "origin.age")
visreg(model.new.1, "TCLAY")
visreg(model.new.1, "VFSAND")
visreg(model.new.1, "DN1_SILSYS_GP")

visreg(model.new.1, "G_BGC_ZONE")
visreg(model.new.1, "START_SEASON")

visreg(model.new.1, "Tave_wt")
```
Now let's get to best model from these variables

```{r}
#Remove least significant (Canopy Cover)
model.new.1 <- glm (Species.Present2 ~ SAI_cb + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #330.0

#Remove least significant (SAI)
model.new.1 <- glm (Species.Present2 ~ PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #332.5 --> worse; go back

#Remove least significant other than SAI (Clay)
model.new.1 <- glm (Species.Present2 ~ SAI_cb + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #328.2

#Remove least significant (Start_Season)
model.new.1 <- glm (Species.Present2 ~ SAI_cb + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #323.6

#Remove least significant (Age of cutblock)
model.new.1 <- glm (Species.Present2 ~ SAI_cb + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #321.8

#Remove least significant (whether planted or not)
model.new.1 <- glm (Species.Present2 ~ SAI_cb + PREP_BU_* PREP_ME_ +  PAS_total + PH2  +AREAHA + ELEVATION + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #319.9
```

Get Partial residuals for above model: SAI_cb + PREP_BU_* PREP_ME_ +  PAS_total + PH2  +AREAHA + ELEVATION + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE
```{r}
visreg(model.new.1, "SAI_cb")

visreg(model.new.1, "PREP_BU_", by="PREP_ME_")
visreg(model.new.1, "PREP_ME_", by="PREP_BU_")

visreg(model.new.1, "PAS_total")
visreg(model.new.1, "PH2")

visreg(model.new.1, "AREAHA")
visreg(model.new.1, "ELEVATION")

visreg(model.new.1, "VFSAND")
visreg(model.new.1, "DN1_SILSYS_GP")

visreg(model.new.1, "G_BGC_ZONE")
```


Add in Tave_wt

```{r}
#Remove least significant (whether planted or not)
model.new.1 <- glm (Species.Present2 ~ SAI_cb + PREP_BU_* PREP_ME_ +  PAS_total + PH2  +AREAHA + ELEVATION + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #317.1

#Remove last sig
model.new.1 <- glm (Species.Present2 ~ SAI_cb + PREP_BU_* PREP_ME_ +  PAS_total + PH2  +AREAHA + ELEVATION + VFSAND + G_BGC_ZONE + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #419.5--> WAY WORSE

model.new.1 <- glm (Species.Present2 ~ SAI_cb + PREP_BU_* PREP_ME_ +  PAS_total + PH2  +AREAHA + ELEVATION + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #317.1

#Partial residuals
visreg(model.new.1, "SAI_cb")

visreg(model.new.1, "PREP_BU_", by="PREP_ME_")
visreg(model.new.1, "PREP_ME_", by="PREP_BU_")

visreg(model.new.1, "PAS_total")
visreg(model.new.1, "PH2")
visreg(model.new.1, "Tave_wt")

visreg(model.new.1, "AREAHA")
visreg(model.new.1, "ELEVATION")

visreg(model.new.1, "VFSAND")
visreg(model.new.1, "DN1_SILSYS_GP")

visreg(model.new.1, "G_BGC_ZONE")
visreg(model.new.1, "Tave_wt")
```






Clayton's:(1) percent of area burned, (2) percent sand, (3) average winter temperature, (4) precipitation as snow, (5) canopy cover, (6) average pH, (7) slope and (8) solar heat load.

I would really like CMI (Climate Moisture Index). May need to acquire this.

```{r}
model.new.1k <- glm (Species.Present2 ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION + TSAND,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1k, type=3) #
summary(model.new.1k) #
AIC(model.new.1k) #421.52

model.new.1l <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION + TSAND,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1l, type=3) #
summary(model.new.1l) #
AIC(model.new.1l) #421.70

model.new.1m <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION + TSAND + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1m, type=3) #
summary(model.new.1m) #
AIC(model.new.1m) #418.82

#Remove sand
model.new.1n <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION  + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1n, type=3) #
summary(model.new.1n) #
AIC(model.new.1n) #417.24

#Trade canopy cover with time since intervention
model.new.1o <- glm (Species.Present2 ~ slope_30m_SRTM + origin.age + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION  + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1o, type=3) #
summary(model.new.1o) #
AIC(model.new.1o) #418.78

#Remove CC and age
model.new.1p <- glm (Species.Present2 ~ slope_30m_SRTM + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION  + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1p, type=3) #
summary(model.new.1p) #
AIC(model.new.1p) #416.78

#Remove interventions
model.new.1q <- glm (Species.Present2 ~ slope_30m_SRTM  +  PAS_total + PH2 + ELEVATION  + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1q, type=3) #
summary(model.new.1q) #
AIC(model.new.1q) #415.56 (better AIC, but not 2 points worth)

#Current model of choice
model.new.1n <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION  + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1n, type=3) #
summary(model.new.1n) #
AIC(model.new.1n) #417.24

```

Try some transformations to try and match shape seen in prior graphs.

```{r}

ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = slope_30m_SRTM, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Slope",
        y = "Species Cover")

cutblock_plots_openings_Huck_ALL_df2b$slope_30m_SRTM_tr<- -((cutblock_plots_openings_Huck_ALL_df2b$slope_30m_SRTM/4)-5)^2+23

ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = slope_30m_SRTM_tr, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Slope Transformed",
        y = "Species Cover")
#Maybe kind of worked?

```

```{r}
model.new.1r <- glm (Species.Present2 ~ slope_30m_SRTM_tr + LandsatCC_2010_Fixed + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION  + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1r, type=3) #
summary(model.new.1r) #
AIC(model.new.1r) #423.82
#Not better
```
```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PH2, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "pH",
        y = "Species Cover")

cutblock_plots_openings_Huck_ALL_df2b$PH2_tr<- -((cutblock_plots_openings_Huck_ALL_df2b$PH2)-4)^2+25

ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PH2_tr, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "pH transformed",
        y = "Species Cover")

#Not better
```

```{r}
model.new.1s <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PREP_BU_+PREP_ME_ +  PAS_total + PH2_tr + ELEVATION  + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1s, type=3) #
summary(model.new.1s) #
AIC(model.new.1s)
#Not better
```

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Tave_wt, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Average winter Temp",
        y = "Species Cover")

cutblock_plots_openings_Huck_ALL_df2b$Tave_wt_tr<- -((cutblock_plots_openings_Huck_ALL_df2b$Tave_wt)+7)^2+7

ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Tave_wt_tr, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "Average winter Temp Transformed",
        y = "Species Cover")
```

```{r}
model.new.1t <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION  + Tave_wt_tr,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1t, type=3) #
summary(model.new.1t) #
AIC(model.new.1t) #Not better
```
Best model with variables of interest. Try to enhance canopy cover data?
```{r}
model.new.1n <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PREP_BU_+PREP_ME_ +  PAS_total + PH2 + ELEVATION  + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.1n, type=3) #
summary(model.new.1n) #
AIC(model.new.1n) #417.24
```




####### UPDATE BELOW #############



Determine AUC by splitting into training and validation set (85% and 15% given small sample size).

```{r}
#Create an 85% proportion
prop<-0.85

#Create variables
variables.huck<-c(slope_30m_SRTM = "slope_30m_SRTM", LandsatCC_2010_Fixed = "LandsatCC_2010_Fixed", PREP_BU_ = "PREP_BU_" , PREP_ME_ = "PREP_ME_",  PAS_total = "PAS_total", PH2 = "PH2", ELEVATION = "ELEVATION", Tave_wt = "Tave_wt")

variables.huck<-c("slope_30m_SRTM", "LandsatCC_2010_Fixed", "PREP_BU_", "PREP_ME_",  "PAS_total", "PH2", "ELEVATION", "Tave_wt")

#
mods.me.tmp <- powerSet(variables.huck)
mods.me.tmp

# Select models we want to test here. 256 has all, test some without silviculture and site prep, like 241, 242, 243, 244
mod.to.test.1<-mods.me.tmp[241:244]
mod.to.test.2<-mod.to.test<-mods.me.tmp[256]
mod.to.test.3<-mods.me.tmp[225:228]

mod.to.test.subset<-c(1, mod.to.test.1,mod.to.test.2, mod.to.test.3)
mod.to.test.subset

mod.to.test.all<-c(1,mods.me.tmp)
mod.to.test.all<-mod.to.test.all[-2]

#Subset the data once into training and validation set
cutblock_plots_openings_Huck_ALL_df2b_ng<-as.data.frame((cutblock_plots_openings_Huck_ALL_df2b))
model.data<- cutblock_plots_openings_Huck_ALL_df2b_ng %>% dplyr::select(Species.Present2, variables.huck)
trainIndex_huck <- createDataPartition(model.data$Species.Present2, p = prop,
                                    list = FALSE,
                                    times = 1)
  
dat.1 <- model.data[ trainIndex_huck,]
Valid.1 <- model.data[-trainIndex_huck,]


#Create model function
big.mod <- function(mods.in, df.train, df.test, dep.var="Species.Present2") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

mods.fit <- lapply(mod.to.test.all, big.mod, df.train=dat.1, df.test=Valid.1)
mods.fit


#terms in each model
x1 <- unlist(sapply(mods.fit, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit, '[', 3)), ncol=2, byrow=TRUE)
x3
#auc from validation data
x4 <- unlist(sapply(mods.fit, '[', 4))
x4
#combining all as df
tab.sum.huckleberry <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.huckleberry$delta.aic<- tab.sum.huckleberry$aic - (min(tab.sum.huckleberry$aic))
tab.sum.huckleberry 


```
Save as csv
```{r}
write.csv(tab.sum.huckleberry, file="D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\model.1.series.AIC.AUC.csv")

```

If going to model selection like above, could include other variables like TSAND, PLANTING. Also determine timing of harvest.

```{r}
#Determine timing of harvest
names(cutblock_plots_openings_Huck_ALL_df2b)
head(cutblock_plots_openings_Huck_ALL_df2b$DST_STR_DT)
table(cutblock_plots_openings_Huck_ALL_df2b$DST_STR_DT)

cutblock_plots_openings_Huck_ALL_df2b$DST_Start_year<-stri_sub(cutblock_plots_openings_Huck_ALL_df2b$DST_STR_DT,3,4)
cutblock_plots_openings_Huck_ALL_df2b$DST_Start_year
cutblock_plots_openings_Huck_ALL_df2b$DST_Start_month<-stri_sub(cutblock_plots_openings_Huck_ALL_df2b$DST_STR_DT,5,6)
head(cutblock_plots_openings_Huck_ALL_df2b$DST_Start_month)
cutblock_plots_openings_Huck_ALL_df2b$DST_End_year<-stri_sub(cutblock_plots_openings_Huck_ALL_df2b$DST_END_DT,3,4)
cutblock_plots_openings_Huck_ALL_df2b$DST_End_year
cutblock_plots_openings_Huck_ALL_df2b$DST_End_month<-stri_sub(cutblock_plots_openings_Huck_ALL_df2b$DST_END_DT,5,6)

#Make all numeric
cutblock_plots_openings_Huck_ALL_df2b$DST_Start_year.num<-as.numeric((cutblock_plots_openings_Huck_ALL_df2b$DST_Start_year))
cutblock_plots_openings_Huck_ALL_df2b$DST_End_year.num<- as.numeric(cutblock_plots_openings_Huck_ALL_df2b$DST_End_year)

cutblock_plots_openings_Huck_ALL_df2b$DST_Start_month.num<-as.numeric((cutblock_plots_openings_Huck_ALL_df2b$DST_Start_month))
cutblock_plots_openings_Huck_ALL_df2b$DST_End_month.num<- as.numeric(cutblock_plots_openings_Huck_ALL_df2b$DST_End_month)

#Determine length in years
cutblock_plots_openings_Huck_ALL_df2b$DST_year_length<- cutblock_plots_openings_Huck_ALL_df2b$DST_End_year.num - cutblock_plots_openings_Huck_ALL_df2b$DST_Start_year.num
table(cutblock_plots_openings_Huck_ALL_df2b$DST_year_length) #Can see that treatment took a long time in some.

#Only look at start month, assuming this is when harvesting and scarification ocurred.
table(cutblock_plots_openings_Huck_ALL_df2b$DST_Start_month)
str(cutblock_plots_openings_Huck_ALL_df2b$DST_Start_month)
cutblock_plots_openings_Huck_ALL_df2b$DST_Start_month<-as.factor(cutblock_plots_openings_Huck_ALL_df2b$DST_Start_month)

#Turn into seasonal months
cutblock_plots_openings_Huck_ALL_df2b$DIST_SEASON<-0
cutblock_plots_openings_Huck_ALL_df2b<-cutblock_plots_openings_Huck_ALL_df2b %>%
    mutate(DIST_SEASON = case_when(DST_Start_month == "01" ~ "Winter",
                                  DST_Start_month == "02" ~ "Winter",
                                  DST_Start_month == "03" ~ "Spring",
                                  DST_Start_month == "04" ~ "Spring",
                                  DST_Start_month == "05" ~ "Spring",
                                  DST_Start_month == "06" ~ "Summer",
                                  DST_Start_month == "07" ~ "Summer",
                                  DST_Start_month == "08" ~ "Summer",
                                  DST_Start_month == "09" ~ "Fall",
                                  DST_Start_month == "10" ~ "Fall",
                                  DST_Start_month == "11" ~ "Fall",
                                  DST_Start_month == "12" ~ "Winter",
                                  TRUE ~ "NA"))
table(cutblock_plots_openings_Huck_ALL_df2b$DIST_SEASON) # Determine if want different cutoffs for snow months.

```


```{r}
cutblock_plots_openings_Huck_ALL_df2b$PAS_total<-cutblock_plots_openings_Huck_ALL_df2b$PAS_wt + cutblock_plots_openings_Huck_ALL_df2b$PAS_sm + cutblock_plots_openings_Huck_ALL_df2b$PAS_sp + cutblock_plots_openings_Huck_ALL_df2b$PAS_at

variables.huck<-c("slope_30m_SRTM", "aspect_30m_SRTM", "LandsatCC_2010_Fixed",  "PAS_total", "PH2", "ELEVATION", "Tave_wt", "TSAND", "MODIS_LC", "Fire_Occ", "PLANTED", "PREP_BU_", "PREP_ME_", "DIST_SEASON", "origin.age", "DN1_SILSYS_GP")

cutblock_plots_openings_Huck_ALL_df2b$Fire_Occ<-as.factor(cutblock_plots_openings_Huck_ALL_df2b$Fire_Occ)
cutblock_plots_openings_Huck_ALL_df2b$MODIS_LC<-as.factor(cutblock_plots_openings_Huck_ALL_df2b$MODIS_LC)
head(cutblock_plots_openings_Huck_ALL_df2b$Fire_Occ)

#
mods.me.tmp <- powerSet(variables.huck)
#mods.me.tmp

mod.to.test.all<-c(1,mods.me.tmp)
mod.to.test.all<-mod.to.test.all[-2]

#Subset the data once into training and validation set
cutblock_plots_openings_Huck_ALL_df2b_ng<-as.data.frame((cutblock_plots_openings_Huck_ALL_df2b))
model.data<- cutblock_plots_openings_Huck_ALL_df2b_ng %>% dplyr::select(Species.Present2, variables.huck)
trainIndex_huck <- createDataPartition(model.data$Species.Present2, p = prop,
                                    list = FALSE,
                                    times = 1)
  
dat.1 <- model.data[ trainIndex_huck,]
Valid.1 <- model.data[-trainIndex_huck,]

#Run with big.mod
mods.fit2 <- lapply(mod.to.test.all, big.mod, df.train=dat.1, df.test=Valid.1)
#mods.fit2


#terms in each model
x1 <- unlist(sapply(mods.fit2, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit2, '[', 3)), ncol=2, byrow=TRUE)
#x3
#auc from validation data
x4 <- unlist(sapply(mods.fit2, '[', 4))
#x4
#combining all as df
tab.sum.huckleberry2 <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.huckleberry2$delta.aic<- tab.sum.huckleberry2$aic - (min(tab.sum.huckleberry2$aic))
tab.sum.huckleberry2 
```
Save as csv
```{r}
write.csv(tab.sum.huckleberry2, file="D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\model.2.series.AIC.AUC_SpeciesPresent_Huck.csv")

```



##Create new best models
```{r}
model.new.2 <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + Tave_wt + Fire_Occ + DIST_SEASON + origin.age,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.2, type=3) #
summary(model.new.2) # Treatment in Fall is most conducive to have huckleberries
#positive with slope (transformation desired?)
#negative with canopy cover 
#Positive with precip as snow
#Positive with PH (transformation desired?)
# Positive with elevation
# Positive with Temp in winter
# More likely where natural fires occurred
#Positive with origin age (transformation desired??)
AIC(model.new.2) #406.1

model.new.2b <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + Tave_wt + Fire_Occ + DIST_SEASON + origin.age + PREP_ME_,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.2b, type=3) #
summary(model.new.2b) 
AIC(model.new.2b) #406.4

model.new.2c <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + Tave_wt + Fire_Occ + DIST_SEASON + origin.age + PREP_ME_ + PREP_BU_,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.2c, type=3) #
summary(model.new.2c) # 
AIC(model.new.2c) #407.6

model.new.2d <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + Tave_wt + Fire_Occ + DIST_SEASON + origin.age + PREP_ME_ + PLANTED,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.2d, type=3) #
summary(model.new.2d) # 
AIC(model.new.2d) #407.8
```
Current top model:

```{r}
model.new.2c <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + Tave_wt + Fire_Occ + DIST_SEASON + origin.age + PREP_ME_ + PREP_BU_,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
AIC(model.new.2c) #407.6
```


Check correlation between canopy cover and age of impact.

```{r}
ggscatter(cutblock_plots_openings_Huck_ALL_df2b, x = "LandsatCC_2010_Fixed", y = "origin.age", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = "Canopy Cover", ylab = "Age Since Disturbance")
#Only 0.44 correlation, so ok to have in model together!
```
Assess each variable in the model again.

1. DIST_SEASON: We see that spring has substantially lower abundance, and Fall highest.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = DIST_SEASON , y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "Season",
        y = "Huckleberry Cover")

```


2. SLOPE: We see a positive trend.
```{r}
ggplot(cutblock_plots_openings_Huck_ALL_df2b, aes(slope_30m_SRTM, as.numeric(Species.Present))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Slope") + ylab("Pr (Species Present)")
```
3. Canopy Cover: we see a negative trend.
```{r}
ggplot(cutblock_plots_openings_Huck_ALL_df2b, aes(LandsatCC_2010_Fixed , as.numeric(Species.Present))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Canopy Cover 2010") + ylab("Pr (Species Present)")
```

4. Precip as Snow: strong positive signmoidal pattern

```{r}
ggplot(cutblock_plots_openings_Huck_ALL_df2b, aes(PAS_total, as.numeric(Species.Present))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Precip as Snow") + ylab("Pr (Species Present)")
```

5. PH: gentle negative pattern. Not strong.

```{r}
ggplot(cutblock_plots_openings_Huck_ALL_df2b, aes(PH2, as.numeric(Species.Present))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("pH") + ylab("Pr (Species Present)")
```

6. Elevation: Strong positive trend

```{r}
ggplot(cutblock_plots_openings_Huck_ALL_df2b, aes(ELEVATION, as.numeric(Species.Present))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Elevation (m)") + ylab("Pr (Species Present)")
```

7. Average winter Temp: positive trend with increasing temperature

```{r}
ggplot(cutblock_plots_openings_Huck_ALL_df2b, aes(Tave_wt , as.numeric(Species.Present))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Winter Temp") + ylab("Pr (Species Present)")
```
8. Occurence of natural fires

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = Fire_Occ , y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "No Natural Fire (0), Natural Fire (1)",
        y = "Huckleberry Cover")
```
9. Mechanical prep: slightly more common where mechanical prep occurred.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_ME_ , y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "No Mechanical TR (0), Mechanical TR (1)",
        y = "Huckleberry Cover")
```

10. Burn prep: more likely where burn prep occurred.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = PREP_BU_ , y = Species.Cover)) +
  geom_boxplot () +
  labs (x = "No Burn Prep (0), Burn Prep (1)",
        y = "Huckleberry Cover")
```
11. origin Age: positive trend, but I suspect it is not linear.

```{r}
ggplot(cutblock_plots_openings_Huck_ALL_df2b, aes(origin.age , as.numeric(Species.Present))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3, size=1) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Time Since Disturbance") + ylab("Pr (Species Present)")
```
#Assess BEC zones as well and if that is important to add to model

```{r}
names(cutblock_plots_openings_Huck_ALL_df2b)
table(cutblock_plots_openings_Huck_ALL_df2b$G_BGC_ZONE)

model.new.2e <- glm (Species.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total +
                       PH2 + ELEVATION + Tave_wt + Fire_Occ + DIST_SEASON + origin.age +
                       PREP_ME_ + PREP_BU_ + G_BGC_ZONE,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
AIC(model.new.2e) #402.9
#HUGE. Keep BEC Zone in for sure.
Anova(model.new.2e, type=3)
summary(model.new.2e)

```




############Repeat above for Fruit Presence
We will explore the same variables as we did for plant abundance.

```{r}
variables.huck<-c("slope_30m_SRTM", "aspect_30m_SRTM", "LandsatCC_2010_Fixed",  "PAS_total", "PH2", "ELEVATION", "Tave_wt", "TSAND", "MODIS_LC", "Fire_Occ", "PLANTED", "PREP_BU_", "PREP_ME_", "DIST_SEASON", "origin.age")


#
mods.me.tmp <- powerSet(variables.huck)
#mods.me.tmp

mod.to.test.all<-c(1,mods.me.tmp)
mod.to.test.all<-mod.to.test.all[-2]

#Ensure as factor
cutblock_plots_openings_Huck_ALL_df2b_ng$Fruit.Present2<-as.factor(cutblock_plots_openings_Huck_ALL_df2b_ng$Fruit.Present)
str(cutblock_plots_openings_Huck_ALL_df2b_ng$Fruit.Present)
str(cutblock_plots_openings_Huck_ALL_df2b_ng$Fruit.Present2)

#Subset the data once into training and validation set
model.data2<- cutblock_plots_openings_Huck_ALL_df2b_ng %>% dplyr::select(Fruit.Present2, variables.huck)
trainIndex_huck <- createDataPartition(model.data2$Fruit.Present2, p = prop,
                                    list = FALSE,
                                    times = 1)
  
dat.1 <- model.data2[ trainIndex_huck,]
Valid.1 <- model.data2[-trainIndex_huck,]

#Create function specific for fruit
#Create model function
big.mod2 <- function(mods.in, df.train, df.test, dep.var="Fruit.Present2") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

#Run with big.mod2
mods.fit3 <- lapply(mod.to.test.all, big.mod2, df.train=dat.1, df.test=Valid.1)
#mods.fit3


#terms in each model
x1 <- unlist(sapply(mods.fit3, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit3, '[', 3)), ncol=2, byrow=TRUE)
#x3
#auc from validation data
x4 <- unlist(sapply(mods.fit3, '[', 4))
#x4
#combining all as df
tab.sum.huckleberry3 <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.huckleberry3$delta.aic<- tab.sum.huckleberry3$aic - (min(tab.sum.huckleberry3$aic))
tab.sum.huckleberry3 
```
Save as csv
```{r}
write.csv(tab.sum.huckleberry3, file="D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\model.2.series.AIC.AUC_FruitPresent_Huck.csv")

```

These variables commonly in top models, so start here:
slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + MODIS_LC

Now, others included in some that are interesting to us now: 
1. ELEVATION
2. MODIS_LC
3. origin.age
4. Fire_Occ

One model each deltaAIC<2 had PREP_ME_ and PREP_BU_, but not frequent like above factors; one also had aspect, but not others. One model had TSAND, one had winter Temp. One model also had PLANTED.


```{r}
model.fruitPA.1 <- glm (Fruit.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1, type=3)
summary(model.fruitPA.1)
#Less likely to have fruit where fire occurred
# Positive corellation with origin age
# Positive interaction with pH
# positive interaction with precip as snow
# negative interaction with canopy cover
# positive interaction with slope
AIC(model.fruitPA.1) #565.5

model.fruitPA.1b <- glm (Fruit.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + G_BGC_ZONE,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1b, type=3)
summary(model.fruitPA.1b)
AIC(model.fruitPA.1b) #568.08-- less good with BEC added!

model.fruitPA.1c <- glm (Fruit.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + PLANTED,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.1

model.fruitPA.1c <- glm (Fruit.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + PREP_BU_,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.5


model.fruitPA.1c <- glm (Fruit.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + PREP_ME_,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.4

model.fruitPA.1c <- glm (Fruit.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + TSAND,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.3

model.fruitPA.1c <- glm (Fruit.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.5

```
Current best model:

```{r}
model.fruitPA.1 <- glm (Fruit.Present2 ~ slope_30m_SRTM + LandsatCC_2010_Fixed + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1, type=3)
summary(model.fruitPA.1)
#Less likely to have fruit where fire occurred
# Positive corellation with origin age
# Positive interaction with pH
# positive interaction with precip as snow
# negative interaction with canopy cover
# positive interaction with slope
AIC(model.fruitPA.1) #565.5
```



```{r}
table(cutblock_plots_openings_Huck_ALL_df2b$Fruit.Present)
str(cutblock_plots_openings_Huck_ALL_df2b$Fruit.Present)

model.new.F1 <- glm (Fruit.Present ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #449.0

#Remove least sig
model.new.F1 <- glm (Fruit.Present ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #447.0
```

Let's do partial resids for this before refining further

SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt

```{r}
#Partial residuals
visreg(model.new.F1, "SAI_cb")
visreg(model.new.F1, "LandsatCC_2010_Fixed")

visreg(model.new.F1, "PREP_BU_", by="PREP_ME_")
visreg(model.new.F1, "PREP_ME_", by="PREP_BU_")

visreg(model.new.F1, "PAS_total")
visreg(model.new.F1, "PH2")
visreg(model.new.F1, "Tave_wt")

visreg(model.new.F1, "PLANTED")
visreg(model.new.F1, "AREAHA")
visreg(model.new.F1, "ELEVATION")

visreg(model.new.F1, "VFSAND")
visreg(model.new.F1, "DN1_SILSYS_GP")

visreg(model.new.F1, "origin.age")
visreg(model.new.F1, "G_BGC_ZONE")
visreg(model.new.F1, "START_SEASON")

```


```{r}
#Remove least sig
model.new.F1 <- glm (Fruit.Present ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #442.7

#Remove least sig
model.new.F1 <- glm (Fruit.Present ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP  +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #439.8


#Remove least sig
model.new.F1 <- glm (Fruit.Present ~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP,
               data=cutblock_plots_openings_Huck_ALL_df2b,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #438.8

```

```{r}
#Partial residuals
visreg(model.new.F1, "SAI_cb")
visreg(model.new.F1, "LandsatCC_2010_Fixed")

visreg(model.new.F1, "PREP_BU_", by="PREP_ME_")
visreg(model.new.F1, "PREP_ME_", by="PREP_BU_")

visreg(model.new.F1, "PAS_total")
visreg(model.new.F1, "PH2")

visreg(model.new.F1, "PLANTED")
visreg(model.new.F1, "AREAHA")
visreg(model.new.F1, "ELEVATION")

visreg(model.new.F1, "VFSAND")
visreg(model.new.F1, "DN1_SILSYS_GP")

visreg(model.new.F1, "origin.age")

```





### To do next: Species Cover and Fruit Cover

```{r}
Species.Height

Species.Cover

Fruit.Cover

Fruit.Abund

Fruit.Brix

Fruit.Phenology

```


#Percent cover, but without full data from BEC data

```{r}
model.new.C1 <- lm (Species.Cover~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2451.7
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38

#Remove least sig
model.new.C1 <- lm (Species.Cover~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2449.9
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38

#Remove least sig
model.new.C1 <- lm (Species.Cover~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2 + PLANTED +AREAHA + ELEVATION + origin.age  + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2448.1
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38

#Remove least sig
model.new.C1 <- lm (Species.Cover~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2  +AREAHA + ELEVATION + origin.age  + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2446.5
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38

#Remove least sig
model.new.C1 <- lm (Species.Cover~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2  +AREAHA + ELEVATION + origin.age  + VFSAND + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2419.9
summary(model.new.C1)$r.squared #0.32 --> MAJOR reduction
summary(model.new.C1)$adj.r.squared #0.29

##Remove least sig
model.new.C1 <- lm (Species.Cover~ SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2   + ELEVATION + origin.age  + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df2b)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2446.3
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38
```

Partial residuals:SAI_cb + LandsatCC_2010_Fixed + PREP_BU_ + PREP_ME_ +  PAS_total + PH2   + ELEVATION + origin.age  + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt

```{r}
visreg(model.new.C1, "SAI_cb")
visreg(model.new.C1, "LandsatCC_2010_Fixed")

visreg(model.new.C1, "PREP_BU_")
visreg(model.new.C1, "PREP_ME_")

visreg(model.new.C1, "PAS_total")
visreg(model.new.C1, "PH2")
visreg(model.new.C1, "Tave_wt")

visreg(model.new.C1, "ELEVATION")
visreg(model.new.C1, "origin.age")

visreg(model.new.C1, "VFSAND")
visreg(model.new.C1, "DN1_SILSYS_GP")
visreg(model.new.C1, "G_BGC_ZONE")

visreg(model.new.C1, "START_SEASON")
```








ggplot (cutblock_plots_openings_Huck_ALL_df2b, aes (x = TSAND, y = Species.Cover)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "% Sand",
        y = "Species Cover")


##or berry presence/absence, check which months surveys were done and assess if there is seasonality in the data that needs to be partitioned.

```{r}
head(cutblock_plots_openings_Huck_ALL_df2b)
table(cutblock_plots_openings_Huck_ALL_df2b$Date)

#Select month that data was collected
library(stringi)
cutblock_plots_openings_Huck_ALL_df2b$Date_month<-stri_sub(cutblock_plots_openings_Huck_ALL_df2b$Date,6,7)
table(cutblock_plots_openings_Huck_ALL_df2b$Date_month) # Most August, then September, then July, then some in June.
#hist(cutblock_plots_openings_Huck_ALL_df2b$Date_month)

```

Investiagte date when operations began and ended

```{r}
head(cutblock_plots_openings_Huck_ALL_df2b)
table(cutblock_plots_openings_Huck_ALL_df2b$DST_STR_DT)
table(cutblock_plots_openings_Huck_ALL_df2b$DST_END_DT)

#Select month that data was collected
library(stringi)
cutblock_plots_openings_Huck_ALL_df2b$Date_month_START<-stri_sub(cutblock_plots_openings_Huck_ALL_df2b$DST_STR_DT,5,6)
table(cutblock_plots_openings_Huck_ALL_df2b$Date_month_START) #

cutblock_plots_openings_Huck_ALL_df2b$Date_month_END<-stri_sub(cutblock_plots_openings_Huck_ALL_df2b$DST_END_DT,5,6)
table(cutblock_plots_openings_Huck_ALL_df2b$Date_month_END) #

table(cutblock_plots_openings_Huck_ALL_df2b$Date_month_START, cutblock_plots_openings_Huck_ALL_df2b$Date_month_END) 

#Get Years
cutblock_plots_openings_Huck_ALL_df2b$Date_year_START<-stri_sub(cutblock_plots_openings_Huck_ALL_df2b$DST_STR_DT,1,4)
table(cutblock_plots_openings_Huck_ALL_df2b$Date_year_START) #

cutblock_plots_openings_Huck_ALL_df2b$Date_year_END<-stri_sub(cutblock_plots_openings_Huck_ALL_df2b$DST_END_DT,1,4)
table(cutblock_plots_openings_Huck_ALL_df2b$Date_year_END) #

#How many went between years
str(cutblock_plots_openings_Huck_ALL_df2b$Date_year_END)
cutblock_plots_openings_Huck_ALL_df2b$Date_year_END<-as.numeric(cutblock_plots_openings_Huck_ALL_df2b$Date_year_END)
cutblock_plots_openings_Huck_ALL_df2b$Date_year_START<-as.numeric(cutblock_plots_openings_Huck_ALL_df2b$Date_year_START)

cutblock_plots_openings_Huck_ALL_df2b$NumYearsTreat<-cutblock_plots_openings_Huck_ALL_df2b$Date_year_END - cutblock_plots_openings_Huck_ALL_df2b$Date_year_START

table(cutblock_plots_openings_Huck_ALL_df2b$NumYearsTreat) #Some ended 59 years after starting.


#Even though not entirely accurate, let's use the start month as a proxy. Will group September-November as fall, December-February as winter, March-May as Spring and June-August as summer
cutblock_plots_openings_Huck_ALL_df2b$START_SEASON<-cutblock_plots_openings_Huck_ALL_df2b$Date_month_START
str(cutblock_plots_openings_Huck_ALL_df2b$START_SEASON)

cutblock_plots_openings_Huck_ALL_df2b$START_SEASON<-recode_factor(cutblock_plots_openings_Huck_ALL_df2b$START_SEASON, "01"="Winter", "02"="Winter","03"="Spring","04"="Spring","05"="Spring","06"="Summer", "07"="Summer", "08"="Summer", "09"="Fall", "10" ="Fall", "11"="Fall", "12" ="Winter")

table(cutblock_plots_openings_Huck_ALL_df2b$START_SEASON)

```



#For berry abundance models, plant abundance should be included as a fixed effect (McLelland et al. 2021).



########## Repeat for Buffalo berry


```{r}
buffalo_data<-subset(berry_data, berry_data$Species=="Shepherdia_canadensis")
str(buffalo_data)#208
hist(buffalo_data$CutBlock_Year)
table(buffalo_data$CutBlock_Occurrence) #Suggests that 17 of these were not actually in cutblocks.
table(buffalo_data$CutBlock_Occurrence, buffalo_data$CutBlock_Year) #All 16 not in cutblocks were indicated last harvested in 1900 in Clayton's data
table(buffalo_data$CutBlock_Occurrence, buffalo_data$HARVESTYR) #appears that 13/16 of the plots not harvested were harvested after Clayton's data. Use Clayton's harvest year data as a result. Some data was even collected in 2014 or 2015, so the patches were likely harvested after. Remove all with cutblock_occurence = 0
buffalo_data<-subset(buffalo_data,buffalo_data$CutBlock_Occurrence=="1")
str(buffalo_data) #191 observations

#Inspect presence/absence of huckleberries in data
table(buffalo_data$Species.Present) #88 absences and 103 presences

#I am curious about cutblock size, but I acknowledge that it is not fully representative of the greater area given that adjacent cutblocks could occur before or after this cutblock, making the greater connected area far larger than what this value suggests.

hist(buffalo_data$AREAHA)
hist(buffalo_data$AREA_SQM)


hist(buffalo_data$OPEN_GRSAR)
table(buffalo_data$DN1_DIS_CD) # Mostly L (logged). May want to subset so only have logged
table(buffalo_data$DN2_DIS_CD) #Additional elements
table(buffalo_data$DN1_SILSYS) #79 CCRES (Clearcut with reserves); 82 Clearcut; spattering of others.
table(buffalo_data$PREP1_TECH) # 29 BU (burn), 63 ME (mechanical); spattering of others.

buffalo_data$PREP1_2<-paste(buffalo_data$PREP1_TECH,buffalo_data$PREP2_TECH)
table(buffalo_data$PREP1_2) #210 records of NA, lots of combinations otherwise. Maybe make a column that is yes/no for each technique that is considered important?
table(buffalo_data$BRSH1_TECH) #Brushing technique;37 MA (manual); 8 CG (Chemical Ground); 12 CA (Chemical Air); and others
table(buffalo_data$PLNT1_TECH) #Mostly PL (planting); some FP (Fill Planting); likely not as useful.
hist(buffalo_data$FEAT_AREA)
hist(buffalo_data$PLNT1_AREA) #Also has a Plant2, so could add together for total planting area?

```



If select only logged sites:

```{r}
buffalo_data_logged<-subset(berry_data_logged, berry_data_logged$Species=="Shepherdia_canadensis")

table(buffalo_data_logged$DN1_SILSYS) #May wish to group the smaller groups into an "other" category; or remove
table(buffalo_data_logged$PREP1_TECH) #May wish to remove the 4 MA.

#Compare above with data
table(buffalo_data_logged$Species.Present) #93 absent, 103 present
table(buffalo_data_logged$Species.Present, buffalo_data_logged$PREP1_TECH) #I would remove all small categories
table(buffalo_data_logged$Species.Present, buffalo_data_logged$DN1_SILSYS) #I would remove all small categories

```

Now that we know that we have data that we can play around with, we can add additional information to these. We want to find out information on elements of forestry practices, such as planting density, burning, site prep, etc.


#Other layers with attributes we may want:
https://catalogue.data.gov.bc.ca/dataset/results-activity-treatment-units#edc-pow
https://catalogue.data.gov.bc.ca/dataset/results-forest-cover-silviculture#edc-pow




#Additional code:

Compare to if do intersect in R - do we lose as much data or less?

```{r}
#Load locations within cutblocks
cutblock_plots_gps<- st_read ( dsn = "D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Plots_in_cutblocks_FINAL.shp", stringsAsFactors = T)

#Load openings data
openings_data<- st_read (dsn = "D:\\Hucklberry\\RSLT_OPENING_SVW\\RSLT_OPNGS_polygon.shp", stringsAsFactors = T)

#Combine using "over" from rgeos package - doesn't work because we have sf instead of sp objects. Not sure the proper call so will try again later.
#cutblocks_with_openings<-over(cutblock_plots_gps, openings_data)


```


