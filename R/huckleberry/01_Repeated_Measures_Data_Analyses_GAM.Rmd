---
title: "Repeated_Measures_Data_Analyses"
author: "Cora Skaien"
date: "26/03/2022"
output: html_document
---
<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(data.table)
library(sf)
library(tidyverse)
library(rgeos)
library(cleangeo)
library(dplyr)
library(tidyr)
library(ggplot2)
library(rgdal)
library(sp)
library(keyring)
library(DBI)
library(rgeos)
library(car)
library(rje)
library(caret)
library(pROC)
library(visreg)
library(gtools)
library(mgcv)
library(lme4)
library(forcats)
library(vroom)
library(stringi)
library(gratia)
```

#Overview
This document takes repeated measures data for huckleberry and buffaloberry to assess how variation across time and conditions influence berry abundance. This requires ClimateBC data to be brought in for time t, t-1 and t-2, as well as DEM information, and heatload.

########### HUCKLEBERRY ##############

Assess plots below. In summary, there does not appear to be any relationship with most variables, except perhaps with canopy cover in which berry production peaks at 10% and then perhaps increases again at 35% cover. Not as useful as I had hoped.

#Load in the repeated measures data for huckleberry
```{r}
Huck_RepeatedMeasures<- st_read ( dsn = "C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Laura_Data_Long_RepeatedMeasuresHuck.shp", stringsAsFactors = T) 
crs(Huck_RepeatedMeasures)

Huck_RepeatedMeasures_3005<-st_transform(Huck_RepeatedMeasures, 3005)
crs(Huck_RepeatedMeasures_3005)
```

Append DEM info.

```{r}
DEM_slope <- raster("T:\\FOR\\VIC\\HTS\\ANA\\PROJECTS\\CLUS\\Data\\dem\\all_bc\\slope_ha_bc_3005.tif")
crs(DEM_slope) 

DEM_aspect <- raster("T:\\FOR\\VIC\\HTS\\ANA\\PROJECTS\\CLUS\\Data\\dem\\all_bc\\aspect_ha_bc_3005.tif")
crs(DEM_aspect)

#Elevation
DEM_elevation <- raster("T:\\FOR\\VIC\\HTS\\ANA\\PROJECTS\\CLUS\\Data\\dem\\all_bc\\dem_ha_bc.tif")
crs(DEM_elevation)
crs(Huck_RepeatedMeasures_3005) #Same!

#Stack rasters
rasStack = stack(DEM_slope, DEM_aspect, DEM_elevation)
crs(rasStack) #3005
head(rasStack)
str(rasStack)
extent(rasStack)

Huck_RepeatedMeasures_3005$coords_x1<-st_coordinates(Huck_RepeatedMeasures_3005)
head(Huck_RepeatedMeasures_3005)

pointCoordinates<-data.frame(Huck_RepeatedMeasures_3005$coords_x1[,1], Huck_RepeatedMeasures_3005$coords_x1[,2])
head(pointCoordinates)

DEM_huck1=raster::extract(rasStack, pointCoordinates)
head(DEM_huck1)

#Append
Huck_RepeatedMeasures_3005<-cbind(Huck_RepeatedMeasures_3005, DEM_huck1)
head(Huck_RepeatedMeasures_3005)
```

Combine soils data.

```{r}
cofrag <- raster("C:\\cora\\Hucklberry\\Soil_Layers_Clayton\\cofrag_3005.tif")
orgcarb <- raster("C:\\cora\\Hucklberry\\Soil_Layers_Clayton\\orgcarb_3005.tif")
PH2 <- raster("C:\\cora\\Hucklberry\\Soil_Layers_Clayton\\ph2_3005.tif")
phca <- raster("C:\\cora\\Hucklberry\\Soil_Layers_Clayton\\phca_3005.tif")
tclay <- raster("C:\\cora\\Hucklberry\\Soil_Layers_Clayton\\tclay_3005.tif")
tsand <- raster("C:\\cora\\Hucklberry\\Soil_Layers_Clayton\\tsand_3005.tif")
tsilt <- raster("C:\\cora\\Hucklberry\\Soil_Layers_Clayton\\tsilt_3005.tif")
vfsand <- raster("C:\\cora\\Hucklberry\\Soil_Layers_Clayton\\vfsand_3005.tif")

#Check crs
crs(cofrag) #ESPG 3005
crs(vfsand) #3005

SoilStack<- stack(cofrag, orgcarb, PH2, phca, tclay, tsand, tsilt, vfsand)
crs(SoilStack) #ESPG 3005

#Extract values from SoilStack_2 for GPS coordinates in data file
SOIL_huck_repeat=raster::extract(SoilStack, pointCoordinates)
head(SOIL_huck_repeat) #Looks good

#Combine back into original data set
Huck_RepeatedMeasures_3005<-cbind(Huck_RepeatedMeasures_3005, SOIL_huck_repeat)
head(Huck_RepeatedMeasures_3005)
```

Remove geometry.
```{r}
Huck_RepeatedMeasures_3005_df<-st_drop_geometry(Huck_RepeatedMeasures_3005)
```

bring in Climate data for t, t-1 and t-2.

#2011
```{r}
huck_repeat_2011_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2011_Year_2011MSY.csv")
head(huck_repeat_2011_0)

huck_repeat_2011_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2011_Year_2010MSY.csv")
head(huck_repeat_2011_1)

huck_repeat_2011_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2011_Year_2009MSY.csv")
head(huck_repeat_2011_2)

huck_repeated_2011<-cbind(huck_repeat_2011_0, huck_repeat_2011_1, huck_repeat_2011_2)
names(huck_repeated_2011)

#Remove duplicated columns
huck_repeated_2011<-huck_repeated_2011[-(541:545)]
huck_repeated_2011<-huck_repeated_2011[-(271:275)]
huck_repeated_2011<-huck_repeated_2011[-(5)]

```

#2012
```{r}
huck_repeat_2012_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2012_Year_2012MSY.csv")
head(huck_repeat_2012_0)

huck_repeat_2012_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2012_Year_2011MSY.csv")
head(huck_repeat_2012_1)

huck_repeat_2012_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2012_Year_2010MSY.csv")
head(huck_repeat_2012_2)

huck_repeated_2012<-cbind(huck_repeat_2012_0, huck_repeat_2012_1, huck_repeat_2012_2)
names(huck_repeated_2012)

#Remove duplicated columns
huck_repeated_2012<-huck_repeated_2012[-(541:545)]
huck_repeated_2012<-huck_repeated_2012[-(271:275)]
huck_repeated_2012<-huck_repeated_2012[-(5)]

```

#2013
```{r}
huck_repeat_2013_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2013_Year_2013MSY.csv")
head(huck_repeat_2013_0)

huck_repeat_2013_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2013_Year_2012MSY.csv")
head(huck_repeat_2013_1)

huck_repeat_2013_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2013_Year_2011MSY.csv")
head(huck_repeat_2013_2)

huck_repeated_2013<-cbind(huck_repeat_2013_0, huck_repeat_2013_1, huck_repeat_2013_2)
names(huck_repeated_2013)

#Remove duplicated columns
huck_repeated_2013<-huck_repeated_2013[-(541:545)]
huck_repeated_2013<-huck_repeated_2013[-(271:275)]
huck_repeated_2013<-huck_repeated_2013[-(5)]

```

#2014
```{r}
huck_repeat_2014_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2014_Year_2014MSY.csv")
head(huck_repeat_2014_0)

huck_repeat_2014_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2014_Year_2013MSY.csv")
head(huck_repeat_2014_1)

huck_repeat_2014_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2014_Year_2012MSY.csv")
head(huck_repeat_2014_2)

huck_repeated_2014<-cbind(huck_repeat_2014_0, huck_repeat_2014_1, huck_repeat_2014_2)
names(huck_repeated_2014)

#Remove duplicated columns
huck_repeated_2014<-huck_repeated_2014[-(541:545)]
huck_repeated_2014<-huck_repeated_2014[-(271:275)]
huck_repeated_2014<-huck_repeated_2014[-(5)]

```

#2015
```{r}
huck_repeat_2015_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2015_Year_2015MSY.csv")
head(huck_repeat_2015_0)

huck_repeat_2015_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2015_Year_2014MSY.csv")
head(huck_repeat_2015_1)

huck_repeat_2015_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2015_Year_2013MSY.csv")
head(huck_repeat_2015_2)

huck_repeated_2015<-cbind(huck_repeat_2015_0, huck_repeat_2015_1, huck_repeat_2015_2)
names(huck_repeated_2015)

#Remove duplicated columns
huck_repeated_2015<-huck_repeated_2015[-(541:545)]
huck_repeated_2015<-huck_repeated_2015[-(271:275)]
huck_repeated_2015<-huck_repeated_2015[-(5)]

```

#2016
```{r}
huck_repeat_2016_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2016_Year_2016MSY.csv")
head(huck_repeat_2016_0)

huck_repeat_2016_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2016_Year_2015MSY.csv")
head(huck_repeat_2016_1)

huck_repeat_2016_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2016_Year_2014MSY.csv")
head(huck_repeat_2016_2)

huck_repeated_2016<-cbind(huck_repeat_2016_0, huck_repeat_2016_1, huck_repeat_2016_2)
names(huck_repeated_2016)

#Remove duplicated columns
huck_repeated_2016<-huck_repeated_2016[-(541:545)]
huck_repeated_2016<-huck_repeated_2016[-(271:275)]
huck_repeated_2016<-huck_repeated_2016[-(5)]

```

#2017
```{r}
huck_repeat_2017_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2017_Year_2017MSY.csv")
head(huck_repeat_2017_0)

huck_repeat_2017_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2017_Year_2016MSY.csv")
head(huck_repeat_2017_1)

huck_repeat_2017_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2017_Year_2015MSY.csv")
head(huck_repeat_2017_2)

huck_repeated_2017<-cbind(huck_repeat_2017_0, huck_repeat_2017_1, huck_repeat_2017_2)
names(huck_repeated_2017)

#Remove duplicated columns
huck_repeated_2017<-huck_repeated_2017[-(541:545)]
huck_repeated_2017<-huck_repeated_2017[-(271:275)]
huck_repeated_2017<-huck_repeated_2017[-(5)]

```


#2018
```{r}
huck_repeat_2018_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2018_Year_2018MSY.csv")
head(huck_repeat_2018_0)

huck_repeat_2018_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2018_Year_2017MSY.csv")
head(huck_repeat_2018_1)

huck_repeat_2018_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2018_Year_2016MSY.csv")
head(huck_repeat_2018_2)

huck_repeated_2018<-cbind(huck_repeat_2018_0, huck_repeat_2018_1, huck_repeat_2018_2)
names(huck_repeated_2018)

#Remove duplicated columns
huck_repeated_2018<-huck_repeated_2018[-(541:545)]
huck_repeated_2018<-huck_repeated_2018[-(271:275)]
huck_repeated_2018<-huck_repeated_2018[-(5)]

```

#2019
```{r}
huck_repeat_2019_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2019_Year_2019MSY.csv")
head(huck_repeat_2019_0)

huck_repeat_2019_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2019_Year_2018MSY.csv")
head(huck_repeat_2019_1)

huck_repeat_2019_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2019_Year_2017MSY.csv")
head(huck_repeat_2019_2)

huck_repeated_2019<-cbind(huck_repeat_2019_0, huck_repeat_2019_1, huck_repeat_2019_2)
names(huck_repeated_2019)

#Remove duplicated columns
huck_repeated_2019<-huck_repeated_2019[-(541:545)]
huck_repeated_2019<-huck_repeated_2019[-(271:275)]
huck_repeated_2019<-huck_repeated_2019[-(5)]

```

#2020
```{r}
huck_repeat_2020_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2020_Year_2020MSY.csv")
head(huck_repeat_2020_0)

huck_repeat_2020_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2020_Year_2019MSY.csv")
head(huck_repeat_2020_1)

huck_repeat_2020_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2020_Year_2018MSY.csv")
head(huck_repeat_2020_2)

huck_repeated_2020<-cbind(huck_repeat_2020_0, huck_repeat_2020_1, huck_repeat_2020_2)
names(huck_repeated_2020)

#Remove duplicated columns
huck_repeated_2020<-huck_repeated_2020[-(541:545)]
huck_repeated_2020<-huck_repeated_2020[-(271:275)]
huck_repeated_2020<-huck_repeated_2020[-(5)]

```

#2021
```{r}
#There currently is no 2021 data yet in ClimateBC as of March 2022
#huck_repeat_2021_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2021_Year_2021MSY.csv")
#head(huck_repeat_2021_0)

huck_repeat_2021_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2021_Year_2020MSY.csv")
head(huck_repeat_2021_1)

huck_repeat_2021_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_RepeatedMeasures Huckleberry\\Repeated_Measures_Huckleberry_Long_2021_Year_2019MSY.csv")
head(huck_repeat_2021_2)

#huck_repeated_2021<-cbind(huck_repeat_2021_0, huck_repeat_2021_1, huck_repeat_2021_2)
huck_repeated_2021<-cbind(huck_repeat_2021_1, huck_repeat_2021_2)
names(huck_repeated_2021)

#Remove duplicated columns
#huck_repeated_2021<-huck_repeated_2021[-(541:545)]
huck_repeated_2021<-huck_repeated_2021[-(271:275)]
huck_repeated_2021<-huck_repeated_2021[-(5)]

```

Combine data sets. First will need to get same column names in the 2021 data.

```{r}
huck_repeated_2021[setdiff(names(huck_repeated_2020), names(huck_repeated_2021))] <- NA
head(huck_repeated_2021)
```


```{r}
huck_repeated_climate_data<-rbind(huck_repeated_2020, huck_repeated_2019, huck_repeated_2018, huck_repeated_2017, huck_repeated_2016, huck_repeated_2015, huck_repeated_2014, huck_repeated_2013, huck_repeated_2012, huck_repeated_2011) 

huck_repeated_climate_data2<-smartbind(huck_repeated_climate_data, huck_repeated_2021)

head(huck_repeated_climate_data2)
huck_repeated_climate_data2$Tave01_0
```

Combine data together.

```{r}
Huck_RepeatedMeasures_3005_df_b<-left_join(Huck_RepeatedMeasures_3005_df, huck_repeated_climate_data2, by="ID")
head(Huck_RepeatedMeasures_3005_df_b)
```

#Add heatload
```{r}
# Function "heatload"
# Calculates heat load or potential annual direct incident radiation, using the formulas published in 
# McCune & Keon (2002) based on aspect, slope and latitude.
 
heatload <- function (aspect, slope, latitude, method = 'heatload', units = 'degrees', equation = 1)
{
  if (units == 'degrees')   # convert degrees to radians
    {
    aspect <- aspect/180*pi
    slope <- slope/180*pi
    aspect[slope == 0] <- 0
    latitude <- latitude/180*pi
    }  
  A <- if (method == 'heatload') abs (pi - abs (aspect - (5*pi/4))) else pi - abs (aspect-pi)
  S <- slope
  L <- if (length (latitude) == 1) rep (latitude, length (A)) else latitude
  if (equation == 1) res <- exp (-1.467 +1.582*cos(L)*cos(S) -1.500*cos(A)*sin(S)*sin(L) -0.262*sin(L)*sin(S) +0.607*sin(A)*sin(S))
  if (equation == 2) res <- exp (-1.236 +1.350*cos(L)*cos(S) -1.376*cos(A)*sin(S)*sin(L) -0.331*sin(L)*sin(S) +0.375*sin(A)*sin(S))
  if (equation == 3) res <-      +0.339 +0.808*cos(L)*cos(S)                             -0.196*sin(L)*sin(S)                       - 0.482*cos(A)*sin(S)
  return (res)
}
```

```{r}
Huck_RepeatedMeasures_3005_df_b$heatload <- heatload (aspect = Huck_RepeatedMeasures_3005_df_b$aspect_ha_bc, slope = Huck_RepeatedMeasures_3005_df_b$slope_ha_bc, latitude = Huck_RepeatedMeasures_3005_df_b$Lat, equation = 3)
 
Huck_RepeatedMeasures_3005_df_b$heatload 
hist(Huck_RepeatedMeasures_3005_df_b$heatload)
```


#Combine some variables together given prior literature.
Notes: spring GDD (April-June), July temp range (these from the Holden paper).  Probably better just to use heatload. Need a moisture variable too but what?
Shep model may include: crown closure, plant height, July rain previous year, heatload.
Need moisture variable: July rainfall or PAS?
Growing degree days from April to June and July temperature explaining 70% of variation in one study
Huckleberry: May rainfall and July temp

```{r}
#Need to make "_0" variables numeric given NAs from 2021 missing data
Huck_RepeatedMeasures_3005_df_b$DD5_04_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$DD5_04_0)
Huck_RepeatedMeasures_3005_df_b$DD5_05_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$DD5_05_0)
Huck_RepeatedMeasures_3005_df_b$DD5_06_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$DD5_06_0)

#Make spring growing degree day variables
Huck_RepeatedMeasures_3005_df_b$GDD2_sp_0<-(Huck_RepeatedMeasures_3005_df_b$DD5_04_0 + Huck_RepeatedMeasures_3005_df_b$DD5_05_0 + Huck_RepeatedMeasures_3005_df_b$DD5_06_0)

Huck_RepeatedMeasures_3005_df_b$GDD2_sp_1<-(Huck_RepeatedMeasures_3005_df_b$DD5_04_1 + Huck_RepeatedMeasures_3005_df_b$DD5_05_1 + Huck_RepeatedMeasures_3005_df_b$DD5_06_1)

Huck_RepeatedMeasures_3005_df_b$GDD2_sp_2<-(Huck_RepeatedMeasures_3005_df_b$DD5_04_2 + Huck_RepeatedMeasures_3005_df_b$DD5_05_2 + Huck_RepeatedMeasures_3005_df_b$DD5_06_2)

```

Make Number of Frost Free Days in spring.

```{r}
#Make numeric
Huck_RepeatedMeasures_3005_df_b$NFFD04_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$NFFD04_0)
Huck_RepeatedMeasures_3005_df_b$NFFD05_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$NFFD05_0)
Huck_RepeatedMeasures_3005_df_b$NFFD06_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$NFFD06_0)

Huck_RepeatedMeasures_3005_df_b$NFFD2_sp_0<-(Huck_RepeatedMeasures_3005_df_b$NFFD04_0 + Huck_RepeatedMeasures_3005_df_b$NFFD05_0 + Huck_RepeatedMeasures_3005_df_b$NFFD06_0)

Huck_RepeatedMeasures_3005_df_b$NFFD2_sp_1<-(Huck_RepeatedMeasures_3005_df_b$NFFD04_1 + Huck_RepeatedMeasures_3005_df_b$NFFD05_1 + Huck_RepeatedMeasures_3005_df_b$NFFD06_1)

Huck_RepeatedMeasures_3005_df_b$NFFD2_sp_2<-(Huck_RepeatedMeasures_3005_df_b$NFFD04_2 + Huck_RepeatedMeasures_3005_df_b$NFFD05_2 + Huck_RepeatedMeasures_3005_df_b$NFFD06_2)
```


Make fruit count numeric.
```{r}
Huck_RepeatedMeasures_3005_df_b$Fruit_Coun<-as.numeric(Huck_RepeatedMeasures_3005_df_b$Fruit_Coun)
```

Inspect patterns by plotID.

```{r}
table(Huck_RepeatedMeasures_3005_df_b$ID) #One of every case because year is included
table(Huck_RepeatedMeasures_3005_df_b$ID2) #One of every instance, but as a number
names(Huck_RepeatedMeasures_3005_df_b)
table(Huck_RepeatedMeasures_3005_df_b$Site_ID)
table(Huck_RepeatedMeasures_3005_df_b$Distance)

Huck_RepeatedMeasures_3005_df_b$ID3<-paste(Huck_RepeatedMeasures_3005_df_b$Site_ID, Huck_RepeatedMeasures_3005_df_b$Distance)
table(Huck_RepeatedMeasures_3005_df_b$ID3)
```


```{r}
Huck_RepeatedMeasures_3005_df_b_0<-subset(Huck_RepeatedMeasures_3005_df_b, Huck_RepeatedMeasures_3005_df_b$GDD2_sp_0!="NA")

ggplot (Huck_RepeatedMeasures_3005_df_b_0, aes (x = GDD2_sp_0, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Growing Degree Days April-June (t)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = GDD2_sp_1, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Growing Degree Days April-June (t-1)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = GDD2_sp_2, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Growing Degree Days April-June (t-2)",
        y = "Fruit Abundance") 
```

Having difficulties plotting by ID sometimes.

```{r}
ggplot (Huck_RepeatedMeasures_3005_df_b_0, aes (x = GDD2_sp_0, y = Fruit_Coun)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (
        x = "Growing Degree Days April-June (t)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = GDD2_sp_1, y = Fruit_Coun)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (
        x = "Growing Degree Days April-June (t-1)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = GDD2_sp_2, y = Fruit_Coun)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (
        x = "Growing Degree Days April-June (t-2)",
        y = "Fruit Abundance") 
```

Number of Frost free Days.
```{r}
ggplot (Huck_RepeatedMeasures_3005_df_b_0, aes (x = NFFD2_sp_0, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Frost Free Days April-June (t)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = NFFD2_sp_1, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Frost Free Days April-June (t-1)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = NFFD2_sp_2, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Frost Free Days April-June (t-2)",
        y = "Fruit Abundance") 
```


July rainfall.

```{r}
Huck_RepeatedMeasures_3005_df_b_0$PPT07_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b_0$PPT07_0)
```

```{r}
ggplot (Huck_RepeatedMeasures_3005_df_b_0, aes (x = PPT07_0, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "July rainfall (t)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = PPT07_1, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "July rainfall (t-1)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = PPT07_2, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "July rainfall (t-2)",
        y = "Fruit Abundance") 
```


```{r}
ggplot (Huck_RepeatedMeasures_3005_df_b_0, aes (x = PPT07_0, y = Fruit_Coun)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (
        x = "July rainfall (t)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = PPT07_1, y = Fruit_Coun)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (
        x = "July rainfall (t-1)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = PPT07_2, y = Fruit_Coun)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (
        x = "July rainfall (t-2)",
        y = "Fruit Abundance") 
```

Heatload.

```{r}
ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = heatload, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Heatload",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = heatload, y = Fruit_Coun)) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Heatload",
        y = "Fruit Abundance") 
```

Plant characteristics.

```{r}
Huck_RepeatedMeasures_3005_df_b$Plant_Heig<-as.numeric(Huck_RepeatedMeasures_3005_df_b$Plant_Heig)

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = Plant_Heig, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Plant Height (cm)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = Plant_Heig, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Plant Height (cm)",
        y = "Fruit Abundance") 
```

```{r}
Huck_RepeatedMeasures_3005_df_b$Species_Co<-as.numeric(Huck_RepeatedMeasures_3005_df_b$Species_Co)

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = Species_Co, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Plant Cover (%)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = Species_Co, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Plant Cover (%)",
        y = "Fruit Abundance") 
```

Canopy Cover.
```{r}
Huck_RepeatedMeasures_3005_df_b$Canopy_Cov<-as.numeric(Huck_RepeatedMeasures_3005_df_b$Canopy_Cov)

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = Canopy_Cov, y = Fruit_Coun, colour = factor(ID3))) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Canopy Cover (%)",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = Canopy_Cov, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Canopy Cover (%)",
        y = "Fruit Abundance") 
```

Soil characteristics. Except these will be the same for each location across years.

```{r}
ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = tsand_3005, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Sand",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = cofrag_3005, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Coarse Fragments",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = orgcarb_3005, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Organic Carbon",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = ph2_3005, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "pH",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = tsilt_3005, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Silt",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = tclay_3005, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Clay",
        y = "Fruit Abundance") 
```

DEM (also same between years).

```{r}
ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = dem_ha_bc, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Elevation",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = slope_ha_bc_3005, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Slope",
        y = "Fruit Abundance") 

ggplot (Huck_RepeatedMeasures_3005_df_b, aes (x = aspect_ha_bc_3005, y = Fruit_Coun) ) +
  geom_point () +
  geom_smooth (se=F) +
  theme(legend.position="none") +
  labs (
        x = "Aspect",
        y = "Fruit Abundance") 
```

try a quick analysis?

```{r}
hist(Huck_RepeatedMeasures_3005_df_b$Fruit_Coun) #Pretty skewed
table(Huck_RepeatedMeasures_3005_df_b$Fruit_Coun)
#Try nbinom2 instead of Poisson

library(glmmTMB)
library(car)
library(visreg)
#Try a simple one, using the ID3 as a random effect
huck.m1<-glmmTMB(Fruit_Coun~Canopy_Cov + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m1, type=3) #Not important here, but we also do not expect it to be linear
summary(huck.m1, type=3) 

#Growing Degree Days
huck.m2<-glmmTMB(Fruit_Coun~GDD2_sp_0 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m2, type=3) #Not important

huck.m2<-glmmTMB(Fruit_Coun~GDD2_sp_1 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m2, type=3) #Important
summary(huck.m2)
visreg(huck.m2, "GDD2_sp_1") #Slight positive relationship, mostly flat

huck.m2<-glmmTMB(Fruit_Coun~GDD2_sp_2 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m2, type=3) #Not important

cor(Huck_RepeatedMeasures_3005_df_b$GDD2_sp_0, Huck_RepeatedMeasures_3005_df_b$GDD2_sp_1, use = "complete.obs") #0.82

cor(Huck_RepeatedMeasures_3005_df_b$GDD2_sp_0, Huck_RepeatedMeasures_3005_df_b$GDD2_sp_2, use = "complete.obs") #0.73

cor(Huck_RepeatedMeasures_3005_df_b$GDD2_sp_2, Huck_RepeatedMeasures_3005_df_b$GDD2_sp_1, use = "complete.obs") #0.85

#Precip July
Huck_RepeatedMeasures_3005_df_b$PPT07_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$PPT07_0)

huck.m3<-glmmTMB(Fruit_Coun~PPT07_0 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m3, type=3) #Not Important
summary(huck.m3)
visreg(huck.m3, "PPT07_0") #Pretty flat

huck.m3<-glmmTMB(Fruit_Coun~PPT07_1 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m3, type=3) #Not Important
summary(huck.m3)

huck.m3<-glmmTMB(Fruit_Coun~PPT07_2 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m3, type=3) #Not Important
summary(huck.m3)

cor(Huck_RepeatedMeasures_3005_df_b$PPT07_0, Huck_RepeatedMeasures_3005_df_b$PPT07_1, use = "complete.obs") #-0.31

cor(Huck_RepeatedMeasures_3005_df_b$PPT07_0, Huck_RepeatedMeasures_3005_df_b$PPT07_2, use = "complete.obs") #-0.26

cor(Huck_RepeatedMeasures_3005_df_b$PPT07_2, Huck_RepeatedMeasures_3005_df_b$PPT07_1, use = "complete.obs") #-0.09

#Number Frost Free Days
huck.m4<-glmmTMB(Fruit_Coun~NFFD2_sp_0 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m4, type=3) #Not important

huck.m4<-glmmTMB(Fruit_Coun~NFFD2_sp_1 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m4, type=3) #Important
visreg(huck.m4, "NFFD2_sp_1") #Pretty flat, slight positive

huck.m4<-glmmTMB(Fruit_Coun~NFFD2_sp_2 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m4, type=3) #Not important, but just barely

cor(Huck_RepeatedMeasures_3005_df_b$NFFD2_sp_0, Huck_RepeatedMeasures_3005_df_b$NFFD2_sp_1, use = "complete.obs") #-0.85

cor(Huck_RepeatedMeasures_3005_df_b$NFFD2_sp_0, Huck_RepeatedMeasures_3005_df_b$NFFD2_sp_2, use = "complete.obs") #-0.80

cor(Huck_RepeatedMeasures_3005_df_b$NFFD2_sp_2, Huck_RepeatedMeasures_3005_df_b$NFFD2_sp_1, use = "complete.obs") #-0.86
```

From the above, it is suggested that of what has been investigated, the variables of potential interest include:
1. Spring Growing Degree Days at t-1
2. Number of Frost Free Days at t-1

```{r}
huck.m5<-glmmTMB(Fruit_Coun~NFFD2_sp_1 + GDD2_sp_1 + Canopy_Cov + PPT07_0 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m5, type=3) #Nothing

huck.m5<-glmmTMB(Fruit_Coun~NFFD2_sp_1 + GDD2_sp_1 + Canopy_Cov + PPT07_0 + PPT07_1 + PPT07_2 + (1|ID3), family = nbinom2, data=Huck_RepeatedMeasures_3005_df_b)
Anova(huck.m5, type=3) #Nothing
summary(huck.m5) 

library(visreg)
visreg(huck.m5, "Canopy_Cov") #Looks pretty flat to me; slight negative
visreg(huck.m5, "GDD2_sp_1") #Slight negative; pretty flat
visreg(huck.m5, "NFFD2_sp_1") #Slight positive
visreg(huck.m5, "PPT07_0") #Pretty flat
visreg(huck.m5, "PPT07_1") #pretty flat
visreg(huck.m5, "PPT07_2") #slight positive
```

Explore as a GAM because we know that Canopy Cover, for example, is not linear.

```{r}
library(mgcv)
library(lme4)
library(forcats)
library(vroom)

#Must convert to factor first
Huck_RepeatedMeasures_3005_df_b$ID3<-as.factor(Huck_RepeatedMeasures_3005_df_b$ID3)

#Models
huck.m6<-gam(Fruit_Coun~ s(GDD2_sp_1) + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML")
gam.check(huck.m6) #Values suggest K too low

huck.m6<-gam(Fruit_Coun~ s(GDD2_sp_1, k=20) + s(Canopy_Cov, k=20) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML")
gam.check(huck.m6) #Values suggest K too low - still same values, so not that k was too low.
anova(huck.m6)
visreg(huck.m6, "GDD2_sp_1")
visreg(huck.m6, "Canopy_Cov")

huck.m6<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(GDD2_sp_1) + s(Canopy_Cov) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML")
gam.check(huck.m6) #Worked better
gam.check(huck.m6, rep=500)

anova(huck.m6)
visreg(huck.m6, "GDD2_sp_1")
visreg(huck.m6, "Canopy_Cov")
visreg(huck.m6, "NFFD2_sp_1")
visreg(huck.m6, "PPT07_0")
visreg(huck.m6, "PPT07_1")
visreg(huck.m6, "PPT07_2")

huck.m6<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(GDD2_sp_1) + s(Canopy_Cov) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + ti(PPT07_0, PPT07_1) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML")
anova(huck.m6) #Interaction not significant
visreg(huck.m6, "GDD2_sp_1")
visreg(huck.m6, "Canopy_Cov")
visreg(huck.m6, "NFFD2_sp_1")
visreg(huck.m6, "PPT07_0")
visreg(huck.m6, "PPT07_1")
visreg(huck.m6, "PPT07_2")

huck.m6<-gam(Fruit_Coun ~ s(NFFD2_sp_1) + s(GDD2_sp_1) + s(Canopy_Cov) + s(PPT07_0) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b)


huck.m6<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0) + s(GDD2_sp_1) + s(GDD2_sp_0) + s(GDD2_sp_2) + s(Canopy_Cov) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML")
gam.check(huck.m6) #Worked better
gam.check(huck.m6, rep=500)

huck.m6<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0) + s(GDD2_sp_1) + s(GDD2_sp_0) + s(GDD2_sp_2) + s(Canopy_Cov) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m6, rep=500)
summary(huck.m6)

visreg(huck.m6, "GDD2_sp_0")
visreg(huck.m6, "GDD2_sp_1")
visreg(huck.m6, "GDD2_sp_2")
visreg(huck.m6, "Canopy_Cov")
visreg(huck.m6, "NFFD2_sp_0")
visreg(huck.m6, "NFFD2_sp_1")
visreg(huck.m6, "NFFD2_sp_2")
visreg(huck.m6, "PPT07_0")
visreg(huck.m6, "PPT07_1")
visreg(huck.m6, "PPT07_2")

#Can also try gratia package
library(gratia)
draw(huck.m6, scales= 'fixed')

Huck_RepeatedMeasures_3005_df_b$PAS_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$PAS_0)

huck.m6<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0) + s(GDD2_sp_1) + s(GDD2_sp_0) + s(GDD2_sp_2) + s(Canopy_Cov) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + s(PAS_0) + s(PAS_1) + s(PAS_2) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m6, rep=500)
summary(huck.m6)

draw(huck.m6, scales= 'fixed')

#Likely too many variables at this stage
Huck_RepeatedMeasures_3005_df_b$MWMT_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$MWMT_0)

huck.m6<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0) + s(GDD2_sp_1) + s(GDD2_sp_0) + s(GDD2_sp_2) + s(Canopy_Cov) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + s(PAS_0) + s(PAS_1) + s(PAS_2) + s(MWMT_0) + s(MWMT_1) + s(MWMT_2) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m6, rep=500)
summary(huck.m6) #26.1% deviance explained

draw(huck.m6, scales= 'fixed')

#Due to low power, what happens if we only keep those as significant above? And some from prior literature.

huck.m6b<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(GDD2_sp_1) + s(GDD2_sp_2) + s(Canopy_Cov) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m6b, rep=500)
summary(huck.m6b)

draw(huck.m6b, scales= 'fixed')

huck.m6b<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m6b, rep=500)
summary(huck.m6b)

draw(huck.m6b, scales= 'fixed')

visreg(huck.m6b, "NFFD2_sp_1")
visreg(huck.m6b, "PPT07_2")
visreg(huck.m6b, "PAS_0")
visreg(huck.m6b, "MWMT_1")
#Remained at 26.1% deviance explained

#Other variables of interest?
Huck_RepeatedMeasures_3005_df_b$Tave_wt_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$Tave_wt_0)

huck.m6<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0) + s(GDD2_sp_1) + s(GDD2_sp_0) + s(GDD2_sp_2) + s(Canopy_Cov) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + s(PAS_0) + s(PAS_1) + s(PAS_2) + s(MWMT_0) + s(MWMT_1) + s(MWMT_2) + s(Tave_wt_0) + s(Tave_wt_1) + s(Tave_wt_2) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m6, rep=500)
summary(huck.m6) #24.9% deviance explained -- poorer results and different variables

draw(huck.m6, scales= 'fixed')

#Check with fewer
huck.m6b<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m6b, rep=500)
summary(huck.m6b) #26.4% variance explained

draw(huck.m6b, scales= 'fixed')
visreg(huck.m6b, "NFFD2_sp_1")
visreg(huck.m6b, "PPT07_2")
visreg(huck.m6b, "PAS_0")
visreg(huck.m6b, "MWMT_1")
visreg(huck.m6b, "Tave_wt_2")


#Compare to Poisson
#Check with fewer
huck.m6c<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(ID3, bs="re"), family = poisson, data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m6c, rep=500)
summary(huck.m6c) #58.3% but wildly overdispersed

draw(huck.m6c, scales= 'fixed')

#Remember to add plant height or cover and assess
Huck_RepeatedMeasures_3005_df_b$Plant_Heig

huck.m6d<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(Plant_Heig) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m6d, rep=500)
summary(huck.m6d) #26.4% variance explained

draw(huck.m6d, scales= 'fixed')
visreg(huck.m6d, "NFFD2_sp_1")
visreg(huck.m6d, "PPT07_2")
visreg(huck.m6d, "PAS_0")
visreg(huck.m6d, "MWMT_1")
visreg(huck.m6d, "Tave_wt_2")
visreg(huck.m6d, "Plant_Heig")

#Check May rainfall and July temp
Huck_RepeatedMeasures_3005_df_b$Tmax07_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$Tmax07_0)
Huck_RepeatedMeasures_3005_df_b$Tave07_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$Tave07_0)
Huck_RepeatedMeasures_3005_df_b$PPT05_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$PPT05_0)
Huck_RepeatedMeasures_3005_df_b$Tave05_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$Tave05_0)
Huck_RepeatedMeasures_3005_df_b$Tmax05_0<-as.numeric(Huck_RepeatedMeasures_3005_df_b$Tmax05_0)

huck.m7<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_2) + s(PPT05_0) + s(Tave07_2) + s(Tave07_1) + (Tave07_0) + s(Tmax07_2) + s(Tmax07_1) + (Tmax07_0)+ s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m7, rep=500)
summary(huck.m7) #26.4% variance explained

huck.m7b<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_2) + s(PPT05_0) + s(Tave07_2) + s(Tave07_1) + (Tave07_0) + s(Tmax07_2) + s(Tmax07_1) + (Tmax07_0)+ s(ID3, bs="re"), family = nb, data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m7b, rep=500)
summary(huck.m7b) #15.1% variance explained

draw(huck.m7, scales= 'fixed')
visreg(huck.m6d, "NFFD2_sp_1")
visreg(huck.m6d, "PPT07_2")
visreg(huck.m6d, "PAS_0")
visreg(huck.m6d, "MWMT_1")
visreg(huck.m6d, "Tave_wt_2")
visreg(huck.m6d, "Plant_Heig")

#Investigate with fewer
huck.m8<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_2) + s(PPT05_0) + s(Tave07_2) + s(Tave07_1) + s(Tave07_0) + s(Tmax07_2) + s(Tmax07_1) + s(Tmax07_0) + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8, rep=500)
summary(huck.m8) #26.8% variance explained

#Investigate either tave or tmax
huck.m8b<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_2) + s(PPT05_0) + s(Tave07_2) + s(Tave07_1) + s(Tave07_0) + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8b, rep=500)
summary(huck.m8b) #26.6% variance explained

AIC(huck.m8, huck.m8b) #AIC lower for more complex model

#
huck.m8c<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_2) + s(PPT05_0) + s(Tmax07_2) + s(Tmax07_1) + s(Tmax07_0) + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8c, rep=500)
summary(huck.m8c) #26.3% variance explained

AIC(huck.m8, huck.m8c) #huck.m8 lower AIC
AIC(huck.m8c, huck.m8b) #huck.m8b lower AIC

#Repeat for May instead of July
huck.m8d<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_2) + s(PPT05_0) + s(Tave05_2) + s(Tave05_1) + s(Tave05_0) + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8d, rep=500)
summary(huck.m8d) #27.2% variance explained

AIC(huck.m8, huck.m8d) #AIC same
AIC(huck.m8d, huck.m8b) #AIC better m8d


#
huck.m8e<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1)  +  s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_2) + s(PPT05_0) + s(Tmax05_2) + s(Tmax05_1) + s(Tmax05_0) + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8e, rep=500)
summary(huck.m8e) #26.3% variance explained

AIC(huck.m8, huck.m8e) #huck.m8e better
AIC(huck.m8d, huck.m8e) # huck.m8e better

#Take top model above and investigate increasing k for Canopy Cover and MWMT as these have p<0.05 for smoothness
huck.m8f<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1, k=15)  +  s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_2) + s(PPT05_0) + s(Tmax05_2) + s(Tmax05_1) + s(Tmax05_0) + s(Canopy_Cov, k=15) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8f, rep=500)
summary(huck.m8f) #26.1% variance explained

AIC(huck.m8e, huck.m8f) # much better huck.m8e

#Take one with best AIC above and explore adding and ropping variables
huck.m8f<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(NFFD2_sp_0) + s(PPT07_2) + s(PAS_0) + s(MWMT_1) + s(GDD2_sp_0) + s(MWMT_0) + s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_2) + s(PPT05_0) + s(Tmax05_2) + s(Tmax05_1) + s(Tmax05_0) + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8f, rep=500)
summary(huck.m8f) #26.4% variance explained

AIC(huck.m8f, huck.m8e) #huck.m8e better

huck.m8f<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(NFFD2_sp_0) + s(PPT07_2) + s(PAS_0) + s(MWMT_1) + s(GDD2_sp_0) + s(MWMT_0) + s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_0) + s(Tmax05_0) + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8f, rep=500)
summary(huck.m8f) #26.5% variance explained

AIC(huck.m8f, huck.m8e) #huck.m8e better

#Reduce more variables really not significant
huck.m8f<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(NFFD2_sp_0) + s(PPT07_2) + s(PAS_0) + s(MWMT_1) + s(MWMT_0) + s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_1) + s(PPT05_0)  + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8f, rep=500)
summary(huck.m8f) #26.5% variance explained

AIC(huck.m8f, huck.m8e) #huck.m8e better

#Reduce more variables really not significant
huck.m8f<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(MWMT_1) + s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_0)  + s(Canopy_Cov) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8f, rep=500)
summary(huck.m8f) #26.5% variance explained

AIC(huck.m8f, huck.m8e) #huck.m8e better

#Reduce more variables really not significant
huck.m8f<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(Tave_wt_2) + s(Plant_Heig) + s(PPT05_0)  + s(Canopy_Cov, k=12) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8f, rep=500)
summary(huck.m8f) #26.3% variance explained

AIC(huck.m8f, huck.m8e) #Equivalent

#Reduce more variables really not significant
huck.m8g<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(Tave_wt_2) + s(PPT05_0) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8g, rep=500)
summary(huck.m8g) #26.3% variance explained

AIC(huck.m8f, huck.m8g) #huck.m8g better

#Reduce more variables really not significant
huck.m8h<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(Tave_wt_2) + s(PPT05_0) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8h, rep=500)
summary(huck.m8h) #25.8% variance explained

AIC(huck.m8h, huck.m8g) #huck.m8g better

##Model
huck.m8g<-gam(Fruit_Coun~s(NFFD2_sp_1) + s(PPT07_2) + s(PAS_0) + s(Tave_wt_2) + s(PPT05_0) + s(ID3, bs="re"), family = nb(link="sqrt"), data=Huck_RepeatedMeasures_3005_df_b, method = "REML", select=TRUE)
gam.check(huck.m8g, rep=500)
summary(huck.m8g) #26.3% variance explained

draw(huck.m8g, scales= 'fixed')
visreg(huck.m8g, "NFFD2_sp_1")
visreg(huck.m8g, "PPT07_2")
visreg(huck.m8g, "Tave_wt_2")
visreg(huck.m8g, "PPT05_0")
visreg(huck.m8g, "PAS_0")

```


Save file. Share this prior to ending contract.
```{r}
write.csv(Huck_RepeatedMeasures_3005_df_b, file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Huckleberry_Repeated_Measures_Climate_March28.csv")
```



####### BUFFALOBERRY #######

Load in the data.
```{r}
Buff_RepeatedMeasures<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Copy of LongtermBuffaloberryPlots_FHEV_2016-2021_CSplay.csv")
head(Buff_RepeatedMeasures)
table(Buff_RepeatedMeasures$Shrub.ID)
table(Buff_RepeatedMeasures$Visit_YEAR) #2016-2021
```

Append climate data for each year.

#2016
```{r}
buff_repeat_2016_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2016_Year_2016MSY.csv")
head(buff_repeat_2016_0)

buff_repeat_2016_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2016_Year_2015MSY.csv")
head(buff_repeat_2016_1)

buff_repeat_2016_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2016_Year_2014MSY.csv")
head(buff_repeat_2016_2)

buff_repeated_2016<-cbind(buff_repeat_2016_0, buff_repeat_2016_1, buff_repeat_2016_2)
#names(buff_repeated_2016)

#Remove duplicated columns
buff_repeated_2016<-buff_repeated_2016[-(541:545)]
buff_repeated_2016<-buff_repeated_2016[-(271:275)]
buff_repeated_2016<-buff_repeated_2016[-(5)]

```


#2017
```{r}
buff_repeat_2017_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2017_Year_2017MSY.csv")
head(buff_repeat_2017_0)

buff_repeat_2017_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2017_Year_2016MSY.csv")
head(buff_repeat_2017_1)

buff_repeat_2017_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2017_Year_2015MSY.csv")
head(buff_repeat_2017_2)

buff_repeated_2017<-cbind(buff_repeat_2017_0, buff_repeat_2017_1, buff_repeat_2017_2)
#names(buff_repeated_2017)

#Remove duplicated columns
buff_repeated_2017<-buff_repeated_2017[-(541:545)]
buff_repeated_2017<-buff_repeated_2017[-(271:275)]
buff_repeated_2017<-buff_repeated_2017[-(5)]

```

#2018
```{r}
buff_repeat_2018_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2018_Year_2018MSY.csv")
head(buff_repeat_2018_0)

buff_repeat_2018_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2018_Year_2017MSY.csv")
head(buff_repeat_2018_1)

buff_repeat_2018_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2018_Year_2016MSY.csv")
head(buff_repeat_2018_2)

buff_repeated_2018<-cbind(buff_repeat_2018_0, buff_repeat_2018_1, buff_repeat_2018_2)
#names(buff_repeated_2018)

#Remove duplicated columns
buff_repeated_2018<-buff_repeated_2018[-(541:545)]
buff_repeated_2018<-buff_repeated_2018[-(271:275)]
buff_repeated_2018<-buff_repeated_2018[-(5)]

```

#2019
```{r}
buff_repeat_2019_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2019_Year_2019MSY.csv")
head(buff_repeat_2019_0)

buff_repeat_2019_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2019_Year_2018MSY.csv")
head(buff_repeat_2019_1)

buff_repeat_2019_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2019_Year_2017MSY.csv")
head(buff_repeat_2019_2)

buff_repeated_2019<-cbind(buff_repeat_2019_0, buff_repeat_2019_1, buff_repeat_2019_2)
#names(buff_repeated_2019)

#Remove duplicated columns
buff_repeated_2019<-buff_repeated_2019[-(541:545)]
buff_repeated_2019<-buff_repeated_2019[-(271:275)]
buff_repeated_2019<-buff_repeated_2019[-(5)]

```


#2020
```{r}
buff_repeat_2020_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2020_Year_2020MSY.csv")
head(buff_repeat_2020_0)

buff_repeat_2020_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2020_Year_2019MSY.csv")
head(buff_repeat_2020_1)

buff_repeat_2020_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2020_Year_2018MSY.csv")
head(buff_repeat_2020_2)

buff_repeated_2020<-cbind(buff_repeat_2020_0, buff_repeat_2020_1, buff_repeat_2020_2)
#names(buff_repeated_2020)

#Remove duplicated columns
buff_repeated_2020<-buff_repeated_2020[-(541:545)]
buff_repeated_2020<-buff_repeated_2020[-(271:275)]
buff_repeated_2020<-buff_repeated_2020[-(5)]

```


#2021
No ClimateBC for 2021 as of March 2022
```{r}
#buff_repeat_2021_0<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2021_Year_2021MSY.csv")
#head(buff_repeat_2021_0)

buff_repeat_2021_1<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2021_Year_2020MSY.csv")
head(buff_repeat_2021_1)

buff_repeat_2021_2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Buffaloberry_RepeatedMeasures Buffaloberry ClimateBC\\BuffaloBerry_Repeated_2021_Year_2019MSY.csv")
head(buff_repeat_2021_2)

#buff_repeated_2021<-cbind(buff_repeat_2021_0, buff_repeat_2021_1, buff_repeat_2021_2)
buff_repeated_2021<-cbind(buff_repeat_2021_1, buff_repeat_2021_2)
#names(buff_repeated_2021)

#Remove duplicated columns
#buff_repeated_2021<-buff_repeated_2021[-(541:545)]
buff_repeated_2021<-buff_repeated_2021[-(271:275)]
buff_repeated_2021<-buff_repeated_2021[-(5)]

```

Combine data sets. First will need to get same column names in the 2021 data.

```{r}
buff_repeated_2021[setdiff(names(buff_repeated_2020), names(buff_repeated_2021))] <- NA
head(buff_repeated_2021)
```


```{r}
buff_repeated_climate_data<-rbind(buff_repeated_2020, buff_repeated_2019, buff_repeated_2018, buff_repeated_2017, buff_repeated_2016) 

buff_repeated_climate_data2<-smartbind(buff_repeated_climate_data, buff_repeated_2021)

head(buff_repeated_climate_data2)
buff_repeated_climate_data2$Tave01_0
buff_repeated_climate_data2$Tave07_0 #Some repeatedly have -9999... must remove sadly.


```

Combine data together.

```{r}
buff_RepeatedMeasures_b<-left_join(Buff_RepeatedMeasures, buff_repeated_climate_data2, by="ID")
head(buff_RepeatedMeasures_b)
```

```{r}
buff_RepeatedMeasures_b$Tave01_0 #Weird -9999 seems to be gone now
```


#Combine some variables together given prior literature.
Notes: spring GDD (April-June), July temp range (these from the Holden paper).  Probably better just to use heatload. Need a moisture variable too but what?
Shep model may include: crown closure, plant height, July rain previous year, heatload.
Need moisture variable: July rainfall or PAS?
Growing degree days from April to June and July temperature explaining 70% of variation in one study

```{r}
#Need to make "_0" variables numeric given NAs from 2021 missing data
buff_RepeatedMeasures_b$DD5_04_0<-as.numeric(buff_RepeatedMeasures_b$DD5_04_0)
buff_RepeatedMeasures_b$DD5_05_0<-as.numeric(buff_RepeatedMeasures_b$DD5_05_0)
buff_RepeatedMeasures_b$DD5_06_0<-as.numeric(buff_RepeatedMeasures_b$DD5_06_0)

#Make spring growing degree day variables
buff_RepeatedMeasures_b$GDD2_sp_0<-(buff_RepeatedMeasures_b$DD5_04_0 + buff_RepeatedMeasures_b$DD5_05_0 + buff_RepeatedMeasures_b$DD5_06_0)

buff_RepeatedMeasures_b$GDD2_sp_1<-(buff_RepeatedMeasures_b$DD5_04_1 + buff_RepeatedMeasures_b$DD5_05_1 + buff_RepeatedMeasures_b$DD5_06_1)

buff_RepeatedMeasures_b$GDD2_sp_2<-(buff_RepeatedMeasures_b$DD5_04_2 + buff_RepeatedMeasures_b$DD5_05_2 + buff_RepeatedMeasures_b$DD5_06_2)

```

Make Number of Frost Free Days in spring.

```{r}
#Make numeric
buff_RepeatedMeasures_b$NFFD04_0<-as.numeric(buff_RepeatedMeasures_b$NFFD04_0)
buff_RepeatedMeasures_b$NFFD05_0<-as.numeric(buff_RepeatedMeasures_b$NFFD05_0)
buff_RepeatedMeasures_b$NFFD06_0<-as.numeric(buff_RepeatedMeasures_b$NFFD06_0)

buff_RepeatedMeasures_b$NFFD2_sp_0<-(buff_RepeatedMeasures_b$NFFD04_0 + buff_RepeatedMeasures_b$NFFD05_0 + buff_RepeatedMeasures_b$NFFD06_0)

buff_RepeatedMeasures_b$NFFD2_sp_1<-(buff_RepeatedMeasures_b$NFFD04_1 + buff_RepeatedMeasures_b$NFFD05_1 + buff_RepeatedMeasures_b$NFFD06_1)

buff_RepeatedMeasures_b$NFFD2_sp_2<-(buff_RepeatedMeasures_b$NFFD04_2 + buff_RepeatedMeasures_b$NFFD05_2 + buff_RepeatedMeasures_b$NFFD06_2)
```


Make fruit count numeric.
```{r}
buff_RepeatedMeasures_b$Berry.Count<-as.numeric(buff_RepeatedMeasures_b$Berry.Count)
buff_RepeatedMeasures_b$Berry.Count #There actually are some NAs!

buff_RepeatedMeasures_c<-subset(buff_RepeatedMeasures_b, buff_RepeatedMeasures_b$Berry.Count!="NA") #233
```


Begin Analyses.

```{r}
#Must convert to factor first
buff_RepeatedMeasures_c$Shrub.ID<-as.factor(buff_RepeatedMeasures_c$Shrub.ID)

#Many of the _0 ones need to be made numeric since 2021 data missing
buff_RepeatedMeasures_c$PPT07_0<-as.numeric(buff_RepeatedMeasures_c$PPT07_0)
buff_RepeatedMeasures_c$PAS_0<-as.numeric(buff_RepeatedMeasures_c$PAS_0)
buff_RepeatedMeasures_c$MWMT_0<-as.numeric(buff_RepeatedMeasures_c$MWMT_0)
buff_RepeatedMeasures_c$Tave_wt_0<-as.numeric(buff_RepeatedMeasures_c$Tave_wt_0)
buff_RepeatedMeasures_c$PPT05_0<-as.numeric(buff_RepeatedMeasures_c$PPT05_0)
buff_RepeatedMeasures_c$Tave07_0<-as.numeric(buff_RepeatedMeasures_c$Tave07_0)
buff_RepeatedMeasures_c$Tmax07_0<-as.numeric(buff_RepeatedMeasures_c$Tmax07_0)
buff_RepeatedMeasures_c$Tave05_0<-as.numeric(buff_RepeatedMeasures_c$Tave05_0)
buff_RepeatedMeasures_c$Tmax05_0<-as.numeric(buff_RepeatedMeasures_c$Tmax05_0)

#Models
#Start here... cannot test all at once because of lower sample size
buff.m1<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0) + s(GDD2_sp_1) + s(GDD2_sp_0) + s(GDD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + s(Max.Height..m.) + s(Shrub.ID, bs="re"), family = nb(link="sqrt"), data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m1, rep=500)
summary(buff.m1)

#Change link function
buff.m1<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0) + s(GDD2_sp_1) + s(GDD2_sp_0) + s(GDD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + s(Max.Height..m.) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m1, rep=500) # A lot of p-values < 0.05
summary(buff.m1)

#Drop some variables, then add some in
buff.m2<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m2, rep=500) # A lot of p-values < 0.05
summary(buff.m2) #54.7% deviance explained

AIC(buff.m1, buff.m2) #Models equivalent

#Add some others in
buff.m3<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax07_0) + s(Tave07_0) + s(Tmax05_0) + s(Tave05_0) + s(PPT05_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m3, rep=500) # Fewer p-values <0.05
summary(buff.m3) #62.5% deviance explained

AIC(buff.m3, buff.m2) #m3 better

#Trade some out and add some prior years in
buff.m4<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0)  + s(GDD2_sp_1) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax07_1) + s(Tave07_1) + s(Tmax05_0) + s(Tave05_0) + s(PPT05_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m4, rep=500) # Many p-values < 0.05
summary(buff.m4) #57.3% deviance explained

AIC(buff.m3, buff.m4) #m3 better

#
buff.m4<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax07_1) + s(Tave07_1) + s(Tmax05_0) + s(Tave05_0) +  s(Tmax05_1) + s(Tave05_1) + s(PPT05_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m4, rep=500) # Many p-values < 0.05
summary(buff.m4) #55.8% deviance explained

AIC(buff.m3, buff.m4) #m3 better

#
buff.m5<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tave07_1) + s(Tave05_0) +  s(Tmax05_1) + s(Tave05_1) + s(PPT05_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m5, rep=500) # Many p-values < 0.05
summary(buff.m5) #55.8% deviance explained

AIC(buff.m3, buff.m5) #m3 better
AIC(buff.m4, buff.m5) #equivalent

#Go back to m3
buff.m6<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(PPT07_1) + s(Max.Height..m.)  + s(Tave07_0) + s(Tmax05_0) + s(Tave07_1) + s(Tmax05_1) + s(PPT05_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m6, rep=500) # Most p-values <0.05
summary(buff.m6) #55.8% deviance explained

AIC(buff.m3, buff.m6) #m3 better

#Modify
buff.m6<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0)   + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tave07_1) + s(Tmax05_1) + s(PPT05_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m6, rep=500) # Most p-values <0.05
summary(buff.m6) #55.8% deviance explained

AIC(buff.m3, buff.m6) #m3 better

#Modify
buff.m6<-gam(Berry.Count~s(NFFD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tave07_1) + s(Tmax05_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m6, rep=500) # Most p-values <0.05
summary(buff.m6) #55.8% deviance explained

AIC(buff.m3, buff.m6) #m3 better

#Modify
buff.m6<-gam(Berry.Count~s(NFFD2_sp_2) + s(PPT07_0) + s(Tave07_1) + s(Tmax05_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m6, rep=500) # Most p-values <0.05
summary(buff.m6) #61.4% deviance explained

AIC(buff.m3, buff.m6) #m3 better


#Go back and remove least sig variables
#Add some others in
buff.m3<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax07_0) + s(Tave07_0) + s(Tmax05_0) + s(Tave05_0) + s(PPT05_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m3, rep=500) # Fewer p-values <0.05
summary(buff.m3) #62.5% deviance explained

buff.m7<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax05_0) + s(Tave05_0) + s(PPT05_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m7, rep=500) # Most p-values <0.05
summary(buff.m7) #58% deviance explained

AIC(buff.m3, buff.m7) #m3 better

buff.m7<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax05_0) + s(Tmax05_1) + s(Tave05_0) + s(PPT05_0) +  s(Tmax07_0) +  s(Tmax07_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m7, rep=500) # Most p-values <0.05
summary(buff.m7) #55.9% deviance explained

AIC(buff.m3, buff.m7) #m3 better

buff.m8<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax05_0) + s(Tmax05_1) + s(Tave05_0) + s(PPT05_0) +  s(Tmax07_0) +  s(Tmax07_1) + s(PAS_0) + s(Tave_wt_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m8, rep=500) # Most p-values <0.05
summary(buff.m8) #51.7% deviance explained

AIC(buff.m3, buff.m8) #m3 better

buff.m8<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tave05_0) + s(PPT05_0) +  s(Tmax07_0) +  s(Tmax07_1) + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1)+ s(MWMT_0) + s(MWMT_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m8, rep=500) # Fewer p-values <0.05
summary(buff.m8) #60.5% deviance explained

AIC(buff.m3, buff.m8) #m3 better, but m8 getting closer

buff.m9<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tave05_0)  +  s(Tmax07_1) + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1)+ s(MWMT_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m9, rep=500) # Fewer p-values <0.05
summary(buff.m9) #60.5% deviance explained

AIC(buff.m3, buff.m9) #m3 better, but m9 getting closer

#A prior model investigated
buff.m4<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0) + s(GDD2_sp_1) + s(GDD2_sp_0) + s(GDD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(PPT07_1) + s(PPT07_2) + s(PAS_1) + s(MWMT_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m4, rep=500) #Many but not all p <0.05
summary(buff.m4) #Significant variables: PPT07_0, GDD2_sp_0, NFFD2_sp_2, NFFD2_sp_1
#62.6% deviance explained

AIC(buff.m3, buff.m4) #m3 better


buff.m9<-gam(Berry.Count ~ s(NFFD2_sp_2) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tave05_0)  +  s(Tmax07_1) + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m9, rep=500) # Many but not all p-values <0.05
summary(buff.m9) #57.1% deviance explained

AIC(buff.m3, buff.m9) #m3 better


#m3 and m9 mashup
summary(buff.m3)
buff.m9<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tave07_0) + s(Tmax05_0) + s(Tave05_0) + s(PPT05_0) + + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m9, rep=500) # Fewer p-values <0.05
summary(buff.m9) #62.2% deviance explained

AIC(buff.m3, buff.m9) #Models equivalent

#Attempt reducing variables
buff.m10<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tave07_0) + s(Tmax05_0) + s(Tave05_0) + + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m10, rep=500) # Fewer p-values <0.05
summary(buff.m10) #62% deviance explained

AIC(buff.m10, buff.m9) #Models nearly equivalent

buff.m11<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2) + s(NFFD2_sp_0)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax05_0) + s(Tave05_0) + + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m11, rep=500) # Fewer p-values <0.05
summary(buff.m11) #62.2% deviance explained

AIC(buff.m10, buff.m11) #Models nearly equivalent

buff.m12<-gam(Berry.Count~s(NFFD2_sp_1) + s(NFFD2_sp_2)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax05_0) + s(Tave05_0) + + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m12, rep=500) # Fewer p-values <0.05
summary(buff.m12) #62% deviance explained

AIC(buff.m10, buff.m12) #Models nearly equivalent
AIC(buff.m12, buff.m11)

#
buff.m12<-gam(Berry.Count~ s(NFFD2_sp_2)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax05_0) + s(Tave05_0) + + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m12, rep=500) # Fewer p-values <0.05
summary(buff.m12) #62% deviance explained

AIC(buff.m10, buff.m12) #Models nearly equivalent

buff.m13<-gam(Berry.Count~ s(NFFD2_sp_2)  + s(GDD2_sp_0) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax05_0) + s(Tave05_0) + + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m13, rep=500) # Fewer p-values <0.05
summary(buff.m13) #63.2% deviance explained

AIC(buff.m13, buff.m12) #m12 better

#Use m12
buff.m12<-gam(Berry.Count~ s(NFFD2_sp_2)  + s(GDD2_sp_0) + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax05_0) + s(Tave05_0) + + s(PAS_1) + s(Tave_wt_0) + s(Tave_wt_1) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m12, rep=500) # Fewer p-values <0.05
summary(buff.m12) #62% deviance explained

#Visualize
draw(buff.m12, scales= 'fixed')

visreg(buff.m12, "GDD2_sp_0")
visreg(buff.m12, "NFFD2_sp_2")
visreg(buff.m12, "Canopy.Cover....")
visreg(buff.m12, "PPT07_0")
visreg(buff.m12, "PAS_1")
visreg(buff.m12, "Max.Height..m.")
visreg(buff.m12, "Tmax05_0")
visreg(buff.m12, "Tave05_0")
visreg(buff.m12, "Tave_wt_0")
visreg(buff.m12, "Tave_wt_1")

#
buff.m13<-gam(Berry.Count~ s(NFFD2_sp_2)  + s(Canopy.Cover....) + s(PPT07_0) + s(Max.Height..m.) + s(Tmax05_0) + s(Tave05_0) + s(Tave07_0) + s(PAS_1) + s(Tave_wt_0) + s(Shrub.ID, bs="re"), family = nb, data=buff_RepeatedMeasures_c, method = "REML", select=TRUE)
gam.check(buff.m13, rep=500) # Fewer p-values <0.05
summary(buff.m13) #55.2% deviance explained

AIC(buff.m13, buff.m12) #m12 better


```

