---
title: "Buffaloberry_Data_analysis"
author: "Cora Skaien"
date: "17/03/2022"
output: html_document
---
<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(data.table)
library(sf)
library(tidyverse)
library(rgeos)
library(cleangeo)
library(dplyr)
library(tidyr)
library(ggplot2)
library(rgdal)
library(keyring)
library(DBI)
library(rgeos)
library(car)
library(rje)
library(caret)
library(pROC)
library(visreg)
library(arm)
library(mgcv)
library(mgcViz)
library(plyr)

#source(here::here("R/functions/R_Postgres.R"))
```

##Data set
cutblock_plots_openings_Buff_ALL_df_March2022

#Overview
This file continues from Buffaloberry&buffaloberry_data_processing_Jan2022. Here, we explore how silviculture practices influence the abundance of buffaloberry berries.

#Load Data In
```{r}
cutblock_plots_openings_Buff_ALL_df_b2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Buff_ALL_df_b2.csv")
head(cutblock_plots_openings_Buff_ALL_df_b2)

cutblock_plots_openings_Buff_ALL_df<-cutblock_plots_openings_Buff_ALL_df_b2
                             
```

#Begin Exploration of variables
```{r}
head(cutblock_plots_openings_Buff_ALL_df)
names(cutblock_plots_openings_Buff_ALL_df)

table(cutblock_plots_openings_Buff_ALL_df$Species.Pr) #Some values No or Yes and need to be revalued.

cutblock_plots_openings_Buff_ALL_df$Species.Pr<-revalue(cutblock_plots_openings_Buff_ALL_df$Species.Pr, c("0"="0", "1"="1", "No"="0", "Yes"="1"))
table(cutblock_plots_openings_Buff_ALL_df$Species.Pr) #100 without plants, 145 with

cutblock_plots_openings_Buff_ALL_df_ALL<-cutblock_plots_openings_Buff_ALL_df
cutblock_plots_openings_Buff_ALL_df<-subset(cutblock_plots_openings_Buff_ALL_df, cutblock_plots_openings_Buff_ALL_df$Species.Pr!="0") #158 plants

#Check have from both datasets
table(cutblock_plots_openings_Buff_ALL_df$DATASET) #104 from Clayton, 54 from Mackenzie

table(cutblock_plots_openings_Buff_ALL_df$Fruit.Pres)
cutblock_plots_openings_Buff_ALL_df$Fruit.Pres<-revalue(cutblock_plots_openings_Buff_ALL_df$Fruit.Pres, c("0"="0", "1"="1", "No"="0", "Yes"="1"))
table(cutblock_plots_openings_Buff_ALL_df$Fruit.Pres) #24 no fruits, 121 with fruits
cutblock_plots_openings_Buff_ALL_df$Fruit.Pres
cutblock_plots_openings_Buff_ALL_df$Fruit.Pres<-as.numeric(cutblock_plots_openings_Buff_ALL_df$Fruit.Pres)

table(cutblock_plots_openings_Buff_ALL_df$Species)
cutblock_plots_openings_Buff_ALL_df$Species

cutblock_plots_openings_Buff_ALL_df2<-cutblock_plots_openings_Buff_ALL_df #Save as a back up for now

table(cutblock_plots_openings_Buff_ALL_df$DATASET)

```

Save data.
```{r}
write.csv(cutblock_plots_openings_Buff_ALL_df, file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Buff_ALL_df_PlantPresOnly.csv")
```

## Looking at DN1_DIS_CD (DENUDATION_1_DISTURBANCE_CODE) between openings and openings + activity files
```{r}
#See if worth losing the data points - i.e., do we have consistent good data within this.
head(cutblock_plots_openings_Buff_ALL_df)
table(cutblock_plots_openings_Buff_ALL_df$G_BGC_ZONE) #BEC Zone: ESSF, ICH, IDF, MS, SBPS (1), SBS
cutblock_plots_openings_Buff_ALL_df$OPEN_GRSAR<-as.numeric(cutblock_plots_openings_Buff_ALL_df$OPEN_GRSAR)
hist(cutblock_plots_openings_Buff_ALL_df$OPEN_GRSAR) #total area the opening encompasses
table(cutblock_plots_openings_Buff_ALL_df$DN1_DIS_CD) # 3 B (burned wildfire); 135 logged (L); 1 P (pest); 3 S (Salvage); 3 W; 
table(cutblock_plots_openings_Buff_ALL_df$DN2_DIS_CD) #Additional elements; 115 total

```

May wish to remove P, S and W, and B

```{r}
cutblock_plots_openings_Buff_ALL_df<-subset(cutblock_plots_openings_Buff_ALL_df, cutblock_plots_openings_Buff_ALL_df$DN1_DIS_CD!="P")
cutblock_plots_openings_Buff_ALL_df<-subset(cutblock_plots_openings_Buff_ALL_df, cutblock_plots_openings_Buff_ALL_df$DN1_DIS_CD!="S")
cutblock_plots_openings_Buff_ALL_df<-subset(cutblock_plots_openings_Buff_ALL_df, cutblock_plots_openings_Buff_ALL_df$DN1_DIS_CD!="B")
cutblock_plots_openings_Buff_ALL_df<-subset(cutblock_plots_openings_Buff_ALL_df, cutblock_plots_openings_Buff_ALL_df$DN1_DIS_CD!="W")

table(cutblock_plots_openings_Buff_ALL_df$DN1_DIS_CD) #144 logged
```

#Inspect DN1_SILSYS (DENUDATION_1_SILV_SYSTEM_CODE)
```{r}
table(cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS) #65 CCRES (Clearcut with reserves); 55 Clearcut; spattering of others; 
table(cutblock_plots_openings_Buff_ALL_df$DN2_SILSYS)

#May wish to group the smaller groups into an "other" category
cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP<-cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS
cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP <- recode_factor(cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP, CCRES = "CCRES", CLEAR = "CLEAR", IMCUT  = "Other",  SEEDT = "Other", SELEC = "Other", SHELT = "Other")
table(cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP) 

cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP #NAs exist... turn them into Other? Or maybe Unknown.
cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP<-as.factor(cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP)

library(forcats) 
cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP<-fct_explicit_na(cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP, na_level = "Unknown")

table(cutblock_plots_openings_Buff_ALL_df$DN1_SILSYS_GP) #Could consider combining Unknown and Other. They are slightly different, however, but Other is such a small category. Consider this if partial residuals are wonky.

```

#Investigate other categories
```{r}
table(cutblock_plots_openings_Buff_ALL_df$DN1_SILVAR) # Not many records; not useful
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH) # 16 BU (burn), 30 ME (mechanical), 2 MA (Manual)
table(cutblock_plots_openings_Buff_ALL_df$PREP2_TECH)
# Mostly same categories as above at different values
cutblock_plots_openings_Buff_ALL_df$PREP1_TECH<-as.factor(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH)
cutblock_plots_openings_Buff_ALL_df$PREP2_TECH<-as.factor(cutblock_plots_openings_Buff_ALL_df$PREP2_TECH)
#cutblock_plots_openings_Buff_ALL_df$PREP1_2_TECH<- ifelse (is.na(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH), cutblock_plots_openings_Buff_ALL_df$PREP2_TECH, cutblock_plots_openings_Buff_ALL_df$PREP1_TECH)
#table(cutblock_plots_openings_Buff_ALL_df$PREP1_2_TECH)# 516; get two additional one, but names messed up (become numbers)
```


```{r}
cutblock_plots_openings_Buff_ALL_df$PREP1_2<-paste(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH,cutblock_plots_openings_Buff_ALL_df$PREP2_TECH)
table(cutblock_plots_openings_Buff_ALL_df$PREP1_2) #336 records of NA, lots of combinations otherwise. Maybe make a column that is yes/no for each technique that is considered important? We see that the 2 in above that we gain are the "NA GS" here. We also see that some were burned first and then had mechanical treatment (50), and some had mechanical treatment and then were burned (57)

cutblock_plots_openings_Buff_ALL_df$PREP1_2<-as.factor(cutblock_plots_openings_Buff_ALL_df$PREP1_2)
cutblock_plots_openings_Buff_ALL_df$PREP1_TECH<-as.factor(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH)

table(cutblock_plots_openings_Buff_ALL_df$PREP1_2)

##All 3 of the ifelse statements below get the same result
cutblock_plots_openings_Buff_ALL_df$PREP_TECH <- ifelse (cutblock_plots_openings_Buff_ALL_df$PREP1_2 == "BU ME", cutblock_plots_openings_Buff_ALL_df$PREP1_2, ifelse (cutblock_plots_openings_Buff_ALL_df$PREP1_2 == "ME BU", cutblock_plots_openings_Buff_ALL_df$PREP1_2, cutblock_plots_openings_Buff_ALL_df$PREP1_TECH))

cutblock_plots_openings_Buff_ALL_df$PREP_TECH <- ifelse ((cutblock_plots_openings_Buff_ALL_df$PREP1_2 == "BU ME" | cutblock_plots_openings_Buff_ALL_df$PREP1_2 == "ME BU"), cutblock_plots_openings_Buff_ALL_df$PREP1_2, cutblock_plots_openings_Buff_ALL_df$PREP1_TECH)
cutblock_plots_openings_Buff_ALL_df$PREP_TECH <- ifelse ((cutblock_plots_openings_Buff_ALL_df$PREP1_2 == "ME BU" | cutblock_plots_openings_Buff_ALL_df$PREP1_2 == "BU ME"), cutblock_plots_openings_Buff_ALL_df$PREP1_2, cutblock_plots_openings_Buff_ALL_df$PREP1_TECH) #get same result if change order of names
table(cutblock_plots_openings_Buff_ALL_df$PREP_TECH)
table(cutblock_plots_openings_Buff_ALL_df$PREP2_TECH)
table(cutblock_plots_openings_Buff_ALL_df$PREP1_2)
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH)
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH, cutblock_plots_openings_Buff_ALL_df$PREP_TECH) #1 = BU; 2=CA; 3=CG; 4=GS; 5=MA; 6=ME; 7=BI; 24=?? NA? 
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH, cutblock_plots_openings_Buff_ALL_df$PREP1_2)

cutblock_plots_openings_Buff_ALL_df$PREP_TECH_2<-paste(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH, cutblock_plots_openings_Buff_ALL_df$PREP_TECH)
table(cutblock_plots_openings_Buff_ALL_df$PREP_TECH_2) #This helps fix the weird error above; n = 641 

```

Create additional columns that indicate whether burning happened and whether mechanical application happened.

```{r}

cutblock_plots_openings_Buff_ALL_df$PREP_BU <- ifelse ((cutblock_plots_openings_Buff_ALL_df$PREP1_TECH == "BU" | cutblock_plots_openings_Buff_ALL_df$PREP2_TECH == "BU"), 1, 0)

#Attempt 2
cutblock_plots_openings_Buff_ALL_df$PREP_BU <- ifelse ((cutblock_plots_openings_Buff_ALL_df$PREP1_TECH != "BU" & cutblock_plots_openings_Buff_ALL_df$PREP2_TECH != "BU"), 0, 1)                                                     
table(cutblock_plots_openings_Buff_ALL_df$PREP_BU)    #8 not burned, 22 burned; MANY NAs

cutblock_plots_openings_Buff_ALL_df$PREP_BU
#Lots of NAs - there should be no NAs. It is an ifelse statement where all should be 1s or 0s...
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH) #16 burned
table(cutblock_plots_openings_Buff_ALL_df$PREP2_TECH) #7 burned
table(cutblock_plots_openings_Buff_ALL_df$PREP_TECH_2) #122 9 (so burned both times); so 200 burned seemed realistic

table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH, cutblock_plots_openings_Buff_ALL_df$PREP2_TECH) #Won't see all because many NAs in PREP2_TECH; here 23 are BU BU


table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH)
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH, cutblock_plots_openings_Buff_ALL_df$PREP_BU)
table(cutblock_plots_openings_Buff_ALL_df$PREP_BU, cutblock_plots_openings_Buff_ALL_df$Burned)
table(cutblock_plots_openings_Buff_ALL_df$Burned)

cutblock_plots_openings_Buff_ALL_df$PREP_BU[is.na(cutblock_plots_openings_Buff_ALL_df$PREP_BU)]<-0
table(cutblock_plots_openings_Buff_ALL_df$PREP_BU) #This looks better, but keep in mind that some that had no info may have had treatments not listed; 306 not burned, 186 burned


```

Repeat for mechanical.

```{r}
cutblock_plots_openings_Buff_ALL_df$PREP_ME <- ifelse ((cutblock_plots_openings_Buff_ALL_df$PREP1_TECH == "ME" | cutblock_plots_openings_Buff_ALL_df$PREP2_TECH == "ME"), 1, 0)
table(cutblock_plots_openings_Buff_ALL_df$PREP_ME) #There should be a LOT more data here
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH)
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH, cutblock_plots_openings_Buff_ALL_df$PREP_ME)
cutblock_plots_openings_Buff_ALL_df$PREP_ME # A lot of NAs: turn to 0s
cutblock_plots_openings_Buff_ALL_df$PREP_ME[is.na(cutblock_plots_openings_Buff_ALL_df$PREP_ME)]<-0
table(cutblock_plots_openings_Buff_ALL_df$PREP_ME) #This looks better, but keep in mind that some that had no info may have had treatments not listed; 291 no mechanical treatment, 201 mechanical treatment

#Compare PREP_ME to Mechanical from atu data
table(cutblock_plots_openings_Buff_ALL_df$PREP_ME, cutblock_plots_openings_Buff_ALL_df$Mechanical) #A few more yeses in each
table(cutblock_plots_openings_Buff_ALL_df$PREP_ME) #37 yes
table(cutblock_plots_openings_Buff_ALL_df$Mechanical) #34 yes

cutblock_plots_openings_Buff_ALL_df$Mechanical2<-ifelse(cutblock_plots_openings_Buff_ALL_df$Mechanical==1,1, 
                                                                ifelse(cutblock_plots_openings_Buff_ALL_df$PREP_ME==1,1,0))
table(cutblock_plots_openings_Buff_ALL_df$Mechanical2) #40 yeses, combining infor from both

```
Repeat for MA (manual?)

```{r}
cutblock_plots_openings_Buff_ALL_df$PREP_MA <- ifelse ((cutblock_plots_openings_Buff_ALL_df$PREP1_TECH == "MA" | cutblock_plots_openings_Buff_ALL_df$PREP2_TECH == "MA"), 1, 0)
table(cutblock_plots_openings_Buff_ALL_df$PREP_MA) #There should be a LOT more data here
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH)
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH, cutblock_plots_openings_Buff_ALL_df$PREP_MA)
cutblock_plots_openings_Buff_ALL_df$PREP_MA # A lot of NAs: turn to 0s
cutblock_plots_openings_Buff_ALL_df$PREP_MA[is.na(cutblock_plots_openings_Buff_ALL_df$PREP_MA)]<-0
table(cutblock_plots_openings_Buff_ALL_df$PREP_MA) #This looks better, but keep in mind that some that had no info may have had treatmeants not listed; 20 manual treatment, 472 no manual treatment' not useful, do not use.

#Compare PREP_MA to Manual from atu data
table(cutblock_plots_openings_Buff_ALL_df$PREP_MA, cutblock_plots_openings_Buff_ALL_df$Manual) #Dramatic differences
table(cutblock_plots_openings_Buff_ALL_df$PREP_MA) #19 yeses
table(cutblock_plots_openings_Buff_ALL_df$Manual) # 44 yeses

cutblock_plots_openings_Buff_ALL_df$Manual2<-ifelse(cutblock_plots_openings_Buff_ALL_df$Manual==1,1, 
                                                                ifelse(cutblock_plots_openings_Buff_ALL_df$PREP_MA==1,1,0))
table(cutblock_plots_openings_Buff_ALL_df$Manual2) #40 yeses, combining info from both
#Perhaps this firm manual refers to something different and not brushing?

```


```{r}
table(cutblock_plots_openings_Buff_ALL_df$BRSH1_TECH)#Brushing technique; 121 MA (manual); 16 CG (Chemical Ground); 4 CA (Chemical Air); and others

cutblock_plots_openings_Buff_ALL_df$BRUSH_MA <- ifelse ((cutblock_plots_openings_Buff_ALL_df$BRSH1_TECH == "MA"), 1, 0)
table(cutblock_plots_openings_Buff_ALL_df$BRUSH_MA) #There should be a LOT more data here

cutblock_plots_openings_Buff_ALL_df$BRUSH_MA # A lot of NAs: turn to 0s
cutblock_plots_openings_Buff_ALL_df$BRUSH_MA[is.na(cutblock_plots_openings_Buff_ALL_df$BRUSH_MA)]<-0
table(cutblock_plots_openings_Buff_ALL_df$BRUSH_MA) #This looks better, but keep in mind that some that had no info may have had treatmeants not listed; 112 manual brushing, 311 not

table(cutblock_plots_openings_Buff_ALL_df$Brushing_ALL, cutblock_plots_openings_Buff_ALL_df$BRUSH_MA)

cutblock_plots_openings_Buff_ALL_df$Brush2<-ifelse(cutblock_plots_openings_Buff_ALL_df$Brushing_ALL==1,1, 
                                                                ifelse(cutblock_plots_openings_Buff_ALL_df$BRUSH_MA==1,1,0))
table(cutblock_plots_openings_Buff_ALL_df$Brush2) #44 yeses, combining info from both
```


```{r}
#Repeat for chemical
cutblock_plots_openings_Buff_ALL_df$BRUSH_CM <- ifelse ((cutblock_plots_openings_Buff_ALL_df$BRSH1_TECH == "CA" | cutblock_plots_openings_Buff_ALL_df$BRSH1_TECH== "CG"), 1, 0)
table(cutblock_plots_openings_Buff_ALL_df$BRUSH_CM) #There should be a LOT more data here

cutblock_plots_openings_Buff_ALL_df$BRUSH_CM # A lot of NAs: turn to 0s
cutblock_plots_openings_Buff_ALL_df$BRUSH_CM[is.na(cutblock_plots_openings_Buff_ALL_df$BRUSH_CM)]<-0
table(cutblock_plots_openings_Buff_ALL_df$BRUSH_CM) #This is whether brushing with chemicals was applied; 20 chemical brushing, 472 not

table(cutblock_plots_openings_Buff_ALL_df$BRUSH_CM, cutblock_plots_openings_Buff_ALL_df$Chemical) #Some differences

cutblock_plots_openings_Buff_ALL_df$Chem2<-ifelse(cutblock_plots_openings_Buff_ALL_df$Chemical==1,1, 
                                                                ifelse(cutblock_plots_openings_Buff_ALL_df$BRUSH_CM==1,1,0))
table(cutblock_plots_openings_Buff_ALL_df$Chem2) #28 yeses, combining info from both

```


```{r}
table(cutblock_plots_openings_Buff_ALL_df$PLNT1_TECH) #Mostly PL (planting). RP (replanting). FP (Fill planting). Do NAs mean no planting? Or unknown?
cutblock_plots_openings_Buff_ALL_df$PLNT1_TECH
table(cutblock_plots_openings_Buff_ALL_df$PLNT2_TECH)

cutblock_plots_openings_Buff_ALL_df$PLNT1_2_TECH<-paste(cutblock_plots_openings_Buff_ALL_df$PLNT1_TECH, cutblock_plots_openings_Buff_ALL_df$PLNT2_TECH)
table(cutblock_plots_openings_Buff_ALL_df$PLNT1_2_TECH)
cutblock_plots_openings_Buff_ALL_df$PLNT1_2_TECH<-as.factor(cutblock_plots_openings_Buff_ALL_df$PLNT1_2_TECH)

cutblock_plots_openings_Buff_ALL_df$PLANTED<- ifelse (cutblock_plots_openings_Buff_ALL_df$PLNT1_2_TECH=="NA NA", 0, 1)
table(cutblock_plots_openings_Buff_ALL_df$PLANTED) #Very uneven sample size.
#With current data, 386 planted, 37 not.

table(cutblock_plots_openings_Buff_ALL_df$PLANTED, cutblock_plots_openings_Buff_ALL_df$Planted_ALL) #A few differences

cutblock_plots_openings_Buff_ALL_df$Planted2<-ifelse(cutblock_plots_openings_Buff_ALL_df$Planted_ALL==1,1, 
                                                                ifelse(cutblock_plots_openings_Buff_ALL_df$PLANTED==1,1,0))
table(cutblock_plots_openings_Buff_ALL_df$Planted2) #124 yeses, combining info from both; 11 nos
```


```{r}
cutblock_plots_openings_Buff_ALL_df$FEAT_AREA<-as.numeric(cutblock_plots_openings_Buff_ALL_df$FEAT_AREA)
hist(cutblock_plots_openings_Buff_ALL_df$FEAT_AREA)
cutblock_plots_openings_Buff_ALL_df$PLNT1_AREA<-as.numeric(cutblock_plots_openings_Buff_ALL_df$PLNT1_AREA)
hist(cutblock_plots_openings_Buff_ALL_df$PLNT1_AREA) #Also has a Plant2, so could add together for total planting area?
cutblock_plots_openings_Buff_ALL_df$PLNT2_AREA<-as.numeric(cutblock_plots_openings_Buff_ALL_df$PLNT2_AREA)
hist(cutblock_plots_openings_Buff_ALL_df$PLNT2_AREA)
cutblock_plots_openings_Buff_ALL_df$TOTAL_plant_area<-cutblock_plots_openings_Buff_ALL_df$PLNT1_AREA+cutblock_plots_openings_Buff_ALL_df$PLNT2_AREA
cutblock_plots_openings_Buff_ALL_df$TOTAL_plant_area
cutblock_plots_openings_Buff_ALL_df$TOTAL_plant_area[is.na(cutblock_plots_openings_Buff_ALL_df$TOTAL_plant_area)]<-0
cutblock_plots_openings_Buff_ALL_df$TOTAL_plant_area # We will assume an absence is indicative of no planting
hist(cutblock_plots_openings_Buff_ALL_df$TOTAL_plant_area)

cutblock_plots_openings_Buff_ALL_df$PLANTING<-ifelse (cutblock_plots_openings_Buff_ALL_df$TOTAL_plant_area==0, 0, 1)
table(cutblock_plots_openings_Buff_ALL_df$PLANTING) # We see that this is far different than the data for whether planted or not, suggesting that not all planted sites have planting density. These are NOT true 0s and this data can only be used for locations where we know planting occurred.
#Compare to:
table(cutblock_plots_openings_Buff_ALL_df$PLANTED)
#New metric obviously incomplete as have 290 0s instead of 56.

```


```{r}
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH) #May wish to combine smaller groups into "other"
cutblock_plots_openings_Buff_ALL_df$PREP1_TECH_GP<-cutblock_plots_openings_Buff_ALL_df$PREP1_TECH
cutblock_plots_openings_Buff_ALL_df$PREP1_TECH_GP <- recode_factor(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH_GP, BU="BU", CA="Other",CG="Other",GS="Other",MA="Other",ME="ME", "BI"="Other")
table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH_GP)
#Not as useful as individual assessments that account for both Phase 1 and Phase 2

library(forcats) 
cutblock_plots_openings_Buff_ALL_df$PREP1_TECH_GP<-fct_explicit_na(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH_GP, na_level = "Unknown")

table(cutblock_plots_openings_Buff_ALL_df$PREP1_TECH_GP)

```


```{r}
table(cutblock_plots_openings_Buff_ALL_df$PREP_BU) #122 no, 22 yes
table(cutblock_plots_openings_Buff_ALL_df$PREP_ME) #105 no, 39 yes
table(cutblock_plots_openings_Buff_ALL_df$PREP_MA) #142 no, 2 yes

#With refined data
table(cutblock_plots_openings_Buff_ALL_df$Burned) #122 no, 22 yes
table(cutblock_plots_openings_Buff_ALL_df$Mechanical2) #104 no, 40 yes
table(cutblock_plots_openings_Buff_ALL_df$Manual2) #100 no, 44 yes 

```

Because some of these clearcuts subsequently had fire come through, we must create a new variable that accounts for if fire occurred after but before sampling.

```{r}
# make a new variable that is "origin"
names(cutblock_plots_openings_Buff_ALL_df)
cutblock_plots_openings_Buff_ALL_df$TimeSinceCutblock
cutblock_plots_openings_Buff_ALL_df$TimeSinceFire
cutblock_plots_openings_Buff_ALL_df$CutBlock_O
table(cutblock_plots_openings_Buff_ALL_df$CutBlock_O) #562 indicated as yes. Need to add yes to the appended Laura data.

cutblock_plots_openings_Buff_ALL_df$origin <- ifelse ((cutblock_plots_openings_Buff_ALL_df$CutBlock_O == 1 & cutblock_plots_openings_Buff_ALL_df$TimeSinceCutblock < cutblock_plots_openings_Buff_ALL_df$TimeSinceFire), 1, ifelse ((cutblock_plots_openings_Buff_ALL_df$Fire_Occ == 1 & cutblock_plots_openings_Buff_ALL_df$TimeSinceCutblock > cutblock_plots_openings_Buff_ALL_df$TimeSinceFire), 2, 0))
cutblock_plots_openings_Buff_ALL_df$origin <- as.factor (cutblock_plots_openings_Buff_ALL_df$origin)

table(cutblock_plots_openings_Buff_ALL_df$origin) # 1 = most recently logged; 2 = fire after logging. 0 is when harvesting and burning occurred in the same year.

# make a new variable that is age of stands of known origin
cutblock_plots_openings_Buff_ALL_df$origin.age <- ifelse ((cutblock_plots_openings_Buff_ALL_df$origin == 1), cutblock_plots_openings_Buff_ALL_df$TimeSinceCutblock, ifelse ((cutblock_plots_openings_Buff_ALL_df$origin == 2), cutblock_plots_openings_Buff_ALL_df$TimeSinceFire, ifelse ((cutblock_plots_openings_Buff_ALL_df$origin == 0), cutblock_plots_openings_Buff_ALL_df$TimeSinceFire, NA)))

hist(cutblock_plots_openings_Buff_ALL_df$origin.age)
table(cutblock_plots_openings_Buff_ALL_df$origin)
table(cutblock_plots_openings_Buff_ALL_df$origin, cutblock_plots_openings_Buff_ALL_df$Fire_Year)

```

We only want ones most recently logged, not ones burned since. So remove ones burned more recently than logged.

```{r}
cutblock_plots_openings_Buff_ALL_df_ALL2<-cutblock_plots_openings_Buff_ALL_df
cutblock_plots_openings_Buff_ALL_df<-subset(cutblock_plots_openings_Buff_ALL_df, cutblock_plots_openings_Buff_ALL_df$origin=="1") #Drops down to 142
```

Investigate date when operations began and ended

```{r}
head(cutblock_plots_openings_Buff_ALL_df)
table(cutblock_plots_openings_Buff_ALL_df$DST_STR_DT)
table(cutblock_plots_openings_Buff_ALL_df$DST_END_DT)

#Select month that data was collected
library(stringi)
cutblock_plots_openings_Buff_ALL_df$Date_month_START<-stri_sub(cutblock_plots_openings_Buff_ALL_df$DST_STR_DT,5,6)
table(cutblock_plots_openings_Buff_ALL_df$Date_month_START) #

cutblock_plots_openings_Buff_ALL_df$Date_month_END<-stri_sub(cutblock_plots_openings_Buff_ALL_df$DST_END_DT,5,6)
table(cutblock_plots_openings_Buff_ALL_df$Date_month_END) #

table(cutblock_plots_openings_Buff_ALL_df$Date_month_START, cutblock_plots_openings_Buff_ALL_df$Date_month_END) 

#Get Years
cutblock_plots_openings_Buff_ALL_df$Date_year_START<-stri_sub(cutblock_plots_openings_Buff_ALL_df$DST_STR_DT,1,4)
table(cutblock_plots_openings_Buff_ALL_df$Date_year_START) #

cutblock_plots_openings_Buff_ALL_df$Date_year_END<-stri_sub(cutblock_plots_openings_Buff_ALL_df$DST_END_DT,1,4)
table(cutblock_plots_openings_Buff_ALL_df$Date_year_END) #

#How many went between years
str(cutblock_plots_openings_Buff_ALL_df$Date_year_END)
cutblock_plots_openings_Buff_ALL_df$Date_year_END<-as.numeric(cutblock_plots_openings_Buff_ALL_df$Date_year_END)
cutblock_plots_openings_Buff_ALL_df$Date_year_START<-as.numeric(cutblock_plots_openings_Buff_ALL_df$Date_year_START)

cutblock_plots_openings_Buff_ALL_df$NumYearsTreat<-cutblock_plots_openings_Buff_ALL_df$Date_year_END - cutblock_plots_openings_Buff_ALL_df$Date_year_START

table(cutblock_plots_openings_Buff_ALL_df$NumYearsTreat) #Some ended 59 years after starting.


#Even though not entirely accurate, let's use the start month as a proxy. Will group September-November as fall, December-February as winter, March-May as Spring and June-August as summer
cutblock_plots_openings_Buff_ALL_df$START_SEASON<-cutblock_plots_openings_Buff_ALL_df$Date_month_START
str(cutblock_plots_openings_Buff_ALL_df$START_SEASON)

cutblock_plots_openings_Buff_ALL_df$START_SEASON<-recode_factor(cutblock_plots_openings_Buff_ALL_df$START_SEASON, "01"="Winter", "02"="Winter","03"="Spring","04"="Spring","05"="Spring","06"="Summer", "07"="Summer", "08"="Summer", "09"="Fall", "10" ="Fall", "11"="Fall", "12" ="Winter")

table(cutblock_plots_openings_Buff_ALL_df$START_SEASON)

```

Investigate the newer variables from Dave Waddell.

```{r}
names(cutblock_plots_openings_Buff_ALL_df)
head(cutblock_plots_openings_Buff_ALL_df)

#Look at Planting density - no records in remaining 470 plots
hist(cutblock_plots_openings_Buff_ALL_df$planted_density_TOT)
table(cutblock_plots_openings_Buff_ALL_df$Qa) #Dominate species planted when reported; only 238 reported the species of the 406 records
table(cutblock_plots_openings_Buff_ALL_df$planted_species2) #172 records, so suggests Qa was reported most, as not all plotshad a second species

```

Look at how much of the data shows NAs for abundance.
```{r}
table(cutblock_plots_openings_Buff_ALL_df$Fruit.Pres) #19 cases without fruit present
cutblock_plots_openings_Buff_ALL_df$Fruit.Abun #Many NAs

#cutblock_plots_openings_Buff_ALL_df_FruitNotNA<-subset(cutblock_plots_openings_Buff_ALL_df, cutblock_plots_openings_Buff_ALL_df$Fruit.Abun!="NA") #240 results
#table(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Fruit.Pres) #30 not fruit presents and 210 yes presents. Thus some of the 112 reports of fruit not present was NA. Go back and add back in.

#
cutblock_plots_openings_Buff_ALL_df$Fruit.AbunTEST<-ifelse((cutblock_plots_openings_Buff_ALL_df$Fruit.Pres=="0" & is.na(cutblock_plots_openings_Buff_ALL_df$Fruit.Abun)), 0, cutblock_plots_openings_Buff_ALL_df$Fruit.Abun)
  
#
table(cutblock_plots_openings_Buff_ALL_df$Fruit.AbunTEST)
cutblock_plots_openings_Buff_ALL_df$Fruit.AbunTEST

cutblock_plots_openings_Buff_ALL_df$Species.Pr
cutblock_plots_openings_Buff_ALL_df$Fruit.Pres

#Remaining NAs have fruit, but no record for how many
cutblock_plots_openings_Buff_ALL_df_FruitNotNA<-subset(cutblock_plots_openings_Buff_ALL_df, cutblock_plots_openings_Buff_ALL_df$Fruit.AbunTEST!="NA") #127
table(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Fruit.Pres) # 19 absences, 108 presences.
```



############ Prepare Climate Variables for P/A and % Cover #########

```{r}
#Make annual PAS (precipitation as snow). Here we want to use the decade ClimateBC data for P/A and % Cover
cutblock_plots_openings_Buff_ALL_df$PAS_at_dec<-as.numeric(cutblock_plots_openings_Buff_ALL_df$PAS_at_dec)
cutblock_plots_openings_Buff_ALL_df$PAS_sm_dec<-as.numeric(cutblock_plots_openings_Buff_ALL_df$PAS_sm_dec)
cutblock_plots_openings_Buff_ALL_df$PAS_sp_dec<-as.numeric(cutblock_plots_openings_Buff_ALL_df$PAS_sp_dec)
cutblock_plots_openings_Buff_ALL_df$PAS_wt_dec<-as.numeric(cutblock_plots_openings_Buff_ALL_df$PAS_wt_dec)

cutblock_plots_openings_Buff_ALL_df$PAS_total<-cutblock_plots_openings_Buff_ALL_df$PAS_at_dec + cutblock_plots_openings_Buff_ALL_df$PAS_sm_dec + cutblock_plots_openings_Buff_ALL_df$PAS_sp_dec + cutblock_plots_openings_Buff_ALL_df$PAS_wt_dec

#Repeat for abundance data
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_at_dec<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_at_dec)
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_sm_dec<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_sm_dec)
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_sp_dec <-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_sp_dec )
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_wt_dec<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_wt_dec)

cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_total<-cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_at_dec + cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_sm_dec + cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_sp_dec + cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PAS_wt_dec

```

Check lat-long.

```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Lat
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Long

names(cutblock_plots_openings_Buff_ALL_df_FruitNotNA)
table(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$G_BGC_ZONE)
```


Save files.

```{r}
write.csv(cutblock_plots_openings_Buff_ALL_df_FruitNotNA, file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Buff_ALL_df_FruitNotNA.csv")

write.csv(cutblock_plots_openings_Buff_ALL_df, file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Buff_ALL_df_Berries.csv")
```

#Determine density of plants by cutblock size.
Keep in mind that cutblocks that are adjacent to each other are still currently not combined together to represent total cutblock size.

```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$planted_density_TOT #This indicates planting density of the up to 5 species planted. Probably more accurate than creating a proxy. But note, not all have this info, so will lose more data again. Lots of NAs - remove? Make 0? Investigate if these ones are the few without planting.
table(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Planted_ALL) 
#There are more than 13 records With NAs :( But only 13 without planting.

#Make ifelse statement for Planted to be 0 density planted if not planted.

```


##################### BEGIN VISUALIZATIONS ###############

Visualize differences by categories.

1. Berry abundance by canopy closure, by BEC

```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Fruit.AbunTEST
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Canopy.Cov
table(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$G_BGC_ZONE) #Might need to combine SBPS (n=1) with something else, or just exclude. Also may need to do something with IDF (7).
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$G_BGC_ZONE 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Canopy.Cov, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Canopy Cover",
        x = "Canopy Cover (%)",
        y = "Berry Abundance")  #+


#Remove BEC
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Canopy.Cov, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Canopy Cover",
        x = "Canopy Cover (%)",
        y = "Berry Abundance") 
```

Compare to origin age.
```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Time Since Cutblock",
        x = "Time Since Logging",
        y = "Berry Abundance") 

#By BEC
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST,colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Time Since Cutblock",
        x = "Time Since Logging",
        y = "Berry Abundance") 
```

Comapre to VRI age.

```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$vri_age #some NAs

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = vri_age, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by VRI Age",
        x = "VRI age",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = vri_age, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by VRI Age",
        x = "VRI age",
        y = "Berry Abundance") 
```


Compare age of cutblock to canopy cover.

```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Canopy.Cov, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Canopy.Cov)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Canopy.Cov)) +
  geom_point () +
  geom_smooth (se=F) +
    theme(panel.background = element_rect(fill = "transparent"),
        panel.border = element_rect(linetype = "solid", fill = NA)) +
  labs (
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

cor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$TimeSinceCutblock, cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Canopy.Cov) #0.70
```


#Look at Growing Degree Days
```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$DD5_at_0

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = DD5_at_0, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Growing Degree Days",
        x = "Growing Degree Days > 5",
        y = "Berry Abundance") 
```

```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$heatload

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = heatload, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Heatload",
        x = "Heatload",
        y = "Berry Abundance") 

```

Plot berry abundance by plant cover; but note, not complete.

```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Species.Co #About half have NAs
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Species.Co<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Species.Co)
cor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Species.Co, cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Fruit.AbunTEST, use = "complete.obs") #0.05

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Species.Co, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Species Cover",
        x = "Species Cover (%)",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Species.Co, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Species Cover",
        x = "Species Cover (%)",
        y = "Berry Abundance") 
```

By Species Height.
```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Species.He #Only a handful of NAs, actually not too bad
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Species.He<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Species.He)

cor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Species.He, cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Fruit.AbunTEST, use = "complete.obs") #0.27 - this correlation is stronger

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Species.He, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Species Height",
        x = "Species Height (cm)",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Species.He, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Species Height",
        x = "Species Height (cm)",
        y = "Berry Abundance") 
```


planted_density_TOT
# We see not much influence of planting density on berry production here
```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = planted_density_TOT, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Planting Density",
        x = "Planting Density (trees/ha)",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = planted_density_TOT, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Buffaloberry Berry Abundance by Planting Density",
        x = "Planting Density (trees/ha)",
        y = "Berry Abundance") 
```


```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Fruit.Cove<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Fruit.Cove)
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Fruit.Cove #Lots of missing values
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Burned<-as.factor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Burned)
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Burned # We somehow have NA values. Assume not burned.
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Burned[is.na(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Burned)]<-0

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Burned, y = Fruit.AbunTEST)) +
  geom_boxplot () +
  labs (x = "Not Burned (0), Burned(1)",
        y = "Buffaloberry Fruit Cover")

#No difference
```

Assess for differences in stand age by category.

```{r}
cutblock_plots_openings_Buff_ALL_df$Burned<-as.factor(cutblock_plots_openings_Buff_ALL_df$Burned)

ggplot (cutblock_plots_openings_Buff_ALL_df, aes (x = Burned, y = origin.age)) +
  geom_boxplot () +
  labs (x = "Not Burned (0), Burned(1)",
        y = "Stand Age")

#Stand age is greater in burned areas.
```

Determine canopy cover and stand age by breaking it into burned and not burned.

```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Canopy.Cov, colour = factor(Burned))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(Burned))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 


ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Canopy.Cov, y = Fruit.AbunTEST, colour = factor(Burned))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```

#Repeat for Mechanical treatment
#using Mechanical2 

```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Canopy.Cov, colour = factor(Mechanical2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(Mechanical2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Canopy.Cov, y = Fruit.AbunTEST, colour = factor(Mechanical2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```

#Repeat for if planted or not

```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Canopy.Cov, colour = factor(PLANTED))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(PLANTED))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Canopy.Cov, y = Fruit.AbunTEST, colour = factor(PLANTED))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```

Does clearcut technique matter?

```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Canopy.Cov, colour = factor(DN1_SILSYS_GP))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(DN1_SILSYS_GP))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Canopy.Cov, y = Fruit.AbunTEST, colour = factor(DN1_SILSYS_GP))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```

Differences by main species planted?

```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Canopy.Cov, colour = factor(Qa))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(Qa))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Canopy.Cov, y = Fruit.AbunTEST, colour = factor(Qa))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```


Start season of operations.
```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA2<-subset(cutblock_plots_openings_Buff_ALL_df_FruitNotNA, cutblock_plots_openings_Buff_ALL_df_FruitNotNA$START_SEASON!="NA")

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA2, aes (x = origin.age, y = Canopy.Cov, colour = factor(START_SEASON))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA2, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(START_SEASON))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA2, aes (x = Canopy.Cov, y = Fruit.AbunTEST, colour = factor(START_SEASON))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```


Cutblock Area.
AREA_SQM
```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = AREA_SQM, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Area of Cutblock",
        x = "Area of Cutblock",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = AREA_SQM, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Area of Cutblock",
        x = "Area of Cutblock",
        y = "Berry Abundance") 


```

#Chemicals
Chem2
```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Chem2 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Canopy.Cov, y = Fruit.AbunTEST, colour = factor(Chem2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover and Chemical Application",
        x = "Canopy Cover",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = TimeSinceCutblock, y = Fruit.AbunTEST, colour = factor(Chem2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time and Chemical Application",
        x = "Time Since Cutblock",
        y = "Berry Abundance") 
```

#Brushing
Brush2
```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Canopy.Cov, y = Fruit.AbunTEST, colour = factor(Brush2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover and Brushing",
        x = "Canopy Cover",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = TimeSinceCutblock, y = Fruit.AbunTEST, colour = factor(Brush2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time and Brushing",
        x = "Time Since Cutblock",
        y = "Berry Abundance") 
```

Look at raw data relationhship shapes to each climate variable

```{r}
str(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$TSAND)
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$TSAND<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$TSAND)
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$TSAND

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = TSAND, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Berry Abundance in Cutblocks by % Sand",
        x = "% Sand",
        y = "Berry Abundance")
```


```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Tave_wt_0, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Average Winter Temperature Season Prior",
        x = "Average Winter Temp",
        y = "Berry Abundance")

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Tave_wt_1, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Average Winter Temperature Season Prior",
        x = "Average Winter Temp",
        y = "Berry Abundance")
#Relationship may be more hump shaped centred around -7 degrees as opposed to linear
```

Spring Temperature.
```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Tave_sp_0, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Average Spring Temperature Season Prior",
        x = "Average Spring Temp",
        y = "Berry Abundance")

```

Summer Temperature.
```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = Tave_sm_0, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Average Summer Temperature Season Prior",
        x = "Average Summer Temp",
        y = "Berry Abundance")

```


```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = PAS_total, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Precipitation as Snow",
        x = "Precipitation as snow (mm)",
        y = "Berry Abundance")
```


```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PH2
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PH2<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PH2)

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = PH2, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by pH",
        x = "Soil PH",
        y = "Berry Abundance")
#Extrapolated to those <2 pH likely false
```


```{r}
plot(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_30m_, cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_ha_bc) #Not the same... but positively correlated

cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_30m_<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_30m_)
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_ha_bc<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_ha_bc)

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = slope_30m_, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Slope",
        x = "Slope",
        y = "Fruit Abundance")
#Weak relationship (positive)
```

```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = slope_ha_bc, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Slope",
        x = "Slope",
        y = "Fruit Abundance")
```

```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_30m<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_30m)

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = aspect_30m, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Coverby Apsect",
        x = "Aspect",
        y = "Fruit Abundance")
```

```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_ha_bc<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_ha_bc)

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = aspect_ha_bc, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Aspect",
        x = "Aspect",
        y = "Fruit Abundance")
```

```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$cos_aspect<-cos(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_ha_bc)

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = cos_aspect, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Aspect",
        x = "cos(Aspect)",
        y = "Fruit Abundance")
```


```{r}
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$dem_ha_bc<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$dem_ha_bc)

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = dem_ha_bc, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by Elevation",
        x = "Elevation (m)",
        y = "Fruit Abundance")
```


#Because max slope ~40 degrees, can create an SAI (slope-aspect index) value: example = sin(aspect +225) x (slope/45).

```{r}
names(cutblock_plots_openings_Buff_ALL_df_FruitNotNA)
hist(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_ha_bc)
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SLOPE<-as.numeric(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_ha_bc)
max(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SLOPE) 
hist(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_ha_bc)

cor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SLOPE, cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_30m_) #0.70
plot(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SLOPE ~ cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_30m_) #Quite different. Perhaps use point values and use DEM to get slope and aspect? Or use the cutblock data because it likely takes the average for the cutblock which is probably more representative.
plot(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_ha_bc ~ cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_30m)


cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SAI_cb<-(sin(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_ha_bc + 225) *(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SLOPE/58.9)) #SAI (Slope to aspect Index) of cutblock data slope and aspect
cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SAI_rec<-(sin(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$aspect_30m + 225) *(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$slope_30m_/45)) #SAI of slope and aspect from Clayton's data

hist(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SAI_cb)
hist(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SAI_rec)
plot(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SAI_cb ~ cutblock_plots_openings_Buff_ALL_df_FruitNotNA$SAI_rec) # The result is COMPLETELY different, depending on which values are used. No correlation what so ever.

```

Compare probabilities between values.

```{r}

ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = SAI_cb, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by SAI",
        x = "SAI_cb",
        y = "Species Cover")
```

```{r}
ggplot (cutblock_plots_openings_Buff_ALL_df_FruitNotNA, aes (x = SAI_rec, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Buffaloberry Percent Cover by SAI",
        x = "SAI_rec",
        y = "Species Cover")
```











##ALL BELOW MODELS NEED UPDATING: MARCH 18, 2022 ###



#####################  Begin Exploratory Analyses ###########################

#Explore these Harvesting Variables:
DN1_SILSYS_GP #Maybe
Mechanical2
Burned
Brush2
Chem2
G_BGC_ZONE
OPEN_GRSAR OR AREA_SQM (on in ha and one km square)
PLANTED
Origin.age/TimeSinceCutblock
START_SEASON

#Potential Seasonal variables And:
heatload

PAS_total
Tave_wt_1
Tave_sp_0
Tave_sm_0
DD5_0


```{r}

cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PLANTED<-as.factor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$PLANTED)

cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Mechanical2<-as.factor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Mechanical2)

cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Burned<-as.factor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Burned)

cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Manual2<-as.factor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Manual2)

cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Brush2<-as.factor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Brush2)

cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Chem2<-as.factor(cutblock_plots_openings_Buff_ALL_df_FruitNotNA$Chem2)

```

#Model Series 1:
DN1_SILSYS_GP + Manual2 + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock + START_SEASON + heatload + Manual2*TimeSinceCutblock + START_SEASON*TimeSinceCutblock + Chem2*TimeSinceCutblock + Species.He

#Model Series 2:
DN1_SILSYS_GP + Manual2 + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + Canopy.Cov + START_SEASON + heatload + Manual2*Canopy.Cov + START_SEASON*Canopy.Cov + Chem2*Canopy.Cov + Species.He

#Could investigate as linear models; but GAMs might be better

```{r}
#Model using Time Since Cutblock
model.new2.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + Manual2 + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock + START_SEASON + heatload + Manual2*TimeSinceCutblock + START_SEASON*TimeSinceCutblock + Chem2*TimeSinceCutblock + Species.He,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA)

Anova(model.new2.1, type=3) #
summary(model.new2.1) #
AIC(model.new2.1) #1724.751
summary(model.new2.1)$r.squared #0.23
summary(model.new2.1)$adj.r.squared #-0.03

#Remove least significant

```


```{r}
#Best model
model.new2.1 <- lm (Fruit.AbunTEST ~ , data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA)

#Check model fit
# model diagnostic plots
binnedplot (fitted(model.new2.1), 
            residuals(model.new2.1), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

#Explore partial residuals with current model
#
library(visreg)

visreg(model.new2.1, "DN1_SILSYS_GP")
visreg(model.new2.1, "Burned")
visreg(model.new2.1, "Chem2")
visreg(model.new2.1, "Manual2", by="TimeSinceCutblock")
visreg(model.new2.1, "TimeSinceCutblock", by="Manual2")

visreg(model.new2.1, "G_BGC_ZONE")

visreg(model.new2.1, "heatload")
visreg(model.new2.1, "START_SEASON")

visreg(model.new2.1, "Species.He")


```

Model 2: Canopy Cover
```{r}
model.new2.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + Manual2 + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + Canopy.Cov + START_SEASON + heatload + Manual2*Canopy.Cov + START_SEASON*Canopy.Cov + Chem2*Canopy.Cov + Species.He,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA)

Anova(model.new2.2, type=3) #
summary(model.new2.2) #
AIC(model.new2.2) # 1722.615
summary(model.new2.2)$r.squared #0.25
summary(model.new2.2)$adj.r.squared #-0.01

#Remove Least Significant



```


```{r}
#Best model
model.new2.2 <- lm (Fruit.AbunTEST ~ + ,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA)

#Check model fit
# model diagnostic plots
binnedplot (fitted(model.new2.1), 
            residuals(model.new2.1), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

#Explore partial residuals with current model
# 
library(visreg)

visreg(model.new2.2, "Manual2")
visreg(model.new2.2, "Burned")
visreg(model.new2.2, "Brush2")

visreg(model.new2.2, "G_BGC_ZONE")
visreg(model.new2.2, "Canopy.Cov")

visreg(model.new2.2, "heatload")
visreg(model.new2.2, "START_SEASON")

visreg(model.new2.2, "Species.He")
```


Ensure data saved.

```{r}
write.csv(cutblock_plots_openings_Buff_ALL_df_FruitNotNA, file="c:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Buff_ALL_df_FruitNotNA_March18.csv")
```


### Try above as GAMs
#Model Series 1:
DN1_SILSYS_GP + Manual2 + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock + START_SEASON + heatload + Manual2*TimeSinceCutblock + START_SEASON*TimeSinceCutblock + Chem2*TimeSinceCutblock + Species.He

#Model Series 2:
DN1_SILSYS_GP + Manual2 + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + Canopy.Cov + START_SEASON + heatload + Manual2*Canopy.Cov + START_SEASON*Canopy.Cov + Chem2*Canopy.Cov + Species.He

```{r}
library(mgcv)

model.new2.1b <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + Burned + Brush2 + Chem2 + G_BGC_ZONE + s(OPEN_GRSAR) + PLANTED + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Burned) + s(TimeSinceCutblock, by=Mechanical2) + s(TimeSinceCutblock, by=Brush2) + START_SEASON + s(TimeSinceCutblock, by=START_SEASON) + s(heatload) + s(Species.He) +s(Tave_wt_1),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

#Too little data to perform above. Need to remove some terms

model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Burned) + s(TimeSinceCutblock, by=Mechanical2) + s(TimeSinceCutblock, by=Brush2) + START_SEASON + s(TimeSinceCutblock, by=START_SEASON) + s(Species.He) +s(Tave_wt_1),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

#Still too many
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Burned) + s(TimeSinceCutblock, by=Mechanical2) + s(TimeSinceCutblock, by=Brush2) + START_SEASON + s(Species.He) ,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.106, Deviance explained 29.4%
AIC(model.new2.1b) #1710.708

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove smoothing on key variables
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(TimeSinceCutblock, by=Chem2) + c(TimeSinceCutblock)*Burned + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2 + START_SEASON + s(Species.He) ,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.106, Deviance explained 29.5%
AIC(model.new2.1b) #1710.701

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2 + START_SEASON + s(Species.He) ,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.115, Deviance explained 29.4%
AIC(model.new2.1b) #1708.9

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + c(TimeSinceCutblock)*Chem2 + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2 + START_SEASON + s(Species.He) ,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.107, Deviance explained 28.4%
AIC(model.new2.1b) #1708.9

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2 + START_SEASON + s(Species.He) ,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.108, Deviance explained 27.2%
AIC(model.new2.1b) #1708.9

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2 + START_SEASON + s(Species.He) ,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.108, Deviance explained 27.2%
AIC(model.new2.1b) #1708.9

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Try to add season back in
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2 + START_SEASON + s(Species.He) + s(TimeSinceCutblock, by=START_SEASON),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.077, Deviance explained 27.3%
AIC(model.new2.1b) #1713.3

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2  + s(Species.He) ,
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.134, Deviance explained 26.9%
AIC(model.new2.1b) #1702.6

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + PLANTED + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2  + s(Species.He),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.152, Deviance explained 24%
AIC(model.new2.1b) #1696.2

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Try Chem interaction given observed patterns
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + PLANTED + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2  + s(TimeSinceCutblock, by=Chem2) + s(Species.He),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.148, Deviance explained 24.9%
AIC(model.new2.1b) #1698.33

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + PLANTED + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2 +  c(TimeSinceCutblock)*Chem2  + s(Species.He),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.142, Deviance explained 24%
AIC(model.new2.1b) #1698.1

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~ Burned + Brush2  + PLANTED + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2  + s(Species.He),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.161, Deviance explained 24%
AIC(model.new2.1b) #1694.2

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~  Brush2  + PLANTED + Mechanical2 + s(TimeSinceCutblock, by=Mechanical2) + c(TimeSinceCutblock)*Brush2  + s(Species.He),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.162, Deviance explained 24.1%
AIC(model.new2.1b) #1694.0

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~  Brush2  + PLANTED + Mechanical2 + s(TimeSinceCutblock, by=Mechanical2) + s(Species.He),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.159, Deviance explained 23.1%
AIC(model.new2.1b) #1693.5

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

#Remove least significant
model.new2.1b <- gam (Fruit.AbunTEST ~  PLANTED + Mechanical2 + s(TimeSinceCutblock, by=Mechanical2) + s(Species.He),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.1b) #Model not performing well
anova(model.new2.1b)
summary(model.new2.1b) #Adjusted R-square = 0.16, Deviance explained 22.2%
AIC(model.new2.1b) #1692.5

library(mgcViz)
getViz(model.new2.1b)
plot(model.new2.1b)

plot(model.new2.1b, select=1)
plot(model.new2.1b, select=2)
plot(model.new2.1b, select=3)

library(visreg)
visreg(model.new2.1b, "PLANTED")
visreg(model.new2.1b, "Mechanical2", by="TimeSinceCutblock")
visreg(model.new2.1b, "TimeSinceCutblock", by="Mechanical2")
visreg(model.new2.1b, "Species.He")
visreg(model.new2.1b, "TimeSinceCutblock")



```

Repeat for Canopy Cover.

```{r}
model.new2.2b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(Canopy.Cov, by=Chem2) + s(Canopy.Cov, by=Burned) + s(Canopy.Cov, by=Mechanical2) + s(Canopy.Cov, by=Brush2) + START_SEASON + s(Species.He),
data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.06, Deviance explained 24.1%
AIC(model.new2.2b) #1711.47

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#COnvert to linear for certain variables
model.new2.2b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + c(Canopy.Cov)*Chem2 + s(Canopy.Cov, by=Burned) + s(Canopy.Cov, by=Mechanical2) + s(Canopy.Cov, by=Brush2) + START_SEASON + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.065, Deviance explained 24.1%
AIC(model.new2.2b) #1711.47

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + c(Canopy.Cov)*Chem2 + s(Canopy.Cov, by=Burned) + s(Canopy.Cov, by=Mechanical2) + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.091, Deviance explained 23.6%
AIC(model.new2.2b) #1706.5

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + PLANTED + c(Canopy.Cov)*Chem2 + s(Canopy.Cov, by=Burned) + s(Canopy.Cov, by=Mechanical2) + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.122, Deviance explained 22.2%
AIC(model.new2.2b) #1699.5

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + PLANTED + c(Canopy.Cov)*Chem2 + c(Canopy.Cov)*Burned + s(Canopy.Cov, by=Mechanical2) + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.123, Deviance explained 22.4%
AIC(model.new2.2b) #1699.5

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + PLANTED + c(Canopy.Cov)*Burned + s(Canopy.Cov, by=Mechanical2) + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.133, Deviance explained 22.4%
AIC(model.new2.2b) #1697.7

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~ Burned + Brush2 + Chem2 + PLANTED + s(Canopy.Cov, by=Mechanical2) + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.124, Deviance explained 20%
AIC(model.new2.2b) #1696.4

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~ Burned + Brush2+ PLANTED + s(Canopy.Cov, by=Mechanical2) + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.13, Deviance explained 19.6%
AIC(model.new2.2b) #1694.7

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~  Brush2+ PLANTED + s(Canopy.Cov, by=Mechanical2) + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.137, Deviance explained 19.4%
AIC(model.new2.2b) #1693.1

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~  Brush2+ PLANTED + Mechanical2 + c(Canopy.Cov)*Mechanical2 + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.127, Deviance explained 19.3%
AIC(model.new2.2b) #1694.9

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~  Brush2+ PLANTED + Mechanical2 + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.126, Deviance explained 18.3%
AIC(model.new2.2b) #1694.1

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

#Remove least sig
model.new2.2b <- gam (Fruit.AbunTEST ~  Brush2+ PLANTED + s(Canopy.Cov) + s(Canopy.Cov, by=Brush2) + Species.He, data=cutblock_plots_openings_Buff_ALL_df_FruitNotNA, method="REML")

gam.check(model.new2.2b)
anova(model.new2.2b)
summary(model.new2.2b) #Adjusted R-square = 0.135, Deviance explained 18.4%
AIC(model.new2.2b) #1692.2

library(mgcViz)
getViz(model.new2.2b)
plot(model.new2.2b)

plot(model.new2.2b, select=1)
plot(model.new2.2b, select=2)

#Brush2+ PLANTED + s(Canopy.Cov, by=Brush2) + Species.He
library(visreg)
visreg(model.new2.2b, "PLANTED")
visreg(model.new2.2b, "Brush2")
visreg(model.new2.2b, "Species.He")
visreg(model.new2.2b, "Canopy.Cov", by="Brush2")
visreg(model.new2.2b, "Brush2", by="Canopy.Cov")
visreg(model.new2.2b, "Canopy.Cov")


```


