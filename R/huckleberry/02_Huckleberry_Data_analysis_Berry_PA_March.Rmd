---
title: "Huckleberry_Data_analysis"
author: "Cora Skaien"
date: "14/01/2022"
output: html_document
---
<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(data.table)
library(sf)
library(tidyverse)
library(rgeos)
library(cleangeo)
library(dplyr)
library(tidyr)
library(ggplot2)
library(rgdal)
library(keyring)
library(DBI)
library(rgeos)
library(car)
library(rje)
library(caret)
library(pROC)
library(visreg)
library(arm)
library(mgcv)
library(mgcViz)

#source(here::here("R/functions/R_Postgres.R"))
```

##Data sets for what purpose
Percent cover huckleberry and berry abundance: cutblock_plots_openings_Huck_ALL_df_2022_b2

This dataset already has the two datasets combined together.

#Overview
This file continues from huckleberry&buffaloberry_data_processing_Jan2022. Here, we explore how silviculture practices influence the abundance of huckleberry berries. 


#Load Data In
```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2<-read.csv(file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Huck_ALL_df_2022_b2.csv")
head(cutblock_plots_openings_Huck_ALL_df_2022_b2)
                                                  
```


#Begin Exploration of variables
```{r}
head(cutblock_plots_openings_Huck_ALL_df_2022_b2)
names(cutblock_plots_openings_Huck_ALL_df_2022_b2)

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Species.Pr) #136 absences, 453 presences; some NAs - why NAs? Unsure, in raw data, must remove.
cutblock_plots_openings_Huck_ALL_df_2022_b2_ALL<-cutblock_plots_openings_Huck_ALL_df_2022_b2
cutblock_plots_openings_Huck_ALL_df_2022_b2<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2, cutblock_plots_openings_Huck_ALL_df_2022_b2$Species.Pr!="NA")

cutblock_plots_openings_Huck_ALL_df_2022_b2<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2, cutblock_plots_openings_Huck_ALL_df_2022_b2$Species.Pr!="0")

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.Pres) #123 absences, 316 presences; also lots of NAs.

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Species.y) #495

cutblock_plots_openings_Huck_ALL_df_2022_b22<-cutblock_plots_openings_Huck_ALL_df_2022_b2 #Save as a back up for now

cutblock_plots_openings_Huck_ALL_df_2022_b2<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2, cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.Pres!="NA") #439 data points

```

## Looking at DN1_DIS_CD (DENUDATION_1_DISTURBANCE_CODE) between openings and openings + activity files
```{r}
#See if worth losing the data points - i.e., do we have consistent good data within this.
head(cutblock_plots_openings_Huck_ALL_df_2022_b2)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$G_BGC_ZONE) #BEC Zone: ESSF, ICH, MS, SBS
cutblock_plots_openings_Huck_ALL_df_2022_b2$OPEN_GRSAR<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$OPEN_GRSAR)
hist(cutblock_plots_openings_Huck_ALL_df_2022_b2$OPEN_GRSAR) #total area the opening encompasses
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_DIS_CD) # 15 B (burned wildfire); 492 logged (L); 1 P (pest); 1 S (Salvage);626 total (so 5 missing data)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN2_DIS_CD) #Additional elements; 115 total

#Create an ifelse statement to get a new category in case there are any DSN1s with NAs taht have a DSN2 input
#cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_2_DIS_CD<- ifelse (is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_DIS_CD), cutblock_plots_openings_Huck_ALL_df_2022_b2$DN2_DIS_CD, cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_DIS_CD)
#table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_2_DIS_CD)# 626; same as initial, so no improvement

```

May wish to remove P, S and W, and B

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2, cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_DIS_CD!="P")
cutblock_plots_openings_Huck_ALL_df_2022_b2<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2, cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_DIS_CD!="S")
cutblock_plots_openings_Huck_ALL_df_2022_b2<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2, cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_DIS_CD!="B")

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_DIS_CD) #423 logged
```

#Inspect DN1_SILSYS (DENUDATION_1_SILV_SYSTEM_CODE)
```{r}
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS) #84 CCRES (Clearcut with reserves); 224 Clearcut; 13 SELEC (Selective logging) spattering of others; 
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN2_SILSYS)
#Do same as above to see if can get additional data inputs
#cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_2_SILSYS<- ifelse (is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS), cutblock_plots_openings_Huck_ALL_df_2022_b2$DN2_SILSYS, cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS)
#table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_2_SILSYS)#No improvement, and names now turned to numbers?

#May wish to group the smaller groups into an "other" category
cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP<-cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS
cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP <- recode_factor(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP, CCRES = "CCRES", CLEAR = "CLEAR", IMCUT  = "Other", PATCT = "Other", RETEN= "Other", SEEDT = "Other", SELEC = "Other", SHELT = "Other")
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP) 

cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP #NAs exist... turn them into Other? Or maybe Unknown.
cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP)

library(forcats) 
cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP<-fct_explicit_na(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP, na_level = "Unknown")

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP) #COuld consider combining Unknown and Other? They are slightly different, however, but Other is such a small category. Consider this if partial residuals are wonky.

```

#Investigate other categories
```{r}
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILVAR) # Not many records; not useful
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH) # 146 BU (burn), 163 ME (mechanical), others; --> Ma maybe manual?
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH)
# Mostly same categories as above at different values
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH)
#cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2_TECH<- ifelse (is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH), cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH)
#table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2_TECH)# 516; get two additional one, but names messed up (become numbers)
```


```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2<-paste(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH,cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2) #336 records of NA, lots of combinations otherwise. Maybe make a column that is yes/no for each technique that is considered important? We see that the 2 in above that we gain are the "NA GS" here. We also see that some were burned first and then had mechanical treatment (50), and some had mechanical treatment and then were burned (57)

cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH)

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2)

##All 3 of the ifelse statements below get the same result
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_TECH <- ifelse (cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2 == "BU ME", cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2, ifelse (cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2 == "ME BU", cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH))

cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_TECH <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2 == "BU ME" | cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2 == "ME BU"), cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_TECH <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2 == "ME BU" | cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2 == "BU ME"), cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH) #get same result if change order of names
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_TECH)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_TECH) #1 = BU; 2=CA; 3=CG; 4=GS; 5=MA; 6=ME; 7=BI; 24=?? NA? 
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_2)

cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_TECH_2<-paste(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_TECH)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_TECH_2) #This helps fix the weird error above; n = 641 

```

Create additional columns that indicate whether burning happened and whether mechanical application happened.

```{r}

cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH == "BU" | cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH == "BU"), 1, 0)

#Attempt 2
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH != "BU" & cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH != "BU"), 0, 1)                                                     
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU)    #103 not burned, 200 burned; MANY NAs
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU
#Lots of NAs - there should be no NAs. It is an ifelse statement where all should be 1s or 0s...
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH) #156 burned
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH) #67 burned
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_TECH_2) #122 Bu Bu (so burned both times); so 200 burned seemed realistic

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH) #Won't see all because many NAs in PREP2_TECH; here 23 are BU BU


table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU)

cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU[is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU)]<-0
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU) #This looks better, but keep in mind that some that had no info may have had treatments not listed; 306 not burned, 186 burned

#Compare PREP_BU to Burned from atu data
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU, cutblock_plots_openings_Huck_ALL_df_2022_b2$Burned)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU) #161 yes
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Burned) #176 yes, so 15 more (perhaps wildfires?)

```

Repeat for mechanical.

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH == "ME" | cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH == "ME"), 1, 0)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME) #There should be a LOT more data here
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME # A lot of NAs: turn to 0s
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME[is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME)]<-0
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME) #This looks better, but keep in mind that some that had no info may have had treatments not listed; 291 no mechanical treatment, 201 mechanical treatment

#Compare PREP_ME to Mechanical from atu data
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME, cutblock_plots_openings_Huck_ALL_df_2022_b2$Mechanical) #14 more yeses for one, and 10 different moreyeses for other...
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME) #180 yes
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Mechanical) #184 yes

cutblock_plots_openings_Huck_ALL_df_2022_b2$Mechanical2<-ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$Mechanical==1,1, 
                                                                ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME==1,1,0))
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Mechanical2) #914 yeses, combining infor from both

```
Repeat for MA (manual?)

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH == "MA" | cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP2_TECH == "MA"), 1, 0)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA) #There should be a LOT more data here
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA # A lot of NAs: turn to 0s
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA[is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA)]<-0
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA) #This looks better, but keep in mind that some that had no info may have had treatmeants not listed; 20 manual treatment, 472 no manual treatment' not useful, do not use.

#Compare PREP_MA to Manual from atu data
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA, cutblock_plots_openings_Huck_ALL_df_2022_b2$Manual) #Dramatic differences
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA) #19 yeses
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Manual) #142 yeses

cutblock_plots_openings_Huck_ALL_df_2022_b2$Manual2<-ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$Manual==1,1, 
                                                                ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA==1,1,0))
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Manual2) #145 yeses, combining info from both
#Perhaps this firm manual refers to something different and not brushing?

```


```{r}
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRSH1_TECH)#Brushing technique; 121 MA (manual); 16 CG (Chemical Ground); 4 CA (Chemical Air); and others

cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_MA <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$BRSH1_TECH == "MA"), 1, 0)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_MA) #There should be a LOT more data here

cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_MA # A lot of NAs: turn to 0s
cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_MA[is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_MA)]<-0
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_MA) #This looks better, but keep in mind that some that had no info may have had treatmeants not listed; 112 manual brushing, 311 not

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Brushing_ALL, cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_MA)

cutblock_plots_openings_Huck_ALL_df_2022_b2$Brush2<-ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$Brushing_ALL==1,1, 
                                                                ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_MA==1,1,0))
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Brush2) #140 yeses, combining info from both
```


```{r}
#Repeat for chemical
cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_CM <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$BRSH1_TECH == "CA" | cutblock_plots_openings_Huck_ALL_df_2022_b2$BRSH1_TECH== "CG"), 1, 0)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_CM) #There should be a LOT more data here

cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_CM # A lot of NAs: turn to 0s
cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_CM[is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_CM)]<-0
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_CM) #This is whether brushing with chemicals was applied; 20 chemical brushing, 472 not

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_CM, cutblock_plots_openings_Huck_ALL_df_2022_b2$Chemical) #Some differences

cutblock_plots_openings_Huck_ALL_df_2022_b2$Chem2<-ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$Chemical==1,1, 
                                                                ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$BRUSH_CM==1,1,0))
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Chem2) #40 yeses, combining info from both

```


```{r}
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_TECH) #Mostly PL (planting). RP (replanting). FP (Fill planting). Do NAs mean no planting? Or unknown?
cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_TECH
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT2_TECH)

cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_2_TECH<-paste(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_TECH, cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT2_TECH)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_2_TECH)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_2_TECH<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_2_TECH)

cutblock_plots_openings_Huck_ALL_df_2022_b2$PLANTED<- ifelse (cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_2_TECH=="NA NA", 0, 1)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLANTED) #Very uneven sample size.
#With current data, 386 planted, 37 not.

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLANTED, cutblock_plots_openings_Huck_ALL_df_2022_b2$Planted_ALL) #A few differences

cutblock_plots_openings_Huck_ALL_df_2022_b2$Planted2<-ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$Planted_ALL==1,1, 
                                                                ifelse(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLANTED==1,1,0))
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Planted2) #387 yeses, combining info from both; 31 nos
```


```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2$FEAT_AREA<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$FEAT_AREA)
hist(cutblock_plots_openings_Huck_ALL_df_2022_b2$FEAT_AREA)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_AREA<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_AREA)
hist(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_AREA) #Also has a Plant2, so could add together for total planting area?
cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT2_AREA<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT2_AREA)
hist(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT2_AREA)
cutblock_plots_openings_Huck_ALL_df_2022_b2$TOTAL_plant_area<-cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT1_AREA+cutblock_plots_openings_Huck_ALL_df_2022_b2$PLNT2_AREA
cutblock_plots_openings_Huck_ALL_df_2022_b2$TOTAL_plant_area
cutblock_plots_openings_Huck_ALL_df_2022_b2$TOTAL_plant_area[is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$TOTAL_plant_area)]<-0
cutblock_plots_openings_Huck_ALL_df_2022_b2$TOTAL_plant_area # We will assume an absence is indicative of no planting
hist(cutblock_plots_openings_Huck_ALL_df_2022_b2$TOTAL_plant_area)

cutblock_plots_openings_Huck_ALL_df_2022_b2$PLANTING<-ifelse (cutblock_plots_openings_Huck_ALL_df_2022_b2$TOTAL_plant_area==0, 0, 1)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLANTING) # We see that this is far different than the data for whether planted or not, suggesting that not all planted sites have planting density. These are NOT true 0s and this data can only be used for locations where we know planting occurred.
#Compare to:
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PLANTED)
#New metric obviously incomplete as have 290 0s instead of 56.

```


```{r}
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH) #May wish to combine smaller groups into "other"
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH_GP<-cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH_GP <- recode_factor(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH_GP, BU="BU", CA="Other",CG="Other",GS="Other",MA="Other",ME="ME", "BI"="Other")
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH_GP)
#Not as useful as individual assessments that account for both Phase 1 and Phase 2

library(forcats) 
cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH_GP<-fct_explicit_na(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH_GP, na_level = "Unknown")

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP1_TECH_GP)

```


```{r}
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU) #262 no, 161 yes
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_ME) #243 no, 180 yes
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_MA) #404 no, 19 yes

#With refined data
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Burned) #242 no, 176 yes
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Mechanical2) #224 no, 194 yes
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Manual2) #273 no, 145 yes # But thuis may include brushing now?

#Compare above with data
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Species.Pr) #423 present; ignores BEC plots because only presences there
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Species.Pr, cutblock_plots_openings_Huck_ALL_df_2022_b2$PREP_BU) 
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Species.Pr, cutblock_plots_openings_Huck_ALL_df_2022_b2$DN1_SILSYS_GP) #Only 475 datapoints accounted for here. CCRES = Clearcut with reserves; CLEAR = clearcut

```

Because some of these clearcuts subsequently had fire come through, we must create a new variable that accounts for if fire occurred after but before sampling.

```{r}
# make a new variable that is "origin"
names(cutblock_plots_openings_Huck_ALL_df_2022_b2)
cutblock_plots_openings_Huck_ALL_df_2022_b2$TimeSinceCutblock
cutblock_plots_openings_Huck_ALL_df_2022_b2$TimeSinceFire
cutblock_plots_openings_Huck_ALL_df_2022_b2$CutBlock_O
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$CutBlock_O) #562 indicated as yes. Need to add yes to the appended Laura data.

cutblock_plots_openings_Huck_ALL_df_2022_b2$CutBlock_O[is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$CutBlock_O)]<-1
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$CutBlock_O) #604 - fixed!

cutblock_plots_openings_Huck_ALL_df_2022_b2$origin <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$CutBlock_O == 1 & cutblock_plots_openings_Huck_ALL_df_2022_b2$TimeSinceCutblock < cutblock_plots_openings_Huck_ALL_df_2022_b2$TimeSinceFire), 1, ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$Fire_Occ == 1 & cutblock_plots_openings_Huck_ALL_df_2022_b2$TimeSinceCutblock > cutblock_plots_openings_Huck_ALL_df_2022_b2$TimeSinceFire), 2, 0))
cutblock_plots_openings_Huck_ALL_df_2022_b2$origin <- as.factor (cutblock_plots_openings_Huck_ALL_df_2022_b2$origin)

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$origin) # 1 = most recently logged; 2 = fire after logging. 0 is when harvesting and burning occurred in the same year.

# make a new variable that is age of stands of known origin
cutblock_plots_openings_Huck_ALL_df_2022_b2$origin.age <- ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$origin == 1), cutblock_plots_openings_Huck_ALL_df_2022_b2$TimeSinceCutblock, ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$origin == 2), cutblock_plots_openings_Huck_ALL_df_2022_b2$TimeSinceFire, ifelse ((cutblock_plots_openings_Huck_ALL_df_2022_b2$origin == 0), cutblock_plots_openings_Huck_ALL_df_2022_b2$TimeSinceFire, NA)))

hist(cutblock_plots_openings_Huck_ALL_df_2022_b2$origin.age)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$origin)

```

We only want ones most recently logged, not ones burned since. So remove ones burned more recently than logged.

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_ALL2<-cutblock_plots_openings_Huck_ALL_df_2022_b2
cutblock_plots_openings_Huck_ALL_df_2022_b2<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2, cutblock_plots_openings_Huck_ALL_df_2022_b2$origin=="1") #Drops down to 406
```

Investigate date when operations began and ended

```{r}
head(cutblock_plots_openings_Huck_ALL_df_2022_b2)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DST_STR_DT)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$DST_END_DT)

#Select month that data was collected
library(stringi)
cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_month_START<-stri_sub(cutblock_plots_openings_Huck_ALL_df_2022_b2$DST_STR_DT,5,6)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_month_START) #

cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_month_END<-stri_sub(cutblock_plots_openings_Huck_ALL_df_2022_b2$DST_END_DT,5,6)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_month_END) #

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_month_START, cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_month_END) 

#Get Years
cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_START<-stri_sub(cutblock_plots_openings_Huck_ALL_df_2022_b2$DST_STR_DT,1,4)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_START) #

cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_END<-stri_sub(cutblock_plots_openings_Huck_ALL_df_2022_b2$DST_END_DT,1,4)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_END) #

#How many went between years
str(cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_END)
cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_END<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_END)
cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_START<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_START)

cutblock_plots_openings_Huck_ALL_df_2022_b2$NumYearsTreat<-cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_END - cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_year_START

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$NumYearsTreat) #Some ended 59 years after starting.


#Even though not entirely accurate, let's use the start month as a proxy. Will group September-November as fall, December-February as winter, March-May as Spring and June-August as summer
cutblock_plots_openings_Huck_ALL_df_2022_b2$START_SEASON<-cutblock_plots_openings_Huck_ALL_df_2022_b2$Date_month_START
str(cutblock_plots_openings_Huck_ALL_df_2022_b2$START_SEASON)

cutblock_plots_openings_Huck_ALL_df_2022_b2$START_SEASON<-recode_factor(cutblock_plots_openings_Huck_ALL_df_2022_b2$START_SEASON, "01"="Winter", "02"="Winter","03"="Spring","04"="Spring","05"="Spring","06"="Summer", "07"="Summer", "08"="Summer", "09"="Fall", "10" ="Fall", "11"="Fall", "12" ="Winter")

table(cutblock_plots_openings_Huck_ALL_df_2022_b2$START_SEASON)

```

Investigate the newer variables from Dave Waddell.

```{r}
names(cutblock_plots_openings_Huck_ALL_df_2022_b2)
head(cutblock_plots_openings_Huck_ALL_df_2022_b2)

#Look at Planting density - no records in remaining 470 plots
hist(cutblock_plots_openings_Huck_ALL_df_2022_b2$planted_density_TOT)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Qa) #Dominate species planted when reported; only 238 reported the species of the 406 records
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$planted_species2) #172 records, so suggests Qa was reported most, as not all plotshad a second species

```

Look at how much of the data shows NAs for abundance.
```{r}
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.Pres) #All 406 cases report if fruits or not
cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.Abun #Many NAs

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2, cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.Abun!="NA") #240 results
table(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres) #30 not fruit presents and 210 yes presents. Thus some of the 112 reports of fruit not present was NA. Go back and add back in.

#
cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.AbunTEST<-ifelse((cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.Pres=="0" & is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.Abun)), 0, cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.Abun)
  


#
table(cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.AbunTEST)
cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.AbunTEST

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2, cutblock_plots_openings_Huck_ALL_df_2022_b2$Fruit.AbunTEST!="NA") #240
table(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres) # 112 absences, 210 presences.
```



############ Prepare Climate Variables for P/A and % Cover #########

```{r}
#Make annual PAS (precipitation as snow). Here we want to use the decade ClimateBC data for P/A and % Cover
cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_at_dec<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_at_dec)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_sm_dec<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_sm_dec)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_sp_dec<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_sp_dec)
cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_wt_dec<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_wt_dec)

cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_total<-cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_at_dec + cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_sm_dec + cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_sp_dec + cutblock_plots_openings_Huck_ALL_df_2022_b2$PAS_wt_dec

#Repeat for abundance data
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_at_dec<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_at_dec)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_sm_dec<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_sm_dec)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_sp_dec <-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_sp_dec )
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_wt_dec<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_wt_dec)

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_total<-cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_at_dec + cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_sm_dec + cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_sp_dec + cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PAS_wt_dec

```

Save files.

```{r}
write.csv(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA.csv")

write.csv(cutblock_plots_openings_Huck_ALL_df_2022_b2, file="C:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Huck_ALL_df_2022_b2_Berries.csv")
```

#Determine density of plants by cutblock size.
Keep in mind that cutblocks that are adjacent to each other are still currently not combined together to represent total cutblock size.

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$planted_density_TOT #This indicates planting density of the up to 5 species planted. Probably more accurate than creating a proxy. But note, not all have this info, so will lose more data again.
```




##################### BEGIN VISUALIZATIONS ###############

Visualize differences by categories.

1. Berry abundance by canopy closure, by BEC

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.AbunTEST
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Canopy_Cov
table(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$G_BGC_ZONE) 
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$G_BGC_ZONE 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Canopy_Cov, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Canopy Cover",
        x = "Canopy Cover (%)",
        y = "Berry Abundance")  #+
 # scale_colour_discrete (name = "Stand Origin", labels = c("No Burn No Mechanical", "Mechanical", "Burn", "Burn and Mechanical"))

#Remove BEC
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Canopy_Cov, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Canopy Cover",
        x = "Canopy Cover (%)",
        y = "Berry Abundance") 
```

Compare to origin age.
```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Time Since Cutblock",
        x = "Time Since Logging",
        y = "Berry Abundance") 

#By BEC
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST,colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Time Since Cutblock",
        x = "Time Since Logging",
        y = "Berry Abundance") 
```

Comapre to VRI age.

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$vri_age #some NAs

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = vri_age, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by VRI Age",
        x = "VRI age",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = vri_age, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by VRI Age",
        x = "VRI age",
        y = "Berry Abundance") 
```


Compare age of cutblock to canopy cover.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Canopy_Cov, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Canopy_Cov)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 
```


#Look at Growing Degree Days
```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DD5_at_0

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = DD5_at_0, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Growing Degree Days",
        x = "Growing Degree Days > 5",
        y = "Berry Abundance") 
```

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$heatload

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = heatload, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Heatload",
        x = "Heatload",
        y = "Berry Abundance") 

```

Plot berry abundance by plant cover; but note, not complete.

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Species.Co #Only a handful of NAs, actually not too bad
cor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Species.Co, cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.AbunTEST, use = "complete.obs") #0.22

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Species.Co, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Species Cover",
        x = "Species Cover (%)",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Species.Co, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Species Cover",
        x = "Species Cover (%)",
        y = "Berry Abundance") 
```

By Species Height.
```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Species.He #Only a handful of NAs, actually not too bad

cor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Species.He, cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.AbunTEST, use = "complete.obs") #0.26 - this correlation is stronger

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Species.He, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Species Height",
        x = "Species Height (cm)",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Species.He, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Species Height",
        x = "Species Height (cm)",
        y = "Berry Abundance") 
```


planted_density_TOT
# We see not much influence of planting density on berry production here
```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = planted_density_TOT, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Planting Density",
        x = "Planting Density (trees/ha)",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = planted_density_TOT, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Huckleberry Berry Abundance by Planting Density",
        x = "Planting Density (trees/ha)",
        y = "Berry Abundance") 
```


```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Cove<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Cove)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Cove #Lots of missing values
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Burned<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Burned)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Burned # We somehow have NA values. Assume not burned.
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Burned[is.na(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Burned)]<-0

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Burned, y = Fruit.AbunTEST)) +
  geom_boxplot () +
  labs (x = "Not Burned (0), Burned(1)",
        y = "Huckleberry Fruit Cover")

#No difference
```

Assess for differences in stand age by category.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2, aes (x = Burned, y = origin.age)) +
  geom_boxplot () +
  labs (x = "Not Burned (0), Burned(1)",
        y = "Stand Age")

#Stand age is greater in burned areas.
```

Determine canopy cover and stand age by breaking it into burned and not burned.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Canopy_Cov, colour = factor(Burned))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(Burned))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 


ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Canopy_Cov, y = Fruit.AbunTEST, colour = factor(Burned))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```


#Repeat for Mechanical treatment
#using Mechanical2 (some NAS); PREP_ME instead


```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Canopy_Cov, colour = factor(PREP_ME))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(PREP_ME))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 


ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Canopy_Cov, y = Fruit.AbunTEST, colour = factor(PREP_ME))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```

#Repeat for if planted or not

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Canopy_Cov, colour = factor(PLANTED))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(PLANTED))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 


ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Canopy_Cov, y = Fruit.AbunTEST, colour = factor(PLANTED))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```

Does clearcut technique matter?

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Canopy_Cov, colour = factor(DN1_SILSYS_GP))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(DN1_SILSYS_GP))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 


ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Canopy_Cov, y = Fruit.AbunTEST, colour = factor(DN1_SILSYS_GP))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```

Differences by main species planted?

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Canopy_Cov, colour = factor(Qa))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(Qa))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 


ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Canopy_Cov, y = Fruit.AbunTEST, colour = factor(Qa))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```


Start season of operations.
```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA2<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$START_SEASON!="NA")

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA2, aes (x = origin.age, y = Canopy_Cov, colour = factor(START_SEASON))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Canopy Cover by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Canopy Cover (%)") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA2, aes (x = origin.age, y = Fruit.AbunTEST, colour = factor(START_SEASON))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time Since Cutblock/Logging",
        x = "Time Since Logging",
        y = "Berry Abundance") 


ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA2, aes (x = Canopy_Cov, y = Fruit.AbunTEST, colour = factor(START_SEASON))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover",
        x = "Canopy Cover",
        y = "Berry Abundance") 
```


Cutblock Area.
AREA_SQM
```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = AREA_SQM, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Area of Cutblock",
        x = "Area of Cutblock",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = AREA_SQM, y = Fruit.AbunTEST, colour = factor(G_BGC_ZONE))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Area of Cutblock",
        x = "Area of Cutblock",
        y = "Berry Abundance") 


```

#Chemicals
Chem2
```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Chem2 #A few NAs... why?
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_chem<-subset(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Chem2!="NA")

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_chem, aes (x = Canopy_Cov, y = Fruit.AbunTEST, colour = factor(Chem2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover and Chemical Application",
        x = "Canopy Cover",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_chem, aes (x = TimeSinceCutblock, y = Fruit.AbunTEST, colour = factor(Chem2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time and Chemical Application",
        x = "Time Since Cutblock",
        y = "Berry Abundance") 
```

#Brushing
Brush2
```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_chem, aes (x = Canopy_Cov, y = Fruit.AbunTEST, colour = factor(Brush2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Canopy Cover and Brushing",
        x = "Canopy Cover",
        y = "Berry Abundance") 

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_chem, aes (x = TimeSinceCutblock, y = Fruit.AbunTEST, colour = factor(Brush2))) +
  geom_point () +
  geom_smooth (se=F) +
  labs (title = "Berry Abundance by Time and Brushing",
        x = "Time Since Cutblock",
        y = "Berry Abundance") 
```

Look at raw data relationhship shapes to each climate variable

```{r}
str(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$TSAND)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$TSAND<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$TSAND)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$TSAND

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = TSAND, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Berry Abundance in Cutblocks by % Sand",
        x = "% Sand",
        y = "Berry Abundance")
```


```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Tave_wt_0, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Average Winter Temperature Season Prior",
        x = "Average Winter Temp",
        y = "Berry Abundance")

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Tave_wt_1, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Average Winter Temperature Season Prior",
        x = "Average Winter Temp",
        y = "Berry Abundance")
#Relationship may be more hump shaped centred around -7 degrees as opposed to linear
```

Spring Temperature.
```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Tave_sp_0, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Average Spring Temperature Season Prior",
        x = "Average Spring Temp",
        y = "Berry Abundance")

```

Summer Temperature.
```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = Tave_sm_0, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Average Summer Temperature Season Prior",
        x = "Average Summer Temp",
        y = "Berry Abundance")

```


```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = PAS_total, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Precipitation as Snow",
        x = "Precipitation as snow (mm)",
        y = "Berry Abundance")
```


```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PH2
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PH2<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PH2)

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = PH2, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by pH",
        x = "Soil PH",
        y = "Berry Abundance")
#Extrapolated to those <2 pH likely false
```


```{r}
plot(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_30m_, cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_ha_bc) #Not the same... but positively correlated

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_30m_<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_30m_)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_ha_bc<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_ha_bc)

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = slope_30m_, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Slope",
        x = "Slope",
        y = "Fruit Abundance")
#Weak relationship (positive)
```

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = slope_ha_bc, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Slope",
        x = "Slope",
        y = "Fruit Abundance")
```

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_30m<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_30m)

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = aspect_30m, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Coverby Apsect",
        x = "Aspect",
        y = "Fruit Abundance")
```

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_ha_bc<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_ha_bc)

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = aspect_ha_bc, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Aspect",
        x = "Aspect",
        y = "Fruit Abundance")
```

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$cos_aspect<-cos(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_ha_bc)

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = cos_aspect, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Aspect",
        x = "cos(Aspect)",
        y = "Fruit Abundance")
```


```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$dem_ha_bc<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$dem_ha_bc)

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = dem_ha_bc, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by Elevation",
        x = "Elevation (m)",
        y = "Fruit Abundance")
```


#Because max slope ~40 degrees, can create an SAI (slope-aspect index) value: example = sin(aspect +225) x (slope/45).

```{r}
names(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)
hist(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_ha_bc)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SLOPE<-as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_ha_bc)
max(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SLOPE) 
hist(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_ha_bc)

cor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SLOPE, cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_30m_) #0.70
plot(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SLOPE ~ cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_30m_) #Quite different. Perhaps use point values and use DEM to get slope and aspect? Or use the cutblock data because it likely takes the average for the cutblock which is probably more representative.
plot(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_ha_bc ~ cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_30m)


cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SAI_cb<-(sin(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_ha_bc + 225) *(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SLOPE/58.9)) #SAI (Slope to aspect Index) of cutblock data slope and aspect
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SAI_rec<-(sin(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$aspect_30m + 225) *(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$slope_30m_/45)) #SAI of slope and aspect from Clayton's data

hist(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SAI_cb)
hist(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SAI_rec)
plot(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SAI_cb ~ cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$SAI_rec) # The result is COMPLETELY different, depending on which values are used. No correlation what so ever.

```

Compare probabilities between values.

```{r}

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = SAI_cb, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by SAI",
        x = "SAI_cb",
        y = "Species Cover")
```

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = SAI_rec, y = Fruit.AbunTEST)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover by SAI",
        x = "SAI_rec",
        y = "Species Cover")
```



#####################  Begin Exploratory Analyses ###########################

#Explore these Harvesting Variables:
DN1_SILSYS_GP #Maybe
PREP_ME
Burned
Brush2
Chem2
G_BGC_ZONE
OPEN_GRSAR OR AREA_SQM (on in ha and one km square)
PLANTED
Origin.age/TimeSinceC
START_SEASON

#Potential Seasonal variables And:
heatload

PAS_total
Tave_wt_1
Tave_sp_0
Tave_sm_0
DD5_0


```{r}

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PLANTED<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PLANTED)

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PREP_ME<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PREP_ME)

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Burned<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Burned)

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Manual2<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Manual2)

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Chem2<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Chem2)

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Brush2<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Brush2)


```

#Model Series 1:
DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + START_SEASON*TimeSinceCutblock + Chem2*TimeSinceCutblock + Species.He

#Model Series 2:
DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + Canopy_Cov + START_SEASON + heatload + PREP_ME*Canopy_Cov + START_SEASON*Canopy_Cov + Chem2*Canopy_cov + Species.He

#Could investigate as linear models; but GAMs might be better

```{r}
#Model using Time Since Cutblock
model.new.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + START_SEASON*TimeSinceCutblock + Chem2*TimeSinceCutblock + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #3155.946
summary(model.new.1)$r.squared #0.19
summary(model.new.1)$adj.r.squared #0.11

#Remove least significant
model.new.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + START_SEASON*TimeSinceCutblock + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #3153.96
summary(model.new.1)$r.squared #0.19
summary(model.new.1)$adj.r.squared #0.11

#Remove least significant
model.new.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #3150.0
summary(model.new.1)$r.squared #0.18
summary(model.new.1)$adj.r.squared #0.12

#Remove least significant
model.new.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock + heatload + PREP_ME*TimeSinceCutblock + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #3167.4 --> WORSE!
summary(model.new.1)$r.squared #0.18
summary(model.new.1)$adj.r.squared #0.13

#Remove least significant
model.new.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #3148.2
summary(model.new.1)$r.squared #0.18
summary(model.new.1)$adj.r.squared #0.12

#Remove least significant
model.new.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Chem2 + G_BGC_ZONE + PLANTED + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #3146.4
summary(model.new.1)$r.squared #0.18
summary(model.new.1)$adj.r.squared #0.12

#Remove least significant
model.new.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned  + G_BGC_ZONE + PLANTED + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #3177.65 --> WORSE!
summary(model.new.1)$r.squared #0.18
summary(model.new.1)$adj.r.squared #0.12

#Remove least significant
model.new.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Chem2 + G_BGC_ZONE + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.1, type=3) #
summary(model.new.1) #
AIC(model.new.1) #3145.3
summary(model.new.1)$r.squared #0.18
summary(model.new.1)$adj.r.squared #0.12
#Overall, not performinf great.
```


```{r}
#Best model
model.new.1 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Chem2 + G_BGC_ZONE + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + Species.He, data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

#Check model fit
# model diagnostic plots
binnedplot (fitted(model.new.1), 
            residuals(model.new.1), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

#Explore partial residuals with current model
# DN1_SILSYS_GP + PREP_ME + Burned + Chem2 + G_BGC_ZONE + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + Species.He
library(visreg)

visreg(model.new.1, "DN1_SILSYS_GP")
visreg(model.new.1, "Burned")
visreg(model.new.1, "Chem2")
visreg(model.new.1, "PREP_ME", by="TimeSinceCutblock")
visreg(model.new.1, "TimeSinceCutblock", by="PREP_ME")

visreg(model.new.1, "G_BGC_ZONE")

visreg(model.new.1, "heatload")
visreg(model.new.1, "START_SEASON")

visreg(model.new.1, "Species.He")


```

Model 2: Canopy Cover
```{r}
model.new.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + Canopy_Cov + START_SEASON + heatload + PREP_ME*Canopy_Cov + START_SEASON*Canopy_Cov + Chem2*Canopy_Cov + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3160.532
summary(model.new.2)$r.squared #0.17
summary(model.new.2)$adj.r.squared #0.09

#Remove Least SignificaNT
model.new.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + Canopy_Cov + START_SEASON + heatload + PREP_ME*Canopy_Cov + START_SEASON*Canopy_Cov + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3158.5
summary(model.new.2)$r.squared #0.17
summary(model.new.2)$adj.r.squared #0.10

#Remove Least SignificaNT
model.new.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + Canopy_Cov + START_SEASON + heatload + PREP_ME*Canopy_Cov  + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3153.7
summary(model.new.2)$r.squared #0.17
summary(model.new.2)$adj.r.squared #0.10

#Remove Least SignificaNT
model.new.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE  + PLANTED + Canopy_Cov + START_SEASON + heatload + PREP_ME*Canopy_Cov  + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3151.8
summary(model.new.2)$r.squared #0.17
summary(model.new.2)$adj.r.squared #0.11

#Remove Least SignificaNT
model.new.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE  + Canopy_Cov + START_SEASON + heatload + PREP_ME*Canopy_Cov  + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3149.8
summary(model.new.2)$r.squared #0.17
summary(model.new.2)$adj.r.squared #0.11

#Remove Least SignificaNT
model.new.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE  + Canopy_Cov + heatload + PREP_ME*Canopy_Cov  + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3168.21 --> worse!
summary(model.new.2)$r.squared #0.17
summary(model.new.2)$adj.r.squared #0.11

#Remove Least SignificaNT
model.new.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE  + Canopy_Cov + START_SEASON + heatload   + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3148.2
summary(model.new.2)$r.squared #0.17
summary(model.new.2)$adj.r.squared #0.11

#Remove Least Significant
model.new.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + G_BGC_ZONE  + Canopy_Cov + START_SEASON + heatload   + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3146.3
summary(model.new.2)$r.squared #0.17
summary(model.new.2)$adj.r.squared #0.12

#Remove Least Significant
model.new.2 <- lm (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + G_BGC_ZONE  + Canopy_Cov + START_SEASON + heatload   + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3177.2 --> WORSE!
summary(model.new.2)$r.squared #0.17
summary(model.new.2)$adj.r.squared #0.12

#Remove Least Significant
model.new.2 <- lm (Fruit.AbunTEST ~ + PREP_ME + Burned + Brush2 + G_BGC_ZONE  + Canopy_Cov + START_SEASON + heatload   + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.2, type=3) #
summary(model.new.2) #
AIC(model.new.2) # 3143.8
summary(model.new.2)$r.squared #0.15
summary(model.new.2)$adj.r.squared #0.11


```


```{r}
#Best model
model.new.2 <- lm (Fruit.AbunTEST ~ + PREP_ME + Burned + Brush2 + G_BGC_ZONE  + Canopy_Cov + START_SEASON + heatload + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

#Check model fit
# model diagnostic plots
binnedplot (fitted(model.new.1), 
            residuals(model.new.1), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm", i))

#Explore partial residuals with current model
# PREP_ME + Burned + Brush2 + G_BGC_ZONE  + Canopy_Cov + START_SEASON + heatload + Species.He
library(visreg)

visreg(model.new.2, "PREP_ME")
visreg(model.new.2, "Burned")
visreg(model.new.2, "Brush2")

visreg(model.new.2, "G_BGC_ZONE")
visreg(model.new.2, "Canopy_Cov")

visreg(model.new.2, "heatload")
visreg(model.new.2, "START_SEASON")

visreg(model.new.2, "Species.He")
```


Ensure data saved.

```{r}
write.csv(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, file="c:\\cora\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_March16.csv")
```


### Try above as GAMs
#Model Series 1:
DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock + START_SEASON + heatload + PREP_ME*TimeSinceCutblock + START_SEASON*TimeSinceCutblock + Chem2*TimeSinceCutblock + Species.He

#Model Series 2:
DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + Canopy_Cov + START_SEASON + heatload + PREP_ME*Canopy_Cov + START_SEASON*Canopy_Cov + Chem2*Canopy_cov + Species.He

```{r}
library(mgcv)

model.new.1b <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + s(OPEN_GRSAR) + PLANTED + s(TimeSinceCutblock, by=PREP_ME) + s(TimeSinceCutblock, by=Chem2) + START_SEASON + s(heatload) + s(Species.He),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b)
anova(model.new.1b)
summary(model.new.1b) #Adjusted R-square = 0.203, Deviance explained 28.5%
AIC(model.new.1b) #3133.89

library(mgcViz)
getViz(model.new.1b)
plot(model.new.1b)
plot(model.new.1b, select=1)
plot(model.new.1b, select=2)
plot(model.new.1b, select=3)
plot(model.new.1b, select=4)
plot(model.new.1b, select=5) #Flat line at 0?? Check what is wrong.
plot(model.new.1b, select=6)
plot(model.new.1b, select=7)


library(visreg)
visreg(model.new.1b, "DN1_SILSYS_GP")
visreg(model.new.1b, "Chem2")
visreg(model.new.1b, "PREP_ME")
visreg(model.new.1b, "Burned")
visreg(model.new.1b, "Brush2")
visreg(model.new.1b, "G_BGC_ZONE")
visreg(model.new.1b, "PLANTED")
visreg(model.new.1b, "START_SEASON")

#Can take the smooth out for many terms
model.new.1b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock*PREP_ME + s(TimeSinceCutblock, by=Chem2) + START_SEASON + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b2)
anova(model.new.1b2)
summary(model.new.1b2) #Adjusted R-square = 0.203, Deviance explained 28.5%
AIC(model.new.1b2) #3133.9

#Can remove non-significant variables
model.new.1b3 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + TimeSinceCutblock*PREP_ME + s(TimeSinceCutblock, by=Chem2) + START_SEASON + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b3)
anova(model.new.1b3)
summary(model.new.1b3) #Adjusted R-Square = 0.209; Deviance explained 28.2%
AIC(model.new.1b3) #3129.1

#Can remove non-significant variables
model.new.1b3 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + TimeSinceCutblock*PREP_ME + s(TimeSinceCutblock, by=Chem2) + START_SEASON + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b3)
anova(model.new.1b3)
summary(model.new.1b3) #Adjusted R-Square = 0.21; Deviance explained 28%
AIC(model.new.1b3) #3127.1

#Can remove non-significant variables
model.new.1b3 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + TimeSinceCutblock*PREP_ME + s(TimeSinceCutblock, by=Chem2) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b3)
anova(model.new.1b3)
summary(model.new.1b3) #Adjusted R-Square = 0.212; Deviance explained 27.2%
AIC(model.new.1b3) #3147.4- WORSE

#Can remove non-significant variables
model.new.1b3 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + TimeSinceCutblock*PREP_ME + s(TimeSinceCutblock, by=Chem2) + START_SEASON + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b3)
anova(model.new.1b3)
summary(model.new.1b3) #Adjusted R-Square = 0.21; Deviance explained 27.6%
AIC(model.new.1b3) #3127.2

#Try to add some other interactions
model.new.1b3 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + TimeSinceCutblock*PREP_ME + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Brush2) + c(TimeSinceCutblock) + s(TimeSinceCutblock, by=START_SEASON) +START_SEASON + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b3)
anova(model.new.1b3)
summary(model.new.1b3) #Adjusted R-Square = 0.207; Deviance explained 28.8%
AIC(model.new.1b3) #3133.6

plot(model.new.1b3)
plot(model.new.1b3, select=1)
plot(model.new.1b3, select=2)
plot(model.new.1b3, select=3)

visreg(model.new.1b3, "Chem2")
visreg(model.new.1b3, "PREP_ME")
visreg(model.new.1b3, "Burned")
visreg(model.new.1b3, "Brush2")
visreg(model.new.1b3, "G_BGC_ZONE")
visreg(model.new.1b3, "START_SEASON")
visreg(model.new.1b3, "TimeSinceCutblock", by="PREP_ME")
visreg(model.new.1b3, "TimeSinceCutblock", by="Chem2")
visreg(model.new.1b3, "PREP_ME", by= "TimeSinceCutblock")

#Try to add some other interactions
model.new.1b3 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + c(TimeSinceCutblock)*PREP_ME + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Brush2) + c(TimeSinceCutblock) +START_SEASON*c(TimeSinceCutblock) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b3)
anova(model.new.1b3)
summary(model.new.1b3) #Adjusted R-Square = 0.206; Deviance explained 28.7%
AIC(model.new.1b3) #3132.9

plot(model.new.1b3)


#Try to add some other interactions
model.new.1b3 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + c(TimeSinceCutblock)*PREP_ME + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Brush2) + c(TimeSinceCutblock) +START_SEASON + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b3)
anova(model.new.1b3)
summary(model.new.1b3) #Adjusted R-Square = 0.217; Deviance explained 28.8%
AIC(model.new.1b3) #3127.1

plot(model.new.1b3)

#
model.new.1b3 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + c(TimeSinceCutblock)*PREP_ME + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Brush2) + s(TimeSinceCutblock, by=Burned) + c(TimeSinceCutblock) +START_SEASON + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b3)
anova(model.new.1b3)
summary(model.new.1b3) #Adjusted R-Square = 0.217; Deviance explained 28.8%
AIC(model.new.1b3) #3128.97

plot(model.new.1b3)

#Try to add some other interactions
model.new.1b3 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + c(TimeSinceCutblock)*PREP_ME + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Brush2) + c(TimeSinceCutblock) +START_SEASON + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.1b3)
anova(model.new.1b3)
summary(model.new.1b3) #Adjusted R-Square = 0.217; Deviance explained 28.8%
AIC(model.new.1b3) #3127.1

plot(model.new.1b3)
plot(model.new.1b3, select=1)
plot(model.new.1b3, select=2)
plot(model.new.1b3, select=3)

#PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + c(TimeSinceCutblock)*PREP_ME + s(TimeSinceCutblock, by=Chem2) + s(TimeSinceCutblock, by=Brush2) + c(TimeSinceCutblock) +START_SEASON + s(heatload) + Species.He
visreg(model.new.1b3, "Burned")
visreg(model.new.1b3, "G_BGC_ZONE")
visreg(model.new.1b3, "START_SEASON")
visreg(model.new.1b3, "heatload")
visreg(model.new.1b3, "Species.He")
visreg(model.new.1b3, "TimeSinceCutblock")
visreg(model.new.1b3, "TimeSinceCutblock", by="PREP_ME")
visreg(model.new.1b3, "TimeSinceCutblock", by="Chem2")
visreg(model.new.1b3, "TimeSinceCutblock", by="Brush2")
visreg(model.new.1b3, "Brush2", by= "TimeSinceCutblock")
visreg(model.new.1b3, "PREP_ME", by= "TimeSinceCutblock")
visreg(model.new.1b3, "Chem2", by= "TimeSinceCutblock")
```

Repeat for Canopy Cover.

```{r}
model.new.2b <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + s(OPEN_GRSAR) + s(Canopy_Cov, by=PLANTED) + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=Chem2) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + s(Species.He) + s(Canopy_Cov, by=Brush2),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b)
anova(model.new.2b)
summary(model.new.2b) #Adjusted R-square = 0.225, Deviance explained 31.6%
AIC(model.new.2b) #3133.89

library(mgcViz)
getViz(model.new.2b)
plot(model.new.2b)
plot(model.new.2b, select=1)
plot(model.new.2b, select=2)
plot(model.new.2b, select=3)
plot(model.new.2b, select=4)
plot(model.new.2b, select=5) #Flat line at 0?? Check what is wrong.
plot(model.new.2b, select=6)
plot(model.new.2b, select=7)


library(visreg)
visreg(model.new.2b, "DN1_SILSYS_GP")
visreg(model.new.2b, "Chem2")
visreg(model.new.2b, "PREP_ME")
visreg(model.new.2b, "Burned")
visreg(model.new.2b, "Brush2")
visreg(model.new.2b, "G_BGC_ZONE")
visreg(model.new.2b, "PLANTED")
visreg(model.new.2b, "START_SEASON")

#Remove ones that do not need to be smoothed
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2*Canopy_Cov + Chem2*Canopy_Cov + G_BGC_ZONE + OPEN_GRSAR + Canopy_Cov*PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.226, Deviance explained 32%
AIC(model.new.2b2) #3131.0

plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + c(Canopy_Cov)*Brush2 + c(Canopy_Cov)*Chem2 + G_BGC_ZONE + OPEN_GRSAR + c(Canopy_Cov)*PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.226, Deviance explained 32%
AIC(model.new.2b2) #3131.0
plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + c(Canopy_Cov)*Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + c(Canopy_Cov)*PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.23, Deviance explained 32%
AIC(model.new.2b2) #3129.2
plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + c(Canopy_Cov)*PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.23, Deviance explained 31.7%
AIC(model.new.2b2) #3128.2
plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.229, Deviance explained 31.4%
AIC(model.new.2b2) #3127.6
plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.232, Deviance explained 31.4%
AIC(model.new.2b2) #3125.8
plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + G_BGC_ZONE + OPEN_GRSAR+ s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.234, Deviance explained 31.2%
AIC(model.new.2b2) #3124.0
plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.235, Deviance explained 31%
AIC(model.new.2b2) #3123.1
plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.233, Deviance explained 30.4%
AIC(model.new.2b2) #3155.1--> WORSE
plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.235, Deviance explained 31%
AIC(model.new.2b2) #3123.1
plot(model.new.2b2)

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.229, Deviance explained 29.5%
AIC(model.new.2b2) #3122.2
plot(model.new.2b2)
plot(model.new.2b2, select=1)
plot(model.new.2b2, select=2)
plot(model.new.2b2, select=3)
plot(model.new.2b2, select=4)
plot(model.new.2b2, select=5)
plot(model.new.2b2, select=6)
plot(model.new.2b2, select=7)

#PREP_ME + Burned + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He
visreg(model.new.2b2, "PREP_ME")
visreg(model.new.2b2, "Burned")
visreg(model.new.2b2, "Brush2")
visreg(model.new.2b2, "G_BGC_ZONE")
visreg(model.new.2b2, "heatload")
visreg(model.new.2b2, "Species.He")
visreg(model.new.2b2, "START_SEASON", by="Canopy_Cov")
visreg(model.new.2b2, "PREP_ME", by="Canopy_Cov")
visreg(model.new.2b2, "Canopy_Cov", by= "START_SEASON")
visreg(model.new.2b2, "Canopy_Cov", by= "PREP_ME")

#Remove least significant
model.new.2b2 <- gam (Fruit.AbunTEST ~  Burned + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.217, Deviance explained 27.4%
AIC(model.new.2b2) #3122.1
plot(model.new.2b2)
plot(model.new.2b2, select=1)
plot(model.new.2b2, select=2)
plot(model.new.2b2, select=3)
plot(model.new.2b2, select=4)
plot(model.new.2b2, select=5)
plot(model.new.2b2, select=6)
plot(model.new.2b2, select=7)

#PREP_ME + Burned + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He
visreg(model.new.2b2, "Burned")
visreg(model.new.2b2, "Brush2")
visreg(model.new.2b2, "G_BGC_ZONE")
visreg(model.new.2b2, "heatload")
visreg(model.new.2b2, "Species.He")
visreg(model.new.2b2, "Canopy_Cov")
visreg(model.new.2b2, "START_SEASON", by="Canopy_Cov")
visreg(model.new.2b2, "Canopy_Cov", by= "START_SEASON")

#Go back to this one
model.new.2b2 <- gam (Fruit.AbunTEST ~ PREP_ME + Burned + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b2)
anova(model.new.2b2)
summary(model.new.2b2) #Adjusted R-square = 0.229, Deviance explained 29.5%
AIC(model.new.2b2) #3122.2
plot(model.new.2b2)
plot(model.new.2b2, select=1)
plot(model.new.2b2, select=2)
plot(model.new.2b2, select=3)
plot(model.new.2b2, select=4)
plot(model.new.2b2, select=5)
plot(model.new.2b2, select=6)
plot(model.new.2b2, select=7)

#PREP_ME + Burned + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON) + s(heatload) + Species.He
visreg(model.new.2b2, "PREP_ME")
visreg(model.new.2b2, "Burned")
visreg(model.new.2b2, "Brush2")
visreg(model.new.2b2, "G_BGC_ZONE")
visreg(model.new.2b2, "heatload")
visreg(model.new.2b2, "Species.He")
visreg(model.new.2b2, "START_SEASON", by="Canopy_Cov")
visreg(model.new.2b2, "PREP_ME", by="Canopy_Cov")
visreg(model.new.2b2, "Canopy_Cov", by= "START_SEASON")
visreg(model.new.2b2, "Canopy_Cov", by= "PREP_ME")

```


Compare to if remove covariates.
```{r}
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + s(OPEN_GRSAR) + s(Canopy_Cov, by=PLANTED) + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=Chem2) + s(Canopy_Cov, by=START_SEASON) + s(Canopy_Cov, by=Brush2),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.09, Deviance explained 15.5%
AIC(model.new.2b_2) #3736.9

getViz(model.new.2b_2)
plot(model.new.2b_2)
plot(model.new.2b_2, select=1)
plot(model.new.2b_2, select=2)
plot(model.new.2b_2, select=3)
plot(model.new.2b_2, select=4)
plot(model.new.2b_2, select=5) .
plot(model.new.2b_2, select=6)
plot(model.new.2b_2, select=7)


library(visreg)
visreg(model.new.2b_2, "DN1_SILSYS_GP")
visreg(model.new.2b_2, "Chem2")
visreg(model.new.2b_2, "PREP_ME")
visreg(model.new.2b_2, "Burned")
visreg(model.new.2b_2, "Brush2")
visreg(model.new.2b_2, "G_BGC_ZONE")
visreg(model.new.2b_2, "PLANTED")
visreg(model.new.2b_2, "START_SEASON")

#Remove ones that do not need to be smoothed
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + s(Canopy_Cov, by=PREP_ME) + c(Canopy_Cov)*Chem2 + s(Canopy_Cov, by=START_SEASON) + c(Canopy_Cov)*Brush2,
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.09, Deviance explained 15.8%
AIC(model.new.2b_2) #3736.2

getViz(model.new.2b_2)
plot(model.new.2b_2)

#Remove least significant
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + s(Canopy_Cov, by=PREP_ME) + c(Canopy_Cov)*Chem2 + s(Canopy_Cov, by=START_SEASON),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.09, Deviance explained 15.8%
AIC(model.new.2b_2) #3734.3

getViz(model.new.2b_2)
plot(model.new.2b_2)

#Remove least significant
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + OPEN_GRSAR + PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.09, Deviance explained 15.7%
AIC(model.new.2b_2) #3734.3

getViz(model.new.2b_2)
plot(model.new.2b_2)

#Remove least significant
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + Chem2 + G_BGC_ZONE + PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.097, Deviance explained 15.7%
AIC(model.new.2b_2) #3730.9

getViz(model.new.2b_2)
plot(model.new.2b_2)

#Remove least significant
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Burned + Brush2 + G_BGC_ZONE + PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.10, Deviance explained 15.6%
AIC(model.new.2b_2) #3729.1

getViz(model.new.2b_2)
plot(model.new.2b_2)

#Remove least significant
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Brush2 + G_BGC_ZONE + PLANTED + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.10, Deviance explained 15.5%
AIC(model.new.2b_2) #3727.99

getViz(model.new.2b_2)
plot(model.new.2b_2)

#Remove least significant
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.10, Deviance explained 15.1%
AIC(model.new.2b_2) #3726.7

getViz(model.new.2b_2)
plot(model.new.2b_2)

#Remove least significant
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME  + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.10, Deviance explained 15%
AIC(model.new.2b_2) #3757.9 --> WORSE

getViz(model.new.2b_2)
plot(model.new.2b_2)


#Remove least significant
model.new.2b_2 <- gam (Fruit.AbunTEST ~ DN1_SILSYS_GP + PREP_ME + Brush2 + G_BGC_ZONE + s(Canopy_Cov, by=PREP_ME) + s(Canopy_Cov, by=START_SEASON),
data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, method="REML")

gam.check(model.new.2b_2)
anova(model.new.2b_2)
summary(model.new.2b_2) #Adjusted R-square = 0.10, Deviance explained 15.1%
AIC(model.new.2b_2) #3726.7

getViz(model.new.2b_2)
plot(model.new.2b_2)
plot(model.new.2b_2, select=1)
plot(model.new.2b_2, select=2)
plot(model.new.2b_2, select=3)
plot(model.new.2b_2, select=4)
plot(model.new.2b_2, select=5) .
plot(model.new.2b_2, select=6)

library(visreg)
visreg(model.new.2b_2, "DN1_SILSYS_GP")
visreg(model.new.2b_2, "PREP_ME", by="Canopy_Cov")
visreg(model.new.2b_2, "Brush2")
visreg(model.new.2b_2, "G_BGC_ZONE")
visreg(model.new.2b_2, "START_SEASON", by="Canopy_Cov")
visreg(model.new.2b_2, "Canopy_Cov", by="PREP_ME")
visreg(model.new.2b_2, "Canopy_Cov", by="START_SEASON")

#Remove ones that do not need to be smoothed
```




########### BELOW IS OLD CODE THAT MAY BE USEFUL ##############








Determine AUC by splitting into training and validation set (85% and 15% given small sample size).

```{r}
summary(model.new.1)

#Create a new blank table and get AUC too
top_mod_table_PA_Plant <- data.frame (matrix (ncol = 22, nrow = 0))
colnames (top_mod_table_PA_Plant ) <- c ("Model", "Model_terms", "intercept", "coef_DN1_DIS_CDL", "coef_PREP_MA1", "coef_PREP_ME1", "coef_PREP_BU1", "coef_BRUSH_MA1", "coef_G_BGC_ZONEICH", "coef_G_BGC_ZONEMS", "coef_G_BGC_ZONESBS", "coef_origin1", "coef_origin2", "coef_PAS_total", "coef_PPT_sm_dec", "coef_PH2","coef_CMI_sm_dec", "coef_CMI_at_dec", "coef_SAI_cb", "coef_DD5_dec", "coef_LandsatCC_", "AUC")
```

Let's run it 500 times to get good mean values.

```{r}

for (g in 1:500){

prop<-0.85
# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Species.Pr2, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA[ trainIndex,]
   Valid <- cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA[-trainIndex,]
   
#Model   
model.new.1<-glm(Species.Pr2 ~ DN1_DIS_CD + PREP_MA + PREP_ME + PREP_BU + BRUSH_MA + G_BGC_ZONE + origin + PAS_total+ PPT_sm_dec + PH2 + CMI_sm_dec + CMI_at_dec + SAI_cb + DD5_dec + LandsatCC_, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.new.1, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"Species.Pr2"], mod.valid)
   mod.auc <- auc(roc_obj)

# create model table (only do this once) and add the relevant data
top_mod_table_PlantPA <- data.frame (matrix (ncol = 22, nrow = 0))
colnames (top_mod_table_PlantPA ) <- c ("Model", "Model_terms", "intercept", "coef_DN1_DIS_CDL", "coef_PREP_MA1", "coef_PREP_ME1", "coef_PREP_BU1", "coef_BRUSH_MA1", "coef_G_BGC_ZONEICH", "coef_G_BGC_ZONEMS", "coef_G_BGC_ZONESBS", "coef_origin1", "coef_origin2", "coef_PAS_total", "coef_PPT_sm_dec", "coef_PH2","coef_CMI_sm_dec", "coef_CMI_at_dec", "coef_SAI_cb", "coef_DD5_dec", "coef_LandsatCC_", "AUC")

##Add data for NDT1
top_mod_table_PlantPA[1,1]<-"Plant PA"
top_mod_table_PlantPA[1,2]<-"Species.Pr2 ~ DN1_DIS_CD + PREP_MA + PREP_ME + PREP_BU + BRUSH_MA + G_BGC_ZONE + origin + PAS_total+ PPT_sm_dec + PH2 + CMI_sm_dec + CMI_at_dec + SAI_cb + DD5_dec + LandsatCC_"
top_mod_table_PlantPA[1,3]<- coef(model.new.1)[1] #Intercept
top_mod_table_PlantPA[1,4]<- coef(model.new.1)[2] #Intercept
top_mod_table_PlantPA[1,5]<- coef(model.new.1)[3] #Intercept
top_mod_table_PlantPA[1,6]<- coef(model.new.1)[4] #
top_mod_table_PlantPA[1,7]<- coef(model.new.1)[5] #
top_mod_table_PlantPA[1,8]<- coef(model.new.1)[6] #coefficient 
top_mod_table_PlantPA[1,9]<- coef(model.new.1)[7] #coefficient 
top_mod_table_PlantPA[1,10]<- coef(model.new.1)[8] #coefficient
top_mod_table_PlantPA[1,11]<- coef(model.new.1)[9] #
top_mod_table_PlantPA[1,12]<- coef(model.new.1)[10] #coefficient 
top_mod_table_PlantPA[1,13]<- coef(model.new.1)[11] #coefficient 
top_mod_table_PlantPA[1,14]<- coef(model.new.1)[12] #coefficient
top_mod_table_PlantPA[1,15]<- coef(model.new.1)[13] #coefficient
top_mod_table_PlantPA[1,16]<- coef(model.new.1)[14] #coefficient
top_mod_table_PlantPA[1,17]<- coef(model.new.1)[15] #coefficien
top_mod_table_PlantPA[1,18]<- coef(model.new.1)[16] #coefficient 
top_mod_table_PlantPA[1,19]<- coef(model.new.1)[17] #
top_mod_table_PlantPA[1,20]<- coef(model.new.1)[18] #  
top_mod_table_PlantPA[1,21]<- coef(model.new.1)[19] # 
top_mod_table_PlantPA[1,22]<- mod.auc

top_mod_table_PA_Plant<-rbind(top_mod_table_PA_Plant, top_mod_table_PlantPA)

}

```

Check.
```{r}
head(top_mod_table_PA_Plant)

```

#Save coefficient table

```{r}
write.csv(top_mod_table_PA_Plant, file="D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Top_Mod_PlantPA.csv")
```

Get mean values.

```{r}
top_mod_table_PA_Plant_mean<-top_mod_table_PA_Plant %>% summarise_each(funs( mean( .,na.rm = TRUE)))
top_mod_table_PA_Plant_mean

top_mod_table_PA_Plant_mean[1,1]<-"Plant PA"
top_mod_table_PA_Plant_mean[1,2]<-"Species.Pr2 ~ DN1_DIS_CD + PREP_MA + PREP_ME + PREP_BU + BRUSH_MA + G_BGC_ZONE + origin + PAS_total+ PPT_sm_dec + PH2 + CMI_sm_dec + CMI_at_dec + SAI_cb + DD5_dec + LandsatCC_"
top_mod_table_PA_Plant_mean
```
Save mean coefficient table.

```{r}
write.csv(top_mod_table_PA_Plant_mean, file="D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Top_Mod_PlantPA_mean.csv")
```

Get SD.

```{r}
top_mod_table_PA_Plant_SD<-top_mod_table_PA_Plant %>% summarise_each(funs( sd( .,na.rm = TRUE)))
top_mod_table_PA_Plant_SD

top_mod_table_PA_Plant_SD[1,1]<-"Plant PA"
top_mod_table_PA_Plant_SD[1,2]<-"Species.Pr2 ~ DN1_DIS_CD + PREP_MA + PREP_ME + PREP_BU + BRUSH_MA + G_BGC_ZONE + origin + PAS_total+ PPT_sm_dec + PH2 + CMI_sm_dec + CMI_at_dec + SAI_cb + DD5_dec + LandsatCC_"
top_mod_table_PA_Plant_SD
```

Save sd coefficient table.

```{r}
write.csv(top_mod_table_PA_Plant_SD, file="D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Top_Mod_PlantPA_SD.csv")
```










#Additional Code for timing of harvest
```{r}
#Determine timing of harvest
names(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)
head(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_STR_DT)
table(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_STR_DT)

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_year<-stri_sub(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_STR_DT,3,4)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_year
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_month<-stri_sub(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_STR_DT,5,6)
head(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_month)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_End_year<-stri_sub(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_END_DT,3,4)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_End_year
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_End_month<-stri_sub(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_END_DT,5,6)

#Make all numeric
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_year.num<-as.numeric((cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_year))
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_End_year.num<- as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_End_year)

cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_month.num<-as.numeric((cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_month))
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_End_month.num<- as.numeric(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_End_month)

#Determine length in years
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_year_length<- cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_End_year.num - cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_year.num
table(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_year_length) #Can see that treatment took a long time in some.

#Only look at start month, assuming this is when harvesting and scarification ocurred.
table(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_month)
str(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_month)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_month<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DST_Start_month)

#Turn into seasonal months
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DIST_SEASON<-0
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA<-cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA %>%
    mutate(DIST_SEASON = case_when(DST_Start_month == "01" ~ "Winter",
                                  DST_Start_month == "02" ~ "Winter",
                                  DST_Start_month == "03" ~ "Spring",
                                  DST_Start_month == "04" ~ "Spring",
                                  DST_Start_month == "05" ~ "Spring",
                                  DST_Start_month == "06" ~ "Summer",
                                  DST_Start_month == "07" ~ "Summer",
                                  DST_Start_month == "08" ~ "Summer",
                                  DST_Start_month == "09" ~ "Fall",
                                  DST_Start_month == "10" ~ "Fall",
                                  DST_Start_month == "11" ~ "Fall",
                                  DST_Start_month == "12" ~ "Winter",
                                  TRUE ~ "NA"))
table(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$DIST_SEASON) # Determine if want different cutoffs for snow months.

```












## BELOW NEEDS TO BE RELOCATED AND THEN REMOVED######

############Repeat above for Fruit Presence
We will explore the same variables as we did for plant abundance.

```{r}
variables.huck<-c("slope_30m_SRTM", "aspect_30m_SRTM", "LandsatCC_",  "PAS_total", "PH2", "ELEVATION", "Tave_wt", "TSAND", "MODIS_LC", "Fire_Occ", "PLANTED", "PREP_BU_", "PREP_ME_", "DIST_SEASON", "origin.age")


#
mods.me.tmp <- powerSet(variables.huck)
#mods.me.tmp

mod.to.test.all<-c(1,mods.me.tmp)
mod.to.test.all<-mod.to.test.all[-2]

#Ensure as factor
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_ng$Fruit.Pres2<-as.factor(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_ng$Fruit.Pres)
str(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_ng$Fruit.Pres)
str(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_ng$Fruit.Pres2)

#Subset the data once into training and validation set
model.data2<- cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA_ng %>% dplyr::select(Fruit.Pres2, variables.huck)
trainIndex_huck <- createDataPartition(model.data2$Fruit.Pres2, p = prop,
                                    list = FALSE,
                                    times = 1)
  
dat.1 <- model.data2[ trainIndex_huck,]
Valid.1 <- model.data2[-trainIndex_huck,]

#Create function specific for fruit
#Create model function
big.mod2 <- function(mods.in, df.train, df.test, dep.var="Fruit.Pres2") {
   rhs <- paste(mods.in, collapse=" + ")
   form <- as.formula(paste(noquote(dep.var), " ~", rhs))
   mods.fit <- glm(form, family=binomial, data=df.train)
   mod.stuff <- summary(mods.fit)
   mod.aic <- extractAIC(mods.fit)
   mod.valid <- predict.glm(mods.fit, newdata=df.test, type="response")
   roc_obj <- roc(df.test[,dep.var], mod.valid)
   mod.auc <- auc(roc_obj)
   return(list(rhs, mod.stuff, mod.aic, mod.auc))
   
}

#Run with big.mod2
mods.fit3 <- lapply(mod.to.test.all, big.mod2, df.train=dat.1, df.test=Valid.1)
#mods.fit3


#terms in each model
x1 <- unlist(sapply(mods.fit3, '[', 1))
x1
#Aic for models
x3 <- matrix(unlist(sapply(mods.fit3, '[', 3)), ncol=2, byrow=TRUE)
#x3
#auc from validation data
x4 <- unlist(sapply(mods.fit3, '[', 4))
#x4
#combining all as df
tab.sum.huckleberry3 <- cbind.data.frame(model=x1, edf=x3[,1], aic=x3[,2], auc.valid=x4)
tab.sum.huckleberry3$delta.aic<- tab.sum.huckleberry3$aic - (min(tab.sum.huckleberry3$aic))
tab.sum.huckleberry3 
```
Save as csv
```{r}
write.csv(tab.sum.huckleberry3, file="D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\model.2.series.AIC.AUC_FruitPresent_Huck.csv")

```

These variables commonly in top models, so start here:
slope_30m_SRTM + LandsatCC_ + PAS_total + PH2 + ELEVATION + MODIS_LC

Now, others included in some that are interesting to us now: 
1. ELEVATION
2. MODIS_LC
3. origin.age
4. Fire_Occ

One model each deltaAIC<2 had PREP_ME_ and PREP_BU_, but not frequent like above factors; one also had aspect, but not others. One model had TSAND, one had winter Temp. One model also had PLANTED.

For berry abundance models, plant abundance should be included as a fixed effect (McLelland et al. 2021). Need to be added below.
**When looking at berry production, include physical plant characteristics as covariates.

## ADD COVARIATES OF PLANT HEIGHT AND ABUNDANCE!

```{r}
model.fruitPA.1 <- glm (Fruit.Pres2 ~ slope_30m_SRTM + LandsatCC_ + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1, type=3)
summary(model.fruitPA.1)
#Less likely to have fruit where fire occurred
# Positive corellation with origin age
# Positive interaction with pH
# positive interaction with precip as snow
# negative interaction with canopy cover
# positive interaction with slope
AIC(model.fruitPA.1) #565.5

model.fruitPA.1b <- glm (Fruit.Pres2 ~ slope_30m_SRTM + LandsatCC_ + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + G_BGC_ZONE,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1b, type=3)
summary(model.fruitPA.1b)
AIC(model.fruitPA.1b) #568.08-- less good with BEC added!

model.fruitPA.1c <- glm (Fruit.Pres2 ~ slope_30m_SRTM + LandsatCC_ + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + PLANTED,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.1

model.fruitPA.1c <- glm (Fruit.Pres2 ~ slope_30m_SRTM + LandsatCC_ + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + PREP_BU_,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.5


model.fruitPA.1c <- glm (Fruit.Pres2 ~ slope_30m_SRTM + LandsatCC_ + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + PREP_ME_,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.4

model.fruitPA.1c <- glm (Fruit.Pres2 ~ slope_30m_SRTM + LandsatCC_ + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + TSAND,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.3

model.fruitPA.1c <- glm (Fruit.Pres2 ~ slope_30m_SRTM + LandsatCC_ + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ + Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1c, type=3)
summary(model.fruitPA.1c)
AIC(model.fruitPA.1c) #567.5

```
Current best model:

```{r}
model.fruitPA.1 <- glm (Fruit.Pres2 ~ slope_30m_SRTM + LandsatCC_ + PAS_total + PH2 + ELEVATION + MODIS_LC + ELEVATION + MODIS_LC + origin.age + Fire_Occ,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))
Anova(model.fruitPA.1, type=3)
summary(model.fruitPA.1)
#Less likely to have fruit where fire occurred
# Positive corellation with origin age
# Positive interaction with pH
# positive interaction with precip as snow
# negative interaction with canopy cover
# positive interaction with slope
AIC(model.fruitPA.1) #565.5
```



```{r}
table(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres)
str(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres)

model.new.F1 <- glm (Fruit.Pres ~ SAI_cb + LandsatCC_ + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREA_SQM + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #449.0

#Remove least sig
model.new.F1 <- glm (Fruit.Pres ~ SAI_cb + LandsatCC_ + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREA_SQM + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #447.0
```

Let's do partial resids for this before refining further

SAI_cb + LandsatCC_ + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREA_SQM + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt

```{r}
#Partial residuals
visreg(model.new.F1, "SAI_cb")
visreg(model.new.F1, "LandsatCC_")

visreg(model.new.F1, "PREP_BU_", by="PREP_ME_")
visreg(model.new.F1, "PREP_ME_", by="PREP_BU_")

visreg(model.new.F1, "PAS_total")
visreg(model.new.F1, "PH2")
visreg(model.new.F1, "Tave_wt")

visreg(model.new.F1, "PLANTED")
visreg(model.new.F1, "AREA_SQM")
visreg(model.new.F1, "ELEVATION")

visreg(model.new.F1, "VFSAND")
visreg(model.new.F1, "DN1_SILSYS_GP")

visreg(model.new.F1, "origin.age")
visreg(model.new.F1, "G_BGC_ZONE")
visreg(model.new.F1, "START_SEASON")

```


```{r}
#Remove least sig
model.new.F1 <- glm (Fruit.Pres ~ SAI_cb + LandsatCC_ + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREA_SQM + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #442.7

#Remove least sig
model.new.F1 <- glm (Fruit.Pres ~ SAI_cb + LandsatCC_ + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREA_SQM + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP  +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #439.8


#Remove least sig
model.new.F1 <- glm (Fruit.Pres ~ SAI_cb + LandsatCC_ + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREA_SQM + ELEVATION + origin.age + VFSAND + DN1_SILSYS_GP,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA,
               family = binomial (link = "logit"))

Anova(model.new.F1, type=3)
summary(model.new.F1)
AIC(model.new.F1) #438.8

```

```{r}
#Partial residuals
visreg(model.new.F1, "SAI_cb")
visreg(model.new.F1, "LandsatCC_")

visreg(model.new.F1, "PREP_BU_", by="PREP_ME_")
visreg(model.new.F1, "PREP_ME_", by="PREP_BU_")

visreg(model.new.F1, "PAS_total")
visreg(model.new.F1, "PH2")

visreg(model.new.F1, "PLANTED")
visreg(model.new.F1, "AREA_SQM")
visreg(model.new.F1, "ELEVATION")

visreg(model.new.F1, "VFSAND")
visreg(model.new.F1, "DN1_SILSYS_GP")

visreg(model.new.F1, "origin.age")

```





### To do next: Species Cover and Fruit Cover

```{r}
Species.Height

Species.Co

Fruit.Cover

Fruit.Abund

Fruit.Brix

Fruit.Phenology

```


#Percent cover, but without full data from BEC data

```{r}
model.new.C1 <- lm (Species.Co~ SAI_cb + LandsatCC_ + PREP_BU_* PREP_ME_ +  PAS_total + PH2 + PLANTED +AREA_SQM + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2451.7
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38

#Remove least sig
model.new.C1 <- lm (Species.Co~ SAI_cb + LandsatCC_ + PREP_BU_ + PREP_ME_ +  PAS_total + PH2 + PLANTED +AREA_SQM + ELEVATION + origin.age + TCLAY + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2449.9
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38

#Remove least sig
model.new.C1 <- lm (Species.Co~ SAI_cb + LandsatCC_ + PREP_BU_ + PREP_ME_ +  PAS_total + PH2 + PLANTED +AREA_SQM + ELEVATION + origin.age  + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2448.1
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38

#Remove least sig
model.new.C1 <- lm (Species.Co~ SAI_cb + LandsatCC_ + PREP_BU_ + PREP_ME_ +  PAS_total + PH2  +AREA_SQM + ELEVATION + origin.age  + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2446.5
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38

#Remove least sig
model.new.C1 <- lm (Species.Co~ SAI_cb + LandsatCC_ + PREP_BU_ + PREP_ME_ +  PAS_total + PH2  +AREA_SQM + ELEVATION + origin.age  + VFSAND + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2419.9
summary(model.new.C1)$r.squared #0.32 --> MAJOR reduction
summary(model.new.C1)$adj.r.squared #0.29

##Remove least sig
model.new.C1 <- lm (Species.Co~ SAI_cb + LandsatCC_ + PREP_BU_ + PREP_ME_ +  PAS_total + PH2   + ELEVATION + origin.age  + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt,
               data=cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA)

Anova(model.new.C1, type=3)
summary(model.new.C1)
AIC(model.new.C1) #2446.3
summary(model.new.C1)$r.squared #0.42
summary(model.new.C1)$adj.r.squared #0.38
```

Partial residuals:SAI_cb + LandsatCC_ + PREP_BU_ + PREP_ME_ +  PAS_total + PH2   + ELEVATION + origin.age  + VFSAND + DN1_SILSYS_GP + G_BGC_ZONE + START_SEASON +Tave_wt

```{r}
visreg(model.new.C1, "SAI_cb")
visreg(model.new.C1, "LandsatCC_")

visreg(model.new.C1, "PREP_BU_")
visreg(model.new.C1, "PREP_ME_")

visreg(model.new.C1, "PAS_total")
visreg(model.new.C1, "PH2")
visreg(model.new.C1, "Tave_wt")

visreg(model.new.C1, "ELEVATION")
visreg(model.new.C1, "origin.age")

visreg(model.new.C1, "VFSAND")
visreg(model.new.C1, "DN1_SILSYS_GP")
visreg(model.new.C1, "G_BGC_ZONE")

visreg(model.new.C1, "START_SEASON")
```








ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = TSAND, y = Species.Co)) +
  geom_point () +
  geom_smooth () +
  labs (title = "Huckleberry Percent Cover in Cutblocks of Different Ages",
        x = "% Sand",
        y = "Species Cover")


##or berry presence/absence, check which months surveys were done and assess if there is seasonality in the data that needs to be partitioned.


#For berry abundance models, plant abundance should be included as a fixed effect (McLelland et al. 2021).




#Other layers with attributes we may want:
https://catalogue.data.gov.bc.ca/dataset/results-activity-treatment-units#edc-pow
https://catalogue.data.gov.bc.ca/dataset/results-forest-cover-silviculture#edc-pow




#Additional code:

Compare to if do intersect in R - do we lose as much data or less?

```{r}
#Load locations within cutblocks
cutblock_plots_gps<- st_read ( dsn = "D:\\Hucklberry\\Grizzly Bear stuff\\berries\\data\\Plots_in_cutblocks_FINAL.shp", stringsAsFactors = T)

#Load openings data
openings_data<- st_read (dsn = "D:\\Hucklberry\\RSLT_OPENING_SVW\\RSLT_OPNGS_polygon.shp", stringsAsFactors = T)

#Combine using "over" from rgeos package - doesn't work because we have sf instead of sp objects. Not sure the proper call so will try again later.
#cutblocks_with_openings<-over(cutblock_plots_gps, openings_data)


```







Assess for fruit Presence/Absence.
Note: this is hierarchical, so when we look at fruit P/A, it should be subsetted and only be where plants occurred.

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres2 <- as.factor (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres2
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA3 <-  subset(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres2!="NA")
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA3$Fruit.Pres2

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA3, aes (x = Fruit.Pres, fill = origin)) + 
geom_bar (position = "fill") +
  scale_fill_discrete (name = "Stand Origin", labels = c("Burned and Harvested", "Harvested", "Burned")) #Unequal sample sizes, but areas burned and harvested might have more fruit.
```

Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = origin, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "Unknown Origin (0), Harvest Origin (1) and Fire Origin (2) Stands",
        y = "Huckleberry Fruit Abundance")

#Reverse pattern as last: highest in burned and harvested in same year, then harvest, then burned.
```


Assess for fruit Presence/Absence.

```{r}
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres2 <- as.factor (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PREP_BU_ <- as.factor (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$PREP_BU)
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA3 <-  subset(cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA$Fruit.Pres2!="NA")
cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA3$Fruit.Pres2

ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA3, aes (x = Fruit.Pres, fill = PREP_BU_)) + 
geom_bar (position = "fill") +
  scale_fill_discrete (name = "Stand Origin", labels = c("Not Burned", "Burned")) 
#No differences
```


Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = PREP_BU_, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "Not Burned (0), Burned(1)",
        y = "Huckleberry Fruit Abundance")

#Not a huge difference
```

Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = PREP_ME_, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "No Mechanical TR (0), Mechanical TR (1)",
        y = "Huckleberry Fruit Abundance")

#Lower with ME
```


Assess for fruit Presence/Absence.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA3, aes (x = Fruit.Pres, fill = DN1_SILSYS_GP)) + 
geom_bar (position = "fill") +
  scale_fill_discrete (name = "Clearcut Technique")
#Fruit presence most common in clearcuts.
```


Assess for fruit abundance by origin.

```{r}
ggplot (cutblock_plots_openings_Huck_ALL_df_2022_b2_FruitNotNA, aes (x = DN1_SILSYS_GP, y = Fruit.Abund)) +
  geom_boxplot () +
  labs (x = "Clearcut Technique",
        y = "Huckleberry Fruit Abundance")

#Appears highest in other site clearcut types, then clearcut > clearcut with reserves
```