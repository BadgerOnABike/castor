---
title: "Chilcotin Cariobu Local Population Unit (LPU) critical habitat protection scenario."
author: "Tyler Muhly"
date: "July 22, 2019"
output: 
  html_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Scenario Background
This habitat protection scenario tests the influence of protecting newly designated and incompletely protected critical habitat for caribou on timber harvest flows, i.e., allowable annual cut (AAC), caribou habitat quality, moose habitat quality, moose density (?) and wolf density (?), over time, using the caribou and land use simulator (CLUS). Critical habitat for caribou is as spatially defined by the government of British Columbia (source). Provincial wildlife biologists and caribou recovery program area leads defined how each type of critical habitat would be protected from forestry activity within the context of this scenario and the functionality of the CLUS model. 

The CLUS model in general was designed to support caribou recovery planning, as a tool to explore and discuss the implications of alternative management scenarios to caribou and other resource values. The tool does not necessarily provide accurate or optimal solutions for caribou recovery but can help identify preferred recovery actions.  

# Scenario Study Area
This scenario was developed to support caribou recovery planning in the Chilcotin local population unit (LPU) of caribou. This LPU consists of the Itcha-Ilgachuz, Rainbows and Charlotte Alplands caribou herds, and constitutes the southernmost LPU of the Northern Mountain Caribou Designatible Unit (DU 7). These caribou are classified as *Threatened* under Canada's *Species at Risk Act*. 

The Itcha-Ilgachuz herd is considered to be of significant conservation importance provincially because it is the largest and highest density herd in west-central British Columbia (cite herd plan). However, the herd declined 17.2% annually between 2014 and 2018, and the habitat has experienced significant amounts of timber harvesting, associated road development, wildfire and mountain pine beetle infestations (cite herd plan). In addition, the 2019 population census showed a 40% popualion decline from 2018, and at that rate of decline, the herd would be functionally extirpated (i.e., less than 20 animals) in eight years (Carolyn Shores, pers. comm.). There is an increasingly urgent need to develop an effective recovery plan for these caribou. 

The Chilcotin LPU overlaps the following timber supply areas (TSAs) and timber supply blocks (TSBs):
* Great Bear Rainforest (GBR) North TSA
* GBR South TSA, TSB V 47C
* Prince George TSA, TSB 24D
* Quesnel TSA, TSBs 26B and 26A
* Williams Lake TSA, TSBs 29A, 29B, 29C, 29E and 29I
The overlap with the Prince George TSA is minimal, and most of the GBR North TSA that overlaps the  LPU is in Tweedsmuir Park. Thus, the impacts of new caribou habitat protections to timber supply in these TSAs are expected to be minimal or null. The AAC's in the GBR South and GBR North TSAs were established through legislation. Thus, they are unlikely to be quickly changed if new caribou protection orders were established in those areas. Therefore, the focus of this scenario is on AAC impacts to the Quesnel TSA and Williams Lake TSA.
 
Existing habitat protections for caribou (e.g., caribou-specific ungulate winter ranges) and for wildlife and ecosystems more broadly (e.g., provincial parks), are addressed in this scenario as parameters in the CLUS model. These primarily include 219,152 ha designated as 'conditional harvest' and 193,470 ha as 'no-harvest' zones within provincial parks or WHAs (cite herd plan). These existing protections are implemented in all model scenarios. 

# Scenario Habitat Protections
Critical habitat for caribou in the Chiltoin LPU consists of five types:
* high elevation winter range (HEWR)
* high elevation summer range (HESR)
* low elevation winter range (LEWR)
* low elevation summer range (LESR)
* matrix
Each of these types corresponds to a specific habitat protection definition, based on its understood importance to caribou population sustainability. They are consistent with the federal recovery strategy for southern mountain caribou ([Environment Canada 2014](https://www.registrelep-sararegistry.gc.ca/virtual_sara/files/plans/rs_woodland_caribou_bois_s_mtn_pop_0114_e.pdf)), although the protection definitions for some types are ambiguous within the federal plan.     

HEWR and HESR critical habitat types (often referred to as 'core' habitat) typically consist of areas heavily and regularly used by caribou. Parks, wildlife habitat areas (WHAs) and ungulate winter ranges (UWRs) already exist over many of these areas to protect this habitat. Management plans for caribou typically recommend full protection of these types from forest harvest [Environment Canada 2014](https://www.registrelep-sararegistry.gc.ca/virtual_sara/files/plans/rs_woodland_caribou_bois_s_mtn_pop_0114_e.pdf); also cite herd plan). 

LEWR and LESR are also regularly used by caribou, but may not be as protected by existing orders and regulations. Indeed, the current priority proposed recovery actions for the Itcha-Ilgachuz herd are to protect LEWR and LESR critical habitat from further timber harvesting and development (cite herd plan). However, currently, 97% of the Itcha-Ilgachuz herd’s LEWR is available for timber harvesting (cite herd plan), and thus there is uncertainty and concern over how these proposed actions may influence forest harvest and the AAC in the Williams Lake and Quesnel TSA's. In addition, predator removal has been proposed for the Chilcotin LPU, but it's long-term effectiveness as a recovery action depends on effective habitat protection.  

Matrix habitat is not regularly used by caribou, and thus there are typically little or no protections for caribou in this habitat type. Matrix habitat areas are typically large and adjacent to HEWR, HESR, LEWR or LESR habitat types. The intent of matrix is to provide a 'buffer' against high predator density or use of HEWR, HESR, LEWR or LESR habitat types, allowing these types to function more effectively as refugia from predators. Some level of redcution in forest harvest in matrix habitat is recommend in caribou plans. Specifically, the federal recovery plan for southern mountain caribou recommends maintaining matrix habitat that supports less than 3 wolves per 1,000km^2^, and the Itcha-Ilgachuz herd plan recommends maintaining habitat 'disturbance' below 35% within matrix areas.

How habitat 'disturbance' is defined is somewhat ambiguous and requires clarification here. Disturbance and the 35% 'management threshold' were originally defined in the federal boreal caribou recovery strategy [Environment Canada 2012](https://www.registrelep-sararegistry.gc.ca/virtual_sara/files/plans/rs_caribou_boreal_caribou_0912_e1.pdf). A scientific assessment was completed to support this strategy [Environment Canada 2011](https://www.registrelep-sararegistry.gc.ca/virtual_sara/files/ri_boreal_caribou_science_0811_eng.pdf), and included a regression model relating habitat disturbance in caribou popualtion ranges to probability that boreal caribou populations are stable or gwowing (i.e., $\lambda$ $\geq$ 1). There, habitat disturbance was defined as anthropoegnic disturbances (i.e., 'human footprint', such as cutblocks and roads) clearly visible using 1:50,000 resolution satellite imagery, and burnt areas less than 40 years old, as defined in the national fire database [link](http://cwfis.cfs.nrcan.gc.ca/ha/nfdb?wbdisable=true). Human footprint was also buffered by 500m. The relationship between disturbance and probability of $\lambda$ $\geq$ 1 is continuous, but a 35% disturbance threshold was identified as a reasonable threshold to achieve a sustainable caribou population. This model and management threshold has since been applied to some critical habitat types for southern mountain caribou. However, the model has not been tested or validated for southern mountain caribou habtiat, and often disturbance is measured differently from how it was definened in the boreal analysis. Thus, the disturbance model and managmen threshold should be used caution and under the assumption that it is highly uncertain. 

Here we define the following forest harvest constraints for each critical habitat type for this scenario:
```{r, create the protection type data.table}
library (data.table)
library (kableExtra)
tab_protection_type <- data.table (Type = c ('High Elevation Summer Range (HESR)', 
                                             'High Elevation Winter (HEWR)', 
                                             'Low Elevation Summer Range (LESR)', 
                                             'Low Elevation Winter Range (LEWR)', 
                                             'Matrix'),
                                  Constraint = c ('No Harvest', 
                                                  'No Harvest', 
                                                  'No Harvest', 
                                                  'No Harvest',                                                                                       'Less than 20% forest age less than 40 years old')
                                   )
kable (tab_protection_type)
```
HESR, HEWR, LESR and LEWR habitat types are defined as 'no harvest' areas, with the intent of protecting habitats heavily or regularly used by caribou. Matrix areas allow for some forest harvest. We use a 20% area threshold of 40 year old forest definition as a means to limit the amount of early seral forest in matrix habitat. Early seral forest is thought to be a critical driver of moose popualtions, where higher amounts of early seral forest is thought to contribute to increased moose forage and moose densities (Wam et al. 2010; Bjørneraas et al. 2011; Serrouya et al. 2011). This subsequently is thought to support higher predator (ie.. wolf) densities and higher predation rates on caribou (Wittmer et al. 2007; Lesmerises et al. 2012). The 20% area threshold is based on a statistical relationship calculated between 'disturbed' habitat (defined as areas within 500 m of less than 40 year old cutblocks or roads, or within less than 40 year old burns) and the density of roads and cutblocks less than 40 years old with landscape units [Muhly 2016](https://www2.gov.bc.ca/assets/gov/farming-natural-resources-and-industry/forestry/stewardship/forest-analysis-inventory/tsr-annual-allowable-cut/wildlife-analysis/pg_tsr_caribou_20161128.pdf). The statistical model indicated that a cutblock area of 18.5% was equivalent to 35% habitat disturbance.



Alternatives:
 - use Doug LEwis model to calculate moose density and
 - develop model of raltionshp between moose dnesity and ealy seral habtiat 



# Scenario Outputs
Outputs from CLUS relevant to this scenario include AAC, caribou habitat quality and moose habitat quality. AAC outptus can be used to evaluate how new protections might impact forest harvest oeprations ability to achieve AAC targets in the William's Lake and Quesnel TSA's. Habitat quality outputs for wildlife are indicated by resource selection function (RSF) scores, which can be used to indicate quality of habitat available to caribou. 

Outputs should be evaluated relative to a scenario without the protections defined here (i.e., a "business-as-usual" scenario) rather than as an absolute representation of impacts to AAC and habitat.


 


## Create Scenario Habitat Data

```{r, Chilctoin LPU critical habitat}

####
### load critical habtiat to postgres db as 'rast.zone_crit_habitat' ###
####


library (here)
library (sf)
library (fasterize)
source (paste0 (here(),"/R/functions/R_Postgres.R")) # postgres functions

# call the critical habitat polygon data from the postgres db
critical_habitat_poly <- getSpatialQuery ("SELECT ogc_fid, wha_tag, feat_notes, aprv_date, wkb_geometry FROM public.wcp_whaply_polygon WHERE wha_tag IN 
(SELECT a.wha_tag  FROM public.wcp_whaply_polygon  a , public.study_area_tsa b WHERE  ST_INTERSECTS (a.wkb_geometry, b.wkb_geometry)) ORDER BY aprv_date ASC")

# Create the hectares bc raster 
ProvRast <- raster(
  nrows = 15744, ncols = 17216, xmn = 159587.5, xmx = 1881187.5, ymn = 173787.5, ymx = 1748187.5, 
  crs = st_crs(getSpatialQuery ("SELECT * FROM public.rmp_lu_sp_polygon LIMIT 1"))$proj4string, # getting the spatial projection from existing data 
  resolution = c(100, 100), vals = 0
)

# fasterize - convert the polygon to the provincal raster
crit.habitat.ras <- fasterize::fasterize (sf = critical_habitat_poly, 
                                          raster = ProvRast, 
                                          field = "ogc_fid")

# Create empty zone constraint table
zone_crit_habitat <- data.table (zoneid = integer (), type = character (), variable = character (), 
                                 threshold = numeric (), reference_zone = character (), 
                                 percentage = numeric (), ndt = integer (), label = character ())

#get the ogc_fid from raster
ogc_fids < -data.table (unique (c (t (raster::as.matrix (crit.habitat.ras)))))
ogc_fids <- ogc_fids [!(is.na (V1)),]
crit_habitat_cond <- getTableQuery (paste0 ("SELECT ogc_fid, harvest,wha_tag, feat_notes, aprv_date FROM public.wcp_whaply_polygon WHERE ogc_fid IN(",paste(ogc_fids$V1, collapse = ","), ") ORDER BY wha_tag"))

# assign all no harvest as 0 -- pertains to 3-030 -- this can be any number that has no harvest
ogc_fids_noharv <- crit_habitat_cond[crit_habitat_cond$harvest == 'NO HARVEST ZONE', "ogc_fid"]
zone_crit_habitat <- data.table(zoneid = 0, type = 'nh', variable = '', threshold = 0, 
                                reference_zone ='zone_crit_habitat', percentage = 0, ndt = 0, 
                                label = 'no_harvest')
#set all to 0 in the raster as no harvest
crit.habitat.ras [crit.habitat.ras [] %in% ogc_fids_noharv] <- 0

crit_habitat_cond <- crit_habitat_cond [!(wha_cond$harvest == 'NO HARVEST ZONE'), ] # get only the conditional harvesting ones now.


```

### Conditional Harvest
```{r, u3003}
library(data.table)
library(sf)

u7007<-getSpatialQuery("SELECT  ogc_fid, unit_no, feat_notes, wkb_geometry FROM public.wcp_uwr_sp_polygon WHERE uwr_tag = 'u-7-007' AND harvest = 'CONDITIONAL HARVEST ZONE'")

# change the uwr to one unit (the min of the ogc_fid)
zoneid_new2<-min(u7007$ogc_fid) #177829
uwr_cond_harvest[uwr_cond_harvest$uwr_tag == 'u-7-007',]$ogc_fid<-zoneid_new2

u7007_table<-data.table(zoneid =zoneid_new2, reference_zone ='rast.zone_uwr', variable ='age', type = 'ge', percentage =50 , threshold = 70, ndt = 0, label = 'u-7-007')

zone_uwr<-rbind(zone_uwr, u7007_table)

rm(u7007_table,u7007)
gc()
#Check
zone_uwr[label == 'u-7-007',]
```



## UWR conditional harvest raster
```{r, cond_ras}
library(here)
source("C:/Users/KLOCHHEA/clus/R/functions/R_Postgres.R")

lu<-getSpatialQuery("SELECT *
FROM public.rmp_lu_sp_polygon LIMIT 1")

#Get the raster and projection
ProvRast <- raster(
  nrows = 15744, ncols = 17216, xmn = 159587.5, xmx = 1881187.5, ymn = 173787.5, ymx = 1748187.5, 
  crs = st_crs(lu)$proj4string, resolution = c(100, 100), vals = 0
)

#fasterize 
class(uwr_cond_harvest$ogc_fid)
uwr.ras<-fasterize::fasterize(sf= uwr_cond_harvest, raster = ProvRast , field = "ogc_fid")
#writeRaster(test, file="uwr.tif", format="GTiff", overwrite=TRUE)

no_harv<-getSpatialQuery("SELECT  ogc_fid, uwr_tag, feat_notes, wkb_geometry FROM public.wcp_uwr_sp_polygon WHERE harvest = 'NO HARVEST ZONE'  ORDER BY apprv_date ASC")
uwr_nh.ras<-fasterize::fasterize(sf= no_harv, raster = ProvRast , field = "ogc_fid")
#writeRaster(uwr_nh.ras, file="uwr_nh.tif", format="GTiff", overwrite=TRUE)
uwr.ras[uwr_nh.ras[]> 0 ]<-0
writeRaster(uwr.ras, file="uwr.tif", format="GTiff", overwrite=TRUE)

#upload to db
system("cmd.exe", input = paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', here(), '/R/params/uwr.tif -t 100x100 rast.zone_cond_uwr | psql -d clus'), show.output.on.console = FALSE, invisible = TRUE)


```

## Commit the zone_uwr
```{r, commit_uwr, eval=FALSE}
df<-as.data.frame(zone_uwr)
df$ndt<-as.integer(0)
df$zoneid<-as.integer(df$zoneid)#assign integer
df$percentage<-as.numeric(df$percentage)#assign integer

conn<-DBI::dbConnect(dbDriver("PostgreSQL"), host=keyring::key_get('dbhost', keyring = 'postgreSQL'), dbname = keyring::key_get('dbname', keyring = 'postgreSQL'), port='5432' ,user=keyring::key_get('dbuser', keyring = 'postgreSQL') ,password= keyring::key_get('dbpass', keyring = 'postgreSQL'))

DBI::dbWriteTable(conn, c("public", "zone_uwr"), value= df, row.names = FALSE, overwrite = TRUE) 

#clean up the constraint table
#dbExecute(conn, "DELETE FROM public.zone_uwr WHERE zoneid IN (SELECT g.zoneid FROM (SELECT * FROM public.zone_uwr FULL OUTER JOIN (SELECT (pvc).value as value, SUM((pvc).count) as count FROM (SELECT ST_ValueCount(rast,1,true) AS pvc FROM rast.zone_cond_uwr) AS f GROUP BY value ORDER BY value) as h ON zoneid = value ORDER BY zoneid, value) as g WHERE g.value is NULL);")

dbDisconnect(conn)
```


# Literature Cited
Bjørneraas, K., Solberg, E. J., Herfindal, I., Van Moorter, B., Rolandsen, C. M., Tremblay, J. P., ... & Astrup, R. (2011). Moose Alces alces habitat use at multiple temporal scales in a human-altered landscape. Wildlife Biology, 17(1), 44-54.

Lesmerises, F., Dussault, C., & St-Laurent, M. H. (2012). Wolf habitat selection is shaped by human activities in a highly managed boreal forest. Forest ecology and management, 276, 125-131.

Serrouya, R., McLellan, B. N., Boutin, S., Seip, D. R., & Nielsen, S. E. (2011). Developing a population target for an overabundant ungulate for ecosystem restoration. Journal of Applied Ecology, 48(4), 935-942.

Wam, H. K., Hjeljord, O., & Solberg, E. J. (2010). Differential forage use makes carrying capacity equivocal on ranges of Scandinavian moose (Alces alces). Canadian Journal of Zoology, 88(12), 1179-1191.

Wittmer, H. U., McLellan, B. N., Serrouya, R., & Apps, C. D. (2007). Changes in landscape composition influence the decline of a threatened woodland caribou population. Journal of animal ecology, 76(3), 568-579.