---
title: "Scripts for creating parameters to run Castor model for Fort Nelson timber supply area for comparison to SELES/STSM"
output: html_document
---

All data comes from Qinglin Li, and is the data used to complete the timber supply review in 2020-21.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source (here::here("R/functions/R_Postgres.R"))
library (data.table)
library (sf)
library (tidyverse)
library (raster)
library (fasterize)

data.dir <- "D:\\clus_data\\castor_stsm\\FN_data\\"

#Create a provincial raster
layeraoi<-getSpatialQuery("SELECT * FROM study_area_compart limit 1")
prov.rast <- raster::raster(
  nrows = 15744, ncols = 17216, xmn = 159587.5, xmx = 1881187.5, ymn = 173787.5, ymx = 1748187.5, 
  crs = st_crs(layeraoi)$proj4string, resolution = c(100, 100), vals = 0)
```

## Fort Nelson TSA - Area of Interest
```{r Fort Nelson TSA}

fn.tsa <- st_make_valid (st_read (dsn = paste0 (data.dir, "fn_spatial.gdb"),
                                  layer = "bnd"))
fn.tsa$tsa_name <- "Fort_Nelson_TSA"
fn.tsa$value <- as.integer (1)
fn.tsa$included <- NULL
fn.tsa$bnd_fid <- NULL
fn.tsa$ORIG_FID <- NULL
fn.tsa$Shape_Length <- NULL
fn.tsa$Shape_Area <- NULL

st_write (fn.tsa, paste0 (data.dir, "bounds_fort_nelson_tsa.shp"))
# ogr2ogr -f PostgreSQL PG:"dbname=clus port=5432 user= password= host=" SCHEMA=fort_nelson_tsa D:\clus_data\castor_stsm\FN_data\bounds_fort_nelson_tsa.shp bounds_fort_nelson_tsa -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI -lco 

fn.tsa.vat <- as.data.table (unique (fn.tsa$tsa_name))
fn.tsa.vat [, value := seq_len(.N)]

# Rasterize 
ras.fn.tsa <-fasterize::fasterize (st_cast (fn.tsa, "MULTIPOLYGON"), prov.rast, field = "value")
writeRaster (ras.fn.tsa, paste0 (data.dir, "bounds_fort_nelson_tsa.tif"), overwrite = T)

# write data
conn<-DBI::dbConnect(dbDriver("PostgreSQL"), host=keyring::key_get('dbhost', keyring = 'postgreSQL'), dbname = keyring::key_get('dbname', keyring = 'postgreSQL'), port='5432' ,user=keyring::key_get('dbuser', keyring = 'postgreSQL') ,password= keyring::key_get('dbpass', keyring = 'postgreSQL'))

setnames (fn.tsa.vat, c ("attribute", "value")) # Note use convention; always name these value and attribute
DBI::dbWriteTable(conn, c("fort_nelson_tsa", "vat_bounds_fort_nelson_tsa"), value = fn.tsa.vat, row.names = FALSE, overwrite = TRUE)

system("cmd.exe", input = paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', data.dir, 'bounds_fort_nelson_tsa.tif -t 100x100 fort_nelson_tsa.rast_bounds_fort_nelson_tsa | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus'), show.output.on.console = FALSE, invisible = TRUE)

dbDisconnect(conn)
```

## Inventory

```{r, inventory data}

fn.vri <- st_make_valid (st_read (dsn = paste0 (data.dir, "fn_spatial.gdb"),
                                  layer = "vri"))
fn.vri$Shape_Length <- NULL
fn.vri$Shape_Area <- NULL
st_write (fn.vri, paste0 (data.dir, "vri_fort_nelson_tsa.shp"))
# ogr2ogr -f PostgreSQL PG:"dbname=clus port=5432 user= password= host=" SCHEMA=fort_nelson_tsa D:\clus_data\castor_stsm\FN_data\vri_fort_nelson_tsa.shp vri_fort_nelson_tsa -a_srs EPSG:3005 -progress --config PG_USE_COPY YES -nlt PROMOTE_TO_MULTI -lco 

# Rasterize 
ras.fn.vri <-fasterize::fasterize (st_cast (fn.vri, "MULTIPOLYGON"), prov.rast, field = "vri_fid")
writeRaster (ras.fn.vri, paste0 (data.dir, "vri_fort_nelson_tsa.tif"), overwrite = T)

# write data
system("cmd.exe", input = paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', data.dir, 'vri_fort_nelson_tsa.tif -t 100x100 fort_nelson_tsa.rast_vri_id_fort_nelson_tsa | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus'), show.output.on.console = FALSE, invisible = TRUE)

```

## Growth and Yield

```{r, g and y data}
## TABLES
tab.au.info <- data.table (read.table (paste0 (data.dir, "AUInfo.txt"), header = T, sep = '\t'))
tab.mgd.vol <- data.table (read.table (paste0 (data.dir, "MgdVolumeTables.txt"), header = T, sep = '\t')) # use this for both 'natural' and 'managed' stands 
tab.height <- data.table (read.table (paste0 (data.dir, "HeightTables.txt"), header = T, sep = '\t'))

# Check for dupes 
# tab.count <- tab.mgd.vol %>%
#               group_by (au) %>%
#                tally ()
# check <- tab.count %>%
#           dplyr::filter (n > 1)

# Format
colnames (tab.mgd.vol) <- c('ycid', "0", "10", "20", "30", "40", "50", "60", "70", "80", "90", "100", "110", "120", "130", "140", "150", "160", "170", "180", "190", "200", "210", "220", "230", "240", "250", "260", "270", "280", "290", "300")
colnames (tab.height) <- c('ycid', "0", "10", "20", "30", "40", "50", "60", "70", "80", "90", "100", "110", "120", "130", "140", "150", "160", "170", "180", "190", "200", "210", "220", "230", "240", "250", "260", "270", "280", "290", "300")
tab.au.info <- tab.au.info [, c ("AU", "Auid")]
colnames (tab.au.info) <- c ("ycid", "yc_grp")
# reshape the table to long form
tab.vol <- melt (tab.mgd.vol, 
                 id.vars = "ycid",
                 measure.vars = list (age = c ("0", "10", "20", "30", "40", "50", "60", "70", "80", "90", "100", "110", "120", "130", "140", "150", "160", "170", "180", "190", "200", "210", "220", "230", "240", "250", "260", "270", "280", "290", "300")),
                  value.name = "tvol",
                  variable.name = "age")
tab.hgt <- melt (tab.height, 
                 id.vars = "ycid",
                 measure.vars = list (age = c ("0", "10", "20", "30", "40", "50", "60", "70", "80", "90", "100", "110", "120", "130", "140", "150", "160", "170", "180", "190", "200", "210", "220", "230", "240", "250", "260", "270", "280", "290", "300")),
                  value.name = "height",
                  variable.name = "age")

# join the tables
tab.yields <- merge (tab.vol,
                     tab.hgt, 
                     by.x = c ("ycid", "age"),
                     by.y = c ("ycid", "age"),
                     all.x = T)
tab.gy <- merge (tab.au.info,
                 tab.yields, 
                 by.x = "ycid",
                 by.y = "ycid",
                 all.x = T)

# write table
conn<-DBI::dbConnect(dbDriver("PostgreSQL"), host=keyring::key_get('dbhost', keyring = 'postgreSQL'), dbname = keyring::key_get('dbname', keyring = 'postgreSQL'), port='5432' ,user=keyring::key_get('dbuser', keyring = 'postgreSQL') ,password= keyring::key_get('dbpass', keyring = 'postgreSQL'))

DBI::dbWriteTable (conn, c("fort_nelson_tsa", "yc_table"), value = tab.gy, row.names = FALSE, overwrite = TRUE)

## RASTERS
# analysis unit raster
rast.yield.id <- raster::raster (paste0 (data.dir, "tsa08_au2016.tif")) 
writeRaster (rast.yield.id, paste0 (data.dir, "rast_ycid_fort_nelson_tsa.tif"), overwrite = T)
system ("cmd.exe", input = paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', data.dir, 'rast_ycid_fort_nelson_tsa.tif -t 100x100 fort_nelson_tsa.rast_ycid_fort_nelson_tsa | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus'), show.output.on.console = FALSE, invisible = TRUE)

```


## THLB
```{r thlb}

thlb <- raster::raster (paste0 (data.dir, "tsa08_thlb_fact_nov2019.tif")) 
# values have been multiplied to make them 0 to 10,000; divide by 10,000 to make it a value 0 to 1
thlb <- thlb / 10000
## Upload data to db
crs(thlb) <- "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs"
writeRaster (thlb, file = paste0 (data.dir, "thlb.tif"), format = "GTiff", overwrite = TRUE)
system ("cmd.exe", input = paste0 ('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', data.dir, 'thlb.tif -t 100x100 fort_nelson_tsa.rast_thlb | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus'), show.output.on.console = FALSE, invisible = TRUE)

```



## Harvest Constraint Zones

```{r harvest constraints}

tab.constraints <- data.table (read.table (paste0 (data.dir, "CoverConstraints.txt"), header = T, sep = '\t'))







rast.irm <- raster::raster (paste0 (data.dir, "gisData\\grids\\IRMzone.tif")) 
rast.lu <- raster::raster (paste0 (data.dir, "gisData\\grids\\lu.tif")) 
# LU classes: 1:Bear  2:Bowser  3:BrownBear  4:CambriaIcefield  5:Craven  6:GreenvilleKalum  7:Kinskuch  8:Kiteen  9:Kwinamuck  10:Madely  11:Muskaboo  12:NassRiverKalum  13:Oweegee  14:Sallysout 15:SpatsiziRiver  16:TaylorDamdochax  17:Tchitin  18:Tintina  19:White  20:Wildfire
unique(getValues(rast.lu))

rast.lu.irm <- rast.irm * rast.lu
unique(getValues(rast.lu.irm))

zone_irm <- data.table (zoneid = as.integer (c(1:20)), 
                             type = 'ge',
                             variable = 'height', 
                             threshold = as.numeric (3), 
                             reference_zone = 'comparison_nass.rast_zone_irm_lu', 
                             percentage = 65, ndt = as.integer (0), 
                             label = c ('bear', 'bowser', 'brownbear', 'cambriaicefield', 'craven', 'greenvillekalum',
                                        'kinsuch', 'kiteen', 'kwinamuck', 'madely', 'muskaboo', 'nassriverkalum', 'oweegee',
                                        'sallysout', 'spatsiziriver', 'taylordamdochax', 'tchitin', 'tintina', 'white',
                                        'wildfire'), 
                             multi_condition = as.character (''), 
                             denom = as.character ('thlb > 0'), start = as.integer (0), stop = as.integer (0))

## Upload data to db
crs(rast.irm) <- "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs"
writeRaster(rast.irm, file = "irm.tif", format = "GTiff", overwrite = TRUE)
system("cmd.exe", input = paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', here::here(), '/R/params/irm.tif -t 100x100 comparison_nass.rast_zone_irm | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus'), show.output.on.console = FALSE, invisible = TRUE)

crs(rast.lu.irm) <- "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs"
writeRaster(rast.lu.irm, file = "irm_lu.tif", format = "GTiff", overwrite = TRUE)
system("cmd.exe", input = paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', here::here(), '/R/params/irm_lu.tif -t 100x100 comparison_nass.rast_zone_irm_lu | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus'), show.output.on.console = FALSE, invisible = TRUE)

conn<-DBI::dbConnect(dbDriver("PostgreSQL"), host=keyring::key_get('dbhost', keyring = 'postgreSQL'), dbname = keyring::key_get('dbname', keyring = 'postgreSQL'), port='5432' ,user=keyring::key_get('dbuser', keyring = 'postgreSQL') ,password= keyring::key_get('dbpass', keyring = 'postgreSQL'))
DBI::dbWriteTable(conn, c("comparison_nass", "zone_irm_lu"), value = zone_irm, row.names = FALSE, overwrite = TRUE) 
dbExecute(conn, "ALTER TABLE comparison_nass.zone_irm_lu ALTER COLUMN denom TYPE VARCHAR;")
dbExecute (conn, paste0("ALTER TABLE comparison_nass.zone_irm_lu INHERIT comparison_nass.zone_constraints_nass"))

dbDisconnect(conn)

```



