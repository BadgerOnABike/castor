---
title: "Estimating volume yield uncertainty from a meta-model of VDYP"
output: html_document
---

# Introduction

Estimates of merchantable tree volume yields are neccessaary inputs into timber supply forecasts and also serve as surrogates for many ecological processes of interest to decision makers (e.g., biomass, carbon, wildlife habitat). Often these estimates are forecasted through time using empirically derived growth and yield models. The input parameters for these models can vary from individual tree level to stand level attributes with a forest inventory providing the majority of this information. In particular, stand-level information is often used to paramterize these models given its availability across very large spatial scales. At a minimum the required stand-level parameters tend  to include: specific geographical or ecological zone, species compositions, a measure of site productivity (e.g., site index) and density (e.g., trees per ha or basal area per ha). However, projecting this information across very large scales or macroscales like the province of BC can be computationally restrictive; given the level of precision in the forest attributes could result in numerous projections. For example, in the [Vegetation Resources Inventory](https://www.for.gov.bc.ca/hfd/library/documents/bib106996.pdf) (VRI) of British Columbia (BC), forest attributes like site index are reported to the nearest decimeter, species compositions can contain up to 6 species with an estimate of the percentage for each species to the nearest 1%, stand height is reported to the nearest decimeter and basal area to the nearest squared meter. Thus, the combinations of these highly precise input parameters would result in millions of possible yield curves; that consume valuable computer resources to project through growth and yield models.

One approach to alleviate this problem is to aggregate the yield projections by yield curve groups or analysis units. Aggregation may be warranted, given the accuracy of the forest inventory attributes may not support such high level of precision. The [current standard](https://www2.gov.bc.ca/assets/gov/environment/natural-resource-stewardship/nr-laws-policy/risc/vri_photo_interp_qa_proc_and_stds_v43_2019.pdf) for quality assurance of VRI variables varies by attribute with species compositions around 80% correspondance, height $\pm$ 3 - 4 m,  age $\pm$ 10 years, crown closure $\pm$ 10%, basal area $\pm$ 10-15 $m^2$, tph $\pm$ 100 stems. However, aggregation may results in costs in terms of the loss of information; this may pose serious problems when simulating individal stand level decision making. 

Simulating forest management decision at very large scales involves a long list of assumptions; many based on volume yield estimates that contain error. Known sources of error arise from i.) the forest inventory (initial state of the forest); ii.) the projection of the forest inventory (i.e., the growth and yield model); iii.) the loss of information through aggregation into yield curves groups; and iv.) changes in forest policy. All of these sources of error propagate through time in complex ways which may provide barriers for confidentaly making forest management decisions. 

Recently, Robinson et al. (2016) recommended a simple way to incorpate error from volume yield projections into decision making through the use of observed scale data that is commonly collected following timber harvesting operations. They propose a calibration model approach to not only calibrate yields from a given growth and yield model but also to provide a measure of error around the volume yield estimate. Thus, the value of the Robinson et al. (2016) approach is two fold: 1.) a calibration of the yields for use when simulating the management decisions and 2.) the ability to simulate the error in volume yield. To further explain the later,  Robinson et al. (2016) estimated parameters of the error distribution (conditional mean and variance) for a given prediction. Once these parameters were estimated (conditional on the projected volume estimates), it was realtively simple to reconstruct the error distribution using these fitted parameters and then sample this error distribtuion many times (i.e., 10000). The result was a distribution of plausible yields that can be summarized into statistics like: the proportion or probability above a specifed threshold (i.e., AAC) or the estimation of a prediction interval. Note that the prediction interval is not the same as the confidence interval- the prediction interval takes into account two sources of uncertainty: i) the uncertainty of the distrbution of the process; and ii) the uncertainty of the location of the prediction within the distribution. The impetus of this work was a data set with both observed volume yield (as measured from scale data) and projected volume yields derived from linking a forest inventory with a growth and yield model. 

To apply this approach in the province of BC, this would require linking the harvest billing systemn (HBS) data which provides observed billable harvest volumes for a spatial unit known as a timber mark with VRI information before the date of harvest and then using this information as the neccessary inputs for a growth and yield model.The finest spatial resolution of the HBS is the timber mark which is a Unique identifer stamped or marked on the end of each log to associate the log with the specific authority to harvest and move timber. Timber marks can be assigned to many harvest units that may be not be sptailly contiguous nor contain a single harvest date.  Historically, linking HBS and VRI data has been difficult due to issues with the spatial accuracy in estimating the spatial boundaries of the timber marks. This has largely been due to spatialy estimating the net area being harvested (i.e., netting out roads, wildlife tree patches, etc). To achieve forest management objectives various amounts of forest may be retained in specific areas within a harvest unit and these areas can be difficult to determine for historical cutblocks. While a series of different data sources (i.e., Landsat, VRI) can be used, the accuracy of these products is unknown. These factors complicate linking the spatial boundary and its estimate of the net harvest area to the VRI.

In the following sections, the spatial (timber mark boundaries) and temporal (harvest date, inventory projection) data are linked to re-create the approach by Robinson et al. (2016). The specific objectives are: i) to calibrate the projected volume yields from an aggregated growth and yield model (hereafter termed the meta-model) with observed volume yields reported in the harvest billing system and ii) demonstrate the use of this model in landscape simulations for assessing error in yields. The proposed calibration model will be used in the caribou and landuse model (CLUS) to provide an indication of volume yield uncertainty which will help provide some context surrounding the quantification of impacts from conservation activities on harvest flows. 

# Methods
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(sf)
library(dplyr)
library(velox)
library(ggplot2)
library(Hmisc)
library(bcmaps)
source("C:/Users/KLOCHHEA/clus/R/functions/R_Postgres.R")
```

## Linking timber mark boundaries with VRI

In order to link the timber mark boundaries with the VRI whcih is needed to link to a growth and yield model the following steps were completed (see [code](https://github.com/bcgov/clus/blob/master/SQL/develop_vri2011table.sql))

1. Estimate the spatial boundaries of the timber marks

The spatial boundaries of the timber mark were estimated using two spatial data sets: i) [forest tenure cutblock polygons](https://catalogue.data.gov.bc.ca/dataset/forest-tenure-cutblock-polygons-fta-4-0) (aka. ftn_c_b_pl_polygon) and ii) [consolidated cutblock polygons](https://catalogue.data.gov.bc.ca/dataset/harvested-areas-of-bc-consolidated-cutblocks-) (a.k.a cns_cut_bl_polygon). Using the ftn_c_b_pl_polygon, all timber marks comprised of openings (harvest units) that had disturbance start dates between 2012-01-01 and 2016-12-31 were selected (i.e., removed possible timber marks with some openings not in this range). This selected subset of ftn_c_b_pl_polygon was then joined with cns_cut_bl_polygon by the harvest unit identifier (viz. opening_id) to link the timber mark to a spatial boundary. Lastly, timber marks were removed that did not fully contain geometries reported by RESULTS (the most accurate form of reporting cutblock information). This ensured a more accurate net spatial description of the timber mark boundary (i.e., removed retention patches). The result of this process was 2912 unique timber marks; this list was then used to query the Harvest Billing System.

2. Intersect the timber mark spatial boundaries of the s with the VRI

The resulting timber mark spatial boundaries were spatialy intersected with the 2011 VRI to provide the neccessary forest attribute information for linking to the growth and yield model. Only layer rank 1 forest attribution was used to link to the growth and yield model. However, as a result of this intersection 1604 of the timber marks did not have a portion of their total area that faild to provide the neccessary VRI information (i.e., Tree Farm Licenses, private areas) for a forest yield projection. 

The following is the distribution of the percentage of the total timber mark area without a yield estimate:

```{r, timber_mrks, echo = FALSE, fig.cap = 'FIGURE 1. A histogram of the percentage of the total timber mark area that did not match with forested VRI polygons. q25 and q75 are the 25th and 75th quantile, respectively.'}
feats<-getSpatialQuery("SELECT feature_id, shape, bec_zone_code, site_index, crown_closure, proj_height_1, proj_age_1 FROM yt_vri2011")
cnx_hbs<-getSpatialQuery("SELECT * FROM cnx_hbs")
cnx_hbs<-lwgeom::st_make_valid(cnx_hbs)

polys<- st_intersection(cnx_hbs, feats) #spatialy join the timber mark boundaries with the id that links the VRI
polys$area<-st_area(polys)/10000 #calc the area of the individual polygons within a timber mark


yt_prj<-getTableQuery("SELECT * FROM yt_vri2011prj ") #get the projections by featureid

#join with poly
out.tbl<-merge(polys, yt_prj)

out.tbl$vol<-out.tbl$area*out.tbl$itvol #calc the volumes for each of the individual polygons within a timber mark
#st_write(out.tbl, "test3.shp")

#get the itvols that are NULL == don't match with the meta-model
out.tbl2<-data.table(out.tbl)
units(out.tbl2$area) <- NULL

#figure out the distrubution of area with no matching
noMatchArea<-out.tbl2[is.na(itvol), sum(area), by =timber_mrk]
setnames(noMatchArea, "V1", "area")
totalArea<-out.tbl2[, sum(area), by =timber_mrk]
setnames(totalArea, "V1", "totarea")
percentNoMatch<-merge(noMatchArea, totalArea)
percentNoMatch$pernomatch<-percentNoMatch$area/percentNoMatch$totarea


#plot the distribution
eq <- substitute(italic(q25)== a*","~~italic(q75)== b ,list(a=as.numeric(quantile(percentNoMatch$pernomatch,0.25)), b= as.numeric(quantile(percentNoMatch$pernomatch,0.75))))
  
ggplot(data = data.table(per.Area.Missing=percentNoMatch$pernomatch), aes(x=per.Area.Missing)) +
  geom_histogram(bins =120)+
  geom_vline(xintercept=quantile(percentNoMatch$pernomatch,0.25))+
  geom_vline(xintercept=quantile(percentNoMatch$pernomatch,0.75))+
  geom_text(aes(x = 0.30, y =800 , label = as.character(as.expression(eq)) ), parse = TRUE) + 
  theme_bw()

```

The majority (75%) of timber marks with harvest units that do not have the neccessary VRI attribution contribute less than 3.3% of the total area. After visually checking, two issues arose: i) the spatial boundaries of these timber marks extend into non-forested area as reported by the VRI; and ii) there wasn't enough information to parameterize the growth and yield model (outside the domain of the inputs, e.g., recently disturbed). For the non-forested areas, these may be wrongfully classified given the accuracy and precision of the spatial boundaries determined in the VRI. From a practical view, these relatively small areas would result in little contribution to the total projected volume estimate. Thus, timber marks with less than or equal to 3 percent of their total area that contained inadequate VRI information were retained in the analysis.

Following the previous two steps, a total of 2140 timber marks remained in the analysis. 

```{r, sample, echo = FALSE, fig.cap = 'FIGURE 2. The location of timber marks used in the analysis (n = 2142).'}
noMatch2<-unique(percentNoMatch[pernomatch > 0.3, timber_mrk])
timbr_mrks<-out.tbl[!(out.tbl$timber_mrk %in% noMatch2),]

ggplot() +
  geom_sf(data = st_geometry(get_layer("bc_bound_hres")))+
  geom_sf(data =timbr_mrks, aes(fill=bec_zone_code), lwd =0)


```


## Growth and yield meta-model

Using the VRI (2018 vintage), each polygon was projected through time to 350 years using Variable Density Yield projection (VDYP). VDYP is a stand-level empirical growth and yield model that uses VRI attribution as inputs into its algortihums. The result of this process was a dataset with over 3.5 million yield curves which took 3 days to complete on a intel xeon, 3.5 ghz processor with 64 GB of RAM. Both the input (VRI information) and outputs (yields over time) were uploaded into a PostgreSQL database for further processing. Using the layer 1 rank information (the dominant layer),  yield curve groups (yc_grp) or anlaysis units were constructed using: BEC zone, site index (2 m interval), height class (5 classes as per the VRI) and crown closure class (5 classes as per the VRI). Each yc_grp was then aggregated by area weighting the respsective individual polygon level yield curves. The result was a provincial database of composite yield curves that directly link to the 2018 VRI through the layer 1 rank attribution described above.

## HBS volumes vs projected meta-model volumes

Each projected VRI polygon that intersected the timber mark boundary was summed to estimate the total projected volume for the timber mark.The HBS data was also aggregated by timber mark and matched with the projected volumes. The result is shown below that compares the projected volumes from the meta model with the observed volumes that were reported in the HBS.

```{r, echo = FALSE, Step6_develop_vri2011, fig.cap = 'FIGURE 3. The relationship between observed (obs_vol) and projected (proj_vol) volumes ($m^3$). The yellow line is a one to one relationship; the blue line is a linear line of best fit; the dashed red lines represent the 95% prediction interval.'}

timbr_mrks<-data.table(timbr_mrks)
timbr_mrks[is.na(vol), vol:=0]

out.tbl3<-timbr_mrks[, sum(vol), by =timber_mrk]
setnames(out.tbl3, c("V1", "timber_mrk"), c("proj_vol","timber_mark"))

hbs_obs<-getTableQuery("SELECT timber_mark, sum(volume_m3) as obs_vol FROM hbs_select_tmbr_mrk  where waste_type = 'Non-Waste' AND coast_interior = 'Interior' group by timber_mark")

calb_data<-data.table(merge(hbs_obs, out.tbl3))
calb_data$proj_vol<-as.numeric(calb_data$proj_vol)
model1 <- lm(obs_vol ~ proj_vol, data=calb_data)
summary(model1)
temp_var <- predict(model1, data =calb_data, interval="prediction")
calb_data2 <- cbind(calb_data, temp_var)

lm_eqn = function(m) {
  l <- list(a = format(as.numeric(coef(m)[1]), digits = 2),
      b = format(as.numeric(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3))
  eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2,l)
  as.character(as.expression(eq))                 
}

ggplot(calb_data2, aes(proj_vol, obs_vol)) +
  geom_point() +
  geom_smooth(method='lm', se = TRUE)+
  geom_line(aes(y=lwr), color = "red", linetype = "dashed")+
  geom_line(aes(y=upr), color = "red", linetype = "dashed") +
  geom_text(aes(x = 35000, y = 250000, label = lm_eqn(model1)), parse = TRUE) +
    geom_abline(intercept =0, slope=1, col ="yellow") +
  theme_bw()

```

## Predictors of error

Following Robinson et al. (2016) the error between observed and projected volume yields was paritioned according to both forest quality class (high and low) and timber type (mature or mixedwood). This supported the conditional mean and variance to be modelled seperately for each of these factors. In the BC application, timber marks were subsetted by bclcs_level_2?, and further stand-level attribution was included to test hypotheses of which variables could be important predictors of error between observed and projected yield volumes.

```{r, predictors}

# get the bec zone that makes up the majority of the timber mark 
pv_timber_mrk<-merge(timbr_mrks, totalArea)
pv_timber_mrk[,wt:=as.numeric(area/totarea)]
pv_timber_mrk2<-pv_timber_mrk[, lapply(.SD, function(x) {wtd.mean (x, wt)}), by =timber_mrk, .SDcols=c("proj_height_1", "site_index", "crown_closure", "proj_age_1")]
setnames(pv_timber_mrk2, "timber_mrk" , "timber_mark" )
calb_data3<-merge(calb_data2, pv_timber_mrk2, by = "timber_mark")
calb_data3[, dif:=proj_vol-obs_vol]

cor.test(calb_data3$proj_height_1, calb_data3$dif)
cor.test(calb_data3$site_index, calb_data3$dif)
cor.test(calb_data3$crown_closure, calb_data3$dif)
cor.test(calb_data3$proj_age_1, calb_data3$dif)

#Site index and crown closure have larger cor than height and age.

```


## The calibration model

In Robinson et al. (2016) a double gamma model was used to model both the conditional mean and variance of the error distribution. Gamma models are advantageous because they are highly flexible in the positive domain and allow the variance to scale with parameters. Below we try a few gamma models by incorporating site index and crown closure but land on using site index because crown closure may change with time which makes its harder to interpret. This area could be greatly improved to try other distributions (e.g., Exponential, Beta) or other parameters (e.g., variance of stand attributes, BEC zones?, etc) 

```{r, calibrate_model,  fig.cap= 'FIGURE 4. The calibration model with low site index (A) and high site index (B). Blue line is the conditional mean, blue dotted lines are the 66% prediction intervals and the red dashed lines are the 90% prediction intervals' }
library(gamlss)
library(cowplot)
## Fit and compare some models
test.0 <- gamlss(obs_vol ~ proj_vol,
                 sigma.formula = ~ 1,
                 sigma.link = "log",
                 family = GA(),
                 data = calb_data3)

test.1 <- gamlss(obs_vol ~ proj_vol,
                 sigma.formula = ~ proj_vol,
                 sigma.link = "log",
                 family = GA(),
                 data = calb_data3)

test.3 <- gamlss(obs_vol ~ log(proj_vol),
                 sigma.formula = ~ 1,
                 sigma.link = "log",
                 family = GA(),
                 data = calb_data3)

test.4 <- gamlss(obs_vol ~ log(proj_vol),
                 sigma.formula = ~ log(proj_vol),
                 sigma.link = "log",
                 family = GA(),
                 data = calb_data3)

test.5 <- gamlss(obs_vol ~ log(proj_vol)+ log(site_index),
                 sigma.formula = ~ log(proj_vol),
                 sigma.link = "log",
                 family = GA(),
                 data = calb_data3)

test.6 <- gamlss(obs_vol ~ log(proj_vol) + log(site_index),
                 sigma.formula = ~ log(proj_vol) + log(crown_closure),
                 sigma.link = "log",
                 family = GA(),
                 data = calb_data3)
LR.test(test.5, test.6)
summary(test.5)

trajectory.l <-
  with(calb_data3,
       expand.grid(proj_vol =
                   seq(from = min(proj_vol),
                       to = max(proj_vol),
                       length.out = 100),
                   site_index = min(site_index),
                   crown_closure = mean(crown_closure)
                   ))

new.dist.l <- predictAll(test.5, newdata = trajectory.l)

trajectory.l$mu <- new.dist.l$mu
trajectory.l$sigma <- new.dist.l$sigma
trajectory.l$upper.2 <- with(new.dist.l, qGA(0.95, mu = mu, sigma = sigma))
trajectory.l$lower.2 <- with(new.dist.l, qGA(0.05, mu = mu, sigma = sigma))
trajectory.l$upper.1 <- with(new.dist.l, qGA(0.67, mu = mu, sigma = sigma))
trajectory.l$lower.1 <- with(new.dist.l, qGA(0.33, mu = mu, sigma = sigma))

trajectory.h <-
  with(calb_data3,
       expand.grid(proj_vol =
                   seq(from = min(proj_vol),
                       to = max(proj_vol),
                       length.out = 100),
                   site_index = max(site_index),
                   crown_closure = mean(crown_closure)
                   ))

new.dist.h <- predictAll(test.5, newdata = trajectory.h)

trajectory.h$mu <- new.dist.h$mu
trajectory.h$sigma <- new.dist.h$sigma
trajectory.h$upper.2 <- with(new.dist.h, qGA(0.95, mu = mu, sigma = sigma))
trajectory.h$lower.2 <- with(new.dist.h, qGA(0.05, mu = mu, sigma = sigma))
trajectory.h$upper.1 <- with(new.dist.h, qGA(0.67, mu = mu, sigma = sigma))
trajectory.h$lower.1 <- with(new.dist.h, qGA(0.33, mu = mu, sigma = sigma))

p.l <-
  ggplot(calb_data3, aes(x = proj_vol, y = obs_vol) ) +
  geom_point(alpha=0.4) +
  #facet_wrap(~ ForestQualityClass) +
  xlab(expression(paste("Projected Volume Yield ", m^3, ")"))) +
  ylab(expression(paste("Observed Volume Yield ", m^3, ")"))) +
  geom_line(aes(y = mu, x = proj_vol), color = 'blue', data = trajectory.l) +
  geom_line(aes(y = lower.2, x =  proj_vol), linetype = "dashed", color = 'red', data = trajectory.l) +
  geom_line(aes(y = upper.2 , x =  proj_vol), linetype = "dashed", color = 'red', data = trajectory.l) +
  geom_line(aes(y = lower.1 , x =  proj_vol), linetype = "dotted", color = 'blue', data = trajectory.l) +
  geom_line(aes(y = upper.1 , x =  proj_vol), linetype = "dotted", color = 'blue', data = trajectory.l)

p.h <-
  ggplot(calb_data3, aes(x = proj_vol, y = obs_vol) ) +
  geom_point(alpha=0.4) +
  #facet_wrap(~ ForestQualityClass) +
  xlab(expression(paste("Projected Volume Yield ", m^3, ")"))) +
  ylab(expression(paste("Observed Volume Yield ", m^3, ")"))) +
  geom_line(aes(y = mu, x = proj_vol), color = 'blue', data = trajectory.h) +
  geom_line(aes(y = lower.2, x =  proj_vol), linetype = "dashed", color = 'red', data = trajectory.h) +
  geom_line(aes(y = upper.2 , x =  proj_vol), linetype = "dashed", color = 'red', data = trajectory.h) +
  geom_line(aes(y = lower.1 , x =  proj_vol), linetype = "dotted", color = 'blue', data = trajectory.h) +
  geom_line(aes(y = upper.1 , x =  proj_vol), linetype = "dotted", color = 'blue', data = trajectory.h)


plot_grid(p.l, p.h, labels = "AUTO")
```

Thus, a timber mark with a small site index results in a upward calibration - meaning for a given projected yield the observed volume will on average be greater but this also comes with greater uncertainty. Where as, a timber mark with a large site index, will result in a downward calibration or reducing the projected volumes but will result in less uncertainty.  

## Exercises

To demonstrate use of the calibration model we implemented a yield calibration module in [forestrycLUS](https://github.com/bcgov/clus/tree/master/R/SpaDES-modules/forestryCLUS). 

# References

Robinson, A.P., McLarin, M. and Moss, I., 2016. A simple way to incorporate uncertainty and risk into forest harvest scheduling. Forest Ecology and Management, 359, pp.11-18.
