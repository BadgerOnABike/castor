---
title: "fireCastor"
author: ""
date: "26 June 2023"
output: pdf_document
---

# Overview

This module takes the output from a series of *Castor* disturbance modules and estimates the probability that a fire will start (ignite), the probability that a fire will escape (grow bigger than 1ha), and the probability that a fire will spread from one pixel to the next. Once these probability rasters are created then fires are randomly started on the landscape and the escape and spread is simulated. This process is repeated many time. Then the number of times a particluar pixel is burned at one time step tells us how likely it is that that location will burn. For each itteration the total area burned and amount of wood volume lost is calculated. 

# Usage
The module needs *dataCastor*, *roadCastor* and *blockingCastor* to run.

```{r module_usage}
library (SpaDES.core)
library (data.table)
library (dplyr)
source (here::here("R/functions/R_Postgres.R"))

Sys.setenv(JAVA_HOME='C:\\Program Files\\Java\\jdk-14.0.1')

moduleDir <- paste0(here::here(),"/R/SpaDES-modules")
outputDir <- paste0(here::here(),"/R/SpaDES-modules/disturbanceCastor")

times <- list(start = 0, end = 100)

parameters <- list(
  .progress = list(type = NA, interval = NA),
  .globals = list(),
  dataCastor = list(saveCastorDB = TRUE,
                     randomLandscapeZoneNumber = 1,
                     randomLandscape = list(100,100,0, 100, 0, 100),
                     randomLandscapeZoneConstraint = data.table(zoneid = 1,  variable = 'age', threshold = 140, type = 'ge', percentage = 0)
                     ),
  blockingCastor = list (blockMethod = 'none'
                         ),
  growingStockCastor = list(periodLength = 5, maxYieldAge = 1000),
  roadCastor = list (roadMethod = 'mst'
                     ),
  fireCastor = list (calculateInterval =  1, 
                            #criticalHabitatTable = "vat.vat_bc_crithab_and_herd",
                            #criticalHabRaster = "rast.bc_crithab_and_herd",
                            #permDisturbanceRaster = "rast.mine_ag_wind_rail",
                            recovery = 300)
)

modules <- list ("dataCastor", "blockingCastor", "roadCastor", "growingStockCastor", "disturbanceCastor")
disturbanceFlow<- data.table(compartment ="all",
                                     partition = ' treed = 1 ',
                                     mean = 1.75,
                                     sd = 2.47,
                                     period = rep(seq(from = 1, to=500, by = 1),1), 
                                     flow = 1000)
objects <- list (scenario = data.table (name = "test", description = "test"), disturbanceFlow=disturbanceFlow) #omit the disturbanceFlow object to remove disturbance processes

paths <- list(
  modulePath = moduleDir,
  outputPath = outputDir
)

mySim <- simInit(times = times, params = parameters, modules = modules,
                 objects = objects, paths = paths)
outputs(mySim) <- data.frame (objectName = c("disturbanceProcessReport"))

mysimout<-spades(mySim,debug=TRUE) 


```

## plot fires
```{r, fire_plot}
userdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/SpaDES-modules/disturbanceCastor/test_castordb.sqlite") ) 
 ras.info<-dbGetQuery(userdb, "Select * from raster_info limit 1;")
ras<-raster(extent(ras.info$xmin, ras.info$xmax, ras.info$ymin, ras.info$ymax), nrow = ras.info$nrow, ncol = ras.info$ncell/ras.info$nrow, vals =0, crs = 3005)
ras[]<-dbGetQuery(userdb, "select age from pixels order by pixelid")$age
plot(ras)
dbDisconnect(userdb)
```

# Links to other modules

The module requires dataCastor, roadCastor, blockingCastor to work.

