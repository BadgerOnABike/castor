---
title: "extract_Dem_climate_veg_data_for_map"
author: "Elizabeth Kleynhans"
date: '2022-09-09'
output: html_document
---

## Description

This script generates a data.table that has for each pixel of the province the elevation, slope, aspect, distance to infrastructure, wind in summer and wind in winter. These variables do not change in time (or at least for the purpose of my model I am not changing them). thus with these variables i estimate the constant part of my logisitic equation and create four rasters one lighting ignition, human initions, fire escape and fire spread.  Each raster holds the value of the coefficients that are constant through out time. for example for lightining ignitions a raster is created at the bottom of this file that has the intercept + b1 * elevation or what ever the equation is for each fire regime type. For human caused fires the raster contains the value of 
intercept + b1*elevation + b1*distance to infrastructure or what ever the equation is for that fire regime type. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#source(here::here("R/functions/R_Postgres.R"))
library(data.table)
#library(sf)
#library(tidyverse)
#library(rgeos)
#library(rpostgis)
#library(keyring)
#library(raster)
#library(rgdal)


```

#import FRT and change it to a raster for faster extraction

```{r}

 
#Create a provincial raster
prov.rast <- raster::raster ( # standardized provincial raster with no data in it
                              nrows = 15744, ncols = 17216,
                              xmn = 159587.5, xmx = 1881187.5,
                              ymn = 173787.5, ymx = 1748187.5,
                              crs = "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs",
                              resolution = c(100, 100),
                              vals = 0)

   
    pts <- data.table(terra::xyFromCell(prov.rast,1:ncell(prov.rast))) #Seems to be faster than rasterTopoints
    pts <- pts[, pixelid:= seq_len(.N)] # add in the pixelid which streams data in according to the cell number = pixelid
    
    pixels <- data.table(V1 = as.integer(prov.rast[]))
    pixels[, pixelid := seq_len(.N)]
    
    pixels<-merge(pixels, pts)
    setorder(pixels, "pixelid")#sort the pixels table so that pixelid is in order.
  

  #   prov.rast[]<-pixels$pixelid
  #   #sim$rasVelo<-velox::velox(sim$ras)
  #   
  #   #Add the raster_info
  #   ras.extent<-terra::ext(prov.rast)
  #   #TODO: Hard coded for epsg 3005 need to convert to terra?
  #   dbExecute(castordb, glue::glue("INSERT INTO raster_info (name, xmin, xmax, ymin, ymax, ncell, nrow, crs) values ('prov.rast', {ras.extent[1]}, {ras.extent[2]}, {ras.extent[3]}, {ras.extent[4]}, {ncell(prov.rast)}, {nrow(prov.rast)}, '3005');"))
  #   
  # 
   aoi<-terra::ext(prov.rast) #need to check that each of the extents are the same
  # 
  # dbGetQuery(castordb, "Select * from raster_info")
  
```

# Get FRT, dem, slope, aspect, distancet to infra ####

```{r}
#---------------------#
  #Get the FRT----
  #---------------------#

ras.frt<-terra::rast("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\rast_frt_bc.tif")

 # frt<-getSpatialQuery("SELECT * FROM frt_canada")
 # ras.frt <- fasterize::fasterize (frt, prov.rast, field = "Cluster")
 # 
    if(aoi == terra::ext(ras.frt)){ # need to check that each of the extents are the same
      pixels<-cbind(pixels, data.table(frt= as.numeric(ras.frt[])))
      rm(ras.frt)
      gc()
    }else{
      stop(paste0("ERROR: extents are not the same check -"))
    }

  #---------------------#
  #Get the elevation----
  #---------------------#
DEM <- terra::rast("C:\\Work\\caribou\\castor_data\\Dem_bc_ha\\dem_ha_bc.tif")
 
if(aoi == terra::ext(DEM)){#need to check that each of the extents are the same
      pixels <- cbind(pixels, data.table(dem = as.integer(DEM[]))) # add the ownership to the pixels table
      rm(DEM)
      gc()
    }else{
      stop(paste0("ERROR: extents are not the same check -"))
    }

# slope
DEM_slope <- terra::rast("T:\\FOR\\VIC\\HTS\\ANA\\PROJECTS\\CASTOR\\Data\\dem\\all_bc\\slope_ha_bc_3005.tif")
# try to fill in NA values using nearest neighbour values

if(aoi == terra::ext(DEM_slope)){#need to check that each of the extents are the same
      pixels <- cbind(pixels, data.table(slope = as.integer(DEM_slope[]))) # add the ownership to the pixels table
      rm(DEM_slope)
      gc()
    }else{
      stop(paste0("ERROR: extents are not the same check -"))
    }

#Aspect
DEM_aspect <- terra::rast("T:\\FOR\\VIC\\HTS\\ANA\\PROJECTS\\CASTOR\\Data\\dem\\all_bc\\aspect_ha_bc_3005.tif")

if(aoi == terra::ext(DEM_aspect)){#need to check that each of the extents are the same
      pixels <- cbind(pixels, data.table(aspect = as.integer(DEM_aspect[]))) # add the ownership to the pixels table
      rm(DEM_aspect)
      gc()
    }else{
      stop(paste0("ERROR: extents are not the same check -"))
    }


# dist infrastructure
# first calculate the minimum distance to infrastructure. Then save that raster and upload it to the database. Then use that.

dist_rail<- terra::rast("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\dist_rail.tif")
dist_power<- terra::rast("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\dist_power.tif")
dist_oil<- terra::rast("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\dist_oil.tif")
dist_mines<- terra::rast("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\dist_mines.tif")
dist_urban<- terra::rast("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\dist_urban.tif")

 inf.rast.function<- function(x, y) {
  ifelse(x < y, x, y)
 }
 
 dist.inf<-lapp(c(dist_rail, dist_power), inf.rast.function)
 dist.inf<-lapp(c(dist.inf, dist_oil), inf.rast.function)
 dist.inf<-lapp(c(dist.inf, dist_mines), inf.rast.function)
 dist.inf<-lapp(c(dist.inf, dist_urban), inf.rast.function)

plot(dist.inf)

if(aoi == terra::ext(dist.inf)){#need to check that each of the extents are the same
      pixels <- cbind(pixels, data.table(distinfrastructure = as.integer(dist.inf[]))) # add the ownership to the pixels table
      rm(dist.inf)
      gc()
    }else{
      stop(paste0("ERROR: extents are not the same check -"))
    }

rm(dist_rail, dist_power, dist_oil, dist_mines, dist_urban)
gc()

# summer wind
# wind_summer<-raster("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\rast_summer_wind.tif")
# x_wind <- focal(wind_summer, w, mean, na.rm=TRUE, NAonly=TRUE, pad=TRUE)
#  
# plot(x_wind)
# wind_summer<-x_wind
# 
# 
# 
# if(aoi == terra::ext(wind_summer)){#need to check that each of the extents are the same
#       pixels <- cbind(pixels, data.table(summerwind = as.integer(wind_summer[]))) # add the ownership to the pixels table
#       rm(wind_summer)
#       gc()
#     }else{
#       stop(paste0("ERROR: extents are not the same check -"))
#     }
# 
# # spring wind
# 
# wind_spring<- raster("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\rast_spring_wind.tif")
# x_wind <- focal(wind_spring, w, mean, na.rm=TRUE, NAonly=TRUE, pad=TRUE)
#  
# plot(x_wind)
# wind_spring<-x_wind
# 
# 
# if(aoi == terra::ext(wind_spring)){#need to check that each of the extents are the same
#       pixels <- cbind(pixels, data.table(springwind = as.integer(wind_spring[]))) # add the ownership to the pixels table
#       rm(wind_spring)
#       gc()
#     }else{
#       stop(paste0("ERROR: extents are not the same check -"))
#     }

head(pixels)

dat<-pixels

```


#Plot to test it worked
Try plotting some of the layers to check them and to see where the NA's are. Looks like data for vancouver island and Haida Gwaii are missing for dem, slope and aspect. Otherwise the data looks ok. 
```{r}

setorder(pixels, cols = "pixelid")

prov.rast <- raster::raster ( # standardized provincial raster with no data in it
                              nrows = 15744, ncols = 17216,
                              xmn = 159587.5, xmx = 1881187.5,
                              ymn = 173787.5, ymx = 1748187.5,
                              crs = "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs",
                              resolution = c(100, 100),
                              vals = 0)
        
prov.rast[]<-pixels$dem



plot(prov.rast)

```

# Aspect to N,S,O
```{r}
#Change Aspect to N,S, and O


pixels[, aspect_cardinal:="O"]
pixels[aspect>315, aspect_cardinal:="N"]
pixels[aspect<=45, aspect_cardinal:="N"]
pixels[aspect>45 & aspect<=135, aspect_cardinal:="O"]
pixels[aspect>135 & aspect<=225, aspect_cardinal:="S"]
pixels[aspect>225 & aspect<=315, aspect_cardinal:="O"]

pixels[!is.na(dem) & is.na(slope), slope:=0]
pixels[is.na(slope), slope:=0]

pixels[!is.na(aspect_cardinal),]

# create dummy variables for aspect
pixels[, aspect_N:=0]
pixels[aspect_cardinal == "N", aspect_N:=1]
pixels[,aspect_O:=0]
pixels[aspect_cardinal == "O", aspect_O:=1]
pixels[, aspect_S:=0]
pixels[aspect_cardinal == "S", aspect_S:=1]

pixels[!is.na(frt),]

rm(aoi, dat, frt, prov.rast, pts)
gc()

```

for na values I guess the best is to make them the mean value or the median value than just an NA. I want to keep as much information as I can. 

##FRT 5
```{r}
frt5<-pixels[frt %in% c(5,7),]

##########################
# probability of escape

model_coef_table_escape<-read.csv("C:\\Work\\caribou\\castor\\R\\fire_sim\\Analysis_results\\BC\\Coefficient_tables\\top_mod_table_frt5_escape.csv")

model_coef_table_escape

frt5$logit_P_escape_coef<- model_coef_table_escape$intercept +  
  model_coef_table_escape$coef_dist_infra*frt5$distinfrastructure
  
rm(model_coef_table_escape)
gc()

```


## FRT10
```{r}
frt10<- pixels[frt==10,]

#################################
# escape
model_coef_table_escape<-read.csv("C:\\Work\\caribou\\castor\\R\\fire_sim\\Analysis_results\\BC\\Coefficient_tables\\top_mod_table_frt10_escape.csv")

model_coef_table_escape

frt10$logit_P_escape_coef<- model_coef_table_escape$intercept


# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
rm(model_coef_table_escape)
gc()

```


## FRT 11 

```{r}
frt11<- pixels[frt %in% c(9,11),]

################################
# Escape

model_coef_table<-read.csv("C:\\Work\\caribou\\castor\\R\\fire_sim\\Analysis_results\\BC\\Coefficient_tables\\top_mod_table_frt11_escape.csv")

model_coef_table

frt11$logit_P_escape_coef<- model_coef_table$intercept + 
  model_coef_table$coef_slope * frt11$slope +  
  model_coef_table$coef_dist_infra * frt11$distinfrastructure

rm(model_coef_table)
gc()

```

## FRT 12

```{r}
frt12<- pixels[frt==12,]


##################################
#escape
model_coef_table<-read.csv("C:\\Work\\caribou\\castor\\R\\fire_sim\\Analysis_results\\BC\\Coefficient_tables\\top_mod_table_frt12_escape.csv")

model_coef_table

frt12$logit_P_escape_coef<- model_coef_table$intercept +
  model_coef_table$coef_elevation*frt12$dem + 
  model_coef_table$coef_log_infr  * log(frt12$distinfrastructure+1)


rm(model_coef_table)
gc()

```

## FRT13
```{r}
frt13<- pixels[frt==13,]

################################
#escape

model_coef_table<-read.csv("C:\\Work\\caribou\\castor\\R\\fire_sim\\Analysis_results\\BC\\Coefficient_tables\\top_mod_table_frt13_escape.csv")
model_coef_table

frt13$logit_P_escape_coef<- model_coef_table$intercept + 
  model_coef_table$coef_elevation*frt13$dem + 
  model_coef_table$coef_slope*frt13$slope +
  model_coef_table$coef_aspect_S + frt13$aspect_S +
  model_coef_table$coef_aspect_O + frt13$aspect_O +
  model_coef_table$coef_log_infr * log(frt13$distinfrastructure+1) 


rm(model_coef_table)
gc()

```

#FRT 14
```{r}
frt14<- pixels[frt==14,]


##############################
#escape  

model_coef_table<-read.csv("C:\\Work\\caribou\\castor\\R\\fire_sim\\Analysis_results\\BC\\Coefficient_tables\\top_mod_table_frt14_escape.csv")
model_coef_table

frt14$logit_P_escape_coef<- model_coef_table$intercept + 
  model_coef_table$coef_elevation*frt14$dem +
  model_coef_table$coef_log_infr *log(frt14$distinfrastructure+1)


gc()
```

## FRT15
```{r}
frt15<- pixels[frt==15,]


################################
# escape

model_coef_table<-read.csv("C:\\Work\\caribou\\castor\\R\\fire_sim\\Analysis_results\\BC\\Coefficient_tables\\top_mod_table_frt15_escape.csv")
model_coef_table

frt15$logit_P_escape_coef<- model_coef_table$intercept +
  model_coef_table$coef_aspect_S*frt15$aspect_S +
  model_coef_table$coef_aspect_O*frt15$aspect_O +
  model_coef_table$coef_log_infr  *log(frt15$distinfrastructure+1)

#################################
# spread

# model_coef_table<-read.csv("C:\\Work\\caribou\\castor\\R\\fire_sim\\Analysis_results\\BC\\Coefficient_tables\\top_mod_table_frt15_spread.csv")
# model_coef_table
# 
# # put coefficients into model formula
# #logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
# logit_P_spread<- model_coef_table$intercept + 
#   model_coef_table$coef_slope*frt15$slope +
#   model_coef_table$coef_aspect_N*frt15$aspect_N +
#   model_coef_table$coef_aspect_S*frt15$aspect_S +
#   model_coef_table$coef_aspect_W*frt15$aspect_W +
#   ((model_coef_table$coef_aspect_N + model_coef_table$coef_aspect_S)/2)*frt15$aspect_flat +
#   model_coef_table$coef_log_dist_infra*log(frt15$distinfrastructure+1) +
#   model_coef_table$coef_wind_summer*frt15$summerwind
# 
# logit_P_spread
# frt15$logit_P_spread_coef<-logit_P_spread
# 
# 
rm(model_coef_table)

gc()

```

# now join all the frt's back together. 
```{r}

frt_all <- rbindlist(list(frt5,frt10, frt11, frt12, frt13, frt14, frt15))

dim(frt_all)

frt_all<-frt_all[,c("pixelid","frt", "logit_P_escape_coef")]

unique(frt_all$frt)
 

names(frt_all)
names(pixels)

rm(frt5, frt7, frt9, frt10, frt11, frt12, frt13, frt14, frt15)
gc()
```

# remake pixels table
```{r}
prov.rast <- raster::raster ( # standardized provincial raster with no data in it
                              nrows = 15744, ncols = 17216,
                              xmn = 159587.5, xmx = 1881187.5,
                              ymn = 173787.5, ymx = 1748187.5,
                              crs = "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs",
                              resolution = c(100, 100),
                              vals = 0)

   
    pts <- data.table(terra::xyFromCell(prov.rast,1:ncell(prov.rast))) #Seems to be faster than rasterTopoints
    pts <- pts[, pixelid:= seq_len(.N)] # add in the pixelid which streams data in according to the cell number = pixelid
    
    pixels1 <- data.table(V1 = as.integer(prov.rast[]))
    pixels1[, pixelid := seq_len(.N)]
    
    pixels1<-left_join(pixels1, pts)
    setorder(pixels1, "pixelid")#sort the pixels table so that pixelid is in order.

const_coef_data<- merge(pixels1, frt_all, all.x=TRUE)
dim(const_coef_data)

setorder(const_coef_data, cols = "pixelid")
```


```{r}
#     prov.rast[]<-const_coef_data$logit_P_lightning_coef_const
#     plot(prov.rast)
#     
# # upload const_coef_lighting_raster to postgres
#     
#  writeRaster(prov.rast, file=" C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\rast_const_coef_lighting.tif", format="GTiff", overwrite=TRUE)
# # 
# # # run this in R:
#  paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', 'C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/rast_const_coef_lighting.tif -t 100x100 rast.const_coef_lightning_ignit | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus')
# # then copy the output thats between the " " from the above and paste it into the cmd and run that... should show Insert 0  1 lots of times.
# 
# #############################
#  #constant coeffieitn values for human caused ignitions
#  
# prov.rast[]<-const_coef_data$logit_P_person_coef_const
#  plot(prov.rast)
#     
# # upload const_coef_lighting_raster to postgres
#     
#  writeRaster(prov.rast, file=" C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\rast_const_coef_person.tif", format="GTiff", overwrite=TRUE)
# # # run this in R:
#  paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', 'C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/rast_const_coef_person.tif -t 100x100 rast.const_coef_person_ignit | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus')
# # then copy the output thats between the " " from the above and paste it into the cmd and run that... should show Insert 0  1 lots of times.

 
#############################
 #constant coeffieitn values for escaped fires
 
prov.rast[]<-const_coef_data$logit_P_escape_coef
 plot(prov.rast)
 
 prov.rast<-terra::rast(prov.rast)
    
# upload const_coef_lighting_raster to postgres
    
 terra::writeRaster(prov.rast, file=" C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\rast_const_coef_escaped_new.tif")
# # run this in R:
 paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', 'C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/rast_const_coef_escaped_new.tif -t 100x100 rast.const_coef_escaped_fires | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus')
# then copy the output thats between the " " from the above and paste it into the cmd and run that... should show Insert 0  1 lots of times.

 
#############################
 #constant coeffieitn values for spreading fires
 
# prov.rast[]<-const_coef_data$logit_P_spread_coef_const
#     
# # upload const_coef_lighting_raster to postgres
#     
#  writeRaster(prov.rast, file=" C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\rast_const_coef_spread.tif", format="GTiff", overwrite=TRUE)
# # # run this in R:
#  paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', 'C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/rast_const_coef_spread.tif -t 100x100 rast.const_coef_spread_fires | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/castor')
# # then copy the output thats between the " " from the above and paste it into the cmd and run that... should show Insert 0  1 lots of times.
# 
#  
    
```

