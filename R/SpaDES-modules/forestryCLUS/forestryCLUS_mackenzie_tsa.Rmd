---
title: "forestryCLUS"
author: ""
date: "08 April 2019"
output:
  html_document: 
    keep_md: yes
---

<!--
Copyright 2020 Province of British Columbia
 
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
 
http://www.apache.org/licenses/LICENSE-2.0
 
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.-->

# Overview

This module provides the logic for simulating forestry decisions on the landscape. These decisions currently involve spatializing the harvest flow objectives which include: where, when and how much to harvest. These factors help determine policies related to harvest flows, opening size, seral distrubitions, road densitites, preservation areas, silvicultural systems, etc. More sophistication to these decisions would involve looking at the costs and benefits beyond the current time period; this requires optimization or improved heuristics -- which may be considered in the future. The general overview of forestryCLUS follows.

At each time step, harvest units (pixels or blocks) are ranked according to a priority (e.g., oldest first), this constructs a queue. This queue of harvest units are then subject to various constraints meant to meet objectives for the study area. Harvest units are harvested until either a constraint is binding, the queue is exhausted or the harvest flow is met. Next, the age of the forest is advanced to the next time period and the process is repeated. 

During the simulation various reports and information surrounding each pixel can be saved/recorded or used in a summary. Note these outputs are considered expected future outcomes given the inputs developed by the anlayst.For a historical selection of harvesting activities see [cutblockSeqPrepCLUS](https://github.com/bcgov/clus/tree/master/R/SpaDES-modules/cutblockSeqPrepCLUS). Both  cutblockSeqPrepCLUS and forestryCLUS build a list of landing locations through simulation time. One is historical while the other is one possible future realization.

# Usage
This module could be a parent module?? It relies on: 
1. dataloadCLUS (set up the clusdb) 
2. blockingCLUS (preforms the pixel aggregation into harvest units)
3. growingStockCLUS (increments the age and volume in pixels)
4. (Optionally) rsfCLUS (track resource selection functions)
5. (Optionally) roadCLUS (preforms the access to the harvest units)
6. uploaderCLUS (uploades the outputs to a shiny app)


# Mackenzie TSA Scenarios
business as usual (BAU); no new constraints, caribou or otherwise; establishes the current 'baseline' or benchmark to evaluate the potential impact of 'new' actions in caribou habitat

no harvest in Central Group caribou critical habtiat; to support Central groups  planning, we run a sceanrio with no harvest in the  Central Group HEWSR, LEWSR and Matrix; harvest is BAU in other herds; assesses the potential maximum impact of protecting Central groups only, assuming other herds unprotected

"ECCC" in Central groups caribou critical habtiat; an alternative to a no harvest scenario, attemps to interpret the federal recovery strategy that stipulates no disturbance in high and low elevation critical habitat, and up to 35% disturbance in matrix habtiat; this is a possible scenario if Canada were to enact an emergency order on Central group only

Partnership Agreement Scenario; BC, West Moberly First Nation, Saulteau First Nation and Canada have an agreement to protect certain areas in the central group; No harvest in Central group partnership agreement areas A2, B2, and B3, maximum 35%  disturbance (15%) harvest in  Central group partnership agreement areas A1, B1, B4 and B5.

No harvest in all Partnership Agreement areas; this scenario assesses the potential maximum impact of protecting all the partnership agreement areas, assuming other herds unprotected

no harvest in southern mountain caribou critical habtait areas; where there is cirtical habitat, no harvest in any types (including matrix); establishes the 'maximum impact' that protection of caribou critical habitat might potentially have on forest harvest; in Mackenzie TSA these include: Kennedy Siding HEWSR, Kennedy Siding HESR, Kennedy Siding HEWR, Kennedy Siding LEWR, Kennedy Siding Matrix, Moberly HEWR, Moberly HEWSR, Moberly HESR, Moberly Matrix, Graham HESR, Graham HEWSR, Graham Matrix

'ECCC' in caribou critical habtait areas; an alternative to a no harvest scenario, attemps to interpret the federal recovery strategy that stipulates no disturbance in high and low eleavtion cirtcial habitat, and up to 35% disturabnce in matrix habtiat; this is a possible scenario if Canada were to enact an emergency order; assumes all herds protected

no harvest in southern moutnain caribou herd areas; where there is southern moutnain herd boundaries, no harvest; establishes the 'maximum impact' that protection of caribou habitat might potentially have on forest harvest; in Mackenzie TSA these include: Kennedy Siding, Kennedy Siding HESR, Kennedy Siding HEWR, Kennedy Siding LEWR, Kennedy Siding Matrix, Moberly HEWR, Moberly HEWSR, Moberly HESR, Moberly Matrix, Graham HESR, Graham HEWSR, Graham Matrix, Wolverine Herd, Scott Herd, Chase Herd

no harvest in Wolverine/Chaase/Takla herds; to support Central groups  planning, we run a sceanrio with no harvest in the herd boundaries (currently no critical habitat for these herds)


# Mackenzie SW TSA Scenarios
business as usual (BAU); no new constraints, caribou or otherwise; establishes the current 'baseline' or benchmark to evaluate the potential impact of 'new' actions in caribou habitat

no harvest in Wolverine/Chaase/Takla herds; to support Central groups  planning, we run a sceanrio with no harvest in the herd boundaries (currently no critical habitat for these herds)
 
 no harvest in southern moutnain caribou herd areas; where there is southern moutnain herd boundaries, no harvest; establishes the 'maximum impact' that protection of caribou habitat might potentially have on forest harvest; in Mackenzie SW TSA these include: Scott Herd, Wolverine Herd

DU7 (Northern group) specific scenarios developed by caribou recovery science team. These were done for each groups of herds that overlaps the TSA. For Morice TSA, this included Tweedsmuir (group 1).

First set of scenarios uses rast.zone_du7_scenario_20210305; this raster defines priority forest stands for 'protection', i.e., old or close to old stands, plus a 500m buffer. Scenarios:
* 3a = No harvest in old forest, recruitment forest and buffered high elevation core and low elevation summer critical habitat areas, as defined by Bevan Ernst, maximum 15% disturbance (unbuffered) in low elevation winter and matrix habitat areas

# MacKenzie TSA Parameters 
## Constraints for Main Portion of TSA
BAU = beo, vqo, wha, uwr, fsw (fisheries senstive watersheds), parks and protected areas (nharv) and cw (community watersheds) 

In addtion to BAU (above):

No harvest in Central Group = "rast.zone_cond_noharvest_kennedy_siding_crithab_or_herd",
                               rast.zone_cond_noharvest_moberly_crithab_or_herd"

ECCC Central Group = "rast.zone_cond_eccc_kennedy_siding_crithab_or_herd",
                     "rast.zone_cond_eccc_moberly_crithab_or_herd"

Parntership Agreement = rast.zone_cond_partnership_agreement

Parntership Agreement - ho harvest = rast.zone_cond_partnership_agreement (but change constraint to no harvest 'nh')   

No harvest in southern mountain critical habitat = "rast.zone_cond_noharvest_moberly_crithab_or_herd",
                                                    "rast.zone_cond_noharvest_kennedy_siding_crithab_or_herd",
                                                    "rast.zone_cond_noharvest_graham_crithab_or_herd",
                              
ECCC in southern mountain critical habitat = "rast.zone_cond_eccc_kennedy_siding_crithab_or_herd",
                                            "rast.zone_cond_eccc_moberly_crithab_or_herd",
                                            "rast.zone_cond_eccc_graham_crithab_or_herd",

No harvest in southern mountain herds =  "rast.zone_cond_noharvest_moberly_crithab_or_herd",
                                         "rast.zone_cond_noharvest_wolverine_crithab_or_herd",
                                          "rast.zone_cond_noharvest_chase_crithab_or_herd",
                                          "rast.zone_cond_noharvest_kennedy_siding_crithab_or_herd",
                                          "rast.zone_cond_noharvest_graham_crithab_or_herd"

No harvest in Wolverine/Chase/Takla mountain herds =  "rast.zone_cond_noharvest_wolverine_crithab_or_herd",
                                                      "rast.zone_cond_noharvest_chase_crithab_or_herd"

DU7 - Northern group priority forest stand areas = "rast.zone_du7_scenario_20210305"

BAU plus the new B2 and B3 areas (new Klinse-za/Twin Sisters Park) of the caribou partnership agreement areas as protected areas (rast.central_grp_proposed_luo zones 1 and 2 = no harvest)

## Constraints for SW Portion of TSA
BAU = beo, vqo, wha, uwr, fsw (fisheries senstive watersheds), parks and protected areas (nharv) and cw (community watersheds) 

In addtion to BAU (above):

No harvest in Wolverine/Chase/Takla mountain herds =  "rast.zone_cond_noharvest_wolverine_crithab_or_herd"

No harvest in southern mountain herds =  "rast.zone_cond_noharvest_wolverine_crithab_or_herd",
                                          "rast.zone_cond_noharvest_scott_crithab_or_herd"
                                          

```{r, zone_update}
#STEP 1: Connect to the clusdb.sqlite database for the AOI
clusdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/MacKenzie_TSA_clusdb.sqlite")) # MacKenzie_SW_TSA_clusdb.sqlite     Mackenzie_TSA_clusdb.sqlite
#STEP 2: View the constraints available to a zone
zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneconstraints where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab'")


# Central Group - Draft Land Use Orders - April 23, 2021
## Below makes the B2 and B3 areas (new Klinse-za/Twin Sisters Park) of the partnership agreement areas as protected areas; everything else as available to harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.central_grp_proposed_luo' AND (zoneid = 1) OR (zoneid = 2)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.central_grp_proposed_luo' AND (zoneid = 3) OR (zoneid = 4) OR (zoneid = 5) OR (zoneid = 6) OR (zoneid = 7) OR (zoneid = 8)") 

# Below sets proposed maximum NRV age targets for LUO for critical habitat overlapping this unit with age 30 threshold
## Kennedy Siding
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 29 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 7 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 24 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 17 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 5)") 
## Moberly
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 29 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 28 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 4)") 

# Below sets proposed maximum NRV age targets for LUO for critical habitat overlapping this unit 
## Kennedy Siding
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 39 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 7 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 24 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 17 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 5)") 
## Moberly
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 39 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 28 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 4)") 

# Below sets proposed median NRV age targets for LUO for critical habitat overlapping this unit 
## Kennedy Siding
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 39 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 5 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 17 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 5)") 
## Moberly
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 39 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 9 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 21 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 4)") 

# Below sets proposed minimum NRV age targets for LUO for critical habitat overlapping this unit 
## Kennedy Siding
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 39 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0) OR (zoneid = 4) OR (zoneid = 5)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 3 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 0)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 10 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 7 where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 5)") 
## Moberly
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 39 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0) OR (zoneid = 4)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 6 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 0)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 13 where reference_zone = 'rast.zone_cond_bc_moberly_crithab' AND (zoneid = 4)") 


# NORTHERN GROUP - Wolverine
# Below makes priority forest stands no harvest in Core and all of the matrix habitat areas max 15% disturbance; N
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 12) OR (zoneid = 13) OR (zoneid = 14) OR (zoneid = 15) OR (zoneid = 16) OR (zoneid = 17) OR (zoneid = 18) OR (zoneid = 19) OR (zoneid = 20) OR (zoneid = 21) OR (zoneid = 22) OR (zoneid = 23) OR (zoneid = 24) OR (zoneid = 25) OR (zoneid = 26) OR (zoneid = 27) OR  (zoneid = 9) OR (zoneid = 10) OR (zoneid = 11)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 88) OR (zoneid = 89) OR (zoneid = 90)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 91)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 91)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 91)") 


# NORTHERN GROUP - Chase
# Below makes priority forest stands no harvest in Core and all of the matrix habitat areas max 15% disturbance; N
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 13) OR (zoneid = 14) OR (zoneid = 15) OR (zoneid = 16) OR (zoneid = 17) OR (zoneid = 18) OR (zoneid = 19) OR (zoneid = 20) OR (zoneid = 21) OR (zoneid = 22) OR (zoneid = 23) OR (zoneid = 24) OR (zoneid = 25) OR (zoneid = 26) OR (zoneid = 27) OR (zoneid = 88) OR (zoneid = 89) OR (zoneid = 90) OR (zoneid = 91)") 

dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 9) OR (zoneid = 10) OR (zoneid = 11)") 

dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 12)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 12)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 12)") 


# NORTHERN GROUP - GROUP 2 (Graham)
# Below makes the HEWSR and LESR no harvest and matrix and LEWR habitat max 12% disturbance
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_graham_crithab' AND (zoneid = 3)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_cond_bc_graham_crithab' AND (zoneid = 3)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_bc_graham_crithab' AND (zoneid = 3)") 
# Below makes priority forest stands no harvest and all of the matrix and LEWR habitat areas max 15% disturbance; N
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 9) OR (zoneid = 10) OR (zoneid = 11) OR (zoneid = 12) OR (zoneid = 88) OR (zoneid = 89) OR (zoneid = 90) OR (zoneid = 91)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 13) OR (zoneid = 14) OR (zoneid = 15) OR (zoneid = 16) OR (zoneid = 17) OR (zoneid = 18) OR (zoneid = 19) OR (zoneid = 20) OR (zoneid = 21) OR (zoneid = 22) OR (zoneid = 23) OR (zoneid = 24)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 25) OR (zoneid = 26) OR (zoneid = 27)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 25) OR (zoneid = 26) OR (zoneid = 27)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 25) OR (zoneid = 26) OR (zoneid = 27)") 
# Below makes priority forest stands in high and medium zones no harvest and  high and medium zones of the matrix and LEWR habitat areas max 15% disturbance; Low priority zones availabel to harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 9) OR (zoneid = 10) OR (zoneid = 11) OR (zoneid = 12) OR (zoneid = 88) OR (zoneid = 89) OR (zoneid = 90) OR (zoneid = 91) OR (zoneid = 14) OR (zoneid = 17) OR (zoneid = 20) OR (zoneid = 26)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 13)  OR (zoneid = 15) OR (zoneid = 16) OR (zoneid = 18) OR (zoneid = 19) OR (zoneid = 21) OR (zoneid = 22) OR (zoneid = 23) OR (zoneid = 24)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 25) OR (zoneid = 27)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 25) OR (zoneid = 27)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 25) OR (zoneid = 27)") 
# Below makes priority forest stands in high and medium zones no harvest and  high and medium zones of the matrix and LEWR habitat areas max 15% disturbance; Low priority zones available to harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 9) OR (zoneid = 10) OR (zoneid = 11) OR (zoneid = 12) OR (zoneid = 88) OR (zoneid = 89) OR (zoneid = 90) OR (zoneid = 91) OR (zoneid = 14) OR (zoneid = 17) OR (zoneid = 20) OR (zoneid = 26) OR (zoneid = 15) OR (zoneid = 18) OR (zoneid = 21) OR (zoneid = 27)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 13) OR (zoneid = 16) OR (zoneid = 19) OR (zoneid = 22) OR (zoneid = 23) OR (zoneid = 24)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 25)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 25)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_du7_scenario_20210330' AND (zoneid = 25)") 

#STEP 4: Remove the connection to the database
dbDisconnect(clusdb)
```

## 'harvestPriority' parameter 
- used oldest first

- as alternative,  could focus on minimizing 'disturbance' for caribou, then older, higher volume stands
  - 'dist, age DESC, vol DESC' prioritize based on:
      - 'dist', i.e., distance to disturbed pixel (closest first), then
      - 'age DESC', i.e., descending age (oldest first), then
      - 'vol DESC', i.e., descending volume (highest volume first)

- no discussion of this in PDP or determination that I could find

## Harvest Flow
The Mackenzie TSA’s allowable annual cut (AAC) was set at 4.5 million cubic metres as of November 14, 2014. A maximum of 2 M m3 is attributable to live uninfested timber and of this 500 000 m3 can be taken from the south west portion of the TSA (see [Rationale for Allowable Annual Cut (AAC) Partition Amendment](https://www2.gov.bc.ca/assets/gov/farming-natural-resources-and-industry/forestry/stewardship/forest-analysis-inventory/tsr-annual-allowable-cut/16tsra_2019_partition_amendment.pdf)). 

- In the main portion of the TSA, first, I tested a harvest flow of 1,750,000m^3^/year (7,500,000m^3^/5-year), 2M, 1.95M
  - also identified non-declining harvest flow for BAU plus the B2 and B3 areas (new Klinse-za/Twin Sisters Park) of the      partnership agreement areas as protected areas
  
- in the SW of the TSA, first, I tested a harvest flow of 500,000, 750,000, 1M, 1.5M, 1.25M, 1.35M; 1.3 - final




From 2014 determination: "...current policy already allows stands with less than 150 cubic metres per hectare to be harvested at the licensees’ discretion.  Given the results of the sensitivity analysis in which a decrease in the minimum average volume limit eliminates the projected decline in the base case mid-term timber supply, I strongly encourage Mackenzie Fibre to work with licensees to explore opportunities to harvest lower volume stands in the Mackenzie TSA. With regard to Canfor’s ’ recommendation that an average stand volume limit of 200 cubic metres not be applied in the base case, I note that removal of this limit in a sensitivity analysis resulted in a much higher contribution of low-volume stands than is currently supported by demonstrated harvest performance in the Mackenzie TSA. After careful consideration of all the information available to me, I conclude that the minimum harvest criteria used in the base case reasonably reflect demonstrated harvest performance in the Mackenzie TSA and I will make no adjustments to the base case on this account."

- in TSR, the annual average was 200, allowing for <200, but I used 150 m3/ha as minimum harvest volume, and assessed what the average was *a priori* to make sure I was at ~200; foudn that with a 1.7 Mm3 flow, for 23 of 40 intervals average <200, 17 of 40 years average less than 195, 13 of 40 years less than 190, and 7 of 40 less than 185; so I am overestimating use of low volume stands much of the time, but on average typically not more than by 150m3/ha; lowest average was 180 m3; so I kept as is (any major concerns with this?)

For cutblock adjacency, I used 3 m adjacency; no real mention fo this in report

## Below is a code for switching from a disturbance ('dist') to forest attribute ('age', height') constraint type
Disturbance constraint types calculates the percent area disturbed over forested area, whereas forest stand attributes constraint types are calculated over total area of the zone. Thus, if you have a zone initially parameterized with a disturbance constraint and want to use the same zone with a forest stand attributes constraint, you need to change the total area (t_area) from forested area to total zone area (or vice-versa). The code chunk below demonstrates how to do that,

```{r, change dist to forest attribute constraint type}

# connect to the db
clusdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/MacKenzie_TSA_clusdb.sqlite"))

# identify zone column names of the zones of interest
dbGetQuery(clusdb, "SELECT reference_zone, zone_column, zoneid from zoneConstraints where 
reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab'") 
#  rast.zone_cond_bc_moberly_crithab, rast.zone_cond_bc_kennedy_siding_crithab
 
 
# for each zone that you want to change:
## calc the total area of the zone 
count <- dbGetQuery(clusdb, "SELECT count() from pixels where zone31 = 5") # rast.zone_cond_bc_moberly_crithab, rast.zone_cond_bc_kennedy_siding_crithab // 0, 4, 5

## update to the total area in the constraint table for the zone
dbExecute(clusdb, paste0("UPDATE zoneConstraints SET t_area = ", count, " where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab' AND (zoneid = 5)")) # rast.zone_cond_bc_moberly_crithab, rast.zone_cond_bc_kennedy_siding_crithab  // 0, 4, 5 

# to check it
zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneconstraints where reference_zone = 'rast.zone_cond_bc_kennedy_siding_crithab'")                  
 

```


## Below is the code chunk for running the sim

```{r module_usage}
library (SpaDES.core)
library (data.table)
source (paste0(here::here(), "/R/functions/R_Postgres.R"))

moduleDir <- file.path(paste0(here::here(), "/R/SpaDES-modules"))
inputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/inputs")) %>% reproducible::checkPath(create = TRUE)
outputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/outputs"))
cacheDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS"))
times <- list(start = 0, end = 40) # 5 year interval; 200 years = 40 intervals
parameters <- list(
  .progress = list(type = NA, interval = NA),
  .globals = list(),
  dataLoaderCLUS = list( 
                           dbName='clus',
                           save_clusdb = TRUE,
                           sqlite_dbname = "MacKenzie_TSA",
                           useCLUSdb = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/MacKenzie_TSA_clusdb.sqlite"), # MacKenzie_TSA_clusdb.sqlite  MacKenzie_SW_TSA_clusdb.sqlite  
                           #Study Area
                           nameBoundaryFile = "tsa_aac_bounds",
                           nameBoundaryColumn = "tsa_name",
                           nameBoundary = "MacKenzie_TSA", # MacKenzie_TSA   MacKenzie_SW_TSA
                           nameBoundaryGeom = 'wkb_geometry',
                           nameCompartmentRaster = "rast.tsa_aac_boundary",
                           nameCompartmentTable = "tsa_aac_bounds_vat",
                           nameMaskHarvestLandbaseRaster = 'rast.thlb_2020', #'rast.bc_thlb2018' 
                           nameZoneRasters = c(
                                               # "rast.zone_cond_beo", 
                                               # "rast.zone_cond_vqo", 
                                               # "rast.zone_wha_2021", #"rast.zone_cond_wha"  
                                               # "rast.zone_uwr_2021", #"rast.zone_cond_uwr"
                                               # "rast.zone_cond_fsw",
                                               # "rast.zone_cond_nharv",
                                               # "rast.zone_cond_cw",
                                           
                                              # "rast.zone_cond_partnership_agreement",
                                              # "rast.zone_cond_noharvest_moberly_crithab_or_herd",
                                              # "rast.zone_cond_noharvest_gataga_crithab_or_herd",
                                              # "rast.zone_cond_noharvest_wolverine_crithab_or_herd"
                                              # "rast.zone_cond_noharvest_chase_crithab_or_herd"
                                              # "rast.zone_cond_noharvest_finlay_crithab_or_herd",
                                              # "rast.zone_cond_noharvest_kennedy_siding_crithab_or_herd",
                                              # "rast.zone_cond_noharvest_graham_crithab_or_herd"
                                              # "rast.zone_cond_noharvest_rabbit_crithab_or_herd",
                                              # "rast.zone_cond_noharvest_frog_crithab_or_herd",
                                              # "rast.zone_cond_noharvest_thutade_crithab_or_herd",
                                              # "rast.zone_cond_noharvest_wolverine_crithab_or_herd"
                                              # "rast.zone_cond_eccc_moberly_crithab_or_herd",
                                              # "rast.zone_cond_eccc_gataga_crithab_or_herd",
                                              # "rast.zone_cond_eccc_wolverine_crithab_or_herd",
                                              # "rast.zone_cond_eccc_chase_crithab_or_herd",
                                              # "rast.zone_cond_eccc_finlay_crithab_or_herd",
                                              # "rast.zone_cond_eccc_kennedy_siding_crithab_or_herd",
                                              # "rast.zone_cond_eccc_graham_crithab_or_herd",
                                              # "rast.zone_cond_eccc_rabbit_crithab_or_herd",
                                              # "rast.zone_cond_eccc_frog_crithab_or_herd",
                                              # "rast.zone_cond_eccc_thutade_crithab_or_herd",
                                              # "rast.zone_cond_bc_graham_crithab"
                                               # "rast.zone_cond_bc_moberly_crithab",
                                               # "rast.zone_cond_bc_kennedy_siding_crithab",
                                              # "rast.central_grp_proposed_luo"
                                              # "rast.central_grp_proposed_luo_buffer",
                                              # "rast.central_grp_proposed_luo_matrix",
                                              # "rast.central_grp_proposed_luo_feb2021",
                                              # "rast.zone_du7_scenario_20210330"
                                             ),
                           nameZoneTable = "zone.constraints",
                           # nameZonePriorityRaster = "rast.zone_cond_beo",
                           nameYieldsRaster = "rast.ycid_vdyp",
                           nameYieldTable = "yc_vdyp",
                           nameYieldsTransitionRaster = "rast.tipsy2018_id",
                           nameYieldTransitionTable = "yc_tipsy",
                           nameForestInventoryRaster = "rast.vri2019_id",
                           nameForestInventoryKey = "feature_id",
                           nameForestInventoryTable = "veg_comp_lyr_r1_poly2019",
                           nameForestInventoryAge = "proj_age_1",
                           nameForestInventoryHeight = "proj_height_1",
                           nameForestInventoryCrownClosure = "crown_closure",
                           nameForestInventoryTreed = "bclcs_level_2",
                           nameForestInventorySiteIndex = "site_index"),
  blockingCLUS = list(blockMethod ='pre', 
                      patchZone = 'rast.zone_cond_beo',
                      patchVariation = 6,
                      nameCutblockRaster ="rast.cns_cut_bl",
                      useLandingsArea = FALSE, 
                      useSpreadProbRas = FALSE),
  forestryCLUS = list(harvestBlockPriority = "age DESC", # "dist, age DESC, vol DESC"
                      #harvestZonePriority = "age DESC",
                      #harvestZonePriorityInterval = 1,
                      reportHarvestConstraints = T,
                      adjacencyConstraint = 0),
  growingStockCLUS = list (periodLength = 5),
  roadCLUS = list(roadMethod = 'pre', 
                  nameCostSurfaceRas = 'rast.rd_cost_surface', 
                  nameRoads =  'rast.crds_all'),
  # rsfCLUS = list (calculateInterval = 10, # at what time interval to calculate RSF
  #                 criticalHabitatTable = "public.vat_bc_crithab_and_herd",
  #                 randomEffectsTable = "public.rsf_re_coeff",
  #                 writeRSFRasters = TRUE,
  #                 checkRasters = FALSE),
  survivalCLUS = list (caribou_herd_density = 0.05, # assign what is appropriate for the herd
                       nameRasCaribouHerd = "rast.caribou_herd", # raster of herd boundaries
                       tableCaribouHerd = "public.caribou_herd_vat"), # look-up table of herd names
  disturbanceCalcCLUS = list(calculateInterval =  1, # should be 1 if using constraints on 'dist' (disturbance)
                             criticalHabitatTable = "public.vat_bc_crithab_and_herd",
                             criticalHabRaster = "rast.bc_crithab_and_herd",
                             permDisturbanceRaster = "rast.mine_ag_wind_rail",
                             recovery = 40),
  volumebyareaReportCLUS = list (calculateInterval = 1,
                                 AreaofInterestRaster = "rast.bc_crithab_and_herd",
                                 AreaofInterestTable = "public.vat_bc_crithab_and_herd"),
  uploaderCLUS = list(aoiName = 'mackenzie_tsa', # mackenzie_sw_tsa
                      dbInfo  = list(keyring::key_get("vmdbhost", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbuser", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbpass", keyring="postgreSQL"),  
                                     keyring::key_get("vmdbname", keyring="postgreSQL"))
                  ),
  yieldUncertaintyCLUS = list(elevationRaster = 'rast.dem')
)

modules <- list("dataLoaderCLUS", 
                "growingStockCLUS", 
                "blockingCLUS", 
                "forestryCLUS", 
                "roadCLUS",  
                #"yieldUncertaintyCLUS", 
                "survivalCLUS", 
                "disturbanceCalcCLUS", 
                "volumebyareaReportCLUS",
                # "rsfCLUS", # error line 453 - need to debug
                "uploaderCLUS"
                )

# rsf_model_coeff <- data.table (getTableQuery ("SELECT * FROM rsf_model_coeff WHERE population = 'DU7' and  species = 'caribou' and season IN ('A')"))
# rsf_model_coeff[, bounds := 'rast.bc_crithab_and_herd']



# scenario = data.table (name = "mackenzie_bau",
#                        description = "Business-as-usual case. Oldest first. Harvest flow = 1.95 M m3/yr. Adjacency = 3m.")
# scenario = data.table (name = "mackenzie_luo_35p_25yo_250cm",
#                        description = "Central group proposed land use order; area less than 35% less than 25 years old or less than 2.5 m tall. Oldest first. Adjacency = 3. Harvest flow = 1.95 M m3/yr.")
# scenario = data.table (name = "mackenzie_luo_35p_25yo",
#                        description = "Central group proposed land use order; area less than 35% less than 25 years old. Oldest first. Adjacency = 3. Harvest flow = 1.95 M m3/yr.")
# scenario = data.table (name = "mackenzie_luo_35p_250cm",
#                        description = "Central group proposed land use order; area less than 35% less than 2.5 m tall. Oldest first. Adjacency = 3. Harvest flow = 1.95 M m3/yr.")
# scenario = data.table (name = "mackenzie_du7_grp2_nh",
#                        description = "No harvest in group 2 (Graham) critical habitat that overlaps with the harvest unit (e.g., TSA or TFL). Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_du7_grp2_he0d_mlewr12d",
#                        description = "No harvest in group 2 (Graham)  HEWSR and LESR critical habitat; harvest allowed in LEWR and matrix critical habitat up to 12% disturbance (no buffer) in forested area. Harvest flow = 1.95 M m3/yr.  Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_du7_grp2_hi_med_lo",
#                        description = "No harvest priority stands in high, medium and low priority zones in group 2 (Graham) HEWSR and LESR critical habitat; harvest allowed in high, medium and low priority zones in LEWR and matrix critical habitat up to 15% disturbance (no buffer) in forested area. Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_du7_grp2_hi_med",
#                        description = "No harvest priority stands in high and medium  priority zones in group 2 (Graham) HEWSR and LESR critical habitat; harvest allowed in high and medium priority zones in LEWR and matrix critical habitat up to 15% disturbance (no buffer) in forested area. All low priority zoens available to harvest. Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_du7_grp2_hi",
#                        description = "No harvest priority stands in high priority zones in group 2 (Graham) HEWSR and LESR critical habitat; harvest allowed in high  priority zones in LEWR and matrix critical habitat up to 15% disturbance (no buffer) in forested area. All low and medium priority zones available to harvest. Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_chase_nh",
#                        description = "No harvest in Chase critical habitat that overlaps with the harvest unit (e.g., TSA or TFL). Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_chase_hi_med_lo",
#                        description = "No harvest priority stands in high priority zones in Chase core critical habitat; harvest allowed in high priority zones in Chase matrix critical habitat up to 15% disturbance (no buffer) in forested area. NOTE: all zones in this unit high priority. Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_wolverine_nh",
#                        description = "No harvest in Wolverine herd that overlaps with the harvest unit (e.g., TSA or TFL). Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_wolverine_hi_priority",
#                        description = "No harvest priority stands in high priority zones in Wolverine core critical habitat; harvest allowed in high priority zones in Wolverine matrix critical habitat up to 15% disturbance (no buffer) in forested area. NOTE: all zones in this unit high priority. Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_sw_bau",
#                        description = "Business-as-usual case; southwest block only. Oldest first. Harvest flow = 1,300,000 m3/yr. Adjacency = 3m.")
# scenario = data.table (name = "mackenzie_sw_wolverine_nh",
#                        description = "No harvest in Wolverine herd that overlaps with the harvest unit (e.g., TSA or TFL). Harvest flow = 1,300,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_sw_wolverine_hi_priority",
#                        description = "No harvest priority stands in high priority zones in Wolverine core critical habitat; harvest allowed in high priority zones in Wolverine matrix critical habitat up to 15% disturbance (no buffer) in forested area. NOTE: all zones in this unit high priority. Harvest flow = 1,300,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_bau_newpark",
#                        description = "Business-as-usual case with Klinse-za/Twin Sisters park (B2 and B3 areas) from parntership agreement added as no harvest. Oldest first. Harvest flow = 1.95 M m3/yr. Adjacency = 3m.")
# scenario = data.table (name = "mackenzie_centgrp_luo_age_le40",
#                        description = "Draft land use order early seral (age) thresholds for central group critical habitat, April 26, 2021. Oldest first. Harvest flow = 1.95 M m3/yr. Adjacency = 3m.")
# scenario = data.table (name = "mackenzie_centgrp_luo_age_le40_modNRV",
#                        description = "Draft land use order early seral (age) thresholds for central group critical habitat, April 26, 2021. Oldest first. Moderate natural range of variability (NRV) early seral targets.  Harvest flow = 1.95 M m3/yr. Adjacency = 3m.")
# scenario = data.table (name = "mackenzie_centgrp_luo_age_le40_maxNRV",
#                        description = "Draft land use order early seral (age) thresholds for central group critical habitat, April 26, 2021. Oldest first. Maximum natural range of variability (NRV) early seral targets.  Harvest flow = 1.95 M m3/yr. Adjacency = 3m.")
# scenario = data.table (name = "mackenzie_centgrp_agele30_maxnrv",
#                        description = "Draft land use order early seral (age) thresholds for central group critical habitat, April 26, 2021. Early seral targets set for maximum natural range of variability (NRV) for each area, using age <30 as early seral. Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_centgrp_agele20_maxnrv",
#                        description = "Draft land use order early seral (age) thresholds for central group critical habitat, April 26, 2021. Early seral targets set for maximum natural range of variability (NRV) for each area, using age <20 as early seral. Harvest flow = 1.95 M m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "mackenzie_bau_newpark_noadj",
#                        description = "Business-as-usual case with Klinse-za/Twin Sisters park (B2 and B3 areas) from parntership agreement added as no harvest. Oldest first. Harvest flow = 2.25 M m3/yr. No Adjacency.")
# scenario = data.table (name = "mackenzie_centgrp_luo_age_le40_modNRV",
#                        description = "Draft land use order early seral (age) thresholds for central group critical habitat, April 26, 2021. Oldest first. Moderate natural range of variability (NRV) early seral targets.  Harvest flow = 1.95 M m3/yr. Adjacency = 3m.")

scenario = data.table (name = "mackenzie_bau_newpark_noadj",
                       description = "Business-as-usual case with no constraints. Oldest first. Harvest flow = 2.25 M m3/yr. No Adjacency.")


# BELOW SCENARIOS HAVE NOT BEEN RUN WITH UPDATED MODEL
# scenario = data.table (name = "mackenzie_centgrp_nh",
#                        description = "No harvest in all central group critical habitat (Moberly and Kennedy Siding). Adjacency was set to 3m.")
# scenario = data.table (name = "mackenzie_centgrp_ch_hele0d_m15d",
#                        description = "No harvest in Central group high and low elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Central group matrix critical habitat (Moberly and Kennedy Siding). Adjacency was set to 3m.")
# scenario = data.table (name = "mackenzie_centgrp_pa_ch_a2b2b3_0d_a1b1b4b5_15d",
#                        description = "No harvest in Central group partnership agreement areas A2, B2, and B3, maximum 35% buffered disturbance (15% harvest) in  Central group partnership agreement areas A1, B1, B4 and B5. Adjacency was set to 3m.")
# scenario = data.table (name = "mackenzie_centgrp_pa_nh",
#                        description = "No harvest in all central group partnership agreement areas. Adjacency was set to 3m.")
# scenario = data.table (name = "mackenzie_all_nh",
#                        description = "No harvest in all critical habitat of all herds that overlap with the unit. Adjacency was set to 3m.")
# scenario = data.table (name = "mackenzie_all_ch_hele0d_m15d",
#                        description = "No harvest in high and low elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in matrix critical habitat of all herds that overlap with the harvest unit. Adjacency was set to 3m.")
# scenario = data.table (name = "mackenzie_all_sm_herdbounds_nh",
#                        description = "No harvest in all southern mountain herds that overlap with the harvest unit. Adjacency was set to 3m.")
# scenario = data.table (name = "mackenzie_wct_nh",
#                        description = "No harvest in Wolverine, Chase and Takla herds that overlap with the harvest unit. Adjacency was set to 3m.")
# scenario = data.table (name = "mackenzie_luo_35p_25yo",
#                        description = "Central group proposed land use order. Maximum 35% less than 25 years old.")



harvestFlow <- rbindlist(list(data.table(compartment ="MacKenzie_TSA", # # MacKenzie_TSA   MacKenzie_SW_TSA
                                     partition = ' vol > 150 ', # from 2014 determination
                                     year = rep( seq (from = 1, # run the 
                                                      to = 40, 
                                                      by = 1),
                                                1), 
                                     flow = 11250000) # southwest: 6500000 / 1,300,000m3/yr //north: 9750000 / 1,950,000m3/yr 
))

#harvestFlow<-rbindlist(list(harvestFlowA,harvestFlowB,harvestFlowC))

patchSizeDist<- data.table(ndt= c(1,1,1,1,1,1,
                                  2,2,2,2,2,2,
                                  3,3,3,3,3,3,
                                  4,4,4,4,4,4,
                                  5,5,5,5,5,5), 
                           sizeClass = c(40,80,120,160,200,240), 
                           freq = c(0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.2, 0.3, 0.125, 0.125, 0.125, 0.125,
                                    0.1,0.02,0.02,0.02,0.02,0.8,
                                    0.3,0.3,0.1,0.1,0.1, 0.1))

#calb_ymodel<-readRDS(paste0(here::here(), "/R/Params/calb_ymodel.rds")) #See linkHBS_VRI_Calibration.Rmd
#calb_data4<-readRDS(paste0(here::here(), "/R/Params/calb_data.rds")) #See linkHBS_VRI_Calibration.Rmd

objects <- list(harvestFlow = harvestFlow, 
                patchSizeDist = patchSizeDist, 
                scenario = scenario)

paths <- list(cachePath = cacheDir,
              modulePath = moduleDir,
              inputPath = inputDir,
              outputPath = outputDir)

mySim <- simInit(times = times, 
                 params = parameters, 
                 modules = modules,
                 objects = objects, 
                 paths = paths)

# outputs to keep; these are tables that get used in the uploader
outputs(mySim) <- data.frame (objectName = c("harvestReport",
                                             "growingStockReport",
                                             "tableSurvival",
                                             "disturbanceReport"))

#Run the model 1 time
system.time({mysimout<-spades(mySim)})

#Run the model with experiment
#sims3 <- experiment(mySim, replicates = 2)

#Profile the model
#profvis::profvis({system.time({mysimout<-spades(mySim)})})


```


# Scenarios for SW Portion of the TSA 

mackenzie_bau: Business-as-usual case; sustainable flow = 1.7 M m3/yr + 0.5 M m3 in SW portion.Adjacency was set to 3m.

mackenzie_wct_nh:No harvest in Wolverine, Chase and Takla herds that overlap with the harvest unit (e.g., TSA or TFL)

mackenzie_all_nh: No harvest in all critical habitat of all herds that overlap with the harvest unit (e.g., TSA or TFL)

----No different than BAU but added anyways
mackenzie_centgrp_nh : No harvest in all central group critical habitat

mackenzie_centgrp_ch_hele0d_m15d: No harvest in Central group high and low elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Central group matrix critical habitat

mackenzie_centgrp_pa_ch_a2b2b3_0d_a1b1b4b5_15d:No harvest in Central group partnership agreement areas A2, B2, and B3, maximum 35% buffered disturbance (15% harvest) in  Central group partnership agreement areas A1, B1, B4 and B5

mackenzie_centgrp_pa_nh: No harvest in all central group partnership agreement areas


mackenzie_all_ch_hele0d_m15d:No harvest in high and low elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in matrix critical habitat of all herds that overlap with the harvest unit (e.g., TSA or TFL)

mackenzie_all_sm_herdbounds_nh:No harvest in all southern mountain herds that overlap with the harvest unit (e.g., TSA or TFL). Wolverine, Moberly and scott are sm - northern /central group

"rast.zone_cond_eccc_moberly_crithab_or_herd",
"rast.zone_cond_eccc_scott_crithab_or_herd",
"rast.zone_cond_eccc_wolverine_crithab_or_herd"


```{r module_usage}
library (SpaDES.core)
library (data.table)
source (paste0(here::here(), "/R/functions/R_Postgres.R"))

moduleDir <- file.path(paste0(here::here(), "/R/SpaDES-modules"))
inputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/inputs")) %>% reproducible::checkPath(create = TRUE)
outputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/outputs"))
cacheDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS"))
times <- list(start = 0, end = 40) # 5 year interval; 200 years = 40 intervals
parameters <- list(
  .progress = list(type = NA, interval = NA),
  .globals = list(),
  dataLoaderCLUS = list( 
                           dbName='clus',
                           save_clusdb = FALSE,
                           useCLUSdb = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/MacKenzie_SW_TSA_clusdb.sqlite"),
                           #Study Area
                           nameBoundaryFile = "tsa_aac_bounds",
                           nameBoundaryColumn = "tsa_name",
                           nameBoundary = "MacKenzie_SW_TSA",
                           nameBoundaryGeom = 'wkb_geometry',
                           nameCompartmentRaster = "rast.tsa_aac_boundary",
                           nameCompartmentTable = "tsa_aac_bounds_vat",
                           nameMaskHarvestLandbaseRaster = 'rast.bc_thlb2018',
                           nameZoneRasters = c("rast.zone_cond_beo", 
                                               "rast.zone_cond_vqo", 
                                               "rast.zone_cond_wha", 
                                               "rast.zone_cond_uwr",
                                               "rast.zone_cond_fsw",
                                               "rast.zone_cond_nharv",
                                               "rast.zone_cond_noharvest_moberly_crithab_or_herd",
"rast.zone_cond_noharvest_scott_crithab_or_herd",
"rast.zone_cond_noharvest_wolverine_crithab_or_herd"
                                              
                                               ),
                           nameZoneTable = "zone_constraints",
                           nameYieldsRaster = "rast.ycid_vdyp",
                           nameYieldTable = "yc_vdyp",
                           nameYieldsTransitionRaster = "rast.tipsy2018_id",
                           nameYieldTransitionTable = "yc_tipsy",
                           nameForestInventoryRaster = "rast.vri2018_id",
                           nameForestInventoryKey = "feature_id",
                           nameForestInventoryTable = "veg_comp_lyr_r1_poly2018",
                           nameForestInventoryAge = "proj_age_1",
                           nameForestInventoryHeight = "proj_height_1",
                           nameForestInventoryCrownClosure = "crown_closure",
                           nameForestInventorySiteIndex = "site_index"),
  blockingCLUS = list(blockMethod ='pre', 
                      patchZone = 'rast.zone_cond_beo',
                      patchVariation = 6,
                      nameCutblockRaster ="rast.cns_cut_bl",
                      useLandingsArea = FALSE, 
                      useSpreadProbRas = FALSE),
  forestryCLUS = list(harvestPriority = "dist, age DESC, vol DESC",
                      adjacencyConstraint = 3),
  growingStockCLUS = list (periodLength = 5),
  roadCLUS = list(roadMethod = 'pre', 
                  nameCostSurfaceRas = 'rast.rd_cost_surface', 
                  nameRoads =  'rast.crds_all'),
  # rsfCLUS = list (calculateInterval = 10, # at what time interval to calculate RSF
  #                 criticalHabitatTable = "public.vat_bc_crithab_and_herd",
  #                 randomEffectsTable = "public.rsf_re_coeff",
  #                 writeRSFRasters = TRUE,
  #                 checkRasters = FALSE),
  survivalCLUS = list (caribou_herd_density = 0.05, # assign what is appropriate for the herd
                       nameRasCaribouHerd = "rast.caribou_herd", # raster of herd boundaries
                       tableCaribouHerd = "public.caribou_herd_vat"), # look-up table of herd names
  disturbanceCalcCLUS = list(calculateInterval = 5, 
                             criticalHabitatTable = "public.vat_bc_crithab_and_herd",
                             criticalHabRaster = "rast.bc_crithab_and_herd",
                             permDisturbanceRaster = "rast.mine_ag_wind_rail",
                             recovery = 40),
  uploaderCLUS = list(aoiName = 'mackenzie_tsa', # name of the schema that gets uplaoded to postgres
                      dbInfo  = list(keyring::key_get("vmdbhost", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbuser", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbpass", keyring="postgreSQL"),  
                                     keyring::key_get("vmdbname", keyring="postgreSQL"))
                  ),
  yieldUncertaintyCLUS = list(elevationRaster = 'rast.dem')
)

modules <- list("dataLoaderCLUS", 
                "growingStockCLUS", 
                "blockingCLUS", 
                "forestryCLUS", 
                "roadCLUS",  
                #"yieldUncertaintyCLUS", 
                "survivalCLUS", 
                "disturbanceCalcCLUS", 
                # "rsfCLUS", # error line 453 - need to debug
                "uploaderCLUS"
                )

# rsf_model_coeff <- data.table (getTableQuery ("SELECT * FROM rsf_model_coeff WHERE population = 'DU7' and  species = 'caribou' and season IN ('A')"))
# rsf_model_coeff[, bounds := 'rast.bc_crithab_and_herd']

scenario = data.table (name = "mackenzie_all_sm_herdbounds_nh",
                       description = "No harvest in all southern mountain herds that overlap with the harvest unit (e.g., TSA or TFL). Wolverine, Moberly and scott are sm - northern /central group")

harvestFlow <- rbindlist(list(data.table(compartment ="MacKenzie_SW_TSA",
                                     partition = ' vol > 150 ', # from 2014 determination
                                     year = rep( seq (from = 2018, # run the 
                                                      to = 2218, 
                                                      by = 5),
                                                1), 
                                     flow = 2500000) #500,000m3/yr
))

#harvestFlow<-rbindlist(list(harvestFlowA,harvestFlowB,harvestFlowC))

patchSizeDist<- data.table(ndt= c(1,1,1,1,1,1,
                                  2,2,2,2,2,2,
                                  3,3,3,3,3,3,
                                  4,4,4,4,4,4,
                                  5,5,5,5,5,5), 
                           sizeClass = c(40,80,120,160,200,240), 
                           freq = c(0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.2, 0.3, 0.125, 0.125, 0.125, 0.125,
                                    0.1,0.02,0.02,0.02,0.02,0.8,
                                    0.3,0.3,0.1,0.1,0.1, 0.1))

#calb_ymodel<-readRDS(paste0(here::here(), "/R/Params/calb_ymodel.rds")) #See linkHBS_VRI_Calibration.Rmd
#calb_data4<-readRDS(paste0(here::here(), "/R/Params/calb_data.rds")) #See linkHBS_VRI_Calibration.Rmd

objects <- list(harvestFlow = harvestFlow, 
                patchSizeDist = patchSizeDist, 
                scenario = scenario)

paths <- list(cachePath = cacheDir,
              modulePath = moduleDir,
              inputPath = inputDir,
              outputPath = outputDir)

mySim <- simInit(times = times, 
                 params = parameters, 
                 modules = modules,
                 objects = objects, 
                 paths = paths)

# outputs to keep; these are tables that get used in the uploader
outputs(mySim) <- data.frame (objectName = c("harvestReport",
                                             "growingStockReport",
                                             "tableSurvival",
                                             "disturbanceReport"))

#Run the model 1 time
system.time({mysimout<-spades(mySim)})

#Run the model with experiment
#sims3 <- experiment(mySim, replicates = 2)

#Profile the model
#profvis::profvis({system.time({mysimout<-spades(mySim)})})


```

# Events

## Flow Chart

```{r, flow_chart}
library(SpaDES.core)
eventDiagram(mysimout)
```

## Algorithum

The general algorithum (pseudo-code) follows as:

`compartment_list`= SELECT zones FROM compartments WHERE target > 0 ORDER BY priority_compartment

FOR compartment_selected in `compartment_list`
`queue`<- SELECT pixelid, blockid FROM pixels WHERE 
            compartment = compartment_selected AND thlb > 0 AND constraint = 0                 ORDER BY priority
               
IF (`queue` > 0 )
  check constraints
ELSE 
  NEXT
        

# Data dependencies

## Input data

A SQLite db is required (output from dataloaderCLUS). A harvestFlow data.table object that includes the forest management unit (i.e., compartment, aka - 'supply block'), the partition from which the harvest flow applies (e.x., All dead pine); the year at which the flow applies and the amount of volume.

## Output data

A list of landings || blocks from when they are harvested.

# Links to other modules

dataloaderCLUS is required.

