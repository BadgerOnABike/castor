---
title: "forestryCLUS"
author: ""
date: "08 April 2019"
output:
html_document: 
keep_md: yes
---

<!--
Copyright 2020 Province of British Columbia
 
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
 
http://www.apache.org/licenses/LICENSE-2.0
 
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.-->

# Overview

This module provides the logic for simulating forestry decisions on the landscape. These decisions currently involve spatializing the harvest flow objectives which include: where, when and how much to harvest. These factors help determine policies related to harvest flows, opening size, seral distrubitions, road densitites, preservation areas, silvicultural systems, etc. More sophistication to these decisions would involve looking at the costs and benefits beyond the current time period; this requires optimization or improved heuristics -- which may be considered in the future. The general overview of forestryCLUS follows.

At each time step, harvest units (pixels or blocks) are ranked according to a priority (e.g., oldest first), this constructs a queue. This queue of harvest units are then subject to various constraints meant to meet objectives for the study area. Harvest units are harvested until either a constraint is binding, the queue is exhausted or the harvest flow is met. Next, the age of the forest is advanced to the next time period and the process is repeated. 

During the simulation various reports and information surrounding each pixel can be saved/recorded or used in a summary. Note these outputs are considered expected future outcomes given the inputs developed by the anlayst.For a historical selection of harvesting activities see [cutblockSeqPrepCLUS](https://github.com/bcgov/clus/tree/master/R/SpaDES-modules/cutblockSeqPrepCLUS). Both  cutblockSeqPrepCLUS and forestryCLUS build a list of landing locations through simulation time. One is historical while the other is one possible future realization.

# Usage
This module could be a parent module?? It relies on: 
1. dataloadCLUS (set up the clusdb) 
2. blockingCLUS (preforms the pixel aggregation into harvest units)
3. growingStockCLUS (increments the age and volume in pixels)
4. (Optionally) rsfCLUS (track resource selection functions)
5. (Optionally) roadCLUS (preforms the access to the harvest units)
6. uploaderCLUS (uploades the outputs to a shiny app)


# Chilcotin Scenarios
business as usual (BAU); no new constraints, caribou or otherwise; establishes the current 'baseline' or benchmark to evaluate the potential impact of 'new' actions in caribou habitat


# Parameters 
## New Caribou Zone Constraints
BAU = beo, vqo, wha, uwr, fsw, parks and protected areas, community watersheds 




## 'harvestPriority' parameter 


## 'harvestFlow'






#UPDATE SCENARIO

## Chilcotin Planning Scenarios Aug. 2021
```{r, zone_update}
require (DBI)
#STEP 1: Connect to the clusdb.sqlite database for the AOI
clusdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/chilcotin_study_area_clusdb.sqlite")) # connect to clusdb -- set the locations of the sqlite

#STEP 2: View the constraints available to a zone
zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_wha_2021'") # Note: the reference_zone is the name of the raster in the rast schema. If there is no 'WHERE' clause this may return 1000's of zones rast.zone_cond_noharvest_barkerville_crithab_or_herd

zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_cond_bc_rainbows_crithab'")  # 
#  rast.zone_cond_bc_itcha_ilgachuz_crithab",  "rast.zone_cond_bc_charlotte_alplands_crithab", "rast.zone_cond_bc_rainbows_crithab"     

zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_chilcotin_scenario2'")
dbExecute (clusdb, "UPDATE zoneConstraints SET multi_condition = NULL WHERE multi_condition = 'NA';") 


#### Chilcotin Scenarios 1a, b and c - Sept. 2021 #### 
### To remove existing caribou WHA GARs; forest age constraints applied to critical habitat
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' WHERE reference_zone = 'rast.zone_wha_2021' AND (zoneid = 263) OR (zoneid = 264) OR (zoneid = 3779) OR (zoneid = 3780) OR (zoneid = 3781)") 
### To remove existing caribou conditional harvest WHA GARs; forest age constraints applied to critical habitat
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' WHERE reference_zone = 'rast.zone_wha_2021' AND (zoneid = 263) OR (zoneid = 3779) OR (zoneid = 3780) OR (zoneid = 3781)") 


#################
### Scenario 1a forest age constraints applied to all to critical habitat ##
#################
# Seral stage >80 = 45%; Seral stage >100 = 37%; Seral stage >120 = 30%; Seral stage >140 = 25%

## Itcha ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 4)")
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 4)")
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 141 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 4)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 25 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 4)")
# Need to create some new rows for multiple age constraints
dbExecute(clusdb, "INSERT INTO zoneconstraints (id, zoneid, reference_zone, zone_column, ndt, variable, threshold, type, percentage, denom, multi_condition, t_area, start, stop)
VALUES 
(3510,0,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',121,'ge',30,NULL,NULL,354101,0,250),
(3511,3,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',121,'ge',30,NULL,NULL,743222,0,250),
(3512,4,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',121,'ge',30,NULL,NULL,803760,0,250),
(3513,0,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',101,'ge',37,NULL,NULL,354101,0,250),
(3514,3,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',101,'ge',37,NULL,NULL,743222,0,250),
(3515,4,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',101,'ge',37,NULL,NULL,803760,0,250),
(3516,0,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',81,'ge',45,NULL,NULL,354101,0,250),
(3517,3,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',81,'ge',45,NULL,NULL,743222,0,250),
(3518,4,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',81,'ge',45,NULL,NULL,803760,0,250);")

## Rainbows ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 2)")
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 2)")
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 141 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 2)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 25 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 2)")
dbExecute(clusdb, "INSERT INTO zoneconstraints (id, zoneid, reference_zone, zone_column, ndt, variable, threshold, type, percentage, denom, multi_condition, t_area, start, stop)
VALUES 
(3519,0,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',121,'ge',30,NULL,NULL,54247,0,250),
(3520,3,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',121,'ge',30,NULL,NULL,45116,0,250),
(3521,4,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',121,'ge',30,NULL,NULL,10929,0,250),
(3522,0,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',101,'ge',37,NULL,NULL,54247,0,250),
(3523,3,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',101,'ge',37,NULL,NULL,45116,0,250),
(3524,4,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',101,'ge',37,NULL,NULL,10929,0,250),
(3525,0,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',81,'ge',45,NULL,NULL,54247,0,250),
(3526,3,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',81,'ge',45,NULL,NULL,45116,0,250),
(3527,4,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',81,'ge',45,NULL,NULL,10929,0,250);")

## Charlotte ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 2)")
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 2)")
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 141 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 2)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 25 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (zoneid = 0) OR (zoneid = 3) OR (zoneid = 2)")
dbExecute(clusdb, "INSERT INTO zoneconstraints (id, zoneid, reference_zone, zone_column, ndt, variable, threshold, type, percentage, denom, multi_condition, t_area, start, stop)
VALUES 
(3528,0,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',121,'ge',30,NULL,NULL,93677,0,250),
(3529,2,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',121,'ge',30,NULL,NULL,44178,0,250),
(3530,3,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',121,'ge',30,NULL,NULL,79918,0,250),
(3531,0,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',101,'ge',37,NULL,NULL,93677,0,250),
(3532,2,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',101,'ge',37,NULL,NULL,44178,0,250),
(3533,3,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',101,'ge',37,NULL,NULL,79918,0,250),
(3534,0,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',81,'ge',45,NULL,NULL,93677,0,250),
(3535,2,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',81,'ge',45,NULL,NULL,44178,0,250),
(3536,3,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',81,'ge',45,NULL,NULL,79918,0,250);")

        
#################
### Scenario 1b forest age constraints applied to HEWSR, LEWR and LESR  to critical habitat ##
#################
# Seral stage >80 = 37%; Seral stage >100 = 30%; Seral stage >120 = 25%

## Itcha ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND zoneid = 4")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3327) OR (id = 3328)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 25 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3510) OR (id = 3511)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 30 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3513) OR (id = 3514)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 37 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3516) OR (id = 3517)")
## Rainbows ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND zoneid = 4")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (id = 3334) OR (id = 3335) OR (id = 3336)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 25 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (id = 3519) OR (id = 3520)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 30 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (id = 3522) OR (id = 3523)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 37 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (id = 3525) OR (id = 3526)")
## Charlotte ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND zoneid = 3")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (id = 3324) OR (id = 3325)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 25 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (id = 3528) OR (id = 3529)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 30 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (id = 3531) OR (id = 3532)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 37 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (id = 3534) OR (id = 3535)")

#################
### Scenario 1c forest age constraints applied to HEWSR and LESR critical habitat ##
#################
# Seral stage >80 = 30%; Seral stage >100 = 25%

## Itcha ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND zoneid = 3")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3510)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 25 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3513)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 30 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3516)")
## Rainbows ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND zoneid = 3")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND id = 3519")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 25 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND id = 3522")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 30 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND id = 3525")
## Charlotte ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND zoneid = 2")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND id = 3528")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 25 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND id = 3531")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 30 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND id = 3534")

#################
### Scenario 2 forest age constraints applied to all critical habitat ##
#################
# Seral stage >80 = 45%; Seral stage >100 = 37%; Seral stage >120 = 30%; Seral stage >140 = 25%;
# Seral stage >40 = 85%

## Itcha ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab'")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 30 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3510) OR (id = 3511) OR (id = 3512)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 37 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3513) OR (id = 3514) OR (id = 3515)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 45 where reference_zone = 'rast.zone_cond_bc_itcha_ilgachuz_crithab' AND (id = 3516) OR (id = 3517) OR (id = 3518)")
# Need to create some new rows for early seral age constraints
dbExecute(clusdb, "INSERT INTO zoneconstraints (id, zoneid, reference_zone, zone_column, ndt, variable, threshold, type, percentage, denom, multi_condition, t_area, start, stop)
VALUES 
(3537,0,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',41,'ge',85,NULL,NULL,354101,0,250),
(3538,3,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',41,'ge',85,NULL,NULL,743222,0,250),
(3539,4,'rast.zone_cond_bc_itcha_ilgachuz_crithab','zone26',0,'age',41,'ge',85,NULL,NULL,803760,0,250);")

## Rainbows ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_cond_bc_rainbows_crithab'")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 30 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (id = 3519) OR (id = 3520) OR (id = 3521)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 37 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (id = 3522) OR (id = 3523) OR (id = 3524)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 45 where reference_zone = 'rast.zone_cond_bc_rainbows_crithab' AND (id = 3525) OR (id = 3526) OR (id = 3527)")
dbExecute(clusdb, "INSERT INTO zoneconstraints (id, zoneid, reference_zone, zone_column, ndt, variable, threshold, type, percentage, denom, multi_condition, t_area, start, stop)
VALUES 
(3540,0,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',41,'ge',85,NULL,NULL,54247,0,250),
(3541,3,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',41,'ge',85,NULL,NULL,45116,0,250),
(3542,4,'rast.zone_cond_bc_rainbows_crithab','zone29',0,'age',41,'ge',85,NULL,NULL,10929,0,250);")

## Charlotte ##
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab'")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 30 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (id = 3528) OR (id = 3529) OR (zoneid = 3530)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 37 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (id = 3531) OR (id = 3532) OR (zoneid = 3533)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 45 where reference_zone = 'rast.zone_cond_bc_charlotte_alplands_crithab' AND (id = 3534) OR (id = 3535) OR (zoneid = 3536)")
dbExecute(clusdb, "INSERT INTO zoneconstraints (id, zoneid, reference_zone, zone_column, ndt, variable, threshold, type, percentage, denom, multi_condition, t_area, start, stop)
VALUES 
(3543,0,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',41,'ge',85,NULL,NULL,93677,0,250),
(3544,2,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',41,'ge',85,NULL,NULL,44178,0,250),
(3545,3,'rast.zone_cond_bc_charlotte_alplands_crithab','zone25',0,'age',41,'ge',85,NULL,NULL,79918,0,250);")



#################
### Scenario 2a no harvest corridors ##
#################
# Seral stage >80 = 45%; Seral stage >100 = 37%; Seral stage >120 = 30%; Seral stage >140 = 25%
# Seral stage >40 = 65%

# Need to create some new rows for multiple age constraints
dbExecute(clusdb, "INSERT INTO zoneconstraints (id, zoneid, reference_zone, zone_column, ndt, variable, threshold, type, percentage, denom, multi_condition, t_area, start, stop)
VALUES 
(3472,5,'rast.zone_chilcotin_scenario2','zone32',0,'age',141,'ge',25,NULL,NULL,776877,0,250),
(3473,5,'rast.zone_chilcotin_scenario2','zone32',0,'age',121,'ge',30,NULL,NULL,776877,0,250),
(3474,5,'rast.zone_chilcotin_scenario2','zone32',0,'age',101,'ge',37,NULL,NULL,776877,0,250),
(3475,5,'rast.zone_chilcotin_scenario2','zone32',0,'age',81,'ge',45,NULL,NULL,776877,0,250),
(3476,6,'rast.zone_chilcotin_scenario2','zone32',0,'age',141,'ge',25,NULL,NULL,891770,0,250),
(3477,6,'rast.zone_chilcotin_scenario2','zone32',0,'age',121,'ge',30,NULL,NULL,891770,0,250),
(3478,6,'rast.zone_chilcotin_scenario2','zone32',0,'age',101,'ge',37,NULL,NULL,891770,0,250),
(3479,6,'rast.zone_chilcotin_scenario2','zone32',0,'age',81,'ge',45,NULL,NULL,891770,0,250);")


#################
### Scenario 2b; harvest in LESR high-low areas (zone 2) ##
#################
# Seral stage >80 = 45%; Seral stage >100 = 37%; Seral stage >120 = 30%; Seral stage >140 = 25%
# Seral stage >40 = 65%

# Change LESR high-low to harvestable
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_chilcotin_scenario2' AND (zoneid = 2)")
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_chilcotin_scenario2' AND (zoneid = 2)")
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 40 where reference_zone = 'rast.zone_chilcotin_scenario2' AND (zoneid = 2)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_chilcotin_scenario2' AND (zoneid = 2)")

# Need to create some new rows for multiple age constraints
dbExecute(clusdb, "INSERT INTO zoneconstraints (id, zoneid, reference_zone, zone_column, ndt, variable, threshold, type, percentage, denom, multi_condition, t_area, start, stop)
VALUES 
(3480,2,'rast.zone_chilcotin_scenario2','zone32',0,'age',141,'ge',25,NULL,NULL,14863,0,250),
(3481,2,'rast.zone_chilcotin_scenario2','zone32',0,'age',121,'ge',30,NULL,NULL,14863,0,250),
(3482,2,'rast.zone_chilcotin_scenario2','zone32',0,'age',101,'ge',37,NULL,NULL,14863,0,250),
(3483,2,'rast.zone_chilcotin_scenario2','zone32',0,'age',81,'ge',45,NULL,NULL,14863,0,250);")


#################
### Scenario 2c; harvest in LESR high-low and high moderate areas and Rainbows corridor (zones 2, 3, and 7) ##
#################
# Seral stage >80 = 45%; Seral stage >100 = 37%; Seral stage >120 = 30%; Seral stage >140 = 25%
# Seral stage >40 = 65%

# Change LESR high-moderate and Rainbows corridor to harvestable
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_chilcotin_scenario2' AND (zoneid = 3) OR (zoneid = 7)")
dbExecute(clusdb, "UPDATE zoneconstraints SET variable = 'age' where reference_zone = 'rast.zone_chilcotin_scenario2' AND (zoneid = 3) OR (zoneid = 7)")
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 40 where reference_zone = 'rast.zone_chilcotin_scenario2' AND (zoneid = 3) OR (zoneid = 7)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_chilcotin_scenario2' AND (zoneid = 3) OR (zoneid = 7)")

# Need to create some new rows for multiple age constraints
dbExecute(clusdb, "INSERT INTO zoneconstraints (id, zoneid, reference_zone, zone_column, ndt, variable, threshold, type, percentage, denom, multi_condition, t_area, start, stop)
VALUES 
(3484,3,'rast.zone_chilcotin_scenario2','zone32',0,'age',141,'ge',25,NULL,NULL,19196,0,250),
(3485,3,'rast.zone_chilcotin_scenario2','zone32',0,'age',121,'ge',30,NULL,NULL,19196,0,250),
(3486,3,'rast.zone_chilcotin_scenario2','zone32',0,'age',101,'ge',37,NULL,NULL,19196,0,250),
(3487,3,'rast.zone_chilcotin_scenario2','zone32',0,'age',81,'ge',45,NULL,NULL,19196,0,250),
(3488,7,'rast.zone_chilcotin_scenario2','zone32',0,'age',141,'ge',25,NULL,NULL,77831,0,250),
(3489,7,'rast.zone_chilcotin_scenario2','zone32',0,'age',121,'ge',30,NULL,NULL,77831,0,250),
(3490,7,'rast.zone_chilcotin_scenario2','zone32',0,'age',101,'ge',37,NULL,NULL,77831,0,250),
(3491,7,'rast.zone_chilcotin_scenario2','zone32',0,'age',81,'ge',45,NULL,NULL,77831,0,250);")

## CLEAN-UP
dbExecute(clusdb, "VACUUM")
dbDisconnect(clusdb)
```



## Simulation Model

```{r module_usage}
library (SpaDES.core)
library (data.table)
source (paste0(here::here(), "/R/functions/R_Postgres.R"))

moduleDir <- file.path(paste0(here::here(), "/R/SpaDES-modules"))
inputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/inputs")) %>% reproducible::checkPath(create = TRUE)
outputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/outputs"))
cacheDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS"))
times <- list(start = 0, end = 40) # 5 year interval; 200 years = 40 intervals
parameters <- list(
  .progress = list(type = NA, interval = NA),
  .globals = list(),
  dataLoaderCLUS = list( dbName='clus',
                         save_clusdb = FALSE,
                         sqlite_dbname = "chilcotin_study_area",
                         useCLUSdb = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/chilcotin_study_area_clusdb.sqlite"),
                         nameBoundaryFile="chilcotin_area_of_interest_habitat",
                         nameBoundaryColumn = "tsa_name",
                         nameBoundary = c ('Matrix', 'HEWSR', 'LESR', 'LEWR', 'out'),
                         nameBoundaryGeom = 'wkb_geometry',
                         nameCompartmentRaster = "rast.study_area_chilcotin",
                         nameCompartmentTable = "vat.study_area_chilcotin",
                         nameMaskHarvestLandbaseRaster='rast.thlb_2020_chilcotin',  
                         nameZoneRasters=c("rast.zone_cond_beo", 
                                           "rast.zone_cond_vqo", 
                                           "rast.zone_wha_2021", 
                                           "rast.zone_uwr_2021",  
                                           "rast.zone_cond_nharv", 
                                           "rast.zone_cond_fsw", 
                                           "rast.zone_cond_cw"
                                           
                                           # "rast.zone_cond_noharvest_barkerville_crithab_or_herd",
                                           # "rast.zone_cond_noharvest_charlotte_alplands_crithab_or_herd",
                                           # "rast.zone_cond_noharvest_itcha_ilgachuz_crithab_or_herd",
                                           # "rast.zone_cond_noharvest_narrow_lake_crithab_or_herd",
                                           # "rast.zone_cond_noharvest_north_cariboo_crithab_or_herd",
                                           # "rast.zone_cond_noharvest_rainbows_crithab_or_herd",
                                           # "rast.zone_cond_noharvest_tweedsmuir_crithab_or_herd",
                                           # "rast.zone_cond_noharvest_wells_gray_north_crithab_or_herd",
                                           # 
                                           # "rast.zone_cond_eccc_barkerville_crithab_or_herd",
                                           # "rast.zone_cond_eccc_charlotte_alplands_crithab_or_herd",
                                           # "rast.zone_cond_eccc_itcha_ilgachuz_crithab_or_herd",
                                           # "rast.zone_cond_eccc_narrow_lake_crithab_or_herd",
                                           # "rast.zone_cond_eccc_north_cariboo_crithab_or_herd",
                                           # "rast.zone_cond_eccc_rainbows_crithab_or_herd",
                                           # "rast.zone_cond_eccc_tweedsmuir_crithab_or_herd",
                                           # "rast.zone_cond_eccc_wells_gray_north_crithab_or_herd",
                                           # 
                                           # "rast.zone_cond_bc_barkerville_crithab",
                                           # "rast.zone_cond_bc_narrow_lake_crithab",
                                           # "rast.zone_cond_bc_north_cariboo_crithab",
                                           # "rast.zone_cond_bc_tweedsmuir_crithab",
                                           # "rast.zone_cond_bc_wells_gray_north_crithab",
                                           
                                           # "rast.zone_cond_bc_charlotte_alplands_crithab",
                                           # "rast.zone_cond_bc_itcha_ilgachuz_crithab",
                                           # "rast.zone_cond_bc_rainbows_crithab"
                                           
                                           # "rast.zone_barkerville_groundhog_zones_20210303",
                                           # "rast.zone_smc_zones_20210315"
                                           
                                           # "rast.zone_chilcotin_scenario2"
                                           ),
                           nameZoneTable = "zone.constraints",
                           # nameZonePriorityRaster = "rast.zone_cond_beo",
                           nameYieldsRaster = "rast.ycid_vdyp",
                           nameYieldTable = "yc_vdyp",
                           nameYieldsTransitionRaster = "rast.tipsy2018_id",
                           nameYieldTransitionTable = "yc_tipsy",
                           nameForestInventoryRaster = "rast.vri2019_id",
                           nameForestInventoryKey = "feature_id",
                           nameForestInventoryTable = "veg_comp_lyr_r1_poly2019",
                           nameForestInventoryAge = "proj_age_1",
                           nameForestInventoryHeight = "proj_height_1",
                           nameForestInventoryCrownClosure = "crown_closure",
                           nameForestInventoryTreed = "bclcs_level_2",
                           nameForestInventorySiteIndex = "site_index"),
  blockingCLUS = list(blockMethod ='pre', 
                      patchZone = 'rast.zone_cond_beo',
                      patchVariation = 6,
                      nameCutblockRaster ="rast.cns_cut_bl",
                      useLandingsArea = FALSE, 
                      useSpreadProbRas = FALSE),
  forestryCLUS = list(harvestBlockPriority = " dist, salvage_vol DESC, age DESC", # query to prioritize blocks within 1km of disturbance, then 2.5km, then 5km, then everything >5km, then oldest first after that =  "CASE WHEN dist < 1000 THEN 3 WHEN dist < 2500 THEN 2 WHEN dist < 5000 THEN 1 ELSE 0 END DESC, age DESC"
                      # "dist, age DESC, vol DESC"
                      #harvestZonePriority = "age DESC",
                      #harvestZonePriorityInterval = 1,
                      reportHarvestConstraints = T,
                      adjacencyConstraint = 0,
                      salvageRaster = 'rast.dead_vol_125_2020'),
  growingStockCLUS = list (periodLength = 5),
  roadCLUS = list(roadMethod = 'pre', 
                  nameCostSurfaceRas = 'rast.rd_cost_surface', 
                  nameRoads =  'rast.crds_all'),
  # rsfCLUS = list (calculateInterval = 10, # at what time interval to calculate RSF
  #                 criticalHabitatTable = "public.vat_bc_crithab_and_herd",
  #                 randomEffectsTable = "public.rsf_re_coeff",
  #                 writeRSFRasters = TRUE,
  #                 checkRasters = FALSE),
  survivalCLUS = list (caribou_herd_density = 0.05, # assign what is appropriate for the herd
                       nameRasCaribouHerd = "rast.caribou_herd", # raster of herd boundaries
                       tableCaribouHerd = "vat.caribou_herd_vat"), # look-up table of herd names
  disturbanceCalcCLUS = list(calculateInterval =  1, # should be 1 if using constraints on 'dist' (disturbance)
                             criticalHabitatTable = "vat.vat_bc_crithab_and_herd",
                             criticalHabRaster = "rast.bc_crithab_and_herd",
                             permDisturbanceRaster = "rast.mine_ag_wind_rail",
                             recovery = 40),
  volumebyareaReportCLUS = list (calculateInterval = 1,
                                 AreaofInterestRaster = "rast.study_area_chilcotin",
                                 AreaofInterestTable = "vat.study_area_chilcotin"),
  smcaribouAbundanceCLUS = list (nameRasSMCHerd = "rast.smc_herd_habitat", 
                                  tableSMCCoeffs = "vat.smc_coeffs"),
  uploaderCLUS = list(aoiName = 'chilcotin_caribou_plan', # name of the schema that gets uploaded to postgres
                      dbInfo  = list(keyring::key_get("vmdbhost", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbuser", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbpass", keyring="postgreSQL"),  
                                     keyring::key_get("vmdbname", keyring="postgreSQL"))
                  )
  #yieldUncertaintyCLUS = list(elevationRaster = 'rast.dem')
)

modules <- list("dataLoaderCLUS", 
                "growingStockCLUS", 
                "blockingCLUS", 
                "forestryCLUS", 
                "roadCLUS",  
                #"yieldUncertaintyCLUS", 
                "survivalCLUS", 
                "disturbanceCalcCLUS", 
                "volumebyareaReportCLUS",
                # "rsfCLUS", # error line 453 - need to debug
                "smcaribouAbundanceCLUS",
                "uploaderCLUS"
                )


# scenario = data.table (name = "chilcotin_bau",
#                        description = "Business as usual (BAU). Adjacency = 0m. Oldest first. Minimum volume: Quesnel = 150 m3/year; Williams Lake = 110 m3/year. Even harvest flow: Quesnel Matrix = 190,000m3/year; Quesnel HEWSR = 0 m3/year; Quesnel LESR = 7,000 m3/year; Quesnel LEWR = 85,000m3/year; Quesnel out = 2,100,000m3/year; Williams Lake HEWSR = 15,000m3/year; Williams Lake LESR = 70,000m3/year; Williams Lake LEWR = 140,000m3/year; Williams Lake Matrix = 140,000m3/year; Williams Lake out = 1,650,000m3/year. ")
# scenario = data.table (name = "chilcotin_scen1a",
#                        description = "Scenario 1a. Habitat: HEWSR, LESR, LEWR, Matrix. Rotation age (in habitat): 140 years. Seral stage constraints (in habitat): 25% > 140 y.o.; 30% >120 y.o.; 37% >100 y.o.; 45% >80 y.o. Adjacency = 0m. Oldest first. Minimum volume: Quesnel = 150 m3/year; Williams Lake = 110 m3/year. Target harvest flow: Quesnel Matrix = 190,000m3/year; Quesnel HEWSR = 0 m3/year; Quesnel LESR = 7,000 m3/year; Quesnel LEWR = 85,000m3/year; Quesnel out = 2,100,000m3/year; Williams Lake HEWSR = 15,000m3/year; Williams Lake LESR = 70,000m3/year; Williams Lake LEWR = 140,000m3/year; Williams Lake Matrix = 140,000m3/year; Williams Lake out = 1,650,000m3/year. ")
# scenario = data.table (name = "chilcotin_scen1b",
#                        description = "Scenario 1b. Habitat: HEWSR, LESR, LEWR. Rotation age (in habitat): 120 years. Seral stage constraints (in habitat): 25% > 120 y.o.; 30% >100 y.o.; 37% >80 y.o. Adjacency = 0m. Oldest first. Minimum volume: Quesnel = 150 m3/year; Williams Lake = 110 m3/year. Target harvest flow: Quesnel Matrix = 190,000m3/year; Quesnel HEWSR = 0 m3/year; Quesnel LESR = 7,000 m3/year; Quesnel LEWR = 85,000m3/year; Quesnel out = 2,100,000m3/year; Williams Lake HEWSR = 15,000m3/year; Williams Lake LESR = 70,000m3/year; Williams Lake LEWR = 140,000m3/year; Williams Lake Matrix = 140,000m3/year; Williams Lake out = 1,650,000m3/year. ")
# scenario = data.table (name = "chilcotin_scen1c",
#                        description = "Scenario 1c. Habitat: HEWSR, LESR. Rotation age (in habitat): 100 years. Seral stage constraints (in habitat): 25% > 100 y.o.; 30% > 80 y.o. Adjacency = 0m. Oldest first. Minimum volume: Quesnel = 150 m3/year; Williams Lake = 110 m3/year. Target harvest flow: Quesnel Matrix = 190,000m3/year; Quesnel HEWSR = 0 m3/year; Quesnel LESR = 7,000 m3/year; Quesnel LEWR = 85,000m3/year; Quesnel out = 2,100,000m3/year; Williams Lake HEWSR = 15,000m3/year; Williams Lake LESR = 70,000m3/year; Williams Lake LEWR = 140,000m3/year; Williams Lake Matrix = 140,000m3/year; Williams Lake out = 1,650,000m3/year. ")
# scenario = data.table (name = "chilcotin_scen2",
#                        description = "Scenario 2. Habitat: HEWSR, LESR, LEWR, Matrix. Rotation age (in habitat): 140 years. Seral stage constraints (in habitat): 25% > 140 y.o.; 30% >120 y.o.; 37% >100 y.o.; 45% >80 y.o.; 85 > 40 y.o. Adjacency = 0m. Oldest first. Minimum volume: Quesnel = 150 m3/year; Williams Lake = 110 m3/year. Target harvest flow: Quesnel Matrix = 190,000m3/year; Quesnel HEWSR = 0 m3/year; Quesnel LESR = 7,000 m3/year; Quesnel LEWR = 85,000m3/year; Quesnel out = 2,100,000m3/year; Williams Lake HEWSR = 15,000m3/year; Williams Lake LESR = 70,000m3/year; Williams Lake LEWR = 140,000m3/year; Williams Lake Matrix = 140,000m3/year; Williams Lake out = 1,650,000m3/year. ")
# scenario = data.table (name = "chilcotin_scen2a",
#                        description = "Scenario 2a. No harvest: HEWSR, LESR, Tweedsmuir Corridor, Rainbows Corridor. Rotation age (in all habitat): 140 years. Seral stage constraints (in LEWR, Matrix): 25% > 140 y.o.; 30% >120 y.o.; 37% >100 y.o.; 45% >80 y.o.; 65% > 40 y.o. Adjacency = 0m. Oldest first. Minimum volume: Quesnel = 150 m3/year; Williams Lake = 110 m3/year. Target harvest flow: Quesnel Matrix = 190,000m3/year; Quesnel HEWSR = 0 m3/year; Quesnel LESR = 7,000 m3/year; Quesnel LEWR = 85,000m3/year; Quesnel out = 2,100,000m3/year; Williams Lake HEWSR = 15,000m3/year; Williams Lake LESR = 70,000m3/year; Williams Lake LEWR = 140,000m3/year; Williams Lake Matrix = 140,000m3/year; Williams Lake out = 1,650,000m3/year. ")
# scenario = data.table (name = "chilcotin_scen2b",
#                        description = "Scenario 2b. No harvest: HEWSR, LESR (except high-low areas), Tweedsmuir Corridor, Rainbows Corridor. Rotation age (in all habitat): 140 years. Seral stage constraints (in LESR high-low areas, LEWR, Matrix): 25% > 140 y.o.; 30% >120 y.o.; 37% >100 y.o.; 45% >80 y.o.; 65% > 40 y.o. Adjacency = 0m. Oldest first. Minimum volume: Quesnel = 150 m3/year; Williams Lake = 110 m3/year. Target harvest flow: Quesnel Matrix = 190,000m3/year; Quesnel HEWSR = 0 m3/year; Quesnel LESR = 7,000 m3/year; Quesnel LEWR = 85,000m3/year; Quesnel out = 2,100,000m3/year; Williams Lake HEWSR = 15,000m3/year; Williams Lake LESR = 70,000m3/year; Williams Lake LEWR = 140,000m3/year; Williams Lake Matrix = 140,000m3/year; Williams Lake out = 1,650,000m3/year. ")
# scenario = data.table (name = "chilcotin_scen2c",
#                        description = "Scenario 2c. No harvest: HEWSR, LESR (except high-low adn highe-moderate areas), Tweedsmuir Corridor. Rotation age (in all habitat): 140 years. Seral stage constraints (in LESR high-low areas, LEWR, Matrix, Rainbows Corridor): 25% > 140 y.o.; 30% >120 y.o.; 37% >100 y.o.; 45% >80 y.o.; 65% > 40 y.o. Adjacency = 0m. Oldest first. Minimum volume: Quesnel = 150 m3/year; Williams Lake = 110 m3/year. Target harvest flow: Quesnel Matrix = 190,000m3/year; Quesnel HEWSR = 0 m3/year; Quesnel LESR = 7,000 m3/year; Quesnel LEWR = 85,000m3/year; Quesnel out = 2,100,000m3/year; Williams Lake HEWSR = 15,000m3/year; Williams Lake LESR = 70,000m3/year; Williams Lake LEWR = 140,000m3/year; Williams Lake Matrix = 140,000m3/year; Williams Lake out = 1,650,000m3/year. ")
# scenario = data.table (name = "chilcotin_scen1a_disturb",
#                        description = "Scenario 1a with closest to disturbance harvest priority. Habitat: HEWSR, LESR, LEWR, Matrix. Rotation age (in habitat): 140 years. Seral stage constraints (in habitat): 25% > 140 y.o.; 30% >120 y.o.; 37% >100 y.o.; 45% >80 y.o. Adjacency = 0m. Closest to Disturabnce, then oldest first. Minimum volume: Quesnel = 150 m3/year; Williams Lake = 110 m3/year. Target harvest flow: Quesnel Matrix = 190,000m3/year; Quesnel HEWSR = 0 m3/year; Quesnel LESR = 7,000 m3/year; Quesnel LEWR = 85,000m3/year; Quesnel out = 2,100,000m3/year; Williams Lake HEWSR = 15,000m3/year; Williams Lake LESR = 70,000m3/year; Williams Lake LEWR = 140,000m3/year; Williams Lake Matrix = 140,000m3/year; Williams Lake out = 1,650,000m3/year. ")

scenario = data.table (name = "chilcotin_bau_dead",
                       description = "Business as usual (BAU). Adjacency = 0m. Priority queue = closts to disturbance first, dead volume second, oldest third (live or dead volume). Salvage dead volume in first 10 years. Minimum volume: Quesnel = 150 m3/year. Even live harvest flow: HEWSR = 0 m3/year; LESR = 7,000 m3/year; LEWR = 85,000m3/year; Matrix = 140,000m3/year; out = 2,100,000m3/year. Dead volume targets (in first 10 years only): HEWSR = 0 m3/year; LESR = 3,500 m3/year; LEWR = 42,500m3/year; Matrix = 70,000 m3/year; out = 1,050,000 m3/year.")



harvestFlow <- rbindlist(list(data.table (compartment ="HEWSR",
                                          partition = ' vol > 150 and salvage_vol/(vol + salvage_vol) < 0.5', #  AND age > 139, 119, 99
                                          period = rep( seq (from = 1, 
                                                           to = 40, 
                                                           by = 1),
                                                     1), 
                                          flow = 0,
                                          partition_type = 'live'), # 0 m3/yr 
                              data.table (compartment ="LESR",
                                          partition = ' vol > 150 and salvage_vol/(vol + salvage_vol) < 0.5', # AND age > 139, 119
                                          period = rep( seq (from = 1, 
                                                           to = 40, 
                                                           by = 1),
                                                     1),
                                          flow = 35000,
                                          partition_type = 'live'), # 7,000 m3/yr 
                              data.table (compartment ="LESR",
                                          partition = ' salvage_vol > 150 and salvage_vol/(vol + salvage_vol) >= 0.5) ', # AND age > 139, 119
                                          period = rep( seq (from = 1, 
                                                           to = 2, 
                                                           by = 1),
                                                     1),
                                          flow = 17500,
                                          partition_type = 'dead'), # 3,500 m3/yr 
                              data.table (compartment ="LEWR",
                                          partition = ' vol > 150 and salvage_vol/(vol + salvage_vol) < 0.5', #  AND age > 139, 119
                                          period = rep( seq (from = 1, 
                                                           to = 40, 
                                                           by = 1),
                                                     1), 
                                          flow = 425000,
                                          partition_type = 'live'), # 85,000 m3/yr 
                              data.table (compartment ="LEWR",
                                          partition = ' salvage_vol > 150 and salvage_vol/(vol + salvage_vol) >= 0.5)', #  AND age > 139, 119
                                          period = rep( seq (from = 1, 
                                                           to = 2, 
                                                           by = 1),
                                                     1), 
                                          flow = 212500,
                                          partition_type = 'dead'), # 42,500 m3/yr 
                              data.table (compartment ="Matrix",
                                          partition = ' vol > 150 and salvage_vol/(vol + salvage_vol) < 0.5', # AND age > 139, 119
                                          period = rep( seq (from = 1, 
                                                           to = 40, 
                                                           by = 1),
                                                     1), 
                                          flow = 950000,
                                          partition_type = 'live'), #190,000 m3/yr 
                              data.table (compartment ="Matrix",
                                          partition = ' salvage_vol > 150 and salvage_vol/(vol + salvage_vol) >= 0.5)', # AND age > 139, 119
                                          period = rep( seq (from = 1, 
                                                           to = 2, 
                                                           by = 1),
                                                     1), 
                                          flow = 475000,
                                          partition_type = 'dead'), #95,000 m3/yr 
                              data.table (compartment ="out",
                                          partition = ' vol > 150 and salvage_vol/(vol + salvage_vol) < 0.5', 
                                          period = rep( seq (from = 1, 
                                                           to = 40, 
                                                           by = 1),
                                                     1), 
                                          flow = 10500000,
                                          partition_type = 'live'), # 2,100,000 m3/yr 
                              data.table (compartment ="out",
                                          partition = ' salvage_vol > 150 and salvage_vol/(vol + salvage_vol) >= 0.5) ', 
                                          period = rep( seq (from = 1, 
                                                           to = 2, 
                                                           by = 1),
                                                     1), 
                                          flow = 5250000,
                                          partition_type = 'dead') # 1,050,000 m3/yr 
))

#harvestFlow<-rbindlist(list(harvestFlowA,harvestFlowB,harvestFlowC)) # if > 1 harvest flow


patchSizeDist<- data.table(ndt= c(1,1,1,1,1,1,
                                  2,2,2,2,2,2,
                                  3,3,3,3,3,3,
                                  4,4,4,4,4,4,
                                  5,5,5,5,5,5), 
                           sizeClass = c(40,80,120,160,200,240), 
                           freq = c(0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.2, 0.3, 0.125, 0.125, 0.125, 0.125,
                                    0.1,0.02,0.02,0.02,0.02,0.8,
                                    0.3,0.3,0.1,0.1,0.1, 0.1))

#calb_ymodel<-readRDS(paste0(here::here(), "/R/Params/calb_ymodel.rds")) #See linkHBS_VRI_Calibration.Rmd
#calb_data4<-readRDS(paste0(here::here(), "/R/Params/calb_data.rds")) #See linkHBS_VRI_Calibration.Rmd

objects <- list(harvestFlow = harvestFlow, 
                patchSizeDist = patchSizeDist, 
                scenario = scenario)

paths <- list(cachePath = cacheDir,
              modulePath = moduleDir,
              inputPath = inputDir,
              outputPath = outputDir)

mySim <- simInit(times = times, 
                 params = parameters, 
                 modules = modules,
                 objects = objects, 
                 paths = paths)

# outputs to keep; these are tables that get used in the uploader
outputs(mySim) <- data.frame (objectName = c("harvestReport",
                                             "growingStockReport",
                                             "tableSurvivalReport",
                                             "disturbanceReport",
                                             "volumebyareaReport"
                                             ))

#Run the model 1 time
system.time({mysimout<-spades(mySim)})

#Run the model with experiment
#sims3 <- experiment(mySim, replicates = 2)

#Profile the model
#profvis::profvis({system.time({mysimout<-spades(mySim)})})


```


# Events

## Flow Chart

```{r, flow_chart}
library(SpaDES.core)
eventDiagram(mysimout)
```

## Algorithm

The general algorithm (pseudo-code) follows as:

`compartment_list`= SELECT zones FROM compartments WHERE target > 0 ORDER BY priority_compartment

FOR compartment_selected in `compartment_list`
`queue`<- SELECT pixelid, blockid FROM pixels WHERE 
            compartment = compartment_selected AND thlb > 0 AND constraint = 0                 ORDER BY priority
               
IF (`queue` > 0 )
  check constraints
ELSE 
  NEXT
        

# Data dependencies

## Input data

A SQLite db is required (output from dataloaderCLUS). A harvestFlow data.table object that includes the forest management unit (i.e., compartment, aka - 'supply block'), the partition from which the harvest flow applies (e.x., All dead pine); the year at which the flow applies and the amount of volume.

## Output data

A list of landings || blocks from when they are harvested.

# Links to other modules

dataloaderCLUS is required.

