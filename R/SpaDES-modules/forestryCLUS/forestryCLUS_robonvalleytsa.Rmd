---
title: "forestryCLUS"
author: ""
date: "08 April 2019"
output:
  html_document: 
    keep_md: yes
---

<!--
Copyright 2020 Province of British Columbia
 
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
 
http://www.apache.org/licenses/LICENSE-2.0
 
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.-->

# Overview

This module provides the logic for simulating forestry decisions on the landscape. These decisions currently involve spatializing the harvest flow objectives which include: where, when and how much to harvest. These factors help determine policies related to harvest flows, opening size, seral distrubitions, road densitites, preservation areas, silvicultural systems, etc. More sophistication to these decisions would involve looking at the costs and benefits beyond the current time period; this requires optimization or improved heuristics -- which may be considered in the future. The general overview of forestryCLUS follows.

At each time step, harvest units (pixels or blocks) are ranked according to a priority (e.g., oldest first), this constructs a queue. This queue of harvest units are then subject to various constraints meant to meet objectives for the study area. Harvest units are harvested until either a constraint is binding, the queue is exhausted or the harvest flow is met. Next, the age of the forest is advanced to the next time period and the process is repeated. 

During the simulation various reports and information surrounding each pixel can be saved/recorded or used in a summary. Note these outputs are considered expected future outcomes given the inputs developed by the anlayst.For a historical selection of harvesting activities see [cutblockSeqPrepCLUS](https://github.com/bcgov/clus/tree/master/R/SpaDES-modules/cutblockSeqPrepCLUS). Both  cutblockSeqPrepCLUS and forestryCLUS build a list of landing locations through simulation time. One is historical while the other is one possible future realization.

# Usage
This module could be a parent module?? It relies on: 
1. dataloadCLUS (set up the clusdb) 
2. blockingCLUS (preforms the pixel aggregation into harvest units)
3. growingStockCLUS (increments the age and volume in pixels)
4. (Optionally) rsfCLUS (track resource selection functions)
5. (Optionally) roadCLUS (preforms the access to the harvest units)
6. uploaderCLUS (uploades the outputs to a shiny app)


# Robson Valley TSA Scenarios
business as usual (BAU); no new constraints, caribou or otherwise; establishes the current 'baseline' or benchmark to evaluate the potential impact of 'new' actions in caribou habitat

no harvest in Columbia North, Columbia South and Frisby-Boulder critical habtiat; to support Columbia North, Columbia South and Frisby-Boulder herd planning, we run a sceanrio with no harvest in the Columbia North, Columbia South and Frisby-Boulder HEWSR and Matrix; harvest is BAU in other herds; assesses the potential maximum impact of protecting Columbia North, Columbia South and Frisby-Boulder only, assuming other herds unprotected

"ECCC" in Columbia North, Columbia South and Frisby-Boulder caribou critical habtiat; an alternative to a no harvest scenario, attemps to interpret the federal recovery strategy that stipulates no disturbance in high and low elevation critical habitat, and up to 35% disturbance in matrix habtiat; this is a possible scenario if Canada were to enact an emergency order on Columbia North, Columbia South and Frisby-Boulder only

no harvest in Hart Ranges critical habtiat; to support Hart Ranges herd planning, we run a sceanrio with no harvest in the Hart Ranges HEWSR and Matrix; harvest is BAU in other herds; assesses the potential maximum impact of protecting Hart Ranges only, assuming other herds unprotected

"ECCC" in  Hart Ranges  caribou critical habtiat; an alternative to a no harvest scenario, attemps to interpret the federal recovery strategy that stipulates no disturbance in high and low elevation critical habitat, and up to 35% disturbance in matrix habtiat; this is a possible scenario if Canada were to enact an emergency order on  Hart Ranges only

no harvest in Wells Gray S/Groundhog critical habtiat; to supportWells Gray S/Groundhog herd planning, we run a sceanrio with no harvest in the Wells Gray S/Groundhog HEWSR and Matrix; harvest is BAU in other herds; assesses the potential maximum impact of protecting Wells Gray S/Groundhog only, assuming other herds unprotected

"ECCC" in  Wells Gray S/Groundhog caribou critical habtiat; an alternative to a no harvest scenario, attemps to interpret the federal recovery strategy that stipulates no disturbance in high and low elevation critical habitat, and up to 35% disturbance in matrix habtiat; this is a possible scenario if Canada were to enact an emergency order on  Hart Ranges only

no harvest in caribou critical habtait areas; where there is cirtical habitat, no harvest in any types (including matrix); establishes the 'maximum impact' that protection of caribou habitat might potentially have on forest harvest; in Robson Valley TSA these include Columbia North HEWSR, Columbia North Matrix, Wells Gray SOuth Matrix, Wells Gray South HEWSR, Hart Ranges HEWSR, Hart Ranges Matrix, North Cariboo HEWSR, North Cariboo Matrix, Redrock-Prairie Creek HESR, Redrock-Prairie Creek Matrix

'ECCC' in caribou critical habtait areas; an alternative to a no harvest scenario, attemps to interpret the federal recovery strategy that stipulates no disturbance in high and low eleavtion cirtcial habitat, and up to 35% disturabnce in matrix habtiat; this is a possible scenario if Canada were to enact an emergency order; assumes all herds protected


# Robson Valley TSA Parameters 

## New Caribou Zone Constraints
BAU = beo, vqo, wha, uwr, fsw, parks and protected areas, community watersheds 

No harvest in all herds = "rast.zone_cond_noharvest_columbia_north_crithab_or_herd",
                          "rast.zone_cond_noharvest_wells_gray_south_crithab_or_herd",
                          "rast.zone_cond_noharvest_hart_ranges_crithab_or_herd",
                          "rast.zone_cond_noharvest_north_cariboo_crithab_or_herd",
                          "rast.zone_cond_noharvest_redrock_prairie_creek_crithab_or_herd",

ECCC in all herds = "rast.zone_cond_eccc_columbia_north_crithab_or_herd",
                          "rast.zone_cond_eccc_wells_gray_south_crithab_or_herd",
                          "rast.zone_cond_eccc_hart_ranges_crithab_or_herd",
                          "rast.zone_cond_eccc_north_cariboo_crithab_or_herd",
                          "rast.zone_cond_eccc_redrock_prairie_creek_crithab_or_herd"

No harvest in Columbia North, Columbia South and Frisby-Boulder =
"rast.zone_cond_noharvest_columbia_north_crithab_or_herd"

ECCC in Columbia North, Columbia South and Frisby-Boulder = "rast.zone_cond_eccc_columbia_north_crithab_or_herd"

No harvest in Hart Ranges = "rast.zone_cond_noharvest_hart_ranges_crithab_or_herd"

ECCC in Hart Ranges = rast.zone_cond_eccc_hart_ranges_crithab_or_herd

No harvest in Wells Gray S/Groundhog = rast.zone_cond_noharvest_wells_gray_south_crithab_or_herd

ECCC in Wells Gray S/Groundhog = rast.zone_cond_eccc_wells_gray_south_crithab_or_herd

## 'harvestPriority' parameter 
- used oldest first, not clear from pdp or determination what the priority queue was 

- as alternative,  could focus on minimizzing 'disturabnce; for caribou, then older, higher volume stands
  - 'dist, age DESC, vol DESC' priortize based on:
      - 'dist', i.e., distance to disturbed pixel (closest first), then
      - 'age DESC', i.e., descending age (oldest first), then
      - 'vol DESC', i.e., descending volume (highest volume first)

## 'harvestFlow'
- based on interpretation of analysis report, I tested a harvest flow of 350,000m^3^/year (1,750,000m^3^/5-year); then down to 300,000, 275,000, 285,000, 280,000

in pdp adjacency or min harvest criteria were

- I used 150 m3/ha as minimum harvest volume instead

- For cutblock adjacency, I used 3 m adjacncey

## Modify Constraints
```{r, zone_update}
library (DBI)
# STEP 1: Connect to the clusdb.sqlite database for the AOI
clusdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/Robson_Valley_TSA_clusdb.sqlite")) # connext to clusdb -- set the locations of the sqlite

# STEP 2: View the constraints available to a zone
zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_du9_scenarios'") 
zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_cond_eccc_wells_gray_south_crithab_or_herd'") 
zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_cond_bc_columbia_north_crithab'") 
zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_smc_zones_20210315'") 



# WELLS GRAY SOUTH Update the constraints available to a zone as specified in the scenario
#Below will set WGS old, recruit and buffer as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 15) OR (zoneid = 30) OR (zoneid = 59)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 76") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 76")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR (zoneid = 7) OR (zoneid = 10) OR (zoneid = 14) OR (zoneid = 19) OR (zoneid = 22) OR (zoneid = 25) OR (zoneid = 34) OR (zoneid = 37) OR (zoneid = 40) OR (zoneid = 58) OR (zoneid = 64) OR (zoneid = 68) OR (zoneid = 71) OR (zoneid = 75)") 
#Below will set WGS old and recruit as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 15) OR (zoneid = 30)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 76") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 76")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR (zoneid = 7) OR (zoneid = 10) OR (zoneid = 14) OR (zoneid = 19) OR (zoneid = 22) OR (zoneid = 25) OR (zoneid = 34) OR (zoneid = 37) OR (zoneid = 40) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 64) OR (zoneid = 68) OR (zoneid = 71) OR (zoneid = 75)") 
# Below makes the matrix habitat available to harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_eccc_wells_gray_south_crithab_or_herd' AND zoneid = 2")
#Below will set Wells Gray South HEWSR as no harvest and matrix as 12% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_bc_wells_gray_south_crithab' AND zoneid = 2 ")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_wells_gray_south_crithab' AND zoneid = 2 ")
#Below will set high priority stand types in Wells Gray South HEWSR high, medium and low priority areas as no harvest and matrix as 15% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115) OR (zoneid = 116) OR (zoneid = 118)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115) OR (zoneid = 116) OR (zoneid = 118)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 30) OR (zoneid = 36) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 67) OR (zoneid = 68) OR (zoneid = 69) OR (zoneid = 70) OR (zoneid = 79) OR (zoneid = 80) OR (zoneid = 81) OR (zoneid = 82) OR (zoneid = 96) OR (zoneid = 97) OR (zoneid = 102)") 
#Below will set high priority stand types in Wells Gray South HEWSR high and medium priority areas as no harvest and matrix as 15% disturbance (no buffer); NOTE No medium zones in TSA
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 30) OR (zoneid = 36) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 67) OR (zoneid = 68) OR (zoneid = 69) OR (zoneid = 70) OR (zoneid = 79) OR (zoneid = 80) OR (zoneid = 81) OR (zoneid = 82) OR (zoneid = 96) OR (zoneid = 97) OR (zoneid = 102) OR (zoneid = 116) OR (zoneid = 118)") 


# COLUMBIA NORTH Update the constraints available to a zone as specified in the scenario
#Below will set Columbia North old, recruit and buffer as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR (zoneid = 19) OR (zoneid = 34) OR (zoneid = 48)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 63) OR (zoneid = 64)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 63) OR (zoneid = 64)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 5) OR (zoneid = 6) OR (zoneid = 15) OR (zoneid = 20) OR (zoneid = 21) OR (zoneid = 30) OR (zoneid = 35) OR (zoneid = 36) OR (zoneid = 61) OR (zoneid = 65) OR (zoneid = 66) OR (zoneid = 67) OR (zoneid = 69) OR (zoneid = 76)") 
#Below will set Columbia North old and recruit as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR (zoneid = 19)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 63) OR (zoneid = 64)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 63) OR (zoneid = 64)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 5) OR (zoneid = 6) OR (zoneid = 20) OR (zoneid = 21) OR (zoneid = 35) OR (zoneid = 36) OR (zoneid = 61) OR (zoneid = 65) OR (zoneid = 66) OR (zoneid = 67) OR (zoneid = 69) OR (zoneid = 34) OR (zoneid = 48) OR (zoneid = 76)") 
#Below will set Columbia North HEWSR as no harvest and matrix as 12% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_bc_columbia_north_crithab' AND zoneid = 1")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_columbia_north_crithab' AND zoneid = 1")
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_cond_bc_columbia_north_crithab' AND zoneid = 1")
#Below will set high priority stand types in Columbia North HEWSR high, medium and low priority areas as no harvest and matrix as 15% disturbance (no buffer) NTOE ONLy high priority zones in this TSA
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND zoneid = 46") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND zoneid = 46") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 30) OR (zoneid = 36) OR (zoneid = 67) OR (zoneid = 68) OR (zoneid = 69) OR (zoneid = 70) OR (zoneid = 79) OR (zoneid = 80) OR (zoneid = 81) OR (zoneid = 82) OR (zoneid = 96) OR (zoneid = 97) OR (zoneid = 102) OR (zoneid = 115) OR (zoneid = 116) OR (zoneid = 118)") 














# HART RANGES Update the constraints available to a zone as specified in the scenario
#Below will set Hart Ranges old, recruit and buffer as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 7) OR (zoneid = 22) OR (zoneid = 37) OR (zoneid = 51)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 68") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 68") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR (zoneid = 10) OR (zoneid = 14) OR (zoneid = 15) OR (zoneid = 19) OR (zoneid = 25) OR (zoneid = 30) OR (zoneid = 34) OR (zoneid = 40) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 64) OR (zoneid = 71) OR (zoneid = 75) OR (zoneid = 76)") 
#Below will set Hart Ranges old and recruit forest as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 7) OR (zoneid = 22)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 68") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 68") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR (zoneid = 10) OR (zoneid = 14) OR (zoneid = 15) OR (zoneid = 19) OR (zoneid = 25) OR (zoneid = 30) OR (zoneid = 34) OR (zoneid = 40) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 64) OR (zoneid = 71) OR (zoneid = 75) OR (zoneid = 76)  OR (zoneid = 37) OR (zoneid = 51)") 
#Below will set Hart Ranges HEWSR as no harvest and matrix as 12% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_bc_hart_ranges_crithab' AND zoneid = 2 ")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_hart_ranges_crithab' AND zoneid = 2 ")
#Below will set high priority stand types in Hart Ranges HEWSR high, medium and low priority areas as no harvest and matrix as 15% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 67) OR (zoneid = 68) OR (zoneid = 69)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND zoneid = 70") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 30) OR (zoneid = 36) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 79) OR (zoneid = 80) OR (zoneid = 81) OR (zoneid = 82) OR (zoneid = 96) OR (zoneid = 97) OR (zoneid = 102) OR (zoneid = 115) OR (zoneid = 116) OR (zoneid = 118)") 
#Below will set high priority stand types in Hart Ranges HEWSR high and medium priority areas as no harvest and matrix as 15% disturbance (no buffer); NOTE there is only low priority HEWSR in this TSA
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND zoneid = 70") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 30) OR (zoneid = 36) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 79) OR (zoneid = 80) OR (zoneid = 81) OR (zoneid = 82) OR (zoneid = 96) OR (zoneid = 97) OR (zoneid = 102) OR (zoneid = 115) OR (zoneid = 116) OR (zoneid = 118) OR (zoneid = 67) OR (zoneid = 68) OR (zoneid = 69)") 






# NORTH CARIBOO Update the constraints available to a zone as specified in the scenario
#Below will set North Cariboo old, recruit and buffer as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 10) OR (zoneid = 25) OR (zoneid = 40) OR (zoneid = 54)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 71") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 71") 
#Below will set North Cariboo old and recruit as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 10) OR (zoneid = 25)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 71") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 71") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR (zoneid = 7) OR (zoneid = 14) OR (zoneid = 15) OR (zoneid = 19) OR (zoneid = 22) OR (zoneid = 30) OR (zoneid = 34) OR (zoneid = 37) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 64) OR (zoneid = 68) OR (zoneid = 75) OR (zoneid = 76) OR (zoneid = 40) OR (zoneid = 54)")
#Below will set North Cariboo HEWSR as no harvest and matrix as 12% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_bc_north_cariboo_crithab' AND zoneid = 2 ")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_bc_north_cariboo_crithab' AND zoneid = 2 ")
#Below will set high priority stand types in North Cariboo HEWSR high, medium and low priority areas as no harvest and matrix as 15% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 30) OR (zoneid = 36) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 67) OR (zoneid = 68) OR (zoneid = 69) OR (zoneid = 70) OR (zoneid = 96) OR (zoneid = 102) OR (zoneid = 115) OR (zoneid = 116) OR (zoneid = 118)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 79) OR (zoneid = 80) OR (zoneid = 81)")
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 82) OR (zoneid = 97)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 82) OR (zoneid = 97)") 
# Below makes priority stands in high and medium priority HESR zones no harvest, and high and medium priority matrix priority zones max 15% disturbance; core and amtrix outside of priority areas and stands available,
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 30) OR (zoneid = 36) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 67) OR (zoneid = 68) OR (zoneid = 69) OR (zoneid = 70) OR (zoneid = 96) OR (zoneid = 102) OR (zoneid = 115) OR (zoneid = 116) OR (zoneid = 118) OR (zoneid = 79) OR (zoneid = 80) OR (zoneid = 81) OR (zoneid = 97)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 82)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 82)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 82)")

















dbDisconnect(clusdb)
```


```{r module_usage}
library (SpaDES.core)
library (data.table)
source (paste0(here::here(), "/R/functions/R_Postgres.R"))

moduleDir <- file.path(paste0(here::here(), "/R/SpaDES-modules"))
inputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/inputs")) %>% reproducible::checkPath(create = TRUE)
outputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/outputs"))
cacheDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS"))
times <- list(start = 0, end = 40) # 5 year interval; 200 years = 40 intervals
parameters <- list(
  .progress = list(type = NA, interval = NA),
  .globals = list(),
  dataLoaderCLUS = list (  dbName='clus',
                           save_clusdb = TRUE,
                           sqlite_dbname = "Robson_Valley_TSA",
                           useCLUSdb = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/Robson_Valley_TSA_clusdb.sqlite"),
                           #Study Area
                           nameBoundaryFile = "tsa_aac_bounds",
                           nameBoundaryColumn = "tsa_name",
                           nameBoundary = "Robson_Valley_TSA",
                           nameBoundaryGeom = 'wkb_geometry',
                           nameCompartmentRaster = "rast.tsa_aac_boundary",
                           nameCompartmentTable = "tsa_aac_bounds_vat",
                           nameMaskHarvestLandbaseRaster = 'rast.thlb_2020', #'rast.bc_thlb2018' 
                           nameZoneRasters = c("rast.zone_cond_beo", 
                                               "rast.zone_cond_vqo", 
                                               "rast.zone_wha_2021", #"rast.zone_cond_wha" 
                                               "rast.zone_uwr_2021", #"rast.zone_cond_uwr"
                                               "rast.zone_cond_fsw",
                                               "rast.zone_cond_nharv",
                                               "rast.zone_cond_cw",
                                          #  "rast.zone_cond_noharvest_columbia_north_crithab_or_herd"
                                          #  "rast.zone_cond_noharvest_wells_gray_south_crithab_or_herd"
                                          #  "rast.zone_cond_noharvest_hart_ranges_crithab_or_herd",
                                          # "rast.zone_cond_noharvest_north_cariboo_crithab_or_herd"
                                     # "rast.zone_cond_noharvest_redrock_prairie_creek_crithab_or_herd",
                                          # "rast.zone_cond_eccc_columbia_north_crithab_or_herd"
                                          #  "rast.zone_cond_eccc_wells_gray_south_crithab_or_herd"
                                          #  "rast.zone_cond_eccc_hart_ranges_crithab_or_herd",
                                          #  "rast.zone_cond_eccc_north_cariboo_crithab_or_herd"
                                          #  "rast.zone_cond_eccc_redrock_prairie_creek_crithab_or_herd",
                                           "rast.zone_smc_zones_20210315"
                                          #   "rast.zone_cond_bc_columbia_north_crithab"
                                          #  "rast.zone_cond_bc_wells_gray_south_crithab"
                                          #  "rast.zone_cond_bc_hart_ranges_crithab"
                                          #  "rast.zone_cond_bc_north_cariboo_crithab"
                                          #  "rast.zone_cond_bc_redrock_prairie_creek_crithab"
                                              ),
                           nameZoneTable = "zone.constraints",
                           # nameZonePriorityRaster = "rast.zone_cond_beo",
                           nameYieldsRaster = "rast.ycid_vdyp",
                           nameYieldTable = "yc_vdyp",
                           nameYieldsTransitionRaster = "rast.tipsy2018_id",
                           nameYieldTransitionTable = "yc_tipsy",
                           nameForestInventoryRaster = "rast.vri2019_id",
                           nameForestInventoryKey = "feature_id",
                           nameForestInventoryTable = "veg_comp_lyr_r1_poly2019",
                           nameForestInventoryAge = "proj_age_1",
                           nameForestInventoryHeight = "proj_height_1",
                           nameForestInventoryCrownClosure = "crown_closure",
                           nameForestInventoryTreed = "bclcs_level_2",
                           nameForestInventorySiteIndex = "site_index"),
  blockingCLUS = list(blockMethod ='pre', 
                      patchZone = 'rast.zone_cond_beo',
                      patchVariation = 6,
                      nameCutblockRaster ="rast.cns_cut_bl",
                      useLandingsArea = FALSE, 
                      useSpreadProbRas = FALSE),
  forestryCLUS = list(harvestBlockPriority = "age DESC", # "dist, age DESC, vol DESC"
                      #harvestZonePriority = "age DESC",
                      #harvestZonePriorityInterval = 1,
                      # reportHarvestConstraints = T
                      adjacencyConstraint = 3),
  growingStockCLUS = list (periodLength = 5),
  roadCLUS = list(roadMethod = 'pre', 
                  nameCostSurfaceRas = 'rast.rd_cost_surface', 
                  nameRoads =  'rast.crds_all'),
  # rsfCLUS = list (calculateInterval = 10, # at what time interval to calculate RSF
  #                 criticalHabitatTable = "public.vat_bc_crithab_and_herd",
  #                 randomEffectsTable = "public.rsf_re_coeff",
  #                 writeRSFRasters = TRUE,
  #                 checkRasters = FALSE),
  survivalCLUS = list (caribou_herd_density = 0.05, # assign what is appropriate for the herd
                       nameRasCaribouHerd = "rast.caribou_herd", # raster of herd boundaries
                       tableCaribouHerd = "public.caribou_herd_vat"), # look-up table of herd names
  disturbanceCalcCLUS = list(calculateInterval =  1, # should be 1 if using constraints on 'dist' (disturbance) 
                             criticalHabitatTable = "public.vat_bc_crithab_and_herd",
                             criticalHabRaster = "rast.bc_crithab_and_herd",
                             permDisturbanceRaster = "rast.mine_ag_wind_rail",
                             recovery = 40),
  volumebyareaReportCLUS = list (calculateInterval = 1,
                                 AreaofInterestRaster = "rast.bc_crithab_and_herd",
                                 AreaofInterestTable = "public.vat_bc_crithab_and_herd"),
  uploaderCLUS = list(aoiName = 'robsonvalley_tsa', # name of the schema that gets uploaded to postgres
                      dbInfo  = list(keyring::key_get("vmdbhost", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbuser", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbpass", keyring="postgreSQL"),  
                                     keyring::key_get("vmdbname", keyring="postgreSQL"))
                  ),
  yieldUncertaintyCLUS = list(elevationRaster = 'rast.dem')
)

modules <- list("dataLoaderCLUS", 
                "growingStockCLUS", 
                "blockingCLUS", 
                "forestryCLUS", 
                "roadCLUS",  
                #"yieldUncertaintyCLUS", 
                "survivalCLUS", 
                "disturbanceCalcCLUS", 
                # "rsfCLUS", # error line 453 - need to debug
                "volumebyareaReportCLUS",
                "uploaderCLUS"
                )

# rsf_model_coeff <- data.table (getTableQuery ("SELECT * FROM rsf_model_coeff WHERE population = 'DU7' and  species = 'caribou' and season IN ('A')"))
# rsf_model_coeff[, bounds := 'rast.bc_crithab_and_herd']



# scenario = data.table (name = "robson_bau",
#                        description = "Business-as-usual case. Harvest flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_hart_nh",
#                        description = "No harvest in all Hart Ranges critical habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency was set to 3m.")
# scenario = data.table (name = "robson_hart_ch_he0d_m15d",
#                        description = "No harvest in Hart Ranges high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Hart Ranges  matrix critical habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency was set to 3m.")
# scenario = data.table (name = "robson_hart_scen3a",
#                        description = "No harvest in old forest, recruitment forest and buffered core critical habitat areas in Hart Ranges, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Hart Ranges matrix habitat areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_hart_scen3b",
#                        description = "No harvest in old forest and recruitment forest critical habitat areas in Hart Ranges, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Hart Ranges matrix habitat areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_north_cariboo_nh",
#                        description = "No harvest in North Cariboo critical habitat that overlaps with the TSA. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_north_cariboo_he0d_m15d",
#                        description = "No harvest in North Cariboo high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in North Cariboo matrix critical habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_north_cariboo_scen3a",
#                        description = "No harvest in old forest, recruitment forest and buffered core critical habitat areas in North Cariboo, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in North Cariboo matrix habitat areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_north_cariboo_scen3b",
#                        description = "No harvest in old forest and recruitment forest critical habitat areas in North Cariboo, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in North Cariboo matrix habitat areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_wells_gray_south_nh",
#                        description = "No harvest in Wells Gray South critical habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_wells_gray_south_he0d_m15d",
#                        description = "No harvest in Wells Gray South high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Wells Gray South matrix critical habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_wells_gray_south_scen3a",
#                        description = "No harvest in old forest, recruitment forest and buffered core critical habitat areas in Wells Gray South, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Wells Gray South matrix habitat areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_wells_gray_south_scen3b",
#                        description = "No harvest in old forest and recruitment forest core critical habitat areas in Wells Gray South, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Wells Gray South matrix habitat areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_columbia_north_nh",
#                        description = "No harvest in Columbia North critical habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_columbia_north_he0d_m15d",
#                        description = "No harvest in Columbia North high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Columbia North matrix critical habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_columbia_north_scen3a",
#                        description = "No harvest in old forest, recruitment forest and buffered core critical habitat areas in Columbia North, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Columbia North matrix habitat areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_columbia_north_scen3b",
#                        description = "No harvest in old forest and recruitment forest core critical habitat areas in Columbia North, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Columbia North matrix habitat areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_wells_gray_south_he0d",
#                        description = "No harvest in Wells Gray South high elevation critical habitat; harvest allowed in matrix critical habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_columbia_north_he0d",
#                        description = "No harvest in Columbia North high elevation critical habitat; harvest allowed in matrix critical habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_hart_he0d_m12d",
#                        description = "No harvest in all Hart Ranges HEWSR critical habitat. Up to 12% forestry disturbance (no buffer) in all matrix habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_hart_hi_med_lo_priority",
#                        description = "No harvest in Hart Ranges high priority stands in high, medium and low priority HEWSR zones; harvest allowed in all matrix critical habitat up to 15% disturbance (no buffer) in forested area. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_hart_hi_med_priority",
#                        description = "No harvest in Hart Ranges high priority stands in high and medium priority HEWSR zones. harvest allowed in low priority HEWSR. Harvest allowed in all matrix critical habitat up to 15% disturbance (no buffer) in forested area. NOTE there is only low priority HEWSR in this TSA. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_north_cariboo_he0d_m12d",
#                        description = "No harvest in all North Cariboo HEWSR critical habitat. Up to 12% forestry disturbance (no buffer) in all matrix habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_north_cariboo_hi_med_lo",
#                        description = "No harvest in North Cariboo high priority stands in high, medium and low priority HEWSR zones; harvest allowed in all matrix critical habitat up to 15% disturbance (no buffer) in forested area. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_north_cariboo_hi_med",
#                        description = "No harvest in North Cariboo high priority stands in high and medium prioirty high elevation critical habitat. Harvest allowed in high and medium priority matrix critical habitat up to 15% disturbance (no buffer) in forested area. Harvest allowed in non-priority stands and low priority HEWSR and matrix areas. Note: all areas low priority except for some high priority matrix. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_wells_south_he0d_m12d",
#                        description = "No harvest in all Wells Gray South HEWSR critical habitat. Up to 12% forestry disturbance (no buffer) in all matrix habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_wells_south_hi_med_lo",
#                        description = "No harvest in Wells Gray South high priority stands in high, medium and low priority HEWSR zones; harvest allowed in all matrix critical habitat up to 15% disturbance (no buffer) in forested area. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_wells_south_hi_med",
#                        description = "No harvest in Wells Gray South high priority stands in high and medium priority HEWSR zones; harvest allowed in high and medium priority matrix critical habitat up to 15% disturbance (no buffer) in forested area. Harvest allowed in other areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_wells_south_hi",
#                        description = "No harvest in Wells Gray South high priority stands in high priority HEWSR zones; harvest allowed in high priority matrix critical habitat up to 15% disturbance (no buffer) in forested area. Harvest allowed in other areas. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")
# scenario = data.table (name = "robson_columbia_north_he0d_m12d",
#                        description = "No harvest in all Columbia North HEWSR critical habitat. Up to 12% forestry disturbance (no buffer) in all matrix habitat. Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")

scenario = data.table (name = "robson_columbia_north_hi_med_lo",
                       description = "No harvest in Columbia North high priority stands in high, medium and low priority HEWSR zones; harvest allowed in all matrix critical habitat up to 15% disturbance (no buffer) in forested area. Note: only high prioirty zones in this TSA.  Sustainable flow = 280,000m^3^/year. Oldest first priority. Adjacency = 3m.")



# BELOW ARE OLD SCENARIOS THAT NEED TO BE RE-RUN WITH NEW MODEL PARAMS
# scenario = data.table (name = "robson_colnsfb_nh",
#                        description = "No harvest in all Columbia North, Columbia South and Frisby-Boulder critical habitat. Adjacency was set to 3m.")
# scenario = data.table (name = "robson_colnsfb_ch_he0d_m15d",
#                        description = "No harvest in Columbia North, Columbia South and Frisby-Boulder high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Columbia North, Columbia South and Frisby-Boulder matrix critical habitat. Adjacency was set to 3m.")
# scenario = data.table (name = "robson_wgsgr_nh",
#                        description = "No harvest in all Wells Gray South/Groundhog critical habitat. Adjacency was set to 3m.")
# scenario = data.table (name = "robson_wgsgr_ch_he0d_m15d",
#                        description = "No harvest in Wells Gray South/Groundhog high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Wells Gray South/Groundhog matrix critical habitat. Adjacency was set to 3m.")
# scenario = data.table (name = "robson_all_nh",
#                        description = "No harvest in all critical habitat of all herds that overlap with the TSA. Adjacency was set to 3m.")
# scenario = data.table (name = "robson_all_ch_he0d_m15d",
#                        description = "No harvest in high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in matrix critical habitat of all herds that overlap the TSA. Adjacency was set to 3m.")

# scenario = data.table (name = "robson_columbia_north_he0d_m15d",
#                        description = "No harvest in Columbia North high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Columbia North matrix critical habitat. Adjacency was set to 3m.")

# scenario = data.table (name = "robson_columbia_north_ch_he10d_m15d",
#                        description = "No harvest in Columbia North high elevation critical habitat areas as defined by Bevan Ernst, maximum 35% buffered disturbance (15% harvest) in Columbia North matrix habitat areas as defined by Bevan Ernst. Adjacency was set to 3m.")



harvestFlow <- rbindlist(list(data.table(compartment ="Robson_Valley_TSA",
                                         partition = ' vol > 150 ', 
                                         period = rep( seq (from = 1, # run the 
                                                      to = 40, 
                                                      by = 1),
                                                    1), 
                                         flow = 1400000,
                                         partition_type = 'live') # 280,000m^3^/year
))  

#harvestFlow<-rbindlist(list(harvestFlowA,harvestFlowB,harvestFlowC)) # if > 1 harvest flow

patchSizeDist<- data.table(ndt= c(1,1,1,1,1,1,
                                  2,2,2,2,2,2,
                                  3,3,3,3,3,3,
                                  4,4,4,4,4,4,
                                  5,5,5,5,5,5), 
                           sizeClass = c(40,80,120,160,200,240), 
                           freq = c(0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.2, 0.3, 0.125, 0.125, 0.125, 0.125,
                                    0.1,0.02,0.02,0.02,0.02,0.8,
                                    0.3,0.3,0.1,0.1,0.1, 0.1))

#calb_ymodel<-readRDS(paste0(here::here(), "/R/Params/calb_ymodel.rds")) #See linkHBS_VRI_Calibration.Rmd
#calb_data4<-readRDS(paste0(here::here(), "/R/Params/calb_data.rds")) #See linkHBS_VRI_Calibration.Rmd

objects <- list(harvestFlow = harvestFlow, 
                patchSizeDist = patchSizeDist, 
                scenario = scenario)

paths <- list(cachePath = cacheDir,
              modulePath = moduleDir,
              inputPath = inputDir,
              outputPath = outputDir)

mySim <- simInit(times = times, 
                 params = parameters, 
                 modules = modules,
                 objects = objects, 
                 paths = paths)

# outputs to keep; these are tables that get used in the uploader
outputs(mySim) <- data.frame (objectName = c("harvestReport",
                                             "growingStockReport",
                                             "tableSurvival",
                                             "disturbanceReport",
                                             "volumebyareaReport"))

#Run the model 1 time
system.time({mysimout<-spades(mySim)})

#Run the model with experiment
#sims3 <- experiment(mySim, replicates = 2)

#Profile the model
#profvis::profvis({system.time({mysimout<-spades(mySim)})})


```

# Events

## Flow Chart

```{r, flow_chart}
library(SpaDES.core)
eventDiagram(mysimout)
```

## Algorithum

The general algorithum (pseudo-code) follows as:

`compartment_list`= SELECT zones FROM compartments WHERE target > 0 ORDER BY priority_compartment

FOR compartment_selected in `compartment_list`
`queue`<- SELECT pixelid, blockid FROM pixels WHERE 
            compartment = compartment_selected AND thlb > 0 AND constraint = 0                 ORDER BY priority
               
IF (`queue` > 0 )
  check constraints
ELSE 
  NEXT
        

# Data dependencies

## Input data

A SQLite db is required (output from dataloaderCLUS). A harvestFlow data.table object that includes the forest management unit (i.e., compartment, aka - 'supply block'), the partition from which the harvest flow applies (e.x., All dead pine); the year at which the flow applies and the amount of volume.

## Output data

A list of landings || blocks from when they are harvested.

# Links to other modules

dataloaderCLUS is required.

