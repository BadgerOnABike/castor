---
title: "fisherabmCLUS"
author: ""
date: "25 July 2022"
output:
  html_document:
    keep_md: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, results = "hold") ## TODO: use 'eval = TRUE'






```

# Overview

This is an agent based model (ABM) to simulate fisher life history on a landscape. 
For help writing in R Markdown, see https://rmarkdown.rstudio.com/.

```{r some code to acces the sqlite db}
library (DBI)
library (data.table)
library (here)
source (paste0 (here::here (), "/R/functions/R_Postgres.R"))

# connect to the db
clusdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/scenarios/test_flex2/fisherABM_test_clusdb.sqlite"))

# show tables in the db
dbListTables (clusdb)

# select all contents in a table, e.g., agents
table <- as.data.table (dbGetQuery (clusdb, "SELECT * FROM pixels"))


```



# Usage

```{r module_usage}
library (SpaDES.core)
library (data.table)
library (terra)
library (keyring)
library (tidyverse)
library (here)
source (paste0(here::here(), "/R/functions/R_Postgres.R"))

setPaths (modulePath = file.path("C:/Work/git/clus/R/SpaDES-modules/"))
getPaths() # shows where the 4 relevant paths are

times <- list (start = 0, end = 1)

#@ needs a function to simulate multiple replicates
# replicates <- 100
# see FLEX... iterations

parameters <- list(
  dataLoaderCLUS = list(dbName='clus',
                         save_clusdb = FALSE, # Set to TRUE first time running the analysis
                         sqlite_dbname = "fisherABM_test", 
                         nameBoundaryFile = "tsa_aac_bounds",
                         useCLUSdb = paste0(here::here(), "/R/scenarios/test_flex2/fisherABM_test_clusdb.sqlite"),
                         nameBoundaryColumn = "tsa_name", 
                         nameBoundary = c ("Williams_Lake_TSA"), 
                         nameBoundaryGeom = 'wkb_geometry',
                         nameCompartmentRaster = "rast.tsa_aac_boundary",
                         nameCompartmentTable = "vat.tsa_aac_bounds_vat",
                         nameMaskHarvestLandbaseRaster ='rast.thlb_2020', 
                         nameZoneRasters=c("rast.zone_cond_beo", 
                                           "rast.zone_cond_vqo", 
                                           "rast.zone_wha_2021", 
                                           "rast.zone_uwr_2021",  
                                           "rast.zone_cond_nharv", 
                                           "rast.zone_cond_fsw", 
                                           "rast.zone_cond_cw"
                              ),
                         nameZoneTable="zone.constraints", 
                         nameYieldsRaster = "rast.ycid_vdyp_2020",
                         nameYieldTable ="yc_vdyp_2020",
                         nameYieldsCurrentRaster = "rast.ycid_tipsy_current_2020",
                         nameYieldCurrentTable = "tipsy_current_prov_2020",
                         nameYieldsTransitionRaster = "rast.ycid_tipsy_prov_2020", 
                         nameYieldTransitionTable = "tipsy_prov_2020", 
                         nameForestInventoryRaster = "rast.vri2020_id", 
                         nameForestInventoryKey = "feature_id",                     
                         nameForestInventoryTable = "veg_comp_lyr_r1_poly2020",
                         nameForestInventoryAge = "proj_age_1",  
                         nameForestInventoryHeight = "proj_height_1",
                         nameForestInventoryCrownClosure = "crown_closure",
                         nameForestInventoryTreed = "bclcs_level_2",
                         nameForestInventorySiteIndex = "site_index",
                         nameForestInventoryBasalArea= "basal_area",
                         nameForestInventoryQMD = "quad_diam_125"
                    ),
  growingStockCLUS = list (periodLength = 5),
  fisherabmCLUS = list (female_max_age = 9,
                        den_target = 0.003, 
                        rest_target = 0.028,
                        move_target = 0.091,
                        reproductive_age = 2,
                        sex_ratio = 0.5,
                        female_dispersal = 785000,
                        timeInterval = 1,
                        iterations = 1)
)

scenario = data.table (name = "test",
                       description = "Testing fisher ABM.")

modules <- list ("fisherabmCLUS",
                 "growingStockCLUS",
                 "dataLoaderCLUS")

objects <- list (scenario = scenario)
inputs <- list ()
outputs <- list ()

mySim <- simInit(times = times, params = parameters, modules = modules,
                 objects = objects)

mySimOut <- spades(mySim)
```

# Parameters

Provide a summary of user-visible parameters.

```{r moduleParams, echo = FALSE, eval = TRUE}
df_params <- SpaDES.core::moduleParams("fisherabmCLUS", "C:/Work/git/clus/R/SpaDES-modules")
knitr::kable(df_params)
```

# Events

Describe what happens for each event type.

## Plotting

Write what is plotted.

## Saving

Write what is saved.

# Data dependencies

## Input data

How to obtain input data, and a description of the data required by the module.
If `sourceURL` is specified, `downloadData("fisherabmCLUS", "C:/Work/git/clus/R/SpaDES-modules")` may be sufficient.

```{r moduleInputs, echo = FALSE, eval = TRUE}
df_inputs <- SpaDES.core::moduleInputs("fisherabmCLUS", "C:/Work/git/clus/R/SpaDES-modules")
knitr::kable(df_inputs)
```

## Output data

Description of the module outputs.

```{r moduleOutputs, echo = FALSE, eval = TRUE}
df_outputs <- SpaDES.core::moduleOutputs("fisherabmCLUS", "C:/Work/git/clus/R/SpaDES-modules")
knitr::kable(df_outputs)
```

# Links to other modules

Describe any anticipated linkages to other modules.
