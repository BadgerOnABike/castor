---
title: "Moose Spatial Data"
author: "Tyler Muhly"
date: "26/08/2019"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set (echo = TRUE)
```

## Introduction
Here I provide the workflow and script for summarizing spatial data within wildlfie management units (WMUs) in British Columbia. The prupose is to provide spaital information on wildlfie habitat that can be linked to wildlife popualtion data collected in WMUs. This data can then be used to  create staistical models relating habtiat to wildlife popualtion paramters. These models help achieve the objectives of providing soem undertsadnign of how habtiat is related to popautlions, and for estimating future popualtion paramters under changing landscape conditions. 

Here I apply this workjflow to analyzing statsical realtionships between moose popuyaltion apramters and vegetation, climate and human footprint (e.g, roads) in WMUs.

I referred to the provincial moose [species account](http://a100.gov.bc.ca/appsdata/acat/documents/r1665/whr_4146_malal_1098220322301_07a33d337dd7428586868202f6bc05bd.pdf) and a moose habtait decision aid ([Wall et al. 2011](http://www.jem-online.org/index.php/jem/article/download/46/39)) for identifying habitat features important to moose and to measure in WMUs.

## Methods
Here I outline the steps for aquiring spaital data and sumamrizing habitat atributes in each managment unit (e.g., WMU). 

### Step 1: Management Boundaries
First, we need to identify the management area boundaries where we are going to summarize the habitat data. Here I am using WMUs and limited entry hunting (LEH) zones, because the focus of this particular analysis is on moose, and data on moose density is typically estimated within WMUs or LEH zones. These data can also be easily scaled up to game managment zones (GMZs). I got the spatial boundary data from the British Columbia government data warehouse (BCGW) using the [bcdata](https://github.com/bcgov/bcdata) package. WMU data can also be downloaded [here](https://catalogue.data.gov.bc.ca/dataset/wildlife-management-units) and LEH zone data can be downloaded [here](https://catalogue.data.gov.bc.ca/dataset/limited-entry-hunting-zone-polygons-1-20-000). 

```{r, management unit spatial data, echo = T, message = F, warning = F}
library (bcdata)
library (sf)
library (data.table)
# bcdata::bcdc_search ("wildlife") # can use this to search for data

# poly.wmu <- bcdc_get_data ("wildlife-management-units") # name of the data in BCGW; 
#### NOTE: this is currrntly 'broken' for some reason, so I'm accessing via geodb....

poly.wmu <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\leh_wmu_habitat.gdb",
                         layer = "wmu_bcgw_20190925")
poly.wmu <- poly.wmu [poly.wmu$REGION_RESPONSIBLE != 1,] # drop Van Isle - no moose
plot (st_geometry (poly.wmu)) # check to make sure it looks ok
wmu.habitat <- as.data.table (unique (poly.wmu$WILDLIFE_MGMT_UNIT_ID))# instantiate a data.table of unique wmu's to bind habitat values and save
names (wmu.habitat) [1] <- "wmu"
wmu.area <- as.data.table (poly.wmu) # add area to the table
wmu.area <- as.data.table (wmu.area [, c("WILDLIFE_MGMT_UNIT_ID", "FEATURE_AREA_SQM")])
wmu.area [, wmu_area_km2 := FEATURE_AREA_SQM / 1000000]
names (wmu.area) [1] <- "wmu"
wmu.area <- wmu.area [, "FEATURE_AREA_SQM" := NULL] 
setkey (wmu.area, wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0

write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")

# poly.leh <- bcdc_get_data ("limited-entry-hunting-zone-polygons-1-20-000") # name of the data in BCGW
# The LEH data is not currently accesible via the bcdata package; so I will use the download version and load that shapefile here
poly.leh <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\leh_wmu_habitat.gdb",
                         layer = "leh_zones",
                         query = "SELECT LIMITED_ENTRY_HUNTING_ZONE, MANAGEMENT_UNITS FROM leh_zones") # only select the LEH columns
poly.leh <- sf::st_transform (poly.leh, st_crs (poly.wmu))
# there a topology problem with the data; Ring Self-intersection
# st_is_valid (poly.leh) # four polygons have invalid geometry
poly.leh <- poly.leh [st_is_valid (poly.leh), ] # this drops those invalid geometries
plot (st_geometry (poly.leh)) # check to make sure it looks ok  
leh.habitat <- as.data.table (unique (poly.leh$LIMITED_ENTRY_HUNTING_ZONE))# instantiate a data.table of unique leh to bind habitat values and save
names (leh.habitat) [1] <- "leh"
write.csv (leh.habitat, "C:\\Work\\caribou\\clus_data\\moose\\leh_habitat.csv")

# game management zones (gmz's)
poly.gmz <- bcdc_get_data ("game-management-zones")
plot (st_geometry (poly.gmz)) # check to make sure it looks ok  
poly.gmz <- sf::st_transform (poly.gmz, st_crs (poly.wmu))
gmz.habitat <- as.data.table (unique (poly.gmz$GAME_MANAGEMENT_ZONE_ID))# instantiate a data.table of unique leh to bind habitat values and save
names (gmz.habitat) [1] <- "gmz"
write.csv (gmz.habitat, "C:\\Work\\caribou\\clus_data\\moose\\gmz_habitat.csv")
```

### Step 2: Compile Population Parameter Data
I took the regional moose population number, density and composition (i.e., bull:cow and calf:cow ratios) estimates obtained from stratified random block (SRB) aerial surveys between 1996 to 2015 compiled by Hatter for this analysis. 

```{r, load the moose data, echo = T, message = F, warning = F}
require (kableExtra)
require (data.table)
data.moose <- read.csv ("C:\\Work\\caribou\\clus_data\\moose\\density\\table_moose_gmz_data_1996_2015.csv") 
wmu.moose.unique <- list (unique (as.character (data.moose$wmus))) # get list of unique WMUs

# kable (data.moose, 
#        caption = "Estimated Moose Population Number, Density and composition in Wildlife Management Units (WMUs) across Brtish Columbia form 1996-2015") %>%
#   kable_styling (position = "left",
#                  bootstrap_options = c("striped", "hover", "condensed"),
#                  fixed_thead = T,
#                  full_width = F)
```

### Step 3: Summarize Spatial Habitat Data by Management Unit
I obtained spatial data from maintained, publicly accessible sources wherever possible to facilitate transparency of the analysis. The majority of the data is accessible through the BC government data portal, [DataBC](https://data.gov.bc.ca/). This approach allows others to obtain, evaluate and analyze the same data and facilitates re-analysis of updated data in the future for comparison to previous analyses. 

#### Human Landscape Disturbances
I calculated the area or density of human created landscape disturbances in each management unit. Here, I focussed on roads and cutblocks, as they represent important impacts of natural resource development on moose in particular, and wildlife in general. Roads increase human access into moose habitat, which can increase their mortality rates. Cutblocks create early seral forest, which in general supports production of shrubs and young deciduous trees that are high-qulity forage for moose. In addition, spatial data on roads and cutblocks are accessible and relatively well documented.  

##### Roads
I estimated the total length of roads in each management area using the BC governments [digital road atlas data](https://catalogue.data.gov.bc.ca/dataset/digital-road-atlas-dra-demographic-partially-attributed-roads). I only included 'road', 'bridge' and 'tunnel' feature types (i.e., I removed 'trail', 'ferry routes', 'snowshed', 'dam' and 'virtual' types) in the estimate. I estimated the length of each road surface type (i.e., 'loose', 'overgrown', 'paved', 'rough', 'seasonal' adn 'unknwon') in each managment area. Unfortunately, the digital road atlas does not include reliable date attributes for when roads are built, and thus roads are treated as a 'static' variable.  

```{r, road data download and attribute to management areas, echo = T, message = F, warning = F}
# roads <- bcdc_get_data ("digital-road-atlas-dra-demographic-partially-attributed-roads") # name of the data in BCGW; again, not working; so loadign form BCGW via a gdb
roads <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\leh_wmu_habitat.gdb",
                         layer = "roads_dra_20190925")

## Removing 'trail', 'ferry routes', 'snowshed', 'dam' and 'virtual' linear feature types ##
roads <- roads [roads$FEATURE_TYPE == "Road" | roads$FEATURE_TYPE == "Bridge" | roads$FEATURE_TYPE == "Tunnel",]

# intersect roads with wmu and retuns lines with WMU values
wmu.roads <- sf::st_intersection (roads, poly.wmu ["WILDLIFE_MGMT_UNIT_ID"]) # just intersect the WMU name
table.wmu.roads <- as.data.table (wmu.roads)
table.wmu.roads.sum <- table.wmu.roads %>% 
                        group_by (WILDLIFE_MGMT_UNIT_ID, ROAD_SURFACE) %>%
                        summarise (length_m = sum (FEATURE_LENGTH_M)) # calculate length of each road type
names (table.wmu.roads.sum) [names (table.wmu.roads.sum) == "WILDLIFE_MGMT_UNIT_ID"] <- "wmu"

## these next steps left-join the road length data to wmu data ##
### Subset the road types ###
#### LOOSE ####
table.wmu.loose.roads.sum <- table.wmu.roads.sum [table.wmu.roads.sum$ROAD_SURFACE == "loose", ]
setkey (as.data.table (table.wmu.loose.roads.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.loose.roads.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "length_m"] <- "road_loose_meters"
wmu.habitat <- wmu.habitat [, "ROAD_SURFACE" := NULL] 
rm (table.wmu.loose.roads.sum)
gc ()

#### Overgrown ####
table.wmu.og.roads.sum <- table.wmu.roads.sum [table.wmu.roads.sum$ROAD_SURFACE == "overgrown", ]
setkey (as.data.table (table.wmu.og.roads.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.og.roads.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "length_m"] <- "road_overgrown_meters"
wmu.habitat <- wmu.habitat [, "ROAD_SURFACE" := NULL] 
rm (table.wmu.og.roads.sum)
gc ()

#### Paved ####
table.wmu.pvd.roads.sum <- table.wmu.roads.sum [table.wmu.roads.sum$ROAD_SURFACE == "paved", ]
setkey (as.data.table (table.wmu.pvd.roads.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.pvd.roads.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "length_m"] <- "road_paved_meters"
wmu.habitat <- wmu.habitat [, "ROAD_SURFACE" := NULL] 
rm (table.wmu.pvd.roads.sum)
gc ()

#### Rough ####
table.wmu.rough.roads.sum <- table.wmu.roads.sum [table.wmu.roads.sum$ROAD_SURFACE == "rough", ]
setkey (as.data.table (table.wmu.rough.roads.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.rough.roads.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "length_m"] <- "road_rough_meters"
wmu.habitat <- wmu.habitat [, "ROAD_SURFACE" := NULL] 
rm (table.wmu.rough.roads.sum)
gc ()

#### Seasonal ####
table.wmu.seas.roads.sum <- table.wmu.roads.sum [table.wmu.roads.sum$ROAD_SURFACE == "seasonal", ]
setkey (as.data.table (table.wmu.seas.roads.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.seas.roads.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "length_m"] <- "road_seasonal_meters"
wmu.habitat <- wmu.habitat [, "ROAD_SURFACE" := NULL] 
rm (table.wmu.seas.roads.sum)
gc ()

#### Unknown ####
table.wmu.seas.unk.sum <- table.wmu.roads.sum [table.wmu.roads.sum$ROAD_SURFACE == "unknown", ]
setkey (as.data.table (table.wmu.seas.unk.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.seas.unk.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "length_m"] <- "road_unknown_meters"
wmu.habitat <- wmu.habitat [, "ROAD_SURFACE" := NULL] 
rm (table.wmu.seas.unk.sum)
gc ()

# save the data
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")

rm (table.wmu.roads, table.wmu.roads.sum, wmu.roads)
gc ()
```

##### Cutblocks
I estimated the area of cutblocks in each management area using the BC governments [consolidated cutblock data ](https://catalogue.data.gov.bc.ca/dataset/harvested-areas-of-bc-consolidated-cutblocks-). I calculated the amount of area cut each year from 1960 to 2018, and the area cut between 1950 to 1959 and prior to 1950. 

```{r, cutblock data download and attribute to management areas, echo = T, message = F, warning = F}
# cutblocks <- bcdc_get_data ('b1b647a6-f271-42e0-9cd0-89ec24bce9f7', resource = '66656966-8af6-4e32-8de1-b79c63cae40f') # name of the data in BCGW; I noticed there are 413451 rows form here, whereas 446,987 in the BCGW; not sure why they are different, but this version likely underestimates the area of cutblocks; so I used teh BCGW data again....
cutblocks <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\leh_wmu_habitat.gdb",
                          layer = "cutblocks_20190927")

# intersect cutblocks with WMU values
wmu.cutblocks <- sf::st_intersection (cutblocks, poly.wmu ["WILDLIFE_MGMT_UNIT_ID"]) # just intersect the WMU name
table.wmu.cutblocks <- as.data.table (wmu.cutblocks)
table.wmu.cutblocks.sum <- table.wmu.cutblocks %>% 
                             group_by (WILDLIFE_MGMT_UNIT_ID, HARVEST_YEAR) %>%
                             summarise (area_ha = sum (AREA_HA)) # calculate area of cut by year
names (table.wmu.cutblocks.sum) [names (table.wmu.cutblocks.sum) == "WILDLIFE_MGMT_UNIT_ID"] <- "wmu"

## these next steps left-join the cutblock data to wmu data ##
### Subset the harvest years ###
#### everything  prior to 1950 ####
table.wmu.cutblocks.lt1950.sum <- table.wmu.cutblocks.sum [table.wmu.cutblocks.sum$HARVEST_YEAR < 1950, ] # filter out the years
table.wmu.cutblocks.lt1950.sum <- table.wmu.cutblocks.lt1950.sum %>% # summarize area across years
                                       group_by (wmu) %>%
                                       summarise (area_ha = sum (area_ha))
setkey (as.data.table (table.wmu.cutblocks.lt1950.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.cutblocks.lt1950.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "area_ha"] <- "cutblocks_lt1950_area_ha"
rm (table.wmu.cutblocks.lt1950.sum)
gc ()

#### 1950 to 1959 ####
table.wmu.cutblocks.1950to1959.sum <- table.wmu.cutblocks.sum [table.wmu.cutblocks.sum$HARVEST_YEAR > 1949 & table.wmu.cutblocks.sum$HARVEST_YEAR < 1960, ]
table.wmu.cutblocks.1950to1959.sum <- table.wmu.cutblocks.1950to1959.sum %>% 
                                       group_by (wmu) %>%
                                       summarise (area_ha = sum (area_ha))
setkey (as.data.table (table.wmu.cutblocks.1950to1959.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.cutblocks.1950to1959.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "area_ha"] <- "cutblocks_1950to1959_area_ha"
rm (table.wmu.cutblocks.1950to1959.sum)
gc ()

#### 1960 ####
table.wmu.cutblocks.1960.sum <- table.wmu.cutblocks.sum [table.wmu.cutblocks.sum$HARVEST_YEAR == 1960, ]
setkey (as.data.table (table.wmu.cutblocks.1960.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.cutblocks.1960.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "area_ha"] <- "cutblocks_1960_area_ha"
wmu.habitat <- wmu.habitat [, "HARVEST_YEAR" := NULL] 
rm (table.wmu.cutblocks.1960.sum)
gc ()

# all years in between.....

#### 2018 ####
table.wmu.cutblocks.2018.sum <- table.wmu.cutblocks.sum [table.wmu.cutblocks.sum$HARVEST_YEAR == 2018, ]
setkey (as.data.table (table.wmu.cutblocks.2018.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.cutblocks.2018.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "area_ha"] <- "cutblocks_2018_area_ha"
wmu.habitat <- wmu.habitat [, "HARVEST_YEAR" := NULL] 
rm (table.wmu.cutblocks.2018.sum)
gc ()

# save the data
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
```

#### Natural Landscape Disturbances
I calculated the area of fire and insect disturbances in each management unit. Both disturabnce types likely have a signficant influence on moose, as they create early seral forest that may increase forage quantity for moose in an area. Conversely, they remove forest cover acorss large areas, and can potentially reduce the amount of security and thermal cover available to moose.

#### Fire
I obtained [historic](https://catalogue.data.gov.bc.ca/dataset/fire-perimeters-historical) and [current (2019)](https://catalogue.data.gov.bc.ca/dataset/fire-locations-current) fire perimeter data collected by the BC government. These data map the maximum spatial extent of burned areas, but do not map the intensity of burned areas within them, and  there may be areas within the perimeters that did not burn. Therefore, I use it as an indicator of the amount of burnt area, and not an absolute value. 

```{r, fire perimeter data download and attribute to management areas, echo = T, message = F, warning = F}
library (bcdata)
# fire.historic <- bcdc_get_data ('fire-perimeters-historical') 
# fire.current <- bcdc_get_data ('fire-perimeters-current') 

fire.historic <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\leh_wmu_habitat.gdb",
                             layer = "fire_historic_20190930")
fire.current <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\leh_wmu_habitat.gdb",
                             layer = "fire_current_20190930")

# intersect fire perims with WMU values
wmu.fire.historic <- sf::st_intersection (fire.historic, poly.wmu ["WILDLIFE_MGMT_UNIT_ID"]) # just intersect the WMU name
wmu.fire.current <- sf::st_intersection (fire.current, poly.wmu ["WILDLIFE_MGMT_UNIT_ID"]) 

table.wmu.fire.historic <- as.data.table (wmu.fire.historic)
table.wmu.fire.historic.sum <- table.wmu.fire.historic %>% 
                             group_by (WILDLIFE_MGMT_UNIT_ID, FIRE_YEAR) %>%
                             summarise (area_m2 = sum (FEATURE_AREA_SQM))
names (table.wmu.fire.historic.sum) [names (table.wmu.fire.historic.sum) == "WILDLIFE_MGMT_UNIT_ID"] <- "wmu"

table.wmu.fire.current <- as.data.table (wmu.fire.current)
table.wmu.fire.current.sum <- table.wmu.fire.current %>% 
                             group_by (WILDLIFE_MGMT_UNIT_ID) %>%
                             summarise (area_m2 = sum (FEATURE_AREA_SQM))
names (table.wmu.fire.current.sum) [names (table.wmu.fire.current.sum) == "WILDLIFE_MGMT_UNIT_ID"] <- "wmu"

## these next steps left-join the fire data to wmu data ##


### Subset the fire years ###
### Current ###
setkey (as.data.table (table.wmu.fire.current.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.fire.current.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "area_m2"] <- "fire_2019_area_m2"
rm (table.wmu.fire.current.sum)
gc ()

#### everything prior to 1950 ####
table.wmu.fire.lt1950.sum <- table.wmu.fire.historic.sum [table.wmu.fire.historic.sum$FIRE_YEAR < 1950, ] # filter out the years
table.wmu.fire.lt1950.sum <- table.wmu.fire.lt1950.sum %>% # summarize area across years
                                       group_by (wmu) %>%
                                       summarise (area_m2 = sum (area_m2))
setkey (as.data.table (table.wmu.fire.lt1950.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.fire.lt1950.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "area_m2"] <- "fire_lt1950_area_m2"
rm (table.wmu.fire.lt1950.sum)
gc ()

#### 1950 to 1959 ####
table.wmu.fire.1950to1959.sum <- table.wmu.fire.historic.sum [table.wmu.fire.historic.sum$FIRE_YEAR > 1949 & table.wmu.fire.historic.sum$FIRE_YEAR < 1960, ] # filter out the years
table.wmu.fire.1950to1959.sum <- table.wmu.fire.1950to1959.sum %>% # summarize area across years
                                       group_by (wmu) %>%
                                       summarise (area_m2 = sum (area_m2))
setkey (as.data.table (table.wmu.fire.1950to1959.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.fire.1950to1959.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "area_m2"] <- "fire_1950to1959_area_m2"
rm (table.wmu.fire.1950to1959.sum)
gc ()

#### 1960 ####
table.wmu.fire.1960.sum <- table.wmu.fire.historic.sum [table.wmu.fire.historic.sum$FIRE_YEAR == 1960, ] # filter out the years
setkey (as.data.table (table.wmu.fire.1960.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.fire.1960.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "area_m2"] <- "fire_1960_area_m2"
wmu.habitat <- wmu.habitat [, "FIRE_YEAR" := NULL]
rm (table.wmu.fire.1960.sum)
gc ()

### and all between.... ###

#### 2018 ####
table.wmu.fire.2018.sum <- table.wmu.fire.historic.sum [table.wmu.fire.historic.sum$FIRE_YEAR == 2018, ]
setkey (as.data.table (table.wmu.fire.2018.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.fire.2018.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
names (wmu.habitat) [names (wmu.habitat) == "area_m2"] <- "fire_2018_area_m2"
wmu.habitat <- wmu.habitat [, "FIRE_YEAR" := NULL]
rm (table.wmu.fire.2018.sum)
gc ()

# save the data
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")

```

#### Beetle Disturbances
I measured insect disturbance in management areas using data collected by the government of British Columbia using aerial survey  [methods](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/forest-health/aerial-overview-surveys/methods). Data are accessible through an [FTP site](https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/), and I downloaded annual datsets from 1999 to 2017.  

I summarized the area of moderate (11 to 29%), severe (30 to 49%) and very severe (>50%) levels of disturbance from bettle's including: mountain pine beetle, spruce beetle, Dougals fir beetle, western balsam bark beetle and western pine beetle in each WMU. 

```{r, forest health data download and attribute beetle disturbance to management areas, echo = T, message = F, warning = F}
library (downloader)
library (sf)
library (data.table)
library (dplyr)

# Download data; this is an example; do these for each year
download ("https://www.for.gov.bc.ca/ftp/HFP/external/!publish/Aerial_Overview/1999/shape/Prov_Shape.zip", 
            dest = "C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
            mode = "wb")
unzip ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip", 
       exdir = "C:\\Work\\caribou\\clus_data\\forest_health\\1999")
file.remove ("C:\\Work\\caribou\\clus_data\\forest_health\\1999\\shape.zip")

#################
# 1999 to 2018 #
###############
fh.2018 <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\forest_health\\2018\\AOS_2018_Poly_Jan21.shp")
bark.beetles.2018 <- dplyr::filter (fh.2018, FHF == "IB" | FHF == "IBB" | FHF == "IBD" |
                                             FHF == "IBM" | FHF == "IBS" | FHF == "IBI" |
                                             FHF == "IBW")
bark.beetles.vs.2018 <- dplyr::filter (bark.beetles.2018, SEVERITY == "V")
bark.beetles.s.2018 <- dplyr::filter (bark.beetles.2018, SEVERITY == "S")
bark.beetles.m.2018 <- dplyr::filter (bark.beetles.2018, SEVERITY == "M")
st_crs (bark.beetles.vs.2018) = 3005
wmu.bark.beetles.vs.2018 <- sf::st_intersection (bark.beetles.vs.2018, poly.wmu ["WILDLIFE_MGMT_UNIT_ID"])
table.wmu.bark.beetles.vs.2018 <- as.data.table (wmu.bark.beetles.vs.2018)  
table.wmu.bark.beetles.vs.2018.sum <- table.wmu.bark.beetles.vs.2018 %>% 
                                          group_by (WILDLIFE_MGMT_UNIT_ID) %>%
                                          summarise (beetle_2018_vs_area_ha = sum (POLY_AREA))
names (table.wmu.bark.beetles.vs.2018.sum) [names (table.wmu.bark.beetles.vs.2018.sum) == "WILDLIFE_MGMT_UNIT_ID"] <- "wmu"

## these next steps left-join the fire data to wmu data ##
setkey (as.data.table (table.wmu.bark.beetles.vs.2018.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.bark.beetles.vs.2018.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
rm (bark.beetles.vs.2018, wmu.bark.beetles.vs.2018, table.wmu.bark.beetles.vs.2018, table.wmu.bark.beetles.vs.2018.sum, bark.beetles.vs.2018, bark.beetles.2018, fh.2018)
gc ()

# save the data
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
```

#### Vegetation
I obtained data on vegetation from the provincial government vegetation resources inventory (VRI), available [here](https://catalogue.data.gov.bc.ca/dataset/vri-forest-vegetation-composite-polygons-and-layer-1). However, I used a version 'internal' to govenrment employees, becuase the internal version included data form tree farm licenses (TFLs), that is not available in the pulbic data because TFL data is typically not public and is owned by the licensee. However, agreements have been made to put the TFL data into upcomign versions of the pulbic VRI datsets. Thus, the same data used here will eventually be made available. Here I made the choice to use the internal data to minimize teh extent of missing data in the management areas. 

```{r, VRI data download and attribute to management areas, echo = T, message = F, warning = F}
library (sf)
library (units)
library (dplyr)
poly.vri <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\caribou_habitat_model\\caribou_habitat_model.gdb",
                         layer = "vri_internal_20180725",
                         query = "SELECT FEATURE_ID, POLYGON_ID, COAST_INTERIOR_CD, SHRUB_CROWN_CLOSURE, BEC_ZONE_CODE, BEC_SUBZONE, BEC_VARIANT, CROWN_CLOSURE, SPECIES_CD_1, SPECIES_PCT_1, SPECIES_CD_2, SPECIES_PCT_2, SPECIES_CD_3, SPECIES_PCT_3, PROJ_AGE_1, PROJ_AGE_CLASS_CD_1, PROJ_AGE_2, PROJ_AGE_CLASS_CD_2, PROJ_HEIGHT_1 FROM vri_internal_20180725") # select the data fields of interest
poly.vri.clean <- poly.vri [sf::st_is_valid (poly.vri), ] # remove invalid topologies
rm (poly.vri)
gc ()

### Need to do this analysis by game management zone since the data is too large to do provincially or by region ###
poly.wmu.gmz8d <- poly.wmu [poly.wmu$GAME_MANAGEMENT_ZONE_ID == "8d" ,]
poly.wmu.gmz8d <- poly.wmu.gmz8d ["WILDLIFE_MGMT_UNIT_ID"] # drop the data fields we don't need
poly.vri.clean.gmz8d <- sf::st_intersection (poly.vri.clean, poly.wmu.gmz8d) # intersect the VRI with WMU data
poly.vri.clean.gmz8d <- poly.vri.clean.gmz8d %>% 
                            mutate (area_m2 = st_area (.) %>% # calculate area of each polygon in m2
                            as.numeric ())
tab.poly.vri.gmz8d <- as.data.table (poly.vri.clean.gmz8d) 
tab.poly.vri.gmz8d <- tab.poly.vri.gmz8d [, "SHAPE" := NULL] 
names (tab.poly.vri.gmz8d) [names (tab.poly.vri.gmz8d) == "WILDLIFE_MGMT_UNIT_ID"] <- "wmu"
tab.poly.vri.gmz8d$area_ha <- tab.poly.vri.gmz8d$area_m2 / 10000 # convert m^2 to ha
tab.poly.vri <- rbind (tab.poly.vri, tab.poly.vri.gmz8d)
rm (poly.wmu.gmz8d, poly.vri.clean.gmz8d, tab.poly.vri.gmz8d)
gc ()
write.csv (tab.poly.vri, # save the data
           "C:\\Work\\caribou\\clus_data\\moose\\table_vri_wmu.csv")
```

I summarized the area of each biogeoclimatic (BEC) zone in each management area. BEC represents broad classes of climatic and vegetation conditions. 

```{r, calculate area of BEC in each WMU, echo = T, message = F, warning = F}
library (data.table)
# tab.poly.vri.wmu <- as.data.table (read.csv ("C:\\Work\\caribou\\clus_data\\moose\\table_vri_wmu.csv"))
# tab.poly.vri.wmu [, bec_class := paste0 (BEC_ZONE_CODE, BEC_SUBZONE, BEC_VARIANT)] # use this if you want a concatenated column of BEC variant
# tab.poly.vri.wmu [, bec_subzone_c := paste0 (BEC_ZONE_CODE, BEC_SUBZONE)] # use this if you want a concatenated column of BEC subzone
# unique (tab.poly.vri.wmu$bec_subzone_c)

### Summarize by BEC zone ###
# unique (tab.poly.vri.wmu$BEC_ZONE_CODE)
tab.poly.vri.wmu.BWBS <- dplyr::filter (tab.poly.vri.wmu, BEC_ZONE_CODE == "BWBS")

tab.poly.vri.wmu.BWBS.sum <- tab.poly.vri.wmu.BWBS %>% 
                               group_by (wmu) %>%
                               summarise (bec_BWBS_area_ha = sum (area_ha))

## these next steps left-join the fire data to wmu data ##
setkey (as.data.table (tab.poly.vri.wmu.BWBS.sum), wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, tab.poly.vri.wmu.BWBS.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
rm (tab.poly.vri.wmu.BWBS.sum, tab.poly.vri.wmu.BWBS.sum, tab.poly.vri.wmu.BWBS)
gc ()

write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
```

I summarized the area of shubs in each management area. I multiplied the area of each polygon by teh crown closure of shrubs as an estimate of shrub cover in a polygon. Then I added all polygons in a WMU to calculate area of shrub cover. 

```{r, calculate area of shrub, echo = T, message = F, warning = F}
# tab.poly.vri.wmu <- as.data.table (read.csv ("C:\\Work\\caribou\\clus_data\\moose\\table_vri_wmu.csv"))
tab.poly.vri.wmu.shrub <- na.omit (tab.poly.vri.wmu,
                                        cols = ("SHRUB_CROWN_CLOSURE"),
                                        invert = FALSE) # remove NA
wmu.shrub.area <- tab.poly.vri.wmu.shrub [, .(shrub_area_ha = sum (area_ha * SHRUB_CROWN_CLOSURE)), 
                                              by = .(wmu)] 
setkey (wmu.shrub.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.shrub.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.shrub.area, tab.poly.vri.wmu.shrub)
gc () 
```

I summarized the area of forest types important for moose. This included area of: spruce and douglas fir leading forest stands aged 51 and over, in 20 year age classes (i.e., 51 to 70, 71 to 90, 91 to 110 and greater than 111 years old), spruce and douglas fir leading forest stands greater than 10 m tall and 40% crown closure (thermal cover), spruce and douglas fir leading forest stands greater than 60 years old and 40% crown closure (snow inteception cover), *Populus spp.* leading forest stands in 20 year age classes (i.e., 1 to 20, 21 to 40, 41 to 60, 61 to 80, 81 to 100, 101 to 120 and greater than 120). 

```{r, area of forest stand types, echo = T, message = F, warning = F}
# tab.poly.vri.wmu <- as.data.table (read.csv ("C:\\Work\\caribou\\clus_data\\moose\\table_vri_wmu.csv"))
# Douglas fir leading forest stands aged 51 to 70
wmu.doug.fir.50.70.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "FDI" | SPECIES_CD_1 == "FDC") & (between (PROJ_AGE_1, 51, 70)),
                                        .(doug_fir_50_70_area_ha = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.doug.fir.50.70.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.doug.fir.50.70.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.doug.fir.50.70.area)
gc () 

# Douglas fir leading forest stands aged 71 to 90
wmu.doug.fir.71.90.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "FDI" | SPECIES_CD_1 == "FDC") & (between (PROJ_AGE_1, 71, 90)),
                                        .(doug_fir_71_90_area_ha = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.doug.fir.71.90.area, wmu) 
setkey (wmu.habitat ,wmu)
wmu.habitat <- merge (wmu.habitat, wmu.doug.fir.71.90.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.doug.fir.71.90.area)
gc () 

# Douglas fir leading forest stands aged 91 to 110
wmu.doug.fir.91.110.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "FDI" | SPECIES_CD_1 == "FDC") & (between (PROJ_AGE_1, 91, 110)),
                                        .(doug_fir_91_110_area_ha = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.doug.fir.91.110.area, wmu) 
setkey (wmu.habitat ,wmu)
wmu.habitat <- merge (wmu.habitat, wmu.doug.fir.91.110.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.doug.fir.91.110.area)
gc () 

# Douglas fir leading forest stands aged >111
wmu.doug.fir.gt110.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "FDI" | SPECIES_CD_1 == "FDC") & (PROJ_AGE_1 > 111),
                                        .(doug_fir_gt110_area_ha = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.doug.fir.gt110.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.doug.fir.gt110.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.doug.fir.gt110.area)
gc () 

# Spruce leading forest stands aged 51 to 70
wmu.spruce.50.70.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "S" | SPECIES_CD_1 == "SE" | SPECIES_CD_1 == "SB" | SPECIES_CD_1 == "SW" | SPECIES_CD_1 == "SX" | SPECIES_CD_1 == "SXS" | SPECIES_CD_1 == "SS" | SPECIES_CD_1 == "SXW" | SPECIES_CD_1 == "SXW") & (between (PROJ_AGE_1, 51, 70)),
                                        .(spruce_50_70_area_ha = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.spruce.50.70.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.spruce.50.70.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.spruce.50.70.area)
gc () 

# Spruce leading forest stands aged 71 to 90
wmu.spruce.71.90.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "S" | SPECIES_CD_1 == "SE" | SPECIES_CD_1 == "SB" | SPECIES_CD_1 == "SW" | SPECIES_CD_1 == "SX" | SPECIES_CD_1 == "SXS" | SPECIES_CD_1 == "SS" | SPECIES_CD_1 == "SXW" | SPECIES_CD_1 == "SXW") & (between (PROJ_AGE_1, 71, 90)),
                                        .(spruce_71_90_area_ha = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.spruce.71.90.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.spruce.71.90.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.spruce.71.90.area)
gc () 

# Spruce leading forest stands aged 91 to 110
wmu.spruce.91.110.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "S" | SPECIES_CD_1 == "SE" | SPECIES_CD_1 == "SB" | SPECIES_CD_1 == "SW" | SPECIES_CD_1 == "SX" | SPECIES_CD_1 == "SXS" | SPECIES_CD_1 == "SS" | SPECIES_CD_1 == "SXW" | SPECIES_CD_1 == "SXW") & (between (PROJ_AGE_1, 71, 90)),
                                        .(spruce_91_110_area_ha = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.spruce.91.110.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.spruce.91.110.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.spruce.91.110.area)
gc () 

# Spruce leading forest stands > 110
wmu.spruce.gt110.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "S" | SPECIES_CD_1 == "SE" | SPECIES_CD_1 == "SB" | SPECIES_CD_1 == "SW" | SPECIES_CD_1 == "SX" | SPECIES_CD_1 == "SXS" | SPECIES_CD_1 == "SS" | SPECIES_CD_1 == "SXW" | SPECIES_CD_1 == "SXW") & (PROJ_AGE_1 > 111),
                                        .(spruce_gt110_area_ha = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.spruce.gt110.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.spruce.gt110.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.spruce.gt110.area)
gc () 

# Spruce leading forest stands 10 m tall and 40% crown closure (thermal cover)
wmu.spruce_h10_cc40.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "S" | SPECIES_CD_1 == "SE" | SPECIES_CD_1 == "SB" | SPECIES_CD_1 == "SW" | SPECIES_CD_1 == "SX" | SPECIES_CD_1 == "SXS" | SPECIES_CD_1 == "SS" | SPECIES_CD_1 == "SXW" | SPECIES_CD_1 == "SXW") & (PROJ_HEIGHT_1 > 10) & (CROWN_CLOSURE > 40),
                                        .(spruce_h10_cc40 = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.spruce_h10_cc40.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.spruce_h10_cc40.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.spruce_h10_cc40.area)
gc () 

# Doug fir leading forest stands 10 m tall and 40% crown closure (thermal cover)
wmu.doug.fir_h10_cc40.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "FDI" | SPECIES_CD_1 == "FDC") & (PROJ_HEIGHT_1 > 10) & (CROWN_CLOSURE > 40),
                                        .(doug_fir_h10_cc40 = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.doug.fir_h10_cc40.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.doug.fir_h10_cc40.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.doug.fir_h10_cc40.area)
gc () 

# Spruce leading forest stands >60 yo and 40% crown closure (snow interception)
wmu.spruce_gt60yo_cc40.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "S" | SPECIES_CD_1 == "SE" | SPECIES_CD_1 == "SB" | SPECIES_CD_1 == "SW" | SPECIES_CD_1 == "SX" | SPECIES_CD_1 == "SXS" | SPECIES_CD_1 == "SS" | SPECIES_CD_1 == "SXW" | SPECIES_CD_1 == "SXW") & (PROJ_AGE_1 > 60) & (CROWN_CLOSURE > 40),
                                        .(spruce_gt60yo_cc40.area = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.spruce_gt60yo_cc40.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.spruce_gt60yo_cc40.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.spruce_gt60yo_cc40.area)
gc () 

# Doug fir leading forest stands >60 yo and 40% crown closure (snow interception)
wmu.doug_fir_gt60yo_cc40.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "FDI" | SPECIES_CD_1 == "FDC") & (PROJ_AGE_1 > 60) & (CROWN_CLOSURE > 40),
                                        .(doug_fir_gt60yo_cc40.area = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.doug_fir_gt60yo_cc40.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.doug_fir_gt60yo_cc40.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.doug_fir_gt60yo_cc40.area)
gc () 

# Populus spp. leading forest stands 1 to 20
wmu.poplar.1to20yo.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "A" | SPECIES_CD_1 == "AC" | SPECIES_CD_1 == "ACB" | SPECIES_CD_1 == "ACT" | SPECIES_CD_1 == "AX" | SPECIES_CD_1 == "AT") & (between (PROJ_AGE_1, 1, 20)),
                                        .(poplar_1to20yo_area = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.poplar.1to20yo.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.poplar.1to20yo.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.poplar.1to20yo.area)
gc () 

# Populus spp. leading forest stands 21 to 40
wmu.poplar.21to40yo.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "A" | SPECIES_CD_1 == "AC" | SPECIES_CD_1 == "ACB" | SPECIES_CD_1 == "ACT" | SPECIES_CD_1 == "AX" | SPECIES_CD_1 == "AT") & (between (PROJ_AGE_1, 21, 40)),
                                        .(poplar_21to40yo_area = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.poplar.21to40yo.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.poplar.21to40yo.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.poplar.21to40yo.area)
gc () 

# Populus spp. leading forest stands 41 to 60
wmu.poplar.41to60yo.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "A" | SPECIES_CD_1 == "AC" | SPECIES_CD_1 == "ACB" | SPECIES_CD_1 == "ACT" | SPECIES_CD_1 == "AX" | SPECIES_CD_1 == "AT") & (between (PROJ_AGE_1, 41, 60)),
                                        .(poplar_41to60yo_area = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.poplar.41to60yo.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.poplar.41to60yo.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.poplar.41to60yo.area)
gc () 

# Populus spp. leading forest stands 61 to 80
wmu.poplar.61to80yo.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "A" | SPECIES_CD_1 == "AC" | SPECIES_CD_1 == "ACB" | SPECIES_CD_1 == "ACT" | SPECIES_CD_1 == "AX" | SPECIES_CD_1 == "AT") & (between (PROJ_AGE_1, 61, 80)),
                                        .(poplar_61to80yo_area = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.poplar.61to80yo.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.poplar.61to80yo.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.poplar.61to80yo.area)
gc () 

# Populus spp. leading forest stands 81 to 100
wmu.poplar.81to100yo.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "A" | SPECIES_CD_1 == "AC" | SPECIES_CD_1 == "ACB" | SPECIES_CD_1 == "ACT" | SPECIES_CD_1 == "AX" | SPECIES_CD_1 == "AT") & (between (PROJ_AGE_1, 81, 100)),
                                        .(poplar_81to100yo_area = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.poplar.81to100yo.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.poplar.81to100yo.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.poplar.81to100yo.area)
gc () 

# Populus spp. leading forest stands 101 to 120
wmu.poplar.101to120yo.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "A" | SPECIES_CD_1 == "AC" | SPECIES_CD_1 == "ACB" | SPECIES_CD_1 == "ACT" | SPECIES_CD_1 == "AX" | SPECIES_CD_1 == "AT") & (between (PROJ_AGE_1, 101, 120)),
                                        .(poplar_101to120yo_area = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.poplar.101to120yo.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.poplar.101to120yo.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.poplar.101to120yo.area)
gc () 

# Populus spp. leading forest stands >120
wmu.poplar.gt120yo.area <- tab.poly.vri.wmu [(SPECIES_CD_1 == "A" | SPECIES_CD_1 == "AC" | SPECIES_CD_1 == "ACB" | SPECIES_CD_1 == "ACT" | SPECIES_CD_1 == "AX" | SPECIES_CD_1 == "AT") & (PROJ_AGE_1 > 120),
                                        .(poplar_gt120yo_area = sum (area_ha)), 
                                        by = .(wmu)] 
setkey (wmu.poplar.gt120yo.area, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, wmu.poplar.gt120yo.area, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.poplar.gt120yo.area)
gc () 
```

#### Wet Areas
I estimated the total area of 'wet areas' in each WMU by calculating the area of lakes, wetlands and watercourses. These wet areas may be a useful index of food sources for important summer food sources for moose in riparian areas, lake shores and wetlands. 

##### Lakes
I calculated the area of [lakes](https://catalogue.data.gov.bc.ca/dataset/freshwater-atlas-lakes) using the freshwater atlas data. 
```{r, calculate area of lakes, echo = T, message = F, warning = F}
library (bcdata)
library (sf)
library (data.table)

# poly.lakes <- bcdc_get_data ("freshwater-atlas-lakes") # name of the data in BCGW
# plot (st_geometry (poly.lakes)) # check to make sure it looks ok; again, not working; so loadign form BCGW via a gdb
poly.lakes <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\leh_wmu_habitat.gdb",
                           layer = "fwa_lakes_20191030")
# intersect with WMU
wmu.lakes <- sf::st_intersection (poly.lakes, poly.wmu ["WILDLIFE_MGMT_UNIT_ID"]) 
table.wmu.lakes <- as.data.table (wmu.lakes)
table.wmu.lakes.sum <- table.wmu.lakes %>% 
                             group_by (WILDLIFE_MGMT_UNIT_ID) %>%
                             summarise (lake_area_ha = sum (AREA_HA)) 
names (table.wmu.lakes.sum) [names (table.wmu.lakes.sum) == "WILDLIFE_MGMT_UNIT_ID"] <- "wmu"
table.wmu.lakes.sum <- as.data.table (table.wmu.lakes.sum)
write.csv (table.wmu.lakes.sum,
           "C:\\Work\\caribou\\clus_data\\moose\\table_lake_wmu_area.csv")
setkey (table.wmu.lakes.sum, wmu) 
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.lakes.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (table.wmu.lakes.sum, table.wmu.lakes, wmu.lakes)
gc ()
```

##### Wetlands
I calculated the area of [wetlands](https://catalogue.data.gov.bc.ca/dataset/freshwater-atlas-wetlands) using the freshwater atlas data. 
```{r, calculate area of wetlands, echo = T, message = F, warning = F}
library (bcdata)
library (sf)
library (data.table)

# poly.wet <- bcdc_get_data ("freshwater-atlas-wetlands") # name of the data in BCGW
# plot (st_geometry (poly.wet)) # check to make sure it looks ok; again, not working; so loading form BCGW via a gdb
poly.wetlands <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\leh_wmu_habitat.gdb",
                              layer = "fwa_wetlands_20191030")
wmu.wetlands <- sf::st_intersection (poly.wetlands, poly.wmu ["WILDLIFE_MGMT_UNIT_ID"]) 
table.wmu.wetlands <- as.data.table (wmu.wetlands)
table.wmu.wetlands.sum <- table.wmu.wetlands %>% 
                             group_by (WILDLIFE_MGMT_UNIT_ID) %>%
                             summarise (wetland_area_ha = sum (AREA_HA))
table.wmu.wetlands.sum <- as.data.table (table.wmu.wetlands.sum)
names (table.wmu.wetlands.sum) [names (table.wmu.wetlands.sum) == "WILDLIFE_MGMT_UNIT_ID"] <- "wmu"
setkey (table.wmu.wetlands.sum, wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.wetlands.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.wet.area)
gc ()
```


##### Watercourses
I calculated the area of [watercourses](https://catalogue.data.gov.bc.ca/dataset/watercourses-trim-enhanced-base-map-ebm) using TRIM data.
```{r, calculate area of watercourses, echo = T, message = F, warning = F}
library (bcdata)
library (sf)
library (data.table)

# poly.wet <- bcdc_get_data ("freshwater-atlas-wetlands") # name of the data in BCGW
# plot (st_geometry (poly.wet)) # check to make sure it looks ok; again, not working; so loading form BCGW via a gdb
poly.watercourse <- sf::st_read (dsn = "C:\\Work\\caribou\\clus_data\\moose\\leh_wmu_habitat.gdb",
                                 layer = "fwa_watercourses_20191030")
wmu.watercourse <- sf::st_intersection (poly.watercourse, poly.wmu ["WILDLIFE_MGMT_UNIT_ID"]) 
table.wmu.watercourse <- as.data.table (wmu.watercourse)
table.wmu.watercourse.sum <- table.wmu.watercourse %>% 
                               group_by (WILDLIFE_MGMT_UNIT_ID) %>%
                               summarise (watercourse_area_ha = sum (AREA))
table.wmu.watercourse.sum <- as.data.table (table.wmu.watercourse.sum)
names (table.wmu.watercourse.sum) [names (table.wmu.watercourse.sum) == "WILDLIFE_MGMT_UNIT_ID"] <- "wmu"
setkey (table.wmu.watercourse.sum, wmu)
setkey (wmu.habitat, wmu)
wmu.habitat <- merge (wmu.habitat, table.wmu.watercourse.sum, all.x = TRUE)
wmu.habitat [is.na (wmu.habitat)] <- 0
write.csv (wmu.habitat, "C:\\Work\\caribou\\clus_data\\moose\\wmu_habitat.csv")
rm (wmu.wet.area)
gc ()
```
