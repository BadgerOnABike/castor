---
title: "Comaprison of SELES/STSM to Castor/SpaDES"
author: "Tyler Muhly, Kyle Lochhead and Kelly Izzard"
date: '2023-05-26'
output:
  html_document:
    keep_md: yes
  word_document: default
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r, load packages and data, echo = F, message = F, eval = T, include = F}
library (terra)
library (DBI)
library (keyring)
library (data.table)
library (ggplot2)
library (scales)
library (terra)
# library (rasterVis)

data.dir <- "G:\\!Workgrp\\Analysts\\tmuhly\\clus_stsm_comparison\\results"
conn <- DBI::dbConnect (RPostgreSQL::PostgreSQL(), 
                        host=keyring::key_get('vmdbhost', keyring = 'postgreSQL'), 
                        dbname = keyring::key_get('vmdbname', keyring = 'postgreSQL'), 
                        port='5432',
                        user = keyring::key_get('vmdbuser', keyring = 'postgreSQL'),
                        password = keyring::key_get('vmdbpass', keyring = 'postgreSQL'))

# Data
## TABLES
castor.harvest.flow <- data.table (dbGetQuery (conn, "SELECT * from stsm_compare.harvest"))
castor.grow.stock <- data.table (dbGetQuery (conn, "SELECT * from stsm_compare.growingstock"))
castor.preblocks <- data.table (read.csv (paste0 (data.dir, "\\castor\\blocks.csv")))
dbDisconnect (conn)

stsm.annual.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\annual_run\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.annual.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\annual_run\\growingStock.txt"), 
                                             header = TRUE))
stsm.decadal.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\decadal_run\\oScn250\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.decadal.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\decadal_run\\oScn250\\growingStock.txt"), 
                                             header = TRUE))
stsm.blocking.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\growingStock.txt"), 
                                             header = TRUE))
stsm.blocking.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.blocking.block.size <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\BlockLIst.txt"), 
                                             header = TRUE))
stsm.road.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\growingStock.txt"), 
                                             header = TRUE))
stsm.road.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.road.record <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\roadRecord.txt"), 
                                             header = TRUE))
stsm.constraint.no.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\constraints\\BaseCase_zone_test_100pct_removal\\oEvenFlow\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.constraint.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\constraints\\BaseCase_aspatial_rd0_75pct_175yrs\\oScn250\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.base.case.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\base_case_run\\BaseCase\\oScn250\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.base.case.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\base_case_run\\BaseCase\\oScn250\\growingStock.txt"), 
                                             header = TRUE))

## RASTERS
### BLOCKS
rast.castor.harvest.blocks.50.annual.133 <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\spatial_50_oldest_annual_noroads_noblocks_133600_tsa99_harvestBlocks.tif"))
rast.castor.harvest.blocks.50.block <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\oldest_decadal_noroads_blocks_tsa99_harvestBlocks_50yrs.tif"))
rast.stsm.harvest.blocks.50.annual <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\annual_run\\oScn250_1yr\\grids\\Logged_1_5.tif"))
rast.stsm.harvest.blocks.50.blocking <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_5.tif"))
rast.castor.preblocks <- terra::rast ("D:\\clus_data\\castor_stsm\\castor\\hu_blocks_no_roads.tif")

rast.stsm.blocking.harvest.blocks.1 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_1.tif"))
rast.stsm.blocking.harvest.blocks.2 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_2.tif"))
rast.stsm.blocking.harvest.blocks.3 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_3.tif"))
rast.stsm.blocking.harvest.blocks.4 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_4.tif"))
rast.stsm.blocking.harvest.blocks.5 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_5.tif"))

### ROADS
rast.castor.road.init <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\rast_roads_init.tif"))
rast.castor.road.status <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\oldest_decadal_roads_blocks_tsa99_mst_status_250.tif"))
rast.castor.road.year <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\oldest_decadal_roads_blocks_tsa99_mst_year_250.tif"))

rast.stsm.road.10 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_1.tif"))
rast.stsm.road.20 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_2.tif"))
rast.stsm.road.30 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_3.tif"))
rast.stsm.road.40 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_4.tif"))
rast.stsm.road.50 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_5.tif"))
rast.stsm.road.60 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_6.tif"))
rast.stsm.road.70 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_7.tif"))
rast.stsm.road.80 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_8.tif"))
rast.stsm.road.90 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_9.tif"))
rast.stsm.road.100 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_10.tif"))
rast.stsm.road.110 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_11.tif"))
rast.stsm.road.120 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_12.tif"))
rast.stsm.road.130 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_13.tif"))
rast.stsm.road.140 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_14.tif"))
rast.stsm.road.150 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_15.tif"))
rast.stsm.road.160 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_16.tif"))
rast.stsm.road.170 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_17.tif"))
rast.stsm.road.180 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_18.tif"))
rast.stsm.road.190 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_19.tif"))
rast.stsm.road.200 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_20.tif"))
rast.stsm.road.210 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_21.tif"))
rast.stsm.road.220 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_22.tif"))
rast.stsm.road.230 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_23.tif"))
rast.stsm.road.240 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_24.tif"))
rast.stsm.road.250 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_25.tif"))

rast.stsm.road.all <- rast.stsm.road.250 + rast.stsm.road.240 + rast.stsm.road.230 +
                      rast.stsm.road.220 + rast.stsm.road.210 + rast.stsm.road.200 + 
                      rast.stsm.road.190 + rast.stsm.road.180 + rast.stsm.road.170 + 
                      rast.stsm.road.160 + rast.stsm.road.150 + rast.stsm.road.140 +
                      rast.stsm.road.130 + rast.stsm.road.120 + rast.stsm.road.110 +
                      rast.stsm.road.100 + rast.stsm.road.90 + rast.stsm.road.80 +
                      rast.stsm.road.70 + rast.stsm.road.60 + rast.stsm.road.50 +
                      rast.stsm.road.40 + rast.stsm.road.30 + rast.stsm.road.20 + rast.stsm.road.10

### Constraints
poly.zone.constraint <- sf::st_read ("G:\\!Workgrp\\Analysts\\tmuhly\\clus_stsm_comparison\\zone_test\\zone_test.shp", quiet = T)
rast.thlb <- terra::rast (paste0 (data.dir, "\\tsa99_thlb.tif"))

```

## Introduction
The purpose of this report is to compare [Castor, a forestry and land use simulator model](https://github.com/bcgov/castor) built using the [Spatial Discrete Event Simulation (SpaDES)](https://spades-core.predictiveecology.org/) package in program R, to the Spatially Explicit
Timber Supply Model (STSM) built using the [Spatially Explicit Landscape Event Simulator  (SELES)](https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=14729e8f5430035cead9f38e708f4507c543ff9d) platform. These models were compared to test whether the Castor model approximates results from STSM when using the same input data to complete a timber supply analysis. 

STSM has been used to conduct timber supply analyses in support of allowable annual cut (AAC) determinations in British Columbia since the mid-2000's. Therefore, it has been refined over a relatively long-period of time. The high frequency in use cases has deemed it an accepted and valid model for completing timber supply reviews by the government of British Columbia. Castor was more recently developed, starting in 2017, by the Strategic Analysis Team in the Forest Analysis and Inventory Branch as an open source tool using the [R programming language](https://www.r-project.org/), which provides a relatively large user and developer base with a diversity of analytical functions (including data wrangling, statistical analyses and data visualization). To date it has primarily been used to support strategic decisions around habitat protections for species-at-risk such as caribou (*Rangifer taranadus caribou*) and fisher (*Pekania pennanti*). Therefore, Castor has not been as widely used as STSM and has not yet been approved for use in timber supply reviews.

To improve confidence in output results from Castor and support the use of Castor as a model for strategic decision making processes, possibly including timber supply reviews, we compared Castor to STSM. This comparison also provides an opportunity to explore and discuss alternative approaches to simulating timber harvest and future forest conditions. While the comparison between these models could result in numerous metrics and analyses, we focus the comparison on a primary set of metrics commonly used in timber supply modelling, namely: the volume and area harvested, average age of the stand harvested. merchantable growing stock projections, forest cover constraints and road network development.

## Methods
To compare the two models, a small area of interest (approximately 350,000 ha in size) was created in the central part of the Mackenzie timber supply area of British Columbia. Both models used the same data and information within that area, including the same forest inventory to provide current (2022) forest stand characteristics, growth and yield estimates for natural and planted stands in the inventory, estimated from the the Variable Density Yield Projection (VDYP) and Table Interpolation Program for Stand Yields (TIPSY) models, respectively, including their assumptions concerning their transitions following harvesting, and the timber harvest land base (THLB) to define the area of forest available to harvest.

### Model Framework
#### Similarities Between Castor and STSM
Castor and STSM are not optimization models, i.e., they do not search for maximum or minimums of the objective function to find timber harvest patterns that will either maximize the amount of timber volume that can be harvested or minimize the cost to harvest timber volume over time. Instead, they spatially simulate timber harvest patterns based on 'greedy' heuristics regarding harvest practices (i.e., they make short-term optimal choices), and estimate timber volume that can be harvested over time given those practices. The simple heuristic nature of these models omits any information about the future in their decision-making processes, thus these models are reactive to short term information. 

Castor and STSM are a class of model called discrete event-based simulators where events, for example, forest stand growth, forest harvesting, forest cover constraint achievement and roading, are scheduled in discrete time. Technically, any future event can be programmed in either Castor or STSM to represent some process of interest (i.e., fire, wind, drought, insect attack, seed dissemination, etc). Both models are programmed to simulate timber harvest activities based on meeting a timber volume demand, following a harvest priority queue (e.g., oldest stands first), potentially with ‘partitions’ of the volume (i.e., spatial sub-zones or ‘compartments’, or forest stand types), and within the legal requirements of the land base (i.e., satisfy the requirements of zones with rules that restrict forest harvest in some way to meet some other objective, such as wildlife habitat). Both Castor and STSM estimate timber supply outcomes by simulating changes to forests and forest harvest activity over space and time.

#### Differences Between Castor and STSM
Functionally, the models were set up the same way in terms of discrete event based simulations, but it is important to note that there are key differences between how these models are instantiated. STSM uses a combination of raster Tag Image File Format (TIFF) geo-referenced images and text tables, whereas Castor leverages database functionality by using an SQLite database containing relational tables to ease the process of scaling models to very large spatial extents. Both models have flexibility in how things like minimum harvest criteria and the harvest queue are parameterized, but how they interact with data is different due to the fundamental differences in their data structures. 

Castor's approach is to have the user input simple SQL queries of forest stand characteristics (e.g., age, volume, height) for setting model parameters. Specifically, model parameterization leverages SQL injection, which allows users familiar with SQL to navigate the model easily and intuitively. For example, the minimum harvest and age criteria used here was parameterized as ' vol > 149 AND age > 79 '. Similarly, and oldest first priority queue was parameterized as ' age DESC '. These queries were integrated into the model as parameters that were called within functions created in program R, and these functions were organized and scheduled using the SpaDES framework. The benefit of using the SpaDES package in R stems from modelling philosophies common to predictive ecology: reproducibility, reusability, transferability, interoperablility, accessibility, and continuous workflows that are routinely tested ([McIntire et al. 2022](https://besjournals.onlinelibrary.wiley.com/doi/pdfdirect/10.1111/2041-210X.14034)). Modelling outputs from Castor are visualized in a cloud-based application to allow any user with an internet connection to view and compare scenarios. The forest structure being tracked by Castor is limited by the outputs from the growth and yield models which include: forest stand age, height, species, basal area, quadratic mean diameter, and crown closure, and deciduous and coniferous merchantable volume, coarse woody debris, and various forest product yields.

STSMs approach was to use locally stored TIFFs and text files with parameter definitions specific to the [SELES modeling language](http://www.ncgia.ucsb.edu/SANTA_FE_CD-ROM/sf_papers/fall_andrew/fall.html). Data and information were organized in a specific folder structure to allow users to navigate the inputs. These get integrated into functions, and are organized and scheduled within the SELES program. The SELES program provides an interactive graphical user interface to allow users to navigate parameters and view various outputs in real time. SELES has a large library of programmed landscape events for users to leverage which makes it relatively easy to create and customize a landscape simulation. Some of these landscape events include fire, insect infestation, oil and gas development and various wildlife habitat indicators. The forest structures being tracked by STSM includes: forest stand age, height, and species, and deciduous and coniferous merchantable volume.  

Other differences between Castor and STSM worth mentioning are the development of the harvest queue and forest cover constraint achievement. STSM updates its harvest queue four times a year, whereas Castor's harvest queue was calculated once at the start of a time interval. STSM included a 'look-ahead' function, where the model determined whether a pixel (i.e., a 100 m by 100 m square, which was the spatial resolution of both models) or harvest block achieved the minimum harvest criteria (minimum 80 years old and volume 150 m^3^/ha) by the end of the time interval minus 1 year (i.e., t-1). For example, in this case it checked whether the target was achieved at year 9 of a 10 year interval, and if it met the criteria at year 9 of the interval than the stand was available for harvest at any time during the interval, otherwise it was not. Castor did not have this functionality at the time of this analysis. 

Several other important differences exist between these two models such as yield updating, harvest blocking, roading and forest cover constraints. The effects of these differences were explicitly tested in this analysis and therefore these differences are documented in more detail in their respective sections below.

#### Yield Update
The Castor and STSM models had different approaches for updating growth and yield values (e.g., volume, height) of forest stands at simulation period intervals. The effect of these different approaches on timber supply estimates was tested.  

##### Castor
The Castor model updated growth and yield estimates at the mid-point of a simulation interval. Therefore, if a simulation interval was a decade, in the first interval Castor updated the growth and yield estimates of forest stands to year five of the simulation by interpolating the estimates between the initial age and initial plus ten year age from the growth and yield model. For example, if the initial stand volume was 150 m^3^/ha at year 0 of the simulation, and 170 m^3^/ha ten years from year 0, then the Castor model would use 160 m^3^/ha as the volume estimate for the stand at the first simulation interval. Castor then updated stand age and growth and yield estimates at ten year intervals from there. For any stands that were harvested in an interval, Castor updated the stand age to 0 at the mid-point. Therefore, in subsequent mid-points the stand would age 10 years. The key point here is that the amount of volume harvested is first accounted for by Castor at the middle of the first simulation interval, not the beginning or end of the interval. This approach assumes that a stand will be harvested at some point within the interval, which relaxes the assumption around the spatial harvesting sequence within an interval.  

##### STSM
In contrast to Castor, STSM estimated growth and yield at each year of a simulation. When a simulation interval was longer than a year, STSM divided the harvest request equally by the number of years in the interval, and updated growth and yield estimates at each year when a stand was harvested in an interval. Therefore, if a stand was harvested in year one of a ten year interval, volume estimates were interpolated to the first year of the growth and yield estimates. For example, if the initial stand volume was 150 m^3^/ha at year 0 of the simulation, and 170 m^3^/ha ten years from year 0, and the stand was harvested in the first year of the interval, then the STSM model would use 152 m^3^/ha as the volume estimate for the stand at the first simulation interval. The year that each stand was harvested in an interval was then multiplied by -1 (e.g., year 1 = -1, year 2 = -2, year 3 = -3,  etc.) and then in the next interval stands were aged 10 years (i.e., stand ages became 9, 8, 7, etc.) and growth and yield estimates were updated accordingly. Therefore, in STSM the amount of volume harvested in an interval was accounted for annually and then summed across the simulation interval. This approach assumes that a stand will be harvested in a specific year and thus follows a specific spatial harvesting sequence.

#### Harvest Blocking
Scenarios with and without blocking were simulated to compare how the two models created harvest blocks, and their potential effects on harvest flow. When blocking was not simulated, both models selected harvest areas at a 1 ha spatial resolution (a pixel) using the harvest priority criteria (i.e., oldest first). Therefore, each pixel was harvested independently, in order of its age, and there was no defined spatial pattern or aggregation of pixels to form blocks.    

##### Castor
Castor used a graph-based agglomerative hierarchical clustering method to pre-define harvest blocks prior to the simulation. This method searches the landscape and groups pixels with similar forest characteristics (i.e., crown closure and height) and in close spatial proximity (i.e., Euclidean distance) into clusters defined as homogeneous forest types, subject to a patch size distribution. It evaluated whether to cluster pixels together using a multivariate distance metric (i.e., the Mahalanobis distance statistic), which measures how far an individual pixels vector of stand characteristics are from the multivariate distribution of those characteristics in neighbouring pixels. If the Mahalanobis distance was below a threshold (in this case the default value of 6), then a pixel was grouped into a cluster.

Since the method is agglomerative, pixels were iteratively grouped together one at time with neighboring pixels that had the least multivariate distance between them. The agglomeration would continue until there weren’t any similar pixels left or the maximum block size in a distribution was met. Block sizes were determined by drawing from a distribution of block sizes defined for natural disturbance types (see table below). Larger blocks were harder to find and were therefore prioritized on the landscape first and subsequently smaller blocks were added until blocking was complete. 

```{r, ndt block size table, echo = F, message = F, eval = T}
knitr::kable (data.table(ndt = c(1,1,1,1,1,1,
                                  2,2,2,2,2,2,
                                  3,3,3,3,3,3,
                                  4,4,4,4,4,4,
                                  5,5,5,5,5,5), 
                           sizeClass = c(40,80,120,160,200,240), 
                           freq = c(0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.2, 0.3, 0.125, 0.125, 0.125, 0.125,
                                    0.1,0.02,0.02,0.02,0.02,0.8,
                                    0.3,0.3,0.1,0.1,0.1, 0.1)),
               col.names = c("Natural Disturbance Type",
                             "Size Class (ha)",
                             "Frequency"),
              align = "ccc")

```

##### STSM
STSM did not pre-define harvest blocks, but instead used a spreading algorithm to create blocks during the simulation. It selected pixels as starting points for the spreading process (i.e., 'seeds'), based on the harvest priority queue. A harvest block size for each seed was selected at random from a uniform distribution (defined using the block size distribution obtained from Castor to facilitate comparison of the models). The spreading algorithm from the seeded pixel to neighbouring pixels was based on age threshold criteria, where it was only able to spread to a neighbouring pixel that was within 20% of the age of the origin pixel, up to the selected block size. Block size targets were considered 'soft', i.e., they were approximate targets, and they were required to be a minimum of 10 ha in size.   

#### Roads
Castor and STSM had different approaches to creating road networks related to forest harvest (i.e., a multiple access target problem). Simulations of both models were run to compare outputs of the roading algorithms and assess whether they achieved similar results. Below provides a description of the different approaches used by each model. 

##### Castor
Castor could simulate roads using multiple approaches, but the preferred method (after comparing and validating the approaches), described here, used a dynamic minimum spanning tree (MST). Castor pre-defined 'landings' (i.e., road targets for hauling timber) as a pixel on the edge of each pre-defined harvest block (see *Harvest Blocking*, above). Castor then simultaneously solved the least-cost path between landings, and the paths from landings to existing roads. Pixels on the edge of the area of interest that were existing roads were connected to the existing road network to work around cases where there were ‘islands’ of existing roads within the area of interest that were connected to areas outside of the area of interest. All least cost paths were solved using a computationally fast bi-directional A* algorithm that allows for multiple target locations (i.e., mills). The least cost paths followed a queen's case, where all eight neighbouring pixels were considered in a path. 

During the simulation, as harvest blocks were selected by the harvest priority queue, Castor 'built' the network of roads dynamically by connecting the landings in the selected blocks to existing roads (or the edge of the area of interest), following the identified least cost path in a MST. The MST connected all of the selected landings using [Kruskal's algorithm](https://en.wikipedia.org/wiki/Kruskal%27s_algorithm), which sorted the potential routes by their cost, and added the least costly road connections, without a loop or cycle, until the network was completed.

The least-cost path required a spatial cost-surface model as its input, where each pixel was attributed a cost of building a road based on factors such as terrain, water and land designations. The same cost-surface model was used in both the Castor model and STSM, but the relative difference in cost values were inflated for use in Castor by taking the square of the cost values. Therefore, instead of values between 1 and 62, the values were scaled between 1 and 3844. We found this was necessary to fit reasonable least-cost paths in Castor based on review of the outputs. Castor roading can be highly sensitive to the cost surface since the objective function is to minimize the cost of building roads. The purpose of this sensitivity was to model highly complex roads in complex terrain by accounting for operational considerations (i.e., switch backs).

##### STSM
STSM also pre-processed the road network, but the network was not dynamically created during a simulation, Instead the entire network was 'built' at the start of the simulation and roads were dynamically activated or deactivated during the simulation as they were needed to access blocks selected in the harvest queue.

Similar to Castor, inputs to the STSM model included a cost-surface and existing road network. In addition, STSM required the location of 'exit points' (i.e., destinations), which were locations where timber hauling ended, such as mills or the exit locations of highways from the area of interest.  

STSM pre-processed a simulated road network by sampling locations in areas of the THLB that were greater than a specified distance from an existing road (in this case 1 km). Locations further from an existing road had a higher probability of being selected. STSM then solved the road network by iteratively connecting the sampled locations to destination points following a least-cost path until all locations were within 1 km from an existing road. Therefore, an entire road network that could connect to all locations within 1 km of any portion of THLB was created prior to the simulation. During the simulation, as blocks were selected in the harvest queue, a landing was selected in the block and a straight line (as a crow flies) road was created to connect it to the road network (existing or simulated roads). The least cost paths could follow a rooks case, where neighbouring pixels in four cardinal directions were considered in a path.   

When running the STSM simulation, an additional constraint was included to weight the harvest queue to prioritize selecting blocks closer to, and within a specified distance from active roads (in this case a distance of 2 km was used) to limit the projection of “long roads”. This had the effect of limiting the extent of road development from one time interval to the next. This constraint was not implemented in Castor. 

#### Forest Cover Constraints
Here we included two scenarios to compare how Castor and STSM set aside areas to meet forest cover constraints. We created a 'dummy' management zone over the THLB in the eastern portion of the area of interest. In one scenario we set this as a no harvest zone, and in a second scenario we created a forest cover constraint where 75% of the productive forest (i.e., forested areas with a site index > 5) within the zone had to be greater than or equal to 175 years old. The no harvest scenario was run on a decadal time step and the forest cover constraint scenario was run with an annual time step to facilitate comparison.  

Both models used the same general approach to defining cover constraints, where a variable of interest (i.e., the forest stand or landscape condition that is desired), must achieve a desired threshold (i.e., greater than or less than a target value for the variable), over a specific percentage of the zone, within a land base definition (i.e., denominator) for the zone. However, there were differences in how each model selected areas to achieve forest cover constraints. These differences are described in more detail below. 

##### Castor
The Castor model set forest cover constraints by creating a binary variable that specified if a pixel in a management zone was above (0) or below (1) the constraint threshold. It then sorted the pixels based on this binary variable, and prioritized reserving pixels that met the threshold and were outside of the THLB, or that were previously reserved to meet another management zone constraint. Lastly, Castor sorted those selected pixels by the constraint parameter and reserved them until the desired threshold for the variable of interest was met. For example, in this analysis Castor prioritized reserving areas of productive forest in the zone that were greater than 175 years old and outside of the THLB, and then, if the constraint was not met (i.e., 75% of the productive forest in the zone had not been reserved), by reserving pixels in the THLB from oldest to youngest until the constraint was met. If the reserve area was not achievable, than it became a *de facto* no harvest area. Otherwise areas in the zone outside of the reserved pixels could be harvested, assuming they met the minimum harvest criteria and were selected in the harvest queue. Constraints were re-calculated at each interval of the simulation period.

##### STSM
STSM used a different approach to reserving pixels in forest cover constraint zones. First, STSM checked to see whether a constraint was met in a zone by summing the pixels above the desired threshold of the variable of interest in the area of interest. If the constraint was met (i.e., a sufficient percentage of area could be achieved to meet the constraint), then the entire reserve area became available to harvest. Otherwise, it was not harvested or it was designated as a recruitment area. In this case, a recruitment area was fully constrained (i.e., a no harvest zone) if the constraint was not met. However, if the constraint was met, then the zone was available to harvest, and harvest occurred freely in the area following the harvest queue (in this case oldest first) and subject to the merchantability criteria (in this case the minimum volume and age requirements) up until the constraint threshold was met (i.e., there was a limit on harvest). 

Consequently, in this case STSM put greater priority on reserving pixels closest to the threshold value by allowing the potential for pixels well above the threshold value to be harvested. Therefore, in this case a key difference between Castor and STSM was that STSM was more likely to allow harvest of areas well above the age threshold, whereas Castor was more likely to allow harvest of areas with a mix of age values. 

In both models, the pixels used to meet forest cover constraints did not meet any spatial configuration requirements. Pixels were reserved based only on their attribution and not their location. This may have the effect of creating fragmented reserved areas within the management zones. In cases where the spatial configuration of reserved areas is important (e.g., to create contiguous patches of habitat for wildlife), it may be valuable to add some spatial consideration to the pixel selection approach used in both models. 

We also note that STSM re-calculated constraints four times a year in a simulation, regardless of the time interval used.

### Model Parameters
In addition to using the same initial and projected forest conditions, the models were set-up with the same timber supply modeling parameters. This included a minimum harvest age of 80 years old, minimum harvest volume of 150 m^3^/ha, and no adjacency constraints. Each timber supply scenario (described below) was simulated to achieve a maximum sustainable harvest flow, i.e., the maximum volume that could be harvested across all time intervals without ever going down, over a 250 year simulation period. 

A non-declining merchantable growing stock was not considered in Castor, but was included in STSM, where the growing stock beyond year 150 could not drop more than 1% by the end of a 250 year time horizon. 

The spatial resolution of both models was 1 ha (also referred to as a *pixel*), and thus the area of interest was represented spatially as a grid of 100m by 100m pixels.

### Model Scenarios
We simulated seven scenarios:

```{r, scenario table, echo = F, message = F, eval = T}
knitr::kable (data.table(number = c(seq(1:7)),
                         name = c("Annual Harvest","Decadal Harvest", "Harvest Blocking","Roading", "No Harvest Zone", "Forest Cover Constraint", "Base Case Timber Supply"), 
                         interval = c("Annual", "Decadal", "Decadal", "Decadal", "Decadal", "Annual", "Decadal"), 
                         block = c("No", "No", "Yes", "Yes","No","No", "Yes"),
                         road = c("No", "No","No", "Yes","No", "No", "Yes"),
                         constraint = c("None","None","None","None","No Harvest","Forest Cover","None")),
               col.names = c("Scenario Number",
                             "Scenario Names",
                             "Time Interval",
                             "Harvest Blocking",
                             "Roading",
                             "Constraint Type"),
              align = "clcccc")

```

The first two scenarios had no roading and no harvest block definition, i.e., each 1 ha pixel was considered a harvest 'block'. Of these two scenarios, one was simulated with an annual time step to compare the two models without the effect of interpolating yield values between decadal periods. A second scenario was simulated with a decadal time step to show the effect of the different yield interpolation methods used by each model. The blocking and road scenarios allowed for comparison of how each model simulated harvest blocks and roads. The no harvest constraint scenario essentially removed a hypothetical forest management zone from the THLB. The forest cover constraint scenario applied an age-based constraint to the same zone. 

The timber supply base case scenario (scenario 7) fit a harvest flow following the standard timber supply analysis approach designed for STSM. The steps to determine the harvest flow in STSM were to first use a binary search algorithm to determine the maximum sustainable harvest flow, then use another binary search algorithm to iteratively test whether increases in the short-term harvest flow could be sustained without causing a reduction in the mid-term (which was set at the maximum sustainable harvest level), but limiting it to a maximum 10% difference in harvest flow between decades. Once the short-term harvest flow was determined, STSM then tested for the ability to increase the long-term harvest flow, without causing declines in the long-term growing stock. The harvest flow determined using the STSM model was then fit using the Castor model to determine if the Castor model could find the same harvest flow, and to compare the output indicators between the models. 

##	Results
The initial states of both models were checked to confirm that they were the same. The study area was 355,253 ha in size, of which 73,300 hectares was THLB, and the initial merchantable growing stock was 9,717,000 m^3^. In both models, the long-run sustained yield (LRSY) of current stands was calculated at 108,881 m^3^, the mean volume/ha was 179 m^3^ and the average mean annual increment (MAI) was 1.48 m^3^. The LRSY of managed stands was calculated at 235,930 m^3^. 

Below we compare the maximum non-declining even-flow harvest rate of each model for each scenario. As these harvest flows differed between both models, we also ran scenarios where we adjusted the Castor maximum non-declining harvest flow to fit the STSM harvest flow and compared the outputs, including average harvest age, area harvested and merchantable growing stock (i.e., amount of volume available to be harvested in the THLB).   

### Scenario 1: Annual Harvest Simulation
This scenario used an annual simulation time interval with no blocking and no roads.

#### Harvest Flow
When modeling the maximum non-declining harvest flow of each model on an annual basis, the Castor model was able to harvest approximately 136,000 m^3^ per year. STSM was able to harvest approximately 133,600 m^3^ per year. Thus, Castor was able to harvest slightly more volume (~1,400 m^3^ per year, or 2%).

```{r, annual harvest flow, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_136000", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.fig <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "volume")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_136000"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.fig)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (130000, 140000, 500)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]

```

#### Area Harvested 
When modeling a harvest flow of approximately 133,600 m^3^ per year, the Castor model and STSM had comparable harvest area patterns, i.e., peaks and troughs in area harvested over time generally coincided in both models. However, the models began to diverge slightly at approximately year 130, where STSM harvested more area than the Castor model. From that point on, while both models followed a similar general trend in area harvested (i.e., a trough between approximately years 150 to 175 and a peak at approximately year 180) there were approximately 5-year differences in the timing of the peaks and troughs. Total area harvested across the 250 year period was 121,726 ha in Castor and 124,632 ha in STSM, a 2% difference.

```{r, annual area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_133600", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.fig <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "area")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_133600"

tab.harvest.area <- rbind (tab.harvest.area, stsm.fig)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic()

# aggregate(tab.harvest.area$area, by=list(model=tab.harvest.area$model), FUN=sum)
```

#### Average Age Harvested
The Castor model and STSM harvested similar aged stands for the first 100 years when modeling a harvest flow of approximately 133,600 m^3^ per year. However, during the first 10 to 15 years of the simulation, the Castor model appears to harvest stands at maximum 250 years old, compared to STSM which harvested stands 310 to 250 years old. This was a result of the Castor model set-up to make stands greater than 250 years old equal to 250 years old to make stand ages consistent with the yield curves, i.e., the yield curves used in both models only went to 250 years old. Therefore, volumes were the same in both models for stands greater than 250 years old, but Castor tracked these stands as 250 year old stands. Despite this difference, both models harvested essentially identical aged stands from approximately year 15 to 100. The average age of harvested stands differed from years 100 to 250, where the age in the Castor model steadily increased over time, whereas the age in STSM was essentially level. This difference was likely because the Castor model was constrained to harvest at the flow reported by STSM and could potentially have harvested 2% more volume over the long-term, resulting in stands being able to age slightly more in the Castor simulation than in STSM.

```{r, annual average age harvested, echo = F, message = F, eval = T}
tab.harvest.age <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_133600", c ("scenario", "timeperiod", "age")]
tab.harvest.age$model <- "castor"

stsm.fig <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "mnHAge_1")]
names (stsm.fig) <- c ( "timeperiod", "age")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_133600"

tab.harvest.age <- rbind (tab.harvest.age, stsm.fig)

ggplot (tab.harvest.age, aes (x = timeperiod, y = age, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Average Age Harvested") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (50, 320, 20)) +
              theme_classic()

```

#### Merchantable Growing Stock
The trends in merchantable growing stock (i.e., volume in the THLB available for harvest) were similar between the Castor model and STSM. The amount of growing stock was close to identical between the models for the first 60 years. While the trends were the same after 60 years, the amount of growing stock began to diverge between the models, where growing stock in STSM was increasingly less than growing stock in the Castor model, up to a 9% (645,000 m^3^) difference by year 250. 

```{r, annual growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "oldest_annual_noroads_noblocks_133600" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"

stsm.fig <- stsm.annual.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_133600"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic()

```

#### Spatial Harvest Location
The spatial harvest sequence was very similar for both models in the first 50 years of the simulation, but not identical. The slight differences in areas that were harvested may have contributed to the divergent harvest flows seen in both models.

```{r, stsm annual model 50 year harvest blocks map, echo = F, message = F, eval = T}
m <- c (390,400,5, 380,390,4,  370,380,3, 360,370,2, 350,360,1, 0,350,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.stsm.harvest.blocks.50.annual.rcl <- classify (rast.stsm.harvest.blocks.50.annual, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
plot (rast.stsm.harvest.blocks.50.annual.rcl,
      col = c ("forestgreen", "yellow1", "olivedrab1", "seagreen1", "dodgerblue3", "darkorchid4"),
      type = "classes",
      plg = list (title = "Decade Harvested"))
title ("STSM Harvest Locations")

```

```{r castor annual harvest blocks map, echo = F, message = F, eval = T}

m <- c (1,10,1, 10,20,2, 20,30,3, 30,40,4, 40,50,5, 50,100,0, 0,0,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.annual.rcl <- classify (rast.castor.harvest.blocks.50.annual.133, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)

plot (rast.castor.harvest.blocks.50.annual.rcl,
      col = c ("forestgreen", "yellow1", "olivedrab1", "seagreen1", "dodgerblue3", "darkorchid4"),
      type = "classes",
      plg = list (title = "Decade Harvested"))
title ("Castor Harvest Locations")

```

### Scenario 2: Decadal Harvest Simulation
This scenario used a decadal simulation time interval with no blocking and no roads.

#### Harvest Flow
When modeling the maximum non-declining harvest flow of each model on a decadal basis, the Castor model was able to harvest approximately 135,000 m^3^ per year, approximately 1,000 m^3^ per year (<1%) less than in the annual model.

```{r, decadal harvest flow, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_135000", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.fig <- stsm.decadal.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "volume")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_135000"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.fig)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (130000, 140000, 500)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]


```

#### Area Harvested 
When modeling a harvest flow of approximately 133,600 m^3^ per year, the Castor model and STSM had comparable harvest area patterns, i.e., peaks and troughs in area harvested over time generally coincided in both models. However, the models began to diverge slightly at approximately year 70, where STSM harvested more area than the Castor model. From that point on, while both models followed a similar general trend in area harvested (i.e., a trough between approximately years 150 to 175 and a peak at approximately year 190), STSM harvested more area (124,246 ha) than Castor (122,990 ha) across the 250 period, a 1% difference.

```{r, decadal area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_133600", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.fig <- stsm.decadal.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "area")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_decadal_noroads_noblocks_133600"

tab.harvest.area <- rbind (tab.harvest.area, stsm.fig)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic () +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))
# aggregate(tab.harvest.area$area, by=list(model=tab.harvest.area$model), FUN=sum)

```

#### Merchantable Growing Stock
The trends in merchantable growing stock were similar between the Castor model and STSM. However, STSM had consistently higher growing stock estimates than the Castor model up to year 80, and then both models began to converge between years 80 to 250. This was largely driven by Castor finding more harvest volume in less area which resulted in a smaller amount of growing stock.

```{r, decadal growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "oldest_decadal_noroads_noblocks_133600" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"

stsm.fig <- stsm.decadal.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_decadal_noroads_noblocks_133600"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic() +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

### Scenario 3: Harvest Blocking Simulation
This scenario used a harvest blocking algorithm and had a decadal time interval and no roads.

#### Characteristics of Harvest Blocks 
The spatial distribution of blocks that were predetermined in the Castor model is shown in the map below. Note that areas without blocks are indicated in purple.

```{r castor harvest units, echo = F, message = F, eval = T}
plot (rast.castor.preblocks,
      breaks = 500000,
      col = hcl.colors (250, palette = "viridis", alpha = NULL, rev = FALSE, fixup = TRUE),
      legend = F)
```

In the Castor model, the predetermined block sizes were right-skewed (i.e., there were many smaller blocks and few large blocks). The Castor initial mean block size was 28 ha, median block size was 7 ha and maximum block size was 320 ha. The initial block size distribution was used to parameterize STSM and thus average output of harvest block sizes were similar between STSM and Castor. STSM had a mean harvest block size of 20 ha and median block size of 8 ha, and Castor had a mean harvest block size of 22 ha and median block size of 6 ha. Both models harvested a similar distribution of block sizes but STSM harvested more medium sized blocks (20-40 ha in size), fewer large blocks (100-200 ha in size), and more very large blocks (greater than 260 ha in size) than Castor.

```{r, block sizes, echo = F, message = F, eval = T}

castor.init.block.sizes <- castor.preblocks [, c ("blockid", "N")]
names (castor.init.block.sizes) <- c ( "blockid", "size")
castor.init.block.sizes$Model <- "Initial Castor Blocks"
#mean (castor.init.block.sizes$size)
#median (castor.init.block.sizes$size)

blocksdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/scenarios/comparison_stsm/stsm_compare_blocks_noroads_castordb.sqlite"))
raster.info <- data.table (dbGetQuery (blocksdb, "SELECT * FROM raster_info;"))	
ras <- terra::rast (terra::ext (raster.info$xmin, raster.info$xmax, raster.info$ymin,
                                raster.info$ymax), nrow = raster.info$nrow, 
                                ncol = raster.info$ncell/raster.info$nrow, 
                                vals =1: raster.info$ncell)
pixels <- data.table (dbGetQuery (blocksdb, "SELECT * FROM pixels;"))
dbDisconnect (blocksdb)
ras [] <- pixels$blockid
terra::crs(ras) <- "epsg:3005"

m <- c (9,11,1, 0,9,0,  11,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.10 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.10 <- rast.castor.harvest.blocks.50.block.10 * ras
castor.block.sizes.10 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.10))
m <- c (19,21,1, 0,19,0,  21,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.20 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.20 <- rast.castor.harvest.blocks.50.block.20 * ras
castor.block.sizes.20 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.20))
m <- c (29,31,1, 0,29,0,  31,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.30 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.30 <- rast.castor.harvest.blocks.50.block.30 * ras
castor.block.sizes.30 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.30))
m <- c (39,41,1, 0,39,0,  41,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.40 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.40 <- rast.castor.harvest.blocks.50.block.40 * ras
castor.block.sizes.40 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.40))
m <- c (49,51,1, 0,49,0,  51,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.50 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.50 <- rast.castor.harvest.blocks.50.block.50 * ras
castor.block.sizes.50 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.50))
castor.block.sizes <- rbind (castor.block.sizes.10, castor.block.sizes.20, castor.block.sizes.30,
                             castor.block.sizes.40, castor.block.sizes.50)
castor.block.sizes <- castor.block.sizes [, c ("value", "count")]
names (castor.block.sizes) <- c ( "blockid", "size")
castor.block.sizes$Model <- "Castor Harvest Blocks"
castor.block.sizes <- castor.block.sizes [blockid > 0]
#mean (castor.block.sizes$size)
#median (castor.block.sizes$size)

stsm.block.sizes <- stsm.blocking.block.size [Year < 51, c ("blockNum", "blockSize")]
names (stsm.block.sizes) <- c ( "blockid", "size")
stsm.block.sizes$Model <- "STSM Harvest Blocks"
#mean (stsm.block.sizes$size)
#median (stsm.block.sizes$size)

tab.block.sizes <- rbind (castor.init.block.sizes, castor.block.sizes, stsm.block.sizes)
tab.block.sizes$Model <- as.factor (tab.block.sizes$Model)
tab.block.sizes$Model <- factor(tab.block.sizes$Model, 
                                levels = c ("Initial Castor Blocks", "Castor Harvest Blocks", "STSM Harvest Blocks"))

ggplot (tab.block.sizes, 
        aes (x = size, group = Model, fill = Model)) +
  geom_histogram (aes(y = ..density..),
                  position  ="dodge",
                  binwidth = 20) +
  theme_bw () +
  scale_x_continuous (breaks = c(0, 40, 80, 120, 160, 200, 240, 280, 320, 360, 400, 440))
```

#### Harvest Flow
Both models harvested less volume when blocking was implemented. The Castor model harvested 130,000 m^3^/year with blocking, a 4% decline (6,000 m^3^/year) from the Castor model without blocking. The STSM model with blocking harvested 127,000 m^3^/year, a 5% decline (6,600 m^3^/year) from the STSM model without blocking. There was approximately 2% less volume harvested in STSM compared to the Castor model when blocking was simulated in the models. Therefore, pre-defining blocks resulted in lower timber supply in both models, but the STSM method was slightly more constraining on timber supply.

```{r, blocking harvest flow block vs. no block, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_133600" | scenario == "oldest_decadal_noroads_blocks", c ("scenario", "timeperiod", "volume")]

tab.harvest.flow$model <- "castor"

stsm.decadal <- stsm.decadal.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.decadal) <- c ( "timeperiod", "volume")
stsm.decadal$model <- "stsm"
stsm.decadal$scenario <- "oldest_decadal_noroads_noblocks_133600"

stsm.block <- stsm.blocking.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.block) <- c ( "timeperiod", "volume")
stsm.block$model <- "stsm"
stsm.block$scenario <- "oldest_decadal_noroads_blocks"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.decadal, stsm.block)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = scenario)) +
              geom_line (position = position_dodge (width = 1), size = 1, aes (linetype = model)) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Scenario", 
                                    labels = c("Blocking", "No Blocking")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (120000, 140000, 1000)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]


```

#### Area Harvested 
When blocking was implemented in the models they had similar overall patterns in the amount of area harvested throughout the simulation, with corresponding timing in the peaks and valleys in area harvested. However, there were small differences in the amount of area harvested at a given time period, and the general trend was that Castor consistently harvested more area than STSM, with a few exceptions (e.g., decades 80 and 90). Indeed, overall STSM harvested less area (120,066 ha) than Castor (123,365 ha) across the 250 period. 

```{r, blocking area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "oldest_decadal_noroads_blocks", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.block <- stsm.blocking.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.block) <- c ( "timeperiod", "area")
stsm.block$model <- "stsm"
stsm.block$scenario <- "oldest_decadal_noroads_blocks"

tab.harvest.area <- rbind (tab.harvest.area, stsm.block)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic () +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))
# aggregate(tab.harvest.area$area, by=list(model=tab.harvest.area$model), FUN=sum)

```

#### Merchantable Growing Stock
The overall trends in merchantable growing stock were similar between the Castor model and STSM. However, the models increasingly diverged, and this divergence increased quite a bit at approximately year 70, where the Castor growing stock reached a plateau at approximately 5M m^3^ compared to STSM which reached approximately 6M m^3^ before increasing to approximately 6.5M m^3^ at year 250.  This again can be explained by the greater amount of volume that could be harvested by Castor. However, this indicates that STSM could have potentially increased to a higher long-term harvest level, and therefore closer to Castor's harvest flow.

```{r, blocking growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "oldest_decadal_noroads_blocks" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"
# tab.grow.stock$timeperiod <- c (seq (from = 10, to = 260, by = 10)) # need to shift the values for reporting
# tab.grow.stock [26, 2] <- 0
# tab.grow.stock [26, 3] <- 9716881

stsm.fig <- stsm.decadal.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_decadal_noroads_blocks"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic() +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

#### Spatial Harvest Location
Despite the similarities in harvest volume flows, blocking resulted in some differences in the spatial distribution of harvest between the two models over the first 50 years of the simulation. At the scale of the area of interest, the spatial distribution was generally similar, with more harvest in the southwest and northern parts in the first two to three decades of the simulation, shifting to more harvest in the eastern portion of the area in the fourth and fifth decades. However, there were some differences at finer scales. For example, there was more harvest in the northwest portion of the area in later decades in the Castor model compared to STSM.

```{r, stsm blocking model 50 year harvest blocks map, echo = F, message = F, eval = T, warning = F}
m <- c (390,400,5, 380,390,4,  370,380,3, 360,370,2, 350,360,1, 0,350,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.stsm.harvest.blocks.50.block.rcl <- classify (rast.stsm.harvest.blocks.50.blocking, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
plot (rast.stsm.harvest.blocks.50.block.rcl,
      col = c ("forestgreen", "yellow1", "olivedrab1", "seagreen1", "dodgerblue3", "darkorchid4"),
      type = "classes",
      plg = list (title = "Decade Harvested"))
title ("STSM Harvest Locations")

```

```{r castor blocking harvest blocks map, echo = F, message = F, eval = T}

m <- c (1,10,1, 10,20,2, 20,30,3, 30,40,4, 40,50,5, 50,100,0, 0,0,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.rcl <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)

terra::plot (rast.castor.harvest.blocks.50.block.rcl,
              col = c ("forestgreen", "yellow1", "olivedrab1", 
                       "seagreen1", "dodgerblue3", "darkorchid4"),
              type = "classes",
              plg = list (title = "Decade Harvested"))
title ("Castor Harvest Locations")

```


### Scenario 4: Roading Simulation
This scenario used a road algorithm with harvest blocking to develop a road network, and had a decadal time interval.

#### Road Development Pattern
Initially there was 23,938 ha (7%) of the area of interest that was classified as having a road. Existing roads were concentrated in the northeast, central and southwest portions of the area of interest. Few existing roads were located in the northwest portion of the area of interest. 

```{r initial roads map, echo = F, message = F, eval = T}
# sum (terra::freq (rast.castor.road.init)) # initial road count
m <- c (0,6,1)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.road.init.rcl <- classify (rast.castor.road.init, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
# sum (rast.castor.road.init.rcl[], na.rm = T)  # 23,915 ha have a road
terra::plot (rast.castor.road.init.rcl,
              col = c ("grey0"),
              legend = F) 
legend ("topright", legend = "Existing Road", fill = "grey0", cex = 0.75,  pt.cex = 1)

```

At the end of the road simulation, Castor had simulated roads in 38,671 ha (11%) and STSM simulated roads in 39,991 ha (11%) of the area of interest. Thus, STSM simulated slightly more roaded areas than Castor but they were essentially the same (i.e., a difference of less than 1% of the area of interest).

The difference in road development patterns are illustrated below in the northwest corner of the study area where there were few existing roads at the start of the simulation. In the top figure, existing roads are indicated in black and roads simulated by Castor are indicated in purple. The bottom figure shows all roads in STSM, including existing and simulated. While the branching pattern of the roads is somewhat different, the overall broad pattern is similar, as roads followed the least-cost paths in Castor and a combination of snapping roads and least cost roads in STSM to develop a road system. A notable difference is the greater level of branching or fractal patterns observed in Castor and the greater level of loops observed in STSM. We assume a more similar road network would be achieved if Castor was constrained to harvest within 2 km of the existing road. 

```{r final roads castor, echo = F, message = F, eval = T}
# sum (terra::freq (rast.castor.road.year))
m <- c (0,0,1, 1,251,2)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.road.year.rcl <- classify (rast.castor.road.year, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)

e <- ext (999987.5, 1030000, 1200000, 1223387.5)
rast.castor.road.year.rcl.crop <- terra::crop (rast.castor.road.year.rcl, e)

terra::plot (rast.castor.road.year.rcl.crop,
      col = c ("black", "darkorchid4"),
      type = "classes",
      levels = c ("Existing Road", "Simulated Road"),
      plg = list (title = "Road Types"),
      main = "Castor Simulated Roads")

```

```{r final roads stsm, echo = F, message = F, eval = T}
m <- c (0,0,0, 1,150,1)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.stsm.road.all.rcl <- classify (rast.stsm.road.all, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
# terra::freq (rast.stsm.road.all.rcl)
e <- ext (999987.5, 1030000, 1200000, 1223387.5)
rast.stsm.road.all.rcl.crop <- terra::crop (rast.stsm.road.all.rcl, e)
terra::plot (rast.stsm.road.all.rcl.crop,
      col = c ("white", "darkorchid4"),
      type = "classes",
      levels = c ("Not Roaded", "Road"),
      plg = list (title = "Road Type"),
      main = "STSM Simulated Roads")

```

Despite the broad-scale similarities in road development, the patterns in the timing of road development were notably different between the two models. Castor built the bulk of its roads early in the simulation, exclusively following the 'oldest first' priority queue, whereas STSM included additional constraints, i.e., blocks must be within 2km of the active road network. This essentially delayed road development in STSM relative to Castor to approximately the middle of the simulation (i.e., years 75 to 125).

```{r castor count roads, echo = F, message = F, eval = T }

castor.road.count.year <- data.table (terra::freq (rast.castor.road.year))
castor.road.count.year <- castor.road.count.year [value > 0, c ("value", "count")]
names (castor.road.count.year) <- c ( "timeperiod", "count")
castor.road.count.year$Model <- "Castor"

stsm.road.count.year <- stsm.road.record [, c ("Year", "KmRdsBuilt")]
names (stsm.road.count.year) <- c ( "timeperiod", "count")
stsm.road.count.year$count <- stsm.road.count.year$count * 10 # convert km to m (x1,000) and assume 1 ha = 100 m of road (/100)
stsm.road.count.year$Model <- "STSM"

tab.road.count <- rbind (castor.road.count.year, stsm.road.count.year)


ggplot (tab.road.count, 
        aes (x = timeperiod, y = count, group = Model, fill = Model)) +
  geom_bar (stat = "identity", position = position_dodge ()) +
  scale_y_continuous (breaks = c (0,500,1000,1500,2000,2500,3000)) +
  scale_x_continuous (breaks = c (0,25,50,75,100,125,150,175,200,225,250)) +
  labs (x = "Year", y = "Number of Roaded Pixels")
```

### Scenario 5: No Harvest Constraint Simulation
This scenario applied a no harvest constraint with decadal time intervals, but no blocking or roads.  When the models were run with a no harvest zone in the eastern portion of the area of interest (outlined in green over the timber harvest land base), the Castor model harvested 117,500 m^3^/year, 14% less than without the no harvest zone, and the STSM model harvested 120,216 m^3^/year, 10% less than without the no harvest zone. Thus the two models were approximately 4% different, but the effect was greater in Castor than STSM.

```{r zone constraint map, echo = F, message = F, eval = T}

poly.zone.constraint <- terra::vect (poly.zone.constraint)

m <- c (0,0,0, 1,2000,20, 2000,4000,40, 4000,6000,60, 6000,8000,80, 8000,10000,100)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.thlb.rcl <- classify (rast.thlb, 
                           rcl = rclmat,
                           include.lowest = T,
                           right = T)

terra::plot (rast.thlb.rcl,
             col = c ("white", "salmon1", "violetred3", "magenta4", "darkorchid4", "black"),
             type = "classes",
             plg = list (title = "Timber Harvest 
Land Base (%)"))
terra::polys (poly.zone.constraint, border="green", lwd = 3, alpha = 0)

```

```{r harvest flow constraint, no harvest, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_136000" | scenario == "oldest_decadal_noroads_noblocks_constraint", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.decadal <- stsm.decadal.harvest.flow [ScenarioId == 1 & Year < 251, c ("Year", "vHarv_1")]
names (stsm.decadal) <- c ( "timeperiod", "volume")
stsm.decadal$model <- "stsm"
stsm.decadal$scenario <- "oldest_annual_noroads_noblocks_136000"

stsm.constraint <- stsm.constraint.no.harvest.flow [ScenarioId == 1 & Year < 251, c ("Year", "vHarv_1")]
names (stsm.constraint) <- c ( "timeperiod", "volume")
stsm.constraint$model <- "stsm"
stsm.constraint$scenario <- "oldest_decadal_noroads_noblocks_constraint"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.decadal, stsm.constraint)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = scenario)) +
              geom_line (position = position_dodge (width = 1), size = 1, aes (linetype = model)) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Scenario", 
                                    labels = c("No Constraint", "Constraint")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (100000, 140000, 1000)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]

```

### Scenario 6: Forest Cover Constraint Simulation
This scenario applied a forest cover constraint with decadal time intervals, but no blocking or roads. When the models were run with a modified harvest zone (i.e., at least 75% of the productive forest in the zone greater than 175 year-old forest) in the eastern portion of the area of interest, the Castor model harvested 123,500 m^3^/year, 9% less than without the modified harvest zone, and the STSM model harvested 125,000 m^3^/year, 6% less than without the no modified zone. The difference between the two models was 1,500 m^3^/year (approximately 2%).

```{r harvest flow constraint, modifed harvest, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_constraint_modified_aflb" | scenario ==  "oldest_annual_noroads_noblocks_136000", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.decadal <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.decadal) <- c ( "timeperiod", "volume")
stsm.decadal$model <- "stsm"
stsm.decadal$scenario <- "oldest_annual_noroads_noblocks_136000"

stsm.constraint <- stsm.constraint.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.constraint) <- c ( "timeperiod", "volume")
stsm.constraint$model <- "stsm"
stsm.constraint$scenario <- "oldest_annual_noroads_noblocks_constraint_modified_aflb"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.decadal, stsm.constraint)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = scenario)) +
              geom_line (position = position_dodge (width = 1), size = 1, aes (linetype = model)) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Scenario", 
                                    labels = c("No Constraint", "Constraint")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (100000, 140000, 1000)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]

```

### Scenario 7: Timber Supply Review Base Case
This scenario applied the standard approach to developing timber supply harvest flows using STSM, including blocking and roads, but no forest cover constraints. 

#### Harvest Flow
STSM fit a harvest flow of 147,304 m^3^/year in the first decade, 133,510 m^3^/year in the second decade, approximately 132,300 m^3^/year in the third to fourteenth decade and approximately 135,400 m^3^/year in the fifteenth to twenty-fifth decade. Castor was able to achieve this harvest flow in the first 12 decades of the simulation, but only in one of the decades (decade 19) thereafter. Therefore, Castor was not able to achieve the long-term harvest flow estimated by STSM, and was approximately 5,000 m^3^/year (4%) to 25,000 m^3^/year (19%) less in the long-term.

```{r, base case harvest flow, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "stsm_base_case", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.fig <- stsm.base.case.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "volume")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "stsm_base_case"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.fig)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (110000, 150000, 5000)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]

```

#### Area Harvested 
The patterns in area harvested differed between the two models in this scenario. The variability in harvest area was significantly more in the Castor model than STSM, and the general pattern of high and low periods of harvest area was not as pronounced in STSM compared to the Castor model.   

```{r, base case area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "stsm_base_case", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.fig <- stsm.base.case.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "area")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "stsm_base_case"

tab.harvest.area <- rbind (tab.harvest.area, stsm.fig)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic () +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))
# aggregate(tab.harvest.area$area, by=list(model=tab.harvest.area$model), FUN=sum)

```

#### Average Age Harvested
During the first five decades the STSM model consistently harvested younger stands than Castor, approximately 20 to 30 years younger. However, from the seventh to ninth decades, STSM harvested older stands than Castor, by approximately 20 to 50 years. In the long-term (from the ninth to twenty-fifth decade) the models harvested similar aged stands.

```{r, base case annual average age harvested, echo = F, message = F, eval = T}
tab.harvest.age <- castor.harvest.flow [scenario == "stsm_base_case", c ("scenario", "timeperiod", "age")]
tab.harvest.age$model <- "castor"

stsm.fig <- stsm.base.case.harvest.flow [ScenarioId == 1, c ("Year", "mnHAge_1")]
names (stsm.fig) <- c ( "timeperiod", "age")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "stsm_base_case"

tab.harvest.age <- rbind (tab.harvest.age, stsm.fig)

ggplot (tab.harvest.age, aes (x = timeperiod, y = age, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Average Age Harvested") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (50, 320, 20)) +
              theme_classic()

```

#### Merchantable Growing Stock
Castor had less growing stock than STSM across the simulation period, and they became increasingly divergent, particularly after the first 50 years of the simulation. However, the growing stock in both model stabilized at approximately the seventh decade. By the end of the simulation Castor had 26% less (~1.7M m^3^) growing stock than STSM.

```{r, base case growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "stsm_base_case" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"

stsm.fig <- stsm.base.case.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "stsm_base_case"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic()

```


## Discussion
We conclude that Castor and STSM are similar in terms of estimating long-term timber supply. Despite the differences in the analytical frameworks developed for each modeling platform, at their simplest parameterization, Castor harvested only ~2% more timber volume per year than STSM, and thus appears to be slightly more optimistic in terms of timber supply estimates. While it was difficult to determine whether different results from the two models were due to their parameterization or analytical frameworks, we argue the most likely driving factor for the observed differences was that the models used different methods for updating forest stand yields (i.e., merchantable volume) at each time interval, i.e., Castor updated yields to the mid-point of a time interval, whereas STSM updated volume each year and using the “look-ahead" function. While one approach assumes a bias using the mid-point, the other approach assumes a bias from strictly following an annual spatial harvest sequence. The difference between these two approaches remains philosophical, as it was not possible to test their validity using empirical methods. The “look-ahead" function likely allowed for more stands to be included in the harvest queue than using the mid-point (i.e., STSM identified more stands that met the minimum harvest criteria), as stands would be assessed at an older age and thus greater volume, which may have contributed to the differences between the model. In addition, small differences in rounding (STSM used two decimal places whereas Castor used floating point) and the development of the harvest queue may also have contributed to these differences.

Scenario seven showed notable differences between STSM and Castor in the area and age of harvested stands, and importantly, Castor was not able to achieve the long-term harvest flow target. This result was somewhat surprising given the similarities in indicators of simpler scenarios. However, the differences between the two models were likely amplified by the complexity of the algorithms used in STSM to estimate a 'base case' harvest flow. Specifically, it is very likely that the differences between how the models updated forest stand volume yields were what caused the divergence of the indicators and the inability for Castor to achieve the long-term harvest flows. As a consequence, the same algorithm applied in Castor would likely have found a slightly different solution for short-, mid- and long-term harvest flows.

In most scenarios, merchantable growing stock, forest stand age and area harvested indicators generally diverged between Castor and STSM as the simulation progressed past 70 to 100 years. While these divergences did not result in significantly different timber supply estimates over a 250 year simulation period, it is worth noting that model outputs are less likely to be the same, the longer that a simulation is run. This outcome is common for models that simulate decisions conditional on previous decisions (e.g., a Markov process).

When blocking was implemented, the timber supply was reduced by a similar amount in both models with a 2% difference between them. Again, STSM harvested 2% less timber volume than Castor, suggesting that the different blocking methods used in each model achieved similar results. However, Castor consistently harvested more area when blocking was implemented, suggesting that Castor's pre-blocking algorithm was causing the model to harvest more area to obtain similar volumes as STSM. The homogenization of harvest blocks based on stand characteristics that was implemented in Castor may have resulted in the creation of relatively larger and lower volume harvest blocks compared to STSMs spreading approach, which created more medium sized harvest blocks that were likely more diverse in terms of forest stand characteristics. 
At a coarse scale, Castor and STSM simulated similar amounts of roads. There were differences in the road development pattern at fine-scales, but these did not appear to result in significant differences in the road pattern across larger areas and over a long-term simulation period. The fine-scale differences in the simulated patterns likely reflect the differences between allowing some dynamic development of roads in response to the harvest queue (Castor) and pre-determination of the entire road network (STSM). The STSM approach assumes perfect information of harvest locations across the simulation time horizon, whereas the Castor approach assumes limited information concerning harvest locations (i.e., a single period of locations). Pre-determination of the entire road network may result in greater efficiency in road development in some cases, whereas a dynamic approach may allow for flexibility, which may be useful in scenarios where other ecological drivers of landscape change, such as fire, influence the harvest queue. The differences in the timing of road development were likely simply due to the additional constraint in STSM to limit the harvest queue to blocks within 2 km of a road. If a similar constraint were applied in Castor it would likely approximate the road development pattern seen in STSM.   

When a no harvest zone or forest cover constraint zone were applied, the models were similar (within 4%) in terms of annual timber supply. However, the constraint scenarios had a greater effect on timber supply in the Castor model than STSM. This may have been because removing that portion of the THLB exacerbated a pinch point in the age class distribution of harvested stands in the Castor model. In the forest cover constraint scenario, STSM may have also able to achieve slightly more volume than the Castor model due to the differences in how each model reserved areas to achieve the cover constraints. STSMs approach to reserving pixels in the zone in ascending order above the variable threshold, compared to Castors approach of reserving pixels by first prioritizing non-THLB, then areas already reserved, followed by a descending order from the highest value in the zone likely allowed STSM to harvest slightly older stands and thus achieve greater volume from zones with forest cover constraints. This effect may be different in forest types whose yields decline (i.e., due to decay and breakage) at older ages rather than asymptote at older ages.

## Conclusions
In summary, when using the same data and basic parameterizations, STSM and Castor were able to achieve remarkably consistent results in terms of timber harvest flow, other forest harvest indicators (e.g., average harvest age, growing stock), and road development. While Castor seemed to find slightly more merchantable volume to harvest under the annual, decadal and blocking scenarios, it found slightly less merchantable volume to harvest under the forest cover constraints, relative to STSM. We believe these small differences would likely offset each other in more complex simulation scenarios that include blocking, roading and multiple forest cover constraints. 

The results provide confidence in the approaches used by both models to estimate timber supply. While the complexity of each individual process (e.g., roading, blocking) used in each model was different, their conclusions were quite similar. Given the similarity in results between Castor and STSM, we found Castor to be an effective tool for timber supply modeling in British Columbia. 