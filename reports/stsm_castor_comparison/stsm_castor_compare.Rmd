---
title: "Comaprison of SELES/STSM to Castor/SpaDES"
author: "Tyler Muhly"
date: '2023-03-22'
output: html_document
---

```{r, load packages, data}
library (terra)
library (DBI)
library (keyring)
library (data.table)
library (ggplot2)
library (scales)
library (terra)
# library (rasterVis)

data.dir <- "G:\\!Workgrp\\Analysts\\tmuhly\\clus_stsm_comparison\\results"
conn <- DBI::dbConnect (RPostgreSQL::PostgreSQL(), 
                        host=keyring::key_get('vmdbhost', keyring = 'postgreSQL'), 
                        dbname = keyring::key_get('vmdbname', keyring = 'postgreSQL'), 
                        port='5432',
                        user = keyring::key_get('vmdbuser', keyring = 'postgreSQL'),
                        password = keyring::key_get('vmdbpass', keyring = 'postgreSQL'))

# Data
## TABLES
castor.harvest.flow <- data.table (dbGetQuery (conn, "SELECT * from stsm_compare.harvest"))
castor.grow.stock <- data.table (dbGetQuery (conn, "SELECT * from stsm_compare.growingstock"))
castor.preblocks <- data.table (read.csv (paste0 (data.dir, "\\castor\\blocks.csv")))
dbDisconnect (conn)

stsm.annual.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\annual_run\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.annual.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\annual_run\\growingStock.txt"), 
                                             header = TRUE))
stsm.decadal.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\decadal_run\\oScn250\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.decadal.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\decadal_run\\oScn250\\growingStock.txt"), 
                                             header = TRUE))
stsm.blocking.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\growingStock.txt"), 
                                             header = TRUE))
stsm.blocking.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.blocking.block.size <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\BlockLIst.txt"), 
                                             header = TRUE))
stsm.road.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\growingStock.txt"), 
                                             header = TRUE))
stsm.road.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.road.record <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\roadRecord.txt"), 
                                             header = TRUE))

## RASTERS
### BLOCKS
rast.castor.harvest.blocks.50.annual.133 <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\spatial_50_oldest_annual_noroads_noblocks_133600_tsa99_harvestBlocks.tif"))
rast.castor.harvest.blocks.50.block <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\oldest_decadal_noroads_blocks_tsa99_harvestBlocks_50yrs.tif"))
rast.stsm.harvest.blocks.50.annual <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\annual_run\\oScn250_1yr\\grids\\Logged_1_5.tif"))
rast.stsm.harvest.blocks.50.blocking <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_5.tif"))
rast.castor.preblocks <- terra::rast ("D:\\clus_data\\castor_stsm\\castor\\hu_blocks_no_roads.tif")

rast.stsm.blocking.harvest.blocks.1 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_1.tif"))
rast.stsm.blocking.harvest.blocks.2 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_2.tif"))
rast.stsm.blocking.harvest.blocks.3 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_3.tif"))
rast.stsm.blocking.harvest.blocks.4 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_4.tif"))
rast.stsm.blocking.harvest.blocks.5 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_5.tif"))

### ROADS
rast.castor.road.init <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\rast_roads_init.tif"))
rast.castor.road.status <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\oldest_decadal_roads_blocks_tsa99_mst_status_250.tif"))
rast.castor.road.year <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\oldest_decadal_roads_blocks_tsa99_mst_year_250.tif"))

rast.stsm.road.10 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_1.tif"))
rast.stsm.road.20 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_2.tif"))
rast.stsm.road.30 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_3.tif"))
rast.stsm.road.40 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_4.tif"))
rast.stsm.road.50 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_5.tif"))
rast.stsm.road.60 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_6.tif"))
rast.stsm.road.70 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_7.tif"))
rast.stsm.road.80 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_8.tif"))
rast.stsm.road.90 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_9.tif"))
rast.stsm.road.100 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_10.tif"))
rast.stsm.road.110 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_11.tif"))
rast.stsm.road.120 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_12.tif"))
rast.stsm.road.130 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_13.tif"))
rast.stsm.road.140 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_14.tif"))
rast.stsm.road.150 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_15.tif"))
rast.stsm.road.160 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_16.tif"))
rast.stsm.road.170 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_17.tif"))
rast.stsm.road.180 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_18.tif"))
rast.stsm.road.190 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_19.tif"))
rast.stsm.road.200 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_20.tif"))
rast.stsm.road.210 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_21.tif"))
rast.stsm.road.220 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_22.tif"))
rast.stsm.road.230 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_23.tif"))
rast.stsm.road.240 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_24.tif"))
rast.stsm.road.250 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_25.tif"))

rast.stsm.road.all <- rast.stsm.road.250 + rast.stsm.road.240 + rast.stsm.road.230 +
                      rast.stsm.road.220 + rast.stsm.road.210 + rast.stsm.road.200 + 
                      rast.stsm.road.190 + rast.stsm.road.180 + rast.stsm.road.170 + 
                      rast.stsm.road.160 + rast.stsm.road.150 + rast.stsm.road.140 +
                      rast.stsm.road.130 + rast.stsm.road.120 + rast.stsm.road.110 +
                      rast.stsm.road.100 + rast.stsm.road.90 + rast.stsm.road.80 +
                      rast.stsm.road.70 + rast.stsm.road.60 + rast.stsm.road.50 +
                      rast.stsm.road.40 + rast.stsm.road.30 + rast.stsm.road.20 + rast.stsm.road.10
```

## Introduction
The purpose of this report is to present and compare the outputs from [Castor, a forestry and land use simulator model](https://github.com/bcgov/castor) built using the [Spatial Discrete Event Simulation (SpaDES)](https://spades-core.predictiveecology.org/) platform in program R, to the Spatially Explicit
Timber Supply Model (STSM) built using the [SELES](https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=14729e8f5430035cead9f38e708f4507c543ff9d) platform. These models were compared to test whether the Castor model approximates results from a STSM model, and thus to assess the logic of the Castor model relative to STSM. If the Castor model closely approximates the STSM model than it will improve confidence in forest harvest results from Castor and open the opportunity to use Castor as a model for timber supply reviews. This comparison also provides an opportunity to explore and discuss alternative logical approaches to simulating timber harvest and future forest conditions. 

Both the Castor and STSM models can be used to spatially simulate forest condition and harvest, and estimate 'timber supply' (i.e.,t eh amount of wood volume that can be harvested in a landscape). However, STSM has been used to estimate timber supply in support of timber supply reviews in British Columbia since the mid-2000's. Therefore, it has been refined over a relatively long-period of time and it has been accepted as a valid model for completing timber supply reviews. Castor was developed starting in 2017 and has primarily been used to support strategic decisions around habitat protections for species-at-risk such as caribou. Therefore, Castor has not been as widely tested or developed as STSM.

Neither Castor nor STSM are optimization models, but they both simulate timber harvest based on heuristics regarding forest harvest patterns. In summary, they are both programmed to harvest and calculate harvested timber volume based on meeting a volume demand, following a harvest priority queue (e.g., oldest stands first), potentially with 'partitions' of the volume (i.e., spatial sub-zones or 'compartments', or forest stand types), within the 'constraints' of the land base (i.e.,, zones with some rules that restrict forest harvest in some way to meet some objective, such as wildlife habitat).

Castor was developed internally to the Forest Analysis and Inventory Branch as an open source tool using the [programming language R](https://www.r-project.org/). It was created to take advantage of the R programming language, which provides a relative large user and developer base with a diversity of analytical functions (including data wrangling, statistical analyses and data visualization). By 

## Methods
To compare the two models, a simplified timber supply area (350,000 ha in size) was created in the center of British Columbia. The current (2022) forest inventory, growth and yield and timber harvest land base data were obtained for that area to use as the forest estate for the area of interest. In both models, the forest inventory provides the current state-of-the-forest, growth and yield models (Variable Density Yield Projection (VDYP) models for natural stands, Table Interpolation Program for Stand Yields (TIPSY) models for planted stands) provided future stand characteristics and the THLB defined the area available for forest harvest.

### Model Parameters
In addition to using the same initial and projected forest conditions, the models were set-up with the same timber supply modeling parameters. This included a minimum harvest age of 80 years old and minimum harvest volume of 150 m^3^/ha.  





e.	Even-flow harvest
f.	Harvest queue
g.	“blocking” at pixel scale – no spatial blocking
h.	No adjacency constraints


### Model Scenarios


- annual time step for 250 years, no blocks, no roads
- decadal time step for 250 years (25 intervals), no blocks, no roads
- decadal time step for 250 years (25 intervals), blocks, no roads
- decadal time step for 250 years (25 intervals), blocks, roads


- all	oldest first priority queue


#### Castor Yield Update
-	Mid-point
o	Forest Estate Model Sample Clauses | Law Insider
o	Aggregation of Age Classes in Timber Resources Scheduling Models: Its Effects and Bias | Forest Science | Oxford Academic (oup.com)
-	5 year increment

[‎2023-‎02-‎01 12:19 PM]  Lochhead, Kyle FLNR:EX:  
they say what is currently out there aka time = 0....use that volume and harvest 10 years worth of timber....then at time period 2, increase the age by 10 years
for us its report the time=0 (no harvesting goes on), then increase the age by the midpoint of the timperiod (5 years) then go find 10 years worth of timber, then in timperiod 2 increase by 10 years....so time period 1 = 5 years, timperiod 2 = 15, as increments , timperiod 3 = 25



Probability of initiation fo cutblock is driven by a number of parameters, depnign on how coarse/fine the analyst makes; sort cells based on preferences; preference value for cells; random selection; set seed
-	Oldest first; harvest queue


- in annual time step, castor takes the yiled at time = 1, stsm at time = 0


#### STSM Yield Update
- annualized harvest in a time interval (e.g., a decade)
- divides harvest request across years in a time interval; so if harvets request is 10 years, it gets divdied by ten
- first 10% (year 1) of queue gets advanced one year in age and volume, then harvested and age set to 0; becomes age 10 in next interval
- second 10% (year 2) of queue gets advanced two years in age and volume, then harvested and age set to -1; becomes age 9 in next interval
- etc.
- ninth 10% (year 9) of queue gets advanced two years in age and volume, then harvested and age set to -9; becomes age 1 in next interval


#### Castor blocking
- agglomerative clustering; pixels (ha) get grouped together based on stand characteristics (similarities determined using mahalanobis distance statistic) and block size target
- block size drawn from patch size distribution targets 

#### STSM blocking
- starts with 'preferred' cell in harvest queue
- then identifies a patch size target, but these are 'soft targets' so as not to become too constraining
- then sorts cells in the patch by harvest queue preference
- but also can parameterize it to 'spread' to pixels based on age threshold criteria, e.g., must be within 20% of age
- also looks for fragments in the patch
- initially a 'pattern analysis' is done to match patterns of created to exciting blocks


•	Initiate in the absolute oldest first. Availability is based on MHA/V > 80yrs/150m3/ha
•	Available patches must be > = 10 ha.
•	Target block sizes are selected from a uniform distribution between 20-300 hectares. If the patch is < twice the target size (between 40 and 600 ha) it will attempt to log the whole patch
•	The age differential within a block can be no more then +/- 20% of the age in the initiating cell

Under scenario 2  the median block size is 8 ha while the mean is 20 ha. An even flow of 127 000 m3/yr. can be achieved

#### Castor roading

queens case
- needed ot incrase the costs of traversing moutnain in Casto - values between 1 and 62 betwen a flat valley and steep maintain were not different enough to drive Castor to select least costs paths; i.e., needed to make the differences between the costs amplified to account for the fact that builign up the slope of amoutnain is orders of magnitude more costsly than a valley
- took the stsm cost suface which was between 1 and 62 and took teh squared value to get values between 1 and 3844; this made mountains 100's to 1000's of times more costly to traverse than valleys 


#### STSM roading
- does pre-processign of roads
- uses existing road network
- builds 'potential' future roads using a static costs surface (physical features, like slope, terrain, waterbodies)
- in pre-roading, road segments (~1km long) are built using the cost surface to access every pixel in the THLB within some threshold distance (e.g., 1 km; so each pixel will be 1km form a road)
- priority of a pixel could be adjusted by it's distance to road or by the amount of road that can be active in a period or cost of building the road as a proportion of the relative value of wood in an area, for example
- can therefore limit harvest based on road access, road building 'budget' and cost/value of road
- goal of making sure the model achieves a cost/value threshold can help ensure the model doesn't suddenly harvest in remote areas when timber volume is limited during a particular time period
- thus it dynamically changes the TLHB, where an area of THLB may be removed for a priroity queue if it doesnt achieve teh roading threholds (e.g., it is too far or too costly to build the roads to access the area)
- generally this feature has the effect of concentrating logging

- roading can add parameters to the harvest priority queue
- a landing is identified in a selected block and the model builds roads between that and the nearest road segment (either existing or pre-determined)
- if the block landing is connected to an existing or future road network, then those roads are 'activate', or else it builds a 'spur' road (straight-line, as a crow flies) connection between the landing and nearest road

It assumes:
•	All blocks must initiate within 2 km of the active road network
•	The default active road network is the existing road network at the beginning of the projection
•	Probability of initiation is weighted linearly by distance to active road. Default weight slope coefficient is -0.00056
•	Available stands within 200 m. of an active road have a weight coefficient of 1.
•	New roads (future roads) are added (activated) to the active road network as necessary to meet the harvest request. All things being equal the model will prioritize harvest nearest the existing network first.
•	Scenario 2 blocking assumptions are applied

- rooks case
- building min density of roads; effciciency 

#### STSM Harvest Queue
- can have multiple 'preference' criteria
- in a simple example, oldest first, it orders teh pixels by age
- but it can have multiple preferences, e.g., oldest first, closest to road, in which case the preferences get multiplied and then the queue re-ordered based on the multiplied preferences
- the harvest queue is updated (re-ordered) four times a year; so the queue gets re-ordered 4 times a year as the model harvests


#### STSM Constraints
- contraints are assessed four times per year
- detailed check of constraints at pixel scale





‘look-ahead’ in STSM the analysts can hit flag in the model, and the model will look at year 9 in 10 yar time step and determine when initiating whether a span meets min age requirements at year 9
-	In tiem step, will satnd achieve min age or volume ,or both target, if yes, then harvest
-	Could affect spatial distribution
-	Most analysts use this fxn









##	Results
The initial states of both models were the same. The study area was 355,253 ha in size, of which 73,300 hectares was THLB, the an initial merchantable growing stock was 9,717,000 m^3^. In the Castor model, the long-run sustained yield (LRSY) of current stands was calculated at 108,881 m^3^, the mean volume/ha was 179 m^3^ and the average mean annual increment (MAI) was 1.48 m^3^. The LRSY of managed stands was calculated at 235,930 m^3^. 

We then compared the maximum non-declining harvest flow of each model on an annual and decadal basis. We then adjusted the Castor maximum non-declining harvest flow to fit the STSM harvest flow and compared other indicators, including average harvest age, area harvested and merchantable growing stock (amount of volume available to be harvested in the THLB).   

### Annual Harvest Model
#### Harvest Flow
When modeling the maximum non-declining harvest flow of each model on an annual basis, the Castor model was able to harvest approximately 136,000 m^3^ per year. STSM was able to harvest approximately 134,000 m^3^ per year. Thus, Castor was able to harvest slightly more volume (~2,000 m^3^ per year, or 1.6%).

```{r, annual harvest flow, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_136000", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.fig <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "volume")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_136000"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.fig)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (130000, 140000, 500)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]


```

#### Area Harvested 
When modeling a harvest flow of approximately 133,600 m^3^ per year, the Castor model and STSM had comparable harvest area patterns, i.e., peaks and troughs in area harvested over time generally coincided in both models. However, the models began to diverge slightly at approximately year 130, where STSM harvested more area than the Castor model. From that point on, while both models followed a similar general trend in area harvested (i.e., a trough between approximately years 150 to 175 troughs a peak at approximately year 180) there were approximately 5-year differences in the timing of the peaks and troughs.

```{r, annual area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_133600", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.fig <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "area")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_133600"

tab.harvest.area <- rbind (tab.harvest.area, stsm.fig)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic()

```

#### Average Age Harvested
The Castor model and STSM harvested similar aged stands for the first 100 years when modeling a harvest flow of approximately 133,600 m^3^ per year. However, during the first 10 to 15 years of the simulation, the Castor model appears to harvest stands at maximum 250 years old, compared to STSM which harvested stands 310 to 250 years old. This was because the Castor model was set-up to make stands greater than 250 years old equal to 250 years old to make stand ages consistent with the yield curves, i.e., the yield curves used in both models only went to 250 years old. Therefore, volumes peaked at 250 years old and were level thereafter in both models, but Castor tracked these stands as 250 year old stands. Despite this difference both models harvested essentially identical aged stands from approximately year 15 to 100, suggesting this had no effect on model outputs. The average age of harvested stands differed from years 100 to 250, where the age in the Castor model steadily increased over time, whereas the age in STSM essentially was level. This difference was likely because the Castor model could potentially harvest 2% more volume over the long-term, resulting in stands being able to age slightly.

```{r, annual average age harvested, echo = F, message = F, eval = T}
tab.harvest.age <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_133600", c ("scenario", "timeperiod", "age")]
tab.harvest.age$model <- "castor"

stsm.fig <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "mnHAge_1")]
names (stsm.fig) <- c ( "timeperiod", "age")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_133600"

tab.harvest.age <- rbind (tab.harvest.age, stsm.fig)

ggplot (tab.harvest.age, aes (x = timeperiod, y = age, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Average Age Harvested") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (50, 320, 20)) +
              theme_classic()

```

#### Merchantable Growing Stock
The trends in merchantable growing stock (i.e., volume in the THLB available for harvest) were similar between the Castor model and STSM. The amount of growing stock was close to identical between the models for the first 60 years. While the trends were the same after 60 years, the amount of growing stock began to diverge between the models, where growing stock in STSM was increasingly less than growing stock in the Castor model, up to a 9% (645,000 m^3^) difference by year 250. 

```{r, annual growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "oldest_annual_noroads_noblocks_133600" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"

stsm.fig <- stsm.annual.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_133600"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic()

```
#### Spatial Harvest Location
The spatial harvest sequence was very similar for both models in the first 50 years of the simulation. However, there were some slight differences in areas that were harvested, and these differences may have contributed to the divergent harvest flows seen in both models.

```{r, stsm annual model 50 year harvest blocks map, echo = F, message = F, eval = T}
m <- c (390,400,5, 380,390,4,  370,380,3, 360,370,2, 350,360,1, 0,350,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.stsm.harvest.blocks.50.annual.rcl <- classify (rast.stsm.harvest.blocks.50.annual, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
plot (rast.stsm.harvest.blocks.50.annual.rcl,
      col = c ("forestgreen", "yellow1", "olivedrab1", "seagreen1", "dodgerblue3", "darkorchid4"),
      type = "classes",
      plg = list (title = "Decade Harvested"))

```

```{r castor annual harvest blocks map, echo = F, message = F, eval = T}

m <- c (1,10,1, 10,20,2, 20,30,3, 30,40,4, 40,50,5, 50,100,0, 0,0,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.annual.rcl <- classify (rast.castor.harvest.blocks.50.annual.133, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)

plot (rast.castor.harvest.blocks.50.annual.rcl,
      col = c ("forestgreen", "yellow1", "olivedrab1", "seagreen1", "dodgerblue3", "darkorchid4"),
      type = "classes",
      plg = list (title = "Decade Harvested"))

```

### Decadal Harvest Model
#### Harvest Flow
When modeling the maximum non-declining harvest flow of each model on a decadal basis, the Castor model was able to harvest approximately 135,000 m^3^ per year, approximately 1,000 m^3^ per year (<1%) less than in the annual model.
```{r, decadal harvest flow, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_135000", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.fig <- stsm.decadal.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "volume")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_135000"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.fig)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (130000, 140000, 500)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]


```

#### Area Harvested 
When modeling a harvest flow of approximately 133,600 m^3^ per year, the Castor model and STSM had comparable harvest area patterns, i.e., peaks and troughs in area harvested over time generally coincided in both models. However, the models began to diverge slightly at approximately year 70, where STSM harvested more area than the Castor model. From that point on, while both models followed a similar general trend in area harvested (i.e., a trough between approximately years 150 to 175 troughs a peak at approximately year 190), STSM generally harvested more area than Castor.

```{r, decadal area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_133600", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.fig <- stsm.decadal.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "area")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_decadal_noroads_noblocks_133600"

tab.harvest.area <- rbind (tab.harvest.area, stsm.fig)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic () +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

#### Merchantable Growing Stock
The trends in merchantable growing stock (i.e., volume in the THLB available for harvest) were similar between the Castor model and STSM. However, STSM had consistently higher growing stock estimates than the Castor model up to year 80, and then both models began to converge between years 80 and 250. 

```{r, decadal growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "oldest_decadal_noroads_noblocks_133600" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"

stsm.fig <- stsm.decadal.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_decadal_noroads_noblocks_133600"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic() +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

### Blocking Model
#### Characteristics of Harvest Blocks 
The spatial distribution of blocks that were predetermined in the Castor model is shown in the map below. 

```{r castor harvest units}
plot (rast.castor.preblocks,
      breaks = c (seq (from = 100000, to = 450000, 1)),
      col = topo.colors(10),
      legend = F)
```

In the Castor model, the predetermined block sizes were right-skewed (i.e., there were many smaller blocks and few large blocks). The Castor initial mean block size was 28 ha, median block size was 7 ha and maximum block size was 320 ha. This block size distribution was used to parameterize STSM and subsequent output block sizes had a mean block size of 20 ha and median block size of 8 ha. Output blocks from the Castor model had a mean block size of 22 ha and median block size of 6 ha. 

The models harvested a similar distribution of block sizes but STSM harvested more medium sized blocks (20-40 ha in size), fewer large blocks (100-200 ha in size), and more very large blocks (greater than 260 ha in size) than Castor.

```{r, block sizes}

castor.init.block.sizes <- castor.preblocks [, c ("blockid", "N")]
names (castor.init.block.sizes) <- c ( "blockid", "size")
castor.init.block.sizes$Model <- "Initial Castor Blocks"
#mean (castor.init.block.sizes$size)
#median (castor.init.block.sizes$size)

blocksdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/scenarios/comparison_stsm/stsm_compare_blocks_noroads_castordb.sqlite"))
raster.info <- data.table (dbGetQuery (blocksdb, "SELECT * FROM raster_info;"))	
ras <- terra::rast (terra::ext (raster.info$xmin, raster.info$xmax, raster.info$ymin,
                                raster.info$ymax), nrow = raster.info$nrow, 
                                ncol = raster.info$ncell/raster.info$nrow, 
                                vals =1: raster.info$ncell)
pixels <- data.table (dbGetQuery (blocksdb, "SELECT * FROM pixels;"))
dbDisconnect (blocksdb)
ras [] <- pixels$blockid
terra::crs(ras) <- "epsg:3005"

m <- c (9,11,1, 0,9,0,  11,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.10 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.10 <- rast.castor.harvest.blocks.50.block.10 * ras
castor.block.sizes.10 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.10))
m <- c (19,21,1, 0,19,0,  21,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.20 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.20 <- rast.castor.harvest.blocks.50.block.20 * ras
castor.block.sizes.20 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.20))
m <- c (29,31,1, 0,29,0,  31,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.30 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.30 <- rast.castor.harvest.blocks.50.block.30 * ras
castor.block.sizes.30 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.30))
m <- c (39,41,1, 0,39,0,  41,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.40 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.40 <- rast.castor.harvest.blocks.50.block.40 * ras
castor.block.sizes.40 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.40))
m <- c (49,51,1, 0,49,0,  51,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.50 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.50 <- rast.castor.harvest.blocks.50.block.50 * ras
castor.block.sizes.50 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.50))
castor.block.sizes <- rbind (castor.block.sizes.10, castor.block.sizes.20, castor.block.sizes.30,
                             castor.block.sizes.40, castor.block.sizes.50)
castor.block.sizes <- castor.block.sizes [, c ("value", "count")]
names (castor.block.sizes) <- c ( "blockid", "size")
castor.block.sizes$Model <- "Castor Harvest Blocks"
castor.block.sizes <- castor.block.sizes [blockid > 0]
#mean (castor.block.sizes$size)
#median (castor.block.sizes$size)

stsm.block.sizes <- stsm.blocking.block.size [Year < 51, c ("blockNum", "blockSize")]
names (stsm.block.sizes) <- c ( "blockid", "size")
stsm.block.sizes$Model <- "STSM Harvest Blocks"
#mean (stsm.block.sizes$size)
#median (stsm.block.sizes$size)

tab.block.sizes <- rbind (castor.init.block.sizes, castor.block.sizes, stsm.block.sizes)
tab.block.sizes$Model <- as.factor (tab.block.sizes$Model)
tab.block.sizes$Model <- factor(tab.block.sizes$Model, 
                                levels = c ("Initial Castor Blocks", "Castor Harvest Blocks", "STSM Harvest Blocks"))

ggplot (tab.block.sizes, 
        aes (x = size, group = Model, fill = Model)) +
  geom_histogram (aes(y = ..density..),
                  position  ="dodge",
                  binwidth = 20) +
  theme_bw () +
  scale_x_continuous (breaks = c(0, 40, 80, 120, 160, 200, 240, 280, 320, 360, 400, 440))
```

#### Harvest Flow
Both models harvested less volume when blocking was implemented. The Castor model harvested 130,000 m^3^/year with blocking, a 3% decline from the baseline model with a 133,600 m^3^/year harvest flow. The STSM model with blocking harvested 127,000 m^3^/year,a 5% decline from the baseline model harvest flow. There was a 2% difference in harvest flows between the Castor and STSM when blocking was simulated in the models. Therefore, pre-defining blocks resulted in lower timber supply in both models, but the Castor method was slightly more constraining on timber supply.

```{r, blocking harvest flow block vs. no block, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_133600" | scenario == "oldest_decadal_noroads_blocks", c ("scenario", "timeperiod", "volume")]

tab.harvest.flow$model <- "castor"

stsm.decadal <- stsm.decadal.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.decadal) <- c ( "timeperiod", "volume")
stsm.decadal$model <- "stsm"
stsm.decadal$scenario <- "oldest_decadal_noroads_noblocks_133600"

stsm.block <- stsm.blocking.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.block) <- c ( "timeperiod", "volume")
stsm.block$model <- "stsm"
stsm.block$scenario <- "oldest_decadal_noroads_blocks"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.decadal, stsm.block)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = scenario)) +
              geom_line (position = position_dodge (width = 1), size = 1, aes (linetype = model)) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Scenario", 
                                    labels = c("Blocking", "No Blocking")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (120000, 140000, 1000)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]


```

#### Area Harvested 
When blocking was implemented in the models they had similar overall patterns in the amount of area harvested over the simulation, with corresponding timing in the peaks and valleys in area harvested. However, there were differences in area harvested within those patterns. For example, the Castor model harvested more area in the first three decades of the simulation and then STSM harvested more area in the fourth to sixth decades. 

```{r, blocking area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "oldest_decadal_noroads_blocks", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.block <- stsm.blocking.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.block) <- c ( "timeperiod", "area")
stsm.block$model <- "stsm"
stsm.block$scenario <- "oldest_decadal_noroads_blocks"

tab.harvest.area <- rbind (tab.harvest.area, stsm.block)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic () +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

#### Merchantable Growing Stock
The trends in merchantable growing stock were similar between the Castor model and STSM. However, the models increasingly diverged, and this divergence became notably large at approximately year 70, where the Castor growing stock reached its plateau at approximately 5M m^3^ compared to STSM which reached its plateau at approximately 6M m^3^ before increasing to approximately 6.5M m^3^ at year 250.

```{r, decadal growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "oldest_decadal_noroads_blocks" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"
# tab.grow.stock$timeperiod <- c (seq (from = 10, to = 260, by = 10)) # need to shift the values for reporting
# tab.grow.stock [26, 2] <- 0
# tab.grow.stock [26, 3] <- 9716881

stsm.fig <- stsm.decadal.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_decadal_noroads_blocks"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic() +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

#### Spatial Harvest Location
Despite the similarities in harvest volume, blocking resulted in some differences in the spatial distribution of harvest in the two models over the first 50 years of the simulation. At the scale of the area-of-interest, the spatial distribution was generally similar, with more harvest in the southwest and northern parts in the first two to three decades of the simulation, shifting to more harvest in the eastern portion of the area in the fourth and fifth decades. However, there were some differences at finer scales. For example, there was more harvest in the northwest portion fo the area in alter decades in the Castor model compared to STSM.

```{r, stsm blocking model 50 year harvest blocks map, echo = F, message = F, eval = T, warning = F}
m <- c (390,400,5, 380,390,4,  370,380,3, 360,370,2, 350,360,1, 0,350,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.stsm.harvest.blocks.50.block.rcl <- classify (rast.stsm.harvest.blocks.50.blocking, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
plot (rast.stsm.harvest.blocks.50.block.rcl,
      col = c ("forestgreen", "yellow1", "olivedrab1", "seagreen1", "dodgerblue3", "darkorchid4"),
      type = "classes",
      plg = list (title = "Decade Harvested"))

```

```{r castor blocking harvest blocks map, echo = F, message = F, eval = T}

m <- c (1,10,1, 10,20,2, 20,30,3, 30,40,4, 40,50,5, 50,100,0, 0,0,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.rcl <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)

terra::plot (rast.castor.harvest.blocks.50.block.rcl,
              col = c ("forestgreen", "yellow1", "olivedrab1", 
                       "seagreen1", "dodgerblue3", "darkorchid4"),
              type = "classes",
              plg = list (title = "Decade Harvested"))

```


### Roads Model
#### Road Development Pattern
In the initial state of the models there were 23,938 ha (7% of the study area) that were classified as being roaded. Existing roads were concentrated in the northeast, central and southwest portions of the area of interest. Few existing roads were located in the northwest portion fo the area of interest. 

```{r initial roads map}
# sum (terra::freq (rast.castor.road.init)) # initial road count
m <- c (0,6,1)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.road.init.rcl <- classify (rast.castor.road.init, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
# sum (rast.castor.road.init.rcl[], na.rm = T)  # 23,915 ha have a road
terra::plot (rast.castor.road.init.rcl,
              col = c ("grey0"),
              legend = F) 
legend ("topright", legend = "Existing Road", fill = "grey0", cex = 0.75,  pt.cex = 1)

```

At the end of the simulation Castor had simulated roads in 38,671 ha (11%) and STSM simulated roads in 39,991 ha (11%) of the study area. Thus, STSM simulated slightly more roaded areas than Castor but they are remarkably similar (i.e., less than 1% of the area of interest).

The difference in road development patterns are illustrated below in the northwest corner of the study area where there were few existing roads at the start of the simulation. Existing roads are indicated in black and roads simulated by Castor are indicated in purple in the top figure. The bottom figure shows all roads in STSM, including existing and simulated. While the branching pattern fo the roads is somewhat different, the overall broad pattern is similar, as roads followed the least-cost path to develop a road system. 

```{r final roads castor}
# sum (terra::freq (rast.castor.road.year))
m <- c (0,0,1, 1,251,2)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.road.year.rcl <- classify (rast.castor.road.year, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)

e <- ext (999987.5, 1030000, 1200000, 1223387.5)
rast.castor.road.year.rcl.crop <- terra::crop (rast.castor.road.year.rcl, e)

terra::plot (rast.castor.road.year.rcl.crop,
      col = c ("black", "darkorchid4"),
      type = "classes",
      levels = c ("Existing Road", "New Road"),
      plg = list (title = "Road Types"))

```

```{r final roads stsm}
m <- c (0,0,0, 1,150,1)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.stsm.road.all.rcl <- classify (rast.stsm.road.all, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
# terra::freq (rast.stsm.road.all.rcl)
e <- ext (999987.5, 1030000, 1200000, 1223387.5)
rast.stsm.road.all.rcl.crop <- terra::crop (rast.stsm.road.all.rcl, e)
terra::plot (rast.stsm.road.all.rcl.crop,
      col = c ("white", "darkorchid4"),
      type = "classes",
      levels = c ("Not Roaded", "Road"),
      plg = list (title = "Road Type"))

```

  
Despite the broad-scale similarites in road development, the patterns of road development were notably different between the two models. Castor built the bulk of its roads early in the simualtion





```{r castor count roads }

castor.road.count.year <- data.table (terra::freq (rast.castor.road.year))
castor.road.count.year <- castor.road.count.year [value > 0, c ("value", "count")]
names (castor.road.count.year) <- c ( "timeperiod", "count")
castor.road.count.year$Model <- "Castor"

stsm.road.count.year <- stsm.road.record [, c ("Year", "KmRdsBuilt")]
names (stsm.road.count.year) <- c ( "timeperiod", "count")
stsm.road.count.year$count <- stsm.road.count.year$count * 10 # convert km to m (x1,000) and assume 1 ha = 100 m of road (/100)
stsm.road.count.year$Model <- "STSM"

tab.road.count <- rbind (castor.road.count.year, stsm.road.count.year)


ggplot (tab.road.count, 
        aes (x = timeperiod, y = count, group = Model, fill = Model)) +
  geom_bar (stat = "identity", position = position_dodge ()) +
  scale_y_continuous (breaks = c (0,500,1000,1500,2000,2500,3000)) +
  scale_x_continuous (breaks = c (0,25,50,75,100,125,150,175,200,225,250)) +
  labs (x = "Year", y = "Number of Roaded Pixels")
```


- count ha's of roads built in first 10 years, 50 yeas, 100 years, 250 years
- ...




## Conclusions

- Castor and STSM models are closely aligned in terms of estimating long-term timber supply; suggesting the logic of both models is consistent.

- however, Castor was able to  harvest ~2% more volume/year, because of how it updates volumes stock; in annual steps, year 1 updates volumes by 1 year, i.e., assumes harvest at the end of the year, whereas STSM does not, ie assumes harvest at the start of the year; in a decadal steps, Castor uses the mid-point volume (i.e., in the first step of the simulation it updates volumes to year 5, and then harvest and calculates growing stock) whereas STSM uses the start year volume (i.e., in the first step of the simulation it calculates harvest and growing stock); therefore Castor is a slightly more optimistic model in terms of timber supply estimates

- blocking reduces timber supply; makes sense because it contrains harvest to spceific spatial locations; both models harvested a similar volume with blocking (2% less in Castor); Castor approach of pre-blocking, or identifying homeoegnous stands that fit a block-szie distrbituion at the initiano of teh analysis had a slightly greater efefct on timber harvest flows than the STSM method of spreading to a defined patch size from a satrtign pixel; Castor allows for less spatial freedom for the model to harvest  

- Castor could be used as a timber supply model to support allowable annual cut determinations

- Castor adn STSM simualte similar road networks broadly speaking. there are differences in the pattern at fine-scales, but these are likely trivial for long-term simulation models 

- differences in periods of road development were likely due to constains in STSM on raod development (i.e., blocks coudl only be activiate within 2km of an existign road)



