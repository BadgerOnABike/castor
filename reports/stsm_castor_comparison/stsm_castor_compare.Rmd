---
title: "Comaprison of SELES/STSM to Castor/SpaDES"
author: "Tyler Muhly"
date: '2023-03-22'
output:
  word_document: default
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r, load packages and data, echo = F, message = F, eval = T, include = F}
library (terra)
library (DBI)
library (keyring)
library (data.table)
library (ggplot2)
library (scales)
library (terra)
# library (rasterVis)

data.dir <- "G:\\!Workgrp\\Analysts\\tmuhly\\clus_stsm_comparison\\results"
conn <- DBI::dbConnect (RPostgreSQL::PostgreSQL(), 
                        host=keyring::key_get('vmdbhost', keyring = 'postgreSQL'), 
                        dbname = keyring::key_get('vmdbname', keyring = 'postgreSQL'), 
                        port='5432',
                        user = keyring::key_get('vmdbuser', keyring = 'postgreSQL'),
                        password = keyring::key_get('vmdbpass', keyring = 'postgreSQL'))

# Data
## TABLES
castor.harvest.flow <- data.table (dbGetQuery (conn, "SELECT * from stsm_compare.harvest"))
castor.grow.stock <- data.table (dbGetQuery (conn, "SELECT * from stsm_compare.growingstock"))
castor.preblocks <- data.table (read.csv (paste0 (data.dir, "\\castor\\blocks.csv")))
dbDisconnect (conn)

stsm.annual.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\annual_run\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.annual.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\annual_run\\growingStock.txt"), 
                                             header = TRUE))
stsm.decadal.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\decadal_run\\oScn250\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.decadal.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\decadal_run\\oScn250\\growingStock.txt"), 
                                             header = TRUE))
stsm.blocking.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\growingStock.txt"), 
                                             header = TRUE))
stsm.blocking.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.blocking.block.size <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\BlockLIst.txt"), 
                                             header = TRUE))
stsm.road.grow.stock <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\growingStock.txt"), 
                                             header = TRUE))
stsm.road.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.road.record <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\roadRecord.txt"), 
                                             header = TRUE))
stsm.constraint.no.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\constraints\\BaseCase_zone_test_100pct_removal\\oEvenFlow\\harvestRecord.txt"), 
                                             header = TRUE))
stsm.constraint.harvest.flow <- data.table (read.table (paste0 (data.dir, "\\stsm\\tsa99\\constraints\\BaseCase_aspatial_rd0_75pct_175yrs\\oScn250\\harvestRecord.txt"), 
                                             header = TRUE))



## RASTERS
### BLOCKS
rast.castor.harvest.blocks.50.annual.133 <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\spatial_50_oldest_annual_noroads_noblocks_133600_tsa99_harvestBlocks.tif"))
rast.castor.harvest.blocks.50.block <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\oldest_decadal_noroads_blocks_tsa99_harvestBlocks_50yrs.tif"))
rast.stsm.harvest.blocks.50.annual <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\annual_run\\oScn250_1yr\\grids\\Logged_1_5.tif"))
rast.stsm.harvest.blocks.50.blocking <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_5.tif"))
rast.castor.preblocks <- terra::rast ("D:\\clus_data\\castor_stsm\\castor\\hu_blocks_no_roads.tif")

rast.stsm.blocking.harvest.blocks.1 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_1.tif"))
rast.stsm.blocking.harvest.blocks.2 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_2.tif"))
rast.stsm.blocking.harvest.blocks.3 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_3.tif"))
rast.stsm.blocking.harvest.blocks.4 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_4.tif"))
rast.stsm.blocking.harvest.blocks.5 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_no_roads\\oScn250\\grids\\Logged_1_5.tif"))

### ROADS
rast.castor.road.init <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\rast_roads_init.tif"))
rast.castor.road.status <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\oldest_decadal_roads_blocks_tsa99_mst_status_250.tif"))
rast.castor.road.year <- terra::rast (paste0 (data.dir, "\\castor\\rasters\\oldest_decadal_roads_blocks_tsa99_mst_year_250.tif"))

rast.stsm.road.10 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_1.tif"))
rast.stsm.road.20 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_2.tif"))
rast.stsm.road.30 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_3.tif"))
rast.stsm.road.40 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_4.tif"))
rast.stsm.road.50 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_5.tif"))
rast.stsm.road.60 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_6.tif"))
rast.stsm.road.70 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_7.tif"))
rast.stsm.road.80 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_8.tif"))
rast.stsm.road.90 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_9.tif"))
rast.stsm.road.100 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_10.tif"))
rast.stsm.road.110 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_11.tif"))
rast.stsm.road.120 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_12.tif"))
rast.stsm.road.130 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_13.tif"))
rast.stsm.road.140 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_14.tif"))
rast.stsm.road.150 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_15.tif"))
rast.stsm.road.160 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_16.tif"))
rast.stsm.road.170 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_17.tif"))
rast.stsm.road.180 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_18.tif"))
rast.stsm.road.190 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_19.tif"))
rast.stsm.road.200 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_20.tif"))
rast.stsm.road.210 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_21.tif"))
rast.stsm.road.220 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_22.tif"))
rast.stsm.road.230 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_23.tif"))
rast.stsm.road.240 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_24.tif"))
rast.stsm.road.250 <- terra::rast (paste0 (data.dir, "\\stsm\\tsa99\\spatial_roaded\\oScn250_roaded\\grids\\RoadState_1_25.tif"))

rast.stsm.road.all <- rast.stsm.road.250 + rast.stsm.road.240 + rast.stsm.road.230 +
                      rast.stsm.road.220 + rast.stsm.road.210 + rast.stsm.road.200 + 
                      rast.stsm.road.190 + rast.stsm.road.180 + rast.stsm.road.170 + 
                      rast.stsm.road.160 + rast.stsm.road.150 + rast.stsm.road.140 +
                      rast.stsm.road.130 + rast.stsm.road.120 + rast.stsm.road.110 +
                      rast.stsm.road.100 + rast.stsm.road.90 + rast.stsm.road.80 +
                      rast.stsm.road.70 + rast.stsm.road.60 + rast.stsm.road.50 +
                      rast.stsm.road.40 + rast.stsm.road.30 + rast.stsm.road.20 + rast.stsm.road.10

### Constraints
poly.zone.constraint <- sf::st_read ("G:\\!Workgrp\\Analysts\\tmuhly\\clus_stsm_comparison\\zone_test\\zone_test.shp", quiet = T)
rast.thlb <- terra::rast (paste0 (data.dir, "\\tsa99_thlb.tif"))

```

## Introduction
The purpose of this report is to compare [Castor, a forestry and land use simulator model](https://github.com/bcgov/castor) built using the [Spatial Discrete Event Simulation (SpaDES)](https://spades-core.predictiveecology.org/) package in program R, to the Spatially Explicit
Timber Supply Model (STSM) built using the [SELES](https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=14729e8f5430035cead9f38e708f4507c543ff9d) platform. These models were compared to test whether Castor approximates results from STSM when using the same input data to complete a timber supply analysis. 

Castor and STSM are not optimization models, i.e., they do not use an objective function to find a timber harvest pattern that will maximize the amount of timber volume that can be harvested from a forest. Instead, they spatially simulate timber harvest patterns based on heuristics regarding harvest practices, and estimate timber volume that can be harvested given those practices. Both models are programmed to harvest timber based on meeting a timber volume demand, following a harvest priority queue (e.g., oldest stands first), potentially with 'partitions' of the volume (i.e., spatial sub-zones or 'compartments', or forest stand types), and within the legal requirements of the land base (i.e., satisfy the requirements of zones with rules that restrict forest harvest in some way to meet some other objective, such as wildlife habitat). Both Castor and STSM estimate timber supply by simulating changes to forests and forest harvest activity over space and time. 

STSM has been used to estimate timber supply in support of allowable annual cut (AAC) determinations in British Columbia since the mid-2000's. Therefore, it has been refined over a relatively long-period of time and it is accepted as a valid model for completing timber supply reviews in the province. Castor was more recently developed, starting in 2017, by the Strategic Analysis Team in the Forest Analysis and Inventory Branch as an open source tool using the [R programming language](https://www.r-project.org/), which provides a relatively large user and developer base with a diversity of analytical functions (including data wrangling, statistical analyses and data visualization). To date it has primarily been used to support strategic decisions around habitat protections for species-at-risk such as caribou (*Rangifer taranadus caribou*) and fisher (*Pekania pennanti*). Therefore, Castor has not been as widely used as STSM and has not yet been approved for use in timber supply reviews.

If Castor closely approximates STSM in estimating timber supply, than it will improve confidence in output results from Castor and open the opportunity to use Castor as a model for timber supply reviews. This comparison also provides an opportunity to explore and discuss alternative approaches to simulating timber harvest and future forest conditions. 

## Methods
To compare the two models, a small timber supply area (approximately 350,000 ha in size) was created in the center of British Columbia. Both models used the same data within that area, including the same forest inventory to provide current (2022) forest stand characteristics, growth and yield estimates for natural and planted stands in the inventory, estimated from the the Variable Density Yield Projection (VDYP) and Table Interpolation Program for Stand Yields (TIPSY) models, respectively, and the timber harvest land base (THLB) to define the area of forest available to harvest.

### Model Parameters
In addition to using the same initial and projected forest conditions, the models were set-up with the same timber supply modeling parameters. This included a minimum harvest age of 80 years old, minimum harvest volume of 150 m^3^/ha, and no adjacency constraints. Each timber supply scenario (described below) was simulated to achieve a maximum sustainable harvest flow, i.e., the maximum volume that could be harvested across all time intervals without ever going down, over a 250 year simulation period. The spatial resolution of both models was 1 ha (here referred to as a *pixel*), and thus the area of interest was represented spatially as a 1 ha grid. 

Functionally, the models were set up the same way, but it is important to note that there were key differences between how these models are instantiated. STSM used a combination of raster Tag Image File Format (TIFF) images and text tables, whereas Castor used an SQLite database containing relational tables. Both models had flexibility in how things like minimum harvest criteria and the harvest queue were parameterized, but how they interacted with data was different due to the fundamental differences in their data structures. 

Castor's approach was to have the user input simple SQL queries of forest stand characteristics (e.g., age, volume, height) for setting model parameters. For example, the minimum harvest and age criteria used here was parameterized as ' vol > 149 AND age > 79 '. Similarly, and oldest first priority queue was parameterized as ' age DESC '. These queries were integrated into the model as parameters that were called within functions created in program R, and these functions were organized and scheduled using the SpaDES framework. 

STSMs approach was to use TIFFs and text files with parameter definitions specific to the [SELES modeling language](http://www.ncgia.ucsb.edu/SANTA_FE_CD-ROM/sf_papers/fall_andrew/fall.html). These get integrated into functions, and are organized and scheduled within the SELES program.

Other important differences between Castor and STSM functionality worth mentioning here were that STSM updated its harvest queue four times a year, whereas Castor's queue was calculated once at the start of a time interval, and STSM included a 'look-ahead' function, where the model determined whether a pixel or harvest block achieved the minimum harvest criteria (minimum 80 years old and volume 150 m^3^/ha) by the end of the time interval. For example, it checked whether the target was achieved at year 10 in a 10 year interval, and if it met the criteria by the end of the interval than the stand was available for harvest at any time during the interval, otherwise it was not. Castor did not have this functionality at the time of this analysis. 

### Model Scenarios
We simulated five scenarios:

1. annual time step; no blocking, no roads

2. decadal time step; no blocking, no roads

3. blocking; decadal time step; no roads

4. blocking and roads; decadal time step

5. no harvest constraint; decadal time step; no blocking, no roads 

6. forest cover constraint; annual time step; no blocking, no roads 

The first two scenarios had no roading and no harvest block definition, i.e., each 1 ha pixel was considered a harvest 'block'. Of these two scenarios, one was simulated with an annual time step to compare the two models without the effect of interpolating yield values between decadal periods (see the *Yield Update* section below for details). A second scenario was simulated with a decadal time step to show the effect of the different yield interpolation methods used by each model. The blocking and road scenarios allowed for comparison of how each model simulated harvest blocks and roads (see the *Harvest Blocking* and *Roads* sections below for details). The no harvest constraint scenario essentially removed a hypothetical zone of interest from the THLB. The forest cover constraint scenario applied an age-based constraint to the zone of interest (see the *Forest Cover Constraints* section below for details).    

### Yield Update
The Castor and STSM models had different approaches for updating growth and yield values (e.g., volume, height) of forest stands at simulation period intervals. The effect of these different approaches on timber supply estimates were tested.  

#### Castor
The Castor model updated growth and yield estimates at the mid-point of a simulation interval. Therefore, if a simulation interval was a decade, in the first interval Castor updated the growth and yield estimates of forest stands to year five of the simulation by interpolating the estimates between the initial age and initial plus ten year age from the growth and yield model. For example, if the initial stand volume was 150 m^3^/ha at year 0 of the simulation, and 170 m^3^/ha ten years from year 0, then the Castor model would use 160 m^3^/ha as the volume estimate for the stand at the first simulation interval. Castor then updated stand age and growth and yield estimates at ten year intervals from there. For any stands that were harvested in an interval, Castor updated the stand age to 0 at the mid-point. Therefore, in subsequent mid-points the stand would age 10 years. The key point here is that the amount of volume harvested is first accounted for by Castor at the middle of the first simulation interval, not the beginning or end of the interval.  

#### STSM
In contrast to Castor, STSM estimated growth and yield at each year of a simulation. When a simulation interval was longer than a year, STSM divided the harvest request equally by the number of years in the interval, and updated growth and yield estimates at each year when a stand was harvested in an interval. Therefore, if a stand was harvested in year one of a ten year interval, volume estimates were interpolated to the first year of the growth and yield estimates. For example, if the initial stand volume was 150 m^3^/ha at year 0 of the simulation, and 170 m^3^/ha ten years from year 0, and the stand was harvested in the first year of the interval, then the STSM model would use 152 m^3^/ha as the volume estimate for the stand at the first simulation interval. The year that each stand was harvested in an interval was then multiplied by -1 (e.g., year 1 = -1, year 2 = -2, year 3 = -3,  etc.) and then in the next interval stands were aged 10 years (i.e., stand ages became 9, 8, 7, etc.) and growth and yield estimates were updated accordingly. Therefore, in STSM the amount of volume harvested in an interval was accounted for annually and then summed across the simulation interval. 

###  Harvest Blocking
Scenarios with and without blocking were simulated to compare how the two models created harvest blocks, and their potential effects on harvest flow. When blocking was not simulated, both models selected harvest areas at a 1 ha spatial resolution (a pixel) using the harvest priority criteria (i.e., oldest first). Therefore, each pixel was harvested independently, in order of its age, and there was no defined spatial pattern or aggregation of pixels to form blocks.    

#### Castor
Castor used an agglomerative hierarchical clustering method to pre-define harvest blocks prior to the simulation. This method searches the landscape and groups pixels with similar forest characteristics (i.e., crown closure and height) and in close spatial proximity (i.e., Euclidean distance) into clusters that can be defined as homogeneous forest types. It evaluated whether to cluster pixels together using the Mahalanobis distance statistic, which measures how far a pixels characteristics are from the distribution of the mean value of those characteristics in neighbouring pixels. If the Mahalanobis distance was below a threshold (in this case the default value of 6), then a pixel was grouped into a cluster, otherwise it was grouped into another cluster, or formed its own cluster. Once clustering was complete, block sizes were determined by drawing from a distribution of block sizes defined for natural disturbance types (see table below), and fitting those blocks onto the landscape within the defined clusters. Larger blocks were harder to find and were therefore placed on the landscape first and subsequently smaller blocks were added until blocking was complete.

```{r, ndt block size table, echo = F, message = F, eval = T}
knitr::kable (data.table(ndt = c(1,1,1,1,1,1,
                                  2,2,2,2,2,2,
                                  3,3,3,3,3,3,
                                  4,4,4,4,4,4,
                                  5,5,5,5,5,5), 
                           sizeClass = c(40,80,120,160,200,240), 
                           freq = c(0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.2, 0.3, 0.125, 0.125, 0.125, 0.125,
                                    0.1,0.02,0.02,0.02,0.02,0.8,
                                    0.3,0.3,0.1,0.1,0.1, 0.1)),
               col.names = c("Natural Disturbance Type",
                             "Size Class (ha)",
                             "Frequency"),
              align = "ccc")

```

#### STSM
STSM did not pre-define harvest blocks, but instead used a spreading algorithm to create blocks during the simulation. It selected pixels to harvest based on the harvest priority queue, then selected a block size from a uniform distribution (defined using the block size outputs obtained form Castor). The model then 'spread' from the selected pixel to neighbouring pixels based on age threshold criteria, where it was only able to spread to a neighbouring pixel that was within 20% of the age of the origin pixel, up to the selected block size. Block size targets were considered 'soft', i.e., they were approximate targets, and they were required to be a minimum of 10 ha in size.   

### Roads
Castor and STSM had different approaches to creating road networks related to forest harvest. Simulations of both models were run to compare outputs of the roading algorithms and assess whether they achieved similar results. Below provides a description of the different approaches used by each model. 

#### Castor
Castor could simulate roads using multiple approaches, but the preferred method, described here, used a dynamic minimum spanning tree (MST) to create roads within a simulation. Castor pre-defined potential road networks by identifying a pixel on the edge of each pre-defined harvest block (see *Harvest Blocking*, above) as a 'landing' from which timber would be hauled. Castor then solved the least-cost path of interconnected pixels from each landing to other landings, existing roads and pixels on the edge of the area of interest using [Dijkstra’s algorithm](https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm). The least cost paths could follow a queen's case, where all eight neighbouring pixels were considered in a path. 

During the simulation, as harvest blocks were selected by the harvest priority queue, Castor 'built' the network of roads dynamically by connecting the landings in the selected blocks to existing roads (or the edge of the area of interest), following the identified least cost path in a MST. The MST connected all of the selected landings using [Kruskal's algorithm](https://en.wikipedia.org/wiki/Kruskal%27s_algorithm), which sorted the potential routes by their cost, and added the least costly road connections, without a loop or cycle, until the network was completed.

The least-cost path was solved using a spatial cost-surface model, where each pixel was attributed a cost of building a road based on factors such as terrain, water and land designations. The same cost-surface model was used in both the Castor model and STSM, but the relative difference in cost values were inflated for use in Castor by taking the square of the cost values. Therefore, instead of values between 1 and 62, the values were scaled between 1 and 3844. We found this was necessary to fit reasonable least-cost paths in Castor based on review of the outputs.

#### STSM
STSM also pre-processed the road network, but the network was not dynamically created during a simulation, Instead the entire network was 'built' at the start of the simulation and roads were dynamically activated or deactivated during the simulation as they were needed to access blocks selected in the harvest queue.

Similar to Castor, inputs to the STSM model included a cost-surface and existing road network. In addition, STSM required the location of 'exit points' (i.e., destinations), which were locations where timber hauling ended, such as mills or the exit locations of highways from the area of interest.  

STSM pre-processed a simulated road network by randomly selecting locations in areas of the THLB that were greater than 1 km from an existing road. Locations further from an existing road had a higher probability of being selected. STSM then iteratively connected the random locations to destination points following a least-cost path until all locations were within 1 km from an existing road. Therefore, an entire road network that could connect to all locations within 1 km of any portion of THLB was created prior to the simulation. During the simulation, as blocks were selected in the harvest queue, a landing was selected in the block and a straight line (as a crow flies) road was created to connect it to the road network (existing or simulated roads).    

When running the STSM simulation, an additional constraint was included to limit the harvest queue to blocks less than 2 km from an active road. This had the effect of limiting the extent of road development from one time interval to the next. This constraint was not implemented in Castor. 

### Forest Cover Constraints
Here we included two scenarios to compare how Castor and STSM set aside areas to meet forest cover constraints. We created a 'dummy' zone over the THLB in the eastern portion of the area of interest. In one scenario we set this as a no harvest zone, and in a second scenario we created a forest cover constraint where 75% of the productive forest (i.e., forested areas with a site index > 5) within teh zone had to be greater than or equal to 175 years old. The no harvest scenario was run on a decadal time step and the forest cover constraint scenario was run with an annual time step to facilitate comparison.  

Both models used the same general approach to defining cover constraints, where a variable of interest (i.e., the forest stand or landscape condition that is desired), must achieve a desired threshold (i.e., greater than or less than a target value for the variable), over a specific percentage of the zone, within a land base definition (i.e., denominator) for the zone. However, there were differences in how each model selected areas to achieve forest cover constraints. These differences are described in more detail below. 

#### Castor
The Castor model set forest cover constraints by reserving pixels in the zone that were above the desired threshold for the variable of interest (e.g., age, height, volume), in order from the highest to lowest values of the variable, up to when a sufficient percentage of area had been reserved. For example, in this analysis Castor reserved areas of productive forest in the zone that were greater than 175 years old, starting with the oldest pixels, up to when 75% of the productive forest in the zone had been reserved. If the reserve area was not achievable, than it became a *de facto* no harvest area. Otherwise areas in the zone outside of the reserved pixels could be harvested, assuming they met the minimum harvest criteria and were selected in the harvest queue. Constraints were re-calculated at each interval of the simulation period. Note that in more complex cases (not tested here) with multiple overlapping zones with different forest cover constraints, Castor also prioritized selecting pixels in a zone that both met the desired condition of the zone and were previously reserved to meet a constraint in another zone. 

#### STSM
STSM used a slightly different approach to reserving pixels in forest cover constraint zones. STSM reserved pixels above the desired threshold of the variable of interest in the area of interest in ascending order of the variable until a sufficient percentage of area had been reserved. Therefore, a key difference between Castor and STSM was that STSM was more likely to allow harvest of areas well above the threshold value of the variable of interest whereas Castor was more likely to allow harvest of areas slightly above the threshold. For example, in this analysis Castor would reserve the oldest pixels of the productive forest in the constraint zone, whereas STSM could allow for harvest of the oldest pixels, assuming the desired condition was met by reserving pixels just above the 175 year old threshold. 

If the percentage of reserve area was not met by reserving pixels in ascending order above the threshold, then STSM reserved additional pixels below the threshold in descending order of the variable, until the threshold was met. In cases where the percentage of area was not met than it became a no harvest zone. STSM re-calculated constraints four times a year in a simulation, regardless of the time interval used.     

##	Results
The initial states of both models were checked to confirm that they were the same. The study area was 355,253 ha in size, of which 73,300 hectares was THLB, and the initial merchantable growing stock was 9,717,000 m^3^. In both models, the long-run sustained yield (LRSY) of current stands was calculated at 108,881 m^3^, the mean volume/ha was 179 m^3^ and the average mean annual increment (MAI) was 1.48 m^3^. The LRSY of managed stands was calculated at 235,930 m^3^. 

Below we compare the maximum non-declining harvest flow of each model for each scenario. As these harvest flows differed between both models, we also ran scenarios where we adjusted the Castor maximum non-declining harvest flow to fit the STSM harvest flow and compared the outputs, including average harvest age, area harvested and merchantable growing stock (i.e., amount of volume available to be harvested in the THLB).   

### Annual Harvest Simulation
#### Harvest Flow
When modeling the maximum non-declining harvest flow of each model on an annual basis, the Castor model was able to harvest approximately 136,000 m^3^ per year. STSM was able to harvest approximately 133,600 m^3^ per year. Thus, Castor was able to harvest slightly more volume (~1,400 m^3^ per year, or 2%).

```{r, annual harvest flow, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_136000", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.fig <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "volume")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_136000"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.fig)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (130000, 140000, 500)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]


```

#### Area Harvested 
When modeling a harvest flow of approximately 133,600 m^3^ per year, the Castor model and STSM had comparable harvest area patterns, i.e., peaks and troughs in area harvested over time generally coincided in both models. However, the models began to diverge slightly at approximately year 130, where STSM harvested more area than the Castor model. From that point on, while both models followed a similar general trend in area harvested (i.e., a trough between approximately years 150 to 175 and a peak at approximately year 180) there were approximately 5-year differences in the timing of the peaks and troughs.

```{r, annual area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_133600", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.fig <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "area")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_133600"

tab.harvest.area <- rbind (tab.harvest.area, stsm.fig)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic()

```

#### Average Age Harvested
The Castor model and STSM harvested similar aged stands for the first 100 years when modeling a harvest flow of approximately 133,600 m^3^ per year. However, during the first 10 to 15 years of the simulation, the Castor model appears to harvest stands at maximum 250 years old, compared to STSM which harvested stands 310 to 250 years old. This was because the Castor model was set-up to make stands greater than 250 years old equal to 250 years old to make stand ages consistent with the yield curves, i.e., the yield curves used in both models only went to 250 years old. Therefore, volumes were the same in both models for stands greater than 250 years old, but Castor tracked these stands as 250 year old stands. Despite this difference, both models harvested essentially identical aged stands from approximately year 15 to 100. The average age of harvested stands differed from years 100 to 250, where the age in the Castor model steadily increased over time, whereas the age in STSM was essentially level. This difference was likely because the Castor model could potentially have harvested 2% more volume over the long-term, resulting in stands being able to age slightly more in the Castor simulation than in STSM.

```{r, annual average age harvested, echo = F, message = F, eval = T}
tab.harvest.age <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_133600", c ("scenario", "timeperiod", "age")]
tab.harvest.age$model <- "castor"

stsm.fig <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "mnHAge_1")]
names (stsm.fig) <- c ( "timeperiod", "age")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_133600"

tab.harvest.age <- rbind (tab.harvest.age, stsm.fig)

ggplot (tab.harvest.age, aes (x = timeperiod, y = age, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Average Age Harvested") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (50, 320, 20)) +
              theme_classic()

```

#### Merchantable Growing Stock
The trends in merchantable growing stock (i.e., volume in the THLB available for harvest) were similar between the Castor model and STSM. The amount of growing stock was close to identical between the models for the first 60 years. While the trends were the same after 60 years, the amount of growing stock began to diverge between the models, where growing stock in STSM was increasingly less than growing stock in the Castor model, up to a 9% (645,000 m^3^) difference by year 250. 

```{r, annual growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "oldest_annual_noroads_noblocks_133600" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"

stsm.fig <- stsm.annual.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_133600"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic()

```

#### Spatial Harvest Location
The spatial harvest sequence was very similar for both models in the first 50 years of the simulation, but not identical. The slight differences in areas that were harvested may have contributed to the divergent harvest flows seen in both models.

```{r, stsm annual model 50 year harvest blocks map, echo = F, message = F, eval = T}
m <- c (390,400,5, 380,390,4,  370,380,3, 360,370,2, 350,360,1, 0,350,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.stsm.harvest.blocks.50.annual.rcl <- classify (rast.stsm.harvest.blocks.50.annual, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
plot (rast.stsm.harvest.blocks.50.annual.rcl,
      col = c ("forestgreen", "yellow1", "olivedrab1", "seagreen1", "dodgerblue3", "darkorchid4"),
      type = "classes",
      plg = list (title = "Decade Harvested"))
title ("STSM Harvest Locations")

```

```{r castor annual harvest blocks map, echo = F, message = F, eval = T}

m <- c (1,10,1, 10,20,2, 20,30,3, 30,40,4, 40,50,5, 50,100,0, 0,0,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.annual.rcl <- classify (rast.castor.harvest.blocks.50.annual.133, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)

plot (rast.castor.harvest.blocks.50.annual.rcl,
      col = c ("forestgreen", "yellow1", "olivedrab1", "seagreen1", "dodgerblue3", "darkorchid4"),
      type = "classes",
      plg = list (title = "Decade Harvested"))
title ("Castor Harvest Locations")

```

### Decadal Harvest Simulation
#### Harvest Flow
When modeling the maximum non-declining harvest flow of each model on a decadal basis, the Castor model was able to harvest approximately 135,000 m^3^ per year, approximately 1,000 m^3^ per year (<1%) less than in the annual model.
```{r, decadal harvest flow, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_135000", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.fig <- stsm.decadal.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "volume")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_annual_noroads_noblocks_135000"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.fig)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (130000, 140000, 500)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]


```

#### Area Harvested 
When modeling a harvest flow of approximately 133,600 m^3^ per year, the Castor model and STSM had comparable harvest area patterns, i.e., peaks and troughs in area harvested over time generally coincided in both models. However, the models began to diverge slightly at approximately year 70, where STSM harvested more area than the Castor model. From that point on, while both models followed a similar general trend in area harvested (i.e., a trough between approximately years 150 to 175 and a peak at approximately year 190), STSM generally harvested more area than Castor.

```{r, decadal area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_133600", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.fig <- stsm.decadal.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.fig) <- c ( "timeperiod", "area")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_decadal_noroads_noblocks_133600"

tab.harvest.area <- rbind (tab.harvest.area, stsm.fig)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic () +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

#### Merchantable Growing Stock
The trends in merchantable growing stock were similar between the Castor model and STSM. However, STSM had consistently higher growing stock estimates than the Castor model up to year 80, and then both models began to converge between years 80 to 250. 

```{r, decadal growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "oldest_decadal_noroads_noblocks_133600" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"

stsm.fig <- stsm.decadal.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_decadal_noroads_noblocks_133600"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic() +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

### Blocking Simulation
#### Characteristics of Harvest Blocks 
The spatial distribution of blocks that were predetermined in the Castor model is shown in the map below. 

```{r castor harvest units, echo = F, message = F, eval = T}
plot (rast.castor.preblocks,
      breaks = c (seq (from = 100000, to = 450000, 1)),
      col = topo.colors(10),
      legend = F)
```

In the Castor model, the predetermined block sizes were right-skewed (i.e., there were many smaller blocks and few large blocks). The Castor initial mean block size was 28 ha, median block size was 7 ha and maximum block size was 320 ha. This block size distribution was used to parameterize STSM and thus average output of harvest block sizes were similar between STSM and Castor. STSM had a mean harvest block size of 20 ha and median block size of 8 ha, and Castor had a mean harvest block size of 22 ha and median block size of 6 ha. Both models harvested a similar distribution of block sizes but STSM harvested more medium sized blocks (20-40 ha in size), fewer large blocks (100-200 ha in size), and more very large blocks (greater than 260 ha in size) than Castor.

```{r, block sizes, echo = F, message = F, eval = T}

castor.init.block.sizes <- castor.preblocks [, c ("blockid", "N")]
names (castor.init.block.sizes) <- c ( "blockid", "size")
castor.init.block.sizes$Model <- "Initial Castor Blocks"
#mean (castor.init.block.sizes$size)
#median (castor.init.block.sizes$size)

blocksdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/scenarios/comparison_stsm/stsm_compare_blocks_noroads_castordb.sqlite"))
raster.info <- data.table (dbGetQuery (blocksdb, "SELECT * FROM raster_info;"))	
ras <- terra::rast (terra::ext (raster.info$xmin, raster.info$xmax, raster.info$ymin,
                                raster.info$ymax), nrow = raster.info$nrow, 
                                ncol = raster.info$ncell/raster.info$nrow, 
                                vals =1: raster.info$ncell)
pixels <- data.table (dbGetQuery (blocksdb, "SELECT * FROM pixels;"))
dbDisconnect (blocksdb)
ras [] <- pixels$blockid
terra::crs(ras) <- "epsg:3005"

m <- c (9,11,1, 0,9,0,  11,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.10 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.10 <- rast.castor.harvest.blocks.50.block.10 * ras
castor.block.sizes.10 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.10))
m <- c (19,21,1, 0,19,0,  21,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.20 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.20 <- rast.castor.harvest.blocks.50.block.20 * ras
castor.block.sizes.20 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.20))
m <- c (29,31,1, 0,29,0,  31,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.30 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.30 <- rast.castor.harvest.blocks.50.block.30 * ras
castor.block.sizes.30 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.30))
m <- c (39,41,1, 0,39,0,  41,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.40 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.40 <- rast.castor.harvest.blocks.50.block.40 * ras
castor.block.sizes.40 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.40))
m <- c (49,51,1, 0,49,0,  51,Inf,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.50 <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
rast.castor.harvest.blocks.50.block.50 <- rast.castor.harvest.blocks.50.block.50 * ras
castor.block.sizes.50 <- data.table (terra::freq (rast.castor.harvest.blocks.50.block.50))
castor.block.sizes <- rbind (castor.block.sizes.10, castor.block.sizes.20, castor.block.sizes.30,
                             castor.block.sizes.40, castor.block.sizes.50)
castor.block.sizes <- castor.block.sizes [, c ("value", "count")]
names (castor.block.sizes) <- c ( "blockid", "size")
castor.block.sizes$Model <- "Castor Harvest Blocks"
castor.block.sizes <- castor.block.sizes [blockid > 0]
#mean (castor.block.sizes$size)
#median (castor.block.sizes$size)

stsm.block.sizes <- stsm.blocking.block.size [Year < 51, c ("blockNum", "blockSize")]
names (stsm.block.sizes) <- c ( "blockid", "size")
stsm.block.sizes$Model <- "STSM Harvest Blocks"
#mean (stsm.block.sizes$size)
#median (stsm.block.sizes$size)

tab.block.sizes <- rbind (castor.init.block.sizes, castor.block.sizes, stsm.block.sizes)
tab.block.sizes$Model <- as.factor (tab.block.sizes$Model)
tab.block.sizes$Model <- factor(tab.block.sizes$Model, 
                                levels = c ("Initial Castor Blocks", "Castor Harvest Blocks", "STSM Harvest Blocks"))

ggplot (tab.block.sizes, 
        aes (x = size, group = Model, fill = Model)) +
  geom_histogram (aes(y = ..density..),
                  position  ="dodge",
                  binwidth = 20) +
  theme_bw () +
  scale_x_continuous (breaks = c(0, 40, 80, 120, 160, 200, 240, 280, 320, 360, 400, 440))
```

#### Harvest Flow
Both models harvested less volume when blocking was implemented. The Castor model harvested 130,000 m^3^/year with blocking, a 3% decline (3,600 m^3^/year) from the Castor model without blocking. The STSM model with blocking harvested 127,000 m^3^/year, a 5% decline (6,600 m^3^/year) from the STSM model without blocking. There was approximately 2% less volume harvested in STSM compared to the Castor model when blocking was simulated in the models. Therefore, pre-defining blocks resulted in lower timber supply in both models, but the STSM method was slightly more constraining on timber supply.

```{r, blocking harvest flow block vs. no block, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_133600" | scenario == "oldest_decadal_noroads_blocks", c ("scenario", "timeperiod", "volume")]

tab.harvest.flow$model <- "castor"

stsm.decadal <- stsm.decadal.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.decadal) <- c ( "timeperiod", "volume")
stsm.decadal$model <- "stsm"
stsm.decadal$scenario <- "oldest_decadal_noroads_noblocks_133600"

stsm.block <- stsm.blocking.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.block) <- c ( "timeperiod", "volume")
stsm.block$model <- "stsm"
stsm.block$scenario <- "oldest_decadal_noroads_blocks"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.decadal, stsm.block)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = scenario)) +
              geom_line (position = position_dodge (width = 1), size = 1, aes (linetype = model)) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Scenario", 
                                    labels = c("Blocking", "No Blocking")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (120000, 140000, 1000)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]


```

#### Area Harvested 
When blocking was implemented in the models they had similar overall patterns in the amount of area harvested throughout the simulation, with corresponding timing in the peaks and valleys in area harvested. However, there were small differences in the amount of area harvested at a given time period, and the general trend was that Castor consistently harvested more area than STSM, with a few exceptions (e.g., decades 80 and 90).

```{r, blocking area harvested, echo = F, message = F, eval = T}
tab.harvest.area <- castor.harvest.flow [scenario == "oldest_decadal_noroads_blocks", c ("scenario", "timeperiod", "area")]
tab.harvest.area$model <- "castor"

stsm.block <- stsm.blocking.harvest.flow [ScenarioId == 1, c ("Year", "aHarv_1")]
names (stsm.block) <- c ( "timeperiod", "area")
stsm.block$model <- "stsm"
stsm.block$scenario <- "oldest_decadal_noroads_blocks"

tab.harvest.area <- rbind (tab.harvest.area, stsm.block)

ggplot (tab.harvest.area, aes (x = timeperiod, y = area, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Area Harvested (ha)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (250, 700, 50)) +
              theme_classic () +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

#### Merchantable Growing Stock
The overall trends in merchantable growing stock were similar between the Castor model and STSM. However, the models increasingly diverged, and this divergence increased quite a bit at approximately year 70, where the Castor growing stock reached a plateau at approximately 5M m^3^ compared to STSM which reached approximately 6M m^3^ before increasing to approximately 6.5M m^3^ at year 250.

```{r, blocking growing stock, echo = F, message = F, eval = T}
tab.grow.stock <- castor.grow.stock [scenario == "oldest_decadal_noroads_blocks" & compartment == "tsa99", c ("scenario", "timeperiod", "m_gs")]
names (tab.grow.stock) <- c ("scenario", "timeperiod", "growing_stock")
tab.grow.stock$model <- "castor"
# tab.grow.stock$timeperiod <- c (seq (from = 10, to = 260, by = 10)) # need to shift the values for reporting
# tab.grow.stock [26, 2] <- 0
# tab.grow.stock [26, 3] <- 9716881

stsm.fig <- stsm.decadal.grow.stock [ScenarioId == 1, c ("Year", "THLB_1")]
names (stsm.fig) <- c ( "timeperiod", "growing_stock")
stsm.fig$model <- "stsm"
stsm.fig$scenario <- "oldest_decadal_noroads_blocks"

tab.grow.stock <- rbind (tab.grow.stock, stsm.fig)

ggplot (tab.grow.stock, aes (x = timeperiod, y = growing_stock, color = model, linetype = model)) +
              geom_line (position = position_dodge (width = 1), size = 1) + 
              labs (x = "Future Year", 
                    y = "Growing Stock (m3)") + 
              scale_color_discrete (name = "Model", 
                                    labels = c("Castor", "STSM")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text (size = 10),
                     legend.text = element_text (size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 10)) +
              scale_y_continuous (label = comma, breaks = seq (5000000, 10000000, 500000)) +
              theme_classic() +
              theme (axis.text.x = element_text (angle = 45, hjust = 1))

```

#### Spatial Harvest Location
Despite the similarities in harvest volume flows, blocking resulted in some differences in the spatial distribution of harvest between the two models over the first 50 years of the simulation. At the scale of the area-of-interest, the spatial distribution was generally similar, with more harvest in the southwest and northern parts in the first two to three decades of the simulation, shifting to more harvest in the eastern portion of the area in the fourth and fifth decades. However, there were some differences at finer scales. For example, there was more harvest in the northwest portion of the area in later decades in the Castor model compared to STSM.

```{r, stsm blocking model 50 year harvest blocks map, echo = F, message = F, eval = T, warning = F}
m <- c (390,400,5, 380,390,4,  370,380,3, 360,370,2, 350,360,1, 0,350,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.stsm.harvest.blocks.50.block.rcl <- classify (rast.stsm.harvest.blocks.50.blocking, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
plot (rast.stsm.harvest.blocks.50.block.rcl,
      col = c ("forestgreen", "yellow1", "olivedrab1", "seagreen1", "dodgerblue3", "darkorchid4"),
      type = "classes",
      plg = list (title = "Decade Harvested"))
title ("STSM Harvest Locations")

```

```{r castor blocking harvest blocks map, echo = F, message = F, eval = T}

m <- c (1,10,1, 10,20,2, 20,30,3, 30,40,4, 40,50,5, 50,100,0, 0,0,0)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.harvest.blocks.50.block.rcl <- classify (rast.castor.harvest.blocks.50.block, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)

terra::plot (rast.castor.harvest.blocks.50.block.rcl,
              col = c ("forestgreen", "yellow1", "olivedrab1", 
                       "seagreen1", "dodgerblue3", "darkorchid4"),
              type = "classes",
              plg = list (title = "Decade Harvested"))
title ("Castor Harvest Locations")

```


### Roads Simulation
#### Road Development Pattern
In the initial state of the models there were 23,938 ha (7% of the study area) that were classified as being roaded. Existing roads were concentrated in the northeast, central and southwest portions of the area of interest. Few existing roads were located in the northwest portion of the area of interest. 

```{r initial roads map, echo = F, message = F, eval = T}
# sum (terra::freq (rast.castor.road.init)) # initial road count
m <- c (0,6,1)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.road.init.rcl <- classify (rast.castor.road.init, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
# sum (rast.castor.road.init.rcl[], na.rm = T)  # 23,915 ha have a road
terra::plot (rast.castor.road.init.rcl,
              col = c ("grey0"),
              legend = F) 
legend ("topright", legend = "Existing Road", fill = "grey0", cex = 0.75,  pt.cex = 1)

```

At the end of the road simulation, Castor had simulated roads in 38,671 ha (11%) and STSM simulated roads in 39,991 ha (11%) of the area of interest. Thus, STSM simulated slightly more roaded areas than Castor but they were remarkably similar (i.e., a difference of less than 1% of the area of interest).

The difference in road development patterns are illustrated below in the northwest corner of the study area where there were few existing roads at the start of the simulation. Existing roads are indicated in black and roads simulated by Castor are indicated in purple in the top figure. The bottom figure shows all roads in STSM, including existing and simulated. While the branching pattern fo the roads is somewhat different, the overall broad pattern is similar, as roads followed the least-cost path to develop a road system. 

```{r final roads castor, echo = F, message = F, eval = T}
# sum (terra::freq (rast.castor.road.year))
m <- c (0,0,1, 1,251,2)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.castor.road.year.rcl <- classify (rast.castor.road.year, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)

e <- ext (999987.5, 1030000, 1200000, 1223387.5)
rast.castor.road.year.rcl.crop <- terra::crop (rast.castor.road.year.rcl, e)

terra::plot (rast.castor.road.year.rcl.crop,
      col = c ("black", "darkorchid4"),
      type = "classes",
      levels = c ("Existing Road", "Simulated Road"),
      plg = list (title = "Road Types"),
      main = "Castor Simulated Roads")

```

```{r final roads stsm, echo = F, message = F, eval = T}
m <- c (0,0,0, 1,150,1)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.stsm.road.all.rcl <- classify (rast.stsm.road.all, 
                                                    rcl = rclmat,
                                                    include.lowest = T,
                                                    right = T)
# terra::freq (rast.stsm.road.all.rcl)
e <- ext (999987.5, 1030000, 1200000, 1223387.5)
rast.stsm.road.all.rcl.crop <- terra::crop (rast.stsm.road.all.rcl, e)
terra::plot (rast.stsm.road.all.rcl.crop,
      col = c ("white", "darkorchid4"),
      type = "classes",
      levels = c ("Not Roaded", "Road"),
      plg = list (title = "Road Type"),
      main = "STSM Simulated Roads")

```

Despite the broad-scale similarities in road development, the patterns in the timing of road development were notably different between the two models. Castor built the bulk of its roads early in the simulation, exclusively following the 'oldest first' priority queue, whereas STSM included additional constraints, i.e., blocks must be within 2km of the active road network. This essentially delayed road development in STSM relative to Castor to approximately the middle of the simulation (i.e., years 75 to 125).

```{r castor count roads, echo = F, message = F, eval = T }

castor.road.count.year <- data.table (terra::freq (rast.castor.road.year))
castor.road.count.year <- castor.road.count.year [value > 0, c ("value", "count")]
names (castor.road.count.year) <- c ( "timeperiod", "count")
castor.road.count.year$Model <- "Castor"

stsm.road.count.year <- stsm.road.record [, c ("Year", "KmRdsBuilt")]
names (stsm.road.count.year) <- c ( "timeperiod", "count")
stsm.road.count.year$count <- stsm.road.count.year$count * 10 # convert km to m (x1,000) and assume 1 ha = 100 m of road (/100)
stsm.road.count.year$Model <- "STSM"

tab.road.count <- rbind (castor.road.count.year, stsm.road.count.year)


ggplot (tab.road.count, 
        aes (x = timeperiod, y = count, group = Model, fill = Model)) +
  geom_bar (stat = "identity", position = position_dodge ()) +
  scale_y_continuous (breaks = c (0,500,1000,1500,2000,2500,3000)) +
  scale_x_continuous (breaks = c (0,25,50,75,100,125,150,175,200,225,250)) +
  labs (x = "Year", y = "Number of Roaded Pixels")
```

### No Harvest Constraint Simulation
When the models were run with a no harvest zone in the eastern portion of the area of interest (outlined in green over the timber harvest land base), the Castor model harvested 117,500 m^3^/year, 12% less than without the no harvest zone, and the STSM model harvested 120,216 m^3^/year, 10% less than without the no harvest zone. Thus the two models were approximately 2% different, consistent with the harvest flow without constraints.

```{r zone constraint map, echo = F, message = F, eval = T}

poly.zone.constraint <- terra::vect (poly.zone.constraint)

m <- c (0,0,0, 1,2000,20, 2000,4000,40, 4000,6000,60, 6000,8000,80, 8000,10000,100)
rclmat <- matrix (m, ncol = 3, byrow = TRUE)
rast.thlb.rcl <- classify (rast.thlb, 
                           rcl = rclmat,
                           include.lowest = T,
                           right = T)

terra::plot (rast.thlb.rcl,
             col = c ("white", "salmon1", "violetred3", "magenta4", "darkorchid4", "black"),
             type = "classes",
             plg = list (title = "Timber Harvest 
Land Base (%)"))
terra::polys (poly.zone.constraint, border="green", lwd = 3, alpha = 0)

```

```{r harvest flow constraint, no harvest, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_decadal_noroads_noblocks_133600" | scenario == "oldest_decadal_noroads_noblocks_constraint", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.decadal <- stsm.decadal.harvest.flow [ScenarioId == 1 & Year < 251, c ("Year", "vHarv_1")]
names (stsm.decadal) <- c ( "timeperiod", "volume")
stsm.decadal$model <- "stsm"
stsm.decadal$scenario <- "oldest_decadal_noroads_noblocks_133600"

stsm.constraint <- stsm.constraint.no.harvest.flow [ScenarioId == 1 & Year < 251, c ("Year", "vHarv_1")]
names (stsm.constraint) <- c ( "timeperiod", "volume")
stsm.constraint$model <- "stsm"
stsm.constraint$scenario <- "oldest_decadal_noroads_noblocks_constraint"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.decadal, stsm.constraint)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = scenario)) +
              geom_line (position = position_dodge (width = 1), size = 1, aes (linetype = model)) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Scenario", 
                                    labels = c("No Constraint", "Constraint")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (100000, 140000, 1000)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]

```

### Forest Cover Constraint Simulation
When the models were run with a modified harvest zone (i.e., at least 75% of the productive forest in the zone greater than 175 year-old forest) in the eastern portion of the area of interest, the Castor model harvested 123,500 m^3^/year, 9% less than without the modified harvest zone, and the STSM model harvested 125,000 m^3^/year, 6% less than without the no modified zone. The difference between the two models was 1,500 m^3^/year (approximately 2%).

```{r harvest flow constraint, modifed harvest, echo = F, message = F, eval = T}

tab.harvest.flow <- castor.harvest.flow [scenario == "oldest_annual_noroads_noblocks_constraint_modified_aflb" | scenario ==  "oldest_annual_noroads_noblocks_136000", c ("scenario", "timeperiod", "volume")]
tab.harvest.flow$model <- "castor"

stsm.decadal <- stsm.annual.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.decadal) <- c ( "timeperiod", "volume")
stsm.decadal$model <- "stsm"
stsm.decadal$scenario <- "oldest_annual_noroads_noblocks_136000"

stsm.constraint <- stsm.constraint.harvest.flow [ScenarioId == 1, c ("Year", "vHarv_1")]
names (stsm.constraint) <- c ( "timeperiod", "volume")
stsm.constraint$model <- "stsm"
stsm.constraint$scenario <- "oldest_annual_noroads_noblocks_constraint_modified_aflb"

tab.harvest.flow <- rbind (tab.harvest.flow, stsm.decadal, stsm.constraint)

ggplot (tab.harvest.flow, aes (x = timeperiod, y = volume, color = scenario)) +
              geom_line (position = position_dodge (width = 1), size = 1, aes (linetype = model)) + 
              labs (x = "Future Year", 
                    y = "Volume Harvested (m3)") + 
              scale_color_discrete (name = "Scenario", 
                                    labels = c("No Constraint", "Constraint")) +
              scale_linetype_discrete (name = "Model", 
                                      labels = c("Castor", "STSM")) +
              theme (legend.position = c (0.15, 0.15),
                     legend.title = element_text(size = 10),
                     legend.text = element_text( size = 8)) +
              scale_x_continuous (breaks = seq(0, 250, 25)) +
              scale_y_continuous (label = comma, breaks = seq (100000, 140000, 1000)) +
              theme_classic()

#tab.harvest.flow[ , list (mean = mean (volume)), by = model]

```

## Conclusions
We conclude that Castor and STSM are similar in terms of estimating long-term timber supply despite the minor differences in logic between both models. However, at its simplest parameterization, Castor was able to harvest ~2% more timber volume per year than STSM, and thus appears to be slightly more optimistic in terms of timber supply estimates. This difference was likely because the models used different methods to update forest stand volumes at each time interval, i.e., Castor updated volume to the midpoint of a time interval, whereas STSM updated volume each year. In all scenarios, growing stock, age and area harvested indicators generally diverged between Castor and STSM as the simulation progressed. While these divergences did not result in significantly different timber supply estimates over a 250 year simulation period, it is worth noting that model outputs are less likely to be the same, the longer that a simulation is run. 

When blocking was implemented, the timber supply was reduced by a similar amount in both models with a 2% difference between them. Again, STSM harvested 2% less timber volume than Castor, suggesting that the different blocking methods used in each model achieved similar results. However, Castor consistently harvested more area when blocking was implemented, suggesting that somehow Castor's pre-blocking algorithm was causing the model to harvest more area to obtain similar volumes as STSM. The homogenization of harvest blocks in Castor may have resulted in the creation of relatively larger and lower volume harvest blocks compared to STSMs spreading approach. 

At a coarse scale, Castor and STSM simulated similar amounts of roads. There were differences in the road development pattern at fine-scales, but these did not appear to result in significant differences in the road pattern across larger areas and over a long-term simulation period. The fine-scale differences in the simulated patterns likely reflect the differences between allowing some dynamic development of roads in response to the harvest queue (Castor) and pre-determination of the entire road network (STSM). The STSM approach assumes perfect information of harvest locations across the simulation time horizon, whereas the Castor approach assumes limited information concerning harvest locations (i.e., a single period of locations). Pre-determination of the entire road network may result in greater efficiency in road development in some cases, whereas a dynamic approach may allow for flexibility, which may be useful in scenarios where other ecological drivers of landscape change, such as fire, influence the harvest queue. The differences in the timing of road development were likely simply due to the additional constraint in STSM to limit the harvest queue to blocks within 2 km of a road. If a similar constraint were applied in Castor it would likely approximate the road development pattern seen in STSM.   

When forest cover constraints were applied, again the models were within 2% of each other in terms of annual timber supply. However, in this case STSM was able to achieve slightly more volume than the Castor model, likely due to the differences in how each model reserved areas to achieve the cover constraints. STSMs approach to reserving pixels in the zone in ascending order above the variable threshold, compared to Castors approach of reserving pixels in descending order from the highest value in the zone likely allowed STSM to harvest slightly older stands and thus achieve greater volume from zones with forest cover constraints 

In summary, with the same data and parameterizations, STSM and Castor were able to achieve remarkably consistent results in terms of timber harvest flow, other forest harvest indicators (e.g., average harvest age, growing stock), and road development. This provides confidence in the approaches used by both models to estimate timber supply. In addition, given the similarity in results to STSM, the results suggest that it would be reasonable to use Castor for timber supply modeling in the province. 
